name: CI Quality Gate

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    name: Validate & Security Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Required files exist
        run: |
          for f in index.html manifest.json sw.js recover.html; do
            test -f "$f" && echo "‚úÖ $f" || (echo "‚ùå $f missing" && exit 1)
          done

      - name: Validate JSON files
        run: |
          python3 -c "import json; json.load(open('manifest.json'))" \
            && echo "‚úÖ manifest.json valid"

      - name: Content Security Policy present
        run: |
          grep -q "Content-Security-Policy" index.html \
            && echo "‚úÖ CSP header found" \
            || (echo "‚ùå CSP missing from index.html" && exit 1)

      - name: No credentials in HTML
        run: |
          # Fail if jinjer password appears in index.html
          ! grep -q "philia1904rops" index.html \
            && echo "‚úÖ No credentials in index.html" \
            || (echo "‚ùå Credential leak detected in index.html" && exit 1)

      - name: Service Worker cache version
        run: |
          VERSION=$(grep -o "kintai-v[0-9]*" sw.js | head -1)
          echo "‚ÑπÔ∏è  SW cache version: $VERSION"

      - name: Check for console.log (warn only)
        run: |
          COUNT=$(grep -c "console\.log" index.html || true)
          echo "‚ÑπÔ∏è  console.log count: $COUNT (consider removing in production)"

      - name: Byte size report
        run: |
          echo "üì¶ File sizes:"
          wc -c index.html manifest.json sw.js recover.html | sort -n
