<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>å‹¤æ€ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="å‹¤æ€ ">
  <link rel="apple-touch-icon" href="icon-apple.png">

  <!-- Android / General PWA -->
  <meta name="theme-color" content="#4f8dfd">
  <link rel="manifest" href="manifest.json">
  <!-- xlsx ã¯ Excelå‡ºåŠ›ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã«é…å»¶ãƒ­ãƒ¼ãƒ‰ï¼ˆiOS OOMå¯¾ç­–ï¼‰ -->

  <style>
    :root {
      --bg-page: #f5f5f7;
      --bg-card: #ffffff;
      --border-soft: #e0e3ea;
      --accent-blue: #4f8dfd;
      --text-main: #1d1d1f;
      --text-muted: #8e8e93;
      --radius-card: 24px;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: calc(max(var(--safe-top), 12px)) 12px calc(max(var(--safe-bottom), 12px));
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      background: var(--bg-page);
      color: var(--text-main);
      min-height: 100dvh;
    }

    /* ======= CARD ======= */
    .card {
      max-width: 960px;
      margin: 0 auto;
      background: var(--bg-card);
      border-radius: var(--radius-card);
      box-shadow: 0 8px 24px rgba(0,0,0,0.06);
      padding: 14px 14px 10px;
      position: relative;
      overflow: hidden;
    }

    .card-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: .02em;
    }

    /* ======= HEADER ======= */
    .header-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }
    .header-left, .header-right {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .pill-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #f8f9fc;
      cursor: pointer;
      user-select: none;
      font-family: inherit;
    }
    .pill-button .icon { margin-right: 5px; font-size: 13px; }
    .pill-button-primary {
      background: #eef3ff;
      border-color: #c5d2ff;
      color: var(--accent-blue);
      font-weight: 600;
    }
    .pill-button-lock-on {
      background: #ffece5;
      border-color: #ffc1a6;
      color: #f57c00;
      font-weight: 800;
    }
    .month-label { font-size: 16px; font-weight: 700; }
    .nav-arrow {
      width: 30px; height: 30px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #f8f9fc;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
      user-select: none;
      font-family: inherit;
    }

    /* ======= CALENDAR ======= */
    .calendar-wrapper {
      margin-top: 8px;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid var(--border-soft);
    }
    table.calendar {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 11px;
    }
    table.calendar th {
      background: #f5f6fb;
      text-align: center;
      padding: 6px 0;
      color: var(--text-muted);
      font-weight: 600;
    }
    table.calendar td {
      padding: 3px;
      background: #fff;
      vertical-align: top;
    }
    .day-card {
      border-radius: 14px;
      border: 1.5px solid #e3e7f0;
      padding: 5px 5px 26px;
      min-height: 60px;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 3px;
      background: #fbfbfe;
      transition: border-color 0.12s, box-shadow 0.12s, background 0.12s;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .day-card:active { transform: scale(0.98); }
    .day-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 3px;
    }
    .day-number {
      font-size: 12px;
      font-weight: 800;
      color: var(--text-main);
      min-width: 16px;
    }
    .day-number.sun { color: #c62828; }
    .day-number.sat { color: #1565c0; }
    .status-pill {
      flex: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid transparent;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 700;
      user-select: none;
    }
    .status-pill-æœª    { background:#f4f4f6; color:var(--text-muted); border-color:#e0e0e5; }
    .status-pill-å‡ºç¤¾  { background:#e3f2fd; color:#1565c0; border-color:#bbdefb; }
    .status-pill-åœ¨å®…  { background:#e8f5e9; color:#2e7d32; border-color:#c8e6c9; }
    .status-pill-ä¼‘ã¿  { background:#fff8e1; color:#ef6c00; border-color:#ffe0b2; }
    .status-pill-ç¥æ—¥  { background:#ffebee; color:#c62828; border-color:#ffcdd2; }
    .status-pill-ä¼‘æ—¥  { background:#ede7f6; color:#5e35b1; border-color:#d1c4e9; }

    .day-card-status-æœª    { border-color:#e4e5f0; background:#fbfbfe; }
    .day-card-status-å‡ºç¤¾  { border-color:#8ab4ff; background:#eaf3ff; }
    .day-card-status-åœ¨å®…  { border-color:#7bc47f; background:#e9f7ec; }
    .day-card-status-ä¼‘ã¿  { border-color:#ffb74d; background:#fff5e3; }
    .day-card-status-ç¥æ—¥  { border-color:#ef5350; background:#ffebee; }
    .day-card-status-ä¼‘æ—¥  { border-color:#b39ddb; background:#f3e5f5; }

    .dropdown-icon { font-size: 9px; padding-left: 3px; opacity:.7; }
    .memo-dot { font-size:11px; color:#ff9800; margin-left:3px; user-select:none; }
    .today-ring { box-shadow: 0 0 0 2px var(--accent-blue); }
    .selected-day { box-shadow: 0 0 0 2px var(--accent-blue); }
    .subline {
      font-size: 10px; color:#6b7280; line-height:1.2;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      user-select:none;
    }
    .holiday-name {
      font-size: 10px; color:#c62828; line-height:1.2;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      user-select:none;
    }
    .cell-actions {
      position:absolute; right:5px; bottom:5px;
      display:flex; gap:5px; z-index:2;
    }
    .mini-btn {
      border:1px solid rgba(0,0,0,0.08);
      background:rgba(255,255,255,0.9);
      backdrop-filter:blur(6px);
      -webkit-backdrop-filter:blur(6px);
      padding:3px 7px;
      border-radius:999px;
      font-size:10px; font-weight:900; color:#2563eb;
      cursor:pointer; user-select:none; line-height:1;
      box-shadow:0 4px 10px rgba(0,0,0,0.06);
      font-family:inherit;
    }
    .mini-btn:active { transform:scale(0.97); }
    .locked .day-card { opacity:0.55; }
    .locked .day-card { cursor:default; pointer-events:none; }

    /* ======= FOOTER ======= */
    .footer {
      margin-top: 8px;
      font-size: 10px;
      color: var(--text-muted);
      line-height: 1.4;
    }
    .legend span.badge {
      padding:2px 6px; border-radius:6px;
      margin-right:3px; font-weight:700; display:inline-block;
    }
    .badge-work   { background:#e3f2fd; color:#1565c0; }
    .badge-home   { background:#e8f5e9; color:#2e7d32; }
    .badge-holiday{ background:#fff8e1; color:#ef6c00; }
    .badge-shuku  { background:#ffebee; color:#c62828; }
    .badge-kyujitsu{ background:#ede7f6; color:#5e35b1; }

    .data-actions {
      margin-top: 8px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .data-btn {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #f4f5f9;
      cursor: pointer;
      user-select: none;
      font-weight: 600;
      font-family: inherit;
      color: var(--text-main);
    }
    .data-btn:active { transform: scale(0.97); }

    /* ======= MODAL ======= */
    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 999;
    }
    .modal-backdrop.show { display: flex; }
    .modal-sheet {
      width: 100%;
      max-width: 560px;
      background: #fff;
      border-radius: 20px 20px 0 0;
      padding: 12px 14px calc(max(var(--safe-bottom), 14px));
      box-shadow: 0 -4px 16px rgba(0,0,0,0.15);
    }
    .modal-handle {
      width: 34px; height: 4px;
      border-radius: 999px; background: #d0d0d5;
      margin: 0 auto 10px;
    }
    .modal-header {
      display: flex; align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 13px; font-weight: 800;
    }
    .modal-close {
      font-size: 22px; line-height:1;
      cursor:pointer; color:var(--text-muted); user-select:none;
    }
    .modal-section-title {
      font-size:11px; color:var(--text-muted);
      margin-bottom:5px; font-weight:700;
    }
    .status-chip-row { display:flex; gap:5px; margin-bottom:10px; flex-wrap:wrap; }
    .status-chip {
      flex:1; min-width:56px;
      border-radius:999px; padding:8px 6px;
      font-size:12px; text-align:center;
      border:1px solid var(--border-soft);
      background:#f6f7fb;
      cursor:pointer; user-select:none; font-weight:700;
      font-family:inherit;
    }
    .status-chip.active {
      border-color:var(--accent-blue);
      background:#e3edff; color:var(--accent-blue);
    }
    .row-time { display:flex; gap:8px; align-items:center; margin-bottom:10px; }
    .time-input {
      flex:1; padding:10px 10px;
      border-radius:12px; border:1px solid var(--border-soft);
      font-size:14px; font-family:inherit; background:#fff;
    }
    .memo-textarea {
      width:100%; min-height:80px; resize:vertical;
      border-radius:12px; border:1px solid var(--border-soft);
      padding:10px; font-size:13px; font-family:inherit;
    }
    .dup-row { display:flex; gap:8px; margin:4px 0 10px; }
    .dup-row .btn-secondary { flex:1; }
    .obs-row { display:flex; gap:8px; margin:6px 0 4px; }
    .obs-row .btn-secondary { flex:1; }
    .modal-footer {
      margin-top:10px; display:flex;
      justify-content:flex-end; gap:10px;
    }
    .btn-secondary {
      padding:10px 14px; font-size:13px;
      border-radius:999px; border:1px solid var(--border-soft);
      background:#f4f5f9; cursor:pointer; user-select:none;
      font-weight:700; font-family:inherit;
    }
    .btn-primary {
      padding:10px 18px; font-size:13px;
      border-radius:999px; border:none;
      background:var(--accent-blue); color:#fff;
      font-weight:900; cursor:pointer; user-select:none;
      font-family:inherit;
    }

    /* ======= SETTINGS MODAL ======= */
    .settings-body { display:flex; flex-direction:column; gap:12px; }
    .settings-row { display:flex; flex-direction:column; gap:5px; }
    .settings-label { font-size:12px; font-weight:700; color:var(--text-muted); }
    .settings-input {
      padding:10px; border-radius:12px;
      border:1px solid var(--border-soft);
      font-size:14px; font-family:inherit; background:#fff;
    }
    .settings-hint { font-size:11px; color:var(--text-muted); line-height:1.4; }

    /* ======= OVERLAY / SPINNER ======= */
    .overlay {
      position:absolute; inset:0;
      background:rgba(255,255,255,0.65);
      display:none; align-items:center; justify-content:center;
      z-index:50;
      backdrop-filter:blur(2px); -webkit-backdrop-filter:blur(2px);
    }
    .overlay.show { display:flex; }
    .spinner {
      width:28px; height:28px; border-radius:999px;
      border:3px solid rgba(79,141,253,0.25);
      border-top-color:rgba(79,141,253,1);
      animation:spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* ======= TOAST ======= */
    .toast {
      position:fixed; left:50%; bottom:calc(max(var(--safe-bottom), 20px) + 4px);
      transform:translateX(-50%);
      background:rgba(0,0,0,0.78); color:#fff;
      padding:10px 14px; border-radius:999px;
      font-size:12px; font-weight:700;
      z-index:2000; display:none;
      max-width:92vw; white-space:nowrap;
      overflow:hidden; text-overflow:ellipsis;
    }
    .toast.show { display:block; }

    /* ======= PROGRESS OVERLAY ======= */
    .progress-overlay {
      position:fixed; inset:0; z-index:3000;
      background:rgba(0,0,0,0.55);
      display:none; align-items:center; justify-content:center;
    }
    .progress-overlay.show { display:flex; }
    .progress-box {
      background:var(--bg-card); border-radius:18px;
      padding:24px 28px; min-width:260px; max-width:90vw;
      box-shadow:0 8px 32px rgba(0,0,0,0.25);
      display:flex; flex-direction:column; gap:14px; align-items:center;
    }
    .progress-title { font-size:15px; font-weight:800; color:var(--text-main); }
    .progress-step  { font-size:13px; color:var(--text-muted); text-align:center; line-height:1.6; }
    .progress-bar-wrap {
      width:100%; height:8px; background:var(--border-color);
      border-radius:999px; overflow:hidden;
    }
    .progress-bar-fill {
      height:100%; background:var(--accent-blue);
      border-radius:999px;
      transition:width 0.3s ease;
      width:0%;
    }
    .progress-spinner {
      width:32px; height:32px;
      border:3px solid var(--border-color);
      border-top-color:var(--accent-blue);
      border-radius:50%;
      animation:spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* ======= INSTALL BANNER ======= */
    .install-banner {
      background:#eef3ff; border:1px solid #c5d2ff;
      border-radius:14px; padding:10px 14px;
      margin-bottom:10px; font-size:12px;
      color:#1565c0; line-height:1.5;
      display:none;
    }
    .install-banner.show { display:block; }
    .install-banner strong { font-weight:800; }
    .install-close {
      float:right; cursor:pointer;
      font-size:18px; line-height:1; color:#1565c0;
      margin-left:8px;
    }

    /* ======= BACKUP BANNER ======= */
    .backup-banner {
      background:#fff8e1; border:1px solid #ffe0b2;
      border-radius:14px; padding:10px 14px;
      margin-bottom:10px; font-size:12px;
      color:#e65100; line-height:1.5; display:none;
    }
    .backup-banner.show { display:block; }
    .backup-banner-row {
      display:flex; align-items:center;
      justify-content:space-between; gap:8px;
    }
    .backup-banner-text { flex:1; }
    .backup-banner strong { font-weight:800; }
    .backup-now-btn {
      padding:7px 14px; font-size:12px; font-weight:800;
      border-radius:999px; border:none;
      background:#f57c00; color:#fff;
      cursor:pointer; white-space:nowrap;
      font-family:inherit;
    }
    .backup-dismiss {
      cursor:pointer; font-size:16px; opacity:.6;
      margin-left:4px; user-select:none;
    }

    /* ======= STATS BAR ======= */
    .stats-bar {
      display:flex; gap:6px; flex-wrap:wrap;
      padding:7px 2px 4px;
      border-bottom:1px solid var(--border-soft);
      margin-bottom:6px;
    }
    .stat-chip {
      display:inline-flex; align-items:center; gap:4px;
      padding:3px 10px; border-radius:999px;
      font-size:11px; font-weight:700;
      border:1px solid transparent;
    }
    .stat-chip b { font-size:13px; }
    .stat-office  { background:#e3f2fd; color:#1565c0; border-color:#bbdefb; }
    .stat-home    { background:#e8f5e9; color:#2e7d32; border-color:#c8e6c9; }
    .stat-off     { background:#fff8e1; color:#ef6c00; border-color:#ffe0b2; }
    .stat-hours   { background:#f3e5f5; color:#6a1b9a; border-color:#e1bee7; }

    /* ======= TASK FAB ======= */
    .fab-task {
      position:fixed;
      right: calc(max(env(safe-area-inset-right), 16px) + 60px);
      bottom: calc(max(env(safe-area-inset-bottom), 20px) + 56px);
      width:52px; height:52px;
      border-radius:999px;
      background:#ff9800;
      color:#fff; font-size:22px;
      border:none; cursor:pointer;
      box-shadow:0 4px 16px rgba(255,152,0,0.45);
      display:flex; align-items:center; justify-content:center;
      z-index:900;
      font-family:inherit;
      transition:opacity 0.2s;
    }
    .fab-task:active { transform:scale(0.95); }
    .fab-task.hidden { opacity:0; pointer-events:none; }

    /* ======= TASK MODAL ======= */
    .task-add-form { padding:12px 16px 4px; display:flex; flex-direction:column; gap:8px; }
    .task-add-input { padding:8px 10px; border:1.5px solid var(--border-color); border-radius:8px; font-size:15px; font-family:inherit; background:var(--bg-card); color:var(--text-main); outline:none; }
    .task-add-input:focus { border-color:var(--accent-blue); }
    .task-add-textarea { height:60px; resize:none; }
    .task-add-submit { background:var(--accent-blue); color:#fff; border:none; border-radius:8px; padding:9px; font-size:15px; font-weight:700; cursor:pointer; font-family:inherit; }
    .task-section-title { font-size:11px; font-weight:700; color:var(--text-muted); padding:8px 16px 2px; text-transform:uppercase; letter-spacing:.05em; }
    .task-list { padding:0 16px; }
    .task-item { display:flex; align-items:flex-start; gap:10px; padding:10px 0; border-bottom:1px solid var(--border-color); }
    .task-item:last-child { border-bottom:none; }
    .task-check { width:20px; height:20px; flex-shrink:0; margin-top:2px; cursor:pointer; accent-color:var(--accent-blue); }
    .task-body { flex:1; min-width:0; }
    .task-title { font-size:15px; font-weight:700; word-break:break-all; }
    .task-memo { font-size:12px; color:var(--text-muted); margin-top:3px; white-space:pre-wrap; word-break:break-all; }
    .task-item.done .task-title { text-decoration:line-through; opacity:0.5; }
    .task-item.done .task-memo { opacity:0.4; }
    .task-del { background:none; border:none; color:#e57373; font-size:18px; cursor:pointer; padding:0 4px; align-self:center; line-height:1; }
    .task-empty { text-align:center; color:var(--text-muted); padding:24px 0; font-size:14px; line-height:1.8; }

    /* ======= FLOATING TODAY BUTTON ======= */
    .fab-today {
      position:fixed;
      right: calc(max(env(safe-area-inset-right), 16px));
      bottom: calc(max(env(safe-area-inset-bottom), 20px) + 56px);
      width:52px; height:52px;
      border-radius:999px;
      background:var(--accent-blue);
      color:#fff; font-size:11px; font-weight:900;
      border:none; cursor:pointer;
      box-shadow:0 4px 16px rgba(79,141,253,0.45);
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      gap:1px; z-index:900;
      font-family:inherit;
      transition:opacity 0.2s;
    }
    .fab-today:active { transform:scale(0.95); }
    .fab-today .fab-day { font-size:18px; font-weight:900; line-height:1; }
    .fab-today .fab-label { font-size:9px; opacity:.85; }
    .fab-today.hidden { opacity:0; pointer-events:none; }
  </style>
</head>

<body>
  <!-- Install banner (iOS) -->
  <div class="install-banner" id="install-banner">
    <span class="install-close" id="install-close">Ã—</span>
    <strong>ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ã‚¢ãƒ—ãƒªã¨ã—ã¦ä½¿ã†</strong><br>
    Safari ã® <strong>å…±æœ‰ãƒœã‚¿ãƒ³ï¼ˆâ†‘ï¼‰â†’ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€</strong> ã‚’ã‚¿ãƒƒãƒ—
  </div>

  <!-- Auto-backup reminder banner -->
  <div class="backup-banner" id="backup-banner">
    <div class="backup-banner-row">
      <div class="backup-banner-text">
        <strong>âš ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ãŠå‹§ã‚ã—ã¾ã™</strong><br>
        <span id="backup-days-msg">å‰å›ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰7æ—¥ä»¥ä¸ŠçµŒéã—ã¦ã„ã¾ã™</span>
      </div>
      <button class="backup-now-btn" id="btn-backup-now">ä¸€æ‹¬ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
      <span class="backup-dismiss" id="backup-dismiss">Ã—</span>
    </div>
  </div>

  <div class="card" id="calendar-card">
    <div class="overlay" id="overlay"><div class="spinner"></div></div>

    <div class="card-title">å‹¤æ€ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆãƒ¡ãƒ¢ä»˜ãï¼‰</div>

    <!-- Monthly stats bar -->
    <div class="stats-bar" id="stats-bar">
      <span class="stat-chip stat-office">å‡ºç¤¾ <b id="stat-office">0</b>æ—¥</span>
      <span class="stat-chip stat-home">åœ¨å®… <b id="stat-home">0</b>æ—¥</span>
      <span class="stat-chip stat-off">ä¼‘æš‡ <b id="stat-off">0</b>æ—¥</span>
      <span class="stat-chip stat-hours">å‹¤å‹™ <b id="stat-hours">0h</b></span>
    </div>

    <div class="header-bar">
      <div class="header-left">
        <button class="nav-arrow" id="prev-month">â€¹</button>
        <button class="pill-button pill-button-primary" id="today-button">ä»Šæ—¥</button>
      </div>
      <div class="month-label" id="month-label">----</div>
      <div class="header-right">
        <button class="pill-button" id="lock-toggle">
          <span class="icon">ğŸ”’</span><span id="lock-label">ãƒ­ãƒƒã‚¯</span>
        </button>
        <button class="nav-arrow" id="next-month">â€º</button>
      </div>
    </div>

    <div class="calendar-wrapper">
      <table class="calendar">
        <thead>
          <tr>
            <th>æ—¥</th><th>æœˆ</th><th>ç«</th><th>æ°´</th><th>æœ¨</th><th>é‡‘</th><th>åœŸ</th>
          </tr>
        </thead>
        <tbody id="calendar-body"></tbody>
      </table>
    </div>

    <div class="footer">
      <div class="legend">
        ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼š
        <span class="badge badge-work">å‡º</span>
        <span class="badge badge-home">åœ¨</span>
        <span class="badge badge-kyujitsu">ä¼‘æ—¥</span>
        <span class="badge badge-holiday">ä¼‘ã¿</span>
        <span class="badge badge-shuku">ç¥æ—¥</span><br>
        æ—¥æ›œâ†’ä¼‘æ—¥ / åœŸæ›œâ†’ä¼‘ã¿ / ç¥æ—¥ã¯è‡ªå‹•åˆ¤å®šã€‚ãƒ¡ãƒ¢ã‚ã‚Šï¼<span style="color:#ff9800;font-weight:800;">â—</span>
      </div>
      <div class="data-actions">
        <button class="data-btn" id="btn-xlsx">ğŸ“Š xlsxæ›¸ãå‡ºã—</button>
        <button class="data-btn" id="btn-export">ğŸ’¾ JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
        <button class="data-btn" id="btn-import">ğŸ“¥ JSONèª­ã¿è¾¼ã¿</button>
        <button class="data-btn" id="btn-migrate">ğŸ”„ iSHç‰ˆã‚’å–ã‚Šè¾¼ã‚€</button>
        <button class="data-btn" id="btn-jinjer">ğŸ¢ jinjeråŒæœŸ</button>
        <button class="data-btn" id="btn-settings">âš™ï¸ è¨­å®š</button>
      </div>
      <input type="file" id="file-import"  accept=".json" style="display:none">
      <input type="file" id="file-jinjer" accept=".json" style="display:none">
    </div>
  </div>

  <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-backdrop" id="memo-modal">
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div id="modal-date-label"></div>
        <div class="modal-close" id="modal-close">Ã—</div>
      </div>

      <div class="modal-section-title">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
      <div class="status-chip-row" id="status-chip-row"></div>

      <div class="modal-section-title">æ¥­å‹™æ™‚é–“ï¼ˆ1åˆ†å˜ä½ï¼‰</div>
      <div class="row-time">
        <input id="start-time" class="time-input" type="time" step="60">
        <span style="color:var(--text-muted);font-weight:800;">ã€œ</span>
        <input id="end-time" class="time-input" type="time" step="60">
      </div>

      <div class="dup-row">
        <button class="btn-secondary" id="btn-dup-prev">å‰æ—¥ã‚’è¤‡è£½</button>
        <button class="btn-secondary" id="btn-dup-last">ç›´è¿‘ã‚’è¤‡è£½</button>
      </div>

      <div class="modal-section-title">ãƒ¡ãƒ¢</div>
      <textarea id="memo-textarea" class="memo-textarea" placeholder="ã“ã®æ—¥ã®ãƒ¡ãƒ¢ã‚’å…¥åŠ›"></textarea>

      <div class="modal-section-title" style="margin-top:10px;">Obsidian</div>
      <div class="obs-row">
        <button class="btn-secondary" id="btn-obs-open">ğŸ“ Obsidianã§é–‹ã</button>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" id="modal-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn-primary" id="modal-save">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-backdrop" id="settings-modal">
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div>è¨­å®š</div>
        <div class="modal-close" id="settings-close">Ã—</div>
      </div>
      <div class="settings-body">
        <div class="settings-row">
          <div class="settings-label">Obsidian Vault å</div>
          <input id="settings-vault" class="settings-input" type="text" placeholder="ä¾‹: MyVault">
          <div class="settings-hint">Obsidianã§é–‹ãã¨ãã«ä½¿ã†Vaultåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>
        </div>
        <div class="settings-row">
          <div class="settings-label">Obsidian ã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€</div>
          <input id="settings-subdir" class="settings-input" type="text" placeholder="ä¾‹: ã€æ¥­å‹™ã€‘/å‹¤æ€ ">
          <div class="settings-hint">Vaultã®ã©ã®ãƒ•ã‚©ãƒ«ãƒ€ã«MDãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã‹ã®ãƒ‘ã‚¹ã€‚</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="settings-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn-primary" id="settings-save">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- Task modal -->
  <div class="modal-backdrop" id="task-modal">
    <div class="modal-sheet" style="max-height:85vh;overflow:hidden;display:flex;flex-direction:column;">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div>ğŸ“‹ ã‚¿ã‚¹ã‚¯</div>
        <div class="modal-close" id="task-modal-close">Ã—</div>
      </div>
      <div class="task-add-form">
        <input id="task-title-input" class="task-add-input" type="text" placeholder="ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›">
        <textarea id="task-memo-input" class="task-add-input task-add-textarea" placeholder="ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰"></textarea>
        <button class="task-add-submit" id="task-add-btn">ï¼‹ è¿½åŠ </button>
      </div>
      <div id="task-list-container" style="overflow-y:auto;flex:1;padding-bottom:16px;"></div>
    </div>
  </div>

  <!-- Floating today button -->
  <button class="fab-today" id="fab-today">
    <span class="fab-day" id="fab-day">--</span>
    <span class="fab-label">ä»Šæ—¥</span>
  </button>

  <!-- Task FAB -->
  <button class="fab-task" id="fab-task">ğŸ“‹</button>

  <!-- Progress overlayï¼ˆjinjeråŒæœŸãƒ»é‡ã„å‡¦ç†ç”¨ï¼‰ -->
  <div class="progress-overlay" id="progress-overlay">
    <div class="progress-box">
      <div class="progress-spinner" id="progress-spinner"></div>
      <div class="progress-title" id="progress-title">å‡¦ç†ä¸­...</div>
      <div class="progress-bar-wrap">
        <div class="progress-bar-fill" id="progress-bar"></div>
      </div>
      <div class="progress-step" id="progress-step"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /* =====================================================
       HIGH-AVAILABILITY: ç·Šæ€¥ãƒªã‚»ãƒƒãƒˆ / ã‚¯ãƒ©ãƒƒã‚·ãƒ¥æ¤œå‡º / ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼æ•æ‰
       ===================================================== */

    // â‘  URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚ˆã‚‹ç·Šæ€¥ãƒªã‚»ãƒƒãƒˆ (?reset)
    if (location.search.includes('reset')) {
      (async () => {
        try { const r = await navigator.serviceWorker.getRegistrations(); for(const s of r) await s.unregister(); } catch(_){}
        try { const k = await caches.keys(); await Promise.all(k.map(c => caches.delete(c))); } catch(_){}
        try { localStorage.clear(); } catch(_){}
        try { indexedDB.deleteDatabase('kintai_idb'); } catch(_){}
        location.replace(location.pathname); // ?reset ã‚’é™¤ã„ã¦ãƒªãƒ­ãƒ¼ãƒ‰
      })();
    }

    // â‘¡ ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ãƒ«ãƒ¼ãƒ—æ¤œå‡ºï¼ˆ3å›é€£ç¶šã§ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ãŸã‚‰å¾©æ—§UIã‚’è¡¨ç¤ºï¼‰
    //    sessionStorage ã¯iOSãŒãƒ—ãƒ­ã‚»ã‚¹ã‚’killã™ã‚‹ã¨æ¶ˆãˆã‚‹ãŸã‚ localStorage ã‚’ä½¿ã†
    const _CRASH_KEY = '_kintai_crash';
    const _crashes   = Number(localStorage.getItem(_CRASH_KEY) || 0);
    localStorage.setItem(_CRASH_KEY, _crashes + 1);
    window.addEventListener('load', () => localStorage.setItem(_CRASH_KEY, '0'));

    if (_crashes >= 3) {
      document.addEventListener('DOMContentLoaded', () => {
        document.body.innerHTML = `
          <div style="font-family:-apple-system,sans-serif;max-width:360px;margin:60px auto;padding:24px;
               background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(0,0,0,0.12);text-align:center;">
            <div style="font-size:40px;">ğŸš¨</div>
            <h2 style="margin:8px 0 6px;font-size:18px;">ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã‚’ç¹°ã‚Šè¿”ã—ã¦ã„ã¾ã™</h2>
            <p style="font-size:13px;color:#666;line-height:1.6;margin:0 0 20px">
              ãƒ‡ãƒ¼ã‚¿ãŒç ´æã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚<br>å¾©æ—§ãƒšãƒ¼ã‚¸ã§ä¿®å¾©ã—ã¦ãã ã•ã„ã€‚
            </p>
            <a href="./recover.html" style="display:block;background:#4f8dfd;color:#fff;
               padding:13px;border-radius:12px;text-decoration:none;font-weight:700;font-size:15px;
               margin-bottom:10px;">ğŸ›  å¾©æ—§ãƒšãƒ¼ã‚¸ã¸</a>
            <button onclick="localStorage.setItem('${_CRASH_KEY}','0');location.reload()"
              style="width:100%;background:#fff;border:1.5px solid #ddd;color:#555;
              padding:11px;border-radius:12px;font-size:14px;cursor:pointer;font-family:inherit;">
              âš¡ ã“ã®ã¾ã¾èµ·å‹•ã‚’å†è©¦è¡Œ
            </button>
          </div>`;
      });
      throw new Error('RECOVERY_MODE'); // ä»¥é™ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä¸€åˆ‡å®Ÿè¡Œã—ãªã„
    }

    // â‘¢ ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ï¼ˆæœªæ•æ‰ã‚¨ãƒ©ãƒ¼ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¨˜éŒ²ï¼‰
    window.addEventListener('error', ev => {
      console.error('[GLOBAL ERROR]', ev.message, ev.filename, ev.lineno);
    });
    window.addEventListener('unhandledrejection', ev => {
      console.error('[UNHANDLED REJECTION]', ev.reason);
      ev.preventDefault(); // iOS Safari ã®å¼·åˆ¶ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã‚’æŠ‘åˆ¶
    });

    /* =====================================================
       CONSTANTS
       ===================================================== */
    const STATUS_LIST = ["æœª", "å‡ºç¤¾", "åœ¨å®…", "ä¼‘æ—¥", "ä¼‘ã¿", "ç¥æ—¥"];
    const STORE_KEY   = 'kintai_store_v1';
    const LAST_KEY    = 'att_last_template';
    const CFG_KEY     = 'kintai_config_v1';

    /* =====================================================
       JAPANESE HOLIDAY CALCULATION
       ===================================================== */
    const _hCache = {};

    function getHolidays(year) {
      if (_hCache[year]) return _hCache[year];
      const h = {};
      const f = (m, d, name) => {
        h[`${year}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`] = name;
      };

      // Fixed
      f(1,1,'å…ƒæ—¥');
      f(2,11,'å»ºå›½è¨˜å¿µã®æ—¥');
      f(2,23,'å¤©çš‡èª•ç”Ÿæ—¥');
      f(4,29,'æ˜­å’Œã®æ—¥');
      f(5,3,'æ†²æ³•è¨˜å¿µæ—¥');
      f(5,4,'ã¿ã©ã‚Šã®æ—¥');
      f(5,5,'ã“ã©ã‚‚ã®æ—¥');
      f(8,11,'å±±ã®æ—¥');
      f(11,3,'æ–‡åŒ–ã®æ—¥');
      f(11,23,'å‹¤åŠ´æ„Ÿè¬ã®æ—¥');

      // nth weekday helper (wd: JS format 0=Sun,1=Mon,...,6=Sat)
      function nthWD(month, wd, n) {
        const d = new Date(year, month - 1, 1);
        let c = 0;
        while (true) {
          if (d.getDay() === wd && ++c === n) return d.getDate();
          d.setDate(d.getDate() + 1);
        }
      }
      f(1,  nthWD(1, 1, 2), 'æˆäººã®æ—¥');
      f(7,  nthWD(7, 1, 3), 'æµ·ã®æ—¥');
      f(9,  nthWD(9, 1, 3), 'æ•¬è€ã®æ—¥');
      f(10, nthWD(10,1, 2), 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥');

      // æ˜¥åˆ†ã®æ—¥ãƒ»ç§‹åˆ†ã®æ—¥ (è¿‘ä¼¼å¼)
      const sy = year - 1980;
      const shunbun = Math.floor(20.8431 + 0.242194 * sy - Math.floor(sy / 4));
      const shubun  = Math.floor(23.2488 + 0.242194 * sy - Math.floor(sy / 4));
      f(3, shunbun, 'æ˜¥åˆ†ã®æ—¥');
      f(9, shubun,  'ç§‹åˆ†ã®æ—¥');

      // æŒ¯æ›¿ä¼‘æ—¥: ç¥æ—¥ãŒæ—¥æ›œ â†’ ç¿Œæœˆæ›œï¼ˆé€£é–å¯¾å¿œï¼‰
      const hkeys = Object.keys(h).sort();
      for (const k of hkeys) {
        const d = new Date(k + 'T00:00:00');
        if (d.getDay() === 0) {
          let nxt = new Date(d);
          nxt.setDate(nxt.getDate() + 1);
          while (h[nxt.toISOString().slice(0, 10)]) nxt.setDate(nxt.getDate() + 1);
          h[nxt.toISOString().slice(0, 10)] = 'æŒ¯æ›¿ä¼‘æ—¥';
        }
      }

      // å›½æ°‘ã®ä¼‘æ—¥: 2ã¤ã®ç¥æ—¥ã«æŒŸã¾ã‚ŒãŸå¹³æ—¥
      const all = Object.keys(h).sort();
      for (let i = 0; i < all.length - 1; i++) {
        const d1 = new Date(all[i] + 'T00:00:00');
        const d2 = new Date(all[i + 1] + 'T00:00:00');
        if ((d2 - d1) / 86400000 === 2) {
          const mid = new Date(d1);
          mid.setDate(mid.getDate() + 1);
          const mk = mid.toISOString().slice(0, 10);
          if (!h[mk] && mid.getDay() !== 0) h[mk] = 'å›½æ°‘ã®ä¼‘æ—¥';
        }
      }

      _hCache[year] = h;
      return h;
    }

    function holidayName(dateStr) {
      return getHolidays(+dateStr.slice(0, 4))[dateStr] || null;
    }

    /* =====================================================
       CONFIG
       ===================================================== */
    function loadConfig() {
      try {
        const r = localStorage.getItem(CFG_KEY);
        return r ? JSON.parse(r) : {};
      } catch { return {}; }
    }
    function saveConfig(cfg) {
      localStorage.setItem(CFG_KEY, JSON.stringify(cfg));
    }

    /* =====================================================
       DATA STORAGE â€” IndexedDBï¼ˆä¸»ï¼‰+ localStorageï¼ˆé«˜é€Ÿã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
       æ›¸ãè¾¼ã¿: ä¸¡æ–¹ã«åŒæœŸ
       èª­ã¿è¾¼ã¿: localStorageï¼ˆé«˜é€Ÿï¼‰
       å¾©å…ƒ:     localStorage ãŒç©ºã®å ´åˆ IndexedDB ã‹ã‚‰è‡ªå‹•å¾©å…ƒ
       ===================================================== */
    const IDB_NAME    = 'kintai_idb';
    const IDB_VERSION = 1;
    const IDB_STORE   = 'attendance';

    function _openIDB() {
      return new Promise((resolve) => {
        try {
          const req = indexedDB.open(IDB_NAME, IDB_VERSION);
          req.onupgradeneeded = e => {
            e.target.result.createObjectStore(IDB_STORE, { keyPath: 'id' });
          };
          req.onsuccess = e => resolve(e.target.result);
          req.onerror   = () => resolve(null);
        } catch (_) { resolve(null); }
      });
    }

    async function idbSave(data) {
      const db = await _openIDB();
      if (!db) return;
      try {
        const tx = db.transaction(IDB_STORE, 'readwrite');
        tx.objectStore(IDB_STORE).put({ id: 'main', data, saved_at: new Date().toISOString() });
      } catch (_) {}
    }

    async function idbLoad() {
      const db = await _openIDB();
      if (!db) return null;
      return new Promise(resolve => {
        try {
          const req = db.transaction(IDB_STORE).objectStore(IDB_STORE).get('main');
          req.onsuccess = () => resolve(req.result?.data || null);
          req.onerror   = () => resolve(null);
        } catch (_) { resolve(null); }
      });
    }

    // localStorage ã‹ã‚‰èª­ã‚€ï¼ˆé«˜é€Ÿãƒ»åŒæœŸï¼‰
    function loadStore() {
      try {
        const r = localStorage.getItem(STORE_KEY);
        if (!r) return { months: {} };
        const d = JSON.parse(r);
        return (d && d.months) ? d : { months: {} };
      } catch { return { months: {} }; }
    }

    // ä¸¡æ–¹ã«æ›¸ãï¼ˆlocalStorage æ›¸ãè¾¼ã¿å¤±æ•—æ™‚ã¯ IDB ã®ã¿ï¼‰
    function saveStore(store) {
      const json = JSON.stringify(store);
      try {
        localStorage.setItem(STORE_KEY, json);
      } catch(e) {
        console.warn('[saveStore] localStorage æ›¸ãè¾¼ã¿å¤±æ•— (quota?):', e);
        // Quotaè¶…éãªã‚‰å¤ã„æœˆã‚’å‰Šé™¤ã—ã¦å†è©¦è¡Œ
        try {
          const months = Object.keys(store.months || {}).sort();
          if (months.length > 3) {
            delete store.months[months[0]]; // æœ€å¤æœˆã‚’å‰Šé™¤
            localStorage.setItem(STORE_KEY, JSON.stringify(store));
            console.warn('[saveStore] æœ€å¤æœˆã‚’å‰Šé™¤ã—ã¦ä¿å­˜ã—ã¾ã—ãŸ:', months[0]);
          }
        } catch(_) { console.error('[saveStore] ä¿å­˜å®Œå…¨å¤±æ•—'); }
      }
      idbSave(store); // éåŒæœŸãƒŸãƒ©ãƒ¼ï¼ˆfire-and-forgetï¼‰
    }

    // èµ·å‹•æ™‚: localStorage ãŒç©ºãªã‚‰ IndexedDB ã‹ã‚‰å¾©å…ƒ
    async function restoreFromIDBIfNeeded() {
      const ls = localStorage.getItem(STORE_KEY);
      const isEmpty = !ls || ls === '{"months":{}}';
      if (!isEmpty) return false;
      const idbData = await idbLoad();
      if (idbData && Object.keys(idbData.months || {}).length > 0) {
        localStorage.setItem(STORE_KEY, JSON.stringify(idbData));
        toast('ğŸ’¾ IndexedDBã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
        return true;
      }
      return false;
    }

    function buildSkeleton(ym) {
      const [y, m] = ym.split('-').map(Number);
      const last = new Date(y, m, 0).getDate();
      const out = {};
      for (let day = 1; day <= last; day++) {
        const d = `${ym}-${String(day).padStart(2, '0')}`;
        out[d] = { date: d, status: 'æœª', start: '', end: '', memo: '', updated_at: '' };
      }
      return out;
    }

    function autoStatus(dateStr) {
      if (holidayName(dateStr)) return 'ç¥æ—¥';
      const wd = new Date(dateStr + 'T00:00:00').getDay();
      if (wd === 0) return 'ä¼‘æ—¥';
      if (wd === 6) return 'ä¼‘ã¿';
      return 'æœª';
    }

    function applyAutoRules(monthData) {
      const out = {}, holidays = {};
      for (const [d, rec] of Object.entries(monthData)) {
        const r = { ...rec };
        const hn = holidayName(d);
        if (hn) holidays[d] = hn;
        const st = (r.status || 'æœª').trim() || 'æœª';
        r.status = (st === 'æœª') ? autoStatus(d) : st;
        out[d] = r;
      }
      return { data: out, holidays };
    }

    function getMonthData(ym) {
      const store = loadStore();
      if (!store.months[ym]) {
        store.months[ym] = buildSkeleton(ym);
        saveStore(store);
      }
      return applyAutoRules(store.months[ym]);
    }

    function saveDayData(dateStr, status, start, end, memo) {
      const ym = dateStr.slice(0, 7);
      const store = loadStore();
      if (!store.months[ym]) store.months[ym] = buildSkeleton(ym);
      if (!store.months[ym][dateStr]) {
        store.months[ym][dateStr] = {
          date: dateStr, status: 'æœª', start: '', end: '', memo: '', updated_at: ''
        };
      }
      if (status !== '') store.months[ym][dateStr].status = status;
      store.months[ym][dateStr].start = start;
      store.months[ym][dateStr].end   = end;
      store.months[ym][dateStr].memo  = memo;
      store.months[ym][dateStr].updated_at = new Date().toISOString().slice(0, 19);
      saveStore(store);
      // return view-corrected record
      const { data } = applyAutoRules({ [dateStr]: store.months[ym][dateStr] });
      return data[dateStr];
    }

    /* =====================================================
       APP STATE
       ===================================================== */
    let currentYear, currentMonth;
    let attendanceData = {};
    let holidaysData   = {};
    let currentEditDate = null;
    let locked = false;
    let selectedDateStr = null;

    const toastEl   = document.getElementById('toast');
    const overlayEl = document.getElementById('overlay');

    function toast(msg) {
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      setTimeout(() => toastEl.classList.remove('show'), 1400);
    }

    function setLoading(v) {
      overlayEl.classList.toggle('show', !!v);
    }

    /* =====================================================
       FORMAT HELPERS
       ===================================================== */
    function ymLabel(y, m) {
      return `${y}å¹´${m}æœˆ`;
    }

    function formatDateJP(dateStr) {
      const d = new Date(dateStr + 'T00:00:00');
      const wdays = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
      return `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥ï¼ˆ${wdays[d.getDay()]}ï¼‰`;
    }

    function prevDateStr(dateStr) {
      const d = new Date(dateStr + 'T00:00:00');
      d.setDate(d.getDate() - 1);
      return d.toISOString().slice(0, 10);
    }

    /* =====================================================
       LOAD MONTH
       ===================================================== */
    function loadMonth(year, month) {
      currentYear  = year;
      currentMonth = month;
      document.getElementById('month-label').textContent = ymLabel(year, month);

      setLoading(true);
      try {
        const ym = `${year}-${String(month).padStart(2, '0')}`;
        const { data, holidays } = getMonthData(ym);
        attendanceData = data;
        holidaysData   = holidays;
        renderCalendar(year, month);
        renderStats(year, month);
      } finally {
        setLoading(false);
      }
    }

    /* =====================================================
       SAVE ATTENDANCE
       ===================================================== */
    function saveAttendance(dateStr, status, memo, start, end) {
      const prev = attendanceData[dateStr] ? { ...attendanceData[dateStr] } : null;
      try {
        const day = saveDayData(dateStr, status, start, end, memo);
        attendanceData[dateStr] = day;
        const hn = holidayName(dateStr);
        if (hn) holidaysData[dateStr] = hn;

        localStorage.setItem(LAST_KEY, JSON.stringify({ status, memo, start, end }));
        renderCalendar(currentYear, currentMonth);
        return true;
      } catch (e) {
        if (prev) attendanceData[dateStr] = prev;
        else delete attendanceData[dateStr];
        renderCalendar(currentYear, currentMonth);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        return false;
      }
    }

    function getLastTemplate() {
      try {
        const r = localStorage.getItem(LAST_KEY);
        return r ? JSON.parse(r) : null;
      } catch { return null; }
    }

    function quickDuplicateLast(targetDate) {
      if (locked) return;
      const t = getLastTemplate();
      if (!t) { alert('ç›´è¿‘ãƒ†ãƒ³ãƒ—ãƒ¬ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
      const ok = saveAttendance(targetDate, t.status||'æœª', t.memo||'', t.start||'', t.end||'');
      if (ok) toast(`${targetDate} ã«ç›´è¿‘ã‚’åæ˜ `);
    }

    /* =====================================================
       RENDER CALENDAR
       ===================================================== */
    function renderCalendar(year, month) {
      const tbody = document.getElementById('calendar-body');
      tbody.innerHTML = '';

      const first      = new Date(year, month - 1, 1);
      const lastDay    = new Date(year, month, 0).getDate();
      const firstWd    = first.getDay();

      const today = new Date();
      const todayY = today.getFullYear();
      const todayM = today.getMonth() + 1;
      const todayD = today.getDate();

      let row = document.createElement('tr');

      for (let i = 0; i < firstWd; i++) row.appendChild(document.createElement('td'));

      for (let day = 1; day <= lastDay; day++) {
        if (row.children.length === 7) {
          tbody.appendChild(row);
          row = document.createElement('tr');
        }

        const td      = document.createElement('td');
        const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const dbData  = attendanceData[dateStr] || null;
        const hname   = holidaysData[dateStr] || null;
        const w       = new Date(year, month - 1, day).getDay();

        let status = 'æœª', memo = '', start = '', end = '';
        if (dbData) {
          status = dbData.status || 'æœª';
          memo   = dbData.memo   || '';
          start  = dbData.start  || '';
          end    = dbData.end    || '';
        }

        const card = document.createElement('div');
        card.className = `day-card day-card-status-${status}`;
        if (year === todayY && month === todayM && day === todayD) card.classList.add('today-ring');
        if (selectedDateStr === dateStr) card.classList.add('selected-day');
        card.dataset.date = dateStr;

        // Header
        const header = document.createElement('div');
        header.className = 'day-header';

        const num = document.createElement('div');
        num.className = 'day-number' + (w === 0 ? ' sun' : w === 6 ? ' sat' : '');
        num.textContent = day;

        const pill = document.createElement('div');
        pill.className = `status-pill status-pill-${status}`;
        pill.textContent = status;
        const ddIcon = document.createElement('span');
        ddIcon.className = 'dropdown-icon';
        ddIcon.textContent = 'â–¾';
        pill.appendChild(ddIcon);

        const dot = document.createElement('span');
        dot.className = 'memo-dot';
        dot.textContent = memo ? 'â—' : '';

        header.appendChild(num);
        header.appendChild(pill);
        header.appendChild(dot);
        card.appendChild(header);

        if (start || end) {
          const tm = document.createElement('div');
          tm.className = 'subline';
          tm.textContent = `${start || '--:--'}ã€œ${end || '--:--'}`;
          card.appendChild(tm);
        }

        if (hname) {
          const hl = document.createElement('div');
          hl.className = 'holiday-name';
          hl.textContent = hname;
          card.appendChild(hl);
        }

        // ç›´è¿‘ãƒœã‚¿ãƒ³
        const actions = document.createElement('div');
        actions.className = 'cell-actions';
        const bLast = document.createElement('button');
        bLast.type = 'button';
        bLast.className = 'mini-btn';
        bLast.textContent = 'ç›´è¿‘';
        bLast.addEventListener('click', e => {
          e.stopPropagation();
          quickDuplicateLast(dateStr);
        });
        actions.appendChild(bLast);
        card.appendChild(actions);

        td.appendChild(card);
        row.appendChild(td);
      }

      if (row.children.length > 0) {
        while (row.children.length < 7) row.appendChild(document.createElement('td'));
        tbody.appendChild(row);
      }

      document.getElementById('calendar-card').classList.toggle('locked', locked);
    }

    /* =====================================================
       MODAL
       ===================================================== */
    function openModal(dateStr) {
      if (locked) return;
      currentEditDate = dateStr;

      const dbData = attendanceData[dateStr] || null;
      let status = 'æœª', memo = '', start = '', end = '';
      if (dbData) {
        status = dbData.status || 'æœª';
        memo   = dbData.memo   || '';
        start  = dbData.start  || '';
        end    = dbData.end    || '';
      }

      document.getElementById('modal-date-label').textContent = formatDateJP(dateStr);
      document.getElementById('memo-textarea').value  = memo;
      document.getElementById('start-time').value     = start || '09:00';
      document.getElementById('end-time').value       = end   || '18:00';

      const row = document.getElementById('status-chip-row');
      row.innerHTML = '';
      STATUS_LIST.forEach(s => {
        const chip = document.createElement('div');
        chip.className = 'status-chip' + (s === status ? ' active' : '');
        chip.textContent = s;
        chip.dataset.value = s;
        row.appendChild(chip);
      });

      document.getElementById('memo-modal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('memo-modal').classList.remove('show');
      currentEditDate = null;
    }

    function getModalStatus() {
      for (const c of document.querySelectorAll('.status-chip')) {
        if (c.classList.contains('active')) return c.dataset.value;
      }
      return 'æœª';
    }

    function applyTemplate(t) {
      if (!t) return;
      document.querySelectorAll('.status-chip')
        .forEach(c => c.classList.toggle('active', c.dataset.value === t.status));
      document.getElementById('memo-textarea').value = t.memo  || '';
      document.getElementById('start-time').value    = t.start || '09:00';
      document.getElementById('end-time').value      = t.end   || '18:00';
    }

    /* =====================================================
       OBSIDIAN
       ===================================================== */
    function obsidianOpen(dateStr) {
      const cfg    = loadConfig();
      const vault  = (cfg.vault  || 'Phi_Memo').trim();
      const subdir = (cfg.subdir || 'ã€æ¥­å‹™ã€‘/å‹¤æ€ ').trim();
      const file   = encodeURIComponent(`${subdir}/${dateStr}.md`);
      location.href = `obsidian://open?vault=${encodeURIComponent(vault)}&file=${file}`;
    }

    /* =====================================================
       xlsx æ›¸ãå‡ºã—ï¼ˆSheetJSï¼‰â€” é…å»¶ãƒ­ãƒ¼ãƒ‰ç‰ˆ
       ===================================================== */
    const XLSX_CDN = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
    function loadXlsxLib() {
      if (typeof XLSX !== 'undefined') return Promise.resolve();
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = XLSX_CDN;
        s.onload = resolve;
        s.onerror = () => reject(new Error('xlsx ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'));
        document.head.appendChild(s);
      });
    }

    async function exportXlsx() {
      try { await loadXlsxLib(); } catch(e) { alert(e.message); return; }
      const store  = loadStore();
      const months = Object.keys(store.months).sort();
      if (months.length === 0) { alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }

      const wb    = XLSX.utils.book_new();
      const wdays = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];

      for (const ym of months) {
        const monthData = store.months[ym];
        const header = ['æ—¥ä»˜','æ›œæ—¥','ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹','é–‹å§‹','çµ‚äº†','å‹¤å‹™æ™‚é–“','ç¥æ—¥','ãƒ¡ãƒ¢'];
        const rows   = [header];

        Object.keys(monthData).sort().forEach(d => {
          const rec = monthData[d];
          const dt  = new Date(d + 'T00:00:00');
          const wd  = wdays[dt.getDay()];

          // å‹¤å‹™æ™‚é–“ã‚’è¨ˆç®—
          let workHours = '';
          if (rec.start && rec.end) {
            const [sh, sm] = rec.start.split(':').map(Number);
            const [eh, em] = rec.end.split(':').map(Number);
            const diff = (eh * 60 + em) - (sh * 60 + sm);
            if (diff > 0) workHours = `${Math.floor(diff / 60)}:${String(diff % 60).padStart(2, '0')}`;
          }

          rows.push([
            d,
            wd,
            rec.status  || 'æœª',
            rec.start   || '',
            rec.end     || '',
            workHours,
            holidayName(d) || '',
            rec.memo    || ''
          ]);
        });

        const ws = XLSX.utils.aoa_to_sheet(rows);
        // åˆ—å¹…
        ws['!cols'] = [
          {wch:12},{wch:4},{wch:8},{wch:6},{wch:6},{wch:8},{wch:14},{wch:60}
        ];
        // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆèƒŒæ™¯è‰²ãªã©ï¼‰ã¯ xlsx.full ã§ã¯åˆ¥é€”è¦è¨­å®šã®ãŸã‚çœç•¥
        XLSX.utils.book_append_sheet(wb, ws, ym);
      }

      const fname = `kintai_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, fname);
      toast(`ğŸ“Š ${fname} ã‚’æ›¸ãå‡ºã—ã¾ã—ãŸ`);
    }

    document.getElementById('btn-xlsx').addEventListener('click', exportXlsx);

    /* =====================================================
       iSHç‰ˆãƒ‡ãƒ¼ã‚¿ç§»è¡Œï¼ˆPWAå†…ã‹ã‚‰åŒä¸€ã‚ªãƒªã‚¸ãƒ³fetchï¼‰
       ===================================================== */
    document.getElementById('btn-migrate').addEventListener('click', async () => {
      if (!confirm('iSHç‰ˆã®å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆ4ãƒ¶æœˆãƒ»73ä»¶ã®è¨˜éŒ²ï¼‰ã‚’ã“ã®ã‚¢ãƒ—ãƒªã«å–ã‚Šè¾¼ã¿ã¾ã™ã€‚\næ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¨ãƒãƒ¼ã‚¸ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
      setLoading(true);
      try {
        const res = await fetch('./kintai_backup_2026-02-22.json', { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (!data || !data.months) throw new Error('ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');

        // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨ãƒãƒ¼ã‚¸ï¼ˆæ—¢å­˜ã‚’å„ªå…ˆï¼‰
        const existing = loadStore();
        const merged = { months: { ...data.months, ...existing.months } };
        saveStore(merged);

        // æœˆã”ã¨ã®ä»¶æ•°é›†è¨ˆ
        const months = Object.keys(data.months);
        const total  = months.reduce((s, m) => s + Object.values(data.months[m]).filter(v => v.status && v.status !== 'æœª').length, 0);

        loadMonth(currentYear, currentMonth);
        toast(`âœ… ç§»è¡Œå®Œäº†ï¼${months.length}ãƒ¶æœˆãƒ»${total}ä»¶ã®è¨˜éŒ²ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸ`);
      } catch (e) {
        alert(`å–ã‚Šè¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}`);
      } finally {
        setLoading(false);
      }
    });

    /* =====================================================
       IMPORT / EXPORT
       ===================================================== */
    document.getElementById('btn-export').addEventListener('click', () => {
      exportJSON();
      markBackedUp();
      document.getElementById('backup-banner').classList.remove('show');
      toast('ğŸ’¾ JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    });

    document.getElementById('btn-import').addEventListener('click', () => {
      document.getElementById('file-import').click();
    });

    document.getElementById('file-import').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          const data = JSON.parse(ev.target.result);
          if (!data || !data.months) throw new Error('invalid format');
          if (!confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿï¼ˆå…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰')) return;
          saveStore(data);
          loadMonth(currentYear, currentMonth);
          toast('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
        } catch {
          alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    });

    /* =====================================================
       PROGRESS OVERLAY ãƒ˜ãƒ«ãƒ‘ãƒ¼
       ===================================================== */
    const _overlay  = document.getElementById('progress-overlay');
    const _progBar  = document.getElementById('progress-bar');
    const _progStep = document.getElementById('progress-step');
    const _progTitle= document.getElementById('progress-title');

    function showProgress(title) {
      _progTitle.textContent = title || 'å‡¦ç†ä¸­...';
      _progBar.style.width   = '0%';
      _progStep.textContent  = '';
      _overlay.classList.add('show');
      console.log(`[Progress] ${title}`);
    }
    function updateProgress(pct, stepMsg) {
      _progBar.style.width  = `${Math.min(pct, 100)}%`;
      _progStep.textContent = stepMsg || '';
      console.log(`[Progress] ${pct}% â€” ${stepMsg}`);
    }
    function hideProgress() {
      _overlay.classList.remove('show');
      console.log('[Progress] å®Œäº†');
    }

    /* =====================================================
       JINJER åŒæœŸï¼ˆãƒãƒ¼ã‚¸ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼‰
       ===================================================== */
    document.getElementById('btn-jinjer').addEventListener('click', () => {
      document.getElementById('file-jinjer').click();
    });

    document.getElementById('file-jinjer').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) { e.target.value = ''; return; }
      e.target.value = '';

      showProgress('ğŸ¢ jinjeråŒæœŸ');
      updateProgress(5, 'ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...');
      console.log('[jinjer] é–‹å§‹:', file.name, file.size, 'bytes');

      const reader = new FileReader();

      reader.onload = async ev => {
        try {
          // â‘  JSONè§£æï¼ˆUI ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ã‚ˆã† yieldï¼‰
          await tick();
          updateProgress(15, 'ğŸ” ãƒ‡ãƒ¼ã‚¿ã‚’è§£æä¸­...');
          let jinjer;
          try {
            jinjer = JSON.parse(ev.target.result);
          } catch(parseErr) {
            throw new Error('JSONã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + parseErr.message);
          }
          if (!jinjer || typeof jinjer.months !== 'object') throw new Error('months ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“');

          const monthKeys = Object.keys(jinjer.months);
          if (!monthKeys.length) throw new Error('å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
          console.log('[jinjer] å¯¾è±¡æœˆ:', monthKeys);
          updateProgress(25, `ğŸ“… å¯¾è±¡: ${monthKeys.join(', ')}`);

          // â‘¡ æ—¢å­˜ã‚¹ãƒˆã‚¢ã‚’èª­ã‚€
          await tick();
          updateProgress(35, 'ğŸ“– æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...');
          let store;
          try {
            store = loadStore();
          } catch(storeErr) {
            console.warn('[jinjer] loadStoreå¤±æ•—ã€ç©ºã‚¹ãƒˆã‚¢ã§ç¶šè¡Œ:', storeErr);
            store = { months: {} };
          }

          // â‘¢ ãƒãƒ£ãƒ³ã‚¯å‡¦ç†ï¼ˆ7æ—¥ãšã¤ã€å„ãƒãƒ£ãƒ³ã‚¯é–“ã§UIã«åˆ¶å¾¡ã‚’è¿”ã™ï¼‰
          const allDays = [];
          for (const [mk, days] of Object.entries(jinjer.months)) {
            if (!store.months[mk]) store.months[mk] = {};
            for (const [dk, jd] of Object.entries(days)) {
              allDays.push({ mk, dk, jd });
            }
          }
          const total = allDays.length;
          console.log(`[jinjer] å‡¦ç†å¯¾è±¡: ${total}æ—¥åˆ†`);

          const CHUNK = 7;
          let done = 0;
          for (let i = 0; i < allDays.length; i += CHUNK) {
            const chunk = allDays.slice(i, i + CHUNK);
            for (const { mk, dk, jd } of chunk) {
              const ex = store.months[mk][dk] || {};
              store.months[mk][dk] = {
                status: jd.status || ex.status || 'æœª',
                start:  jd.start  !== undefined ? jd.start  : (ex.start  || ''),
                end:    jd.end    !== undefined ? jd.end    : (ex.end    || ''),
                memo:   ex.memo   || '',
              };
              done++;
            }
            const pct = 35 + Math.round((done / total) * 45); // 35â†’80%
            updateProgress(pct, `ğŸ”„ ${done} / ${total} æ—¥ã‚’å‡¦ç†ä¸­...`);
            await tick(); // UIã«åˆ¶å¾¡ã‚’è¿”ã™
          }

          // â‘£ localStorage ã«ä¿å­˜ï¼ˆIDB ã¯éåŒæœŸfire-and-forgetï¼‰
          await tick();
          updateProgress(85, 'ğŸ’¾ localStorage ã«ä¿å­˜ä¸­...');
          try {
            localStorage.setItem(STORE_KEY, JSON.stringify(store));
            console.log('[jinjer] localStorage ä¿å­˜å®Œäº†');
          } catch(lsErr) {
            console.error('[jinjer] localStorage ä¿å­˜å¤±æ•—:', lsErr);
            throw new Error('ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç©ºãå®¹é‡ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
          }

          // â‘¤ IDB ãƒŸãƒ©ãƒ¼ï¼ˆå¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œï¼‰
          updateProgress(90, 'ğŸ’¾ IndexedDB ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸­...');
          try {
            await idbSave(store);
            console.log('[jinjer] IDB ä¿å­˜å®Œäº†');
          } catch(idbErr) {
            console.warn('[jinjer] IDB ä¿å­˜å¤±æ•—ï¼ˆç„¡è¦–ï¼‰:', idbErr);
          }

          // â‘¥ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å†æç”»
          await tick();
          updateProgress(97, 'ğŸ—“ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°ä¸­...');
          try {
            loadMonth(currentYear, currentMonth);
          } catch(renderErr) {
            console.warn('[jinjer] ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å†æç”»å¤±æ•—:', renderErr);
          }

          updateProgress(100, `âœ… ${done}æ—¥åˆ†ã®åŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸï¼`);
          console.log(`[jinjer] å®Œäº†: ${done}æ—¥åˆ†`);

          await new Promise(r => setTimeout(r, 900));
          hideProgress();
          toast(`âœ… jinjeråŒæœŸå®Œäº†ï¼ˆ${done}æ—¥åˆ†ï¼‰`);

        } catch(err) {
          console.error('[jinjer] è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼:', err);
          hideProgress();
          toast(`âŒ ${err.message || 'jinjeråŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ'}`);
        }
      };

      reader.onerror = () => {
        console.error('[jinjer] FileReader ã‚¨ãƒ©ãƒ¼');
        hideProgress();
        toast('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      };

      reader.readAsText(file, 'utf-8');
    });

    // UIã«åˆ¶å¾¡ã‚’è¿”ã™å°ã•ãªãƒ˜ãƒ«ãƒ‘ãƒ¼
    function tick() {
      return new Promise(r => setTimeout(r, 0));
    }

    /* =====================================================
       SETTINGS MODAL
       ===================================================== */
    document.getElementById('btn-settings').addEventListener('click', () => {
      const cfg = loadConfig();
      document.getElementById('settings-vault').value  = cfg.vault  || 'Phi_Memo';
      document.getElementById('settings-subdir').value = cfg.subdir || 'ã€æ¥­å‹™ã€‘/å‹¤æ€ ';
      document.getElementById('settings-modal').classList.add('show');
    });

    document.getElementById('settings-close').addEventListener('click', () => {
      document.getElementById('settings-modal').classList.remove('show');
    });
    document.getElementById('settings-cancel').addEventListener('click', () => {
      document.getElementById('settings-modal').classList.remove('show');
    });
    document.getElementById('settings-save').addEventListener('click', () => {
      const cfg = {
        vault:  document.getElementById('settings-vault').value.trim()  || 'Phi_Memo',
        subdir: document.getElementById('settings-subdir').value.trim() || 'ã€æ¥­å‹™ã€‘/å‹¤æ€ ',
      };
      saveConfig(cfg);
      document.getElementById('settings-modal').classList.remove('show');
      toast('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    });

    /* =====================================================
       EVENT HANDLERS
       ===================================================== */

    // Calendar click â†’ open modal
    document.addEventListener('click', ev => {
      const card = ev.target.closest('.day-card');
      if (card && !locked) {
        const dateStr = card.dataset.date;
        if (!dateStr) return;
        selectedDateStr = dateStr;
        document.querySelectorAll('.day-card.selected-day')
          .forEach(c => c.classList.remove('selected-day'));
        card.classList.add('selected-day');
        openModal(dateStr);
        return;
      }

      // Status chip
      const chip = ev.target.closest('.status-chip');
      if (chip && document.getElementById('memo-modal').classList.contains('show')) {
        document.querySelectorAll('.status-chip').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        return;
      }

      // Backdrop close
      const mModal = document.getElementById('memo-modal');
      if (mModal.classList.contains('show') && ev.target === mModal) { closeModal(); return; }
      const sModal = document.getElementById('settings-modal');
      if (sModal.classList.contains('show') && ev.target === sModal) {
        sModal.classList.remove('show');
      }
    });

    document.getElementById('modal-close').addEventListener('click', closeModal);
    document.getElementById('modal-cancel').addEventListener('click', closeModal);

    // Save
    document.getElementById('modal-save').addEventListener('click', () => {
      if (!currentEditDate) return;
      const status = getModalStatus();
      const memo   = document.getElementById('memo-textarea').value;
      const start  = document.getElementById('start-time').value || '';
      const end    = document.getElementById('end-time').value   || '';
      const ok = saveAttendance(currentEditDate, status, memo, start, end);
      if (ok) { closeModal(); toast('ä¿å­˜ã—ã¾ã—ãŸ'); }
    });

    // Duplicate: last template
    document.getElementById('btn-dup-last').addEventListener('click', () => {
      const t = getLastTemplate();
      if (!t) { alert('ç›´è¿‘ãƒ†ãƒ³ãƒ—ãƒ¬ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
      applyTemplate(t);
    });

    // Duplicate: prev day
    document.getElementById('btn-dup-prev').addEventListener('click', () => {
      if (!currentEditDate) return;
      const p = prevDateStr(currentEditDate);
      const prev = attendanceData[p];
      if (!prev) { alert('å‰æ—¥ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
      applyTemplate(prev);
    });

    // Obsidian
    document.getElementById('btn-obs-open').addEventListener('click', () => {
      if (!currentEditDate) return;
      obsidianOpen(currentEditDate);
    });

    // Month navigation
    document.getElementById('prev-month').addEventListener('click', () => {
      let y = currentYear, m = currentMonth - 1;
      if (m === 0) { m = 12; y--; }
      loadMonth(y, m);
    });
    document.getElementById('next-month').addEventListener('click', () => {
      let y = currentYear, m = currentMonth + 1;
      if (m === 13) { m = 1; y++; }
      loadMonth(y, m);
    });
    document.getElementById('today-button').addEventListener('click', () => {
      const t = new Date();
      loadMonth(t.getFullYear(), t.getMonth() + 1);
    });

    // Lock
    document.getElementById('lock-toggle').addEventListener('click', () => {
      locked = !locked;
      const btn   = document.getElementById('lock-toggle');
      const label = document.getElementById('lock-label');
      btn.classList.toggle('pill-button-lock-on', locked);
      label.textContent = locked ? 'ãƒ­ãƒƒã‚¯ä¸­' : 'ãƒ­ãƒƒã‚¯';
      document.getElementById('calendar-card').classList.toggle('locked', locked);
    });

    // Install banner
    const installBanner = document.getElementById('install-banner');
    const isStandalone  = window.matchMedia('(display-mode: standalone)').matches
                       || navigator.standalone === true;
    const bannerDismissed = sessionStorage.getItem('install_banner_dismissed');
    if (!isStandalone && !bannerDismissed) {
      installBanner.classList.add('show');
    }
    document.getElementById('install-close').addEventListener('click', () => {
      installBanner.classList.remove('show');
      sessionStorage.setItem('install_banner_dismissed', '1');
    });

    /* =====================================================
       MONTHLY STATS
       ===================================================== */
    function calcMonthStats(year, month) {
      const ym   = `${year}-${String(month).padStart(2,'0')}`;
      const raw  = loadStore().months[ym] || {};
      let office = 0, home = 0, off = 0, totalMin = 0;

      Object.values(raw).forEach(rec => {
        const { data } = applyAutoRules({ [rec.date]: rec });
        const st = data[rec.date]?.status || 'æœª';
        if (st === 'å‡ºç¤¾')                           office++;
        else if (st === 'åœ¨å®…')                      home++;
        else if (['ä¼‘ã¿','ä¼‘æ—¥','ç¥æ—¥'].includes(st)) off++;

        if (rec.start && rec.end) {
          const [sh, sm] = rec.start.split(':').map(Number);
          const [eh, em] = rec.end.split(':').map(Number);
          const d = (eh * 60 + em) - (sh * 60 + sm);
          if (d > 0) totalMin += d;
        }
      });

      const h = Math.floor(totalMin / 60);
      const m = totalMin % 60;
      return { office, home, off, hours: h, mins: m };
    }

    function renderStats(year, month) {
      const s = calcMonthStats(year, month);
      document.getElementById('stat-office').textContent = s.office;
      document.getElementById('stat-home').textContent   = s.home;
      document.getElementById('stat-off').textContent    = s.off;
      document.getElementById('stat-hours').textContent  =
        s.hours > 0 ? `${s.hours}h${s.mins > 0 ? s.mins + 'm' : ''}` : '0h';
    }

    /* =====================================================
       AUTO BACKUP SYSTEM
       ===================================================== */
    const BACKUP_KEY           = 'kintai_last_backup';
    const BACKUP_INTERVAL_DAYS = 7;

    function daysSinceBackup() {
      const last = localStorage.getItem(BACKUP_KEY);
      if (!last) return 999;
      return Math.floor((Date.now() - parseInt(last)) / 86400000);
    }

    function markBackedUp() {
      localStorage.setItem(BACKUP_KEY, Date.now().toString());
    }

    function checkBackupReminder() {
      const days = daysSinceBackup();
      if (days >= BACKUP_INTERVAL_DAYS) {
        const msg = days >= 999
          ? 'ã¾ã ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“'
          : `å‰å›ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ <strong>${days}æ—¥</strong> çµŒéã—ã¦ã„ã¾ã™`;
        document.getElementById('backup-days-msg').innerHTML = msg;
        document.getElementById('backup-banner').classList.add('show');
      }
    }

    // JSON ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆå˜ä½“ï¼‰
    function exportJSON() {
      const store = loadStore();
      const blob  = new Blob([JSON.stringify(store, null, 2)], { type: 'application/json' });
      const a     = document.createElement('a');
      a.href      = URL.createObjectURL(blob);
      a.download  = `kintai_backup_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // JSON + xlsx ã‚’é€£ç¶šãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆä¸€æ‹¬ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰
    async function oneClickBackup() {
      exportJSON();
      markBackedUp();
      document.getElementById('backup-banner').classList.remove('show');
      toast('âœ… JSON + xlsx ã‚’ä¿å­˜ã—ã¾ã™...');
      await new Promise(r => setTimeout(r, 800)); // iOS ã§åŒæ™‚DLãŒè©°ã¾ã‚‰ãªã„ã‚ˆã†å°‘ã—é–“éš”ã‚’ç½®ã
      await exportXlsx();
    }

    document.getElementById('btn-backup-now').addEventListener('click', oneClickBackup);
    document.getElementById('backup-dismiss').addEventListener('click', () => {
      document.getElementById('backup-banner').classList.remove('show');
    });

    // ã‚¢ãƒ—ãƒªãŒå‰é¢ã«æ¥ã‚‹ãŸã³ã«ãƒã‚§ãƒƒã‚¯
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') checkBackupReminder();
    });

    /* =====================================================
       SWIPE GESTUREï¼ˆå·¦å³ã‚¹ãƒ¯ã‚¤ãƒ—ã§æœˆåˆ‡ã‚Šæ›¿ãˆï¼‰
       ===================================================== */
    let _swipeX = 0, _swipeY = 0;
    document.getElementById('calendar-card').addEventListener('touchstart', e => {
      _swipeX = e.touches[0].clientX;
      _swipeY = e.touches[0].clientY;
    }, { passive: true });

    document.getElementById('calendar-card').addEventListener('touchend', e => {
      const dx = e.changedTouches[0].clientX - _swipeX;
      const dy = e.changedTouches[0].clientY - _swipeY;
      if (Math.abs(dx) < 50 || Math.abs(dx) < Math.abs(dy) * 1.2) return; // ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é™¤å¤–
      if (dx < 0) {
        // å·¦ã‚¹ãƒ¯ã‚¤ãƒ— â†’ æ¬¡æœˆ
        let y = currentYear, m = currentMonth + 1;
        if (m === 13) { m = 1; y++; }
        loadMonth(y, m);
      } else {
        // å³ã‚¹ãƒ¯ã‚¤ãƒ— â†’ å‰æœˆ
        let y = currentYear, m = currentMonth - 1;
        if (m === 0) { m = 12; y--; }
        loadMonth(y, m);
      }
    }, { passive: true });

    /* =====================================================
       FLOATING TODAY BUTTON
       ===================================================== */
    (function initFab() {
      const t   = new Date();
      const fab = document.getElementById('fab-today');
      document.getElementById('fab-day').textContent = t.getDate();

      fab.addEventListener('click', () => {
        const today = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;
        // ä»Šæœˆã§ãªã‘ã‚Œã°ä»Šæœˆã¸ç§»å‹•ã—ã¦ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        if (currentYear !== t.getFullYear() || currentMonth !== t.getMonth() + 1) {
          loadMonth(t.getFullYear(), t.getMonth() + 1);
          setTimeout(() => openModal(today), 150);
        } else {
          openModal(today);
        }
      });

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ã‚‹ã¨ãã¯éš ã™
      const observer = new MutationObserver(() => {
        const modalOpen = document.getElementById('memo-modal').classList.contains('show')
                       || document.getElementById('settings-modal').classList.contains('show');
        fab.classList.toggle('hidden', modalOpen);
      });
      observer.observe(document.getElementById('memo-modal'),     { attributes: true });
      observer.observe(document.getElementById('settings-modal'), { attributes: true });
    })();

    /* =====================================================
       GENERATE APP ICON (canvas â†’ apple-touch-icon)
       ===================================================== */
    (function generateIcon() {
      try {
        const c   = document.createElement('canvas');
        c.width   = 192;
        c.height  = 192;
        const ctx = c.getContext('2d');
        // Background
        ctx.fillStyle = '#4f8dfd';
        ctx.beginPath();
        ctx.roundRect(0, 0, 192, 192, 36);
        ctx.fill();
        // Text
        ctx.fillStyle = '#ffffff';
        ctx.font = 'bold 90px -apple-system, "Helvetica Neue", sans-serif';
        ctx.textAlign    = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('å‹¤', 96, 102);
        document.getElementById('apple-touch-icon-link').href = c.toDataURL('image/png');
      } catch (_) {}
    })();

    /* =====================================================
       INIT
       ===================================================== */
    (async function init() {
      try {
        const t = new Date();
        // IDBå¾©å…ƒï¼ˆå¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œï¼‰
        let restored = false;
        try { restored = await restoreFromIDBIfNeeded(); } catch(e) { console.warn('[init] IDBå¾©å…ƒã‚¹ã‚­ãƒƒãƒ—:', e); }
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»ï¼ˆå¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œï¼‰
        try { loadMonth(t.getFullYear(), t.getMonth() + 1); } catch(e) { console.warn('[init] loadMonthå¤±æ•—:', e); }
        if (restored) {
          try { renderCalendar(t.getFullYear(), t.getMonth() + 1); } catch(e) {}
          try { renderStats(t.getFullYear(), t.getMonth() + 1); }  catch(e) {}
        }
        try { checkBackupReminder(); } catch(e) {}
        // èµ·å‹•æˆåŠŸ â†’ ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã‚«ã‚¦ãƒ³ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
        localStorage.setItem(_CRASH_KEY, '0');
      } catch(fatal) {
        console.error('[init] è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼:', fatal);
      }
    })();

    /* =====================================================
       TASK MANAGEMENT
       ===================================================== */
    const TASKS_KEY = 'kintai_tasks_v1';

    function loadTasks() {
      try { return JSON.parse(localStorage.getItem(TASKS_KEY) || '[]'); } catch { return []; }
    }

    function saveTasks(tasks) {
      localStorage.setItem(TASKS_KEY, JSON.stringify(tasks));
    }

    function _esc(s) {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function taskItemHTML(t) {
      const memoHTML = t.memo ? `<div class="task-memo">${_esc(t.memo)}</div>` : '';
      return `<div class="task-item${t.done ? ' done' : ''}">
        <input type="checkbox" class="task-check" data-id="${t.id}" ${t.done ? 'checked' : ''}>
        <div class="task-body">
          <div class="task-title">${_esc(t.title)}</div>${memoHTML}
        </div>
        <button class="task-del" data-id="${t.id}" title="å‰Šé™¤">ğŸ—‘</button>
      </div>`;
    }

    function renderTaskList() {
      const tasks     = loadTasks();
      const container = document.getElementById('task-list-container');
      const todo      = tasks.filter(t => !t.done);
      const done      = tasks.filter(t => t.done);
      let html = '';
      if (!todo.length && !done.length) {
        html = '<div class="task-empty">ã‚¿ã‚¹ã‚¯ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“<br>ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è¿½åŠ ã§ãã¾ã™</div>';
      } else {
        if (todo.length) html += '<div class="task-section-title">æœªå®Œäº†</div><div class="task-list">' + todo.map(taskItemHTML).join('') + '</div>';
        if (done.length) html += '<div class="task-section-title">å®Œäº†æ¸ˆã¿</div><div class="task-list">' + done.map(taskItemHTML).join('') + '</div>';
      }
      container.innerHTML = html;

      container.querySelectorAll('.task-check').forEach(cb => {
        cb.addEventListener('change', () => {
          const ts = loadTasks();
          const idx = ts.findIndex(t => t.id === cb.dataset.id);
          if (idx !== -1) { ts[idx].done = cb.checked; saveTasks(ts); renderTaskList(); }
        });
      });
      container.querySelectorAll('.task-del').forEach(btn => {
        btn.addEventListener('click', () => {
          if (!confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
          saveTasks(loadTasks().filter(t => t.id !== btn.dataset.id));
          renderTaskList();
        });
      });
    }

    (function initTaskModal() {
      const modal    = document.getElementById('task-modal');
      const fab      = document.getElementById('fab-task');
      const closeBtn = document.getElementById('task-modal-close');
      const addBtn   = document.getElementById('task-add-btn');
      const titleIn  = document.getElementById('task-title-input');
      const memoIn   = document.getElementById('task-memo-input');

      function openTaskModal() {
        modal.classList.add('show');
        renderTaskList();
        setTimeout(() => titleIn.focus(), 100);
      }
      function closeTaskModal() {
        modal.classList.remove('show');
        titleIn.value = '';
        memoIn.value  = '';
      }

      fab.addEventListener('click', openTaskModal);
      closeBtn.addEventListener('click', closeTaskModal);
      modal.addEventListener('click', e => { if (e.target === modal) closeTaskModal(); });

      addBtn.addEventListener('click', () => {
        const title = titleIn.value.trim();
        if (!title) { toast('ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); titleIn.focus(); return; }
        const ts = loadTasks();
        ts.unshift({ id: Date.now().toString(), title, memo: memoIn.value.trim(), done: false, created: new Date().toISOString() });
        saveTasks(ts);
        titleIn.value = '';
        memoIn.value  = '';
        renderTaskList();
        toast('âœ… ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
      });

      titleIn.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); addBtn.click(); }
      });

      // fab-task ã¯ memo-modal / settings-modal ãŒé–‹ã„ã¦ã„ã‚‹ã¨ãéš ã™
      const fabToday = document.getElementById('fab-today');
      const hideOnOtherModal = new MutationObserver(() => {
        const anyOther = document.getElementById('memo-modal').classList.contains('show')
                      || document.getElementById('settings-modal').classList.contains('show');
        fab.classList.toggle('hidden', anyOther);
      });
      hideOnOtherModal.observe(document.getElementById('memo-modal'),     { attributes: true });
      hideOnOtherModal.observe(document.getElementById('settings-modal'), { attributes: true });

      // fab-today ã¯ task-modal ãŒé–‹ã„ã¦ã„ã‚‹ã¨ãéš ã™
      new MutationObserver(() => {
        const open = modal.classList.contains('show');
        fabToday.classList.toggle('hidden', open);
        fab.classList.toggle('hidden', open);
      }).observe(modal, { attributes: true });
    })();

    /* =====================================================
       SERVICE WORKER
       ===================================================== */
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(err => {
        console.warn('ServiceWorker registration failed:', err);
      });
    }
  </script>
</body>
</html>
