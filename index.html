<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>勤怠カレンダー</title>

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="勤怠">
  <link rel="apple-touch-icon" href="icon-apple.png">

  <!-- Android / General PWA -->
  <meta name="theme-color" content="#7c5fe6">
  <link rel="manifest" href="manifest.json">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; connect-src 'self' https://api.open-meteo.com https://geocoding-api.open-meteo.com https://api.anthropic.com https://api.openai.com https://generativelanguage.googleapis.com http:;">
  <!-- リソースヒント: xlsx遅延ロード時のDNS/TCP待機を事前に解消 -->
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <!-- xlsx は Excel出力ボタン押下時に遅延ロード（iOS OOM対策） -->
  <!-- QR コード生成（設定画面でCloudflare TunnelのURLをQR表示するため） -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>
  <!-- Mermaid — 構成図・ER図・シーケンス図を仕様タブで描画 -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js" defer></script>

  <style>
    :root {
      --bg-page: #eef1fb;
      --bg-card: rgba(255,255,255,0.82);
      --bg-card-solid: #ffffff;
      --border-soft: rgba(180,190,220,0.5);
      --border-color: rgba(180,190,220,0.5);
      --accent-blue: #4f8dfd;
      --accent-purple: #7c5fe6;
      --text-main: #1a1c2e;
      --text-muted: #8890a0;
      --radius-card: 28px;
      --glass-blur: blur(22px) saturate(1.4);
      --shadow-card: 0 8px 40px rgba(60,80,200,0.09), 0 1px 0 rgba(255,255,255,0.7) inset;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --tab-bar-h: 60px;
    }

    * { box-sizing: border-box; }

    html { overflow-x: hidden; }
    body {
      margin: 0;
      padding: calc(max(var(--safe-top), 12px)) 12px calc(max(var(--safe-bottom), 0px) + var(--tab-bar-h) + 16px);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      background: linear-gradient(145deg, #d8e8ff 0%, #e8ddff 45%, #ffd8f0 100%) fixed;
      color: var(--text-main);
      min-height: 100dvh;
      overflow-x: hidden;
    }

    /* ======= PC レスポンシブ (768px+) ======= */
    @media (min-width: 768px) {
      :root { --tab-bar-h: 0px; }
      body {
        padding: 16px 24px 24px 244px; /* 左220px + 余白 */
      }
      /* タブバーをサイドバーに変換 */
      .bottom-tabs {
        position: fixed;
        top: 0; left: 0; right: auto; bottom: 0;
        width: 220px;
        height: 100dvh;
        flex-direction: column;
        overflow-y: auto;
        overflow-x: hidden;
        border-right: 1px solid var(--border-soft);
        border-top: none;
        padding: 16px 0 80px;
        gap: 2px;
        scrollbar-width: none;
      }
      .bottom-tabs::-webkit-scrollbar { display: none; }
      .tab-btn {
        border-radius: 12px;
        margin: 0 8px;
        padding: 10px 14px;
        text-align: left;
        font-size: 14px;
        min-width: unset;
        width: calc(100% - 16px);
        flex-shrink: 0;
        flex-direction: row;
        gap: 8px;
        justify-content: flex-start;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .tab-btn .tab-icon { font-size: 18px; }
      .tab-btn .tab-label { font-size: 13px; }
      .tab-manage-btn {
        position: fixed;
        bottom: 16px; left: 8px;
        width: 204px;
        border-radius: 12px;
      }
      /* ヘルスバーはサイドバー上部に固定 */
      #health-bar {
        position: fixed;
        top: 0; left: 0;
        width: 220px;
        border-radius: 0;
        border-bottom: 1px solid var(--border-soft);
        border-right: 1px solid var(--border-soft);
        border-top: none;
        z-index: 900;
      }
      /* カードをPC幅に */
      .card { max-width: 100%; }
      /* FABはPC非表示 */
      #fab-group { display: none !important; }
      /* モーダルはPC幅制限 */
      .modal-sheet { max-width: 560px; margin: auto; border-radius: 20px; }
    }

    /* ======= CARD ======= */
    .card {
      max-width: 960px;
      margin: 0 auto;
      background: var(--bg-card);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border-radius: var(--radius-card);
      border: 1px solid rgba(255,255,255,0.65);
      box-shadow: var(--shadow-card);
      padding: 16px 16px 12px;
      position: relative;
      overflow: hidden;
    }

    .card-title {
      font-size: 11px;
      font-weight: 800;
      margin-bottom: 10px;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    /* ======= HEADER ======= */
    .header-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }
    .header-left, .header-right {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .pill-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 7px 14px;
      font-size: 13px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.7);
      background: rgba(255,255,255,0.55);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      cursor: pointer;
      user-select: none;
      font-family: inherit;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .pill-button .icon { margin-right: 5px; font-size: 13px; }
    .pill-button-primary {
      background: #eef3ff;
      border-color: #c5d2ff;
      color: var(--accent-blue);
      font-weight: 600;
    }
    .pill-button-lock-on {
      background: #ffece5;
      border-color: #ffc1a6;
      color: #f57c00;
      font-weight: 800;
    }
    .month-label { font-size: 20px; font-weight: 800; letter-spacing: -.02em; }
    .nav-arrow {
      width: 32px; height: 32px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.7);
      background: rgba(255,255,255,0.5);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 17px;
      user-select: none;
      font-family: inherit;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    }
    .nav-arrow:active { transform: scale(0.93); }

    /* ======= CALENDAR ======= */
    .calendar-wrapper {
      margin-top: 8px;
      border-radius: 20px;
      overflow: hidden;
      border: 1px solid rgba(180,190,220,0.35);
      box-shadow: 0 2px 12px rgba(60,80,200,0.06);
    }
    table.calendar {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 11px;
    }
    table.calendar th {
      background: rgba(245,246,251,0.7);
      text-align: center;
      padding: 7px 0;
      color: var(--text-muted);
      font-weight: 700;
      font-size: 12px;
      letter-spacing: .02em;
    }
    table.calendar td {
      padding: 3px;
      background: #fff;
      vertical-align: top;
    }
    .day-card {
      border-radius: 14px;
      border: 1.5px solid #e3e7f0;
      padding: 5px 5px 26px;
      min-height: 60px;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 3px;
      background: #fbfbfe;
      transition: border-color 0.12s, box-shadow 0.12s, background 0.12s;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .day-card:active { transform: scale(0.98); }
    .day-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 3px;
    }
    .day-number {
      font-size: 12px;
      font-weight: 800;
      color: var(--text-main);
      min-width: 16px;
    }
    .day-number.sun { color: #c62828; }
    .day-number.sat { color: #1565c0; }
    .status-pill {
      flex: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid transparent;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 700;
      user-select: none;
    }
    .status-pill-未    { background:#f4f4f6; color:var(--text-muted); border-color:#e0e0e5; }
    .status-pill-出社  { background:#e3f2fd; color:#1565c0; border-color:#bbdefb; }
    .status-pill-在宅  { background:#e8f5e9; color:#2e7d32; border-color:#c8e6c9; }
    .status-pill-休み  { background:#fff8e1; color:#ef6c00; border-color:#ffe0b2; }
    .status-pill-祝日  { background:#ffebee; color:#c62828; border-color:#ffcdd2; }
    .status-pill-休日  { background:#ede7f6; color:#5e35b1; border-color:#d1c4e9; }

    .day-card-status-未    { border-color:#e4e5f0; background:#fbfbfe; }
    .day-card-status-出社  { border-color:#8ab4ff; background:#eaf3ff; }
    .day-card-status-在宅  { border-color:#7bc47f; background:#e9f7ec; }
    .day-card-status-休み  { border-color:#ffb74d; background:#fff5e3; }
    .day-card-status-祝日  { border-color:#ef5350; background:#ffebee; }
    .day-card-status-休日  { border-color:#b39ddb; background:#f3e5f5; }

    .dropdown-icon { font-size: 9px; padding-left: 3px; opacity:.7; }
    .memo-dot { font-size:11px; color:#ff9800; margin-left:3px; user-select:none; }
    .today-ring { box-shadow: 0 0 0 2px var(--accent-blue); }
    .selected-day { box-shadow: 0 0 0 2px var(--accent-blue); }
    .subline {
      font-size: 10px; color:#6b7280; line-height:1.2;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      user-select:none;
    }
    .holiday-name {
      font-size: 10px; color:#c62828; line-height:1.2;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      user-select:none;
    }
    .cell-actions {
      position:absolute; right:5px; bottom:5px;
      display:flex; gap:5px; z-index:2;
    }
    .mini-btn {
      border:1px solid rgba(0,0,0,0.08);
      background:rgba(255,255,255,0.9);
      backdrop-filter:blur(6px);
      -webkit-backdrop-filter:blur(6px);
      padding:3px 7px;
      border-radius:999px;
      font-size:10px; font-weight:900; color:#2563eb;
      cursor:pointer; user-select:none; line-height:1;
      box-shadow:0 4px 10px rgba(0,0,0,0.06);
      font-family:inherit;
    }
    .mini-btn:active { transform:scale(0.97); }
    .locked .day-card { opacity:0.55; }
    .locked .day-card { cursor:default; pointer-events:none; }

    /* ======= FOOTER ======= */
    .footer {
      margin-top: 8px;
      font-size: 10px;
      color: var(--text-muted);
      line-height: 1.4;
    }
    .legend span.badge {
      padding:2px 6px; border-radius:6px;
      margin-right:3px; font-weight:700; display:inline-block;
    }
    .badge-work   { background:#e3f2fd; color:#1565c0; }
    .badge-home   { background:#e8f5e9; color:#2e7d32; }
    .badge-holiday{ background:#fff8e1; color:#ef6c00; }
    .badge-shuku  { background:#ffebee; color:#c62828; }
    .badge-kyujitsu{ background:#ede7f6; color:#5e35b1; }

    .data-actions {
      margin-top: 8px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .data-btn {
      padding: 7px 13px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.7);
      background: rgba(255,255,255,0.65);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      cursor: pointer;
      user-select: none;
      font-weight: 700;
      font-family: inherit;
      color: var(--text-main);
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .data-btn:active { transform: scale(0.96); }

    /* ======= MODAL ======= */
    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 999;
    }
    .modal-backdrop.show { display: flex; }
    .modal-sheet {
      width: 100%;
      max-width: 560px;
      max-height: 92vh;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(28px) saturate(1.4);
      -webkit-backdrop-filter: blur(28px) saturate(1.4);
      border-radius: 26px 26px 0 0;
      border-top: 1px solid rgba(255,255,255,0.8);
      padding: 12px 16px calc(max(var(--safe-bottom), 14px));
      box-shadow: 0 -8px 36px rgba(60,80,200,0.13);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .modal-handle {
      width: 34px; height: 4px;
      border-radius: 999px; background: #d0d0d5;
      margin: 0 auto 10px;
    }
    .modal-header {
      display: flex; align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 13px; font-weight: 800;
    }
    .modal-close {
      font-size: 22px; line-height:1;
      cursor:pointer; color:var(--text-muted); user-select:none;
    }
    .modal-section-title {
      font-size:11px; color:var(--text-muted);
      margin-bottom:5px; font-weight:700;
    }
    .status-chip-row { display:flex; gap:5px; margin-bottom:10px; flex-wrap:wrap; }
    .status-chip {
      flex:1; min-width:56px;
      border-radius:999px; padding:8px 6px;
      font-size:12px; text-align:center;
      border:1px solid var(--border-soft);
      background:#f6f7fb;
      cursor:pointer; user-select:none; font-weight:700;
      font-family:inherit;
    }
    .status-chip.active {
      border-color:var(--accent-blue);
      background:#e3edff; color:var(--accent-blue);
    }
    .row-time { display:flex; gap:8px; align-items:center; margin-bottom:10px; }
    .time-input {
      flex:1; padding:10px 10px;
      border-radius:12px; border:1px solid var(--border-soft);
      font-size:14px; font-family:inherit; background:#fff;
    }
    .memo-textarea {
      width:100%; min-height:80px; resize:vertical;
      border-radius:12px; border:1px solid var(--border-soft);
      padding:10px; font-size:13px; font-family:inherit;
    }
    .dup-row { display:flex; gap:8px; margin:4px 0 10px; }
    .dup-row .btn-secondary { flex:1; }
    .obs-row { display:flex; gap:8px; margin:6px 0 4px; }
    .obs-row .btn-secondary { flex:1; }
    .modal-footer {
      margin-top:10px; display:flex;
      justify-content:flex-end; gap:10px; flex-shrink:0;
    }
    .btn-secondary {
      padding:10px 14px; font-size:13px;
      border-radius:999px; border:1px solid var(--border-soft);
      background:#f4f5f9; cursor:pointer; user-select:none;
      font-weight:700; font-family:inherit;
    }
    .btn-primary {
      padding:10px 20px; font-size:13px;
      border-radius:999px; border:none;
      background:linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
      color:#fff;
      font-weight:900; cursor:pointer; user-select:none;
      font-family:inherit;
      box-shadow: 0 4px 14px rgba(79,141,253,0.38);
    }
    .btn-primary:active { transform: scale(0.97); }

    /* ======= SETTINGS MODAL ======= */
    .settings-body { display:flex; flex-direction:column; gap:12px; overflow-y:auto; -webkit-overflow-scrolling:touch; flex:1; min-height:0; }
    .settings-row { display:flex; flex-direction:column; gap:5px; }
    .settings-label { font-size:12px; font-weight:700; color:var(--text-muted); }
    .settings-input {
      padding:10px; border-radius:12px;
      border:1px solid var(--border-soft);
      font-size:14px; font-family:inherit; background:#fff;
    }
    .settings-hint { font-size:11px; color:var(--text-muted); line-height:1.4; }

    /* ======= OVERLAY / SPINNER ======= */
    .overlay {
      position:absolute; inset:0;
      background:rgba(255,255,255,0.65);
      display:none; align-items:center; justify-content:center;
      z-index:50;
      backdrop-filter:blur(2px); -webkit-backdrop-filter:blur(2px);
    }
    .overlay.show { display:flex; }
    .spinner {
      width:28px; height:28px; border-radius:999px;
      border:3px solid rgba(79,141,253,0.25);
      border-top-color:rgba(79,141,253,1);
      animation:spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* ======= TOAST ======= */
    .toast {
      position: fixed;
      left: 50%;
      bottom: calc(max(var(--safe-bottom), 20px) + var(--tab-bar-h) + 8px);
      transform: translateX(-50%) translateY(12px);
      background: rgba(22, 24, 38, 0.92);
      color: #fff;
      padding: 10px 18px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 700;
      z-index: 2000;
      max-width: 92vw;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      opacity: 0;
      pointer-events: none;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 4px 24px rgba(0,0,0,0.28);
      transition: opacity 0.22s ease, transform 0.22s cubic-bezier(0.22,1,0.36,1);
    }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* ======= PROGRESS OVERLAY ======= */
    .progress-overlay {
      position:fixed; inset:0; z-index:3000;
      background:rgba(0,0,0,0.55);
      display:none; align-items:center; justify-content:center;
    }
    .progress-overlay.show { display:flex; }
    .progress-box {
      background:var(--bg-card); border-radius:18px;
      padding:24px 28px; min-width:260px; max-width:90vw;
      box-shadow:0 8px 32px rgba(0,0,0,0.25);
      display:flex; flex-direction:column; gap:14px; align-items:center;
    }
    .progress-title { font-size:15px; font-weight:800; color:var(--text-main); }
    .progress-step  { font-size:13px; color:var(--text-muted); text-align:center; line-height:1.6; }
    .progress-bar-wrap {
      width:100%; height:8px; background:var(--border-color);
      border-radius:999px; overflow:hidden;
    }
    .progress-bar-fill {
      height:100%; background:var(--accent-blue);
      border-radius:999px;
      transition:width 0.3s ease;
      width:0%;
    }
    .progress-spinner {
      width:32px; height:32px;
      border:3px solid var(--border-color);
      border-top-color:var(--accent-blue);
      border-radius:50%;
      animation:spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* ======= NETWORK STATUS BANNER ======= */
    .net-banner {
      position: fixed; top: calc(max(var(--safe-top), 0px));
      left: 0; right: 0; z-index: 4000;
      background: rgba(30,30,30,0.92);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      color: #fff; font-size: 13px; font-weight: 700;
      padding: 10px 16px; text-align: center;
      transform: translateY(-100%);
      transition: transform 0.35s cubic-bezier(0.4,0,0.2,1);
    }
    .net-banner.show  { transform: translateY(0); }
    .net-banner.online  { background: rgba(34,136,56,0.92); }
    .net-banner.offline { background: rgba(180,30,30,0.92); }

    /* ======= SKELETON / SHIMMER LOADING ======= */
    @keyframes shimmer {
      0%   { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    .skeleton {
      background: linear-gradient(90deg,
        rgba(200,210,230,0.35) 25%,
        rgba(220,228,245,0.55) 50%,
        rgba(200,210,230,0.35) 75%
      );
      background-size: 200% 100%;
      animation: shimmer 1.6s infinite;
      border-radius: 8px;
    }

    /* ======= GLOBAL BUTTON MICRO-INTERACTIONS ======= */
    .pill-button,
    .data-btn,
    .btn-secondary,
    .fab-group-toggle,
    .fab-today,
    .fab-task,
    .fab-recover {
      -webkit-tap-highlight-color: transparent;
      transition: transform 0.12s cubic-bezier(0.34,1.56,0.64,1),
                  opacity 0.12s ease,
                  box-shadow 0.12s ease;
    }
    .pill-button:active,
    .data-btn:active,
    .btn-secondary:active {
      transform: scale(0.96);
      opacity: 0.88;
    }

    /* ======= CARD HOVER ELEVATION ======= */
    @media (hover: hover) {
      .card {
        transition: box-shadow 0.22s ease, transform 0.22s cubic-bezier(0.22,1,0.36,1);
      }
      .card:hover {
        box-shadow: 0 12px 48px rgba(60,80,200,0.14), 0 1px 0 rgba(255,255,255,0.7) inset;
        transform: translateY(-1px);
      }
    }

    /* ======= INSTALL BANNER ======= */
    .install-banner {
      background:#eef3ff; border:1px solid #c5d2ff;
      border-radius:14px; padding:10px 14px;
      margin-bottom:10px; font-size:12px;
      color:#1565c0; line-height:1.5;
      display:none;
    }
    .install-banner.show { display:block; }
    .install-banner strong { font-weight:800; }
    .install-close {
      float:right; cursor:pointer;
      font-size:18px; line-height:1; color:#1565c0;
      margin-left:8px;
    }

    /* ======= BACKUP BANNER ======= */
    .backup-banner {
      background:#fff8e1; border:1px solid #ffe0b2;
      border-radius:14px; padding:10px 14px;
      margin-bottom:10px; font-size:12px;
      color:#e65100; line-height:1.5; display:none;
    }
    .backup-banner.show { display:block; }
    .backup-banner-row {
      display:flex; align-items:center;
      justify-content:space-between; gap:8px;
    }
    .backup-banner-text { flex:1; }
    .backup-banner strong { font-weight:800; }
    .backup-now-btn {
      padding:7px 14px; font-size:12px; font-weight:800;
      border-radius:999px; border:none;
      background:#f57c00; color:#fff;
      cursor:pointer; white-space:nowrap;
      font-family:inherit;
    }
    .backup-dismiss {
      cursor:pointer; font-size:16px; opacity:.6;
      margin-left:4px; user-select:none;
    }

    /* ======= STATS BAR ======= */
    .stats-bar {
      display:flex; gap:5px; flex-wrap:wrap;
      padding:6px 0 8px;
      margin-bottom:4px;
    }
    .stat-chip {
      display:inline-flex; align-items:center; gap:4px;
      padding:4px 11px; border-radius:999px;
      font-size:11px; font-weight:700;
      border:1px solid rgba(255,255,255,0.65);
      box-shadow:0 1px 4px rgba(0,0,0,0.06);
    }
    .stat-chip b { font-size:13px; }
    .stat-office  { background:rgba(227,242,253,0.92); color:#1565c0; border-color:#bbdefb; }
    .stat-home    { background:rgba(232,245,233,0.92); color:#2e7d32; border-color:#c8e6c9; }
    .stat-off     { background:rgba(255,248,225,0.92); color:#ef6c00; border-color:#ffe0b2; }
    .stat-hours   { background:rgba(243,229,245,0.92); color:#6a1b9a; border-color:#e1bee7; }
    .stat-weekly-toggle {
      background:rgba(237,231,246,0.92); color:#5e35b1; border-color:#d1c4e9;
      cursor:pointer; font-family:inherit;
      transition:background 0.15s;
    }
    .stat-weekly-toggle:active { background:rgba(220,208,240,1); transform:scale(0.97); }

    /* ======= WEEKLY STATS (折りたたみ) ======= */
    .weekly-stats {
      font-size: 12px;
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.38s cubic-bezier(0.4,0,0.2,1), padding 0.2s;
      padding: 0;
    }
    .weekly-stats.open {
      max-height: 320px;
      padding: 8px 0 4px;
      border-top: 1px solid var(--border-soft);
      margin-bottom: 4px;
    }
    .weekly-stats table {
      width: 100%;
      border-collapse: collapse;
    }
    .weekly-stats td {
      padding: 4px 4px;
      vertical-align: middle;
    }
    .weekly-stats .w-label { color: var(--text-muted); min-width: 112px; font-size:11px; }
    .weekly-stats .w-hours { font-weight: 700; min-width: 60px; color: var(--text-main); }
    .weekly-stats .w-pm    { color: var(--accent-purple); font-weight: 800; text-align: right; white-space:nowrap; }
    .weekly-stats .w-bar-cell { width: 100%; padding-left: 8px; }
    .w-bar-bg  { background: rgba(124,95,230,0.12); border-radius: 4px; height: 7px; overflow: hidden; }
    .w-bar-fill{ background: linear-gradient(90deg,#7c5fe6,#a78bfa); height: 100%; border-radius: 4px; transition: width .45s ease; }

    /* ======= TASK FAB ======= */
    .fab-task {
      width:48px; height:48px; border-radius:999px;
      background:linear-gradient(135deg,#ff9800,#f06000);
      color:#fff; font-size:20px; border:none; cursor:pointer;
      box-shadow:0 3px 14px rgba(255,140,0,0.42);
      display:flex; align-items:center; justify-content:center;
      font-family:inherit; flex-shrink:0; transition:transform 0.15s;
    }
    .fab-task:active { transform:scale(0.93); }
    .fab-task.hidden { display:none; }

    /* ======= TASK MODAL ======= */
    .task-add-form { padding:12px 16px 4px; display:flex; flex-direction:column; gap:8px; }
    .task-add-input { padding:8px 10px; border:1.5px solid var(--border-color); border-radius:8px; font-size:15px; font-family:inherit; background:var(--bg-card); color:var(--text-main); outline:none; }
    .task-add-input:focus { border-color:var(--accent-blue); }
    .task-add-textarea { height:60px; resize:none; }
    .task-add-submit { background:var(--accent-blue); color:#fff; border:none; border-radius:8px; padding:9px; font-size:15px; font-weight:700; cursor:pointer; font-family:inherit; }
    .task-section-title { font-size:11px; font-weight:700; color:var(--text-muted); padding:8px 16px 2px; text-transform:uppercase; letter-spacing:.05em; }
    .task-list { padding:0 16px; }
    .task-item { display:flex; align-items:flex-start; gap:10px; padding:10px 0; border-bottom:1px solid var(--border-color); }
    .task-item:last-child { border-bottom:none; }
    .task-check { width:20px; height:20px; flex-shrink:0; margin-top:2px; cursor:pointer; accent-color:var(--accent-blue); }
    .task-body { flex:1; min-width:0; }
    .task-title { font-size:15px; font-weight:700; word-break:break-all; }
    .task-memo { font-size:12px; color:var(--text-muted); margin-top:3px; white-space:pre-wrap; word-break:break-all; }
    .task-item.done .task-title { text-decoration:line-through; opacity:0.5; }
    .task-item.done .task-memo { opacity:0.4; }
    .task-del { background:none; border:none; color:#e57373; font-size:18px; cursor:pointer; padding:0 4px; align-self:center; line-height:1; }
    .task-empty { text-align:center; color:var(--text-muted); padding:24px 0; font-size:14px; line-height:1.8; }

    /* ======= FLOATING TODAY BUTTON ======= */
    .fab-today {
      width:48px; height:48px; border-radius:999px;
      background:linear-gradient(135deg,#4f8dfd,#7c5fe6);
      color:#fff; font-size:11px; font-weight:900;
      border:none; cursor:pointer;
      box-shadow:0 3px 14px rgba(79,141,253,0.42);
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      gap:1px; font-family:inherit; flex-shrink:0; transition:transform 0.15s;
    }
    .fab-today:active { transform:scale(0.93); }
    .fab-today .fab-day { font-size:17px; font-weight:900; line-height:1; }
    .fab-today .fab-label { font-size:9px; opacity:.85; }
    .fab-today.hidden { display:none; }

    /* ======= FAB GROUP (MacBook Dock スタイル、calendar タブのみ) ======= */
    .fab-group {
      position: fixed;
      right: calc(max(env(safe-area-inset-right), 16px));
      bottom: calc(max(env(safe-area-inset-bottom), 0px) + var(--tab-bar-h) + 14px);
      z-index: 900;
      display: flex; flex-direction: column-reverse; align-items: center; gap: 10px;
    }
    .fab-group.hidden { opacity: 0; pointer-events: none; }
    .fab-group-toggle {
      width: 52px; height: 52px; border-radius: 50%;
      background: linear-gradient(135deg, #4f8dfd, #7c5fe6);
      color: #fff; font-size: 26px;
      border: none; cursor: pointer;
      box-shadow: 0 4px 20px rgba(79,141,253,0.52);
      display: flex; align-items: center; justify-content: center;
      transition: transform 0.28s cubic-bezier(0.34,1.56,0.64,1);
      font-family: inherit; line-height: 1; flex-shrink: 0;
    }
    .fab-group.open .fab-group-toggle { transform: rotate(45deg); }
    .fab-group-menu {
      display: flex; flex-direction: column-reverse; align-items: center; gap: 10px;
      overflow: hidden; max-height: 0; opacity: 0;
      transition: max-height 0.32s cubic-bezier(0.4,0,0.2,1), opacity 0.2s;
      pointer-events: none;
    }
    .fab-group.open .fab-group-menu { max-height: 380px; opacity: 1; pointer-events: auto; }
    .fab-custom {
      width: 44px; height: 44px; border-radius: 50%;
      background: var(--bg-card-solid, #fff); border: 1.5px solid var(--border-soft, #ddd);
      font-size: 20px; cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      display: flex; align-items: center; justify-content: center;
      font-family: inherit; flex-shrink: 0;
    }
    .fab-custom:active { transform: scale(0.93); }
    /* AI ページを active 時に flex レイアウトにする */
    #page-ai.active { display: flex !important; }

    /* ======= 仕様タブ サブナビ + 設計書 ======= */
    .spec-subnav {
      display: flex; overflow-x: auto; gap: 6px;
      padding: 0 0 10px; margin-bottom: 10px;
      scrollbar-width: none;
    }
    .spec-subnav::-webkit-scrollbar { display: none; }
    .spec-sub-btn {
      flex-shrink: 0; padding: 5px 13px; border-radius: 999px;
      border: 1px solid var(--border-soft); background: var(--bg-card);
      font-size: 12px; font-weight: 600; cursor: pointer;
      white-space: nowrap; color: var(--text-muted);
      transition: all 0.15s; font-family: inherit;
    }
    .spec-sub-btn.active {
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      color: #fff; border-color: transparent;
      box-shadow: 0 2px 8px rgba(79,141,253,0.35);
    }
    .spec-pane { animation: tabFadeIn 0.18s ease forwards; }
    /* Mermaid SVG レスポンシブ */
    .mermaid-wrap { overflow-x: auto; text-align: center; padding: 4px 0; }
    .mermaid-wrap svg { max-width: 100%; height: auto; }
    /* 設計書ドキュメント */
    .doc-h1 { font-size:14px;font-weight:800;color:var(--text-primary);margin:18px 0 6px;padding-bottom:4px;border-bottom:2px solid var(--border-soft); }
    .doc-h2 { font-size:12px;font-weight:700;color:var(--accent-blue);margin:12px 0 4px; }
    .doc-p  { font-size:12px;line-height:1.85;color:var(--text-primary);margin:4px 0; }
    .doc-ul { font-size:12px;line-height:1.85;color:var(--text-primary);margin:4px 0;padding-left:18px; }
    .doc-ul li { margin:2px 0; }
    .doc-table { width:100%;border-collapse:collapse;font-size:11px;margin:8px 0; }
    .doc-table th { background:rgba(79,141,253,0.08);padding:5px 8px;text-align:left;border-bottom:2px solid var(--border-soft);font-weight:700; }
    .doc-table td { padding:5px 8px;border-bottom:1px solid var(--border-soft);vertical-align:top; }
    .badge-get    { background:#1565c0;color:#fff;padding:1px 5px;border-radius:4px;font-size:10px;font-weight:800; }
    .badge-post   { background:#2e7d32;color:#fff;padding:1px 5px;border-radius:4px;font-size:10px;font-weight:800; }

    /* ======= Docker タブ ======= */
    .docker-stat-bar-wrap {
      background: var(--bg-glass, rgba(0,0,0,0.05));
      border-radius: 6px; height: 8px; overflow: hidden; flex: 1;
    }
    .docker-stat-bar {
      height: 100%; border-radius: 6px;
      transition: width 0.4s ease;
    }
    .docker-stat-bar.cpu  { background: linear-gradient(90deg, #4f8dfd, #58a6ff); }
    .docker-stat-bar.mem  { background: linear-gradient(90deg, #2da44e, #39d353); }
    .docker-stat-bar.warn { background: linear-gradient(90deg, #e3b341, #f0a030); }
    .docker-stat-bar.danger { background: linear-gradient(90deg, #e05252, #ff5f57); }

    /* ======= 業務AI タブ ======= */
    .bizai-tpl-btn {
      padding: 6px 12px; border-radius: 20px; border: 1.5px solid var(--border-soft);
      background: var(--bg-card); color: var(--text-primary);
      font-size: 12px; cursor: pointer; font-family: inherit;
      transition: all 0.15s;
    }
    .bizai-tpl-btn:active, .bizai-tpl-btn.selected {
      background: var(--accent-blue); color: #fff; border-color: var(--accent-blue);
    }

    /* ======= DB STATUS CARD ======= */
    .db-status-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 2px;
    }
    .db-status-item {
      background: rgba(255,255,255,0.5);
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid rgba(180,190,220,0.3);
      transition: background 0.2s;
    }
    .db-status-item-label {
      font-size: 10px;
      font-weight: 700;
      color: var(--text-muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 4px;
    }
    .db-status-item-value {
      font-size: 15px;
      font-weight: 800;
      color: var(--text-main);
    }
    .db-status-item-sub {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 2px;
    }
    .db-status-item-ok .db-status-item-value  { color: #2e7d32; }
    .db-status-item-warn .db-status-item-value { color: #e65100; }
    .db-status-item-err .db-status-item-value  { color: #c62828; }
    .db-status-refresh-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
      gap: 6px;
    }
    .db-status-last-updated {
      font-size: 10px;
      color: var(--text-muted);
    }

    /* ======= JOBS TAB ======= */
    .jobs-server-banner {
      background: #fff8e1; border: 1px solid #ffe0b2; border-radius: 10px;
      padding: 10px 14px; margin-bottom: 10px; font-size: 12px; color: #e65100;
      display: flex; flex-direction: column; gap: 4px;
    }
    .jobs-server-banner code { background: rgba(0,0,0,0.07); padding: 2px 6px; border-radius: 4px; font-size: 11px; color: #333; }
    .jobs-filter-bar { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .jobs-platform-chips { display: flex; gap: 6px; }
    .jobs-platform-chip {
      padding: 4px 12px; border-radius: 999px; font-size: 11px; font-weight: 700;
      background: #f4f4f6; color: var(--text-muted); cursor: pointer;
      border: 1px solid transparent; transition: all 0.15s; user-select: none;
    }
    .jobs-platform-chip.active { background: var(--accent-blue); color: #fff; }
    .jobs-skill-display { display: flex; gap: 4px; flex-wrap: wrap; flex: 1; }
    .jobs-skill-tag { padding: 2px 8px; background: #e8f5e9; color: #2e7d32; border-radius: 999px; font-size: 10px; font-weight: 600; }
    .jobs-refresh-btn { background: none; border: none; font-size: 18px; cursor: pointer; padding: 4px; -webkit-tap-highlight-color: transparent; transition: transform 0.3s; margin-left: auto; }
    .jobs-refresh-btn.spinning { animation: spin 0.6s linear; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .jobs-fetch-status { font-size: 10px; color: var(--text-muted); margin-top: 4px; }
    .jobs-section-title { font-size: 13px; font-weight: 800; margin-bottom: 10px; color: var(--text-main); }
    .jobs-pickup-list { display: flex; flex-direction: column; gap: 8px; }
    .jobs-cards-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 80px; }
    .jobs-card {
      background: var(--card-bg); border: 1px solid var(--border-soft);
      border-radius: 12px; padding: 12px; cursor: pointer;
      transition: box-shadow 0.15s, transform 0.1s; -webkit-tap-highlight-color: transparent;
    }
    .jobs-card:active { transform: scale(0.98); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .jobs-card-header { display: flex; align-items: center; gap: 6px; margin-bottom: 6px; flex-wrap: wrap; }
    .jobs-platform-badge { font-size: 9px; font-weight: 900; padding: 2px 6px; border-radius: 4px; }
    .jobs-badge-cw { background: #e3f2fd; color: #1565c0; }
    .jobs-badge-lancers { background: #fce4ec; color: #c62828; }
    .jobs-category-tag { font-size: 10px; background: #f4f4f6; color: var(--text-muted); padding: 2px 7px; border-radius: 4px; }
    .jobs-match-score { font-size: 10px; color: #f57f17; font-weight: 700; }
    .jobs-updated { font-size: 10px; color: var(--text-muted); margin-left: auto; }
    .jobs-title {
      font-size: 13px; font-weight: 700; color: var(--text-main); line-height: 1.4; margin-bottom: 4px;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
    }
    .jobs-budget { font-size: 11px; color: #2e7d32; font-weight: 600; display: block; margin-bottom: 4px; }
    .jobs-summary {
      font-size: 11px; color: var(--text-muted); line-height: 1.5;
      display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
    }
    .jobs-empty { text-align: center; padding: 40px 20px; font-size: 13px; color: var(--text-muted); line-height: 1.8; }

    /* ======= BOTTOM TAB NAVIGATION ======= */
    .bottom-tabs {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 800;
      background: rgba(255,255,255,0.94);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid rgba(180,190,220,0.35);
      display: flex;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      padding-bottom: env(safe-area-inset-bottom, 0);
      box-shadow: 0 -2px 20px rgba(60,80,200,0.08);
    }
    .bottom-tabs::-webkit-scrollbar { display: none; }
    .tab-btn {
      flex: 0 0 auto;
      min-width: 60px;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      padding: 8px 6px 6px; font-size: 9px; font-weight: 700;
      color: var(--text-muted); border: none; background: none;
      cursor: pointer; font-family: inherit; gap: 2px;
      transition: color 0.15s;
      -webkit-tap-highlight-color: transparent;
    }
    .tab-btn.active { color: var(--accent-blue); }
    .tab-icon { font-size: 20px; line-height: 1; }

    /* ======= TAB PAGES ======= */
    .tab-page {
      display: none;
      opacity: 0;
      transform: translateY(6px);
    }
    .tab-page.active {
      display: block;
      animation: tabFadeIn 0.22s cubic-bezier(0.22, 1, 0.36, 1) forwards;
    }
    @keyframes tabFadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* ======= HUB / LAUNCHER ======= */
    .jinjer-card {
      display: flex; align-items: center; gap: 14px;
      background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
      border-radius: 20px; padding: 18px 20px;
      color: #fff; cursor: pointer; text-decoration: none;
      box-shadow: 0 6px 28px rgba(21,101,192,0.38);
      margin-bottom: 12px; user-select: none;
      -webkit-tap-highlight-color: transparent;
      transition: transform 0.15s, opacity 0.15s;
    }
    .jinjer-card:active { transform: scale(0.98); opacity: 0.9; }
    .jinjer-icon { font-size: 38px; }
    .jinjer-info { flex: 1; }
    .jinjer-label { font-size: 18px; font-weight: 900; }
    .jinjer-sub   { font-size: 12px; opacity: 0.82; margin-top: 3px; }
    .jinjer-arrow { font-size: 22px; opacity: 0.7; }
    .links-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(76px, 1fr));
      gap: 10px; margin-bottom: 12px;
    }
    .link-tile-wrap { position: relative; }
    .link-tile {
      display: flex; flex-direction: column; align-items: center;
      gap: 6px; padding: 12px 6px;
      background: var(--bg-card); border-radius: 16px;
      border: 1px solid var(--border-soft);
      cursor: pointer; text-decoration: none;
      font-size: 11px; font-weight: 700; color: var(--text-main);
      text-align: center; width: 100%;
      -webkit-tap-highlight-color: transparent;
      transition: transform 0.12s;
    }
    .link-tile:active { transform: scale(0.94); }
    .link-tile-icon { font-size: 26px; }
    .link-tile-add {
      border: 1.5px dashed rgba(180,190,220,0.7);
      background: rgba(255,255,255,0.4); color: var(--text-muted); border: none;
    }
    .link-tile-del {
      position: absolute; top: 3px; right: 3px; font-size: 16px;
      color: #e57373; line-height: 1; cursor: pointer; z-index: 2;
      background: rgba(255,255,255,0.9); border-radius: 50%;
      width: 18px; height: 18px; display: flex; align-items: center; justify-content: center;
      font-size: 12px; font-weight: 900;
    }

    /* ======= STUDY TRACKER ======= */
    .study-item {
      background: var(--bg-card-solid); border-radius: 16px;
      border: 1px solid var(--border-soft);
      padding: 14px 14px 12px; margin-bottom: 10px;
    }
    .study-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .study-color-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
    .study-name { font-size: 15px; font-weight: 800; flex: 1; }
    .study-countdown {
      font-size: 10px; font-weight: 800; padding: 2px 8px;
      border-radius: 999px; white-space: nowrap;
    }
    .study-progress-wrap {
      height: 8px; background: #f0f0f5; border-radius: 999px;
      overflow: hidden; margin-bottom: 6px;
    }
    .study-progress-fill { height: 100%; border-radius: 999px; transition: width 0.4s ease; }
    .study-stats { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted); }
    .study-today { display: flex; align-items: center; gap: 8px; margin-top: 10px; }
    .study-hours-input {
      width: 72px; padding: 6px 8px; border-radius: 8px;
      border: 1px solid var(--border-soft); font-size: 14px;
      font-family: inherit; text-align: center;
    }
    .study-add-btn {
      flex: 1; padding: 7px; border: none; border-radius: 8px;
      background: var(--accent-blue); color: #fff; font-weight: 700;
      font-size: 12px; cursor: pointer; font-family: inherit;
    }
    .study-del-btn { background: none; border: none; color: #e57373; font-size: 16px; cursor: pointer; padding: 0 4px; }

    /* ======= PROJECT TRACKER ======= */
    .project-item {
      background: var(--bg-card-solid); border-radius: 16px;
      border: 1px solid var(--border-soft);
      padding: 12px 14px; margin-bottom: 8px;
    }
    .project-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .project-status-badge { font-size: 10px; font-weight: 800; padding: 2px 8px; border-radius: 999px; }
    .project-status-未着手 { background: #f4f4f6; color: var(--text-muted); }
    .project-status-進行中 { background: #e3f2fd; color: #1565c0; }
    .project-status-完了   { background: #e8f5e9; color: #2e7d32; }
    .project-status-保留   { background: #fff8e1; color: #ef6c00; }
    .project-name { font-size: 14px; font-weight: 800; flex: 1; min-width: 0; word-break: break-all; }
    .project-progress-wrap {
      height: 6px; background: #f0f0f5; border-radius: 999px;
      overflow: hidden; margin-bottom: 6px;
    }
    .project-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
      border-radius: 999px; transition: width 0.4s;
    }
    .project-footer { display: flex; justify-content: space-between; align-items: center; font-size: 11px; color: var(--text-muted); gap: 8px; flex-wrap: wrap; }
    .project-del-btn { background: none; border: none; color: #e57373; font-size: 15px; cursor: pointer; padding: 0; flex-shrink: 0; }

    /* ======= REPORT TAB ======= */
    .report-server-banner {
      background: #fff8e1; border: 1px solid #ffe0b2;
      border-radius: 14px; padding: 10px 14px;
      margin-bottom: 10px; font-size: 12px;
      color: #e65100; line-height: 1.5;
    }
    .report-month-nav {
      display: flex; align-items: center; gap: 8px;
      margin-bottom: 10px; overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      padding-bottom: 2px;
    }
    .report-month-nav::-webkit-scrollbar { display: none; }
    .report-month-chip {
      flex-shrink: 0; padding: 5px 13px; border-radius: 999px;
      font-size: 12px; font-weight: 700;
      border: 1px solid var(--border-soft);
      background: rgba(255,255,255,0.7);
      cursor: pointer; font-family: inherit;
      transition: background 0.12s, color 0.12s;
      white-space: nowrap;
    }
    .report-month-chip.active {
      background: var(--accent-blue); color: #fff;
      border-color: var(--accent-blue);
    }
    .report-status-card {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 12px; border-radius: 14px;
      border: 1px solid var(--border-soft);
      background: var(--bg-card-solid);
      margin-bottom: 8px;
    }
    .report-status-badge {
      font-size: 10px; font-weight: 800;
      padding: 3px 9px; border-radius: 999px;
      white-space: nowrap;
    }
    .report-badge-approved { background: #e8f5e9; color: #2e7d32; }
    .report-badge-reviewing { background: #e3f2fd; color: #1565c0; }
    .report-badge-draft     { background: #f4f4f6; color: var(--text-muted); }
    .report-filename { font-size: 11px; color: var(--text-muted); flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .report-table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 14px; border: 1px solid var(--border-soft); margin-bottom: 8px; }
    .report-table {
      width: 100%; border-collapse: collapse; font-size: 11px; min-width: 520px;
    }
    .report-table th {
      background: rgba(245,246,251,0.9); padding: 7px 6px;
      text-align: center; font-weight: 700; color: var(--text-muted);
      border-bottom: 1px solid var(--border-soft); white-space: nowrap;
    }
    .report-table td {
      padding: 5px 6px; border-bottom: 1px solid rgba(230,232,240,0.7);
      vertical-align: middle;
    }
    .report-table tr:last-child td { border-bottom: none; }
    .report-row-weekend td { background: rgba(245,246,251,0.6); color: var(--text-muted); }
    .report-row-holiday td { background: #ffebee; }
    .report-row-vacation td { background: #fff8e1; }
    .report-row-office td  { background: rgba(227,242,253,0.5); }
    .report-row-home td    { background: rgba(232,245,233,0.5); }
    .report-note-badge {
      display: inline-block; padding: 1px 7px; border-radius: 999px;
      font-size: 10px; font-weight: 700;
    }
    .report-note-在宅   { background: #e8f5e9; color: #2e7d32; }
    .report-note-出社   { background: #e3f2fd; color: #1565c0; }
    .report-note-有給   { background: #fff8e1; color: #ef6c00; }
    .report-note-祝日   { background: #ffebee; color: #c62828; }
    .report-note-休日   { background: #ede7f6; color: #5e35b1; }
    .report-actions {
      display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px;
    }
    .report-meta-grid {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 6px; margin-bottom: 8px;
    }
    .report-meta-item {
      background: rgba(255,255,255,0.7); border-radius: 10px;
      border: 1px solid var(--border-soft); padding: 6px 10px;
    }
    .report-meta-label { font-size: 10px; color: var(--text-muted); font-weight: 700; margin-bottom: 2px; }
    .report-meta-value { font-size: 12px; font-weight: 700; }
    .report-summary-bar {
      display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px;
    }
    .report-automation-panel {
      background: rgba(255,255,255,0.7); border-radius: 16px;
      border: 1px solid var(--border-soft);
      padding: 10px 14px;
    }
    .report-automation-header {
      display: flex; align-items: center; justify-content: space-between;
      cursor: pointer; user-select: none;
    }
    .report-automation-title { font-size: 12px; font-weight: 800; }
    .report-automation-body { display: none; margin-top: 10px; }
    .report-automation-body.open { display: block; }
    .report-suggestion {
      display: flex; align-items: flex-start; gap: 8px;
      padding: 8px 0; border-bottom: 1px solid var(--border-soft);
    }
    .report-suggestion:last-child { border-bottom: none; }
    .report-suggestion-icon { font-size: 18px; flex-shrink: 0; }
    .report-suggestion-text { font-size: 12px; line-height: 1.5; }
    .report-suggestion-title { font-weight: 800; margin-bottom: 2px; }
    .report-suggestion-desc { color: var(--text-muted); }
    .report-empty {
      text-align: center; padding: 32px 16px;
      color: var(--text-muted); font-size: 13px;
    }
    .report-loading {
      text-align: center; padding: 24px;
      color: var(--text-muted); font-size: 13px;
    }

    /* ======= CALENDAR WEATHER STRIP ======= */
    .cal-weather-strip {
      display: flex; align-items: center; gap: 10px;
      background: linear-gradient(135deg, #e3f2fd 0%, #ede7f6 100%);
      border-radius: 14px; padding: 9px 13px;
      border: 1px solid rgba(124,95,230,0.15);
      -webkit-tap-highlight-color: transparent;
    }
    .cal-w-emoji { font-size: 28px; line-height: 1; flex-shrink: 0; }
    .cal-weather-info { flex: 1; min-width: 0; }
    .cal-w-cond { font-size: 13px; font-weight: 800; color: var(--text-main); }
    .cal-w-sub  { font-size: 10px; color: var(--text-muted); margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .cal-w-temps { font-size: 15px; font-weight: 900; color: var(--text-main); white-space: nowrap; flex-shrink: 0; }
    .cal-outfit-btn {
      flex-shrink: 0;
      background: linear-gradient(135deg, #7c5fe6, #4f8dfd);
      color: #fff; border: none; border-radius: 999px;
      padding: 5px 11px; font-size: 11px; font-weight: 800;
      cursor: pointer; font-family: inherit; white-space: nowrap;
      -webkit-tap-highlight-color: transparent; transition: opacity 0.15s;
    }
    .cal-outfit-btn:active { opacity: 0.8; }

    /* ======= WEATHER FORECAST ======= */
    .weather-card-wrap { margin-bottom: 10px; }
    .weather-loading { text-align: center; color: var(--text-muted); font-size: 13px; padding: 18px 0; }
    .weather-loc { font-size: 11px; color: var(--text-muted); font-weight: 700; letter-spacing: 0.04em; margin-bottom: 8px; }
    .weather-main-row {
      display: flex; align-items: center; gap: 14px;
      background: linear-gradient(135deg, #1b6ca8 0%, #2980b9 60%, #6dd5fa 100%);
      border-radius: 20px; padding: 16px 18px; color: #fff; margin-bottom: 10px;
    }
    .weather-big-emoji { font-size: 52px; line-height: 1; }
    .weather-temps { display: flex; flex-direction: column; align-items: center; min-width: 52px; }
    .weather-temp-max { font-size: 28px; font-weight: 900; line-height: 1; }
    .weather-temp-min { font-size: 16px; font-weight: 700; opacity: 0.72; margin-top: 2px; }
    .weather-cond { flex: 1; }
    .weather-label { font-size: 17px; font-weight: 900; }
    .weather-sub { font-size: 12px; opacity: 0.82; margin-top: 4px; letter-spacing: 0.04em; }
    .outfit-card {
      background: rgba(255,255,255,0.65); border-radius: 16px;
      border: 1px solid var(--border-soft); padding: 12px 14px; margin-bottom: 10px;
    }
    .outfit-title { font-size: 13px; font-weight: 800; margin-bottom: 8px; color: var(--text-main); }
    .outfit-chips { display: flex; flex-wrap: wrap; gap: 6px; }
    .outfit-chip {
      background: linear-gradient(135deg, #ede7f6, #e3f2fd);
      border-radius: 999px; padding: 5px 12px;
      font-size: 12px; font-weight: 700; color: var(--text-main);
      border: 1px solid rgba(124,95,230,0.15);
    }
    .outfit-warns { margin-top: 8px; display: flex; flex-direction: column; gap: 4px; }
    .outfit-warn {
      font-size: 11px; font-weight: 700; color: #c62828;
      background: #ffebee; border-radius: 8px; padding: 4px 10px;
    }
    .forecast-scroll {
      display: flex; gap: 8px; overflow-x: auto;
      padding-bottom: 4px; scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .forecast-scroll::-webkit-scrollbar { display: none; }
    .fc-card {
      flex-shrink: 0; scroll-snap-align: start;
      width: 60px; text-align: center;
      background: rgba(255,255,255,0.7); border-radius: 14px;
      padding: 10px 4px; border: 1px solid var(--border-soft);
      display: flex; flex-direction: column; align-items: center; gap: 4px;
    }
    .fc-today {
      background: linear-gradient(135deg, #e8effe, #f0e8ff);
      border: 1.5px solid rgba(124,95,230,0.35);
    }
    .fc-dow { font-size: 10px; font-weight: 800; color: var(--text-muted); }
    .fc-today .fc-dow { color: var(--accent-purple); }
    .fc-emoji { font-size: 22px; line-height: 1; }
    .fc-max { font-size: 14px; font-weight: 900; color: var(--text-main); }
    .fc-min { font-size: 11px; color: var(--text-muted); }
    .fc-rain { font-size: 10px; color: #1976d2; font-weight: 700; }
    .weather-refresh-btn {
      display: block; width: 100%; text-align: center;
      font-size: 11px; color: var(--text-muted); margin-top: 8px;
      background: none; border: none; cursor: pointer; padding: 4px;
      font-family: inherit;
    }
    .weather-refresh-btn:active { opacity: 0.6; }
    /* -- Hourly timeline -- */
    .hourly-section { margin: 10px 0 12px; }
    .hourly-label, .forecast-label {
      font-size: 11px; font-weight: 800; color: var(--text-muted);
      letter-spacing: 0.05em; margin-bottom: 7px;
    }
    .forecast-label { margin-top: 14px; }
    .hourly-scroll {
      display: flex; gap: 5px; overflow-x: auto;
      padding-bottom: 4px; scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .hourly-scroll::-webkit-scrollbar { display: none; }
    .h-card {
      flex-shrink: 0; scroll-snap-align: start; width: 54px;
      text-align: center; border-radius: 14px; padding: 8px 3px;
      border: 1px solid var(--border-soft);
      background: rgba(255,255,255,0.65);
      display: flex; flex-direction: column; align-items: center; gap: 3px;
      transition: transform 0.1s;
    }
    .h-card.h-now {
      background: linear-gradient(160deg, #1565c0 0%, #42a5f5 100%);
      border: none; box-shadow: 0 4px 14px rgba(21,101,192,0.35);
    }
    .h-time  { font-size: 10px; font-weight: 800; color: var(--text-muted); }
    .h-emoji { font-size: 18px; line-height: 1; }
    .h-temp  { font-size: 13px; font-weight: 900; color: var(--text-main); }
    .h-feels { font-size: 9px; color: var(--text-muted); }
    .h-rain  { font-size: 10px; font-weight: 700; color: #1976d2; }
    .h-card.h-now .h-time,
    .h-card.h-now .h-temp,
    .h-card.h-now .h-feels,
    .h-card.h-now .h-rain { color: rgba(255,255,255,0.9); }
    /* -- Outfit Amazon board -- */
    .outfit-board-wrap {
      background: rgba(255,255,255,0.55);
      border-radius: 18px; border: 1px solid var(--border-soft);
      padding: 12px 12px 10px; margin-bottom: 4px;
    }
    .outfit-board-title {
      font-size: 13px; font-weight: 800; margin-bottom: 4px;
      display: flex; align-items: center; gap: 6px;
    }
    .outfit-style-tag {
      font-size: 10px; font-weight: 800; padding: 2px 9px;
      border-radius: 999px; background: linear-gradient(135deg,#7c5fe6,#4f8dfd);
      color: #fff;
    }
    /* Mannequin visual */
    .outfit-mannequin-row {
      display: flex; gap: 10px; align-items: flex-start; margin-bottom: 10px;
    }
    .vp-mannequin {
      position: relative; width: 96px; height: 192px;
      flex-shrink: 0; overflow: visible;
    }
    .vp-svg {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; user-select: none;
    }
    /* フラットレイ clothing display */
    .vp-flatlay {
      display: grid; grid-template-columns: 1fr 1fr; gap: 5px;
      width: 108px; flex-shrink: 0; align-content: start;
    }
    .fl-card {
      background: var(--card-bg); border-radius: 9px; padding: 6px 4px;
      text-align: center; border: 1px solid var(--border-soft);
    }
    .fl-card-em { font-size: 22px; line-height: 1; }
    .fl-card-nm {
      font-size: 8px; color: var(--text-sub); margin-top: 2px;
      line-height: 1.2; overflow: hidden; display: -webkit-box;
      -webkit-line-clamp: 2; -webkit-box-orient: vertical;
    }
    /* jinjer sync option buttons */
    .jinjer-sync-opt-btn {
      width: 100%; text-align: left; padding: 12px 14px; border-radius: 12px;
      border: 1.5px solid var(--border-soft); background: var(--card-bg);
      cursor: pointer; font-family: inherit; margin-bottom: 8px; display: block;
    }
    .jinjer-sync-opt-btn:active { opacity: 0.7; }
    .jinjer-sync-opt-title { font-size: 14px; font-weight: 800; color: var(--text-primary); }
    .jinjer-sync-opt-sub { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    /* outfit gender sections */
    .outfit-gender-section { margin-bottom: 10px; }
    .outfit-gender-label {
      font-size: 11px; font-weight: 800; color: var(--text-muted);
      margin-bottom: 6px; letter-spacing: 0.03em;
    }
    .vp-item {
      position: absolute; left: 50%; transform: translateX(-50%);
      font-size: 22px; line-height: 1; text-decoration: none;
      display: flex; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.92); border-radius: 50%;
      width: 34px; height: 34px; border: 1.5px solid rgba(124,95,230,0.3);
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      transition: transform 0.12s; cursor: pointer;
      -webkit-tap-highlight-color: transparent; z-index: 2;
    }
    .vp-item:active { transform: translateX(-50%) scale(0.86); }
    .vp-hat    { top: -10px; }
    .vp-scarf  { top: 30px; }
    .vp-outer  { top: 43px; }
    .vp-top    { top: 55px; }
    .vp-bottom { top: 108px; }
    .vp-feet   { top: 162px; }
    .vp-acc    { top: 92px; left: calc(50% + 30px); }
    /* Card grid */
    .oic-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(76px, 1fr));
      gap: 7px;
    }
    .oic {
      display: flex; flex-direction: column; align-items: center;
      gap: 5px; padding: 10px 5px 8px;
      background: #fff; border-radius: 14px;
      border: 1px solid rgba(124,95,230,0.15);
      text-decoration: none; color: var(--text-main); text-align: center;
      cursor: pointer; transition: transform 0.12s, box-shadow 0.12s;
      -webkit-tap-highlight-color: transparent;
    }
    .oic:active { transform: scale(0.93); box-shadow: none; }
    .oic:hover  { box-shadow: 0 3px 12px rgba(124,95,230,0.18); }
    .oic-em  { font-size: 30px; line-height: 1; }
    .oic-nm  { font-size: 10px; font-weight: 800; line-height: 1.3; }
    .oic-amz {
      font-size: 9px; font-weight: 800; color: #c45500;
      background: #fff3e0; border-radius: 999px; padding: 2px 7px;
      border: 1px solid #ffe0b2; white-space: nowrap;
    }
    .outfit-warn-row { margin: 8px 0 4px; display: flex; flex-direction: column; gap: 4px; }
    .outfit-all-btn {
      display: flex; align-items: center; justify-content: center; gap: 6px;
      margin-top: 10px; padding: 11px;
      background: linear-gradient(135deg, #ff9900 0%, #ff6d00 100%);
      color: #fff; border-radius: 14px; font-size: 13px; font-weight: 800;
      text-decoration: none; letter-spacing: 0.02em;
      box-shadow: 0 4px 16px rgba(255,153,0,0.35);
      -webkit-tap-highlight-color: transparent;
      transition: opacity 0.15s;
    }
    .outfit-all-btn:active { opacity: 0.8; }
    .outfit-fallback { display: flex; flex-wrap: wrap; gap: 8px; padding: 10px 0; font-size: 13px; color: var(--text-muted); }
    .oic-why { font-size: 9px; color: var(--text-muted); text-align: center; line-height: 1.3; }

    /* ======= HEALTH ADVICE ======= */
    .health-advice-wrap {
      margin: 10px 0 4px;
      padding: 12px 14px;
      background: linear-gradient(135deg, rgba(232,245,255,0.95) 0%, rgba(243,238,255,0.95) 100%);
      border-radius: 18px;
      border: 1px solid rgba(180,200,240,0.4);
    }
    .health-advice-title {
      font-size: 11px; font-weight: 800;
      letter-spacing: 0.09em; text-transform: uppercase;
      color: var(--text-muted); margin-bottom: 10px;
    }
    .health-advice-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 8px;
    }
    .ha-card {
      background: rgba(255,255,255,0.75);
      border-radius: 12px; padding: 10px;
      border: 1px solid rgba(200,210,235,0.5);
      display: flex; flex-direction: column; gap: 3px;
    }
    .ha-card-icon { font-size: 22px; line-height: 1; }
    .ha-card-level {
      font-size: 11px; font-weight: 800;
      border-radius: 999px; padding: 2px 8px;
      display: inline-block; margin-top: 2px;
    }
    .ha-level-ok    { background: #e8f5e9; color: #2e7d32; }
    .ha-level-warn  { background: #fff8e1; color: #e65100; }
    .ha-level-alert { background: #fce4ec; color: #c62828; }
    .ha-card-label  { font-size: 11px; font-weight: 700; color: var(--text-main); }
    .ha-card-tip    { font-size: 10px; color: var(--text-muted); line-height: 1.4; }
    .health-advice-trend {
      margin-top: 10px; padding: 9px 12px;
      background: rgba(255,255,255,0.65); border-radius: 12px;
      font-size: 11px; color: var(--text-main); line-height: 1.6;
      border: 1px solid rgba(200,210,235,0.4);
    }
    .health-advice-trend strong { color: var(--accent-purple); }

    /* ======= CHANGELOG TAB ======= */
    .cl-entry {
      border-left: 3px solid var(--accent-purple);
      padding: 8px 0 8px 14px;
      margin-bottom: 16px;
    }
    .cl-entry-date { font-size: 10px; font-weight: 700; color: var(--text-muted); margin-bottom: 3px; }
    .cl-entry-version {
      display: inline-block; font-size: 11px; font-weight: 800;
      background: var(--accent-purple); color: #fff;
      border-radius: 999px; padding: 1px 8px; margin-bottom: 5px;
    }
    .cl-entry-title { font-size: 14px; font-weight: 800; color: var(--text-main); margin-bottom: 4px; }
    .cl-entry-items { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 3px; }
    .cl-entry-items li { font-size: 12px; color: var(--text-main); padding-left: 14px; position: relative; line-height: 1.5; }
    .cl-entry-items li::before { content: '•'; position: absolute; left: 0; color: var(--accent-purple); }
    .cl-tag {
      display: inline-block; font-size: 9px; font-weight: 800;
      border-radius: 4px; padding: 1px 5px; margin-right: 4px;
      text-transform: uppercase; letter-spacing: 0.06em;
    }
    .cl-tag-feat  { background: #e3f2fd; color: #1565c0; }
    .cl-tag-fix   { background: #e8f5e9; color: #2e7d32; }
    .cl-tag-sec   { background: #fce4ec; color: #c62828; }
    .cl-tag-perf  { background: #f3e5f5; color: #6a1b9a; }
    .cl-tag-db    { background: #fff8e1; color: #e65100; }
    .cl-log-area {
      background: #111827; color: #a3e635;
      border-radius: 12px; padding: 12px 14px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 11px; line-height: 1.7;
      max-height: 300px; overflow-y: auto;
      white-space: pre-wrap; word-break: break-all;
    }
    .cl-log-area:empty::after { content: 'ログを読み込み中...'; opacity: 0.5; }
    .log-line { font-family: 'SF Mono','Fira Code',monospace; font-size: 11px; padding: 1px 4px; line-height: 1.6; }
    .log-error { background: rgba(198,40,40,0.12); color: #c62828; border-left: 3px solid #c62828; }
    .log-warn  { background: rgba(230,81,0,0.08);  color: #e65100; border-left: 3px solid #e65100; }
    .log-info  { color: #a3e635; }
    .log-fix   { font-size: 11px; color: #1565c0; padding: 2px 8px; background: rgba(21,101,192,0.1); border-radius: 4px; margin: 2px 0 2px 8px; }

    /* ======= CAMERA MEASUREMENT ======= */
    .measure-ref-btn, .measure-type-btn {
      padding: 5px 10px; border-radius: 20px;
      border: 2px solid var(--border-soft); background: var(--bg-card);
      color: var(--text-sub); font-size: 11px; font-weight: 700;
      font-family: inherit; cursor: pointer; transition: all 0.15s;
    }
    .measure-ref-btn.active, .measure-type-btn.active {
      background: var(--accent-blue); color: white; border-color: var(--accent-blue);
    }

    /* ======= HOURLY DATE SEPARATOR ======= */
    .h-date-sep {
      flex-shrink: 0; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 1px;
      background: linear-gradient(180deg, rgba(124,95,230,0.18) 0%, rgba(124,95,230,0.06) 100%);
      border-radius: 14px; padding: 8px 5px; min-width: 30px;
      border: 1.5px solid rgba(124,95,230,0.28);
    }
    .h-date-sep span { font-size: 9px; font-weight: 800; color: var(--accent); line-height: 1.3; }
    .h-date-sep .h-ds-today { font-size: 8px; background: var(--accent); color: #fff; border-radius: 4px; padding: 1px 3px; }

    /* ======= SYSTEM LOG MODAL ======= */
    .log-filter-bar { display: flex; gap: 5px; padding: 8px 12px; border-bottom: 1px solid var(--border-soft); flex-shrink: 0; }
    .log-filter-btn { flex: 1; padding: 5px 2px; border-radius: 8px; border: none; background: var(--bg-card); font-size: 11px; font-weight: 700; cursor: pointer; color: var(--text-muted); font-family: inherit; }
    .log-filter-btn.active { background: var(--accent); color: #fff; }
    .log-entry { display: flex; flex-direction: column; gap: 3px; padding: 8px 0; border-bottom: 1px solid var(--border-soft); }
    .log-entry:last-child { border-bottom: none; }
    .log-row1 { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
    .log-ts { font-size: 10px; color: var(--text-muted); font-family: monospace; white-space: nowrap; }
    .log-badge { font-size: 9px; font-weight: 800; border-radius: 999px; padding: 1px 6px; white-space: nowrap; }
    .log-badge-error { background: #fce4ec; color: #c62828; }
    .log-badge-warn  { background: #fff3e0; color: #e65100; }
    .log-badge-info  { background: #e3f2fd; color: #1565c0; }
    .log-src { font-size: 10px; font-weight: 700; color: var(--accent); }
    .log-msg { font-size: 11px; color: var(--text-main); line-height: 1.4; word-break: break-all; padding-left: 2px; }
    .health-log-btn { background: none; border: none; font-size: 14px; cursor: pointer; padding: 2px 5px; border-radius: 6px; opacity: 0.7; transition: opacity 0.15s; line-height: 1; }
    .health-log-btn:active { opacity: 1; }
    .health-item-btn { cursor: pointer; border-radius: 6px; padding: 0 2px; transition: background 0.15s; }
    .health-item-btn:active { background: rgba(124,95,230,0.12); }
    .log-badge-fatal { background: #880e4f; color: #fff; font-weight: 900; letter-spacing: 0.03em; }
    .log-suggest { font-size: 10px; color: #283593; background: #e8eaf6; border-radius: 6px; padding: 3px 7px; margin-top: 3px; line-height: 1.5; display: flex; gap: 5px; align-items: flex-start; }
    .log-suggest::before { content: "💡"; flex-shrink: 0; }

    /* ======= PERFORMANCE MODAL ======= */
    .perf-section { margin-bottom: 14px; }
    .perf-section-title { font-size: 11px; font-weight: 800; letter-spacing: 0.07em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px; display: flex; align-items: center; gap: 5px; }
    .perf-bar-wrap { background: rgba(0,0,0,0.07); border-radius: 999px; height: 8px; overflow: hidden; margin: 3px 0 6px; }
    .perf-bar { height: 100%; border-radius: 999px; transition: width 0.6s cubic-bezier(0.4,0,0.2,1); }
    .perf-bar-ok   { background: linear-gradient(90deg, #2e7d32, #66bb6a); }
    .perf-bar-warn { background: linear-gradient(90deg, #e65100, #ffb300); }
    .perf-bar-crit { background: linear-gradient(90deg, #b71c1c, #ef5350); }
    .perf-metric { display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid var(--border-soft); font-size: 12px; }
    .perf-metric:last-child { border-bottom: none; }
    .perf-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }
    .perf-dot-ok   { background: #2e7d32; box-shadow: 0 0 5px rgba(46,125,50,0.6); }
    .perf-dot-warn { background: #e65100; box-shadow: 0 0 5px rgba(230,81,0,0.6); }
    .perf-dot-crit { background: #b71c1c; box-shadow: 0 0 5px rgba(183,28,28,0.6); }
    .perf-label { flex: 1; color: var(--text-muted); font-weight: 700; }
    .perf-val { font-weight: 800; font-family: monospace; font-size: 13px; }
    .perf-fps-display { text-align: center; padding: 10px 0 4px; }
    .perf-fps-num { font-size: 42px; font-weight: 900; line-height: 1; letter-spacing: -0.04em; }
    .perf-fps-label { font-size: 11px; color: var(--text-muted); margin-top: 2px; font-weight: 700; }

    /* ======= JINJER SYNC CHOICE MODAL ======= */
    .jinjer-sync-opt { display: flex; align-items: center; gap: 14px; padding: 14px 12px; border-radius: 16px; background: rgba(255,255,255,0.7); border: 1px solid var(--border-soft); cursor: pointer; transition: background 0.15s, transform 0.1s; -webkit-tap-highlight-color: transparent; margin-bottom: 10px; }
    .jinjer-sync-opt:active { background: rgba(124,95,230,0.08); transform: scale(0.98); }
    .jinjer-sync-opt-icon { font-size: 32px; flex-shrink: 0; }
    .jinjer-sync-opt-title { font-size: 14px; font-weight: 800; color: var(--text-main); }
    .jinjer-sync-opt-sub { font-size: 11px; color: var(--text-muted); line-height: 1.5; margin-top: 2px; }

    /* ======= 議事録 MODAL ======= */
    .min-controls { display:flex; align-items:center; gap:10px; padding:6px 0 10px; flex-wrap:wrap; flex-shrink:0; }
    .min-rec-btn { display:flex; align-items:center; gap:6px; padding:11px 20px; border-radius:999px; border:none; font-size:13px; font-weight:800; font-family:inherit; cursor:pointer; user-select:none; transition:transform .15s; }
    .min-rec-btn:active { transform:scale(0.96); }
    .min-rec-btn.start { background:linear-gradient(135deg,#e53935,#ef5350); color:#fff; box-shadow:0 4px 14px rgba(229,57,53,0.38); }
    .min-rec-btn.stop  { background:#fff3e0; color:#bf360c; border:2px solid #ffccbc; }
    .min-timer { font-size:20px; font-weight:900; font-variant-numeric:tabular-nums; color:var(--text-main); letter-spacing:.02em; }
    .min-status-badge { font-size:11px; color:#2e7d32; background:#e8f5e9; padding:3px 10px; border-radius:999px; font-weight:700; animation:minPulse 1.5s ease-in-out infinite; }
    @keyframes minPulse { 0%,100%{opacity:1} 50%{opacity:.4} }
    .min-transcript { overflow-y:auto; flex:1; min-height:0; border:1px solid var(--border-soft); border-radius:14px; padding:12px; background:#fafbff; }
    .min-block { margin-bottom:12px; border-left:3px solid var(--accent-blue); padding-left:10px; }
    .min-speaker { font-size:10px; font-weight:800; color:var(--text-muted); margin-bottom:2px; letter-spacing:.06em; text-transform:uppercase; }
    .min-text { font-size:14px; line-height:1.75; color:var(--text-main); }
    .min-text.interim { color:#9e9e9e; font-style:italic; }
    .min-actions { display:flex; gap:8px; flex-wrap:wrap; padding:10px 0 0; flex-shrink:0; }
    .min-action-btn { padding:8px 14px; font-size:12px; border-radius:999px; border:1px solid var(--border-soft); background:#f4f5f9; cursor:pointer; font-weight:700; font-family:inherit; user-select:none; }
    .min-action-btn:active { transform:scale(0.96); }
    .min-hist-item { padding:11px 14px; border-radius:12px; background:#f4f5f9; margin-bottom:8px; cursor:pointer; }
    .min-hist-item:active { background:#e8eaf6; }
    .min-hist-title { font-size:13px; font-weight:800; color:var(--text-main); }
    .min-hist-meta { font-size:11px; color:var(--text-muted); margin-top:2px; }

    /* ======= TAILSCALE CARD ======= */
    .ts-card { background: linear-gradient(135deg, #0d1b2a 0%, #1b263b 100%); border-radius: 16px; padding: 14px; margin-bottom: 10px; color: #e0e8f0; }
    .ts-card-title { font-size: 13px; font-weight: 800; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
    .ts-status-dot { width: 8px; height: 8px; border-radius: 50%; background: #4caf50; box-shadow: 0 0 6px #4caf50; flex-shrink: 0; animation: tsPulse 2s infinite; }
    .ts-status-dot.offline { background: #9e9e9e; box-shadow: none; animation: none; }
    @keyframes tsPulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
    .ts-ip-row { display: flex; align-items: center; gap: 8px; padding: 7px 0; border-bottom: 1px solid rgba(255,255,255,0.08); }
    .ts-ip-row:last-of-type { border-bottom: none; }
    .ts-ip-icon { font-size: 18px; flex-shrink: 0; }
    .ts-ip-info { flex: 1; min-width: 0; }
    .ts-ip-label { font-size: 10px; color: #90a4ae; font-weight: 700; }
    .ts-ip-addr { font-size: 13px; font-weight: 800; font-family: monospace; color: #e0f7fa; letter-spacing: 0.03em; }
    .ts-btn-row { display: flex; gap: 6px; margin-top: 10px; }
    .ts-btn { flex: 1; padding: 9px 4px; border-radius: 10px; border: none; font-size: 11px; font-weight: 800; cursor: pointer; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 4px; transition: opacity 0.15s; font-family: inherit; }
    .ts-btn:active { opacity: 0.8; }
    .ts-btn-ssh { background: linear-gradient(135deg, #00897b, #26a69a); color: #fff; }
    .ts-btn-copy { background: rgba(255,255,255,0.1); color: #e0e8f0; border: 1px solid rgba(255,255,255,0.15); }
    .ts-btn-sftp { background: linear-gradient(135deg, #1565c0, #42a5f5); color: #fff; }

    /* ======= PIN MODAL ======= */
    .pin-modal-body { padding: 4px 0 8px; text-align: center; }
    .pin-purpose { font-size: 13px; color: var(--text-muted); margin-bottom: 16px; line-height: 1.5; }
    .pin-dots { display: flex; justify-content: center; gap: 14px; margin-bottom: 16px; }
    .pin-dot {
      width: 16px; height: 16px; border-radius: 50%;
      border: 2px solid #ccc; background: transparent; transition: all 0.15s;
    }
    .pin-dot.filled { background: var(--accent-blue); border-color: var(--accent-blue); }
    .pin-error-msg { font-size: 12px; color: #c62828; min-height: 18px; margin-bottom: 12px; font-weight: 700; }
    .pin-keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 260px; margin: 0 auto; }
    .pin-key {
      padding: 16px; font-size: 20px; font-weight: 700;
      border: 1px solid var(--border-soft); border-radius: 14px;
      background: rgba(255,255,255,0.9); cursor: pointer;
      font-family: inherit; color: var(--text-main);
      -webkit-tap-highlight-color: transparent; transition: background 0.1s;
    }
    .pin-key:active { background: #e8efff; transform: scale(0.96); }
    .pin-key-sm { font-size: 13px; color: var(--text-muted); }
    .pin-lock-msg { font-size: 12px; color: #c62828; margin-top: 12px; font-weight: 700; min-height: 18px; }

    /* ======= HEALTH INDICATOR ======= */
    .health-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,0.5);
      border: 1px solid rgba(180,190,220,0.3);
      font-size: 11px;
      color: var(--text-muted);
      flex-wrap: wrap;
    }
    .health-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      display: inline-block;
      flex-shrink: 0;
    }
    .health-dot-ok     { background: #4caf50; box-shadow: 0 0 4px rgba(76,175,80,0.6); }
    .health-dot-warn   { background: #ff9800; box-shadow: 0 0 4px rgba(255,152,0,0.6); }
    .health-dot-error  { background: #f44336; box-shadow: 0 0 4px rgba(244,67,54,0.6); }
    .health-item { display: flex; align-items: center; gap: 4px; }

    /* ======= EMERGENCY FAB ======= */
    .fab-recover {
      width: 48px; height: 48px; border-radius: 999px;
      background: linear-gradient(135deg, #f44336, #b71c1c);
      color: #fff; font-size: 18px;
      border: none; cursor: pointer;
      box-shadow: 0 3px 14px rgba(244,67,54,0.42);
      display: flex; align-items: center; justify-content: center;
      font-family: inherit; flex-shrink: 0; transition: transform 0.15s;
    }
    .fab-recover:active { transform: scale(0.93); }
    .fab-recover.hidden { display: none; }

    /* ======= EMERGENCY MODAL ======= */
    .emergency-modal-body {
      display: flex; flex-direction: column; gap: 8px;
    }
    .emergency-section-title {
      font-size: 11px; font-weight: 700; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: .06em;
      margin-top: 4px;
    }
    .emergency-btn {
      display: block; width: 100%;
      padding: 12px 14px;
      border-radius: 12px; border: none;
      font-size: 14px; font-weight: 700;
      cursor: pointer; text-align: left;
      font-family: inherit;
      transition: opacity 0.15s;
    }
    .emergency-btn:active { opacity: 0.8; }
    .emergency-btn-safe   { background: #e3f2fd; color: #1565c0; }
    .emergency-btn-warn   { background: #fff8e1; color: #e65100; }
    .emergency-btn-danger { background: #ffebee; color: #c62828; }
    .emergency-btn-link   { background: #f4f5f9; color: var(--text-main); }
    .emergency-diag {
      background: #f4f5f9; border-radius: 10px;
      padding: 10px 12px; font-size: 11px;
      color: var(--text-muted); line-height: 1.8;
      font-family: monospace;
    }

    /* ===== AI Chat Tab ===== */
    #page-ai {
      flex-direction: column;
      height: calc(100dvh - var(--tab-bar-h) - max(var(--safe-top),12px) - max(var(--safe-bottom),0px) - 32px);
      padding: 0;
    }
    .ai-toolbar {
      display: flex; align-items: center; gap: 6px;
      background: var(--bg-card-solid); border-radius: 18px;
      padding: 8px 12px; margin-bottom: 8px;
      box-shadow: var(--shadow-card); flex-shrink: 0;
    }
    .ai-model-select {
      flex: 1; border: none; background: transparent;
      font-size: 13px; font-weight: 700; color: var(--accent-purple);
      outline: none; cursor: pointer;
    }
    .ai-icon-btn {
      background: none; border: none; font-size: 20px;
      cursor: pointer; padding: 2px 4px; border-radius: 8px;
      line-height: 1;
    }
    .ai-icon-btn:active { background: var(--bg-page); }
    .ai-messages {
      flex: 1; overflow-y: auto; padding: 4px 0;
      display: flex; flex-direction: column; gap: 8px;
    }
    .ai-msg-user {
      align-self: flex-end; max-width: 84%;
      background: var(--accent-blue); color: #fff;
      padding: 10px 14px; border-radius: 18px 18px 4px 18px;
      font-size: 14px; line-height: 1.5; word-break: break-word;
    }
    .ai-msg-assistant {
      align-self: flex-start; max-width: 90%;
      background: var(--bg-card-solid); color: var(--text-main);
      padding: 12px 14px; border-radius: 4px 18px 18px 18px;
      font-size: 14px; line-height: 1.65;
      box-shadow: 0 2px 10px rgba(60,80,200,0.08);
      word-break: break-word;
    }
    .ai-msg-assistant pre {
      background: #1a1a2e; color: #e0f2fe;
      padding: 10px 12px; border-radius: 10px;
      overflow-x: auto; font-size: 12px; margin: 6px 0;
      white-space: pre-wrap; word-break: break-word;
    }
    .ai-msg-assistant code {
      font-size: 12px; background: rgba(79,141,253,0.12);
      padding: 1px 5px; border-radius: 4px;
    }
    .ai-msg-tool {
      align-self: flex-start;
      background: rgba(124,95,230,0.08); border: 1px solid rgba(124,95,230,0.25);
      padding: 5px 12px; border-radius: 10px;
      font-size: 11px; color: var(--text-muted); max-width: 88%;
    }
    .ai-msg-system {
      align-self: center; font-size: 11px;
      color: var(--text-muted); text-align: center; padding: 2px 0;
    }
    .ai-input-row {
      display: flex; gap: 8px; margin-top: 8px;
      background: var(--bg-card-solid); padding: 8px 10px;
      border-radius: 18px; box-shadow: var(--shadow-card); flex-shrink: 0;
    }
    .ai-input {
      flex: 1; border: none; background: transparent;
      font-size: 14px; outline: none; resize: none;
      max-height: 100px; min-height: 34px;
      font-family: inherit; color: var(--text-main);
      padding: 4px 2px; line-height: 1.5;
    }
    .ai-send-btn {
      width: 36px; height: 36px; border-radius: 50%;
      background: var(--accent-blue); color: #fff;
      border: none; cursor: pointer; font-size: 17px;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; align-self: flex-end;
    }
    .ai-send-btn:disabled { opacity: 0.35; cursor: not-allowed; }
    .ai-prompts-wrap {
      display: flex; overflow-x: auto; gap: 6px;
      padding: 6px 10px 2px; scrollbar-width: none; flex-shrink: 0;
    }
    .ai-prompts-wrap::-webkit-scrollbar { display: none; }
    .ai-prompt-chip {
      flex-shrink: 0; padding: 4px 11px; border-radius: 999px;
      border: 1px solid var(--border-soft); background: var(--bg-card);
      font-size: 11px; color: var(--text-muted); cursor: pointer;
      white-space: nowrap; transition: all 0.15s; font-family: inherit;
    }
    .ai-prompt-chip:hover {
      background: var(--bg-glass); color: var(--text-primary);
      border-color: var(--accent-blue);
    }
    .bolt-prompt-input {
      width: 100%; padding: 8px 10px; border-radius: 10px;
      border: 1px solid var(--border-soft); background: var(--bg-glass);
      font-size: 12px; font-family: inherit; resize: none;
      color: var(--text-main); margin-bottom: 8px; box-sizing: border-box;
    }
    .ai-key-input {
      flex: 1; padding: 8px 10px; border-radius: 10px;
      border: 1px solid var(--border-color); font-size: 12px;
      background: var(--bg-card-solid); color: var(--text-main);
      font-family: monospace;
    }

    /* ======= HTTPS バナー ======= */
    .https-banner {
      display: none;
      position: sticky; top: 0; z-index: 900;
      background: linear-gradient(135deg, #ff8c00, #ff5500);
      color: #fff; padding: 10px 14px; font-size: 12px; line-height: 1.5;
      box-shadow: 0 2px 8px rgba(0,0,0,0.18);
    }
    .https-banner a { color: #ffe0b2; font-weight: 700; text-decoration: underline; }
    .https-banner-close { float: right; cursor: pointer; font-size: 16px; line-height: 1; margin-left: 8px; opacity: 0.8; }

    /* ======= タブ管理ボタン ======= */
    .tab-manage-btn {
      flex: 0 0 auto; min-width: 44px;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      padding: 8px 4px 6px; font-size: 9px; font-weight: 700;
      color: var(--text-muted); border: none; background: none;
      cursor: pointer; font-family: inherit; gap: 2px;
      transition: color 0.15s; -webkit-tap-highlight-color: transparent;
      border-left: 1px solid rgba(180,190,220,0.3);
    }
    .tab-manage-btn:active { color: var(--accent-blue); }

    /* ======= タブ管理モーダル ======= */
    .tab-mgr-item {
      display: flex; align-items: center; gap: 10px;
      padding: 11px 0; border-bottom: 1px solid var(--border-color);
      transition: background 0.12s, opacity 0.12s;
      border-radius: 8px;
    }
    .tab-mgr-item:last-child { border-bottom: none; }
    .tab-mgr-item.drag-over { background: rgba(60,80,200,0.08); }
    .tab-mgr-item.dragging { opacity: 0.4; }
    .tab-mgr-handle {
      font-size: 20px; cursor: grab; color: var(--text-muted);
      user-select: none; touch-action: none; padding: 0 4px;
    }
    .tab-mgr-handle:active { cursor: grabbing; }
    .tab-mgr-icon { font-size: 20px; width: 26px; text-align: center; }
    .tab-mgr-label { flex: 1; font-size: 14px; font-weight: 600; }
    .tab-mgr-toggle {
      position: relative; width: 44px; height: 26px;
      background: var(--border-color); border-radius: 13px; cursor: pointer;
      transition: background 0.2s; flex-shrink: 0; border: none;
    }
    .tab-mgr-toggle.on { background: var(--accent-blue); }
    .tab-mgr-toggle::after {
      content: ''; position: absolute; top: 3px; left: 3px;
      width: 20px; height: 20px; border-radius: 50%; background: #fff;
      transition: left 0.2s; box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }
    .tab-mgr-toggle.on::after { left: 21px; }

    /* ======= 従業員管理タブ ======= */
    .emp-list { display: flex; flex-direction: column; gap: 10px; }
    .emp-card {
      background: var(--bg-card-solid); border-radius: 14px;
      border: 1px solid var(--border-color);
      padding: 14px; display: flex; align-items: flex-start; gap: 12px;
      box-shadow: 0 2px 8px rgba(60,80,200,0.06);
      transition: box-shadow 0.15s;
    }
    .emp-card:active { box-shadow: 0 4px 16px rgba(60,80,200,0.14); }
    .emp-avatar {
      width: 44px; height: 44px; border-radius: 50%; flex-shrink: 0;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; color: #fff;
    }
    .emp-info { flex: 1; min-width: 0; }
    .emp-name { font-size: 15px; font-weight: 700; color: var(--text-main); }
    .emp-role { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
    .emp-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
    .emp-tag {
      font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 10px;
      background: var(--bg-page); color: var(--text-muted);
      border: 1px solid var(--border-color);
    }
    .emp-tag.active-tag { background: #e8f5e9; color: #2e7d32; border-color: #a5d6a7; }
    .emp-tag.inactive-tag { background: #fce4ec; color: #c62828; border-color: #ef9a9a; }
    .emp-actions { display: flex; flex-direction: column; gap: 4px; }
    .emp-action-btn {
      background: var(--bg-card-solid); border: 1px solid var(--border-color);
      border-radius: 8px; padding: 4px 10px; font-size: 11px; cursor: pointer;
      color: var(--text-muted); font-family: inherit;
    }
    .emp-action-btn:active { background: var(--accent-blue); color: #fff; border-color: var(--accent-blue); }
    .emp-empty { text-align: center; padding: 40px 20px; color: var(--text-muted); font-size: 14px; }
    .emp-add-btn {
      width: 100%; padding: 14px; border-radius: 14px;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      color: #fff; font-size: 15px; font-weight: 700; border: none;
      cursor: pointer; font-family: inherit; margin-bottom: 12px;
      box-shadow: 0 4px 14px rgba(60,80,200,0.25);
    }

    /* ======= 市場価値タブ ======= */
    .market-score-ring {
      width: 120px; height: 120px; margin: 0 auto 16px;
      position: relative; display: flex; align-items: center; justify-content: center;
    }
    .market-score-ring svg { position: absolute; top: 0; left: 0; transform: rotate(-90deg); }
    .market-score-ring-inner { text-align: center; z-index: 1; }
    .market-score-num { font-size: 34px; font-weight: 800; color: var(--accent-blue); line-height: 1; }
    .market-score-label { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    .market-income-estimate {
      text-align: center; padding: 14px; border-radius: 14px;
      background: linear-gradient(135deg, rgba(60,80,200,0.08), rgba(130,80,200,0.08));
      border: 1px solid rgba(60,80,200,0.15); margin-bottom: 14px;
    }
    .market-income-num { font-size: 28px; font-weight: 800; color: var(--accent-blue); }
    .market-income-unit { font-size: 14px; color: var(--text-muted); }
    .market-section-title { font-size: 13px; font-weight: 700; color: var(--text-muted); margin: 14px 0 8px; letter-spacing: 0.5px; }
    .market-skill-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
    .market-skill-chip {
      padding: 8px 10px; border-radius: 10px; cursor: pointer;
      border: 2px solid var(--border-color); background: var(--bg-card-solid);
      font-size: 12px; font-weight: 600; color: var(--text-muted);
      transition: all 0.15s; text-align: left; font-family: inherit;
      display: flex; align-items: center; gap: 6px;
    }
    .market-skill-chip.selected {
      border-color: var(--accent-blue); background: rgba(60,80,200,0.08);
      color: var(--accent-blue);
    }
    .market-skill-chip.selected::before { content: '✓ '; }
    .market-slider-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .market-slider-label { font-size: 12px; color: var(--text-muted); min-width: 80px; }
    .market-slider { flex: 1; accent-color: var(--accent-blue); }
    .market-slider-val { font-size: 13px; font-weight: 700; color: var(--accent-blue); min-width: 30px; text-align: right; }
    .market-breakdown { display: flex; flex-direction: column; gap: 6px; }
    .market-bd-row { display: flex; align-items: center; gap: 8px; font-size: 12px; }
    .market-bd-label { color: var(--text-muted); min-width: 110px; }
    .market-bd-bar-wrap { flex: 1; height: 6px; background: var(--border-color); border-radius: 3px; overflow: hidden; }
    .market-bd-bar { height: 100%; border-radius: 3px; background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple)); transition: width 0.4s; }
    .market-bd-val { font-weight: 700; color: var(--accent-blue); min-width: 32px; text-align: right; }
    .market-reco { background: rgba(60,80,200,0.06); border-radius: 12px; padding: 12px; font-size: 12px; line-height: 1.7; }
    .market-reco strong { color: var(--accent-blue); }
  </style>
</head>

<body>
  <!-- Network status banner -->
  <div class="net-banner" id="net-banner" role="status" aria-live="polite"></div>

  <!-- Install banner (iOS) -->
  <div class="install-banner" id="install-banner">
    <span class="install-close" id="install-close">×</span>
    <strong>ホーム画面に追加してアプリとして使う</strong><br>
    Safari の <strong>共有ボタン（↑）→「ホーム画面に追加」</strong> をタップ
  </div>

  <!-- Auto-backup reminder banner -->
  <div class="backup-banner" id="backup-banner">
    <div class="backup-banner-row">
      <div class="backup-banner-text">
        <strong>⚠️ バックアップをお勧めします</strong><br>
        <span id="backup-days-msg">前回のバックアップから7日以上経過しています</span>
      </div>
      <button class="backup-now-btn" id="btn-backup-now">一括バックアップ</button>
      <span class="backup-dismiss" id="backup-dismiss">×</span>
    </div>
  </div>

  <!-- HTTPS 混在コンテンツ警告バナー -->
  <div class="https-banner" id="https-banner">
    <span class="https-banner-close" id="https-banner-close">✕</span>
    ⚠️ <strong>Safari でサーバーに接続できません。</strong>
    HTTPS(GitHub Pages) → HTTP(localhost) は Safari でブロックされます。<br>
    Mac では <a href="http://localhost:8899/" target="_blank" rel="noopener">http://localhost:8899/</a> を直接ブックマークして開いてください。
  </div>

  <!-- ===== TAB: 勤怠カレンダー ===== -->
  <div id="page-calendar" class="tab-page active">
  <div class="card" id="calendar-card">
    <div class="overlay" id="overlay"><div class="spinner"></div></div>

    <div class="card-title">勤怠カレンダー（メモ付き）</div>

    <!-- Monthly stats bar -->
    <div class="stats-bar" id="stats-bar">
      <span class="stat-chip stat-office">出社 <b id="stat-office">0</b>日</span>
      <span class="stat-chip stat-home">在宅 <b id="stat-home">0</b>日</span>
      <span class="stat-chip stat-off">休暇 <b id="stat-off">0</b>日</span>
      <span class="stat-chip stat-hours">勤務 <b id="stat-hours">0h</b></span>
      <button class="stat-chip stat-weekly-toggle" id="weekly-toggle">週次人月 <span id="weekly-arrow">▾</span></button>
    </div>
    <!-- Weekly person-month breakdown (折りたたみ) -->
    <div class="weekly-stats" id="weekly-stats"></div>

    <!-- 今日の天気ミニバナー -->
    <div id="cal-weather-wrap" style="display:none;margin-bottom:6px;">
      <div class="cal-weather-strip" id="cal-weather-strip">
        <div class="cal-w-emoji" id="cal-w-emoji">🌤</div>
        <div class="cal-weather-info">
          <div class="cal-w-cond" id="cal-w-cond">--</div>
          <div class="cal-w-sub" id="cal-w-sub">読み込み中…</div>
        </div>
        <div class="cal-w-temps" id="cal-w-temps">--°/--°</div>
        <button class="cal-outfit-btn" id="cal-hourly-btn">⏱ 時間別</button>
        <button class="cal-outfit-btn" id="cal-outfit-btn" style="background:linear-gradient(135deg,#2e7d32,#66bb6a);">👗 服装</button>
      </div>
      <!-- 時間別予報展開 -->
      <div id="cal-hourly-expand" style="display:none;margin-top:6px;padding:8px 4px 4px;background:rgba(255,255,255,0.6);border-radius:12px;">
        <div class="hourly-scroll" id="cal-hourly-scroll"></div>
      </div>
      <!-- 服装展開 -->
      <div id="cal-outfit-expand" style="display:none;margin-top:6px;">
        <div class="outfit-card" id="cal-outfit-card"></div>
      </div>
    </div>

    <div class="header-bar">
      <div class="header-left">
        <button class="nav-arrow" id="prev-month">‹</button>
        <button class="pill-button pill-button-primary" id="today-button">今日</button>
      </div>
      <div class="month-label" id="month-label">----</div>
      <div class="header-right">
        <button class="pill-button" id="lock-toggle">
          <span class="icon">🔒</span><span id="lock-label">ロック</span>
        </button>
        <button class="nav-arrow" id="next-month">›</button>
      </div>
    </div>

    <div class="calendar-wrapper">
      <table class="calendar">
        <thead>
          <tr>
            <th>日</th><th>月</th><th>火</th><th>水</th><th>木</th><th>金</th><th>土</th>
          </tr>
        </thead>
        <tbody id="calendar-body"></tbody>
      </table>
    </div>

    <div class="footer">
      <div class="legend">
        ステータス：
        <span class="badge badge-work">出</span>
        <span class="badge badge-home">在</span>
        <span class="badge badge-kyujitsu">休日</span>
        <span class="badge badge-holiday">休み</span>
        <span class="badge badge-shuku">祝日</span><br>
        日曜→休日 / 土曜→休み / 祝日は自動判定。メモあり＝<span style="color:#ff9800;font-weight:800;">●</span>
      </div>
      <div class="data-actions">
        <button class="data-btn" id="btn-xlsx">📊 xlsx書き出し</button>
        <button class="data-btn" id="btn-export">💾 JSONバックアップ</button>
        <button class="data-btn" id="btn-import">📥 JSON読み込み</button>
        <button class="data-btn" id="btn-migrate">🔄 iSH版を取り込む</button>
        <button class="data-btn" id="btn-jinjer">🏢 jinjer同期</button>
        <button class="data-btn" id="btn-minutes">📝 議事録</button>
        <button class="data-btn" id="btn-measure">📏 サイズ計測</button>
        <button class="data-btn" id="btn-settings">⚙️ 設定</button>
        <button class="data-btn" id="btn-recover" style="color:#c62828;border-color:#ffcdd2;background:rgba(255,235,238,0.7);">🚨 緊急復旧</button>
      </div>
      <!-- Health status bar -->
      <div class="health-bar" id="health-bar">
        <span class="health-item" id="health-srv-item" title="ローカルサーバー (port 8899)"><span class="health-dot" id="health-dot-srv"></span><span id="health-srv">SRV: --</span></span>
        <span class="health-item"><span class="health-dot" id="health-dot-ls"></span><span id="health-ls">LS: --</span></span>
        <span class="health-item health-item-btn" id="health-idb-item" title="タップでログを確認"><span class="health-dot" id="health-dot-idb"></span><span id="health-idb">IDB: --</span></span>
        <span class="health-item health-item-btn" id="health-err-item" title="タップでエラーログを確認"><span class="health-dot" id="health-dot-err"></span><span id="health-err">エラー: --</span></span>
        <span style="flex:1"></span>
        <span id="health-snap" style="font-size:10px;color:var(--text-muted);"></span>
        <button class="health-log-btn" id="health-perf-btn" title="パフォーマンス">📊</button>
        <button class="health-log-btn" id="health-log-btn" title="システムログ">📋</button>
      </div>
      <input type="file" id="file-import"  accept=".json" style="display:none">
      <input type="file" id="file-jinjer" accept=".json" style="display:none">
    </div>
  </div>
  </div><!-- /page-calendar -->

  <!-- ===== TAB: ハブ / クイックランチャー ===== -->
  <div id="page-hub" class="tab-page">
    <div style="text-align:right;margin-bottom:4px;">
      <button id="hub-sort-btn" class="btn-secondary" style="font-size:12px;padding:4px 10px;">🔀 カード並び替え</button>
    </div>

    <!-- 天気予報カード -->
    <div class="card weather-card-wrap" id="weather-card-wrap">
      <div class="card-title">🌤 天気予報</div>
      <div class="weather-loading" id="weather-loading">天気情報を取得中…</div>
      <div id="weather-main-section" style="display:none;">
        <div id="weather-today"></div>
        <!-- 1時間毎の予報 -->
        <div class="hourly-section">
          <div class="hourly-label">⏱ 時間ごとの天気</div>
          <div class="hourly-scroll" id="hourly-scroll"></div>
        </div>
        <!-- 服装おすすめ（Amazon連携） -->
        <div id="outfit-board"></div>
        <!-- 健康・生活アドバイス -->
        <div id="health-advice-board"></div>
        <!-- 7日間予報 -->
        <div class="forecast-label">📅 7日間予報</div>
        <div class="forecast-scroll" id="forecast-scroll"></div>
      </div>
      <div id="weather-error" style="display:none;color:var(--text-muted);font-size:13px;text-align:center;padding:8px 0;"></div>
      <button class="weather-refresh-btn" id="weather-refresh-btn">🔄 更新</button>
    </div>

    <div class="card" id="hub-launcher-card">
      <div class="card-title">🚀 クイックランチャー</div>
      <!-- jinjer 打刻ボタン（大） -->
      <a href="https://kintai.jinjer.biz/staffs/top" target="_blank" rel="noopener" class="jinjer-card" id="jinjer-link">
        <div class="jinjer-icon">🏢</div>
        <div class="jinjer-info">
          <div class="jinjer-label">jinjer 打刻</div>
          <div class="jinjer-sub" id="jinjer-card-sub">出勤・退勤を記録する ↗</div>
        </div>
        <div class="jinjer-arrow">⏱</div>
      </a>
      <div id="jinjer-today-bar" style="background:#e3f2fd;border-radius:12px;padding:10px 14px;margin-bottom:10px;font-size:12px;display:none;">
        <span style="font-weight:800;color:#1565c0;">📍 今日の打刻状況</span>
        <span id="jinjer-today-status" style="margin-left:10px;"></span>
      </div>
      <div class="card-title" style="margin-top:4px;">マイアプリ・リンク</div>
      <div class="links-grid" id="links-grid"></div>
      <div style="font-size:11px;color:var(--text-muted);line-height:1.5;margin-top:4px;">
        ➕ をタップしてよく使うサービスを追加できます
      </div>
    </div>

    <!-- システム情報カード -->
    <div class="card" id="sysinfo-card">
      <div class="card-title">📁 システム情報</div>
      <div id="sysinfo-summary" style="font-size:11px;color:var(--text-muted);margin-bottom:6px;">読み込み中…</div>
      <div id="sysinfo-docker-row" style="display:flex;align-items:center;justify-content:space-between;font-size:11px;color:var(--text-muted);margin-bottom:8px;">
        <span id="sysinfo-docker-status">🐳 Docker: 確認中…</span>
        <button class="btn-secondary" id="sysinfo-docker-tab-btn" style="font-size:11px;padding:2px 8px;">管理 ↗</button>
      </div>
      <button class="btn-secondary" id="sysinfo-open-btn" style="width:100%;margin-bottom:6px;">📂 ファイルブラウザを開く</button>
      <button class="btn-secondary" id="sysinfo-structure-btn" style="width:100%;">📋 STRUCTURE.md を見る</button>
    </div>

    <!-- DB ステータスカード -->
    <div class="card" id="db-status-card">
      <div class="card-title">🗄 データストア状態</div>
      <div id="db-status-content">
        <div class="db-status-grid">
          <div class="db-status-item skeleton" style="height:58px;"></div>
          <div class="db-status-item skeleton" style="height:58px;"></div>
          <div class="db-status-item skeleton" style="height:58px;"></div>
          <div class="db-status-item skeleton" style="height:58px;"></div>
        </div>
      </div>
      <div class="db-status-refresh-row">
        <span class="db-status-last-updated" id="db-status-updated"></span>
        <div style="display:flex;gap:6px;">
          <button class="btn-secondary" id="db-refresh-btn" style="padding:4px 10px;font-size:11px;">🔄 更新</button>
          <button class="btn-secondary" id="db-export-all-btn" style="padding:4px 10px;font-size:11px;">💾 全バックアップ</button>
        </div>
      </div>
    </div>

    <!-- Tailscale VPN / SSH card -->
    <div class="card" id="ts-card-wrap" style="display:none;">
      <div class="ts-card">
        <div class="ts-card-title">
          <span class="ts-status-dot" id="ts-status-dot"></span>
          🔒 Tailscale VPN
          <span id="ts-status-label" style="font-size:10px;opacity:0.7;margin-left:4px;"></span>
        </div>
        <div class="ts-ip-row">
          <div class="ts-ip-icon">💻</div>
          <div class="ts-ip-info">
            <div class="ts-ip-label">MacBook (このデバイス)</div>
            <div class="ts-ip-addr" id="ts-mac-ip-disp">--</div>
          </div>
          <button class="ts-btn ts-btn-copy" id="ts-copy-mac" style="flex:none;padding:6px 10px;">📋</button>
        </div>
        <div class="ts-ip-row">
          <div class="ts-ip-icon">📱</div>
          <div class="ts-ip-info">
            <div class="ts-ip-label">iPhone 13 Pro</div>
            <div class="ts-ip-addr" id="ts-iphone-ip-disp">--</div>
          </div>
          <button class="ts-btn ts-btn-copy" id="ts-copy-iphone" style="flex:none;padding:6px 10px;">📋</button>
        </div>
        <div class="ts-btn-row">
          <a class="ts-btn ts-btn-ssh" id="ts-ssh-btn" href="#" target="_blank" rel="noopener">🖥 SSH接続</a>
          <a class="ts-btn ts-btn-sftp" id="ts-sftp-btn" href="#" target="_blank" rel="noopener">📁 SFTP</a>
          <button class="ts-btn ts-btn-copy" id="ts-ping-btn">📡 疎通確認</button>
        </div>
        <div id="ts-ping-result" style="font-size:11px;margin-top:8px;text-align:center;display:none;"></div>
      </div>
    </div>

    <!-- iPhone 接続ガイドカード -->
    <div class="card" id="iphone-guide-card" style="margin-bottom:10px;">
      <div class="card-title">📱 iPhone 接続ガイド</div>
      <div style="font-size:12px;line-height:1.8;color:var(--text-muted);">
        <div style="font-weight:700;color:var(--text-main);margin-bottom:6px;">🔴 現在の状態確認</div>
        <div id="iphone-guide-status" style="padding:8px;background:var(--bg-page);border-radius:8px;margin-bottom:10px;font-size:11px;">
          確認中...
        </div>
        <div style="font-weight:700;color:var(--text-main);margin-bottom:6px;">📋 Tailscale Serve セットアップ手順</div>
        <ol style="padding-left:20px;margin:0 0 10px;">
          <li><strong>Tailscale.app を起動</strong>（ステータスバーのTailscaleアイコン → オン）</li>
          <li>ターミナルで実行: <code style="background:var(--bg-page);padding:2px 6px;border-radius:4px;">tailscale serve --bg 8899</code></li>
          <li>設定（⚙️）→ 外部HTTPS URL → 「🔍 自動検出」</li>
          <li>iPhone に <strong>Tailscale アプリ</strong>をインストールして同じアカウントでログイン</li>
        </ol>
        <div style="font-weight:700;color:var(--text-main);margin-bottom:6px;">☁️ Cloudflare Tunnel（Tailscale不要・iPhone何も不要）</div>
        <div style="font-family:monospace;font-size:11px;background:var(--bg-page);padding:8px;border-radius:8px;">
          brew install cloudflare/cloudflare/cloudflared<br>
          cloudflared tunnel --url http://localhost:8899<br>
          <span style="color:var(--text-muted)"># 表示された https://xxxx.trycloudflare.com を設定に貼る</span>
        </div>
      </div>
    </div>

    <!-- システム改善提案カード -->
    <div class="card" id="improvement-card">
      <div class="card-title">🚀 システム改善ロードマップ</div>
      <div id="improvement-list" style="font-size:12px;line-height:2;"></div>
    </div>

    <!-- Bolt.new 統合カード -->
    <div class="card" id="bolt-card">
      <div class="card-title">⚡ Bolt.new — AI コーディング環境</div>
      <p style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">
        AIがコードを自動生成するブラウザ開発環境。新機能プロトタイプや新規プロジェクトを即作成できます。
      </p>
      <textarea id="bolt-prompt" class="bolt-prompt-input" rows="2"
        placeholder="作りたいものを説明（例: ダークモード対応の家計簿アプリ）"></textarea>
      <div style="display:flex;gap:8px;margin-bottom:8px;">
        <button id="bolt-new-btn" class="btn-primary" style="flex:1;font-size:12px;">⚡ 新規プロジェクト</button>
        <button id="bolt-kintai-btn" class="btn-secondary" style="flex:1;font-size:12px;">📦 kintai を開く</button>
      </div>
      <p style="font-size:10px;color:var(--text-muted);margin:0;">
        💡 「kintai を開く」は GitHub リポジトリを Bolt.new にインポートします
      </p>
    </div>

    <!-- 株価画像分析カード -->
    <div class="card" id="stock-analysis-card">
      <div class="card-title">📈 株価画像分析 (AI)</div>
      <p style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">HEIC / JPG / PNG のチャート画像を選択して Claude AI にテクニカル分析させます</p>
      <input type="file" id="stock-img-input" accept="image/*,.heic" multiple style="display:none;">
      <button class="btn-secondary" style="width:100%;margin-bottom:8px;"
        onclick="document.getElementById('stock-img-input').click()">
        📂 株価画像を選択（HEIC/JPG/PNG）
      </button>
      <div id="stock-analysis-preview" style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;min-height:0;"></div>
      <button id="stock-analyze-btn" class="btn-primary" style="width:100%;display:none;">🤖 AI分析を実行</button>
      <div id="stock-analysis-result" style="margin-top:10px;font-size:13px;line-height:1.8;white-space:pre-wrap;"></div>
    </div>
  </div>

  <!-- ===== TAB: 資格・学習進捗 ===== -->
  <div id="page-study" class="tab-page">
    <!-- 今週の学習サマリー -->
    <div class="card" style="margin-bottom:10px;">
      <div class="card-title">📈 今週の学習</div>
      <div id="study-week-summary" style="display:flex;gap:8px;flex-wrap:wrap;padding:2px 0 4px;"></div>
    </div>
    <div class="card">
      <div class="card-title">📚 資格・学習進捗</div>
      <div id="study-list"></div>
      <button class="data-btn" id="btn-add-study" style="width:100%;text-align:center;margin-top:4px;">＋ 資格・学習目標を追加</button>
    </div>
  </div>

  <!-- ===== TAB: プロジェクト進捗 ===== -->
  <div id="page-project" class="tab-page">
    <div class="card" style="margin-bottom:10px;">
      <div class="card-title">📊 サマリー</div>
      <div id="project-summary" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
    </div>
    <div class="card">
      <div class="card-title">📋 プロジェクト一覧</div>
      <div id="project-list"></div>
      <button class="data-btn" id="btn-add-project" style="width:100%;text-align:center;margin-top:4px;">＋ プロジェクトを追加</button>
    </div>
  </div>

  <!-- ===== TAB: 業務報告書 ===== -->
  <div id="page-report" class="tab-page">
    <!-- サーバー未起動バナー -->
    <div class="report-server-banner" id="report-server-banner" style="display:none;">
      ⚠️ <strong>ローカルサーバー未接続</strong>
      <span id="report-srv-reconnecting" style="margin-left:8px;font-size:12px;opacity:0.85;">🔄 自動再接続中…</span>
      <div style="margin-top:8px;">
        <input type="file" id="report-local-file" accept=".xlsx,.xls" style="display:none;">
        <button class="btn-secondary" style="font-size:12px;padding:4px 12px;"
          onclick="document.getElementById('report-local-file').click()">
          📂 Excelを直接開く
        </button>
        <span style="font-size:11px;color:var(--text-muted);margin-left:8px;">（Work_ReportフォルダからXLSXを選択）</span>
      </div>
    </div>

    <!-- 月選択ナビ -->
    <div class="card" style="margin-bottom:10px;">
      <div class="card-title">📋 業務報告書</div>
      <div class="report-month-nav" id="report-month-nav"></div>

      <!-- ステータスカード -->
      <div id="report-status-area"></div>

      <!-- メタ情報 -->
      <div class="report-meta-grid" id="report-meta-grid" style="display:none;"></div>

      <!-- サマリー -->
      <div class="report-summary-bar" id="report-summary-bar" style="display:none;"></div>

      <!-- アクションボタン -->
      <div class="report-actions">
        <button class="data-btn" id="btn-report-load">📥 Excel 読み込み</button>
        <button class="data-btn" id="btn-report-sync">📤 kintai から同期</button>
        <button class="data-btn" id="btn-report-generate">➕ 翌月を自動生成</button>
      </div>
    </div>

    <!-- 日別テーブル -->
    <div class="card" id="report-table-card" style="margin-bottom:10px;">
      <div class="card-title">📆 日別作業内容</div>
      <div id="report-table-area">
        <div class="report-empty" id="report-empty-msg">← 月を選択してください</div>
      </div>
    </div>

    <!-- 自動化提案パネル -->
    <div class="card" style="margin-bottom:10px;">
      <div class="report-automation-panel">
        <div class="report-automation-header" id="report-auto-toggle">
          <span class="report-automation-title">🤖 業務自動化の提案・状況</span>
          <span id="report-auto-arrow" style="font-size:14px;transition:transform 0.2s;">▶</span>
        </div>
        <div class="report-automation-body" id="report-auto-body">
          <div id="report-auto-launchd-status" style="margin-bottom:10px;"></div>
          <div class="report-suggestion">
            <div class="report-suggestion-icon">📅</div>
            <div class="report-suggestion-text">
              <div class="report-suggestion-title">毎月1日: 翌月Excel自動生成</div>
              <div class="report-suggestion-desc">launchd (com.kintai.monthly) により毎月1日 08:00 に翌月の作業報告書テンプレートを自動生成します。祝日も自動入力。</div>
            </div>
          </div>
          <div class="report-suggestion">
            <div class="report-suggestion-icon">🔄</div>
            <div class="report-suggestion-text">
              <div class="report-suggestion-title">毎月28日: jinjer同期 + Excel自動記入</div>
              <div class="report-suggestion-desc">月末にjinjerから勤怠データを取得し、kintaiカレンダーと作業報告書Excelを自動更新します。</div>
            </div>
          </div>
          <div class="report-suggestion">
            <div class="report-suggestion-icon">🌅</div>
            <div class="report-suggestion-text">
              <div class="report-suggestion-title">毎朝07:30: STRUCTURE.md自動更新</div>
              <div class="report-suggestion-desc">ディレクトリ構成図を毎日最新の状態でリポジトリに保存します（git pushで公開）。</div>
            </div>
          </div>
          <div class="report-suggestion">
            <div class="report-suggestion-icon">💡</div>
            <div class="report-suggestion-text">
              <div class="report-suggestion-title">【提案】作業内容テンプレート化</div>
              <div class="report-suggestion-desc">「【定常作業】日次ログ確認」のような繰り返し作業はテンプレートとして登録し、1クリックで入力できます。kintaiの「メモ」欄に保存して報告書に自動反映。</div>
            </div>
          </div>
          <div class="report-suggestion">
            <div class="report-suggestion-icon">📊</div>
            <div class="report-suggestion-text">
              <div class="report-suggestion-title">【提案】月次工数サマリーの自動作成</div>
              <div class="report-suggestion-desc">kintaiデータから在宅・出社・休暇の日数と総時間を集計し、月次報告に使えるテキストを自動生成します。</div>
            </div>
          </div>
          <div class="report-suggestion">
            <div class="report-suggestion-icon">📧</div>
            <div class="report-suggestion-text">
              <div class="report-suggestion-title">【提案】報告書提出リマインダー</div>
              <div class="report-suggestion-desc">月末近くに作業報告書が「作成中」状態のままの場合、macOS通知でリマインドする仕組みを追加できます。</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== TAB: フリーランス案件 ===== -->
  <div id="page-jobs" class="tab-page">
    <!-- サーバー未起動バナー -->
    <div class="jobs-server-banner" id="jobs-server-banner" style="display:none;">
      <span>⚡ ローカルサーバー未接続</span>
      <span style="font-size:11px;opacity:0.8;">🔄 自動再接続中…</span>
    </div>
    <!-- フィルターバー -->
    <div class="card" style="margin-bottom:10px;">
      <div class="jobs-filter-bar">
        <div id="jobs-platform-chips" class="jobs-platform-chips">
          <span class="jobs-platform-chip active" data-platform="crowdworks">CW</span>
          <span class="jobs-platform-chip active" data-platform="lancers">Lancers</span>
        </div>
        <div id="jobs-skill-display" class="jobs-skill-display"></div>
        <button class="jobs-refresh-btn" id="jobs-refresh-btn" title="案件を再取得">🔄</button>
      </div>
      <div id="jobs-fetch-status" class="jobs-fetch-status"></div>
    </div>
    <!-- 今日のおすすめ案件 -->
    <div class="card" style="margin-bottom:10px;" id="jobs-pickup-card">
      <div class="jobs-section-title">🎯 今日のおすすめ案件</div>
      <div id="jobs-pickup-list" class="jobs-pickup-list"></div>
    </div>
    <!-- 全案件リスト -->
    <div id="jobs-list-container">
      <div class="jobs-empty" id="jobs-empty-state">💼 案件を読み込んでいます...</div>
    </div>
  </div>

  <!-- AI Chat Tab -->
  <div id="page-ai" class="tab-page">
    <div class="ai-toolbar">
      <select class="ai-model-select" id="ai-model-select">
        <optgroup label="Anthropic">
          <option value="claude">🤖 Claude (Sonnet 4.6)</option>
        </optgroup>
        <optgroup label="OpenAI">
          <option value="openai">💬 ChatGPT (GPT-4o)</option>
        </optgroup>
        <optgroup label="Google">
          <option value="gemini">✨ Gemini 2.0 Flash</option>
        </optgroup>
      </select>
      <button class="ai-icon-btn" id="ai-settings-btn" title="APIキー設定">⚙️</button>
      <button class="ai-icon-btn" id="ai-clear-btn" title="履歴クリア">🗑️</button>
    </div>
    <div class="ai-messages" id="ai-messages"></div>
    <div class="ai-prompts-wrap" id="ai-prompts-wrap"></div>
    <div class="ai-input-row">
      <textarea class="ai-input" id="ai-input" placeholder="AIに質問… (Enter で送信、Shift+Enter で改行)" rows="1"></textarea>
      <button class="ai-send-btn" id="ai-send-btn">↑</button>
    </div>
  </div>

  <!-- ===== TAB: システムログ・更新履歴 ===== -->
  <div id="page-system" class="tab-page">
    <!-- 更新履歴 -->
    <div class="card" style="margin-bottom:10px;">
      <div class="card-title">🏷 更新履歴 / Changelog</div>
      <div id="cl-entries"></div>
    </div>
    <!-- サーバーログ -->
    <div class="card" style="margin-bottom:10px;">
      <div class="card-title">📟 サーバーログ</div>
      <div style="display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap;">
        <button class="btn-secondary" id="cl-log-server-btn" style="flex:1;font-size:11px;">📋 server.log</button>
        <button class="btn-secondary" id="cl-log-watchdog-btn" style="flex:1;font-size:11px;">🐕 watchdog.log</button>
        <button class="btn-secondary" id="cl-log-refresh-btn" style="padding:4px 10px;font-size:11px;">🔄</button>
      </div>
      <div class="cl-log-area" id="cl-log-area">サーバーに接続してログを取得...</div>
    </div>
    <!-- DB / システム情報 -->
    <div class="card">
      <div class="card-title">⚙️ システム情報</div>
      <div id="cl-sysinfo" style="font-size:12px;color:var(--text-muted);line-height:1.8;"></div>
    </div>
  </div>

  <!-- AI Settings Modal -->
  <div class="modal-backdrop" id="ai-settings-modal" style="display:none;">
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div class="modal-title">🔑 AI API キー設定</div>
        <button class="modal-close" id="ai-settings-close">✕</button>
      </div>
      <div style="padding:0 4px 12px;">
        <div style="font-size:11px;color:var(--text-muted);margin-bottom:14px;line-height:1.5;">
          APIキーはデバイス内に AES-GCM 暗号化して保存されます。<br>外部サーバーには送信されません。
        </div>
        <div style="margin-bottom:12px;">
          <div style="font-size:12px;font-weight:700;margin-bottom:5px;">🤖 Anthropic API Key (Claude)</div>
          <div style="display:flex;gap:6px;">
            <input type="password" class="ai-key-input" id="ai-key-claude" placeholder="sk-ant-api03-…">
            <button class="ai-icon-btn" id="ai-key-claude-toggle" style="border:1px solid var(--border-color);border-radius:10px;padding:6px 10px;">👁</button>
          </div>
        </div>
        <div style="margin-bottom:12px;">
          <div style="font-size:12px;font-weight:700;margin-bottom:5px;">💬 OpenAI API Key (ChatGPT)</div>
          <div style="display:flex;gap:6px;">
            <input type="password" class="ai-key-input" id="ai-key-openai" placeholder="sk-proj-…">
            <button class="ai-icon-btn" id="ai-key-openai-toggle" style="border:1px solid var(--border-color);border-radius:10px;padding:6px 10px;">👁</button>
          </div>
        </div>
        <div style="margin-bottom:16px;">
          <div style="font-size:12px;font-weight:700;margin-bottom:5px;">✨ Google AI API Key (Gemini)</div>
          <div style="display:flex;gap:6px;">
            <input type="password" class="ai-key-input" id="ai-key-gemini" placeholder="AIza…">
            <button class="ai-icon-btn" id="ai-key-gemini-toggle" style="border:1px solid var(--border-color);border-radius:10px;padding:6px 10px;">👁</button>
          </div>
        </div>
        <button id="ai-settings-save" style="width:100%;padding:12px;background:var(--accent-blue);color:#fff;border:none;border-radius:14px;font-size:14px;font-weight:700;cursor:pointer;">💾 保存</button>
      </div>
    </div>
  </div>

  <!-- 編集モーダル -->
  <div class="modal-backdrop" id="memo-modal">
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div id="modal-date-label"></div>
        <div class="modal-close" id="modal-close">×</div>
      </div>

      <div class="modal-section-title">ステータス</div>
      <div class="status-chip-row" id="status-chip-row"></div>

      <div class="modal-section-title">業務時間（1分単位）</div>
      <div class="row-time">
        <input id="start-time" class="time-input" type="time" step="60">
        <span style="color:var(--text-muted);font-weight:800;">〜</span>
        <input id="end-time" class="time-input" type="time" step="60">
      </div>

      <div class="dup-row">
        <button class="btn-secondary" id="btn-dup-prev">前日を複製</button>
        <button class="btn-secondary" id="btn-dup-last">直近を複製</button>
      </div>

      <div class="modal-section-title">メモ</div>
      <textarea id="memo-textarea" class="memo-textarea" placeholder="この日のメモを入力"></textarea>

      <div class="modal-section-title" style="margin-top:10px;">Obsidian</div>
      <div class="obs-row">
        <button class="btn-secondary" id="btn-obs-open">📝 Obsidianで開く</button>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" id="modal-cancel">キャンセル</button>
        <button class="btn-primary" id="modal-save">保存</button>
      </div>
    </div>
  </div>

  <!-- PIN 認証モーダル -->
  <div class="modal-backdrop" id="pin-modal">
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div>🔐 PIN 認証</div>
        <div class="modal-close" id="pin-modal-cancel">×</div>
      </div>
      <div class="pin-modal-body">
        <div class="pin-purpose" id="pin-purpose">この操作にはPINが必要です</div>
        <div class="pin-dots" id="pin-dots">
          <div class="pin-dot"></div>
          <div class="pin-dot"></div>
          <div class="pin-dot"></div>
          <div class="pin-dot"></div>
        </div>
        <div class="pin-error-msg" id="pin-error"></div>
        <div class="pin-keypad">
          <button class="pin-key" data-key="1">1</button>
          <button class="pin-key" data-key="2">2</button>
          <button class="pin-key" data-key="3">3</button>
          <button class="pin-key" data-key="4">4</button>
          <button class="pin-key" data-key="5">5</button>
          <button class="pin-key" data-key="6">6</button>
          <button class="pin-key" data-key="7">7</button>
          <button class="pin-key" data-key="8">8</button>
          <button class="pin-key" data-key="9">9</button>
          <button class="pin-key pin-key-sm" id="pin-key-cancel">キャンセル</button>
          <button class="pin-key" data-key="0">0</button>
          <button class="pin-key pin-key-sm" id="pin-key-del">⌫</button>
        </div>
        <div class="pin-lock-msg" id="pin-lock-msg"></div>
      </div>
    </div>
  </div>

  <!-- 設定モーダル -->
  <div class="modal-backdrop" id="settings-modal">
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div>設定</div>
        <div class="modal-close" id="settings-close">×</div>
      </div>
      <div class="settings-body">
        <div class="settings-row">
          <div class="settings-label">Obsidian Vault 名</div>
          <input id="settings-vault" class="settings-input" type="text" placeholder="例: MyVault">
          <div class="settings-hint">Obsidianで開くときに使うVault名を入力してください。</div>
        </div>
        <div class="settings-row">
          <div class="settings-label">Obsidian サブフォルダ</div>
          <input id="settings-subdir" class="settings-input" type="text" placeholder="例: 【業務】/勤怠">
          <div class="settings-hint">VaultのどのフォルダにMDファイルを開くかのパス。</div>
        </div>
        <hr style="border:none;border-top:1px solid var(--border-soft);margin:4px 0;">
        <div class="settings-row">
          <div class="settings-label">🏢 jinjer 打刻URL</div>
          <input id="settings-jinjer-url" class="settings-input" type="url" placeholder="https://kintai.jinjer.biz/staffs/top">
          <div class="settings-hint">ハブの「jinjer打刻」ボタンの遷移先URL。会社によっては異なるドメインの場合があります。</div>
        </div>
        <div class="settings-row">
          <div class="settings-label">🏢 jinjer 会社コード</div>
          <input id="settings-jinjer-company" class="settings-input" type="text" placeholder="例: 15733" autocomplete="off">
        </div>
        <div class="settings-row">
          <div class="settings-label">📧 jinjer メール / 社員コード</div>
          <input id="settings-jinjer-email" class="settings-input" type="text" placeholder="メールアドレス or 社員コード" autocomplete="off">
        </div>
        <div class="settings-row">
          <div class="settings-label">🔑 jinjer パスワード</div>
          <input id="settings-jinjer-pass" class="settings-input" type="password" placeholder="パスワード" autocomplete="new-password">
          <div class="settings-hint">Tailscale経由の自動同期に使います。端末内にのみ保存されます。</div>
        </div>
        <div class="settings-row">
          <div class="settings-label">📅 全期間同期の開始月</div>
          <input id="settings-jinjer-start-month" class="settings-input" type="month" placeholder="例: 2025-10">
          <div class="settings-hint">「全期間一括同期」ボタンで使う開始月。例: 2025-10（入社月など）</div>
        </div>
        <div class="settings-row">
          <div class="settings-label">📍 天気の取得場所</div>
          <select id="settings-city" class="settings-input">
            <option value="">📍 GPS 自動取得（推奨）</option>
            <optgroup label="🇯🇵 日本">
              <option value="Tokyo">東京</option>
              <option value="Yokohama">横浜</option>
              <option value="Osaka">大阪</option>
              <option value="Kyoto">京都</option>
              <option value="Kobe">神戸</option>
              <option value="Nagoya">名古屋</option>
              <option value="Sapporo">札幌</option>
              <option value="Sendai">仙台</option>
              <option value="Hiroshima">広島</option>
              <option value="Fukuoka">福岡</option>
              <option value="Naha">那覇（沖縄）</option>
            </optgroup>
            <optgroup label="🇰🇷 韓国・🇨🇳 中国">
              <option value="Seoul">ソウル</option>
              <option value="Busan">釜山</option>
              <option value="Beijing">北京</option>
              <option value="Shanghai">上海</option>
              <option value="Shenzhen">深セン</option>
              <option value="Chengdu">成都</option>
            </optgroup>
            <optgroup label="🇹🇼🇭🇰 台湾・香港">
              <option value="Taipei">台北</option>
              <option value="Hong Kong">香港</option>
            </optgroup>
            <optgroup label="🌏 東南アジア">
              <option value="Bangkok">バンコク</option>
              <option value="Singapore">シンガポール</option>
              <option value="Kuala Lumpur">クアラルンプール</option>
              <option value="Ho Chi Minh City">ホーチミン</option>
              <option value="Hanoi">ハノイ</option>
              <option value="Jakarta">ジャカルタ</option>
              <option value="Manila">マニラ</option>
              <option value="Yangon">ヤンゴン</option>
            </optgroup>
            <optgroup label="🇮🇳 南アジア・🇦🇪 中東">
              <option value="Mumbai">ムンバイ</option>
              <option value="Delhi">デリー</option>
              <option value="Dubai">ドバイ</option>
              <option value="Riyadh">リヤド</option>
            </optgroup>
            <optgroup label="🇦🇺 オセアニア">
              <option value="Sydney">シドニー</option>
              <option value="Melbourne">メルボルン</option>
              <option value="Brisbane">ブリスベン</option>
              <option value="Auckland">オークランド</option>
            </optgroup>
            <optgroup label="🇬🇧🇫🇷 ヨーロッパ">
              <option value="London">ロンドン</option>
              <option value="Paris">パリ</option>
              <option value="Berlin">ベルリン</option>
              <option value="Rome">ローマ</option>
              <option value="Madrid">マドリード</option>
              <option value="Amsterdam">アムステルダム</option>
              <option value="Zurich">チューリッヒ</option>
              <option value="Stockholm">ストックホルム</option>
              <option value="Vienna">ウィーン</option>
              <option value="Warsaw">ワルシャワ</option>
              <option value="Moscow">モスクワ</option>
            </optgroup>
            <optgroup label="🇺🇸🇨🇦 北米">
              <option value="New York">ニューヨーク</option>
              <option value="Los Angeles">ロサンゼルス</option>
              <option value="Chicago">シカゴ</option>
              <option value="San Francisco">サンフランシスコ</option>
              <option value="Seattle">シアトル</option>
              <option value="Miami">マイアミ</option>
              <option value="Toronto">トロント</option>
              <option value="Vancouver">バンクーバー</option>
            </optgroup>
            <optgroup label="🇧🇷 中南米">
              <option value="Mexico City">メキシコシティ</option>
              <option value="São Paulo">サンパウロ</option>
              <option value="Buenos Aires">ブエノスアイレス</option>
            </optgroup>
            <optgroup label="🌍 アフリカ">
              <option value="Cairo">カイロ</option>
              <option value="Lagos">ラゴス</option>
              <option value="Nairobi">ナイロビ</option>
            </optgroup>
          </select>
          <div class="settings-hint">天気予報に使う場所。GPS自動取得なら空欄のまま（ブラウザの位置情報許可が必要）。</div>
        </div>
        <div class="settings-row">
          <div class="settings-label">👤 性別（Amazon検索最適化）</div>
          <select id="settings-style-gender" class="settings-input">
            <option value="メンズ">メンズ</option>
            <option value="レディース">レディース</option>
            <option value="">指定なし</option>
          </select>
        </div>
        <div class="settings-row">
          <div class="settings-label">👔 ファッションスタイル</div>
          <select id="settings-style-type" class="settings-input">
            <option value="casual">カジュアル</option>
            <option value="business">ビジネス / オフィス</option>
            <option value="street">ストリート</option>
            <option value="sports">スポーティ</option>
            <option value="formal">フォーマル</option>
            <option value="outdoor">アウトドア</option>
          </select>
        </div>
        <div class="settings-row">
          <div class="settings-label">🎨 好みのカラー系統</div>
          <select id="settings-style-color" class="settings-input">
            <option value="basic">ベーシック（白・黒・グレー）</option>
            <option value="earth">アース系（ベージュ・ブラウン）</option>
            <option value="dark">ダーク系（ネイビー・黒）</option>
            <option value="bright">ビビッド（カラフル）</option>
            <option value="pastel">パステル（淡い色）</option>
          </select>
          <div class="settings-hint">スタイルと色の好みを設定すると、服装提案が最適化されます。</div>
        </div>
        <hr style="border:none;border-top:1px solid var(--border-soft);margin:4px 0;">
        <div class="settings-row">
          <div class="settings-label">🌐 外部 HTTPS URL（iPhone 接続用）</div>
          <div style="display:flex;gap:6px;align-items:center;">
            <input type="url" id="settings-ext-url" class="settings-input" placeholder="例: https://macbook.tailnet.ts.net" autocomplete="off" style="flex:1;margin:0;">
            <button id="settings-ext-url-detect" class="btn-secondary" style="font-size:11px;white-space:nowrap;padding:6px 10px;">🔍 自動検出</button>
          </div>
          <div class="settings-hint" style="margin-top:4px;">
            iPhoneから jinjer同期・報告書 に接続するためのHTTPS URL。<br>
            <strong>Tailscale Serve</strong>: Mac で
            <code style="background:var(--bg-page);padding:1px 5px;border-radius:4px;font-size:11px;">tailscale serve --bg 8899</code>
            を実行 → 自動検出ボタンで取得。iPhone に Tailscale アプリが必要。<br>
            <strong>Cloudflare Tunnel</strong>（推奨・iPhone何も不要）: サーバー起動時に自動でトンネルを開始します。
          </div>
        </div>

        <!-- Cloudflare Tunnel 状態カード -->
        <div class="settings-row" id="cf-tunnel-status-row">
          <div class="settings-label">☁️ Cloudflare Tunnel（自動）</div>
          <div id="cf-tunnel-status" style="font-size:12px;padding:8px;background:var(--bg-page);border-radius:10px;border:1px solid var(--border-soft);">
            <div id="cf-tunnel-url-text" style="color:var(--text-muted);">確認中...</div>
            <div id="cf-tunnel-qr-wrap" style="display:none;margin-top:8px;text-align:center;">
              <canvas id="cf-tunnel-qr" width="160" height="160" style="border-radius:8px;background:#fff;padding:6px;"></canvas>
              <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">iPhoneのカメラでスキャン → URLが開く</div>
            </div>
            <div style="display:flex;gap:6px;margin-top:6px;">
              <button id="cf-tunnel-copy-btn" class="btn-secondary" style="font-size:11px;padding:4px 10px;display:none;">📋 URLコピー</button>
              <button id="cf-tunnel-use-btn" class="btn-secondary" style="font-size:11px;padding:4px 10px;display:none;">✓ 外部URLに設定</button>
              <button id="cf-tunnel-refresh-btn" class="btn-secondary" style="font-size:11px;padding:4px 10px;">🔄 更新</button>
            </div>
          </div>
        </div>
        <div class="settings-row">
          <div class="settings-label">🔒 Tailscale MacBook IP</div>
          <input type="text" id="settings-ts-mac" class="settings-input" placeholder="例: 100.x.x.x" autocomplete="off" inputmode="decimal">
        </div>
        <div class="settings-row">
          <div class="settings-label">📱 Tailscale iPhone IP</div>
          <input type="text" id="settings-ts-iphone" class="settings-input" placeholder="例: 100.x.x.x" autocomplete="off" inputmode="decimal">
        </div>
        <div class="settings-row">
          <div class="settings-label">👤 SSH ユーザー名</div>
          <input type="text" id="settings-ts-user" class="settings-input" placeholder="例: your_username" autocomplete="off">
          <div class="settings-hint">設定するとハブにTailscale VPNカードが表示され、iPhoneからSSH接続できます。</div>
        </div>
        <hr style="border:none;border-top:1px solid var(--border-soft);margin:4px 0;">
        <div class="settings-row">
          <div class="settings-label">💼 スキルタグ（案件フィルター）</div>
          <input id="settings-job-skills" class="settings-input" type="text"
            placeholder="例: Python,JavaScript,React" autocomplete="off">
          <div class="settings-hint">カンマ区切りで入力。案件タブでのキーワードマッチングに使います。</div>
        </div>
        <div class="settings-row">
          <div class="settings-label">📂 Crowdworks カテゴリ</div>
          <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:4px;">
            <label style="display:flex;align-items:center;gap:4px;font-size:12px;"><input type="checkbox" id="job-cat-1" value="1"> システム開発</label>
            <label style="display:flex;align-items:center;gap:4px;font-size:12px;"><input type="checkbox" id="job-cat-2" value="2"> Web制作</label>
            <label style="display:flex;align-items:center;gap:4px;font-size:12px;"><input type="checkbox" id="job-cat-3" value="3"> スマホアプリ</label>
            <label style="display:flex;align-items:center;gap:4px;font-size:12px;"><input type="checkbox" id="job-cat-7" value="7"> ECサイト</label>
            <label style="display:flex;align-items:center;gap:4px;font-size:12px;"><input type="checkbox" id="job-cat-9" value="9"> データ入力</label>
          </div>
        </div>
        <div class="settings-row">
          <div class="settings-label">🌐 対象プラットフォーム</div>
          <div style="display:flex;gap:16px;margin-top:4px;">
            <label style="display:flex;align-items:center;gap:4px;font-size:12px;"><input type="checkbox" id="job-platform-crowdworks" value="crowdworks"> Crowdworks</label>
            <label style="display:flex;align-items:center;gap:4px;font-size:12px;"><input type="checkbox" id="job-platform-lancers" value="lancers"> Lancers</label>
          </div>
        </div>
        <hr style="border:none;border-top:1px solid var(--border-soft);margin:4px 0;">
        <div class="settings-row">
          <div class="settings-label">🔐 セキュリティPIN</div>
          <div class="settings-hint" id="pin-status-hint" style="margin-bottom:6px;"></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn-secondary" id="btn-set-pin" style="flex:1;">PINを設定/変更</button>
            <button class="btn-secondary" id="btn-clear-pin" style="flex:1;color:#c62828;display:none;">PINを解除</button>
          </div>
          <div class="settings-hint" style="margin-top:6px;">
            危険な操作（全データ消去など）にPINロックをかけます。4〜6桁の数字。
          </div>
        </div>
      </div>
      <div style="padding:0 14px 6px;">
        <button id="settings-restore-server" class="btn-secondary" style="width:100%;font-size:12px;padding:10px;">
          ☁️ サーバーブリッジからデータを手動復元（別端末・別URLからの移行）
        </button>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="settings-cancel">キャンセル</button>
        <button class="btn-primary" id="settings-save">保存</button>
      </div>
    </div>
  </div>

  <!-- Task modal -->
  <div class="modal-backdrop" id="task-modal">
    <div class="modal-sheet" style="max-height:85vh;overflow:hidden;display:flex;flex-direction:column;">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div>📋 タスク</div>
        <div class="modal-close" id="task-modal-close">×</div>
      </div>
      <div class="task-add-form">
        <input id="task-title-input" class="task-add-input" type="text" placeholder="タスク名を入力">
        <textarea id="task-memo-input" class="task-add-input task-add-textarea" placeholder="メモ（任意）"></textarea>
        <button class="task-add-submit" id="task-add-btn">＋ 追加</button>
      </div>
      <div id="task-list-container" style="overflow-y:auto;flex:1;padding-bottom:16px;"></div>
    </div>
  </div>

  <!-- Emergency recovery modal -->
  <div class="modal-backdrop" id="emergency-modal">
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div style="color:#c62828;">🚨 緊急復旧</div>
        <div class="modal-close" id="emergency-modal-close">×</div>
      </div>
      <div class="emergency-modal-body">
        <div class="emergency-section-title">クイック復旧</div>
        <button class="emergency-btn emergency-btn-safe" id="em-sw-reload">🔄 Service Worker を強制更新</button>
        <button class="emergency-btn emergency-btn-warn" id="em-cache-clear">🗂 キャッシュ・SWをクリア（データ保持）</button>
        <button class="emergency-btn emergency-btn-warn" id="em-snap-restore">📦 自動スナップショットから復元</button>
        <button class="emergency-btn emergency-btn-safe" id="em-bridge-restore">☁️ サーバーブリッジから復元（別端末/別URL移行）</button>

        <!-- iOS のみ: Safari ウェブサイトデータへのショートカット -->
        <button class="emergency-btn emergency-btn-safe" id="em-safari-settings" style="display:none;">📱 Safari ウェブサイトデータを開く</button>

        <div class="emergency-section-title">完全リセット</div>
        <button class="emergency-btn emergency-btn-danger" id="em-full-reset">🗑 全データ消去してリセット</button>
        <a href="./recover.html" class="emergency-btn emergency-btn-link" style="text-decoration:none;display:block;">🔗 recover.html を開く（詳細）</a>

        <div class="emergency-section-title">診断情報</div>
        <div class="emergency-diag" id="em-diag">読み込み中...</div>
      </div>
    </div>
  </div>

  <!-- FAB Group (calendar タブのみ表示・折り畳み式) -->
  <div class="fab-group" id="fab-group">
    <button class="fab-group-toggle" id="fab-toggle" aria-label="アクションメニューを開く">＋</button>
    <div class="fab-group-menu" id="fab-group-menu">
      <button class="fab-recover" id="fab-recover" title="緊急復旧">🚨</button>
      <button class="fab-task" id="fab-task">📋</button>
      <button class="fab-today" id="fab-today">
        <span class="fab-day" id="fab-day">--</span>
        <span class="fab-label">今日</span>
      </button>
    </div>
  </div>

  <!-- Bottom Tab Navigation -->
  <!-- ===== TAB: 従業員管理 ===== -->
  <div id="page-employee" class="tab-page">
    <button class="emp-add-btn" id="emp-add-btn">＋ 従業員を追加</button>
    <div class="emp-list" id="emp-list"></div>
  </div>

  <!-- ===== TAB: 市場価値 ===== -->
  <div id="page-market" class="tab-page">
    <div class="card" style="margin-bottom:10px;">
      <div class="card-title">📈 あなたの市場価値</div>
      <div class="market-score-ring" id="market-ring">
        <svg width="120" height="120" viewBox="0 0 120 120">
          <circle cx="60" cy="60" r="50" fill="none" stroke="var(--border-color)" stroke-width="10"/>
          <circle id="market-ring-arc" cx="60" cy="60" r="50" fill="none"
            stroke="url(#mgrad)" stroke-width="10" stroke-linecap="round"
            stroke-dasharray="314" stroke-dashoffset="314"/>
          <defs>
            <linearGradient id="mgrad" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="var(--accent-blue)"/>
              <stop offset="100%" stop-color="var(--accent-purple)"/>
            </linearGradient>
          </defs>
        </svg>
        <div class="market-score-ring-inner">
          <div class="market-score-num" id="market-score-num">--</div>
          <div class="market-score-label">スコア</div>
        </div>
      </div>
      <div class="market-income-estimate" id="market-income-box" style="display:none;">
        <div style="font-size:12px;color:var(--text-muted);margin-bottom:4px;">推定年収レンジ</div>
        <div class="market-income-num" id="market-income-low">--</div>
        <span class="market-income-unit"> 〜 </span>
        <span class="market-income-num" id="market-income-high">--</span>
        <span class="market-income-unit">万円/年</span>
      </div>
    </div>

    <div class="card" style="margin-bottom:10px;">
      <div class="card-title">⏱ 経験年数</div>
      <div class="market-slider-row">
        <span class="market-slider-label">IT 経験</span>
        <input type="range" class="market-slider" id="mkt-exp-it" min="0" max="20" value="3">
        <span class="market-slider-val" id="mkt-exp-it-val">3年</span>
      </div>
      <div class="market-slider-row">
        <span class="market-slider-label">現在の職種</span>
        <input type="range" class="market-slider" id="mkt-exp-role" min="0" max="20" value="1">
        <span class="market-slider-val" id="mkt-exp-role-val">1年</span>
      </div>
      <div class="market-slider-row">
        <span class="market-slider-label">マネジメント</span>
        <input type="range" class="market-slider" id="mkt-exp-mgmt" min="0" max="10" value="0">
        <span class="market-slider-val" id="mkt-exp-mgmt-val">0年</span>
      </div>
    </div>

    <div class="card" style="margin-bottom:10px;">
      <div class="card-title">💻 スキルセット（複数選択可）</div>
      <div class="market-section-title">プログラミング言語</div>
      <div class="market-skill-grid" id="mkt-skills-lang"></div>
      <div class="market-section-title">フレームワーク / ライブラリ</div>
      <div class="market-skill-grid" id="mkt-skills-fw"></div>
      <div class="market-section-title">クラウド / インフラ</div>
      <div class="market-skill-grid" id="mkt-skills-cloud"></div>
      <div class="market-section-title">資格</div>
      <div class="market-skill-grid" id="mkt-skills-cert"></div>
    </div>

    <div class="card" style="margin-bottom:10px;">
      <div class="card-title">📊 スコア内訳</div>
      <div class="market-breakdown" id="mkt-breakdown"></div>
    </div>

    <div class="card">
      <div class="card-title">💡 市場価値向上のアドバイス</div>
      <div class="market-reco" id="mkt-reco"></div>
    </div>
  </div>

  <!-- ===== TAB: DB管理 ===== -->
  <div id="page-db" class="tab-page">
    <div class="card" style="margin-bottom:10px;">
      <div class="card-title">🗄 DB管理・データ確認</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;">
        <input id="db-query-input" placeholder="キー名 or 値で絞り込み（例: kintai）"
          style="flex:1;min-width:120px;padding:6px 10px;border:1px solid var(--border-soft);border-radius:8px;font-size:12px;font-family:inherit;">
        <button id="db-query-btn" class="btn-secondary" style="font-size:12px;padding:6px 12px;">🔍 絞り込み</button>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;">
        <button id="db-restore-idb-btn" class="btn-secondary" style="font-size:12px;flex:1;">♻️ IDB→LS 復元</button>
        <button id="db-backup-now-btn" class="btn-secondary" style="font-size:12px;flex:1;">💾 今すぐバックアップ</button>
      </div>
      <div id="db-table-area" style="overflow-x:auto;"></div>
    </div>
    <div class="card" style="margin-bottom:10px;">
      <div class="card-title">📦 IDB スナップショット</div>
      <div id="db-idb-summary" style="font-size:12px;color:var(--text-sub);margin-bottom:10px;"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button id="db-idb-restore-kintai" class="btn-secondary" style="font-size:12px;flex:1;">📅 勤怠データをIDBから復元</button>
        <button id="db-idb-restore-tasks" class="btn-secondary" style="font-size:12px;flex:1;">✅ タスクをIDBから復元</button>
      </div>
    </div>
    <div class="card" style="margin-bottom:10px;">
      <div class="card-title">☁️ サーバーブリッジ</div>
      <div id="db-bridge-summary" style="font-size:12px;color:var(--text-sub);margin-bottom:10px;"></div>
      <button id="db-bridge-restore" class="btn-primary" style="font-size:12px;width:100%;">☁️ ブリッジからすべて復元</button>
    </div>
    <div class="card">
      <div class="card-title">🍎 iCloud Drive バックアップ</div>
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;padding:6px 10px;background:rgba(96,165,250,0.06);border-radius:6px;">
        📍 <strong>保存先:</strong> iCloud Drive → :root → attendance/<br>
        🔄 勤怠データ保存時に自動バックアップ。Mac/iPhone 両方からアクセス可能。
      </div>
      <div id="db-icloud-summary" style="font-size:12px;color:var(--text-sub);margin-bottom:10px;">読み込み中...</div>
      <div id="db-icloud-backups" style="max-height:160px;overflow-y:auto;margin-bottom:10px;"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button id="db-icloud-backup-now-btn" class="btn-secondary" style="font-size:12px;flex:1;">☁️ 今すぐバックアップ</button>
        <button id="db-icloud-restore-btn" class="btn-secondary" style="font-size:12px;flex:1;">♻️ 最新から復元</button>
      </div>
    </div>
  </div>

  <!-- ===== TAB: 仕様 / 設計書 ===== -->
  <div id="page-spec" class="tab-page">
    <!-- サブナビゲーション (横スクロール) -->
    <div class="spec-subnav" id="spec-subnav">
      <button class="spec-sub-btn active" data-pane="arch">🏗 構成図</button>
      <button class="spec-sub-btn" data-pane="er">🗃 ER図</button>
      <button class="spec-sub-btn" data-pane="seq">🔄 フロー</button>
      <button class="spec-sub-btn" data-pane="ha">🔒 HA設計</button>
      <button class="spec-sub-btn" data-pane="basic">📋 基本設計</button>
      <button class="spec-sub-btn" data-pane="detail">📐 詳細設計</button>
      <button class="spec-sub-btn" data-pane="api">🔌 API仕様</button>
      <button class="spec-sub-btn" data-pane="struct">📂 構成ツリー</button>
      <button class="spec-sub-btn" data-pane="files">📄 ファイル</button>
    </div>

    <!-- 🏗 構成図 -->
    <div class="spec-pane" id="spec-pane-arch">
      <div class="card">
        <div class="card-title">🏗 システム構成図</div>
        <p style="font-size:11px;color:var(--text-muted);margin:0 0 10px;">kintai PWA の全体コンポーネントと通信経路</p>
        <div class="mermaid-wrap" id="spec-diagram-arch">
          <div style="color:var(--text-muted);font-size:12px;padding:20px;">⏳ 描画中...</div>
        </div>
      </div>
    </div>

    <!-- 🗃 ER図 -->
    <div class="spec-pane" id="spec-pane-er" style="display:none;">
      <div class="card">
        <div class="card-title">🗃 ER図（データ構造）</div>
        <p style="font-size:11px;color:var(--text-muted);margin:0 0 10px;">IndexedDB / localStorage の主要エンティティと関連</p>
        <div class="mermaid-wrap" id="spec-diagram-er">
          <div style="color:var(--text-muted);font-size:12px;padding:20px;">⏳ 描画中...</div>
        </div>
      </div>
    </div>

    <!-- 🔄 シーケンス図 -->
    <div class="spec-pane" id="spec-pane-seq" style="display:none;">
      <div class="card">
        <div class="card-title">🔄 データフロー図（シーケンス）</div>
        <p style="font-size:11px;color:var(--text-muted);margin:0 0 10px;">起動・jinjer同期・報告書出力の処理フロー</p>
        <div class="mermaid-wrap" id="spec-diagram-seq">
          <div style="color:var(--text-muted);font-size:12px;padding:20px;">⏳ 描画中...</div>
        </div>
      </div>
    </div>

    <!-- 🔒 HA設計 -->
    <div class="spec-pane" id="spec-pane-ha" style="display:none;">
      <div class="card">
        <div class="card-title">🔒 HA設計（高可用性アーキテクチャ）</div>
        <p style="font-size:11px;color:var(--text-muted);margin:0 0 10px;">冗長化・障害検知・自動復旧の仕組み</p>
        <div class="mermaid-wrap" id="spec-diagram-ha">
          <div style="color:var(--text-muted);font-size:12px;padding:20px;">⏳ 描画中...</div>
        </div>
      </div>
    </div>

    <!-- 📋 基本設計書 -->
    <div class="spec-pane" id="spec-pane-basic" style="display:none;">
      <div class="card">
        <div class="card-title">📋 基本設計書</div>
        <div id="spec-basic-content"></div>
      </div>
    </div>

    <!-- 📐 詳細設計書 -->
    <div class="spec-pane" id="spec-pane-detail" style="display:none;">
      <div class="card">
        <div class="card-title">📐 詳細設計書</div>
        <div id="spec-detail-content"></div>
      </div>
    </div>

    <!-- 🔌 API仕様 -->
    <div class="spec-pane" id="spec-pane-api" style="display:none;">
      <div class="card">
        <div class="card-title">🔌 外部仕様書 — API エンドポイント</div>
        <div id="spec-api"></div>
      </div>
    </div>

    <!-- 📂 構成ツリー -->
    <div class="spec-pane" id="spec-pane-struct" style="display:none;">
      <div class="card">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
          <div class="card-title" style="margin-bottom:0;flex:1;">📂 ディレクトリ構成</div>
          <button id="spec-refresh-btn" class="btn-secondary" style="font-size:11px;padding:4px 10px;">🔄</button>
        </div>
        <pre id="spec-structure" style="font-size:10px;overflow:auto;max-height:55vh;background:#111827;color:#a3e635;border-radius:8px;padding:10px;margin:0;line-height:1.5;"></pre>
      </div>
    </div>

    <!-- 📄 ファイル閲覧 -->
    <div class="spec-pane" id="spec-pane-files" style="display:none;">
      <div class="card" id="spec-file-card">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
          <div class="card-title" style="margin-bottom:0;flex:1;">📄 ファイル閲覧</div>
          <button id="spec-file-refresh-btn" class="btn-secondary" style="font-size:11px;padding:4px 10px;">🔄</button>
        </div>
        <select id="spec-file-select" style="width:100%;padding:6px 8px;border:1px solid var(--border-soft);border-radius:8px;font-size:12px;margin-bottom:8px;background:var(--bg-card);font-family:inherit;">
          <option value="">── ファイルを選択 ──</option>
        </select>
        <div id="spec-file-status" style="font-size:11px;color:var(--text-muted);margin-bottom:6px;display:none;"></div>
        <pre id="spec-file-content" style="font-size:10px;overflow:auto;max-height:55vh;background:#111827;color:#a3e635;border-radius:8px;padding:10px;margin:0;line-height:1.5;white-space:pre-wrap;word-break:break-all;">ファイルを選択すると内容が表示されます</pre>
      </div>
    </div>
  </div>

  <!-- パフォーマンスエンジニアリングタブ -->
  <div id="page-perf" class="tab-page">

    <!-- スコアカード -->
    <div class="card" style="margin-bottom:10px;">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:12px;">
        <div class="card-title" style="margin-bottom:0;">⚡ パフォーマンススコア</div>
        <button id="perf-measure-btn" class="btn-primary" style="font-size:12px;padding:5px 14px;">📊 計測する</button>
      </div>
      <div style="display:flex;align-items:center;gap:16px;">
        <div id="perf-score-ring" style="position:relative;width:80px;height:80px;flex-shrink:0;">
          <canvas id="perf-score-canvas" width="80" height="80"></canvas>
          <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
            <span id="perf-score-num" style="font-size:22px;font-weight:800;color:#a3e635;">--</span>
            <span style="font-size:9px;color:var(--text-muted);">/100</span>
          </div>
        </div>
        <div style="flex:1;">
          <div id="perf-score-label" style="font-size:15px;font-weight:700;">「計測する」を押してください</div>
          <div id="perf-score-delta" style="font-size:12px;color:var(--text-muted);margin-top:3px;"></div>
          <div id="perf-score-time"  style="font-size:10px;color:var(--text-muted);margin-top:2px;"></div>
        </div>
      </div>
      <div style="margin-top:10px;padding:8px 10px;background:rgba(163,230,53,0.05);border-radius:8px;border-left:3px solid #a3e635;">
        <div style="font-size:11px;color:var(--text-muted);line-height:1.7;">
          <strong style="color:var(--text-primary);">💡 パフォーマンススコアとは？</strong><br>
          ページロード速度・メモリ使用量・UI描画fps・データ層の応答性を総合した <strong>0〜100点</strong> の指標です。<br>
          🏆 90〜100点 = 優秀　✅ 70〜89点 = 良好　⚠️ 50〜69点 = 要改善　🔴 50点未満 = 問題あり
        </div>
      </div>
    </div>

    <!-- システム性能指標 -->
    <div class="card" style="margin-bottom:10px;">
      <div class="card-title">🖥 システム性能指標</div>
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px;padding:6px 10px;background:rgba(96,165,250,0.06);border-radius:6px;">
        📐 <strong>計測方法:</strong> ブラウザ標準の Web Performance API (Navigation Timing・memory・RAF) から取得。
        各指標の横バーが目標値に対する達成率を示します。計測するたびに履歴に追記されます。
      </div>
      <div id="perf-metrics-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;"></div>
    </div>

    <!-- AI速度ベンチマーク -->
    <div class="card" style="margin-bottom:10px;">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:8px;">
        <div class="card-title" style="margin-bottom:0;">🤖 AI速度ベンチマーク</div>
        <button id="perf-ai-bench-btn" class="btn-secondary" style="font-size:12px;padding:4px 12px;">▶ 実行</button>
      </div>
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px;padding:6px 10px;background:rgba(251,191,36,0.06);border-radius:6px;">
        📐 <strong>計測方法:</strong> 設定済み各AIモデルに最小プロンプトを送信し、<em>応答時間(ms)</em>・<em>スループット(文字/秒)</em>を計測します。<br>
        ⚠️ <strong>API料金が発生します</strong>（1回あたり数円以下）。AIタブでAPIキーを設定後に使用してください。
      </div>
      <div id="perf-ai-bench-result" style="font-size:12px;"></div>
    </div>

    <!-- 改善提案 -->
    <div class="card" style="margin-bottom:10px;">
      <div class="card-title">💡 改善提案 — 何をどう改善すべきか</div>
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;padding:6px 10px;background:rgba(96,165,250,0.06);border-radius:6px;">
        📐 現在のシステム状態を自動分析した改善提案です。各提案に <strong>予想改善効果</strong> と <strong>具体的な実施方法</strong> を記載しています。
        「計測する」を押すと最新状態で更新されます。
      </div>
      <div id="perf-suggestions"><div style="color:var(--text-muted);font-size:12px;text-align:center;padding:12px;">計測後に表示されます</div></div>
    </div>

    <!-- 改善履歴 -->
    <div class="card" style="margin-bottom:10px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <div class="card-title" style="margin-bottom:0;">📈 計測履歴 — 改善の可視化</div>
        <button id="perf-history-clear" style="background:none;border:1px solid var(--border-soft);border-radius:6px;font-size:11px;padding:3px 8px;color:var(--text-muted);cursor:pointer;">🗑</button>
      </div>
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">
        計測するたびに記録されます（最大30件）。スコアの変化・ΔをみてPDCAを回してください。
      </div>
      <div id="perf-history-list"></div>
    </div>

    <!-- パフォーマンスエンジニア学習ロードマップ -->
    <div class="card">
      <div class="card-title">🎓 パフォーマンスエンジニア 学習ロードマップ</div>
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px;padding:6px 10px;background:rgba(163,230,53,0.05);border-radius:6px;">
        AIが普及する時代に不可欠な「AI高速化」を含むパフォーマンスエンジニアリングのキャリアパスです。
        各フェーズに <strong>習得スキル</strong> と <strong>推奨ツール</strong> を記載しています。
      </div>
      <div id="perf-learning-map"></div>
    </div>

  </div>

  <!-- ログタブ -->
  <div id="page-logs" class="tab-page">
    <!-- 統計サマリーカード -->
    <div class="card" style="margin-bottom:10px;">
      <div class="card-title" style="margin-bottom:8px;">📊 ログ統計（直近7日）</div>
      <div id="logs-stats-bar" style="display:flex;gap:10px;flex-wrap:wrap;font-size:12px;margin-bottom:8px;"></div>
      <canvas id="logs-mini-chart" height="36" style="width:100%;border-radius:6px;"></canvas>
    </div>
    <!-- メインログカード -->
    <div class="card">
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:10px;">
        <div class="card-title" style="margin-bottom:0;flex:1;">📋 SysLog ビュー</div>
        <button id="logs-refresh-btn" class="btn-secondary" style="font-size:11px;padding:4px 10px;">🔄</button>
        <button id="logs-export-btn" class="btn-secondary" style="font-size:11px;padding:4px 10px;">📥 エクスポート</button>
      </div>
      <!-- ソース + 日付ナビ -->
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;align-items:center;">
        <button class="logs-src-btn active" data-src="app"      style="font-size:11px;padding:3px 10px;border-radius:20px;border:1px solid var(--border-soft);background:var(--bg-card-solid);font-weight:700;">📱 アプリ</button>
        <button class="logs-src-btn"        data-src="server"   style="font-size:11px;padding:3px 10px;border-radius:20px;border:1px solid var(--border-soft);background:none;">🖥 サーバー</button>
        <button class="logs-src-btn"        data-src="watchdog" style="font-size:11px;padding:3px 10px;border-radius:20px;border:1px solid var(--border-soft);background:none;">👁 Watchdog</button>
        <span style="margin-left:auto;display:flex;align-items:center;gap:4px;">
          <button id="logs-date-prev" class="btn-secondary" style="font-size:11px;padding:2px 8px;">◀</button>
          <input id="logs-date-input" type="date" style="font-size:11px;padding:2px 6px;border:1px solid var(--border-soft);border-radius:6px;background:var(--bg-card);color:var(--text-primary);">
          <button id="logs-date-next" class="btn-secondary" style="font-size:11px;padding:2px 8px;">▶</button>
        </span>
      </div>
      <!-- レベルフィルター -->
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;">
        <button class="logs-lvl-btn active" data-level="all"   style="font-size:11px;padding:3px 10px;border-radius:20px;border:1px solid var(--border-soft);background:var(--accent);color:#000;">ALL</button>
        <button class="logs-lvl-btn" data-level="fatal" style="font-size:11px;padding:3px 10px;border-radius:20px;border:1px solid #c62828;color:#c62828;background:none;">💀 FATAL</button>
        <button class="logs-lvl-btn" data-level="error" style="font-size:11px;padding:3px 10px;border-radius:20px;border:1px solid #e53935;color:#e53935;background:none;">🔴 ERROR</button>
        <button class="logs-lvl-btn" data-level="warn"  style="font-size:11px;padding:3px 10px;border-radius:20px;border:1px solid #e65100;color:#e65100;background:none;">🟡 WARN</button>
        <button class="logs-lvl-btn" data-level="info"  style="font-size:11px;padding:3px 10px;border-radius:20px;border:1px solid var(--border-soft);color:var(--text-muted);background:none;">🔵 INFO</button>
      </div>
      <!-- キーワード検索 -->
      <input id="logs-search-input" type="search" placeholder="🔍 キーワードで絞り込み..." style="width:100%;box-sizing:border-box;padding:6px 10px;border:1px solid var(--border-soft);border-radius:8px;font-size:11px;background:var(--bg-card);color:var(--text-primary);font-family:inherit;margin-bottom:8px;">
      <div id="logs-count" style="font-size:11px;color:var(--text-muted);margin-bottom:6px;"></div>
      <div id="logs-content" style="font-family:'SF Mono','Fira Code',monospace;font-size:11px;max-height:55vh;overflow-y:auto;border-radius:8px;background:#0d1117;padding:10px;"></div>
    </div>
  </div>

  <!-- ===== TAB: 業務AI ===== -->
  <div id="page-bizai" class="tab-page">
    <div class="card" style="margin-bottom:10px;">
      <div class="card-title">🗂 業務AI — IT以外の仕事を自動化</div>
      <p style="font-size:12px;color:var(--text-muted);margin:0 0 10px;">文書作成・メール・議事録・分析などをAIで効率化します</p>

      <!-- テンプレート選択 -->
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;" id="bizai-template-list">
        <button class="bizai-tpl-btn" data-tpl="email_reply">📧 メール返信</button>
        <button class="bizai-tpl-btn" data-tpl="minutes">📝 議事録要約</button>
        <button class="bizai-tpl-btn" data-tpl="report_weekly">📊 週報作成</button>
        <button class="bizai-tpl-btn" data-tpl="contract_check">📄 契約書チェック</button>
        <button class="bizai-tpl-btn" data-tpl="presentation">🎯 資料構成案</button>
        <button class="bizai-tpl-btn" data-tpl="schedule">🗓 日程調整文</button>
        <button class="bizai-tpl-btn" data-tpl="estimate">💰 見積もり作成</button>
        <button class="bizai-tpl-btn" data-tpl="complaint">🤝 クレーム対応</button>
        <button class="bizai-tpl-btn" data-tpl="free">✏️ フリー入力</button>
      </div>

      <!-- 入力欄 -->
      <div style="font-size:11px;font-weight:700;color:var(--text-muted);margin-bottom:4px;" id="bizai-input-label">内容を入力してください</div>
      <textarea id="bizai-input" rows="5"
        style="width:100%;box-sizing:border-box;padding:10px;border:1px solid var(--border-soft);border-radius:12px;font-size:13px;font-family:inherit;resize:vertical;background:var(--bg-card);color:var(--text-primary);"
        placeholder="例）受信したメールの内容をここに貼り付けてください..."></textarea>

      <!-- オプション行 -->
      <div style="display:flex;align-items:center;gap:10px;margin-top:8px;flex-wrap:wrap;">
        <label style="font-size:12px;color:var(--text-muted);display:flex;align-items:center;gap:4px;">
          文体:
          <select id="bizai-tone" style="font-size:12px;border-radius:8px;border:1px solid var(--border-soft);padding:3px 6px;background:var(--bg-card);color:var(--text-primary);">
            <option value="formal">丁寧語（ビジネス）</option>
            <option value="semi">やや丁寧</option>
            <option value="casual">カジュアル</option>
          </select>
        </label>
        <label style="font-size:12px;color:var(--text-muted);display:flex;align-items:center;gap:4px;">
          長さ:
          <select id="bizai-length" style="font-size:12px;border-radius:8px;border:1px solid var(--border-soft);padding:3px 6px;background:var(--bg-card);color:var(--text-primary);">
            <option value="short">簡潔（200字以内）</option>
            <option value="medium" selected>標準（400字程度）</option>
            <option value="long">詳細（800字以上）</option>
          </select>
        </label>
      </div>

      <button id="bizai-run-btn" class="btn-primary" style="width:100%;margin-top:10px;" disabled>
        🤖 AI生成
      </button>
    </div>

    <!-- 結果カード -->
    <div class="card" id="bizai-result-card" style="display:none;margin-bottom:10px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <div class="card-title" style="margin:0;">✨ 生成結果</div>
        <div style="display:flex;gap:6px;">
          <button id="bizai-copy-btn" class="btn-secondary" style="font-size:12px;padding:4px 10px;">📋 コピー</button>
          <button id="bizai-reset-btn" class="btn-secondary" style="font-size:12px;padding:4px 10px;">↩ リセット</button>
        </div>
      </div>
      <div id="bizai-result-text" style="font-size:13px;line-height:1.9;white-space:pre-wrap;word-break:break-all;background:rgba(79,141,253,0.04);border:1px solid var(--border-soft);border-radius:10px;padding:12px;max-height:50vh;overflow-y:auto;"></div>
    </div>

    <!-- 履歴カード -->
    <div class="card" id="bizai-history-card" style="margin-bottom:10px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <div class="card-title" style="margin:0;">🕐 生成履歴</div>
        <button id="bizai-history-clear" class="btn-secondary" style="font-size:11px;padding:3px 8px;">クリア</button>
      </div>
      <div id="bizai-history-list" style="font-size:12px;color:var(--text-muted);"></div>
    </div>
  </div>

  <!-- ===== TAB: Docker ===== -->
  <div id="page-docker" class="tab-page">
    <!-- コントロール行 -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:8px;">
      <div style="font-size:15px;font-weight:700;">🐳 Docker 管理</div>
      <div style="display:flex;gap:6px;">
        <button id="docker-create-btn" class="btn-primary" style="font-size:12px;padding:4px 10px;">⊕ 作成</button>
        <button id="docker-refresh-btn" class="btn-secondary" style="font-size:12px;padding:4px 10px;">🔄</button>
      </div>
    </div>

    <!-- ステータスバー -->
    <div id="docker-status-bar" style="font-size:11px;color:var(--text-muted);margin-bottom:8px;"></div>

    <!-- ビュー切り替え: containers / stats / images -->
    <div style="display:flex;gap:5px;margin-bottom:10px;">
      <button class="docker-view-btn active" data-view="containers"
        style="flex:1;padding:6px 4px;border-radius:10px;border:1px solid var(--border-soft);background:var(--bg-card-solid);font-size:12px;cursor:pointer;font-weight:700;">
        📦 コンテナ
      </button>
      <button class="docker-view-btn" data-view="stats"
        style="flex:1;padding:6px 4px;border-radius:10px;border:1px solid var(--border-soft);background:var(--bg-card);font-size:12px;cursor:pointer;">
        📊 統計
      </button>
      <button class="docker-view-btn" data-view="images"
        style="flex:1;padding:6px 4px;border-radius:10px;border:1px solid var(--border-soft);background:var(--bg-card);font-size:12px;cursor:pointer;">
        🖼 イメージ
      </button>
    </div>

    <!-- コンテナリスト -->
    <div id="docker-containers-view">
      <div id="docker-container-list" style="display:flex;flex-direction:column;gap:8px;"></div>
    </div>

    <!-- 統計ビュー -->
    <div id="docker-stats-view" style="display:none;">
      <div id="docker-stats-list" style="display:flex;flex-direction:column;gap:8px;"></div>
    </div>

    <!-- イメージリスト -->
    <div id="docker-images-view" style="display:none;">
      <div id="docker-image-list" style="display:flex;flex-direction:column;gap:8px;"></div>
    </div>

    <!-- ログモーダル -->
    <div class="modal-backdrop" id="docker-log-modal">
      <div class="modal-sheet" style="height:80dvh;display:flex;flex-direction:column;">
        <div class="modal-handle"></div>
        <div class="modal-header">
          <div class="modal-title" id="docker-log-title">📄 コンテナログ</div>
          <div style="display:flex;align-items:center;gap:8px;">
            <label style="font-size:11px;color:var(--text-muted);display:flex;align-items:center;gap:4px;cursor:pointer;">
              <input type="checkbox" id="docker-log-autorefresh" checked> 自動更新
            </label>
            <button class="modal-close" id="docker-log-close">✕</button>
          </div>
        </div>
        <pre id="docker-log-content"
          style="flex:1;overflow-y:auto;padding:12px 14px;font-size:11px;font-family:'Menlo','Consolas',monospace;background:#0d1117;color:#c9d1d9;margin:0;white-space:pre-wrap;word-break:break-all;line-height:1.6;"></pre>
      </div>
    </div>

    <!-- コンテナ作成モーダル -->
    <div class="modal-backdrop" id="docker-create-modal">
      <div class="modal-sheet">
        <div class="modal-handle"></div>
        <div class="modal-header">
          <div class="modal-title">⊕ コンテナ作成</div>
          <button class="modal-close" id="docker-create-close">✕</button>
        </div>
        <div style="padding:0 14px;overflow-y:auto;max-height:60dvh;">
          <!-- イメージ行 -->
          <div style="margin-bottom:10px;">
            <div style="font-size:11px;font-weight:700;color:var(--text-muted);margin-bottom:4px;">イメージ名 *</div>
            <div style="display:flex;gap:6px;">
              <input id="docker-new-image" placeholder="nginx:latest" list="docker-image-datalist"
                style="flex:1;padding:8px 10px;border:1px solid var(--border-soft);border-radius:10px;font-size:13px;background:var(--bg-card);color:var(--text-primary);">
              <button id="docker-pull-btn" class="btn-secondary" style="font-size:12px;padding:6px 10px;white-space:nowrap;">📥 Pull</button>
            </div>
            <datalist id="docker-image-datalist"></datalist>
            <div id="docker-pull-status" style="font-size:11px;color:var(--accent-blue);margin-top:4px;display:none;"></div>
          </div>
          <!-- コンテナ名 -->
          <div style="margin-bottom:10px;">
            <div style="font-size:11px;font-weight:700;color:var(--text-muted);margin-bottom:4px;">コンテナ名（省略可）</div>
            <input id="docker-new-name" placeholder="myapp"
              style="width:100%;box-sizing:border-box;padding:8px 10px;border:1px solid var(--border-soft);border-radius:10px;font-size:13px;background:var(--bg-card);color:var(--text-primary);">
          </div>
          <!-- ポートマッピング -->
          <div style="margin-bottom:10px;">
            <div style="font-size:11px;font-weight:700;color:var(--text-muted);margin-bottom:4px;">ポートマッピング（例: 8080:80, 443:443）</div>
            <input id="docker-new-ports" placeholder="8080:80"
              style="width:100%;box-sizing:border-box;padding:8px 10px;border:1px solid var(--border-soft);border-radius:10px;font-size:13px;background:var(--bg-card);color:var(--text-primary);">
          </div>
          <!-- 再起動ポリシー -->
          <div style="margin-bottom:10px;">
            <div style="font-size:11px;font-weight:700;color:var(--text-muted);margin-bottom:4px;">再起動ポリシー（HA推奨: always）</div>
            <select id="docker-new-restart"
              style="width:100%;padding:8px 10px;border:1px solid var(--border-soft);border-radius:10px;font-size:13px;background:var(--bg-card);color:var(--text-primary);">
              <option value="no">no — 自動再起動しない</option>
              <option value="always" selected>always — 常に再起動（HA推奨）</option>
              <option value="unless-stopped">unless-stopped — 手動停止以外は再起動</option>
              <option value="on-failure">on-failure — 異常終了時のみ再起動</option>
            </select>
          </div>
          <!-- 環境変数 -->
          <div style="margin-bottom:10px;">
            <div style="font-size:11px;font-weight:700;color:var(--text-muted);margin-bottom:4px;">環境変数（KEY=VALUE を改行区切り）</div>
            <textarea id="docker-new-env" rows="3" placeholder="PORT=3000&#10;NODE_ENV=production"
              style="width:100%;box-sizing:border-box;padding:8px 10px;border:1px solid var(--border-soft);border-radius:10px;font-size:12px;font-family:monospace;background:var(--bg-card);color:var(--text-primary);resize:vertical;"></textarea>
          </div>
        </div>
        <div style="padding:12px 14px;">
          <button id="docker-run-btn" class="btn-primary" style="width:100%;">▶ 起動</button>
        </div>
      </div>
    </div>
  </div>

  <nav class="bottom-tabs" id="bottom-tabs">
    <!-- タブボタンは JS (_initTabManager) で動的に生成されます -->
    <button class="tab-manage-btn" id="tab-manage-btn" title="タブ管理">
      <span style="font-size:18px;">⊕</span>管理
    </button>
  </nav>

  <!-- タブ管理モーダル -->
  <div class="modal-backdrop" id="tab-mgr-modal">
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div class="modal-title">⚙️ タブ管理</div>
        <button class="modal-close" id="tab-mgr-close">✕</button>
      </div>
      <div style="padding:0 14px;overflow-y:auto;max-height:52vh;">
        <p style="font-size:12px;color:var(--text-muted);margin-bottom:10px;">
          ☰ をドラッグして並び替え。右のトグルで表示/非表示。カスタムタブは 🗑 で削除。
        </p>
        <div id="tab-mgr-list"></div>
        <!-- FABショートカット設定 -->
        <div id="fab-mgr-section" style="margin-top:14px;padding-top:12px;border-top:1px solid var(--border-soft);">
          <p style="font-size:12px;font-weight:700;margin-bottom:4px;">⚡ FABショートカット（最大3つ）</p>
          <p style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">右下＋ボタンに追加するタブを選択できます</p>
          <div id="fab-mgr-list"></div>
        </div>
      </div>
      <!-- タブ追加フォーム -->
      <div id="tab-add-form" style="display:none;padding:10px 14px;border-top:1px solid var(--border-soft);">
        <div style="font-size:12px;font-weight:700;margin-bottom:8px;">＋ 新しいタブを追加</div>
        <div style="display:flex;gap:8px;margin-bottom:8px;">
          <input id="tab-add-icon" value="🔗" style="width:44px;font-size:18px;text-align:center;padding:4px;border:1px solid var(--border-soft);border-radius:8px;background:var(--bg-card);">
          <input id="tab-add-label" placeholder="タブ名" style="flex:1;padding:6px 10px;border:1px solid var(--border-soft);border-radius:8px;font-size:13px;font-family:inherit;background:var(--bg-card);">
          <select id="tab-add-type" style="padding:6px 8px;border:1px solid var(--border-soft);border-radius:8px;font-size:12px;background:var(--bg-card);">
            <option value="url">🌐 URL</option>
            <option value="note">📝 メモ</option>
            <option value="blank">⬜ 空白</option>
          </select>
        </div>
        <div id="tab-add-content-row" style="margin-bottom:8px;">
          <input id="tab-add-content" placeholder="URL (例: https://example.com)" style="width:100%;padding:6px 10px;border:1px solid var(--border-soft);border-radius:8px;font-size:12px;font-family:inherit;background:var(--bg-card);box-sizing:border-box;">
        </div>
        <div style="display:flex;gap:8px;">
          <button id="tab-add-cancel-btn" class="btn-secondary" style="flex:1;font-size:13px;">キャンセル</button>
          <button id="tab-add-confirm-btn" class="btn-primary" style="flex:1;font-size:13px;">追加</button>
        </div>
      </div>
      <div style="padding:0 14px 14px;display:flex;gap:8px;">
        <button id="tab-add-btn" class="btn-secondary" style="flex:1;margin-top:10px;font-size:13px;">＋ タブを追加</button>
        <button id="tab-mgr-save" class="btn-primary" style="flex:2;margin-top:10px;">✓ 保存</button>
      </div>
    </div>
  </div>

  <!-- ハブカード並び替えモーダル -->
  <div class="modal-backdrop" id="hub-sort-modal">
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div class="modal-title">🔀 ハブカード並び替え</div>
        <button class="modal-close" id="hub-sort-close">✕</button>
      </div>
      <div style="padding:0 14px;overflow-y:auto;max-height:52vh;">
        <p style="font-size:12px;color:var(--text-muted);margin-bottom:10px;">☰ をドラッグして並び替えてください</p>
        <div id="hub-sort-list"></div>
      </div>
      <div style="padding:0 14px 14px;">
        <button id="hub-sort-save" class="btn-primary" style="width:100%;margin-top:10px;">✓ 保存</button>
      </div>
    </div>
  </div>

  <!-- Progress overlay（jinjer同期・重い処理用） -->
  <div class="progress-overlay" id="progress-overlay">
    <div class="progress-box">
      <div class="progress-spinner" id="progress-spinner"></div>
      <div class="progress-title" id="progress-title">処理中...</div>
      <div class="progress-bar-wrap">
        <div class="progress-bar-fill" id="progress-bar"></div>
      </div>
      <div class="progress-step" id="progress-step"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Log viewer modal -->
  <div class="modal-backdrop" id="log-modal">
    <div class="modal-sheet" style="max-height:85vh;overflow:hidden;display:flex;flex-direction:column;">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div class="modal-title">📋 システムログ</div>
        <button class="modal-close" id="log-close">✕</button>
      </div>
      <div style="padding:0 14px 6px;display:flex;align-items:center;gap:8px;">
        <span style="font-size:11px;color:var(--text-muted);flex-shrink:0;">📅 日付:</span>
        <select id="log-date-sel" style="font-size:11px;border:1px solid var(--border-soft);border-radius:8px;padding:3px 8px;background:#f4f5f9;font-family:inherit;flex:1;min-width:0;"></select>
      </div>
      <div class="log-filter-bar">
        <button class="log-filter-btn active" data-filter="all">すべて</button>
        <button class="log-filter-btn" data-filter="fatal">💀 致命</button>
        <button class="log-filter-btn" data-filter="error">🔴 エラー</button>
        <button class="log-filter-btn" data-filter="warn">🟡 警告</button>
        <button class="log-filter-btn" data-filter="info">🔵 情報</button>
      </div>
      <div style="overflow-y:auto;flex:1;padding:0 14px 12px;" id="log-scroll">
        <div id="log-list"></div>
      </div>
      <div class="modal-footer" style="gap:8px;">
        <button class="btn-secondary" id="log-clear" style="flex:1;">🗑 ログ消去</button>
        <button class="btn-primary" id="log-close2" style="flex:1;">閉じる</button>
      </div>
    </div>
  </div>

  <!-- jinjer 同期ステータスモーダル -->
  <div class="modal-backdrop" id="jinjer-sync-modal">
    <div class="modal-sheet" style="max-height:70vh;">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div class="modal-title">🏢 jinjer同期</div>
        <button class="modal-close" id="jinjer-sync-close">✕</button>
      </div>
      <div style="padding:4px 16px 16px;">
        <!-- 同期方法の選択 -->
        <div id="jinjer-sync-opts">
          <button class="jinjer-sync-opt-btn" id="jinjer-sync-opt-auto" style="border-color:var(--accent-blue);background:linear-gradient(135deg,rgba(79,141,253,0.08),rgba(124,95,230,0.08));">
            <div class="jinjer-sync-opt-title" style="color:var(--accent-blue);">🚀 今月を今すぐ同期</div>
            <div class="jinjer-sync-opt-sub">ローカルサーバー経由でjinjerから直接取得（Tailscale不要）</div>
          </button>
          <button class="jinjer-sync-opt-btn" id="jinjer-sync-opt-full">
            <div class="jinjer-sync-opt-title">📊 全期間一括同期</div>
            <div class="jinjer-sync-opt-sub" id="jinjer-sync-full-range">全月をまとめて取得・iCloudに保存</div>
          </button>
          <button class="jinjer-sync-opt-btn" id="jinjer-sync-opt-file">
            <div class="jinjer-sync-opt-title">📂 ファイルから同期</div>
            <div class="jinjer-sync-opt-sub">iCloud kintaiフォルダのJSONを読み込む</div>
          </button>
        </div>
        <div id="jinjer-sync-status" style="font-size:13px;color:var(--text-sub);text-align:center;padding:16px 0;line-height:1.6;display:none;"></div>
        <div id="jinjer-sync-cmd-box" style="display:none;margin-top:4px;">
          <div style="font-size:11px;font-weight:800;color:var(--text-muted);margin-bottom:6px;">Macで以下を実行してサーバーを起動:</div>
          <div style="background:#1a1a2e;color:#e0f2fe;border-radius:10px;padding:10px 12px;font-family:monospace;font-size:11px;line-height:1.6;word-break:break-all;" id="jinjer-sync-cmd-text"></div>
          <button class="btn-secondary" id="jinjer-sync-cmd-copy" style="width:100%;margin-top:8px;font-size:11px;">📋 コマンドをコピー</button>
          <button class="btn-secondary" id="jinjer-sync-retry" style="width:100%;margin-top:6px;font-size:11px;">🔄 再試行</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ファイルブラウザモーダル -->
  <div class="modal-backdrop" id="filebrowser-modal">
    <div class="modal-sheet" style="max-height:94vh;height:92vh;display:flex;flex-direction:column;">
      <div class="modal-handle"></div>
      <div class="modal-header" style="padding:10px 16px 6px;flex-shrink:0;">
        <div class="modal-title">📁 ファイルブラウザ</div>
        <div style="display:flex;align-items:center;gap:8px;">
          <button class="btn-secondary" id="filebrowser-refresh" style="padding:4px 10px;font-size:11px;">🔄</button>
          <button class="modal-close" id="filebrowser-close">✕</button>
        </div>
      </div>
      <!-- ファイル選択 -->
      <div style="padding:0 12px 8px;flex-shrink:0;">
        <select id="filebrowser-select" style="width:100%;padding:8px 10px;border:1px solid #e0e0e0;border-radius:10px;font-size:12px;background:#fff;color:#333;"></select>
      </div>
      <!-- ファイル情報 -->
      <div id="filebrowser-meta" style="padding:0 12px 4px;font-size:10px;color:var(--text-muted);flex-shrink:0;"></div>
      <!-- ファイル内容 -->
      <div style="flex:1;overflow:auto;min-height:0;padding:0 12px 12px;">
        <pre id="filebrowser-content" style="margin:0;padding:12px;background:#1a1a2e;color:#e0f2fe;border-radius:12px;font-size:11px;line-height:1.5;white-space:pre-wrap;word-break:break-all;min-height:200px;"></pre>
      </div>
    </div>
  </div>

  <!-- パフォーマンスビューアーモーダル -->
  <div class="modal-backdrop" id="perf-modal">
    <div class="modal-sheet" style="max-height:88vh;overflow:hidden;display:flex;flex-direction:column;">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div class="modal-title">📊 システムパフォーマンス</div>
        <button class="modal-close" id="perf-close">✕</button>
      </div>
      <div style="overflow-y:auto;flex:1;padding:4px 16px 16px;" id="perf-content">
        <div style="text-align:center;color:var(--text-muted);font-size:13px;padding:24px 0;">計測中…</div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="perf-refresh" style="flex:1;">🔄 再計測</button>
        <button class="btn-primary" id="perf-close2" style="flex:1;">閉じる</button>
      </div>
    </div>
  </div>

  <!-- 議事録・文字起こしモーダル -->
  <div class="modal-backdrop" id="min-modal">
    <div class="modal-sheet" style="max-height:92vh;overflow:hidden;display:flex;flex-direction:column;">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div class="modal-title">📝 議事録・文字起こし</div>
        <button class="modal-close" id="min-close">✕</button>
      </div>
      <!-- タブ -->
      <div style="display:flex;border-bottom:1px solid var(--border-soft);margin:0 -16px;padding:0 16px;flex-shrink:0;">
        <button id="min-tab-rec"  style="flex:1;padding:8px 0;font-size:12px;font-weight:800;font-family:inherit;border:none;background:none;border-bottom:2.5px solid var(--accent-blue);color:var(--accent-blue);cursor:pointer;">🎙 録音</button>
        <button id="min-tab-hist" style="flex:1;padding:8px 0;font-size:12px;font-weight:800;font-family:inherit;border:none;background:none;border-bottom:2.5px solid transparent;color:var(--text-muted);cursor:pointer;">📁 履歴</button>
        <button id="min-tab-video" style="flex:1;padding:8px 0;font-size:12px;font-weight:800;font-family:inherit;border:none;background:none;border-bottom:2.5px solid transparent;color:var(--text-muted);cursor:pointer;">🎬 動画</button>
      </div>
      <!-- 録音パネル -->
      <div id="min-panel-rec" style="flex:1;display:flex;flex-direction:column;min-height:0;overflow:hidden;padding-top:10px;">
        <input id="min-title" class="settings-input" type="text" placeholder="会議名（例: 週次MTG）" style="flex-shrink:0;margin-bottom:4px;">
        <div class="min-controls">
          <button class="min-rec-btn start" id="min-rec-btn">🔴 録音開始</button>
          <span class="min-timer" id="min-timer">00:00</span>
          <span class="min-status-badge" id="min-status" style="display:none;">🎙 認識中</span>
        </div>
        <div class="min-transcript" id="min-transcript">
          <div id="min-transcript-body">
            <div style="text-align:center;color:var(--text-muted);padding:28px 0;font-size:12px;line-height:1.8;">
              🎙 録音開始でリアルタイム文字起こし<br>
              <span style="font-size:11px;">対応: Chrome / Safari (iOS 14.5+)　日本語 精度高</span>
            </div>
          </div>
        </div>
        <div class="min-actions">
          <button class="min-action-btn" id="min-copy">📋 コピー</button>
          <button class="min-action-btn" id="min-md">📄 MD保存</button>
          <button class="min-action-btn" id="min-obsidian">🔗 Obsidian</button>
          <button class="min-action-btn" id="min-save-min">💾 保存</button>
          <button class="min-action-btn" id="min-clear" style="color:#c62828;">🗑 クリア</button>
        </div>
      </div>
      <!-- 履歴パネル -->
      <div id="min-panel-hist" style="flex:1;display:none;flex-direction:column;min-height:0;overflow:hidden;padding-top:8px;">
        <div id="min-hist-list" style="overflow-y:auto;flex:1;"></div>
      </div>
      <!-- 動画文字起こしパネル -->
      <div id="min-panel-video" style="flex:1;display:none;flex-direction:column;min-height:0;overflow:hidden;padding-top:10px;">
        <input id="min-video-title" class="settings-input" type="text" placeholder="ファイル名（自動入力）" style="flex-shrink:0;margin-bottom:6px;">
        <div style="flex-shrink:0;margin-bottom:8px;">
          <button class="min-action-btn" id="min-video-pick" style="width:100%;font-size:13px;padding:10px 0;">📁 動画・音声ファイルを選択</button>
          <input type="file" id="min-video-file" accept="video/*,audio/*" style="display:none">
        </div>
        <div id="min-video-player-wrap" style="display:none;flex-shrink:0;margin-bottom:8px;padding:0 2px;">
          <audio id="min-video-audio" controls style="width:100%;height:36px;"></audio>
          <div id="min-video-file-info" style="font-size:11px;color:var(--text-muted);margin-top:4px;text-align:center;"></div>
        </div>
        <div id="min-video-status" style="font-size:12px;font-weight:700;color:var(--accent-blue);text-align:center;padding:4px 0;display:none;flex-shrink:0;"></div>
        <div class="min-transcript" id="min-video-transcript" style="flex:1;overflow-y:auto;">
          <div id="min-video-transcript-body">
            <div style="text-align:center;color:var(--text-muted);padding:28px 0;font-size:12px;line-height:1.8;">
              📁 動画または音声ファイルを選択して<br>「文字起こし開始」を押してください<br>
              <span style="font-size:11px;opacity:0.8;">⚠️ スピーカー再生＋マイク認識方式<br>ヘッドフォンを外してご使用ください</span>
            </div>
          </div>
        </div>
        <div class="min-actions" style="flex-shrink:0;">
          <button class="min-action-btn" id="min-video-start">▶ 文字起こし開始</button>
          <button class="min-action-btn" id="min-video-stop" style="display:none;color:#c62828;">⏹ 停止</button>
          <button class="min-action-btn" id="min-video-copy">📋 コピー</button>
          <button class="min-action-btn" id="min-video-save">💾 保存</button>
          <button class="min-action-btn" id="min-video-clear" style="color:#c62828;">🗑 クリア</button>
        </div>
      </div>
    </div>
  </div>

  <!-- カメラ サイズ計測モーダル -->
  <div class="modal-backdrop" id="measure-modal">
    <div class="modal-sheet" style="max-height:98vh;overflow:hidden;display:flex;flex-direction:column;">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div class="modal-title">📏 サイズ計測</div>
        <button class="modal-close" id="measure-close">✕</button>
      </div>
      <!-- カメラビューポート -->
      <div id="measure-cam-wrap" style="position:relative;background:#111;overflow:hidden;flex:1;min-height:180px;max-height:46vh;">
        <video id="measure-video" style="width:100%;height:100%;object-fit:cover;display:block;" playsinline muted></video>
        <canvas id="measure-canvas" style="position:absolute;top:0;left:0;width:100%;height:100%;touch-action:none;"></canvas>
        <div id="measure-cam-msg" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.75);font-size:13px;pointer-events:none;text-align:center;padding:16px;background:rgba(0,0,0,0.55);">📷 カメラを起動中...</div>
      </div>
      <!-- ステップ表示 -->
      <div id="measure-step" style="padding:8px 16px 2px;font-size:12px;font-weight:700;color:var(--accent-blue);text-align:center;flex-shrink:0;min-height:26px;"></div>
      <!-- コントロール -->
      <div style="padding:4px 16px 14px;flex-shrink:0;overflow-y:auto;">
        <!-- ① 基準物 -->
        <div style="margin-bottom:10px;">
          <div style="font-size:11px;font-weight:800;color:var(--text-muted);margin-bottom:6px;">① 基準物を画面内に置いてタップで指定:</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;">
            <button class="measure-ref-btn active" data-w="85.6" data-label="クレカ幅">💳 クレカ (85.6mm)</button>
            <button class="measure-ref-btn" data-w="26.5" data-label="500円玉径">🪙 500円玉 (26.5mm)</button>
            <button class="measure-ref-btn" data-w="210" data-label="A4幅">📄 A4幅 (210mm)</button>
          </div>
        </div>
        <!-- ② 計測箇所 -->
        <div style="margin-bottom:10px;">
          <div style="font-size:11px;font-weight:800;color:var(--text-muted);margin-bottom:6px;">② 計測する箇所を選択:</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;">
            <button class="measure-type-btn active" data-type="foot">👟 足の長さ</button>
            <button class="measure-type-btn" data-type="shoulder">👔 肩幅</button>
            <button class="measure-type-btn" data-type="waist">👖 ウエスト</button>
            <button class="measure-type-btn" data-type="custom">📐 自由計測</button>
          </div>
        </div>
        <!-- 計測結果 -->
        <div id="measure-result" style="display:none;background:var(--bg-hover);border-radius:14px;padding:12px;text-align:center;margin-bottom:10px;">
          <div id="measure-result-mm" style="font-size:22px;font-weight:900;color:var(--accent-blue);"></div>
          <div id="measure-result-size" style="font-size:12px;color:var(--text-sub);margin-top:4px;line-height:1.7;"></div>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="btn-secondary" id="measure-reset" style="flex:1;font-size:12px;">🗑 リセット</button>
          <button class="btn-secondary" id="measure-flip" style="flex:1;font-size:12px;">🔄 カメラ切替</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* =====================================================
       HIGH-AVAILABILITY: 緊急リセット / クラッシュ検出 / グローバルエラー捕捉
       ===================================================== */

    // ① URLパラメータによる緊急リセット (?reset)
    if (location.search.includes('reset')) {
      (async () => {
        try { const r = await navigator.serviceWorker.getRegistrations(); for(const s of r) await s.unregister(); } catch(_){}
        try { const k = await caches.keys(); await Promise.all(k.map(c => caches.delete(c))); } catch(_){}
        try { localStorage.clear(); } catch(_){}
        try { indexedDB.deleteDatabase('kintai_idb'); } catch(_){}
        location.replace(location.pathname); // ?reset を除いてリロード
      })();
    }

    // ② クラッシュループ検出（3回連続でクラッシュしたら復旧UIを表示）
    //    sessionStorage はiOSがプロセスをkillすると消えるため localStorage を使う
    const _CRASH_KEY = '_kintai_crash';
    const _crashes   = Number(localStorage.getItem(_CRASH_KEY) || 0);
    localStorage.setItem(_CRASH_KEY, _crashes + 1);
    window.addEventListener('load', () => localStorage.setItem(_CRASH_KEY, '0'));

    if (_crashes >= 3) {
      document.addEventListener('DOMContentLoaded', () => {
        document.body.innerHTML = `
          <div style="font-family:-apple-system,sans-serif;max-width:360px;margin:60px auto;padding:24px;
               background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(0,0,0,0.12);text-align:center;">
            <div style="font-size:40px;">🚨</div>
            <h2 style="margin:8px 0 6px;font-size:18px;">クラッシュを繰り返しています</h2>
            <p style="font-size:13px;color:#666;line-height:1.6;margin:0 0 20px">
              データが破損している可能性があります。<br>復旧ページで修復してください。
            </p>
            <a href="./recover.html" style="display:block;background:#4f8dfd;color:#fff;
               padding:13px;border-radius:12px;text-decoration:none;font-weight:700;font-size:15px;
               margin-bottom:10px;">🛠 復旧ページへ</a>
            <button onclick="localStorage.setItem('${_CRASH_KEY}','0');location.reload()"
              style="width:100%;background:#fff;border:1.5px solid #ddd;color:#555;
              padding:11px;border-radius:12px;font-size:14px;cursor:pointer;font-family:inherit;">
              ⚡ このまま起動を再試行
            </button>
          </div>`;
      });
      throw new Error('RECOVERY_MODE'); // 以降のスクリプトを一切実行しない
    }

    // ③ エラーテレメトリ（ローカル ring buffer — 最新20件をlocalStorageに保存）
    const _ERR_KEY  = '_kintai_errors';
    const _ERR_MAX  = 20;
    function _logError(type, detail) {
      try {
        const log = JSON.parse(localStorage.getItem(_ERR_KEY) || '[]');
        log.unshift({ ts: new Date().toISOString(), type, detail: String(detail).slice(0, 200) });
        if (log.length > _ERR_MAX) log.length = _ERR_MAX;
        localStorage.setItem(_ERR_KEY, JSON.stringify(log));
      } catch(_) {}
    }
    window.addEventListener('error', ev => {
      _logError('js_error', `${ev.message} @ ${ev.filename}:${ev.lineno}`);
      _appLog('fatal', 'GLOBAL', `${ev.message} @ ${(ev.filename||'').split('/').pop()}:${ev.lineno}`);
    });
    window.addEventListener('unhandledrejection', ev => {
      _logError('unhandled_rejection', ev.reason);
      _appLog('fatal', 'PROMISE', String(ev.reason).slice(0, 200));
      ev.preventDefault(); // iOS Safari の強制クラッシュを抑制
    });

    // ④ アプリログ（ring buffer — 最新200件、HA: IDB日次アーカイブ365日保持）
    const _LOG_KEY = '_kintai_log';
    const _LOG_MAX = 200;
    const _LOG_ARCHIVE_DAYS = 365;  // HA準拠: 1年保持
    // IDB 日次ログ操作（HA: 365日保持）
    async function idbSaveLogsDaily(date, entries) {
      try {
        const db = await _openIDB();
        if (!db) return;
        const tx = db.transaction('logs_archive', 'readwrite');
        tx.objectStore('logs_archive').put({ id: date, entries, updated_at: new Date().toISOString() });
      } catch(_) {}
    }
    async function idbLoadLogsDaily(date) {
      try {
        const db = await _openIDB();
        if (!db) return null;
        return new Promise(resolve => {
          const req = db.transaction('logs_archive').objectStore('logs_archive').get(date);
          req.onsuccess = e => resolve(e.target.result);
          req.onerror   = () => resolve(null);
        });
      } catch(_) { return null; }
    }
    async function idbListLogDates() {
      try {
        const db = await _openIDB();
        if (!db) return [];
        return new Promise(resolve => {
          const req = db.transaction('logs_archive').objectStore('logs_archive').getAllKeys();
          req.onsuccess = e => resolve([...(e.target.result || [])].sort().reverse());
          req.onerror   = () => resolve([]);
        });
      } catch(_) { return []; }
    }
    async function idbPruneOldLogs(keepDays = 365) {
      try {
        const db = await _openIDB();
        if (!db) return;
        const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - keepDays);
        const cutoffStr = cutoff.toISOString().slice(0, 10);
        const keys = await new Promise(resolve => {
          const req = db.transaction('logs_archive').objectStore('logs_archive').getAllKeys();
          req.onsuccess = e => resolve(e.target.result || []);
          req.onerror   = () => resolve([]);
        });
        const tx = db.transaction('logs_archive', 'readwrite');
        keys.filter(k => k < cutoffStr).forEach(k => tx.objectStore('logs_archive').delete(k));
      } catch(_) {}
    }

    function _appLog(level, source, msg) {
      try {
        const entry = { ts: new Date().toISOString(), level, source, msg: String(msg).slice(0, 300) };
        // メインリングバッファ（直近200件 — HA強化）
        const log = JSON.parse(localStorage.getItem(_LOG_KEY) || '[]');
        log.unshift(entry);
        if (log.length > _LOG_MAX) log.length = _LOG_MAX;
        localStorage.setItem(_LOG_KEY, JSON.stringify(log));
        // IDB 日次アーカイブ（SysLog形式、365日保持）
        const dayKey = entry.ts.slice(0, 10);
        idbLoadLogsDaily(dayKey).then(existing => {
          const arr = (existing?.entries) || [];
          arr.unshift(entry);
          if (arr.length > 2000) arr.length = 2000;  // 2000件/日
          idbSaveLogsDaily(dayKey, arr);
          if (Math.random() < 0.01) idbPruneOldLogs(365);
        }).catch(() => {});
      } catch(_) {}
    }
    // console.warn / console.error をインターセプトして自動記録
    (function patchConsole() {
      const _ow = console.warn.bind(console);
      const _oe = console.error.bind(console);
      function _src(args) {
        const m = String(args[0]).match(/\[([^\]]+)\]/);
        return m ? m[1] : 'app';
      }
      console.warn  = (...a) => { _ow(...a);  _appLog('warn',  _src(a), a.join(' ')); };
      console.error = (...a) => { _oe(...a);  _appLog('error', _src(a), a.join(' ')); };
    })();

    // ログエントリの改善提案を返す
    function _logSuggestion(source, msg, level) {
      const s = (source || '').toLowerCase();
      const m = (msg || '').toLowerCase();
      if (level === 'fatal') {
        if (m.includes('quota') || m.includes('storage'))
          return 'ストレージが満杯です。設定 → 緊急復旧 → 不要データを削除してください。';
        if (m.includes('syntaxerror') || m.includes('json'))
          return 'データが破損しています。スナップショットから復元を試みてください。';
        if (m.includes('referenceerror'))
          return 'アプリの初期化エラーです。ページをリロードしてください。';
        return 'クリティカルエラー。画面右上🚨から緊急復旧を試みてください。';
      }
      if (s === 'jinjer' || m.includes('jinjer'))
        return 'jinjer同期に失敗しました。設定でjinjer認証情報を確認し再試行してください。';
      if (s === 'weather' || m.includes('open-meteo') || m.includes('geocod'))
        return '天気APIへの接続失敗。設定で都市を変更するかGPS権限を確認してください。';
      if (s === 'idb' || m.includes('indexeddb') || m.includes('idbsave') || m.includes('idbload') || m.includes('idb復元'))
        return 'IndexedDB操作でエラーが発生しました。設定→バックアップから手動復元、またはブラウザのストレージ権限を確認してください。';
      if (s === 'serviceworker' || m.includes('serviceworker'))
        return 'Service Workerの更新に失敗しました。緊急復旧→SWを強制更新を試みてください。';
      if (s === 'tailscale' || m.includes('tailscale'))
        return 'Tailscale接続エラー。VPNが接続中か、設定のMac IPアドレスを確認してください。';
      if (m.includes('referenceerror') || m.includes('cannot access') || m.includes('uninitialized'))
        return 'JavaScript変数の初期化前アクセスです。ページをリロードして解消されない場合はキャッシュクリア (設定→緊急復旧→SW更新) を試みてください。';
      if (m.includes('typeerror') || m.includes('cannot read properties') || m.includes('is not a function'))
        return 'JavaScript型エラーです。null/undefinedへのアクセスが原因の可能性があります。ページをリロードしてください。';
      if (m.includes('syntaxerror') || m.includes('unexpected token'))
        return 'データの構文エラーです。インポートJSONの形式を確認するか、スナップショットから復元してください（設定→緊急復旧）。';
      if (m.includes('heartbeat') || m.includes('_tick') || (s === 'heartbeat'))
        return 'サーバーへの接続が不安定です。launchctl list | grep kintai でサーバープロセスを確認してください。';
      if (m.includes('quota') || m.includes('storage full') || m.includes('storage'))
        return 'ストレージ容量が不足しています。設定→緊急復旧→DBクリーンアップを実行してください。';
      if (m.includes('permission') || m.includes('denied') || m.includes('permissionerror'))
        return 'アクセス権限エラーです。ブラウザの設定でストレージ権限を確認してください。';
      if (m.includes('network') || m.includes('fetch') || m.includes('failed to fetch') || m.includes('load failed'))
        return 'ネットワーク接続を確認してください。オフラインの可能性があります。';
      if (m.includes('timeout') || m.includes('etimedout') || m.includes('aborterror'))
        return 'タイムアウトです。サーバーが高負荷か停止している可能性があります。launchctl list | grep kintai で確認してください。';
      if (m.includes('parse') || m.includes('json'))
        return 'JSONデータの解析に失敗しました。インポートファイルの形式を確認してください。';
      if (m.includes('econnrefused') || m.includes('connection refused'))
        return 'サーバーへの接続が拒否されました。jinjer_server.py が起動しているか確認してください。';
      return null;
    }
    window._logSuggestion = _logSuggestion;  // ログタブ IIFE からアクセス可能に

    /* =====================================================
       HA: 自動スナップショット（3世代ローリング保存）
       ===================================================== */
    const _SNAP_KEY   = '_kintai_snap_';   // _kintai_snap_0 / _1 / _2
    const _SNAP_IDX   = '_kintai_snap_idx';
    const _SNAP_GENS  = 3;

    function saveSnapshot(store) {
      try {
        const idx = (Number(localStorage.getItem(_SNAP_IDX) || 0) + 1) % _SNAP_GENS;
        const meta = { ts: new Date().toISOString(), months: Object.keys(store.months || {}).length };
        localStorage.setItem(_SNAP_KEY + idx, JSON.stringify({ meta, data: store }));
        localStorage.setItem(_SNAP_IDX, String(idx));
      } catch(_) {}
    }

    function loadLatestSnapshot() {
      try {
        const idx = Number(localStorage.getItem(_SNAP_IDX) || 0);
        for (let i = 0; i < _SNAP_GENS; i++) {
          const si = (idx - i + _SNAP_GENS) % _SNAP_GENS;
          const raw = localStorage.getItem(_SNAP_KEY + si);
          if (!raw) continue;
          const { meta, data } = JSON.parse(raw);
          if (data && data.months && Object.keys(data.months).length > 0) return { meta, data };
        }
      } catch(_) {}
      return null;
    }

    function listSnapshots() {
      const result = [];
      const idx = Number(localStorage.getItem(_SNAP_IDX) || 0);
      for (let i = 0; i < _SNAP_GENS; i++) {
        const si = (idx - i + _SNAP_GENS) % _SNAP_GENS;
        const raw = localStorage.getItem(_SNAP_KEY + si);
        if (!raw) continue;
        try {
          const { meta } = JSON.parse(raw);
          result.push({ slot: si, ...meta });
        } catch(_) {}
      }
      return result;
    }

    /* =====================================================
       HA: ヘルスチェック & インジケーター
       ===================================================== */

    // サーバー死活状態 (null=未確認, true=生存, false=停止)
    let _srvAlive = null;
    // heartbeat が解決した実際のサーバーベース URL（全タブ共有）
    window._srvBase = 'http://localhost:8899';

    async function runHealthCheck() {
      // localStorage サイズ推定
      let lsSize = 0;
      try {
        for (const k of Object.keys(localStorage)) {
          lsSize += (localStorage.getItem(k) || '').length;
        }
      } catch(_) {}

      // IDB 確認
      let idbOk = false;
      try {
        const idbData = await idbLoad();
        idbOk = !!(idbData && Object.keys(idbData.months || {}).length > 0);
      } catch(_) {}

      // エラー数
      let errCount = 0;
      try {
        errCount = JSON.parse(localStorage.getItem(_ERR_KEY) || '[]').length;
      } catch(_) {}

      // スナップショット最新時刻
      const snaps = listSnapshots();
      const latestSnap = snaps.length > 0 ? snaps[0] : null;

      // UI 更新
      const dotLS  = document.getElementById('health-dot-ls');
      const dotIDB = document.getElementById('health-dot-idb');
      const dotErr = document.getElementById('health-dot-err');
      const txtLS  = document.getElementById('health-ls');
      const txtIDB = document.getElementById('health-idb');
      const txtErr = document.getElementById('health-err');
      const txtSnap= document.getElementById('health-snap');

      if (!dotLS) return;

      const lsKB = Math.round(lsSize / 1024);
      const lsWarn = lsKB > 4000;
      dotLS.className  = 'health-dot ' + (lsWarn ? 'health-dot-warn' : 'health-dot-ok');
      txtLS.textContent = `LS: ${lsKB}KB`;

      dotIDB.className  = 'health-dot ' + (idbOk ? 'health-dot-ok' : 'health-dot-warn');
      txtIDB.textContent = `IDB: ${idbOk ? '✓' : '空'}`;

      dotErr.className  = 'health-dot ' + (errCount === 0 ? 'health-dot-ok' : errCount < 5 ? 'health-dot-warn' : 'health-dot-error');
      txtErr.textContent = `エラー: ${errCount}件`;

      if (latestSnap) {
        const d = new Date(latestSnap.ts);
        const fmt = `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        txtSnap.textContent = `スナップ: ${fmt}`;
      } else {
        txtSnap.textContent = 'スナップ: なし';
      }

      // SRV ドット更新（_srvAlive は heartbeat が更新する）
      const dotSrv = document.getElementById('health-dot-srv');
      const txtSrv = document.getElementById('health-srv');
      if (dotSrv && _srvAlive !== null) {
        dotSrv.className = 'health-dot ' + (_srvAlive ? 'health-dot-ok' : 'health-dot-error');
        if (txtSrv) txtSrv.textContent = `SRV: ${_srvAlive ? '✓' : '✗'}`;
      }
    }

    /* =====================================================
       CONSTANTS
       ===================================================== */
    const STATUS_LIST = ["未", "出社", "在宅", "休日", "休み", "祝日"];
    /* =====================================================
       ⚠️ CRITICAL DATA KEYS — 絶対に変更・削除禁止 ⚠️
       以下のキーはユーザーの業務データが格納されています。
       システム改修時にこれらのキーを変更すると全データが失われます。
       新しいキーが必要な場合は別名で追加し、マイグレーション処理を実装すること。
       ===================================================== */
    const STORE_KEY   = 'kintai_store_v1';   // 📅 カレンダー/勤怠データ（最重要）
    const LAST_KEY    = 'att_last_template'; // テンプレート
    const CFG_KEY     = 'kintai_config_v1';  // ⚙️ 設定
    const TASKS_KEY   = 'kintai_tasks_v1';  // ✅ タスクデータ
    // _SENS_STORE_KEY = '_kintai_sens_v1'   // 🔒 暗号化センシティブデータ (3370行付近)
    /* ===================================================== */

    /* =====================================================
       JAPANESE HOLIDAY CALCULATION
       ===================================================== */
    const _hCache = {};

    function getHolidays(year) {
      if (_hCache[year]) return _hCache[year];
      const h = {};
      const f = (m, d, name) => {
        h[`${year}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`] = name;
      };

      // Fixed
      f(1,1,'元日');
      f(2,11,'建国記念の日');
      f(2,23,'天皇誕生日');
      f(4,29,'昭和の日');
      f(5,3,'憲法記念日');
      f(5,4,'みどりの日');
      f(5,5,'こどもの日');
      f(8,11,'山の日');
      f(11,3,'文化の日');
      f(11,23,'勤労感謝の日');

      // nth weekday helper (wd: JS format 0=Sun,1=Mon,...,6=Sat)
      function nthWD(month, wd, n) {
        const d = new Date(year, month - 1, 1);
        let c = 0;
        while (true) {
          if (d.getDay() === wd && ++c === n) return d.getDate();
          d.setDate(d.getDate() + 1);
        }
      }
      f(1,  nthWD(1, 1, 2), '成人の日');
      f(7,  nthWD(7, 1, 3), '海の日');
      f(9,  nthWD(9, 1, 3), '敬老の日');
      f(10, nthWD(10,1, 2), 'スポーツの日');

      // 春分の日・秋分の日 (近似式)
      const sy = year - 1980;
      const shunbun = Math.floor(20.8431 + 0.242194 * sy - Math.floor(sy / 4));
      const shubun  = Math.floor(23.2488 + 0.242194 * sy - Math.floor(sy / 4));
      f(3, shunbun, '春分の日');
      f(9, shubun,  '秋分の日');

      // 振替休日: 祝日が日曜 → 翌月曜（連鎖対応）
      const hkeys = Object.keys(h).sort();
      for (const k of hkeys) {
        const d = new Date(k + 'T00:00:00');
        if (d.getDay() === 0) {
          let nxt = new Date(d);
          nxt.setDate(nxt.getDate() + 1);
          while (h[nxt.toISOString().slice(0, 10)]) nxt.setDate(nxt.getDate() + 1);
          h[nxt.toISOString().slice(0, 10)] = '振替休日';
        }
      }

      // 国民の休日: 2つの祝日に挟まれた平日
      const all = Object.keys(h).sort();
      for (let i = 0; i < all.length - 1; i++) {
        const d1 = new Date(all[i] + 'T00:00:00');
        const d2 = new Date(all[i + 1] + 'T00:00:00');
        if ((d2 - d1) / 86400000 === 2) {
          const mid = new Date(d1);
          mid.setDate(mid.getDate() + 1);
          const mk = mid.toISOString().slice(0, 10);
          if (!h[mk] && mid.getDay() !== 0) h[mk] = '国民の休日';
        }
      }

      _hCache[year] = h;
      return h;
    }

    function holidayName(dateStr) {
      return getHolidays(+dateStr.slice(0, 4))[dateStr] || null;
    }

    /* =====================================================
       SENSITIVE DATA ENCRYPTION (AES-GCM / Web Crypto API)
       tsMac / tsIphone / jinjerPass は平文では保存しない。
       デバイス固有のIDから PBKDF2 で鍵を派生させ、常に暗号化して保管する。
       ===================================================== */
    const _SENS_STORE_KEY = '_kintai_sens_v1';
    const _DEV_ID_KEY     = '_kintai_dev_id';

    async function _getSensKey() {
      // ① LS から取得
      let devId = localStorage.getItem(_DEV_ID_KEY);
      // ② LS になければ IDB config_backup から復元
      if (!devId) {
        try {
          const idbCfg = await idbLoadConfig();
          if (idbCfg?._dev_id) {
            devId = idbCfg._dev_id;
            localStorage.setItem(_DEV_ID_KEY, devId); // LS に書き戻す
          }
        } catch(_) {}
      }
      // ③ それでもなければ新規生成して両方に保存
      if (!devId) {
        devId = (crypto.randomUUID?.() ?? Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join(''));
        localStorage.setItem(_DEV_ID_KEY, devId);
        // IDB にも保存 (非同期)
        idbLoadConfig().then(cfg => idbSaveConfig({ ...(cfg||{}), _dev_id: devId })).catch(()=>{});
      }
      const raw = await crypto.subtle.importKey('raw', new TextEncoder().encode(devId), 'PBKDF2', false, ['deriveKey']);
      return crypto.subtle.deriveKey(
        { name: 'PBKDF2', salt: new TextEncoder().encode('kintai-sens-v1'), iterations: 120000, hash: 'SHA-256' },
        raw, { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt']
      );
    }

    async function _encSens(str) {
      if (!str) return '';
      const key = await _getSensKey();
      const iv  = crypto.getRandomValues(new Uint8Array(12));
      const enc = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, new TextEncoder().encode(str));
      const combined = new Uint8Array(12 + enc.byteLength);
      combined.set(iv);
      combined.set(new Uint8Array(enc), 12);
      return btoa(String.fromCharCode(...combined));
    }

    async function _decSens(cipher) {
      if (!cipher) return '';
      try {
        const key = await _getSensKey();
        const raw = Uint8Array.from(atob(cipher), c => c.charCodeAt(0));
        const dec = await crypto.subtle.decrypt({ name: 'AES-GCM', iv: raw.slice(0,12) }, key, raw.slice(12));
        return new TextDecoder().decode(dec);
      } catch { return ''; }
    }

    /** IPアドレスをマスク表示する（実体は返さない）*/
    function maskIp(ip) {
      if (!ip) return '未設定';
      const p = ip.split('.');
      if (p.length === 4) return `${p[0]}.●●.●●●.●●`;
      return '●●●.●●●.●●●.●●●';
    }

    /** センシティブフィールドを暗号化して保存 */
    async function saveSensitiveData(data) {
      const obj = {};
      for (const [k, v] of Object.entries(data)) {
        obj[k] = await _encSens(v || '');
      }
      localStorage.setItem(_SENS_STORE_KEY, JSON.stringify(obj));
    }

    /** センシティブフィールドを復号して返す */
    async function loadSensitiveData() {
      try {
        const r = localStorage.getItem(_SENS_STORE_KEY);
        if (!r) return {};
        const enc = JSON.parse(r);
        const out = {};
        for (const [k, v] of Object.entries(enc)) {
          out[k] = await _decSens(v);
        }
        return out;
      } catch { return {}; }
    }

    /* =====================================================
       CONFIG
       センシティブフィールド (tsMac / tsIphone / jinjerPass)
       は _SENS_STORE_KEY に暗号化保存し、CFG_KEY には含めない。
       ===================================================== */
    function loadConfig() {
      try {
        const r = localStorage.getItem(CFG_KEY);
        const cfg = r ? JSON.parse(r) : {};
        // 旧バージョンから平文IPが残っていたら削除（マイグレーション）
        if (cfg.tsMac || cfg.tsIphone || cfg.jinjerPass) {
          // 暗号化済みが未保存ならマイグレーション
          if (!localStorage.getItem(_SENS_STORE_KEY)) {
            saveSensitiveData({
              tsMac:     cfg.tsMac     || '',
              tsIphone:  cfg.tsIphone  || '',
              jinjerPass: cfg.jinjerPass || '',
            });
          }
          delete cfg.tsMac;
          delete cfg.tsIphone;
          delete cfg.jinjerPass;
          localStorage.setItem(CFG_KEY, JSON.stringify(cfg));
        }
        return cfg;
      } catch { return {}; }
    }
    function saveConfig(cfg) {
      // センシティブフィールドがあっても保存しない（念のため除外）
      const safe = { ...cfg };
      delete safe.tsMac;
      delete safe.tsIphone;
      delete safe.jinjerPass;
      localStorage.setItem(CFG_KEY, JSON.stringify(safe));
      idbSaveConfig(safe); // 非同期 IDB バックアップ
    }

    /* =====================================================
       DATA STORAGE — IndexedDB（主）+ localStorage（高速キャッシュ）
       書き込み: 両方に同期
       読み込み: localStorage（高速）
       復元:     localStorage が空の場合 IndexedDB から自動復元
       ===================================================== */
    const IDB_NAME    = 'kintai_idb';
    const IDB_VERSION = 3;  // v1: attendance → v2: + config_backup + tasks_backup → v3: + logs_archive (HA 365日)
    const IDB_STORE   = 'attendance';

    function _openIDB() {
      return new Promise((resolve) => {
        try {
          const req = indexedDB.open(IDB_NAME, IDB_VERSION);
          req.onupgradeneeded = e => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains('attendance'))
              db.createObjectStore('attendance', { keyPath: 'id' });
            if (!db.objectStoreNames.contains('config_backup'))
              db.createObjectStore('config_backup', { keyPath: 'id' });
            if (!db.objectStoreNames.contains('tasks_backup'))
              db.createObjectStore('tasks_backup', { keyPath: 'id' });
            if (!db.objectStoreNames.contains('logs_archive'))
              db.createObjectStore('logs_archive', { keyPath: 'id' });  // id = 'YYYY-MM-DD'
          };
          req.onsuccess = e => resolve(e.target.result);
          req.onerror   = () => resolve(null);
        } catch (_) { resolve(null); }
      });
    }

    async function idbSave(data) {
      const db = await _openIDB();
      if (!db) return;
      try {
        const tx = db.transaction(IDB_STORE, 'readwrite');
        tx.objectStore(IDB_STORE).put({ id: 'main', data, saved_at: new Date().toISOString() });
      } catch (_) {}
    }

    async function idbLoad() {
      const db = await _openIDB();
      if (!db) return null;
      return new Promise(resolve => {
        try {
          const req = db.transaction(IDB_STORE).objectStore(IDB_STORE).get('main');
          req.onsuccess = () => resolve(req.result?.data || null);
          req.onerror   = () => resolve(null);
        } catch (_) { resolve(null); }
      });
    }

    async function idbSaveConfig(cfg) {
      const db = await _openIDB();
      if (!db) return;
      try {
        const tx = db.transaction('config_backup', 'readwrite');
        tx.objectStore('config_backup').put({ id: 'main', data: cfg, saved_at: new Date().toISOString() });
      } catch (_) {}
    }

    async function idbLoadConfig() {
      const db = await _openIDB();
      if (!db) return null;
      return new Promise(resolve => {
        try {
          const req = db.transaction('config_backup').objectStore('config_backup').get('main');
          req.onsuccess = () => resolve(req.result?.data || null);
          req.onerror   = () => resolve(null);
        } catch (_) { resolve(null); }
      });
    }

    async function idbSaveTasksUnified(tasks) {
      const db = await _openIDB();
      if (!db) return;
      try {
        const tx = db.transaction('tasks_backup', 'readwrite');
        tx.objectStore('tasks_backup').put({ id: 'main', data: tasks, saved_at: new Date().toISOString() });
      } catch (_) {}
    }

    async function idbLoadTasksUnified() {
      const db = await _openIDB();
      if (!db) return null;
      return new Promise(resolve => {
        try {
          const req = db.transaction('tasks_backup').objectStore('tasks_backup').get('main');
          req.onsuccess = () => resolve(req.result?.data || null);
          req.onerror   = () => resolve(null);
        } catch (_) { resolve(null); }
      });
    }

    // localStorage から読む（高速・同期）
    function loadStore() {
      try {
        const r = localStorage.getItem(STORE_KEY);
        if (!r) return { months: {} };
        const d = JSON.parse(r);
        return (d && d.months) ? d : { months: {} };
      } catch { return { months: {} }; }
    }

    // 両方に書く（localStorage 書き込み失敗時は IDB のみ）
    function saveStore(store) {
      const json = JSON.stringify(store);
      try {
        localStorage.setItem(STORE_KEY, json);
      } catch(e) {
        console.warn('[saveStore] localStorage 書き込み失敗 (quota?):', e);
        // Quota超過なら古い月を削除して再試行
        try {
          const months = Object.keys(store.months || {}).sort();
          if (months.length > 3) {
            delete store.months[months[0]]; // 最古月を削除
            localStorage.setItem(STORE_KEY, JSON.stringify(store));
            console.warn('[saveStore] 最古月を削除して保存しました:', months[0]);
          }
        } catch(_) { console.error('[saveStore] 保存完全失敗'); }
      }
      idbSave(store); // 非同期ミラー（fire-and-forget）
      _syncDataToServer('kintai', store); // サーバーブリッジ (非同期)
      // スナップショット: 30分に1回だけ保存（頻繁な書き込みを抑制）
      try {
        const lastSnap = localStorage.getItem('_kintai_snap_last') || '0';
        if (Date.now() - Number(lastSnap) > 30 * 60 * 1000) {
          saveSnapshot(store);
          localStorage.setItem('_kintai_snap_last', String(Date.now()));
        }
      } catch(_) {}
    }

    /* =====================================================
       SERVER DATA BRIDGE — クロスオリジン/クロスデバイスデータ同期
       localStorage はオリジン（URL）ごとに分離されているため、
       ローカルサーバーをデータの橋渡しとして使用する。
       - saveStore/saveTasks → サーバーへ非同期POST（サイレント）
       - restoreFromIDBIfNeeded → IDB失敗時はサーバーからGET
       ===================================================== */
    const _SERVER_SYNC_THROTTLE = new Map(); // key → last sync ts

    async function _syncDataToServer(type, data) {
      // 同じキーで5秒以内の連続送信を抑制
      const now = Date.now();
      if ((now - (_SERVER_SYNC_THROTTLE.get(type) || 0)) < 5000) return;
      _SERVER_SYNC_THROTTLE.set(type, now);

      const base = await _resolveServerUrl(8899);
      if (!base) return;
      const endpoint = type === 'kintai' ? '/api/kintai-data' : '/api/tasks-data';
      try {
        await fetch(`${base}${endpoint}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
          signal: AbortSignal.timeout(4000),
        });
      } catch(_) {} // サイレント失敗（オフライン時はスキップ）
    }

    async function _restoreFromServer(type) {
      const base = await _resolveServerUrl(8899);
      if (!base) return null;
      const endpoint = type === 'kintai' ? '/api/kintai-data' : '/api/tasks-data';
      try {
        const r = await fetch(`${base}${endpoint}`, { signal: AbortSignal.timeout(4000) });
        if (!r.ok) return null;
        const data = await r.json();
        return data;
      } catch(_) { return null; }
    }

    // 起動時: localStorage が空なら IDB → サーバー の順で復元
    async function restoreFromIDBIfNeeded() {
      let restored = false;
      // ── 勤怠データ ───────────────────────────────────────────────────────
      const ls = localStorage.getItem(STORE_KEY);
      const storeEmpty = !ls || ls === '{"months":{}}';
      if (storeEmpty) {
        // 1st: IndexedDB
        const idbData = await idbLoad();
        if (idbData && Object.keys(idbData.months || {}).length > 0) {
          localStorage.setItem(STORE_KEY, JSON.stringify(idbData));
          toast('💾 IndexedDBから勤怠データを復元しました');
          restored = true;
        }
        // 2nd: サーバーブリッジ (IDB も空だった場合)
        if (!restored) {
          const serverData = await _restoreFromServer('kintai');
          if (serverData && Object.keys(serverData.months || {}).length > 0) {
            // _server_* メタキーを除去してから保存
            const clean = { months: serverData.months };
            localStorage.setItem(STORE_KEY, JSON.stringify(clean));
            idbSave(clean);
            toast('☁️ サーバーブリッジから勤怠データを復元しました');
            restored = true;
          }
        }
      } else {
        // データあり → IDB + サーバーブリッジ両方に即時バックアップ（起動時フォースバックアップ）
        try {
          const store = JSON.parse(ls);
          idbSave(store);                        // IDB へ即時バックアップ
          _syncDataToServer('kintai', store);    // サーバーブリッジへ
        } catch(_) {}
      }

      // ── タスク起動時バックアップ ────────────────────────────────────────
      const lsTasks = localStorage.getItem(TASKS_KEY);
      if (lsTasks) {
        try {
          const tasks = JSON.parse(lsTasks);
          idbSaveTasksUnified(tasks);
          _syncDataToServer('tasks', { tasks });
        } catch(_) {}
      }

      // ── 設定 ───────────────────────────────────────────────────────────
      const lsCfg = localStorage.getItem(CFG_KEY);
      if (!lsCfg || lsCfg === '{}') {
        const idbCfg = await idbLoadConfig();
        if (idbCfg && Object.keys(idbCfg).length > 0) {
          // _dev_id は CFG_KEY には書き戻さない（センシティブ）
          const { _dev_id: _, ...safeCfg } = idbCfg;
          if (Object.keys(safeCfg).length > 0) {
            localStorage.setItem(CFG_KEY, JSON.stringify(safeCfg));
            if (!restored) toast('💾 IndexedDBから設定を復元しました');
          }
        }
      }
      return restored;
    }

    function buildSkeleton(ym) {
      const [y, m] = ym.split('-').map(Number);
      const last = new Date(y, m, 0).getDate();
      const out = {};
      for (let day = 1; day <= last; day++) {
        const d = `${ym}-${String(day).padStart(2, '0')}`;
        out[d] = { date: d, status: '未', start: '', end: '', memo: '', updated_at: '' };
      }
      return out;
    }

    function autoStatus(dateStr) {
      if (holidayName(dateStr)) return '祝日';
      const wd = new Date(dateStr + 'T00:00:00').getDay();
      if (wd === 0) return '休日';
      if (wd === 6) return '休み';
      return '未';
    }

    function applyAutoRules(monthData) {
      const out = {}, holidays = {};
      for (const [d, rec] of Object.entries(monthData)) {
        const r = { ...rec };
        const hn = holidayName(d);
        if (hn) holidays[d] = hn;
        const st = (r.status || '未').trim() || '未';
        r.status = (st === '未') ? autoStatus(d) : st;
        out[d] = r;
      }
      return { data: out, holidays };
    }

    function getMonthData(ym) {
      const store = loadStore();
      if (!store.months[ym]) {
        store.months[ym] = buildSkeleton(ym);
        saveStore(store);
      }
      return applyAutoRules(store.months[ym]);
    }

    function saveDayData(dateStr, status, start, end, memo) {
      const ym = dateStr.slice(0, 7);
      const store = loadStore();
      if (!store.months[ym]) store.months[ym] = buildSkeleton(ym);
      if (!store.months[ym][dateStr]) {
        store.months[ym][dateStr] = {
          date: dateStr, status: '未', start: '', end: '', memo: '', updated_at: ''
        };
      }
      if (status !== '') store.months[ym][dateStr].status = status;
      store.months[ym][dateStr].start = start;
      store.months[ym][dateStr].end   = end;
      store.months[ym][dateStr].memo  = memo;
      store.months[ym][dateStr].updated_at = new Date().toISOString().slice(0, 19);
      saveStore(store);
      // return view-corrected record
      const { data } = applyAutoRules({ [dateStr]: store.months[ym][dateStr] });
      return data[dateStr];
    }

    /* =====================================================
       APP STATE
       ===================================================== */
    let currentYear, currentMonth;
    let attendanceData = {};
    let holidaysData   = {};
    let currentEditDate = null;
    let locked = false;
    let selectedDateStr = null;

    const toastEl   = document.getElementById('toast');
    const overlayEl = document.getElementById('overlay');

    let _toastTimer = null;
    function toast(msg, duration = 2200) {
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      if (_toastTimer) clearTimeout(_toastTimer);
      _toastTimer = setTimeout(() => {
        toastEl.classList.remove('show');
        _toastTimer = null;
      }, duration);
    }

    function setLoading(v) {
      overlayEl.classList.toggle('show', !!v);
    }

    /* =====================================================
       FORMAT HELPERS
       ===================================================== */
    function ymLabel(y, m) {
      return `${y}年${m}月`;
    }

    function formatDateJP(dateStr) {
      const d = new Date(dateStr + 'T00:00:00');
      const wdays = ['日','月','火','水','木','金','土'];
      return `${d.getFullYear()}年${d.getMonth()+1}月${d.getDate()}日（${wdays[d.getDay()]}）`;
    }

    function prevDateStr(dateStr) {
      const d = new Date(dateStr + 'T00:00:00');
      d.setDate(d.getDate() - 1);
      return d.toISOString().slice(0, 10);
    }

    /* =====================================================
       LOAD MONTH
       ===================================================== */
    function loadMonth(year, month) {
      currentYear  = year;
      currentMonth = month;
      document.getElementById('month-label').textContent = ymLabel(year, month);

      setLoading(true);
      try {
        const ym = `${year}-${String(month).padStart(2, '0')}`;
        const { data, holidays } = getMonthData(ym);
        attendanceData = data;
        holidaysData   = holidays;
        renderCalendar(year, month);
        renderStats(year, month);
      } finally {
        setLoading(false);
      }
    }

    /* =====================================================
       SAVE ATTENDANCE
       ===================================================== */
    function saveAttendance(dateStr, status, memo, start, end) {
      const prev = attendanceData[dateStr] ? { ...attendanceData[dateStr] } : null;
      try {
        const day = saveDayData(dateStr, status, start, end, memo);
        attendanceData[dateStr] = day;
        const hn = holidayName(dateStr);
        if (hn) holidaysData[dateStr] = hn;

        localStorage.setItem(LAST_KEY, JSON.stringify({ status, memo, start, end }));
        renderCalendar(currentYear, currentMonth);
        return true;
      } catch (e) {
        if (prev) attendanceData[dateStr] = prev;
        else delete attendanceData[dateStr];
        renderCalendar(currentYear, currentMonth);
        alert('保存に失敗しました');
        return false;
      }
    }

    function getLastTemplate() {
      try {
        const r = localStorage.getItem(LAST_KEY);
        return r ? JSON.parse(r) : null;
      } catch { return null; }
    }

    function quickDuplicateLast(targetDate) {
      if (locked) return;
      const t = getLastTemplate();
      if (!t) { alert('直近テンプレがありません'); return; }
      const ok = saveAttendance(targetDate, t.status||'未', t.memo||'', t.start||'', t.end||'');
      if (ok) toast(`${targetDate} に直近を反映`);
    }

    /* =====================================================
       RENDER CALENDAR
       ===================================================== */
    function renderCalendar(year, month) {
      const tbody = document.getElementById('calendar-body');
      tbody.innerHTML = '';

      const first      = new Date(year, month - 1, 1);
      const lastDay    = new Date(year, month, 0).getDate();
      const firstWd    = first.getDay();

      const today = new Date();
      const todayY = today.getFullYear();
      const todayM = today.getMonth() + 1;
      const todayD = today.getDate();

      let row = document.createElement('tr');

      for (let i = 0; i < firstWd; i++) row.appendChild(document.createElement('td'));

      for (let day = 1; day <= lastDay; day++) {
        if (row.children.length === 7) {
          tbody.appendChild(row);
          row = document.createElement('tr');
        }

        const td      = document.createElement('td');
        const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const dbData  = attendanceData[dateStr] || null;
        const hname   = holidaysData[dateStr] || null;
        const w       = new Date(year, month - 1, day).getDay();

        let status = '未', memo = '', start = '', end = '';
        if (dbData) {
          status = dbData.status || '未';
          memo   = dbData.memo   || '';
          start  = dbData.start  || '';
          end    = dbData.end    || '';
        }

        const card = document.createElement('div');
        card.className = `day-card day-card-status-${status}`;
        if (year === todayY && month === todayM && day === todayD) card.classList.add('today-ring');
        if (selectedDateStr === dateStr) card.classList.add('selected-day');
        card.dataset.date = dateStr;

        // Header
        const header = document.createElement('div');
        header.className = 'day-header';

        const num = document.createElement('div');
        num.className = 'day-number' + (w === 0 ? ' sun' : w === 6 ? ' sat' : '');
        num.textContent = day;

        const pill = document.createElement('div');
        pill.className = `status-pill status-pill-${status}`;
        pill.textContent = status;
        const ddIcon = document.createElement('span');
        ddIcon.className = 'dropdown-icon';
        ddIcon.textContent = '▾';
        pill.appendChild(ddIcon);

        const dot = document.createElement('span');
        dot.className = 'memo-dot';
        dot.textContent = memo ? '●' : '';

        header.appendChild(num);
        header.appendChild(pill);
        header.appendChild(dot);
        card.appendChild(header);

        if (start || end) {
          const tm = document.createElement('div');
          tm.className = 'subline';
          tm.textContent = `${start || '--:--'}〜${end || '--:--'}`;
          card.appendChild(tm);
        }

        if (hname) {
          const hl = document.createElement('div');
          hl.className = 'holiday-name';
          hl.textContent = hname;
          card.appendChild(hl);
        }

        // 直近ボタン
        const actions = document.createElement('div');
        actions.className = 'cell-actions';
        const bLast = document.createElement('button');
        bLast.type = 'button';
        bLast.className = 'mini-btn';
        bLast.textContent = '直近';
        bLast.addEventListener('click', e => {
          e.stopPropagation();
          quickDuplicateLast(dateStr);
        });
        actions.appendChild(bLast);
        card.appendChild(actions);

        td.appendChild(card);
        row.appendChild(td);
      }

      if (row.children.length > 0) {
        while (row.children.length < 7) row.appendChild(document.createElement('td'));
        tbody.appendChild(row);
      }

      document.getElementById('calendar-card').classList.toggle('locked', locked);
    }

    /* =====================================================
       MODAL
       ===================================================== */
    function openModal(dateStr) {
      if (locked) return;
      currentEditDate = dateStr;

      const dbData = attendanceData[dateStr] || null;
      let status = '未', memo = '', start = '', end = '';
      if (dbData) {
        status = dbData.status || '未';
        memo   = dbData.memo   || '';
        start  = dbData.start  || '';
        end    = dbData.end    || '';
      }

      document.getElementById('modal-date-label').textContent = formatDateJP(dateStr);
      document.getElementById('memo-textarea').value  = memo;
      document.getElementById('start-time').value     = start || '09:00';
      document.getElementById('end-time').value       = end   || '18:00';

      const row = document.getElementById('status-chip-row');
      row.innerHTML = '';
      STATUS_LIST.forEach(s => {
        const chip = document.createElement('div');
        chip.className = 'status-chip' + (s === status ? ' active' : '');
        chip.textContent = s;
        chip.dataset.value = s;
        row.appendChild(chip);
      });

      document.getElementById('memo-modal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('memo-modal').classList.remove('show');
      currentEditDate = null;
    }

    function getModalStatus() {
      for (const c of document.querySelectorAll('.status-chip')) {
        if (c.classList.contains('active')) return c.dataset.value;
      }
      return '未';
    }

    function applyTemplate(t) {
      if (!t) return;
      document.querySelectorAll('.status-chip')
        .forEach(c => c.classList.toggle('active', c.dataset.value === t.status));
      document.getElementById('memo-textarea').value = t.memo  || '';
      document.getElementById('start-time').value    = t.start || '09:00';
      document.getElementById('end-time').value      = t.end   || '18:00';
    }

    /* =====================================================
       OBSIDIAN
       ===================================================== */
    function obsidianOpen(dateStr) {
      const cfg    = loadConfig();
      const vault  = (cfg.vault  || 'Phi_Memo').trim();
      const subdir = (cfg.subdir || '【業務】/勤怠').trim();
      const file   = encodeURIComponent(`${subdir}/${dateStr}.md`);
      location.href = `obsidian://open?vault=${encodeURIComponent(vault)}&file=${file}`;
    }

    /* =====================================================
       xlsx 書き出し（SheetJS）— 遅延ロード版
       ===================================================== */
    const XLSX_CDN = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
    function loadXlsxLib() {
      if (typeof XLSX !== 'undefined') return Promise.resolve();
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = XLSX_CDN;
        s.onload = resolve;
        s.onerror = () => reject(new Error('xlsx の読み込みに失敗しました'));
        document.head.appendChild(s);
      });
    }

    async function exportXlsx() {
      try { await loadXlsxLib(); } catch(e) { alert(e.message); return; }
      const store  = loadStore();
      const months = Object.keys(store.months).sort();
      if (months.length === 0) { alert('エクスポートするデータがありません'); return; }

      const wb    = XLSX.utils.book_new();
      const wdays = ['日','月','火','水','木','金','土'];

      for (const ym of months) {
        const monthData = store.months[ym];
        const header = ['日付','曜日','ステータス','開始','終了','勤務時間','祝日','メモ'];
        const rows   = [header];

        Object.keys(monthData).sort().forEach(d => {
          const rec = monthData[d];
          const dt  = new Date(d + 'T00:00:00');
          const wd  = wdays[dt.getDay()];

          // 勤務時間を計算
          let workHours = '';
          if (rec.start && rec.end) {
            const [sh, sm] = rec.start.split(':').map(Number);
            const [eh, em] = rec.end.split(':').map(Number);
            const diff = (eh * 60 + em) - (sh * 60 + sm);
            if (diff > 0) workHours = `${Math.floor(diff / 60)}:${String(diff % 60).padStart(2, '0')}`;
          }

          rows.push([
            d,
            wd,
            rec.status  || '未',
            rec.start   || '',
            rec.end     || '',
            workHours,
            holidayName(d) || '',
            rec.memo    || ''
          ]);
        });

        const ws = XLSX.utils.aoa_to_sheet(rows);
        // 列幅
        ws['!cols'] = [
          {wch:12},{wch:4},{wch:8},{wch:6},{wch:6},{wch:8},{wch:14},{wch:60}
        ];
        // ヘッダー行のスタイル（背景色など）は xlsx.full では別途要設定のため省略
        XLSX.utils.book_append_sheet(wb, ws, ym);
      }

      const fname = `kintai_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, fname);
      toast(`📊 ${fname} を書き出しました`);
    }

    document.getElementById('btn-xlsx').addEventListener('click', exportXlsx);

    /* =====================================================
       iSH版データ移行（PWA内から同一オリジンfetch）
       ===================================================== */
    document.getElementById('btn-migrate').addEventListener('click', async () => {
      if (!confirm('iSH版の全データ（4ヶ月・73件の記録）をこのアプリに取り込みます。\n既存のデータとマージします。よろしいですか？')) return;
      setLoading(true);
      try {
        const res = await fetch('./kintai_backup_2026-02-22.json', { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (!data || !data.months) throw new Error('データ形式が正しくありません');

        // 既存データとマージ（既存を優先）
        const existing = loadStore();
        const merged = { months: { ...data.months, ...existing.months } };
        saveStore(merged);

        // 月ごとの件数集計
        const months = Object.keys(data.months);
        const total  = months.reduce((s, m) => s + Object.values(data.months[m]).filter(v => v.status && v.status !== '未').length, 0);

        loadMonth(currentYear, currentMonth);
        toast(`✅ 移行完了！${months.length}ヶ月・${total}件の記録を取り込みました`);
      } catch (e) {
        alert(`取り込みに失敗しました: ${e.message}`);
      } finally {
        setLoading(false);
      }
    });

    /* =====================================================
       IMPORT / EXPORT
       ===================================================== */
    document.getElementById('btn-export').addEventListener('click', () => {
      exportJSON();
      markBackedUp();
      document.getElementById('backup-banner').classList.remove('show');
      toast('💾 JSONバックアップを保存しました');
    });

    document.getElementById('btn-import').addEventListener('click', () => {
      document.getElementById('file-import').click();
    });

    document.getElementById('file-import').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          const data = JSON.parse(ev.target.result);
          if (!data || !data.months) throw new Error('invalid format');
          if (!confirm('現在のデータを上書きしますか？（元に戻せません）')) return;
          saveStore(data);
          loadMonth(currentYear, currentMonth);
          toast('データを読み込みました');
        } catch {
          alert('ファイルの形式が正しくありません');
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    });

    /* =====================================================
       PROGRESS OVERLAY ヘルパー
       ===================================================== */
    const _overlay  = document.getElementById('progress-overlay');
    const _progBar  = document.getElementById('progress-bar');
    const _progStep = document.getElementById('progress-step');
    const _progTitle= document.getElementById('progress-title');

    function showProgress(title) {
      _progTitle.textContent = title || '処理中...';
      _progBar.style.width   = '0%';
      _progStep.textContent  = '';
      _overlay.classList.add('show');
      console.log(`[Progress] ${title}`);
    }
    function updateProgress(pct, stepMsg) {
      _progBar.style.width  = `${Math.min(pct, 100)}%`;
      _progStep.textContent = stepMsg || '';
      console.log(`[Progress] ${pct}% — ${stepMsg}`);
    }
    function hideProgress() {
      _overlay.classList.remove('show');
      console.log('[Progress] 完了');
    }

    /* =====================================================
       JINJER 同期（マージインポート）
       ===================================================== */

    // 月範囲リスト生成（'YYYY-MM' 形式）
    function _monthsInRange(start, end) {
      const result = [];
      let [y, m] = start.split('-').map(Number);
      const [ey, em] = end.split('-').map(Number);
      while (y < ey || (y === ey && m <= em)) {
        result.push(`${y}-${String(m).padStart(2,'0')}`);
        m++;
        if (m > 12) { m = 1; y++; }
      }
      return result;
    }

    // サーバーURL解決 (優先順位):
    //   1. http://localhost:PORT  — Mac 上で直接開いている場合 (同一オリジン)
    //   2. 設定の externalHttpsUrl — Tailscale Serve / Cloudflare Tunnel 固定URL
    //   3. localStorage の _cf_tunnel_url — Cloudflare Quick Tunnel (動的URL)
    //   4. http://TailscaleIP:PORT — 旧フォールバック (Chrome on Mac only)
    async function _resolveServerUrl(port) {
      // ── 1. localhost ──────────────────────────────────────────────────────────
      try {
        const ctrl = new AbortController();
        setTimeout(() => ctrl.abort(), 2000);
        const r = await fetch(`http://localhost:${port}/api/health`, { signal: ctrl.signal });
        if (r.ok) return `http://localhost:${port}`;
      } catch(_) {}

      // ── 2. 設定済み固定 HTTPS URL (Tailscale Serve / Cloudflare Tunnel) ──────
      const cfg = loadConfig();
      const extUrl = cfg.externalHttpsUrl;
      if (extUrl && extUrl.startsWith('https://')) {
        try {
          const ctrl3 = new AbortController();
          setTimeout(() => ctrl3.abort(), 4000);
          const r3 = await fetch(`${extUrl}/api/health`, { signal: ctrl3.signal });
          if (r3.ok) return extUrl;
        } catch(_) {}
      }

      // ── 3. Cloudflare Quick Tunnel — LS にキャッシュされた動的URL ────────────
      const cachedCfUrl = localStorage.getItem('_cf_tunnel_url');
      if (cachedCfUrl && cachedCfUrl.startsWith('https://')) {
        try {
          const ctrl4 = new AbortController();
          setTimeout(() => ctrl4.abort(), 5000);
          const r4 = await fetch(`${cachedCfUrl}/api/health`, { signal: ctrl4.signal });
          if (r4.ok) return cachedCfUrl;
        } catch(_) {}
        // 接続失敗 → キャッシュを削除
        localStorage.removeItem('_cf_tunnel_url');
      }

      // ── 4. Tailscale IP (HTTP) ────────────────────────────────────────────────
      const sens = await loadSensitiveData();
      if (sens.tsMac) {
        try {
          const ctrl2 = new AbortController();
          setTimeout(() => ctrl2.abort(), 2000);
          const r2 = await fetch(`http://${sens.tsMac}:${port}/api/health`, { signal: ctrl2.signal });
          if (r2.ok) return `http://${sens.tsMac}:${port}`;
        } catch(_) {}
      }
      return null;
    }

    // Cloudflare Quick Tunnel URL をサーバーから取得してキャッシュ
    async function _fetchAndCacheTunnelUrl() {
      try {
        const ctrl = new AbortController();
        setTimeout(() => ctrl.abort(), 3000);
        const r = await fetch('http://localhost:8899/api/tunnel-url', { signal: ctrl.signal });
        if (!r.ok) return;
        const data = await r.json();
        if (data.url && data.active) {
          localStorage.setItem('_cf_tunnel_url', data.url);
          _appLog('info', 'cloudflare', `Tunnel URL 取得: ${data.url}`);
        }
      } catch(_) {}
    }
    // 起動時にトンネルURL取得（30秒後 — サーバー側のトンネル起動を待つ）
    setTimeout(_fetchAndCacheTunnelUrl, 30000);

    // 全期間一括同期（開始月 ～ 今月）
    async function _doJinjerFullSync() {
      const cfg      = loadConfig();
      const statusEl = document.getElementById('jinjer-sync-status');
      const cmdBox   = document.getElementById('jinjer-sync-cmd-box');
      const optsEl   = document.getElementById('jinjer-sync-opts');
      document.getElementById('jinjer-sync-modal').classList.add('show');
      optsEl.style.display   = 'none';
      statusEl.style.display = '';
      cmdBox.style.display   = 'none';

      const port   = cfg.jinjerServerPort || '8899';
      statusEl.innerHTML = '🔍 サーバーを検索中…';

      const base = await _resolveServerUrl(port);
      if (!base) {
        statusEl.innerHTML =
          `❌ サーバーが見つかりません<br>` +
          `<span style="font-size:11px;opacity:0.8;">ローカルサーバーは常時起動中のはずです。<br>launchctl list | grep kintai.server で確認してください。</span>`;
        const cmd = `cd ~/root/attendance-pwa && python3 jinjer_server.py`;
        document.getElementById('jinjer-sync-cmd-text').textContent = cmd;
        cmdBox.style.display = '';
        document.getElementById('jinjer-sync-cmd-copy').onclick = () =>
          navigator.clipboard?.writeText(cmd).then(() => toast('📋 コピーしました'));
        document.getElementById('jinjer-sync-retry').onclick = () => _doJinjerFullSync();
        return;
      }

      const today = new Date();
      const endMonth   = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
      const startMonth = cfg.jinjerStartMonth || '2025-10';
      const months     = _monthsInRange(startMonth, endMonth);
      const modeLabel  = base.includes('localhost') ? '🖥 ローカル直接' : '🔒 Tailscale';

      statusEl.innerHTML =
        `📡 全期間一括同期中… (${modeLabel})<br>` +
        `<span style="font-size:12px;font-weight:700;">${startMonth} ～ ${endMonth}（${months.length}ヶ月）</span><br>` +
        `<span style="font-size:11px;opacity:0.7;">初回は数分かかります（Playwright起動含む）</span>`;

      try {
        const ctrl = new AbortController();
        const timeoutMs = Math.max(120000, months.length * 20000);
        setTimeout(() => ctrl.abort(), timeoutMs);

        const res = await fetch(`${base}/api/jinjer?months=${months.join(',')}`, { signal: ctrl.signal });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const jinjer = await res.json();

        const savedMonths = Object.keys(jinjer.months || {});
        document.getElementById('jinjer-sync-modal').classList.remove('show');
        await _processJinjerData(jinjer);
        toast(`✅ 全期間同期完了 ${savedMonths.length}ヶ月`);
        _appLog('info', 'jinjer', `全期間同期: ${startMonth}～${endMonth} (${savedMonths.length}ヶ月)`);
      } catch(e) {
        const isTimeout = e.name === 'AbortError';
        statusEl.innerHTML =
          `❌ 同期に失敗しました<br>` +
          `<span style="font-size:11px;opacity:0.8;">${isTimeout ? 'タイムアウト — Playwright の起動に時間がかかっています' : e.message}</span>`;
        document.getElementById('jinjer-sync-cmd-text').textContent =
          `cd ~/root/attendance-pwa && python3 jinjer_server.py`;
        cmdBox.style.display = '';
        document.getElementById('jinjer-sync-retry').onclick = () => _doJinjerFullSync();
        _appLog('warn', 'jinjer', `全期間同期失敗: ${e.message}`);
      }
    }

    async function _doJinjerAutoSync() {
      const cfg      = loadConfig();
      const statusEl = document.getElementById('jinjer-sync-status');
      const cmdBox   = document.getElementById('jinjer-sync-cmd-box');
      const optsEl   = document.getElementById('jinjer-sync-opts');
      document.getElementById('jinjer-sync-modal').classList.add('show');
      optsEl.style.display   = 'none';
      statusEl.style.display = '';
      cmdBox.style.display   = 'none';

      const port = cfg.jinjerServerPort || '8899';
      statusEl.innerHTML = '🔍 サーバーを検索中…';

      const base = await _resolveServerUrl(port);
      if (!base) {
        statusEl.innerHTML =
          `❌ サーバーが見つかりません<br>` +
          `<span style="font-size:11px;opacity:0.8;">launchd で常時起動中のはずです。ログを確認してください。</span>`;
        document.getElementById('jinjer-sync-cmd-text').textContent =
          `launchctl list | grep kintai.server`;
        cmdBox.style.display = '';
        document.getElementById('jinjer-sync-retry').onclick = () => _doJinjerAutoSync();
        return;
      }

      const today  = new Date();
      const month  = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
      const modeLabel = base.includes('localhost') ? '🖥 ローカル直接' : '🔒 Tailscale';
      statusEl.innerHTML = `📡 今月 (${month}) を同期中… (${modeLabel})`;

      try {
        const ctrl = new AbortController();
        setTimeout(() => ctrl.abort(), 120000);  // Playwright起動込みで2分
        const res = await fetch(`${base}/api/jinjer?months=${month}`, { signal: ctrl.signal });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const jinjer = await res.json();
        document.getElementById('jinjer-sync-modal').classList.remove('show');
        await _processJinjerData(jinjer);
        toast(`✅ 今月の同期完了 (${modeLabel})`);
        _appLog('info', 'jinjer', `今月同期: ${month} via ${modeLabel}`);
      } catch(e) {
        statusEl.innerHTML =
          `❌ 同期に失敗しました<br>` +
          `<span style="font-size:11px;opacity:0.8;">${e.message}</span>`;
        document.getElementById('jinjer-sync-cmd-text').textContent =
          `cd ~/root/attendance-pwa && python3 jinjer_server.py`;
        cmdBox.style.display = '';
        document.getElementById('jinjer-sync-retry').onclick = () => _doJinjerAutoSync();
        _appLog('warn', 'jinjer', `今月同期失敗: ${e.message}`);
      }
    }

    document.getElementById('btn-jinjer').addEventListener('click', () => {
      const optsEl = document.getElementById('jinjer-sync-opts');
      const statusEl = document.getElementById('jinjer-sync-status');
      const cmdBox = document.getElementById('jinjer-sync-cmd-box');
      optsEl.style.display = '';
      statusEl.style.display = 'none';
      cmdBox.style.display = 'none';
      // 全期間同期の月範囲をボタンの説明に表示
      const cfg = loadConfig();
      const today = new Date();
      const endM = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
      const startM = cfg.jinjerStartMonth || '2025-10';
      const months = _monthsInRange(startM, endM);
      document.getElementById('jinjer-sync-full-range').textContent =
        `${startM} ～ ${endM}（${months.length}ヶ月） Macから取得・iCloudに保存`;
      document.getElementById('jinjer-sync-modal').classList.add('show');
    });
    document.getElementById('jinjer-sync-opt-full').addEventListener('click', () => _doJinjerFullSync());
    document.getElementById('jinjer-sync-opt-auto').addEventListener('click', () => _doJinjerAutoSync());
    document.getElementById('jinjer-sync-opt-file').addEventListener('click', () => {
      document.getElementById('jinjer-sync-modal').classList.remove('show');
      document.getElementById('file-jinjer').click();
    });
    document.getElementById('jinjer-sync-close').addEventListener('click', () =>
      document.getElementById('jinjer-sync-modal').classList.remove('show'));

    // jinjerデータ処理（ファイル/Tailscale両方から使う共通処理）
    async function _processJinjerData(jinjer) {
      showProgress('🏢 jinjer同期');
      try {
        await tick();
        updateProgress(15, '🔍 データを解析中...');
        if (!jinjer || typeof jinjer.months !== 'object') throw new Error('months フィールドがありません');
        const monthKeys = Object.keys(jinjer.months);
        if (!monthKeys.length) throw new Error('対象データがありません');
        console.log('[jinjer] 対象月:', monthKeys);
        updateProgress(25, `📅 対象: ${monthKeys.join(', ')}`);

        await tick();
        updateProgress(35, '📖 既存データを読み込み中...');
        let store;
        try { store = loadStore(); } catch(e) { store = { months: {} }; }

        const allDays = [];
        for (const [mk, days] of Object.entries(jinjer.months)) {
          if (!store.months[mk]) store.months[mk] = {};
          for (const [dk, jd] of Object.entries(days)) allDays.push({ mk, dk, jd });
        }
        const total = allDays.length;
        const CHUNK = 7;
        let done = 0;
        for (let i = 0; i < allDays.length; i += CHUNK) {
          for (const { mk, dk, jd } of allDays.slice(i, i + CHUNK)) {
            const ex = store.months[mk][dk] || {};
            store.months[mk][dk] = { ...ex, status: jd.status || ex.status || '未', start: jd.start || ex.start || '', end: jd.end || ex.end || '', memo: ex.memo || '' };
            done++;
          }
          updateProgress(35 + Math.round((done / total) * 45), `🔄 ${done} / ${total} 日を処理中...`);
          await tick();
        }

        await tick();
        updateProgress(85, '💾 localStorage に保存中...');
        try {
          localStorage.setItem(STORE_KEY, JSON.stringify(store));
        } catch(e) {
          throw new Error('ストレージへの保存に失敗しました。空き容量を確認してください。');
        }
        updateProgress(90, '💾 IndexedDB をバックアップ中...');
        try { await idbSave(store); } catch(_) {}

        await tick();
        updateProgress(97, '🗓 カレンダーを更新中...');
        try { loadMonth(currentYear, currentMonth); } catch(_) {}

        updateProgress(100, `✅ ${done}日分の同期が完了しました！`);
        _appLog('info', 'jinjer', `同期完了: ${done}日分`);
        await new Promise(r => setTimeout(r, 900));
        hideProgress();
        toast(`✅ jinjer同期完了（${done}日分）`);
      } catch(err) {
        console.error('[jinjer]', err);
        hideProgress();
        toast(`❌ ${err.message || 'jinjer同期に失敗しました'}`);
      }
    }

    document.getElementById('file-jinjer').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) { e.target.value = ''; return; }
      e.target.value = '';
      console.log('[jinjer] ファイル開始:', file.name, file.size, 'bytes');
      const reader = new FileReader();
      reader.onload = async ev => {
        let jinjer;
        try { jinjer = JSON.parse(ev.target.result); }
        catch(e) { toast('❌ JSONの解析に失敗しました'); return; }
        await _processJinjerData(jinjer);
      };
      reader.onerror = () => toast('❌ ファイルの読み込みに失敗しました');
      reader.readAsText(file, 'utf-8');
    });

    // UIに制御を返す小さなヘルパー
    function tick() {
      return new Promise(r => setTimeout(r, 0));
    }

    /* =====================================================
       SETTINGS MODAL
       ===================================================== */
    document.getElementById('btn-settings').addEventListener('click', async () => {
      const cfg  = loadConfig();
      const sens = await loadSensitiveData();
      document.getElementById('settings-vault').value     = cfg.vault     || 'Phi_Memo';
      document.getElementById('settings-subdir').value   = cfg.subdir   || '【業務】/勤怠';
      document.getElementById('settings-jinjer-url').value = cfg.jinjerUrl || 'https://kintai.jinjer.biz/staffs/top';
      document.getElementById('settings-city').value          = cfg.city          || '';
      document.getElementById('settings-style-gender').value = cfg.styleGender   || 'メンズ';
      document.getElementById('settings-style-type').value   = cfg.styleType     || 'casual';
      document.getElementById('settings-style-color').value  = cfg.styleColor    || 'basic';
      document.getElementById('settings-ext-url').value      = cfg.externalHttpsUrl || '';
      document.getElementById('settings-ts-mac').value       = sens.tsMac     || '';
      document.getElementById('settings-ts-iphone').value    = sens.tsIphone  || '';
      document.getElementById('settings-ts-user').value      = cfg.tsUser     || '';
      document.getElementById('settings-jinjer-company').value    = cfg.jinjerCompany    || '';
      document.getElementById('settings-jinjer-email').value      = cfg.jinjerEmail      || '';
      document.getElementById('settings-jinjer-pass').value       = sens.jinjerPass      || '';
      document.getElementById('settings-jinjer-start-month').value = cfg.jinjerStartMonth || '2025-10';
      // 案件タブ設定
      document.getElementById('settings-job-skills').value = cfg.jobSkills || '';
      const activeCats = (cfg.jobCategories || '1,2,3').split(',');
      ['1','2','3','7','9'].forEach(id => {
        const el = document.getElementById('job-cat-' + id);
        if (el) el.checked = activeCats.includes(id);
      });
      const activePlatforms = (cfg.jobPlatforms || 'crowdworks,lancers').split(',');
      ['crowdworks','lancers'].forEach(p => {
        const el = document.getElementById('job-platform-' + p);
        if (el) el.checked = activePlatforms.includes(p);
      });
      updatePinUI();
      document.getElementById('settings-modal').classList.add('show');
      setTimeout(_loadCfTunnelStatus, 100);
    });

    document.getElementById('settings-close').addEventListener('click', () => {
      document.getElementById('settings-modal').classList.remove('show');
    });
    document.getElementById('settings-cancel').addEventListener('click', () => {
      document.getElementById('settings-modal').classList.remove('show');
    });
    document.getElementById('settings-save').addEventListener('click', async () => {
      const rawJinjer = document.getElementById('settings-jinjer-url').value.trim();
      const cfg = {
        vault:     document.getElementById('settings-vault').value.trim()  || 'Phi_Memo',
        subdir:    document.getElementById('settings-subdir').value.trim() || '【業務】/勤怠',
        jinjerUrl: (rawJinjer && rawJinjer.startsWith('http')) ? rawJinjer : 'https://kintai.jinjer.biz/staffs/top',
        city:        document.getElementById('settings-city').value.trim(),
        styleGender: document.getElementById('settings-style-gender').value,
        styleType:   document.getElementById('settings-style-type').value,
        styleColor:  document.getElementById('settings-style-color').value,
        tsUser:            document.getElementById('settings-ts-user').value.trim(),
        externalHttpsUrl:  document.getElementById('settings-ext-url').value.trim().replace(/\/$/, ''),
        jinjerCompany:     document.getElementById('settings-jinjer-company').value.trim(),
        jinjerEmail:       document.getElementById('settings-jinjer-email').value.trim(),
        jinjerStartMonth:  document.getElementById('settings-jinjer-start-month').value.trim() || '2025-10',
        jobSkills:     document.getElementById('settings-job-skills').value.trim(),
        jobCategories: ['1','2','3','7','9'].filter(id => document.getElementById('job-cat-'+id)?.checked).join(',') || '1,2,3',
        jobPlatforms:  ['crowdworks','lancers'].filter(p => document.getElementById('job-platform-'+p)?.checked).join(',') || 'crowdworks,lancers',
      };
      // センシティブ項目は暗号化して別途保存
      await saveSensitiveData({
        tsMac:     document.getElementById('settings-ts-mac').value.trim(),
        tsIphone:  document.getElementById('settings-ts-iphone').value.trim(),
        jinjerPass: document.getElementById('settings-jinjer-pass').value,
      });
      // 都市 or スタイルが変わったら天気キャッシュをクリアして再取得
      const prevCfg = loadConfig();
      if (prevCfg.city !== cfg.city || prevCfg.styleType !== cfg.styleType ||
          prevCfg.styleGender !== cfg.styleGender || prevCfg.styleColor !== cfg.styleColor) {
        try { localStorage.removeItem('_kintai_weather_cache'); } catch(_) {}
      }
      saveConfig(cfg);
      renderTailscaleCard();
      // jinjerカードのhrefをリアルタイム更新
      const jinjerLink = document.getElementById('jinjer-link');
      if (jinjerLink) jinjerLink.href = cfg.jinjerUrl;
      document.getElementById('settings-modal').classList.remove('show');
      toast('設定を保存しました');
    });

    // サーバーブリッジ手動復元ボタン
    document.getElementById('settings-restore-server')?.addEventListener('click', async () => {
      const btn = document.getElementById('settings-restore-server');
      btn.textContent = '⏳ 復元中...';
      btn.disabled = true;
      let restoredAny = false;
      try {
        // カレンダーデータ
        const serverKintai = await _restoreFromServer('kintai');
        if (serverKintai && Object.keys(serverKintai.months || {}).length > 0) {
          const clean = { months: serverKintai.months };
          localStorage.setItem(STORE_KEY, JSON.stringify(clean));
          await idbSave(clean);
          restoredAny = true;
        }
        // タスク
        const serverTasks = await _restoreFromServer('tasks');
        const tasks = serverTasks?.tasks;
        if (Array.isArray(tasks) && tasks.length > 0) {
          localStorage.setItem(TASKS_KEY, JSON.stringify(tasks));
          await idbSaveTasksUnified(tasks);
          restoredAny = true;
        }
        if (restoredAny) {
          toast('✅ サーバーブリッジからデータを復元しました。ページを再読み込みします...');
          setTimeout(() => location.reload(), 1500);
        } else {
          toast('⚠ サーバーにデータが見つかりません。先に元のURLでページを開いてください。');
        }
      } catch(e) {
        toast(`❌ 復元失敗: ${e.message}`);
      } finally {
        btn.textContent = '☁️ サーバーブリッジからデータを手動復元（別端末・別URLからの移行）';
        btn.disabled = false;
      }
    });

    // ── Cloudflare Tunnel 状態UI ──────────────────────────────────────────────
    async function _loadCfTunnelStatus() {
      const urlText = document.getElementById('cf-tunnel-url-text');
      const qrWrap  = document.getElementById('cf-tunnel-qr-wrap');
      const copyBtn = document.getElementById('cf-tunnel-copy-btn');
      const useBtn  = document.getElementById('cf-tunnel-use-btn');
      if (!urlText) return;

      // まずサーバーから最新 URL を取得
      let tunnelUrl = '';
      try {
        const r = await fetch('http://localhost:8899/api/tunnel-url',
                              { signal: AbortSignal.timeout(3000) });
        if (r.ok) {
          const d = await r.json();
          if (d.url && d.active) {
            tunnelUrl = d.url;
            localStorage.setItem('_cf_tunnel_url', tunnelUrl);
          }
        }
      } catch(_) {}

      // サーバーから取れなければ LS キャッシュを使用
      if (!tunnelUrl) tunnelUrl = localStorage.getItem('_cf_tunnel_url') || '';

      if (tunnelUrl) {
        urlText.innerHTML = `<span style="color:var(--accent-blue);font-weight:700;">✅ アクティブ</span><br>
          <span style="font-size:11px;word-break:break-all;">${_esc(tunnelUrl)}</span>`;
        qrWrap.style.display = '';
        copyBtn.style.display = '';
        useBtn.style.display  = '';

        // QR コード描画（シンプル実装 — qrcode-generator ライブラリ不要）
        _drawQR(document.getElementById('cf-tunnel-qr'), tunnelUrl);

        copyBtn.onclick = () => {
          navigator.clipboard.writeText(tunnelUrl).then(() => toast('📋 URLコピーしました'));
        };
        useBtn.onclick = () => {
          document.getElementById('settings-ext-url').value = tunnelUrl;
          toast('✓ 外部HTTPS URLに設定しました。保存してください。');
        };
      } else {
        urlText.innerHTML = '<span style="color:var(--text-muted);">⏳ サーバー起動後30秒でトンネルが開始されます。<br>それ以降に「🔄 更新」を押してください。</span>';
        qrWrap.style.display = 'none';
        copyBtn.style.display = 'none';
        useBtn.style.display  = 'none';
      }
    }

    // QR コード描画（qrcodejs ライブラリ使用）
    function _drawQR(canvas, text) {
      if (!canvas) return;
      const wrap = canvas.parentElement;
      // canvas を div に差し替えて QRCode ライブラリに渡す
      const div = document.createElement('div');
      div.id = 'cf-tunnel-qr-div';
      div.style.cssText = 'display:inline-block;background:#fff;padding:6px;border-radius:8px;';
      wrap.replaceChild(div, canvas);
      if (typeof QRCode !== 'undefined') {
        new QRCode(div, { text, width: 148, height: 148, correctLevel: QRCode.CorrectLevel.M });
      } else {
        div.textContent = 'QRコードを読み込み中...';
        // ライブラリロード後に再試行
        setTimeout(() => {
          if (typeof QRCode !== 'undefined') {
            div.textContent = '';
            new QRCode(div, { text, width: 148, height: 148, correctLevel: QRCode.CorrectLevel.M });
          }
        }, 2000);
      }
    }

    document.getElementById('cf-tunnel-refresh-btn')?.addEventListener('click', _loadCfTunnelStatus);

    // 設定モーダルが開くたびに Tunnel 状態を更新（btn-settings click handler 内で直接呼び出し）

    // 外部HTTPS URL 自動検出ボタン
    document.getElementById('settings-ext-url-detect')?.addEventListener('click', async () => {
      const btn = document.getElementById('settings-ext-url-detect');
      btn.textContent = '⏳…';
      btn.disabled = true;
      try {
        const r = await fetch('http://localhost:8899/api/tailscale-url', { signal: AbortSignal.timeout(6000) });
        if (r.ok) {
          const data = await r.json();
          if (data.https_url) {
            document.getElementById('settings-ext-url').value = data.https_url;
            toast(`✅ 検出: ${data.https_url}`);
          } else {
            toast('⚠ Tailscale URL が見つかりません。先に "tailscale serve --bg 8899" を実行してください。');
          }
        } else {
          throw new Error(`HTTP ${r.status}`);
        }
      } catch(e) {
        toast('❌ ローカルサーバーに接続できません。http://localhost:8899/ を開いて設定してください。');
      } finally {
        btn.textContent = '🔍 自動検出';
        btn.disabled = false;
      }
    });

    /* =====================================================
       EVENT HANDLERS
       ===================================================== */

    // Calendar click → open modal
    document.addEventListener('click', ev => {
      const card = ev.target.closest('.day-card');
      if (card && !locked) {
        const dateStr = card.dataset.date;
        if (!dateStr) return;
        selectedDateStr = dateStr;
        document.querySelectorAll('.day-card.selected-day')
          .forEach(c => c.classList.remove('selected-day'));
        card.classList.add('selected-day');
        openModal(dateStr);
        return;
      }

      // Status chip
      const chip = ev.target.closest('.status-chip');
      if (chip && document.getElementById('memo-modal').classList.contains('show')) {
        document.querySelectorAll('.status-chip').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        return;
      }

      // Backdrop close
      const mModal = document.getElementById('memo-modal');
      if (mModal.classList.contains('show') && ev.target === mModal) { closeModal(); return; }
      const sModal = document.getElementById('settings-modal');
      if (sModal.classList.contains('show') && ev.target === sModal) {
        sModal.classList.remove('show');
      }
    });

    document.getElementById('modal-close').addEventListener('click', closeModal);
    document.getElementById('modal-cancel').addEventListener('click', closeModal);

    // Save
    document.getElementById('modal-save').addEventListener('click', () => {
      if (!currentEditDate) return;
      const status = getModalStatus();
      const memo   = document.getElementById('memo-textarea').value;
      const start  = document.getElementById('start-time').value || '';
      const end    = document.getElementById('end-time').value   || '';
      const ok = saveAttendance(currentEditDate, status, memo, start, end);
      if (ok) { closeModal(); toast('保存しました'); }
    });

    // Duplicate: last template
    document.getElementById('btn-dup-last').addEventListener('click', () => {
      const t = getLastTemplate();
      if (!t) { alert('直近テンプレがありません'); return; }
      applyTemplate(t);
    });

    // Duplicate: prev day
    document.getElementById('btn-dup-prev').addEventListener('click', () => {
      if (!currentEditDate) return;
      const p = prevDateStr(currentEditDate);
      const prev = attendanceData[p];
      if (!prev) { alert('前日のデータがありません'); return; }
      applyTemplate(prev);
    });

    // Obsidian
    document.getElementById('btn-obs-open').addEventListener('click', () => {
      if (!currentEditDate) return;
      obsidianOpen(currentEditDate);
    });

    // Month navigation
    document.getElementById('prev-month').addEventListener('click', () => {
      let y = currentYear, m = currentMonth - 1;
      if (m === 0) { m = 12; y--; }
      loadMonth(y, m);
    });
    document.getElementById('next-month').addEventListener('click', () => {
      let y = currentYear, m = currentMonth + 1;
      if (m === 13) { m = 1; y++; }
      loadMonth(y, m);
    });
    document.getElementById('today-button').addEventListener('click', () => {
      const t = new Date();
      loadMonth(t.getFullYear(), t.getMonth() + 1);
    });

    // Lock
    document.getElementById('lock-toggle').addEventListener('click', () => {
      locked = !locked;
      const btn   = document.getElementById('lock-toggle');
      const label = document.getElementById('lock-label');
      btn.classList.toggle('pill-button-lock-on', locked);
      label.textContent = locked ? 'ロック中' : 'ロック';
      document.getElementById('calendar-card').classList.toggle('locked', locked);
    });

    // Install banner
    const installBanner = document.getElementById('install-banner');
    const isStandalone  = window.matchMedia('(display-mode: standalone)').matches
                       || navigator.standalone === true;
    const bannerDismissed = sessionStorage.getItem('install_banner_dismissed');
    if (!isStandalone && !bannerDismissed) {
      installBanner.classList.add('show');
    }
    document.getElementById('install-close').addEventListener('click', () => {
      installBanner.classList.remove('show');
      sessionStorage.setItem('install_banner_dismissed', '1');
    });

    /* =====================================================
       MONTHLY STATS
       ===================================================== */
    function calcMonthStats(year, month) {
      const ym   = `${year}-${String(month).padStart(2,'0')}`;
      const raw  = loadStore().months[ym] || {};
      let office = 0, home = 0, off = 0, totalMin = 0;

      Object.values(raw).forEach(rec => {
        const { data } = applyAutoRules({ [rec.date]: rec });
        const st = data[rec.date]?.status || '未';
        if (st === '出社')                           office++;
        else if (st === '在宅')                      home++;
        else if (['休み','休日','祝日'].includes(st)) off++;

        if (rec.start && rec.end) {
          const [sh, sm] = rec.start.split(':').map(Number);
          const [eh, em] = rec.end.split(':').map(Number);
          const d = (eh * 60 + em) - (sh * 60 + sm);
          if (d > 0) totalMin += d;
        }
      });

      const h = Math.floor(totalMin / 60);
      const m = totalMin % 60;
      return { office, home, off, hours: h, mins: m };
    }

    function renderStats(year, month) {
      const s = calcMonthStats(year, month);
      document.getElementById('stat-office').textContent = s.office;
      document.getElementById('stat-home').textContent   = s.home;
      document.getElementById('stat-off').textContent    = s.off;
      document.getElementById('stat-hours').textContent  =
        s.hours > 0 ? `${s.hours}h${s.mins > 0 ? s.mins + 'm' : ''}` : '0h';
      renderWeeklyStats(year, month);
    }

    /* =====================================================
       WEEKLY PERSON-MONTH STATS  (1人月 = 8h)
       ===================================================== */
    function calcWeeklyStats(year, month) {
      const ym      = `${year}-${String(month).padStart(2,'0')}`;
      const raw     = loadStore().months[ym] || {};
      const lastDay = new Date(year, month, 0).getDate();
      const firstWd = new Date(year, month - 1, 1).getDay(); // 0=Sun
      const pad2    = n => String(n).padStart(2,'0');
      const weeks   = [];
      let wStart = 1, wMin = 0;

      for (let day = 1; day <= lastDay; day++) {
        const dk  = `${ym}-${pad2(day)}`;
        const rec = raw[dk];
        if (rec && rec.start && rec.end) {
          const [sh, sm] = rec.start.split(':').map(Number);
          const [eh, em] = rec.end.split(':').map(Number);
          const d = (eh * 60 + em) - (sh * 60 + sm);
          if (d > 0) wMin += d;
        }
        const gridPos = (firstWd + day - 1) % 7; // 0=Sun … 6=Sat
        if (gridPos === 6 || day === lastDay) {
          weeks.push({ start: wStart, end: day, minutes: wMin });
          wStart = day + 1;
          wMin   = 0;
        }
      }
      return weeks;
    }

    function renderWeeklyStats(year, month) {
      const el    = document.getElementById('weekly-stats');
      const weeks = calcWeeklyStats(year, month);
      const pad2  = n => String(n).padStart(2,'0');
      const mm    = String(month).padStart(2,'0');
      // 最大分数（バー比率用）
      const maxMin = Math.max(...weeks.map(w => w.minutes), 1);

      let html = '<table>';
      weeks.forEach((w, i) => {
        const h   = Math.floor(w.minutes / 60);
        const m   = w.minutes % 60;
        const pm  = (w.minutes / 60 / 8).toFixed(2);
        const pct = Math.round(w.minutes / maxMin * 100);
        const lbl = `W${i+1} ${mm}/${pad2(w.start)}〜${mm}/${pad2(w.end)}`;
        const hStr = w.minutes > 0 ? `${h}h${m > 0 ? m+'m' : ''}` : '—';
        html += `<tr>
          <td class="w-label">${lbl}</td>
          <td class="w-hours">${hStr}</td>
          <td class="w-bar-cell"><div class="w-bar-bg"><div class="w-bar-fill" style="width:${pct}%"></div></div></td>
          <td class="w-pm">${w.minutes > 0 ? pm+'人月' : '—'}</td>
        </tr>`;
      });
      html += '</table>';
      el.innerHTML = html;
    }

    /* =====================================================
       AUTO BACKUP SYSTEM
       ===================================================== */
    const BACKUP_KEY           = 'kintai_last_backup';
    const BACKUP_INTERVAL_DAYS = 7;

    function daysSinceBackup() {
      const last = localStorage.getItem(BACKUP_KEY);
      if (!last) return 999;
      return Math.floor((Date.now() - parseInt(last)) / 86400000);
    }

    function markBackedUp() {
      localStorage.setItem(BACKUP_KEY, Date.now().toString());
    }

    function checkBackupReminder() {
      const days = daysSinceBackup();
      if (days >= BACKUP_INTERVAL_DAYS) {
        const msg = days >= 999
          ? 'まだバックアップが作成されていません'
          : `前回のバックアップから <strong>${days}日</strong> 経過しています`;
        document.getElementById('backup-days-msg').innerHTML = msg;
        document.getElementById('backup-banner').classList.add('show');
      }
    }

    // JSON ダウンロード（単体）
    function exportJSON() {
      const store = loadStore();
      const blob  = new Blob([JSON.stringify(store, null, 2)], { type: 'application/json' });
      const a     = document.createElement('a');
      a.href      = URL.createObjectURL(blob);
      a.download  = `kintai_backup_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // JSON + xlsx を連続ダウンロード（一括バックアップ）
    async function oneClickBackup() {
      exportJSON();
      markBackedUp();
      document.getElementById('backup-banner').classList.remove('show');
      toast('✅ JSON + xlsx を保存します...');
      await new Promise(r => setTimeout(r, 800)); // iOS で同時DLが詰まらないよう少し間隔を置く
      await exportXlsx();
    }

    document.getElementById('btn-backup-now').addEventListener('click', oneClickBackup);
    document.getElementById('weekly-toggle').addEventListener('click', () => {
      const el    = document.getElementById('weekly-stats');
      const arrow = document.getElementById('weekly-arrow');
      const open  = el.classList.toggle('open');
      arrow.textContent = open ? '▴' : '▾';
    });
    document.getElementById('backup-dismiss').addEventListener('click', () => {
      document.getElementById('backup-banner').classList.remove('show');
    });

    // アプリが前面に来るたびにチェック
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') checkBackupReminder();
    });

    /* =====================================================
       SWIPE GESTURE（左右スワイプで月切り替え）
       ===================================================== */
    let _swipeX = 0, _swipeY = 0, _swipeOnCal = false;
    document.getElementById('calendar-card').addEventListener('touchstart', e => {
      _swipeX = e.touches[0].clientX;
      _swipeY = e.touches[0].clientY;
      // カレンダーグリッド上のタッチのみ月スワイプを有効化（他領域では無効）
      _swipeOnCal = !!e.target.closest('.calendar-wrapper');
    }, { passive: true });

    document.getElementById('calendar-card').addEventListener('touchend', e => {
      if (!_swipeOnCal) return; // カレンダーグリッド外のスワイプは月移動しない
      const dx = e.changedTouches[0].clientX - _swipeX;
      const dy = e.changedTouches[0].clientY - _swipeY;
      if (Math.abs(dx) < 50 || Math.abs(dx) < Math.abs(dy) * 1.2) return; // 縦スクロールを除外
      if (dx < 0) {
        // 左スワイプ → 次月
        let y = currentYear, m = currentMonth + 1;
        if (m === 13) { m = 1; y++; }
        loadMonth(y, m);
      } else {
        // 右スワイプ → 前月
        let y = currentYear, m = currentMonth - 1;
        if (m === 0) { m = 12; y--; }
        loadMonth(y, m);
      }
    }, { passive: true });

    /* =====================================================
       FLOATING TODAY BUTTON
       ===================================================== */
    (function initFab() {
      const t   = new Date();
      const fab = document.getElementById('fab-today');
      document.getElementById('fab-day').textContent = t.getDate();

      fab.addEventListener('click', () => {
        const today = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;
        // 今月でなければ今月へ移動してからモーダルを開く
        if (currentYear !== t.getFullYear() || currentMonth !== t.getMonth() + 1) {
          loadMonth(t.getFullYear(), t.getMonth() + 1);
          setTimeout(() => openModal(today), 150);
        } else {
          openModal(today);
        }
      });

      // モーダルが開いているときは隠す
      const observer = new MutationObserver(() => {
        const modalOpen = document.getElementById('memo-modal').classList.contains('show')
                       || document.getElementById('settings-modal').classList.contains('show');
        fab.classList.toggle('hidden', modalOpen);
      });
      observer.observe(document.getElementById('memo-modal'),     { attributes: true });
      observer.observe(document.getElementById('settings-modal'), { attributes: true });
    })();

    /* =====================================================
       GENERATE APP ICON (canvas → apple-touch-icon)
       ===================================================== */
    (function generateIcon() {
      try {
        const c   = document.createElement('canvas');
        c.width   = 192;
        c.height  = 192;
        const ctx = c.getContext('2d');
        // Background
        ctx.fillStyle = '#4f8dfd';
        ctx.beginPath();
        ctx.roundRect(0, 0, 192, 192, 36);
        ctx.fill();
        // Text
        ctx.fillStyle = '#ffffff';
        ctx.font = 'bold 90px -apple-system, "Helvetica Neue", sans-serif';
        ctx.textAlign    = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('勤', 96, 102);
        document.getElementById('apple-touch-icon-link').href = c.toDataURL('image/png');
      } catch (_) {}
    })();

    /* =====================================================
       INIT
       ===================================================== */
    (async function init() {
      try {
        const t = new Date();
        // 起動直後: LS に devId があれば IDB にも保存しておく（将来の復元用）
        try {
          const currentDevId = localStorage.getItem(_DEV_ID_KEY);
          if (currentDevId) {
            idbLoadConfig().then(cfg => {
              if (!cfg?._dev_id) idbSaveConfig({ ...(cfg||{}), _dev_id: currentDevId });
            }).catch(()=>{});
          }
        } catch(_) {}
        // IDB復元（失敗しても続行）
        let restored = false;
        try { restored = await restoreFromIDBIfNeeded(); } catch(e) { console.warn('[init] IDB復元スキップ:', e); }
        // カレンダー描画（失敗しても続行）
        try { loadMonth(t.getFullYear(), t.getMonth() + 1); } catch(e) { console.warn('[init] loadMonth失敗:', e); }
        if (restored) {
          try { renderCalendar(t.getFullYear(), t.getMonth() + 1); } catch(e) {}
          try { renderStats(t.getFullYear(), t.getMonth() + 1); }  catch(e) {}
        }
        try { checkBackupReminder(); } catch(e) {}
        // ヘルスチェック（非同期）
        try { runHealthCheck(); } catch(e) {}
        // 天気取得（カレンダーミニバナー用、失敗しても続行）
        try { renderWeather(false); } catch(e) {}
        // 起動成功 → クラッシュカウンタをリセット
        localStorage.setItem(_CRASH_KEY, '0');
        _appLog('info', 'init', '起動完了');
        try { renderTailscaleCard(); } catch(e) {}
        // 初回スナップショット（起動時に1回）
        try {
          const store = loadStore();
          if (Object.keys(store.months || {}).length > 0) {
            const lastSnap = localStorage.getItem('_kintai_snap_last') || '0';
            if (Date.now() - Number(lastSnap) > 5 * 60 * 1000) { // 5分超なら保存
              saveSnapshot(store);
              localStorage.setItem('_kintai_snap_last', String(Date.now()));
            }
          }
        } catch(e) {}
      } catch(fatal) {
        console.error('[init] 致命的エラー:', fatal);
      }
    })();

    // 定期 IDB バックアップ: 5分ごとに現在の LS データを IDB に書き込む
    setInterval(() => {
      try {
        const store = loadStore();
        if (Object.keys(store.months || {}).length > 0) idbSave(store);
        const tasks = typeof loadTasks === 'function' ? loadTasks() : null;
        if (tasks?.length) idbSaveTasksUnified(tasks);
      } catch(_) {}
    }, 5 * 60 * 1000);

    /* =====================================================
       NETWORK STATUS MONITOR（オフライン/オンライン通知）
       ===================================================== */
    (function initNetworkMonitor() {
      const banner = document.getElementById('net-banner');
      let hideTimer = null;

      function showBanner(msg, type, autohide = true) {
        banner.textContent = msg;
        banner.className = `net-banner show ${type}`;
        clearTimeout(hideTimer);
        if (autohide) hideTimer = setTimeout(() => banner.classList.remove('show'), 2800);
      }

      window.addEventListener('online',  () => showBanner('✅ オンラインに復帰しました', 'online'));
      window.addEventListener('offline', () => showBanner('📵 オフラインです — ローカルデータで動作中', 'offline', false));

      // 初期状態がオフラインの場合
      if (!navigator.onLine) showBanner('📵 オフラインです — ローカルデータで動作中', 'offline', false);
    })();

    /* =====================================================
       サーバーハートビート — 適応型インターバル (接続中30s / 未接続10s)
       _resolveServerUrl() でlocalhost→外部HTTPS→TailscaleIPを順番に試し
       成功した URL を window._srvBase にキャッシュして全タブで共有する。
       ===================================================== */
    (function initServerHeartbeat() {
      let _cachedBase  = null; // 最後に成功したサーバーベース URL
      let _lastResolve = 0;    // 解決成功タイムスタンプ (ms)
      const CACHE_TTL  = 5 * 60 * 1000; // 5 分間キャッシュ有効

      // キャッシュ付き URL 解決: 5分以内に成功していれば直接 ping、
      // 失敗 or 期限切れなら _resolveServerUrl() で全候補を再試行する。
      async function _pingSrv() {
        const now = Date.now();
        if (_cachedBase && (now - _lastResolve) < CACHE_TTL) {
          try {
            const r = await fetch(`${_cachedBase}/api/health`,
              { signal: AbortSignal.timeout(3000) });
            if (r.ok) return true;
          } catch(_) {}
          // キャッシュ URL が応答しなかった → 再解決へ
        }
        const base = await _resolveServerUrl(8899);
        if (base) {
          _cachedBase = base;
          _lastResolve = now;
          window._srvBase = base; // 全タブが参照するグローバルを更新
          return true;
        }
        _cachedBase = null;
        return false;
      }

      function _updateSrvDot(alive) {
        const dot = document.getElementById('health-dot-srv');
        const txt = document.getElementById('health-srv');
        if (!dot) return;
        dot.className = 'health-dot ' + (alive ? 'health-dot-ok' : 'health-dot-error');
        if (txt) txt.textContent = `SRV: ${alive ? '✓' : '✗'}`;
      }

      async function _tick() {
        try {
          const alive = await _pingSrv();
          const justRecovered = (alive && _srvAlive === false);
          _srvAlive = alive;
          _updateSrvDot(alive);

          if (justRecovered) {
            // ──── サーバー復旧: 各タブを自動リロード ────

            // 報告書タブ: バナー非表示 + データ再ロード
            if (!_reportServerOk) {
              (async () => {
                await checkReportServer();
                const b = document.getElementById('report-server-banner');
                if (b) b.style.display = _reportServerOk ? 'none' : 'block';
                if (_reportServerOk) { try { await loadReportList(); } catch(e) {} }
              })();
            }

            // 案件タブ: バナー非表示 + データ再ロード
            const jb = document.getElementById('jobs-server-banner');
            if (jb && jb.style.display !== 'none') {
              _jobsData = null;
              try { _loadJobsData(); } catch(e) {}
            }
          }
        } catch(e) {
          console.warn('[heartbeat] _tick error:', e);
          _srvAlive = false;
          _updateSrvDot(false);
        } finally {
          // 必ずスケジュール: 未接続 10s / 接続中 30s
          setTimeout(_tick, _srvAlive ? 30000 : 10000);
        }
      }

      // ページロード直後に即座に解決を試みる（5s待ちをなくす）
      _tick();
    })();

    /* =====================================================
       ファイルブラウザ（システム情報カード → ファイル参照）
       ===================================================== */
    (function initFileBrowser() {
      const _getApi = () => window._srvBase || 'http://localhost:8899';
      let _files = null;

      // ── ファイル一覧取得 ──────────────────────────────────────
      async function _fetchFiles() {
        try {
          const r = await fetch(`${_getApi()}/api/files`, { signal: AbortSignal.timeout(5000) });
          if (!r.ok) throw new Error('HTTP ' + r.status);
          const d = await r.json();
          return d.files.filter(f => !f.is_dir);
        } catch { return null; }
      }

      // ── ファイル種別アイコン ──────────────────────────────────
      function _icon(path) {
        const ext = path.split('.').pop().toLowerCase();
        return { py:'🐍', html:'🌐', js:'⚡', md:'📝', json:'📊', log:'📋',
                 sh:'🔧', yml:'⚙️', plist:'⚙️', txt:'📄', env:'🔐',
                 gitignore:'🚫', css:'🎨' }[ext] || '📄';
      }

      // ── ドロップダウン構築 ────────────────────────────────────
      function _buildSelect(files) {
        const sel = document.getElementById('filebrowser-select');
        if (!sel) return;
        const byDir = {};
        files.forEach(f => {
          const idx = f.path.lastIndexOf('/');
          const dir = idx >= 0 ? f.path.slice(0, idx) : '';
          (byDir[dir] = byDir[dir] || []).push(f);
        });
        sel.innerHTML = '';
        Object.keys(byDir).sort().forEach(dir => {
          const grp = document.createElement('optgroup');
          grp.label = dir || '(root)';
          byDir[dir].forEach(f => {
            const opt = document.createElement('option');
            opt.value = f.path;
            const name = f.path.split('/').pop();
            const kb = f.size > 0 ? ` ${(f.size/1024).toFixed(1)}KB` : '';
            opt.textContent = `${_icon(f.path)} ${name}${kb}`;
            grp.appendChild(opt);
          });
          sel.appendChild(grp);
        });
      }

      // ── ファイル内容取得・表示 ────────────────────────────────
      async function _showFile(path) {
        const pre  = document.getElementById('filebrowser-content');
        const meta = document.getElementById('filebrowser-meta');
        if (!pre) return;
        pre.textContent = '読み込み中…';
        if (meta) meta.textContent = '';
        try {
          const r = await fetch(`${_getApi()}/api/files/read?path=${encodeURIComponent(path)}`,
            { signal: AbortSignal.timeout(10000) });
          const d = await r.json();
          if (d.error) {
            pre.textContent = `⚠️ ${d.error}`;
          } else {
            pre.textContent = d.content + (d.truncated ? '\n\n… (先頭200KB のみ表示)' : '');
            if (meta) meta.textContent =
              `${path}  |  ${(d.size/1024).toFixed(1)}KB${d.truncated ? '  |  ⚠️ 省略あり' : ''}`;
          }
        } catch(e) {
          pre.textContent = `❌ エラー: ${e.message}`;
        }
      }

      // ── モーダルを開く ────────────────────────────────────────
      async function openFileBrowser(initialPath) {
        const modal = document.getElementById('filebrowser-modal');
        if (!modal) return;
        modal.classList.add('show');

        if (!_files) {
          const sel = document.getElementById('filebrowser-select');
          if (sel) sel.innerHTML = '<option>読み込み中…</option>';
          _files = await _fetchFiles();
        }
        if (_files) {
          _buildSelect(_files);
          const sel = document.getElementById('filebrowser-select');
          if (sel && initialPath) {
            sel.value = initialPath;
            if (!sel.value) sel.selectedIndex = 0;
          }
          const target = sel ? sel.value : initialPath;
          if (target) _showFile(target);
        } else {
          const pre = document.getElementById('filebrowser-content');
          if (pre) pre.textContent = '⚠️ サーバーに接続できません (port 8899)';
        }
      }

      // ── イベント登録 ──────────────────────────────────────────
      window.addEventListener('load', () => {
        document.getElementById('sysinfo-open-btn')?.addEventListener('click',
          () => openFileBrowser(null));
        document.getElementById('sysinfo-structure-btn')?.addEventListener('click',
          () => openFileBrowser('STRUCTURE.md'));
        document.getElementById('filebrowser-close')?.addEventListener('click', () =>
          document.getElementById('filebrowser-modal')?.classList.remove('show'));
        document.getElementById('filebrowser-select')?.addEventListener('change', function() {
          if (this.value) _showFile(this.value);
        });
        document.getElementById('filebrowser-refresh')?.addEventListener('click', async () => {
          _files = null;
          const sel = document.getElementById('filebrowser-select');
          const cur = sel?.value;
          await openFileBrowser(cur || null);
        });

        // システム情報カードのサマリー更新（起動5秒後）
        setTimeout(async () => {
          const el = document.getElementById('sysinfo-summary');
          if (!el) return;
          try {
            const r = await fetch(`${_getApi()}/api/structure`, { signal: AbortSignal.timeout(3000) });
            if (r.ok) {
              const txt = await r.text();
              const m   = txt.match(/最終更新: (.+)/);
              const cnt = (txt.match(/^\| `[^`]+`/gm) || []).length;
              el.textContent = `📅 最終更新: ${m ? m[1].trim() : '不明'}  |  ${cnt}ファイル`;
            } else { el.textContent = '⚠️ サーバー未接続'; }
          } catch { el.textContent = '⚠️ サーバー未接続'; }
        }, 5000);
      });

      window.openFileBrowser = openFileBrowser;
    })();

    /* =====================================================
       KEYBOARD SHORTCUTS（パワーユーザー向け）
       ===================================================== */
    document.addEventListener('keydown', e => {
      // モーダル・入力中は無効
      const tag = document.activeElement?.tagName;
      if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

      const memoOpen  = document.getElementById('memo-modal')?.classList.contains('show');
      const taskOpen  = document.getElementById('task-modal')?.classList.contains('show');
      const setsOpen  = document.getElementById('settings-modal')?.classList.contains('show');
      const anyModal  = memoOpen || taskOpen || setsOpen;

      if (e.key === 'Escape' && anyModal) {
        // ESC でモーダルを閉じる
        if (memoOpen) document.getElementById('memo-modal').classList.remove('show');
        if (taskOpen) document.getElementById('task-modal').classList.remove('show');
        if (setsOpen) document.getElementById('settings-modal').classList.remove('show');
        return;
      }
      if (anyModal) return;

      if (e.key === 'ArrowLeft'  && !e.metaKey) { e.preventDefault(); document.getElementById('prev-month')?.click(); }
      if (e.key === 'ArrowRight' && !e.metaKey) { e.preventDefault(); document.getElementById('next-month')?.click(); }
      if (e.key === 't' || e.key === 'T')        document.getElementById('today-button')?.click();
    });

    /* =====================================================
       TASK MANAGEMENT
       ===================================================== */
    function loadTasks() {
      try { return JSON.parse(localStorage.getItem(TASKS_KEY) || '[]'); } catch { return []; }
    }

    function saveTasks(tasks) {
      localStorage.setItem(TASKS_KEY, JSON.stringify(tasks));
      window._taskIdbBackup?.(tasks); // 非同期 IDB バックアップ
      _syncDataToServer('tasks', { tasks }); // サーバーブリッジ (非同期)
    }

    function _esc(s) {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function taskItemHTML(t) {
      const memoHTML = t.memo ? `<div class="task-memo">${_esc(t.memo)}</div>` : '';
      return `<div class="task-item${t.done ? ' done' : ''}">
        <input type="checkbox" class="task-check" data-id="${t.id}" ${t.done ? 'checked' : ''}>
        <div class="task-body">
          <div class="task-title">${_esc(t.title)}</div>${memoHTML}
        </div>
        <button class="task-del" data-id="${t.id}" title="削除">🗑</button>
      </div>`;
    }

    function renderTaskList() {
      const tasks     = loadTasks();
      const container = document.getElementById('task-list-container');
      const todo      = tasks.filter(t => !t.done);
      const done      = tasks.filter(t => t.done);
      let html = '';
      if (!todo.length && !done.length) {
        html = '<div class="task-empty">タスクはまだありません<br>上のフォームから追加できます</div>';
      } else {
        if (todo.length) html += '<div class="task-section-title">未完了</div><div class="task-list">' + todo.map(taskItemHTML).join('') + '</div>';
        if (done.length) html += '<div class="task-section-title">完了済み</div><div class="task-list">' + done.map(taskItemHTML).join('') + '</div>';
      }
      container.innerHTML = html;

      container.querySelectorAll('.task-check').forEach(cb => {
        cb.addEventListener('change', () => {
          const ts = loadTasks();
          const idx = ts.findIndex(t => t.id === cb.dataset.id);
          if (idx !== -1) { ts[idx].done = cb.checked; saveTasks(ts); renderTaskList(); }
        });
      });
      container.querySelectorAll('.task-del').forEach(btn => {
        btn.addEventListener('click', () => {
          if (!confirm('このタスクを削除しますか？')) return;
          saveTasks(loadTasks().filter(t => t.id !== btn.dataset.id));
          renderTaskList();
        });
      });
    }

    (function initTaskModal() {
      const modal    = document.getElementById('task-modal');
      const fab      = document.getElementById('fab-task');
      const closeBtn = document.getElementById('task-modal-close');
      const addBtn   = document.getElementById('task-add-btn');
      const titleIn  = document.getElementById('task-title-input');
      const memoIn   = document.getElementById('task-memo-input');

      function openTaskModal() {
        modal.classList.add('show');
        renderTaskList();
        setTimeout(() => titleIn.focus(), 100);
      }
      function closeTaskModal() {
        modal.classList.remove('show');
        titleIn.value = '';
        memoIn.value  = '';
      }

      fab.addEventListener('click', openTaskModal);
      closeBtn.addEventListener('click', closeTaskModal);
      modal.addEventListener('click', e => { if (e.target === modal) closeTaskModal(); });

      addBtn.addEventListener('click', () => {
        const title = titleIn.value.trim();
        if (!title) { toast('タスク名を入力してください'); titleIn.focus(); return; }
        const ts = loadTasks();
        ts.unshift({ id: Date.now().toString(), title, memo: memoIn.value.trim(), done: false, created: new Date().toISOString() });
        saveTasks(ts);
        titleIn.value = '';
        memoIn.value  = '';
        renderTaskList();
        toast('✅ タスクを追加しました');
      });

      titleIn.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); addBtn.click(); }
      });

      // fab-task は memo-modal / settings-modal が開いているとき隠す
      const fabToday = document.getElementById('fab-today');
      const hideOnOtherModal = new MutationObserver(() => {
        const anyOther = document.getElementById('memo-modal').classList.contains('show')
                      || document.getElementById('settings-modal').classList.contains('show');
        fab.classList.toggle('hidden', anyOther);
      });
      hideOnOtherModal.observe(document.getElementById('memo-modal'),     { attributes: true });
      hideOnOtherModal.observe(document.getElementById('settings-modal'), { attributes: true });

      // fab-today は task-modal が開いているとき隠す
      new MutationObserver(() => {
        const open = modal.classList.contains('show');
        fabToday.classList.toggle('hidden', open);
        fab.classList.toggle('hidden', open);
      }).observe(modal, { attributes: true });
    })();

    /* =====================================================
       TASK IDB AUTO-BACKUP  — localStorage が消えても復元できる
       ===================================================== */
    (function initTaskIdbBackup() {
      // 統合 kintai_idb の tasks_backup ストアを使用
      window._taskIdbBackup = async function(tasks) {
        try { await idbSaveTasksUnified(tasks); } catch (e) { console.warn('[TaskIDB] backup failed', e); }
      };

      // 起動時: localStorage が空なら IDB → サーバーブリッジ の順で復元
      (async () => {
        if (loadTasks().length === 0) {
          // 1st: IndexedDB
          const backup = await idbLoadTasksUnified();
          if (backup && backup.length > 0) {
            localStorage.setItem(TASKS_KEY, JSON.stringify(backup));
            if (typeof toast === 'function')
              toast(`💾 バックアップから ${backup.length} 件のタスクを復元しました`);
          } else {
            // 2nd: サーバーブリッジ
            const serverData = await _restoreFromServer('tasks');
            const serverTasks = serverData?.tasks;
            if (Array.isArray(serverTasks) && serverTasks.length > 0) {
              localStorage.setItem(TASKS_KEY, JSON.stringify(serverTasks));
              await idbSaveTasksUnified(serverTasks);
              if (typeof toast === 'function')
                toast(`☁️ サーバーから ${serverTasks.length} 件のタスクを復元しました`);
            }
          }
        } else {
          window._taskIdbBackup(loadTasks());
          _syncDataToServer('tasks', { tasks: loadTasks() }); // 起動時にサーバーを更新
        }
      })();
    })();

    /* =====================================================
       DB STATUS PANEL — ハブタブのデータストア状態表示
       ===================================================== */
    (function initDbStatus() {
      const container = document.getElementById('db-status-content');
      const updatedEl = document.getElementById('db-status-updated');
      if (!container) return;

      async function refresh() {
        const items = [];

        // 1. 勤怠データ (localStorage)
        const storeStr = localStorage.getItem(STORE_KEY) || '{}';
        let storeMonths = 0;
        try { storeMonths = Object.keys(JSON.parse(storeStr).months || {}).length; } catch(_) {}
        items.push({
          label: '勤怠データ (LS)',
          value: `${storeMonths}ヶ月`,
          sub: `${Math.round(storeStr.length / 1024)}KB`,
          status: storeMonths > 0 ? 'ok' : 'warn',
        });

        // 2. 勤怠データ (IDB)
        const idbData = await idbLoad();
        const idbMonths = Object.keys(idbData?.months || {}).length;
        items.push({
          label: '勤怠データ (IDB)',
          value: `${idbMonths}ヶ月`,
          sub: idbData ? '同期済み' : '未バックアップ',
          status: idbMonths > 0 ? 'ok' : (storeMonths > 0 ? 'warn' : 'err'),
        });

        // 3. タスク (localStorage)
        const tasks = loadTasks();
        items.push({
          label: 'タスク (LS)',
          value: `${tasks.length}件`,
          sub: `${Math.round(JSON.stringify(tasks).length / 1024)}KB`,
          status: tasks.length > 0 ? 'ok' : 'warn',
        });

        // 4. タスク (IDB)
        const idbTasks = await idbLoadTasksUnified();
        items.push({
          label: 'タスク (IDB)',
          value: `${idbTasks?.length ?? 0}件`,
          sub: idbTasks ? '同期済み' : '未バックアップ',
          status: (idbTasks?.length ?? 0) > 0 ? 'ok' : 'warn',
        });

        // 5. 設定 (localStorage)
        const cfgStr = localStorage.getItem(CFG_KEY) || '{}';
        let cfgKeys = 0;
        try { cfgKeys = Object.keys(JSON.parse(cfgStr)).length; } catch(_) {}
        items.push({
          label: '設定 (LS)',
          value: `${cfgKeys}項目`,
          sub: `${cfgStr.length}B`,
          status: cfgKeys > 0 ? 'ok' : 'warn',
        });

        // 6. 設定 (IDB)
        const idbCfg = await idbLoadConfig();
        items.push({
          label: '設定 (IDB)',
          value: idbCfg ? `${Object.keys(idbCfg).length}項目` : '未保存',
          sub: idbCfg ? '同期済み' : '未バックアップ',
          status: idbCfg ? 'ok' : 'warn',
        });

        // 7. localStorage 合計使用量
        let lsTotal = 0;
        for (const k of Object.keys(localStorage)) lsTotal += (localStorage.getItem(k) || '').length;
        const lsKB = Math.round(lsTotal / 1024);
        const lsPct = Math.round(lsTotal / (5 * 1024 * 1024) * 100);
        items.push({
          label: 'LS 合計使用量',
          value: `${lsKB}KB`,
          sub: `上限5MBの約${lsPct}%`,
          status: lsPct < 70 ? 'ok' : lsPct < 90 ? 'warn' : 'err',
        });

        // 8. APIキー保存状態
        const hasSens = !!localStorage.getItem('_kintai_sens_v1');
        items.push({
          label: 'APIキー',
          value: hasSens ? '暗号化済み' : '未設定',
          sub: hasSens ? 'AES-GCM' : 'AIタブで設定可',
          status: 'ok',
        });

        container.innerHTML = `<div class="db-status-grid">${
          items.map(it => `
            <div class="db-status-item db-status-item-${it.status}">
              <div class="db-status-item-label">${it.label}</div>
              <div class="db-status-item-value">${it.value}</div>
              <div class="db-status-item-sub">${it.sub}</div>
            </div>
          `).join('')
        }</div>`;

        if (updatedEl) updatedEl.textContent = `最終更新: ${new Date().toLocaleTimeString('ja-JP')}`;
      }

      window._refreshDbStatus = refresh;

      // ボタンイベント
      document.getElementById('db-refresh-btn')?.addEventListener('click', refresh);

      document.getElementById('db-export-all-btn')?.addEventListener('click', async () => {
        const store  = loadStore();
        const tasks  = loadTasks();
        const cfg    = loadConfig();
        const idbD   = await idbLoad();
        const idbT   = await idbLoadTasksUnified();
        const idbC   = await idbLoadConfig();
        const payload = {
          exported_at: new Date().toISOString(),
          version: '2.0',
          kintai: store,
          tasks,
          config: cfg,
          idb_snapshot: { kintai: idbD, tasks: idbT, config: idbC },
        };
        const json = JSON.stringify(payload, null, 2);
        const fileName = `kintai-full-backup-${new Date().toISOString().slice(0, 10)}.json`;
        const blob = new Blob([json], { type: 'application/json' });
        // iOS では Web Share API (Files) を使ってシェアシート経由で保存
        if (navigator.canShare) {
          try {
            const file = new File([blob], fileName, { type: 'application/json' });
            if (navigator.canShare({ files: [file] })) {
              await navigator.share({ files: [file], title: 'kintai バックアップ' });
              toast('💾 シェアシートからバックアップを保存してください');
              return;
            }
          } catch(e) { /* キャンセル or 非対応 → fallback */ }
        }
        // Mac / Android fallback: <a> ダウンロード
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = fileName;
        a.click();
        toast('💾 全データのエクスポートが完了しました');
      });

      // ハブタブ初回表示時に遅延読み込み
      setTimeout(refresh, 1800);
    })();

    /* =====================================================
       SYSTEM TAB — 更新履歴・ログ・システム情報
       ===================================================== */
    (function initSystemTab() {
      const CHANGELOG = [
        {
          version: 'v35', date: '2026-03-01',
          title: '📐 設計書ビューワー + AIプロンプト例 + Bolt.new統合',
          items: [
            { tag: 'feat', text: '仕様タブを9サブタブの設計書ビューワーに刷新: 🏗構成図・🗃ER図・🔄フロー図・🔒HA設計をMermaid.jsでレンダリング。📋基本設計書・📐詳細設計書・🔌API仕様をHTML文書として表示' },
            { tag: 'feat', text: 'AIタブ入力バー上部にプロンプト例チップを追加: IT技術・ビジネス・キャリア・分析・生産性・健康など22カテゴリのプロンプトをタップで即入力' },
            { tag: 'feat', text: 'Bolt.new統合: ハブタブにAIコーディング環境カードを追加。「⚡ 新規プロジェクト」でBolt.newを開き、「📦 kintai を開く」でGitHubリポジトリをBolt.newにインポート' },
            { tag: 'feat', text: '仕様タブAPIエンドポイント一覧をv34 Docker API対応に拡充（25エンドポイント）。badge-get/badge-post CSS クラスで色分け表示' },
          ],
        },
        {
          version: 'v34', date: '2026-03-01',
          title: '🐳 Docker HA深統合 — 統計・コンテナ作成・自動更新ログ・Compose',
          items: [
            { tag: 'feat', text: 'Docker統計ビュー追加（📊）: 実行中コンテナのCPU/MEM使用率をリアルタイムバーで表示。/api/docker/stats エンドポイント追加' },
            { tag: 'feat', text: 'コンテナ作成モーダル（⊕ 作成）: イメージ名・コンテナ名・ポートマッピング・再起動ポリシー・環境変数を入力して起動。HA推奨のrestart:alwaysがデフォルト' },
            { tag: 'feat', text: 'イメージPull機能: 作成モーダルから直接 docker pull を実行。イメージビューに「▶ 起動」ボタン追加' },
            { tag: 'feat', text: 'ログ自動更新: ログモーダルを開くと3秒ごとに自動更新（チェックボックスで制御可）。最下部に自動スクロール' },
            { tag: 'feat', text: 'Hubタブ sysinfo カードにDocker状態行追加（稼働台数を常時表示。「管理↗」クリックでDockerタブに遷移）' },
            { tag: 'feat', text: 'Dockerfile + docker-compose.yml 追加: kintai-serverとcloudflaredをDockerスタックとして運用可能。health check・restart:alwaysで二重HA' },
            { tag: 'feat', text: '/api/health にDockerデーモン稼働情報とトンネル状態を追加（docker: "3/7", tunnel: true）' },
          ],
        },
        {
          version: 'v33', date: '2026-03-01',
          title: '🐳 Docker管理タブ + CF Tunnel UI修正',
          items: [
            { tag: 'feat', text: 'Dockerタブ追加: コンテナ一覧・起動/停止/再起動/削除・ログ表示・イメージ一覧をPWAから管理可能（要Docker Desktop起動）' },
            { tag: 'feat', text: 'jinjer_server.py: /api/docker/containers, /api/docker/images, /api/docker/logs, /api/docker/action エンドポイント追加' },
            { tag: 'fix',  text: 'Cloudflare Tunnel QRコード表示修正: 設定ボタンのクリックハンドラーに直接フック。window.openSettings パッチ方式を廃止' },
          ],
        },
        {
          version: 'v32', date: '2026-03-01',
          title: '☁️ Cloudflare Tunnel 自動化 — iPhone常時接続を実現',
          items: [
            { tag: 'feat', text: 'jinjer_server.py 起動時に cloudflared quick tunnel を自動起動。trycloudflare.com の HTTPS URL を取得して /api/tunnel-url で公開' },
            { tag: 'feat', text: '_resolveServerUrl() にCF Tunnel URL自動検出を追加（localhost→固定URL→CF Tunnel→Tailscale の優先順位）。LS(_cf_tunnel_url)にキャッシュ' },
            { tag: 'feat', text: '設定画面に「☁️ Cloudflare Tunnel」カード追加。現在のURL・QRコード・「外部URLに設定」ボタンを表示。iPhoneでQRスキャンするだけで接続設定完了' },
            { tag: 'feat', text: '起動30秒後に自動でトンネルURLを取得してPWAのLSにキャッシュ。次回起動時から即座に接続可能' },
          ],
        },
        {
          version: 'v31', date: '2026-03-01',
          title: '📱 iPhoneレイアウト修正 + PC対応 + 業務AIタブ追加',
          items: [
            { tag: 'fix',  text: 'iPhoneレイアウト崩壊バグ修正: ハブカード並び替えの applyHubCardOrder() が hub.style.display="flex" をインラインスタイルで設定し、CSSクラス .tab-page{display:none} を上書きしていた。DOM物理並び替えに変更し修正' },
            { tag: 'fix',  text: 'viewport修正: user-scalable=no を追加してiPhoneでのピンチ拡大を無効化。html/bodyにoverflow-x:hiddenを追加し横スクロール防止' },
            { tag: 'feat', text: 'PCレスポンシブ対応: 768px以上の画面でタブバーが左サイドバーに変換。PC/タブレットでワイドレイアウト表示' },
            { tag: 'feat', text: '業務AIタブ追加: メール返信・議事録要約・週報作成・契約書チェック・資料構成案・日程調整・見積もり作成・クレーム対応など9種類のテンプレートでIT以外の業務をClaudeで効率化' },
          ],
        },
        {
          version: 'v30', date: '2026-03-01',
          title: '🛠 ログモーダル修正 + FABカスタム + ハブ並び替え + 報告書オフライン + 株価分析',
          items: [
            { tag: 'fix',  text: 'ログモーダルバグ修正: _LOG_ARCHIVE_PFX 未定義 ReferenceError によりモーダルが開かなかった問題を解消。_populateLogDateSel / _renderLogList を IDB 対応 async 関数に全面書き換え' },
            { tag: 'feat', text: 'FABカスタマイズ: タブ管理（⚙管理）から右下＋ボタンに最大3つのタブをショートカットとして追加可能に。設定は _kintai_fab_config_v1 に保存' },
            { tag: 'feat', text: 'ハブカード並び替え: 🔀ボタンからDnDモーダルで天気/ランチャー/DB等のカード順を自由に変更可能に。_kintai_hub_card_order_v1 に保存' },
            { tag: 'feat', text: '報告書オフライン対応: サーバー未接続時に「Excelを直接開く」ボタンでローカルXLSXを SheetJS でブラウザ内パースして閲覧可能に（サーバー不要）' },
            { tag: 'feat', text: '株価画像分析: ハブタブに「📈 株価画像分析」カード追加。HEIC/JPG/PNG を複数選択して Claude Vision API でテクニカル分析・売買シグナルを日本語で表示' },
          ],
        },
        {
          version: 'v29', date: '2026-03-01',
          title: '📋 SysLog HA 対応 + ログタブ全面刷新 + 改善提案修正',
          items: [
            { tag: 'fix',  text: 'ログキー不整合バグ修正: ログタブがアプリログを表示しなかった問題 (_kintai_app_log → _kintai_log) を解消' },
            { tag: 'fix',  text: 'ERROR/WARN に改善提案が出ない問題を修正: _logSuggestion() を window に公開しログタブと統合' },
            { tag: 'feat', text: '改善提案パターン拡充: ReferenceError/TypeError/heartbeat/quota/econnrefused など JS エラーに対する具体的な修正手順を追加' },
            { tag: 'feat', text: 'SysLog HA アーキテクチャ: IDB logs_archive ストア追加、リングバッファ 80→200件、アーカイブ保持 30→365日（1年）' },
            { tag: 'feat', text: 'ログタブ刷新: 統計サマリー（直近7日ミニバーグラフ）・日付ナビゲーション（◀/▶）・キーワード検索・JSONエクスポート' },
            { tag: 'feat', text: '日付ブラウザ: アプリログを IDB から過去日付のログを取得して閲覧可能に' },
            { tag: 'feat', text: 'jinjer_server.py: 日次ログアーカイブ (logs/dates/YYYY-MM-DD/) 自動作成、90日保持' },
            { tag: 'feat', text: 'API /api/system/logs/dates で利用可能アーカイブ一覧を返却。/api/system/logs?date= で特定日のサーバーログを取得可能に' },
            { tag: 'feat', text: 'IDB v3 移行 (logs_archive ストア追加)' },
          ],
        },
        {
          version: 'v28', date: '2026-03-01',
          title: '🍎 iCloud Drive バックアップ統合 + jinjer ファイル管理改善',
          items: [
            { tag: 'feat', text: '☁️ iCloud Drive バックアップ自動化: 勤怠データ保存時に :root/attendance/attendance_backup.json へ自動書き出し' },
            { tag: 'feat', text: '世代バックアップ: :root/attendance/Backup/ に最大30世代の timestamped スナップショットを保存' },
            { tag: 'feat', text: 'DB管理タブ: iCloud バックアップカード追加 — 最終バックアップ日時・世代一覧・手動バックアップ・最新から復元' },
            { tag: 'feat', text: 'jinjer同期ファイル保存先を :root/attendance/jinjer/ へ統合 (旧: iCloud Drive/kintai/)' },
            { tag: 'feat', text: 'API /api/backup/list・/api/backup/now・/api/backup/restore・/api/backup/read を追加' },
            { tag: 'fix',  text: 'Mac/iPhone 両方の iCloud Drive ファイルアプリから同一フォルダを参照可能に' },
          ],
        },
        {
          version: 'v27', date: '2026-03-01',
          title: '⚡ パフォーマンスエンジニアリングタブ + ログ/仕様タブ改善',
          items: [
            { tag: 'feat', text: '⚡ パフォーマンスタブ新設: Web Performance APIによるシステム性能スコア計測(0〜100点)' },
            { tag: 'feat', text: 'AI速度ベンチマーク: Claude/GPT-4o/Gemini の応答時間・スループット(文字/秒)をモデル横断比較' },
            { tag: 'feat', text: '改善提案エンジン: 計測結果を自動分析し、具体的な期待効果付き改善案を表示' },
            { tag: 'feat', text: '計測履歴トラッキング: スコア変化(Δ)で改善効果を可視化(最大30件保存)' },
            { tag: 'feat', text: 'パフォーマンスエンジニア 学習ロードマップ: Phase 1〜6のキャリアパス + 推奨ツール' },
            { tag: 'fix',  text: 'ログタブ: アプリログ(localStorage)をデフォルト表示に変更 — サーバー不要で常時閲覧可能' },
            { tag: 'fix',  text: '仕様タブ: ファイル閲覧を多段取得に変更 — ①オリジン直取得 ②サーバーAPI ③キャッシュの順で試行' },
            { tag: 'feat', text: '仕様タブ: ファイル取得成功時にlocalStorageキャッシュ保存 — 次回からオフラインで閲覧可能' },
          ],
        },
        {
          version: 'v26', date: '2026-02-28',
          title: 'バグ修正: TASKS_KEY TDZ / ALL_TABS参照エラー + タブ追加・削除 + ログタブ',
          items: [
            { tag: 'fix',  text: 'TASKS_KEY の TDZ (一時的デッドゾーン) バグ修正: init() 実行時に IDB復元スキップエラーが発生していた問題を解消' },
            { tag: 'fix',  text: 'ALL_TABS 参照エラー修正: _BUILTIN_TABS にリネーム後も renderTabBar/renderMgrList が ALL_TABS を参照しタブバーが壊れていた問題を解消' },
            { tag: 'feat', text: 'タブ管理: カスタムタブの追加（🌐 URL / 📝 メモ / ⬜ 空白）と 🗑 削除機能' },
            { tag: 'feat', text: '📋 ログタブ追加: サーバー・Watchdog・アプリログを FATAL/ERROR/WARN/INFO でフィルタリング' },
            { tag: 'feat', text: 'ログ改善提案: WARN/ERROR/FATAL 行に対して具体的な修正手順を自動表示' },
          ],
        },
        {
          version: 'v25', date: '2026-02-28',
          title: 'DB管理タブ常時表示 + ログローテーション + jinjer同期改善',
          items: [
            { tag: 'fix',  text: 'DB管理タブをデフォルト表示に変更（defaultVisible: true）' },
            { tag: 'feat', text: '定期IDBバックアップ: 5分ごとに勤怠・タスクデータをIndexedDBに自動保存' },
            { tag: 'feat', text: 'ログローテーション: 起動時+1時間ごとに 2MB 超でローテーション（5世代保存）' },
            { tag: 'fix',  text: 'jinjer同期: ボタン検出パターン拡充・複数URLフォールバック・失敗時スクリーンショット' },
            { tag: 'fix',  text: 'jinjer同期: 失敗時にスタックトレースを server.log に記録、生データを logs/ に保存' },
            { tag: 'feat', text: 'jinjer同期: iCloud + ローカル両方に自動保存する save_to_icloud_and_local() に統一' },
          ],
        },
        {
          version: 'v24', date: '2026-02-28',
          title: 'データ消失防止 + DB管理タブ + 仕様タブ + ログ改善',
          items: [
            { tag: 'fix',  text: 'SRVハートビート: _tick() に try-catch-finally を追加。例外でハートビートが止まるバグを修正' },
            { tag: 'sec',  text: 'Device ID (AES-GCM ソルト) を IDB にもバックアップ。LS消去後もAI APIキーを復元可能に' },
            { tag: 'db',   text: '起動時フォースバックアップ: データあり時も毎回 IDB + サーバーブリッジに書き込む' },
            { tag: 'feat', text: '🗄 DB管理タブ追加: LS全キー一覧・絞り込み・IDBサマリー・ブリッジサマリー・各種復元ボタン' },
            { tag: 'feat', text: '📁 仕様タブ追加: システム構成・API一覧・ディレクトリ構成・ファイル閲覧' },
            { tag: 'feat', text: 'システムログ: WARN/ERROR行を色付き表示 + 既知エラーパターンの改善提案を自動表示' },
          ],
        },
        {
          version: 'v23', date: '2026-02-28',
          title: 'サーバー接続修正 + iOS Safari深リンク + Web Share API',
          items: [
            { tag: 'fix',  text: 'サーバーURL解決: localhost→外部HTTPS→Tailscaleの優先順位で自動解決' },
            { tag: 'fix',  text: 'iOS Safari: 深リンクURLから直接タブを開けるよう修正' },
            { tag: 'feat', text: 'Web Share API: ネイティブ共有シートに対応' },
          ],
        },
        {
          version: 'v22', date: '2026-02-28',
          title: 'サーバーサイドデータブリッジ + iPhone接続ガイド',
          items: [
            { tag: 'db',   text: 'data/kintai_store.json / kintai_tasks.json でサーバー側ファイルストア' },
            { tag: 'feat', text: 'iPhone接続ガイド: 外部HTTPS URL設定 + Tailscale Serve セットアップ手順' },
            { tag: 'feat', text: '改善ロードマップカード追加' },
          ],
        },
        {
          version: 'v19', date: '2026-02-28',
          title: 'jinjer同期修正 + 報告書タブ改善 + ヘルスアドバイス',
          items: [
            { tag: 'fix',  text: 'jinjer同期: ThreadingMixInでマルチスレッド化 → watchdog誤検知によるサーバー強制終了を修正' },
            { tag: 'fix',  text: '報告書タブ: サーバー未接続時でも直近12ヶ月 + kintaiデータから月選択チップを自動生成' },
            { tag: 'feat', text: '天気カード: 健康・生活アドバイスセクション追加（UV/風邪リスク/気温差/週間トレンド）' },
            { tag: 'feat', text: 'システムタブ追加 (🔧): 更新履歴・サーバーログ・システム情報を一覧表示' },
            { tag: 'feat', text: 'タブバー: 横スクロール対応（8タブ以上対応）' },
          ],
        },
        {
          version: 'v18', date: '2026-02-28',
          title: '統合IndexedDB v2 + DBステータスUI + セキュリティ強化 + GAFAM UI',
          items: [
            { tag: 'db',   text: 'kintai_idb v2: config_backup / tasks_backup ストア追加' },
            { tag: 'db',   text: 'saveConfig() / saveTasks() がIDBに自動バックアップ' },
            { tag: 'db',   text: 'restoreFromIDBIfNeeded(): 勤怠データ + 設定を同時復元' },
            { tag: 'feat', text: 'ハブタブ: 🗄 データストア状態カード追加（全データ一括エクスポート付き）' },
            { tag: 'sec',  text: '.git/hooks/pre-commit: APIキーパターン検出フック追加' },
            { tag: 'perf', text: 'タブ切り替えフェードインアニメーション / Toastアニメーション改善' },
            { tag: 'perf', text: 'スケルトンシマーローディング / ボタン押下マイクロインタラクション' },
          ],
        },
        {
          version: 'v17', date: '2026-02-28',
          title: 'FABグループ化 + タスクIDBバックアップ + AI表示修正',
          items: [
            { tag: 'feat', text: 'FABを折り畳み式グループ（＋ボタン）に統合' },
            { tag: 'fix',  text: 'AI タブでFABとプロンプト入力が重なる問題を修正' },
            { tag: 'db',   text: 'タスクのIndexedDB自動バックアップ追加' },
          ],
        },
        {
          version: 'v16', date: '2026-02-28',
          title: 'AIチャットタブ追加（Claude / ChatGPT / Gemini）',
          items: [
            { tag: 'feat', text: 'Claude (Sonnet 4.6) / ChatGPT (GPT-4o) / Gemini (2.0 Flash) 対応' },
            { tag: 'feat', text: 'ツール呼び出し: システム状態確認・ファイル読み込み・サーバー再起動' },
            { tag: 'sec',  text: 'APIキーをAES-GCM暗号化でローカル保存' },
            { tag: 'feat', text: 'server.py: /api/system/logs, /api/system/restart エンドポイント追加' },
          ],
        },
        {
          version: 'v15', date: '2026-02-28',
          title: 'ファイルブラウザ / HA watchdog / サーバー自動復旧',
          items: [
            { tag: 'feat', text: 'ハブタブ: システム情報カード + ファイルブラウザ' },
            { tag: 'feat', text: 'watchdog.py: launchd 60秒ごとの死活監視・自動kickstart' },
            { tag: 'feat', text: 'STRUCTURE.md 自動生成（サーバー起動時 + 毎朝07:30）' },
          ],
        },
        {
          version: 'v11', date: '2026-02-27',
          title: '案件タブ追加（フリーランス案件フィード）',
          items: [
            { tag: 'feat', text: 'CrowdWorks / Lancers からリアルタイム案件フィード取得' },
            { tag: 'feat', text: 'カテゴリ・キーワードフィルター / 1時間キャッシュ' },
          ],
        },
        {
          version: 'v10', date: '2026-02-27',
          title: 'セキュリティ強化 (Tailscale IP暗号化)',
          items: [
            { tag: 'sec', text: 'Tailscale IP / jinjerパスワードをAES-GCM + PBKDF2で暗号化保存' },
            { tag: 'sec', text: 'ログ・設定ファイルから機密情報を完全除去' },
          ],
        },
      ];

      const TAG_HTML = {
        feat: `<span class="cl-tag cl-tag-feat">FEAT</span>`,
        fix:  `<span class="cl-tag cl-tag-fix">FIX</span>`,
        sec:  `<span class="cl-tag cl-tag-sec">SEC</span>`,
        perf: `<span class="cl-tag cl-tag-perf">PERF</span>`,
        db:   `<span class="cl-tag cl-tag-db">DB</span>`,
      };

      function renderChangelog() {
        const el = document.getElementById('cl-entries');
        if (!el) return;
        el.innerHTML = CHANGELOG.map(e => `
          <div class="cl-entry">
            <div class="cl-entry-date">${e.date}</div>
            <span class="cl-entry-version">${e.version}</span>
            <div class="cl-entry-title">${e.title}</div>
            <ul class="cl-entry-items">
              ${e.items.map(it => `<li>${TAG_HTML[it.tag] || ''}${it.text}</li>`).join('')}
            </ul>
          </div>`).join('');
      }

      const _LOG_PATTERNS = [
        { re: /openpyxl/i,                  fix: '▶ pip install openpyxl を実行してください' },
        { re: /Connection reset by peer/i,   fix: '▶ watchdog によるサーバー再起動の可能性あり。ThreadingMixIn が有効か確認してください' },
        { re: /Address already in use/i,     fix: '▶ 既存プロセスが port 8899 を使用中。lsof -i:8899 で確認して kill してください' },
        { re: /ModuleNotFoundError/i,        fix: '▶ 必要なモジュールがありません。pip install -r requirements.txt を実行してください' },
        { re: /PermissionError/i,            fix: '▶ ファイルのアクセス権限エラー。chmod 644 対象ファイル で修正してください' },
        { re: /Traceback/i,                  fix: '▶ Python 例外が発生しています。server_err.log を確認してください' },
      ];

      function _escLog(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

      function _formatLogLines(lines) {
        return lines.map(line => {
          const isError = /\bERROR\b|\bError\b|Traceback|Exception/i.test(line);
          const isWarn  = /\bWARN(ING)?\b/i.test(line);
          const cls = isError ? 'log-error' : isWarn ? 'log-warn' : 'log-info';
          let fixHint = '';
          if (isError || isWarn) {
            const match = _LOG_PATTERNS.find(p => p.re.test(line));
            if (match) fixHint = `<div class="log-fix">${_escLog(match.fix)}</div>`;
          }
          return `<div class="log-line ${cls}">${_escLog(line)}${fixHint}</div>`;
        }).join('');
      }

      async function loadLog(type) {
        const logEl = document.getElementById('cl-log-area');
        if (!logEl) return;
        logEl.innerHTML = '<div class="log-line log-info">読み込み中...</div>';
        try {
          const r = await fetch(`${window._srvBase || 'http://localhost:8899'}/api/system/logs?type=${type}&lines=150`, { signal: AbortSignal.timeout(5000) });
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          const d = await r.json();
          const lines = d.lines || [];
          if (lines.length === 0) {
            logEl.innerHTML = '<div class="log-line log-info">(ログなし)</div>';
          } else {
            logEl.innerHTML = _formatLogLines(lines);
          }
          logEl.scrollTop = logEl.scrollHeight;
        } catch(e) {
          logEl.innerHTML = `<div class="log-line log-warn">⚠️ サーバー未接続 (${_escLog(e.message)})</div><div class="log-line log-info">サーバーが起動しているか確認してください。</div>`;
        }
      }

      function renderSysinfo() {
        const el = document.getElementById('cl-sysinfo');
        if (!el) return;
        const swVer = 'kintai-v35';
        let lsTotal = 0;
        for (const k of Object.keys(localStorage)) lsTotal += (localStorage.getItem(k) || '').length;
        const store = loadStore();
        const months = Object.keys(store.months || {}).sort();
        const tasks = loadTasks();
        el.innerHTML = [
          `📦 <strong>SW バージョン</strong>: ${swVer}`,
          `💾 <strong>勤怠データ</strong>: ${months.length}ヶ月分 (${months[0] || '-'} 〜 ${months[months.length-1] || '-'})`,
          `📋 <strong>タスク</strong>: ${tasks.length}件`,
          `🗄 <strong>LS使用量</strong>: ${Math.round(lsTotal/1024)}KB`,
          `🌐 <strong>ネットワーク</strong>: ${navigator.onLine ? 'オンライン' : 'オフライン'}`,
          `🖥 <strong>プラットフォーム</strong>: ${navigator.userAgent.includes('iPhone') ? 'iOS' : navigator.userAgent.includes('Mac') ? 'macOS' : 'その他'}`,
          `🕐 <strong>最終確認</strong>: ${new Date().toLocaleString('ja-JP')}`,
        ].map(s => `<div>${s}</div>`).join('');
      }

      // iPhone 接続ガイドの現在状態を表示
      async function renderIphoneGuideStatus() {
        const el = document.getElementById('iphone-guide-status');
        if (!el) return;
        const lines = [];
        // サーバー疎通確認
        const base = await _resolveServerUrl(8899).catch(() => null);
        if (base) {
          lines.push(`🟢 <strong>ローカルサーバー</strong>: 起動中 (${base})`);
        } else {
          lines.push(`🔴 <strong>ローカルサーバー</strong>: 停止中 — jinjer_server.py を起動してください`);
        }
        // 外部 HTTPS URL 設定確認
        const cfg = loadConfig();
        const extUrl = cfg.externalHttpsUrl || '';
        if (extUrl) {
          lines.push(`🟢 <strong>外部HTTPS URL</strong>: ${extUrl.replace(/^(https?:\/\/[^/]{0,6})[^/]*(\/.*)?$/, '$1…$2')}`);
        } else {
          lines.push(`🟡 <strong>外部HTTPS URL</strong>: 未設定 — 設定(⚙️)から入力または自動検出`);
        }
        // サーバーブリッジ確認
        if (base) {
          try {
            const r = await fetch(`${base}/api/kintai-data`, { signal: AbortSignal.timeout(2000) });
            const d = await r.json();
            const mCount = Object.keys(d.months || {}).length;
            const saved = d._server_saved_at ? new Date(d._server_saved_at).toLocaleString('ja-JP') : '-';
            lines.push(`🟢 <strong>データブリッジ</strong>: ${mCount}ヶ月分保存済み (最終: ${saved})`);
          } catch(_) {
            lines.push(`🟡 <strong>データブリッジ</strong>: 未同期 — 勤怠タブを開くと自動同期されます`);
          }
        }
        el.innerHTML = lines.map(s => `<div>${s}</div>`).join('');
      }

      // システム改善ロードマップを表示
      function renderImprovementList() {
        const el = document.getElementById('improvement-list');
        if (!el) return;
        const items = [
          { done: true,  text: 'v11 — 案件フィード（CrowdWorks/Lancers 自動取得）' },
          { done: true,  text: 'v14 — HA watchdog + サーバー自動復旧' },
          { done: true,  text: 'v16 — AI チャット（Claude / ChatGPT / Gemini）' },
          { done: true,  text: 'v18 — 統合IDB v2 + セキュリティ強化 (AES-GCM)' },
          { done: true,  text: 'v20 — 従業員管理 + 市場価値診断タブ' },
          { done: true,  text: 'v21 — iPhone HTTPS接続 + タブD&D並び替え + データブリッジ' },
          { done: false, text: '次期 — Excel 自動アップロード（iCloud Drive 経由）' },
          { done: false, text: '次期 — プッシュ通知（打刻忘れ・月末リマインダー）' },
          { done: false, text: '次期 — AI による月次レポート自動生成' },
        ];
        el.innerHTML = items.map(({ done, text }) =>
          `<div>${done ? '✅' : '⬜'} ${text}</div>`
        ).join('');
      }

      window._initSystemTab = function() {
        renderChangelog();
        renderSysinfo();
        renderImprovementList();
        renderIphoneGuideStatus(); // 非同期（サーバー確認あり）
        loadLog('server');
      };

      document.getElementById('cl-log-server-btn')?.addEventListener('click', () => loadLog('server'));
      document.getElementById('cl-log-watchdog-btn')?.addEventListener('click', () => loadLog('watchdog'));
      document.getElementById('cl-log-refresh-btn')?.addEventListener('click', () => {
        const active = document.querySelector('.cl-log-server-btn-active') ? 'watchdog' : 'server';
        loadLog(active);
        renderSysinfo();
      });
    })();

    /* =====================================================
       DB管理タブ
       ===================================================== */
    (function initDbTab() {
      const _getApi = () => window._srvBase || 'http://localhost:8899';

      function _esc(s) {
        return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      }

      function renderDbTable(filter) {
        const area = document.getElementById('db-table-area');
        if (!area) return;
        const keys = Object.keys(localStorage).sort();
        const q = (filter || '').toLowerCase();
        const rows = keys.filter(k => {
          if (!q) return true;
          const v = localStorage.getItem(k) || '';
          return k.toLowerCase().includes(q) || v.toLowerCase().includes(q);
        }).map(k => {
          const v = localStorage.getItem(k) || '';
          const kb = (v.length / 1024).toFixed(1);
          const preview = v.length > 80 ? _esc(v.slice(0,80)) + '…' : _esc(v);
          return `<tr>
            <td style="font-size:11px;font-family:monospace;color:var(--accent-blue);max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${_esc(k)}</td>
            <td style="font-size:11px;text-align:right;padding:0 8px;white-space:nowrap;">${kb}KB</td>
            <td style="font-size:10px;color:var(--text-muted);max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${preview}</td>
          </tr>`;
        });
        if (rows.length === 0) {
          area.innerHTML = '<div style="color:var(--text-muted);font-size:12px;padding:8px;">一致するキーがありません</div>';
          return;
        }
        area.innerHTML = `<table style="width:100%;border-collapse:collapse;">
          <thead><tr style="font-size:11px;color:var(--text-muted);border-bottom:1px solid var(--border-soft);">
            <th style="text-align:left;padding:4px 0;">キー</th><th>サイズ</th><th style="text-align:left;">値プレビュー</th>
          </tr></thead>
          <tbody>${rows.join('')}</tbody>
        </table>`;
      }

      async function renderIdbSummary() {
        const el = document.getElementById('db-idb-summary');
        if (!el) return;
        try {
          const [store, tasks, cfg] = await Promise.all([
            idbLoad().catch(()=>null),
            idbLoadTasksUnified().catch(()=>null),
            idbLoadConfig().catch(()=>null),
          ]);
          const months = Object.keys(store?.months || {}).length;
          const taskCnt = Array.isArray(tasks) ? tasks.length : 0;
          const cfgCnt = cfg ? Object.keys(cfg).length : 0;
          el.innerHTML = [
            `📅 勤怠データ: ${months}ヶ月分`,
            `✅ タスク: ${taskCnt}件`,
            `⚙️ 設定項目: ${cfgCnt}件`,
          ].map(s => `<div>${s}</div>`).join('');
        } catch(e) {
          el.textContent = `⚠️ IDB読み込みエラー: ${e.message}`;
        }
      }

      async function renderBridgeSummary() {
        const el = document.getElementById('db-bridge-summary');
        if (!el) return;
        const base = _getApi();
        try {
          const [kr, tr] = await Promise.all([
            fetch(`${base}/api/kintai-data`, { signal: AbortSignal.timeout(3000) }).then(r=>r.ok?r.json():null).catch(()=>null),
            fetch(`${base}/api/tasks-data`, { signal: AbortSignal.timeout(3000) }).then(r=>r.ok?r.json():null).catch(()=>null),
          ]);
          const mCount = Object.keys(kr?.months || {}).length;
          const tCount = Array.isArray(tr?.tasks) ? tr.tasks.length : 0;
          const saved = kr?._server_saved_at ? new Date(kr._server_saved_at).toLocaleString('ja-JP') : '-';
          el.innerHTML = [
            `📅 勤怠データ: ${mCount}ヶ月分 (最終: ${saved})`,
            `✅ タスク: ${tCount}件`,
          ].map(s => `<div>${s}</div>`).join('');
        } catch(_) {
          el.textContent = '⚠️ サーバー未接続';
        }
      }

      async function renderIcloudSummary() {
        const sumEl = document.getElementById('db-icloud-summary');
        const listEl = document.getElementById('db-icloud-backups');
        if (!sumEl || !listEl) return;
        try {
          const base = _getApi();
          const d = await fetch(`${base}/api/backup/list`, { signal: AbortSignal.timeout(4000) })
            .then(r => r.ok ? r.json() : null).catch(() => null);
          if (!d) {
            sumEl.textContent = '⚠️ サーバー未接続（ローカルサーバー起動時のみ利用可）';
            listEl.innerHTML = '';
            return;
          }
          const main = d.main_backup;
          if (main?.exists) {
            const date = new Date(main.mtime * 1000).toLocaleString('ja-JP');
            const kb = (main.size / 1024).toFixed(1);
            sumEl.innerHTML = `<div>📄 <strong>attendance_backup.json</strong>: ${kb} KB (最終更新: ${date})</div>
              <div style="color:var(--text-muted);margin-top:2px;">jinjer同期ファイル: ${d.jinjer_files?.length || 0}件</div>`;
          } else {
            sumEl.innerHTML = '<div style="color:var(--text-muted);">📄 メインバックアップ未作成（勤怠データを保存すると自動作成されます）</div>';
          }
          const baks = d.backups || [];
          if (baks.length === 0) {
            listEl.innerHTML = '<div style="font-size:11px;color:var(--text-muted);padding:4px 0;">世代バックアップなし</div>';
          } else {
            listEl.innerHTML = baks.slice().reverse().map(b => {
              const dt = new Date(b.mtime * 1000).toLocaleString('ja-JP');
              const kb = (b.size / 1024).toFixed(1);
              return `<div style="font-size:11px;padding:3px 6px;border-bottom:1px solid var(--border-soft);display:flex;justify-content:space-between;align-items:center;">
                <span style="color:var(--text-sub);">${b.name}</span>
                <span style="color:var(--text-muted);white-space:nowrap;margin-left:8px;">${kb}KB · ${dt}</span>
              </div>`;
            }).join('');
          }
        } catch(e) {
          sumEl.textContent = `⚠️ エラー: ${e.message}`;
        }
      }

      window._initDbTab = function() {
        renderDbTable('');
        renderIdbSummary();
        renderBridgeSummary();
        renderIcloudSummary();
      };

      document.getElementById('db-query-btn')?.addEventListener('click', () => {
        renderDbTable(document.getElementById('db-query-input')?.value || '');
      });
      document.getElementById('db-query-input')?.addEventListener('keydown', e => {
        if (e.key === 'Enter') renderDbTable(e.target.value);
      });

      document.getElementById('db-backup-now-btn')?.addEventListener('click', async () => {
        try {
          const store = loadStore();
          idbSave(store);
          _syncDataToServer('kintai', store);
          const tasks = loadTasks();
          idbSaveTasksUnified(tasks);
          _syncDataToServer('tasks', { tasks });
          toast('💾 バックアップ完了（IDB + サーバーブリッジ）');
          renderIdbSummary();
          renderBridgeSummary();
        } catch(e) { toast(`❌ ${e.message}`); }
      });

      document.getElementById('db-restore-idb-btn')?.addEventListener('click', async () => {
        try {
          const restored = await restoreFromIDBIfNeeded();
          toast(restored ? '✅ IDB→LS 復元完了' : '⚠️ 復元対象なし（LSにデータあり）');
          renderDbTable('');
        } catch(e) { toast(`❌ ${e.message}`); }
      });

      document.getElementById('db-idb-restore-kintai')?.addEventListener('click', async () => {
        try {
          const data = await idbLoad();
          if (data && Object.keys(data.months || {}).length > 0) {
            localStorage.setItem(STORE_KEY, JSON.stringify(data));
            toast(`📅 勤怠データ復元: ${Object.keys(data.months).length}ヶ月分`);
            renderDbTable('');
          } else { toast('⚠️ IDBに勤怠データがありません'); }
        } catch(e) { toast(`❌ ${e.message}`); }
      });

      document.getElementById('db-idb-restore-tasks')?.addEventListener('click', async () => {
        try {
          const tasks = await idbLoadTasksUnified();
          if (Array.isArray(tasks) && tasks.length > 0) {
            localStorage.setItem(TASKS_KEY, JSON.stringify(tasks));
            toast(`✅ タスク復元: ${tasks.length}件`);
            renderDbTable('');
          } else { toast('⚠️ IDBにタスクデータがありません'); }
        } catch(e) { toast(`❌ ${e.message}`); }
      });

      document.getElementById('db-bridge-restore')?.addEventListener('click', async () => {
        try {
          const base = _getApi();
          const [kr, tr] = await Promise.all([
            fetch(`${base}/api/kintai-data`, { signal: AbortSignal.timeout(5000) }).then(r=>r.json()),
            fetch(`${base}/api/tasks-data`, { signal: AbortSignal.timeout(5000) }).then(r=>r.json()),
          ]);
          if (kr?.months && Object.keys(kr.months).length > 0) {
            const clean = { months: kr.months };
            localStorage.setItem(STORE_KEY, JSON.stringify(clean));
            idbSave(clean);
          }
          if (Array.isArray(tr?.tasks)) {
            localStorage.setItem(TASKS_KEY, JSON.stringify(tr.tasks));
            idbSaveTasksUnified(tr.tasks);
          }
          toast('☁️ ブリッジから復元完了');
          renderDbTable('');
        } catch(e) { toast(`❌ サーバー未接続: ${e.message}`); }
      });

      document.getElementById('db-icloud-backup-now-btn')?.addEventListener('click', async () => {
        try {
          const base = _getApi();
          const r = await fetch(`${base}/api/backup/now`, { method: 'POST', signal: AbortSignal.timeout(8000) });
          const d = await r.json();
          if (d.ok) {
            toast(`☁️ iCloudバックアップ完了 (${d.label || 'manual'})`);
            renderIcloudSummary();
          } else {
            toast(`❌ バックアップ失敗: ${d.error || '不明'}`);
          }
        } catch(e) { toast(`❌ サーバー未接続: ${e.message}`); }
      });

      document.getElementById('db-icloud-restore-btn')?.addEventListener('click', async () => {
        if (!confirm('iCloud Drive の最新バックアップ (attendance_backup.json) からデータを復元しますか？\n現在のデータは上書きされます。')) return;
        try {
          const base = _getApi();
          const r = await fetch(`${base}/api/backup/restore`, { method: 'POST', signal: AbortSignal.timeout(8000) });
          const d = await r.json();
          if (d.ok && d.months) {
            const clean = { months: d.months };
            localStorage.setItem(STORE_KEY, JSON.stringify(clean));
            idbSave(clean);
            toast(`☁️ iCloudから復元完了: ${Object.keys(d.months).length}ヶ月分`);
            renderDbTable('');
            renderIcloudSummary();
          } else {
            toast(`❌ 復元失敗: ${d.error || 'バックアップファイルが見つかりません'}`);
          }
        } catch(e) { toast(`❌ サーバー未接続: ${e.message}`); }
      });
    })();

    /* =====================================================
       仕様タブ / 設計書ビューワー
       ===================================================== */
    (function initSpecTab() {
      const _getApi = () => window._srvBase || 'http://localhost:8899';

      const API_ENDPOINTS = [
        { method: 'GET',  path: '/api/health',                     desc: 'ヘルスチェック (docker/tunnel状態含む)' },
        { method: 'GET',  path: '/api/jinjer?months=YYYY-MM',      desc: 'jinjer 勤怠データ取得' },
        { method: 'GET',  path: '/api/reports',                    desc: '報告書 Excel 一覧' },
        { method: 'GET',  path: '/api/reports/read?year=&month=',  desc: '指定月 Excel → JSON' },
        { method: 'POST', path: '/api/reports/sync',               desc: 'kintai → Excel 書き込み' },
        { method: 'POST', path: '/api/reports/generate',           desc: '翌月 Excel 自動生成' },
        { method: 'GET',  path: '/api/structure',                  desc: 'STRUCTURE.md 内容' },
        { method: 'GET',  path: '/api/files',                      desc: 'ファイル一覧' },
        { method: 'GET',  path: '/api/files/read?path=',           desc: 'ファイル内容取得' },
        { method: 'GET',  path: '/api/jobs?categories=&keywords=', desc: '案件フィード (1h キャッシュ)' },
        { method: 'GET',  path: '/api/kintai-data',                desc: 'サーバーブリッジ: 勤怠データ' },
        { method: 'POST', path: '/api/kintai-data',                desc: 'サーバーブリッジ: 勤怠データ保存' },
        { method: 'GET',  path: '/api/tasks-data',                 desc: 'サーバーブリッジ: タスクデータ' },
        { method: 'POST', path: '/api/tasks-data',                 desc: 'サーバーブリッジ: タスクデータ保存' },
        { method: 'GET',  path: '/api/tailscale-url',              desc: 'Tailscale Serve URL 自動検出' },
        { method: 'GET',  path: '/api/tunnel-url',                 desc: 'Cloudflare Tunnel URL 取得' },
        { method: 'GET',  path: '/api/system/logs',                desc: 'サーバー/watchdog ログ取得' },
        { method: 'POST', path: '/api/system/restart',             desc: 'サーバー再起動 (launchd)' },
        { method: 'GET',  path: '/api/docker/containers',          desc: 'コンテナ一覧' },
        { method: 'GET',  path: '/api/docker/images',              desc: 'イメージ一覧' },
        { method: 'GET',  path: '/api/docker/logs?id=&tail=',      desc: 'コンテナログ取得' },
        { method: 'GET',  path: '/api/docker/stats',               desc: 'コンテナリソース統計' },
        { method: 'POST', path: '/api/docker/action',              desc: 'コンテナ操作 (start/stop/restart/rm)' },
        { method: 'POST', path: '/api/docker/pull',                desc: 'イメージ pull' },
        { method: 'POST', path: '/api/docker/run',                 desc: '新規コンテナ作成・起動' },
      ];

      // ── サブタブ管理 ─────────────────────────────────────────────
      let _specTabInit = false;
      let _mermaidInit = false;
      const _renderedPanes = new Set();

      async function _ensureMermaid() {
        if (window.mermaid) {
          if (!_mermaidInit) {
            window.mermaid.initialize({ startOnLoad: false, theme: 'dark', securityLevel: 'loose' });
            _mermaidInit = true;
          }
          return true;
        }
        for (let i = 0; i < 50; i++) {
          await new Promise(r => setTimeout(r, 100));
          if (window.mermaid) {
            window.mermaid.initialize({ startOnLoad: false, theme: 'dark', securityLevel: 'loose' });
            _mermaidInit = true;
            return true;
          }
        }
        return false;
      }

      async function _renderDiagram(containerId, definition) {
        const container = document.getElementById(containerId);
        if (!container) return;
        const ok = await _ensureMermaid();
        if (!ok) {
          container.innerHTML = '<div style="color:var(--text-muted);font-size:12px;padding:20px;text-align:center;">⚠️ Mermaid が読み込まれませんでした (CDN 未接続)</div>';
          return;
        }
        try {
          const uid = 'mg-' + containerId + '-' + Date.now();
          const { svg } = await window.mermaid.render(uid, definition);
          container.innerHTML = svg;
        } catch (e) {
          container.innerHTML = '<div style="color:#e05252;font-size:11px;padding:10px;">描画エラー: ' + e.message + '</div>';
        }
      }

      // ── Mermaid 図定義 ────────────────────────────────────────────
      const DIAGRAMS = {
        arch: `flowchart TD
  subgraph CL["📱 クライアント"]
    B["ブラウザ/Safari"]
    SW["Service Worker"]
    IDB[("IndexedDB")]
    LS[("localStorage")]
  end
  subgraph SV["🖥 Server :8899"]
    PY["jinjer_server.py"]
    DATA[("data/")]
    LOG[("logs/")]
  end
  subgraph HA["🔒 HA 層"]
    LD["launchd KeepAlive"]
    WD["watchdog 60s"]
  end
  subgraph EX["🌐 外部"]
    GH["GitHub Pages"]
    CF["CF Tunnel"]
    JJ["jinjer.biz"]
    IC["iCloud"]
  end
  B -->|"HTTP"| PY
  B -->|"HTTPS"| GH
  CF --> PY
  PY -->|"Playwright"| JJ
  PY --- IC
  PY --- DATA
  PY --- LOG
  LD -->|"restart"| PY
  WD -->|"kickstart"| PY
  B --- IDB
  B --- SW`,

        er: `erDiagram
  ATTENDANCE {
    string year_month PK
    json days
    string updated_at
  }
  TASKS {
    string id PK
    string title
    string status
    string due
    string priority
  }
  CONFIG_BACKUP {
    string id PK
    json config
    string saved_at
  }
  LOGS_ARCHIVE {
    string date PK
    json entries
    string updated_at
  }
  ATTENDANCE ||--o{ TASKS : "月別管理"
  CONFIG_BACKUP }|--|{ ATTENDANCE : "バックアップ"`,

        seq: `sequenceDiagram
  actor U as User
  participant P as PWA
  participant I as IndexedDB
  participant S as Server
  participant J as jinjer
  Note over U,J: 起動フロー
  U->>P: アプリ起動
  P->>I: restoreFromIDB
  I-->>P: データ復元
  P->>S: GET /api/health
  S-->>P: status ok
  Note over U,J: jinjer 同期フロー
  U->>P: jinjer同期ボタン
  P->>S: GET /api/jinjer
  S->>J: Playwright login
  J-->>S: 打刻データ
  S-->>P: 同期完了
  P->>I: idbSave
  Note over U,J: 報告書フロー
  U->>P: 報告書タブ
  P->>S: GET /api/reports/read
  S-->>P: Excel to JSON
  U->>P: Excel同期
  P->>S: POST /api/reports/sync
  S-->>P: 更新完了`,

        ha: `flowchart LR
  subgraph F["💣 障害"]
    C1["クラッシュ"]
    C2["フリーズ"]
    C3["ビジー"]
  end
  subgraph M["👁 監視"]
    D1["heartbeat 30s"]
    D2["watchdog 60s"]
  end
  subgraph R["✅ 復旧"]
    R1["launchd 10s"]
    R2["kickstart 60s"]
    R3["kill port"]
  end
  C1 --> R1
  C2 --> R2
  C3 --> R3
  D1 -.->|"断検知"| D2
  D2 --> R2`
      };

      function _switchSpecPane(paneName) {
        document.querySelectorAll('.spec-sub-btn').forEach(b =>
          b.classList.toggle('active', b.dataset.pane === paneName));
        document.querySelectorAll('.spec-pane').forEach(p => {
          p.style.display = p.id === 'spec-pane-' + paneName ? '' : 'none';
        });
        if (!_renderedPanes.has(paneName)) {
          _renderedPanes.add(paneName);
          if      (paneName === 'arch')   _renderDiagram('spec-diagram-arch', DIAGRAMS.arch);
          else if (paneName === 'er')     _renderDiagram('spec-diagram-er',   DIAGRAMS.er);
          else if (paneName === 'seq')    _renderDiagram('spec-diagram-seq',  DIAGRAMS.seq);
          else if (paneName === 'ha')     _renderDiagram('spec-diagram-ha',   DIAGRAMS.ha);
          else if (paneName === 'basic')  _renderBasicDesign();
          else if (paneName === 'detail') _renderDetailDesign();
          else if (paneName === 'api')    renderApi();
          else if (paneName === 'struct') renderStructure();
          else if (paneName === 'files')  loadSpecFiles();
        }
      }

      // ── 基本設計書 ────────────────────────────────────────────────
      function _renderBasicDesign() {
        const el = document.getElementById('spec-basic-content');
        if (!el) return;
        el.innerHTML = `
          <div class="doc-h1">kintai PWA — 基本設計書 v35</div>
          <div class="doc-h2">1. システム概要</div>
          <p class="doc-p">kintai は個人向け勤怠管理 PWA です。Safari/Chrome からオフラインでも動作し、
          ローカル Python サーバーと連携することで jinjer 勤怠システムとの自動同期・
          Excel 報告書生成・AI チャット・Docker 管理を提供します。</p>
          <div class="doc-h2">2. 目的・スコープ</div>
          <ul class="doc-ul">
            <li>jinjer 打刻データの自動取得・月間カレンダー表示</li>
            <li>月次作業報告書 (Excel) の自動生成・サーバー同期</li>
            <li>AI (Claude / GPT-4o / Gemini) によるシステム操作・チャット</li>
            <li>高可用性 (HA) サーバーによる常時稼働 (99%+)</li>
            <li>Docker コンテナ管理・統計・イメージ操作 (v34+)</li>
            <li>Cloudflare Tunnel による外部 HTTPS アクセス (v32+)</li>
          </ul>
          <div class="doc-h2">3. システム構成サマリー</div>
          <table class="doc-table">
            <tr style="border-bottom:1px solid var(--border-soft);">
              <th style="padding:5px 8px;text-align:left;font-size:11px;">レイヤー</th>
              <th style="padding:5px 8px;text-align:left;font-size:11px;">コンポーネント</th>
              <th style="padding:5px 8px;text-align:left;font-size:11px;">技術スタック</th>
            </tr>
            <tr style="border-bottom:1px solid var(--border-soft);">
              <td style="padding:5px 8px;font-size:11px;">フロントエンド</td>
              <td style="padding:5px 8px;font-size:11px;">index.html / sw.js</td>
              <td style="padding:5px 8px;font-size:11px;">Vanilla JS, PWA, IndexedDB, Service Worker</td>
            </tr>
            <tr style="border-bottom:1px solid var(--border-soft);">
              <td style="padding:5px 8px;font-size:11px;">バックエンド</td>
              <td style="padding:5px 8px;font-size:11px;">jinjer_server.py</td>
              <td style="padding:5px 8px;font-size:11px;">Python 3.11, ThreadingHTTPServer</td>
            </tr>
            <tr style="border-bottom:1px solid var(--border-soft);">
              <td style="padding:5px 8px;font-size:11px;">スクレイパー</td>
              <td style="padding:5px 8px;font-size:11px;">sync_jinjer.py</td>
              <td style="padding:5px 8px;font-size:11px;">Playwright (headless Chromium)</td>
            </tr>
            <tr style="border-bottom:1px solid var(--border-soft);">
              <td style="padding:5px 8px;font-size:11px;">Excel 処理</td>
              <td style="padding:5px 8px;font-size:11px;">report_sync.py</td>
              <td style="padding:5px 8px;font-size:11px;">openpyxl 3.1+</td>
            </tr>
            <tr style="border-bottom:1px solid var(--border-soft);">
              <td style="padding:5px 8px;font-size:11px;">HA</td>
              <td style="padding:5px 8px;font-size:11px;">launchd + watchdog (5ジョブ)</td>
              <td style="padding:5px 8px;font-size:11px;">macOS launchd, Shell Script</td>
            </tr>
            <tr style="border-bottom:1px solid var(--border-soft);">
              <td style="padding:5px 8px;font-size:11px;">コンテナ</td>
              <td style="padding:5px 8px;font-size:11px;">Docker Compose</td>
              <td style="padding:5px 8px;font-size:11px;">Docker, cloudflared (代替構成)</td>
            </tr>
            <tr>
              <td style="padding:5px 8px;font-size:11px;">外部トンネル</td>
              <td style="padding:5px 8px;font-size:11px;">Cloudflare Tunnel (自動起動)</td>
              <td style="padding:5px 8px;font-size:11px;">cloudflared, Tailscale Serve</td>
            </tr>
          </table>
          <div class="doc-h2">4. 非機能要件</div>
          <table class="doc-table">
            <tr style="border-bottom:1px solid var(--border-soft);">
              <th style="padding:5px 8px;text-align:left;font-size:11px;">要件</th>
              <th style="padding:5px 8px;text-align:left;font-size:11px;">目標値</th>
              <th style="padding:5px 8px;text-align:left;font-size:11px;">実装方式</th>
            </tr>
            <tr style="border-bottom:1px solid var(--border-soft);">
              <td style="padding:5px 8px;font-size:11px;">可用性</td>
              <td style="padding:5px 8px;font-size:11px;">99% 以上</td>
              <td style="padding:5px 8px;font-size:11px;">launchd KeepAlive + watchdog 二重監視</td>
            </tr>
            <tr style="border-bottom:1px solid var(--border-soft);">
              <td style="padding:5px 8px;font-size:11px;">復旧時間 (MTTR)</td>
              <td style="padding:5px 8px;font-size:11px;">&lt; 60 秒</td>
              <td style="padding:5px 8px;font-size:11px;">watchdog 60 秒ポーリング</td>
            </tr>
            <tr style="border-bottom:1px solid var(--border-soft);">
              <td style="padding:5px 8px;font-size:11px;">オフライン動作</td>
              <td style="padding:5px 8px;font-size:11px;">完全動作</td>
              <td style="padding:5px 8px;font-size:11px;">Service Worker + IndexedDB</td>
            </tr>
            <tr style="border-bottom:1px solid var(--border-soft);">
              <td style="padding:5px 8px;font-size:11px;">セキュリティ</td>
              <td style="padding:5px 8px;font-size:11px;">AES-GCM 256bit</td>
              <td style="padding:5px 8px;font-size:11px;">PBKDF2 (100K iterations) + AES-GCM</td>
            </tr>
            <tr>
              <td style="padding:5px 8px;font-size:11px;">レスポンス</td>
              <td style="padding:5px 8px;font-size:11px;">&lt; 500ms</td>
              <td style="padding:5px 8px;font-size:11px;">Network-First SW + IDB キャッシュ</td>
            </tr>
          </table>
          <div class="doc-h2">5. タブ構成 (12 タブ)</div>
          <ul class="doc-ul">
            <li>📅 勤怠 — 月間カレンダー・jinjer 同期・打刻修正</li>
            <li>🚀 ハブ — 天気・クイックランチャー・DB ステータス・Docker 状態</li>
            <li>📚 学習 — 学習記録・目標・ロードマップ</li>
            <li>📊 進捗 — プロジェクト・タスク管理</li>
            <li>📋 報告書 — Excel 月次報告書・オフライン表示</li>
            <li>💼 案件 — フリーランス案件フィード (CW / Lancers)</li>
            <li>🤖 AI — Claude / GPT-4o / Gemini チャット・ツール呼び出し</li>
            <li>🔧 システム — サーバーログ・更新履歴</li>
            <li>🗄 DB 管理 — IDB / LS 操作・バックアップ・復元</li>
            <li>🐳 Docker — コンテナ管理・CPU/MEM 統計・イメージ操作</li>
            <li>📁 仕様 — 設計書ビューワー（本ページ）</li>
            <li>⚡ パフォーマンス — スコア計測・AI 速度ベンチ</li>
          </ul>`;
      }

      // ── 詳細設計書 ────────────────────────────────────────────────
      function _renderDetailDesign() {
        const el = document.getElementById('spec-detail-content');
        if (!el) return;
        el.innerHTML = `
          <div class="doc-h1">kintai PWA — 詳細設計書 v35</div>
          <div class="doc-h2">1. データ設計 — IndexedDB (kintai_idb v3)</div>
          <table class="doc-table">
            <tr style="border-bottom:1px solid var(--border-soft);">
              <th style="padding:5px 8px;font-size:11px;">ストア名</th>
              <th style="padding:5px 8px;font-size:11px;">キー</th>
              <th style="padding:5px 8px;font-size:11px;">用途</th>
            </tr>
            <tr style="border-bottom:1px solid var(--border-soft);">
              <td style="padding:4px 8px;font-size:11px;font-family:monospace;">attendance</td>
              <td style="padding:4px 8px;font-size:11px;font-family:monospace;">YYYY-MM</td>
              <td style="padding:4px 8px;font-size:11px;">月別勤怠データ</td>
            </tr>
            <tr style="border-bottom:1px solid var(--border-soft);">
              <td style="padding:4px 8px;font-size:11px;font-family:monospace;">config_backup</td>
              <td style="padding:4px 8px;font-size:11px;font-family:monospace;">"backup"</td>
              <td style="padding:4px 8px;font-size:11px;">設定バックアップ</td>
            </tr>
            <tr style="border-bottom:1px solid var(--border-soft);">
              <td style="padding:4px 8px;font-size:11px;font-family:monospace;">tasks_backup</td>
              <td style="padding:4px 8px;font-size:11px;font-family:monospace;">"tasks"</td>
              <td style="padding:4px 8px;font-size:11px;">タスク統合バックアップ</td>
            </tr>
            <tr>
              <td style="padding:4px 8px;font-size:11px;font-family:monospace;">logs_archive</td>
              <td style="padding:4px 8px;font-size:11px;font-family:monospace;">YYYY-MM-DD</td>
              <td style="padding:4px 8px;font-size:11px;">日別ログアーカイブ (365日保持)</td>
            </tr>
          </table>
          <div class="doc-h2">2. localStorage 主要キー</div>
          <table class="doc-table">
            <tr style="border-bottom:1px solid var(--border-soft);">
              <th style="padding:5px 8px;font-size:11px;">キー</th>
              <th style="padding:5px 8px;font-size:11px;">内容</th>
            </tr>
            <tr style="border-bottom:1px solid var(--border-soft);">
              <td style="padding:4px 8px;font-size:10px;font-family:monospace;">_kintai_cfg_v1</td>
              <td style="padding:4px 8px;font-size:11px;">アプリ全設定 (JSON)</td>
            </tr>
            <tr style="border-bottom:1px solid var(--border-soft);">
              <td style="padding:4px 8px;font-size:10px;font-family:monospace;">_kintai_sens_v1</td>
              <td style="padding:4px 8px;font-size:11px;">AES-GCM 暗号化済センシティブデータ</td>
            </tr>
            <tr style="border-bottom:1px solid var(--border-soft);">
              <td style="padding:4px 8px;font-size:10px;font-family:monospace;">_kintai_tab_config_v1</td>
              <td style="padding:4px 8px;font-size:11px;">タブ表示順・表示/非表示設定</td>
            </tr>
            <tr style="border-bottom:1px solid var(--border-soft);">
              <td style="padding:4px 8px;font-size:10px;font-family:monospace;">_kintai_log</td>
              <td style="padding:4px 8px;font-size:11px;">アプリログ (200件リングバッファ)</td>
            </tr>
            <tr>
              <td style="padding:4px 8px;font-size:10px;font-family:monospace;">_kintai_file_cache_v1</td>
              <td style="padding:4px 8px;font-size:11px;">ファイルビューワーキャッシュ (200KB/file)</td>
            </tr>
          </table>
          <div class="doc-h2">3. セキュリティ設計</div>
          <ul class="doc-ul">
            <li><strong>暗号化:</strong> AES-GCM 256bit + PBKDF2-SHA256 (100,000 回)</li>
            <li><strong>対象:</strong> Claude/GPT/Gemini APIキー / jinjer パスワード / Tailscale IP</li>
            <li><strong>CSP:</strong> script-src は self + 許可済み CDN のみ</li>
            <li><strong>pre-commit hook:</strong> Anthropic/OpenAI/Google/AWS APIキーパターン検出</li>
            <li><strong>ログマスク:</strong> IP を maskIp() で 100.●●.●●●.●● 表示</li>
            <li><strong>Docker:</strong> コンテナ名・イメージ名を正規表現でバリデーション</li>
          </ul>
          <div class="doc-h2">4. HA 設計 — 多層冗長化</div>
          <table class="doc-table">
            <tr style="border-bottom:1px solid var(--border-soft);">
              <th style="padding:5px 8px;font-size:11px;">レイヤー</th>
              <th style="padding:5px 8px;font-size:11px;">実装</th>
              <th style="padding:5px 8px;font-size:11px;">MTTR</th>
            </tr>
            <tr style="border-bottom:1px solid var(--border-soft);">
              <td style="padding:4px 8px;font-size:11px;">L0: PWA</td>
              <td style="padding:4px 8px;font-size:11px;">Service Worker + IndexedDB (完全オフライン)</td>
              <td style="padding:4px 8px;font-size:11px;">0秒</td>
            </tr>
            <tr style="border-bottom:1px solid var(--border-soft);">
              <td style="padding:4px 8px;font-size:11px;">L1: launchd</td>
              <td style="padding:4px 8px;font-size:11px;">KeepAlive=true, ThrottleInterval=10</td>
              <td style="padding:4px 8px;font-size:11px;">10秒</td>
            </tr>
            <tr style="border-bottom:1px solid var(--border-soft);">
              <td style="padding:4px 8px;font-size:11px;">L2: watchdog</td>
              <td style="padding:4px 8px;font-size:11px;">60秒ポーリング → kickstart</td>
              <td style="padding:4px 8px;font-size:11px;">60秒以内</td>
            </tr>
            <tr>
              <td style="padding:4px 8px;font-size:11px;">L3: Docker</td>
              <td style="padding:4px 8px;font-size:11px;">restart:always + HEALTHCHECK</td>
              <td style="padding:4px 8px;font-size:11px;">30秒以内</td>
            </tr>
          </table>
          <div class="doc-h2">5. Service Worker キャッシュ戦略</div>
          <ul class="doc-ul">
            <li><strong>静的アセット (.png/.jpg/.woff2):</strong> Stale-While-Revalidate</li>
            <li><strong>HTML / JS / JSON:</strong> Network-First (失敗時キャッシュ)</li>
            <li><strong>バージョン:</strong> CACHE = 'kintai-v35'</li>
          </ul>
          <div class="doc-h2">6. launchd ジョブ一覧 (5ジョブ)</div>
          <table class="doc-table">
            <tr style="border-bottom:1px solid var(--border-soft);">
              <th style="padding:5px 8px;font-size:11px;">ジョブ名</th>
              <th style="padding:5px 8px;font-size:11px;">スケジュール</th>
              <th style="padding:5px 8px;font-size:11px;">処理</th>
            </tr>
            <tr style="border-bottom:1px solid var(--border-soft);">
              <td style="padding:4px 8px;font-size:10px;font-family:monospace;">com.kintai.server</td>
              <td style="padding:4px 8px;font-size:11px;">常時 (KeepAlive)</td>
              <td style="padding:4px 8px;font-size:11px;">jinjer_server.py 常駐</td>
            </tr>
            <tr style="border-bottom:1px solid var(--border-soft);">
              <td style="padding:4px 8px;font-size:10px;font-family:monospace;">com.kintai.watchdog</td>
              <td style="padding:4px 8px;font-size:11px;">60秒ごと</td>
              <td style="padding:4px 8px;font-size:11px;">port 8899 死活監視・自動再起動</td>
            </tr>
            <tr style="border-bottom:1px solid var(--border-soft);">
              <td style="padding:4px 8px;font-size:10px;font-family:monospace;">com.kintai.structure</td>
              <td style="padding:4px 8px;font-size:11px;">毎朝 07:30</td>
              <td style="padding:4px 8px;font-size:11px;">STRUCTURE.md 自動更新</td>
            </tr>
            <tr style="border-bottom:1px solid var(--border-soft);">
              <td style="padding:4px 8px;font-size:10px;font-family:monospace;">com.kintai.monthly</td>
              <td style="padding:4px 8px;font-size:11px;">毎月1日 08:00</td>
              <td style="padding:4px 8px;font-size:11px;">翌月 Excel 自動生成</td>
            </tr>
            <tr>
              <td style="padding:4px 8px;font-size:10px;font-family:monospace;">com.kintai.jinjer-end</td>
              <td style="padding:4px 8px;font-size:11px;">毎月28日 19:00</td>
              <td style="padding:4px 8px;font-size:11px;">jinjer 月末同期</td>
            </tr>
          </table>`;
      }

      function renderApi() {
        const el = document.getElementById('spec-api');
        if (!el) return;
        el.innerHTML = '<table class="doc-table"><tr style="border-bottom:1px solid var(--border-soft);"><th style="padding:5px 8px;text-align:left;font-size:11px;">M</th><th style="padding:5px 8px;text-align:left;font-size:11px;">エンドポイント</th><th style="padding:5px 8px;text-align:left;font-size:11px;">説明</th></tr>' +
          API_ENDPOINTS.map(ep =>
            '<tr style="border-bottom:1px solid var(--border-soft);"><td style="padding:4px 8px;white-space:nowrap;"><span class="' + (ep.method === 'GET' ? 'badge-get' : 'badge-post') + '">' + ep.method + '</span></td><td style="padding:4px 8px;font-family:monospace;font-size:10px;color:var(--accent-blue);">' + ep.path + '</td><td style="padding:4px 8px;font-size:11px;color:var(--text-muted);">' + ep.desc + '</td></tr>'
          ).join('') + '</table>';
      }

      async function renderStructure() {
        const pre = document.getElementById('spec-structure');
        if (!pre) return;
        pre.textContent = '読み込み中…';
        try {
          const r = await fetch(`${_getApi()}/api/structure`, { signal: AbortSignal.timeout(5000) });
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          const d = await r.json();
          pre.textContent = d.content || '(空)';
        } catch(_) {
          pre.textContent = '(サーバー未接続 — サーバー起動後に🔄を押してください)';
        }
      }

      function _icon(path) {
        const ext = (path.split('.').pop() || '').toLowerCase();
        return { py:'🐍', html:'🌐', js:'⚡', md:'📝', json:'📊', log:'📋',
                 sh:'🔧', yml:'⚙️', plist:'⚙️', txt:'📄', env:'🔐',
                 css:'🎨' }[ext] || '📄';
      }

      // プロジェクト内の主要ファイル一覧（ハードコード → サーバー不要で常に表示）
      const KNOWN_FILES = [
        { group: 'PWA 本体',      files: ['index.html', 'sw.js', 'manifest.json', 'recover.html'] },
        { group: 'サーバー',       files: ['jinjer_server.py', 'sync_jinjer.py', 'report_sync.py', 'create_monthly_report.py', 'generate_structure.py'] },
        { group: 'ドキュメント',   files: ['STRUCTURE.md', 'README.md'] },
        { group: '設定・環境',     files: ['.gitignore', 'requirements.txt'] },
        { group: 'ログ',           files: ['logs/server.log', 'logs/server_err.log', 'logs/watchdog.log', 'logs/jinjer_end.log'] },
      ];

      function _buildKnownFileSelect(extraFiles) {
        const sel = document.getElementById('spec-file-select');
        if (!sel) return;
        sel.innerHTML = '<option value="">── ファイルを選択 ──</option>';
        // 既知ファイル
        KNOWN_FILES.forEach(({ group, files }) => {
          const grp = document.createElement('optgroup');
          grp.label = group;
          files.forEach(f => {
            const opt = document.createElement('option');
            opt.value = f;
            opt.textContent = `${_icon(f)} ${f.split('/').pop()}`;
            grp.appendChild(opt);
          });
          sel.appendChild(grp);
        });
        // サーバーから取得した追加ファイル（重複除く）
        if (extraFiles && extraFiles.length > 0) {
          const known = new Set(KNOWN_FILES.flatMap(g => g.files));
          const extra = extraFiles.filter(f => !known.has(f.path));
          if (extra.length > 0) {
            const grp = document.createElement('optgroup');
            grp.label = 'その他（サーバー検出）';
            extra.forEach(f => {
              const opt = document.createElement('option');
              opt.value = f.path;
              const name = f.path.split('/').pop();
              const kb = f.size > 0 ? ` (${(f.size/1024).toFixed(1)}KB)` : '';
              opt.textContent = `${_icon(f.path)} ${name}${kb}`;
              grp.appendChild(opt);
            });
            sel.appendChild(grp);
          }
        }
      }

      async function loadSpecFiles() {
        // まず既知ファイルリストを即時表示（サーバー不要）
        _buildKnownFileSelect(null);
        // サーバーが繋がっていれば追加ファイルを取得してリストを補完
        try {
          const r = await fetch(`${_getApi()}/api/files`, { signal: AbortSignal.timeout(4000) });
          if (r.ok) {
            const d = await r.json();
            const extras = (d.files || []).filter(f => !f.is_dir);
            _buildKnownFileSelect(extras);
          }
        } catch(_) { /* サーバー未接続でも既知リストは表示済みなのでOK */ }
      }

      // ファイルキャッシュ（サーバー接続時に取得したコンテンツをローカルに保存）
      const _FILE_CACHE_KEY = '_kintai_file_cache_v1';
      // オリジンから直接取得できる PWA ファイル（サーバー不要）
      const _ORIGIN_FILES = new Set(['index.html','sw.js','manifest.json','recover.html']);

      function _loadFileCache() {
        try { return JSON.parse(localStorage.getItem(_FILE_CACHE_KEY) || '{}'); } catch(_) { return {}; }
      }
      function _saveFileCache(cache) {
        try { localStorage.setItem(_FILE_CACHE_KEY, JSON.stringify(cache)); } catch(_) {}
      }
      function _cacheFile(path, content, size) {
        const cache = _loadFileCache();
        cache[path] = { content: content.slice(0, 200 * 1024), size, cachedAt: new Date().toISOString() };
        _saveFileCache(cache);
      }

      async function showSpecFile(path) {
        const pre    = document.getElementById('spec-file-content');
        const status = document.getElementById('spec-file-status');
        if (!pre) return;
        pre.textContent = '読み込み中…';
        if (status) { status.style.display = ''; status.textContent = `📂 ${path}`; }

        const filename = path.split('/').pop();

        // ── 戦略1: PWAファイルはオリジンから直取得（サーバー不要） ──────────────
        if (_ORIGIN_FILES.has(filename)) {
          try {
            const r = await fetch(`${location.origin}/${filename}`, { signal: AbortSignal.timeout(8000) });
            if (r.ok) {
              const text = await r.text();
              pre.textContent = text.length > 200000 ? text.slice(0, 200000) + '\n\n… (先頭200KB のみ表示)' : text;
              if (status) status.textContent = `📂 ${path}  |  ${(text.length/1024).toFixed(1)}KB  ✅ オリジンから直接取得`;
              _cacheFile(path, text, text.length);
              return;
            }
          } catch(_) { /* fallthrough */ }
        }

        // ── 戦略2: サーバーAPI経由で取得し、キャッシュにも保存 ─────────────────
        try {
          const r = await fetch(`${_getApi()}/api/files/read?path=${encodeURIComponent(path)}`,
            { signal: AbortSignal.timeout(10000) });
          if (r.ok) {
            const d = await r.json();
            if (!d.error) {
              pre.textContent = d.content + (d.truncated ? '\n\n… (先頭200KB のみ表示)' : '');
              if (status) status.textContent = `📂 ${path}  |  ${(d.size/1024).toFixed(1)}KB  ☁️ サーバーから取得`;
              _cacheFile(path, d.content, d.size);
              return;
            }
          }
        } catch(_) { /* fallthrough */ }

        // ── 戦略3: ローカルキャッシュから表示（オフライン対応） ──────────────────
        const cache = _loadFileCache();
        if (cache[path]) {
          const c = cache[path];
          const age = Math.round((Date.now() - new Date(c.cachedAt)) / 1000 / 60);
          pre.textContent = c.content + (c.content.length >= 200*1024 ? '\n\n… (先頭200KB のみ表示)' : '');
          if (status) status.textContent = `📂 ${path}  |  📦 キャッシュ (${age}分前取得) — サーバー未接続`;
          return;
        }

        // ── 取得失敗 ────────────────────────────────────────────────────────────
        pre.textContent = [
          `📂 ${path}`,
          '',
          '⚠️  このファイルを表示するには以下のいずれかが必要です:',
          '',
          '  1. ローカルサーバーを起動する (jinjer_server.py)',
          '     → launchctl start com.kintai.server',
          '',
          '  2. 一度サーバー接続時に「🔄」を押してキャッシュを作成する',
          '     → 次回からオフラインでも閲覧可能になります',
          '',
          '  ※ sw.js / manifest.json / index.html は',
          '    サーバー不要でいつでも閲覧できます',
        ].join('\n');
        if (status) status.textContent = `📂 ${path}  ⚠️ 取得不可 (キャッシュなし)`;
      }

      window._initSpecTab = function() {
        if (!_specTabInit) {
          _specTabInit = true;
          document.querySelectorAll('.spec-sub-btn').forEach(btn => {
            btn.addEventListener('click', () => _switchSpecPane(btn.dataset.pane));
          });
          document.getElementById('spec-refresh-btn')?.addEventListener('click', () => {
            _renderedPanes.delete('struct');
            _switchSpecPane('struct');
          });
          document.getElementById('spec-file-refresh-btn')?.addEventListener('click', loadSpecFiles);
          document.getElementById('spec-file-select')?.addEventListener('change', e => {
            if (e.target.value) showSpecFile(e.target.value);
          });
        }
        const active = document.querySelector('.spec-sub-btn.active')?.dataset.pane || 'arch';
        if (!_renderedPanes.has(active)) _switchSpecPane(active);
      };
    })();

    /* =====================================================
       PERFORMANCE ENGINEERING TAB
       ===================================================== */
    (function _initPerfModule() {
      const _PERF_HISTORY_KEY = '_kintai_perf_history_v1';

      /* ─── 計測 ─────────────────────────────────────────── */
      function _measureFPS() {
        return new Promise(resolve => {
          let count = 0;
          const start = performance.now();
          function frame() {
            count++;
            if (performance.now() - start < 600) requestAnimationFrame(frame);
            else resolve(Math.round(count / 0.6));
          }
          requestAnimationFrame(frame);
        });
      }

      async function _measureAll() {
        const result = { ts: new Date().toISOString(), metrics: {} };
        const nav = performance.getEntriesByType('navigation')[0];
        if (nav) {
          result.metrics.pageLoad  = Math.round(nav.loadEventEnd   - nav.startTime);
          result.metrics.ttfb      = Math.round(nav.responseStart  - nav.requestStart);
          result.metrics.domReady  = Math.round(nav.domContentLoadedEventEnd - nav.startTime);
        }
        const mem = performance.memory;
        if (mem) {
          result.metrics.heapUsedMB  = Math.round(mem.usedJSHeapSize  / 1048576 * 10) / 10;
          result.metrics.heapTotalMB = Math.round(mem.totalJSHeapSize / 1048576 * 10) / 10;
        }
        let lsBytes = 0;
        for (const k of Object.keys(localStorage)) lsBytes += (localStorage.getItem(k) || '').length;
        result.metrics.lsKB     = Math.round(lsBytes / 1024);
        result.metrics.swActive = !!(navigator.serviceWorker?.controller);
        result.metrics.online   = navigator.onLine;
        result.metrics.fps      = await _measureFPS();
        const idbStart = performance.now();
        try { await (typeof idbLoad === 'function' ? idbLoad() : Promise.resolve()); } catch(_) {}
        result.metrics.idbMs = Math.round(performance.now() - idbStart);
        result.score = _calcScore(result.metrics);
        return result;
      }

      /* ─── スコア計算 ──────────────────────────────────── */
      function _calcScore(m) {
        const clamp = v => Math.max(0, Math.min(100, v));
        const scores = [];
        if (m.pageLoad   != null) scores.push(clamp(100 - (m.pageLoad  - 500)  / 45));
        if (m.ttfb       != null) scores.push(clamp(100 - (m.ttfb     - 20)   / 5));
        if (m.heapUsedMB != null) scores.push(clamp(100 - (m.heapUsedMB - 20) / 1.5));
        if (m.fps        != null) scores.push(clamp(m.fps / 60 * 100));
        if (m.lsKB       != null) scores.push(clamp(100 - (m.lsKB - 50) / 4));
        if (m.idbMs      != null) scores.push(clamp(100 - m.idbMs));
        return scores.length ? Math.round(scores.reduce((a,b)=>a+b,0) / scores.length) : 0;
      }

      function _scoreInfo(s) {
        if (s >= 90) return { label: '🏆 優秀',   color: '#a3e635' };
        if (s >= 70) return { label: '✅ 良好',   color: '#4ade80' };
        if (s >= 50) return { label: '⚠️ 要改善', color: '#ffa726' };
        return           { label: '🔴 問題あり', color: '#ef5350' };
      }

      /* ─── スコアリング描画 ─────────────────────────────── */
      function _renderScore(score, prevScore) {
        const canvas = document.getElementById('perf-score-canvas');
        const numEl  = document.getElementById('perf-score-num');
        const lblEl  = document.getElementById('perf-score-label');
        const deltaEl = document.getElementById('perf-score-delta');
        const timeEl  = document.getElementById('perf-score-time');
        if (!canvas) return;
        const { label, color } = _scoreInfo(score);
        // Canvas ring
        const ctx = canvas.getContext('2d');
        const cx = 40, cy = 40, r = 34;
        ctx.clearRect(0,0,80,80);
        ctx.beginPath(); ctx.arc(cx,cy,r,0,2*Math.PI);
        ctx.strokeStyle = '#1e293b'; ctx.lineWidth = 7; ctx.stroke();
        ctx.beginPath(); ctx.arc(cx,cy,r,-Math.PI/2,-Math.PI/2 + 2*Math.PI*(score/100));
        ctx.strokeStyle = color; ctx.lineWidth = 7; ctx.lineCap = 'round'; ctx.stroke();
        // テキスト
        numEl.textContent = score; numEl.style.color = color;
        lblEl.textContent = label; lblEl.style.color = color;
        if (prevScore != null) {
          const d = score - prevScore;
          deltaEl.textContent = d >= 0 ? `▲ +${d}pt (前回比)` : `▼ ${d}pt (前回比)`;
          deltaEl.style.color = d >= 0 ? '#4ade80' : '#ef5350';
        }
        timeEl.textContent = `最終計測: ${new Date().toLocaleString('ja-JP')}`;
      }

      /* ─── 指標グリッド ────────────────────────────────── */
      const _METRIC_DEFS = [
        { key: 'pageLoad',   icon: '📦', label: 'ページロード',  unit: 'ms',  good: 1000, bad: 5000,
          desc: 'ページが完全に読み込まれるまでの時間。<strong>2秒以内</strong>が目標。SWキャッシュを有効にすると劇的に改善します。' },
        { key: 'ttfb',       icon: '⚡', label: 'TTFB',          unit: 'ms',  good: 100,  bad: 500,
          desc: 'Time To First Byte: サーバーが最初の1バイトを返すまでの時間。<strong>100ms以内</strong>が優秀。ネットワーク遅延の指標。' },
        { key: 'domReady',   icon: '🌐', label: 'DOM Ready',     unit: 'ms',  good: 1500, bad: 4000,
          desc: 'DOMContentLoaded イベントまでの時間。HTMLの解析完了タイミング。JSの実行ブロッキングに敏感。' },
        { key: 'heapUsedMB', icon: '🧠', label: 'JSヒープ使用量', unit: 'MB', good: 30,   bad: 150,
          desc: 'JavaScript エンジンが使用中のメモリ量。増えるとGCが頻発しUIがカクつく。<strong>50MB以内</strong>推奨。' },
        { key: 'fps',        icon: '🎞', label: 'フレームレート', unit: 'fps', good: 58,   bad: 20, higherBetter: true,
          desc: '1秒間に描画されるフレーム数。<strong>60fps</strong>が理想。低いとスクロールやアニメーションがガクガクする。' },
        { key: 'lsKB',       icon: '💾', label: 'LS使用量',      unit: 'KB',  good: 100,  bad: 500,
          desc: 'localStorage の使用量。上限5MB。<strong>200KB以内</strong>推奨。大きいと同期読み書きがUIをブロックする。' },
        { key: 'idbMs',      icon: '🗄', label: 'IDB応答時間',   unit: 'ms',  good: 20,   bad: 200,
          desc: 'IndexedDB の読み取り応答時間。<strong>50ms以内</strong>が快適。遅い場合はトランザクション設計を見直す。' },
      ];

      function _renderMetrics(m) {
        const grid = document.getElementById('perf-metrics-grid');
        if (!grid) return;
        const clamp = v => Math.max(0,Math.min(100,v));
        grid.innerHTML = _METRIC_DEFS.map(def => {
          const val = m[def.key];
          if (val == null) return '';
          const pct = def.higherBetter
            ? clamp((val - def.bad) / (def.good - def.bad) * 100)
            : clamp((def.bad - val) / (def.bad - def.good) * 100);
          const color = pct >= 70 ? '#4ade80' : pct >= 40 ? '#ffa726' : '#ef5350';
          const status = pct >= 70 ? '✅' : pct >= 40 ? '⚠️' : '🔴';
          return `<div style="background:var(--bg-card-solid,#1e293b);border-radius:10px;padding:10px;border:1px solid var(--border-soft);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
              <span style="font-size:10px;color:var(--text-muted);">${def.icon} ${def.label}</span>
              <span style="font-size:11px;">${status}</span>
            </div>
            <div style="font-size:20px;font-weight:800;color:${color};">${val.toLocaleString()}<span style="font-size:11px;font-weight:400;color:var(--text-muted);"> ${def.unit}</span></div>
            <div style="height:4px;background:#0d1117;border-radius:2px;margin-top:6px;overflow:hidden;">
              <div style="height:100%;width:${pct}%;background:${color};border-radius:2px;transition:width 0.6s;"></div>
            </div>
            <div style="font-size:9px;color:var(--text-muted);margin-top:5px;line-height:1.5;">${def.desc}</div>
          </div>`;
        }).join('') + `
          <div style="background:var(--bg-card-solid,#1e293b);border-radius:10px;padding:10px;border:1px solid var(--border-soft);">
            <div style="font-size:10px;color:var(--text-muted);margin-bottom:4px;">🔄 Service Worker</div>
            <div style="font-size:18px;font-weight:800;color:${m.swActive?'#4ade80':'#ef5350'};">${m.swActive?'✅ 有効':'❌ 無効'}</div>
            <div style="font-size:9px;color:var(--text-muted);margin-top:6px;line-height:1.5;">SWが有効だとキャッシュ経由で応答。2回目以降のページロードが<strong>最大70%高速化</strong>される。</div>
          </div>
          <div style="background:var(--bg-card-solid,#1e293b);border-radius:10px;padding:10px;border:1px solid var(--border-soft);">
            <div style="font-size:10px;color:var(--text-muted);margin-bottom:4px;">🌐 ネットワーク</div>
            <div style="font-size:18px;font-weight:800;color:${m.online?'#4ade80':'#ffa726'};">${m.online?'✅ オンライン':'⚠️ オフライン'}</div>
            <div style="font-size:9px;color:var(--text-muted);margin-top:6px;line-height:1.5;">オフライン時はSWキャッシュから応答。API系機能はローカルサーバーが必要。</div>
          </div>`;
      }

      /* ─── 改善提案 ───────────────────────────────────── */
      function _renderSuggestions(m) {
        const el = document.getElementById('perf-suggestions');
        if (!el) return;
        const tips = [];

        if (!m.swActive) tips.push({ sev:'error', icon:'🔄',
          title: 'Service Worker が無効 — オフラインキャッシュが機能していません',
          detail: 'SWが動作していないためページ毎回フルロードが発生しています。http://localhost:8899/ または GitHub Pages URL からアクセスしてください。',
          effect: 'SW有効化で2回目以降のロード最大70%高速化' });

        if (m.pageLoad > 2000) tips.push({ sev:'warn', icon:'📦',
          title: `ページロード ${m.pageLoad}ms — 目標2秒以内`,
          detail: 'index.html が大規模のため初回パース・実行時間が長くなっています。タブごとに遅延ロードを実装（コードスプリッティング）することで改善できます。',
          effect: '遅延ロード実装で初回ロード最大30〜40%短縮' });

        if (m.heapUsedMB > 80) tips.push({ sev:'warn', icon:'🧠',
          title: `JSヒープ ${m.heapUsedMB}MB — メモリ最適化推奨`,
          detail: 'イベントリスナー未解除・大きな配列の参照保持・クロージャリークが考えられます。Chrome DevTools の Memory タブでHeap Snapshotを比較し、特定してください。',
          effect: 'リーク解消でGC停止削減・FPS向上・電池消費改善' });

        if (m.lsKB > 200) tips.push({ sev:'warn', icon:'💾',
          title: `localStorage ${m.lsKB}KB — IndexedDBへの移行を検討`,
          detail: `localStorage の同期APIはUIスレッドをブロックします。スナップショット・ログなど大きなデータをIndexedDBに移行すると推定${Math.round(m.lsKB*0.3)}KB削減できます。`,
          effect: `推定${Math.round(m.lsKB*0.3)}KB削減・LS書き込み最大20%高速化` });

        if (m.fps < 50) tips.push({ sev:'warn', icon:'🎞',
          title: `フレームレート ${m.fps}fps — UI描画の最適化が必要`,
          detail: '過多なDOM再描画・重いCSS(filter/blur)・長いJS処理がメインスレッドを占有しています。Chrome DevTools Performance タブでLong Taskを特定してください。',
          effect: 'レンダリング最適化でUX体感速度が大幅改善' });

        if (m.idbMs > 100) tips.push({ sev:'info', icon:'🗄',
          title: `IDB応答 ${m.idbMs}ms — 並列化で短縮可能`,
          detail: '複数のIDB操作を直列ではなく Promise.all で並列実行することで応答時間を短縮できます。また、頻繁にアクセスするデータはメモリキャッシュ（変数）に持つことも有効です。',
          effect: `並列化実装で最大${Math.round(m.idbMs*0.4)}ms短縮` });

        if (m.ttfb > 200) tips.push({ sev:'info', icon:'⚡',
          title: `TTFB ${m.ttfb}ms — サーバー応答時間を短縮できます`,
          detail: 'TTFBが大きい場合、ローカルサーバー(jinjer_server.py)の処理が重い可能性があります。ログ取得・API処理のキャッシュを強化してください。',
          effect: 'APIキャッシュ強化でAPIレスポンス最大50%短縮' });

        if (tips.length === 0) tips.push({ sev:'ok', icon:'🏆',
          title: '現在の問題は検出されませんでした',
          detail: 'システムは良好な状態です。定期的に計測することで性能劣化を早期発見できます。次のステップとしてAIベンチマークを実行して各モデルの速度を比較してみてください。',
          effect: '' });

        const colors = { error:'#ef5350', warn:'#ffa726', info:'#60a5fa', ok:'#4ade80' };
        el.innerHTML = tips.map(t => `
          <div style="border-left:3px solid ${colors[t.sev]};padding:8px 12px;margin-bottom:8px;background:rgba(255,255,255,0.02);border-radius:0 8px 8px 0;">
            <div style="font-weight:600;margin-bottom:4px;font-size:13px;">${t.icon} ${t.title}</div>
            <div style="color:var(--text-muted);line-height:1.7;font-size:11px;">${t.detail}</div>
            ${t.effect ? `<div style="color:${colors[t.sev]};font-size:11px;margin-top:5px;font-weight:700;">📊 期待効果: ${t.effect}</div>` : ''}
          </div>`).join('');
      }

      /* ─── 計測履歴 ───────────────────────────────────── */
      function _saveHistory(result) {
        let h = [];
        try { h = JSON.parse(localStorage.getItem(_PERF_HISTORY_KEY) || '[]'); } catch(_) {}
        h.unshift(result);
        if (h.length > 30) h = h.slice(0, 30);
        localStorage.setItem(_PERF_HISTORY_KEY, JSON.stringify(h));
        return h;
      }

      function _renderHistory(history) {
        const el = document.getElementById('perf-history-list');
        if (!el) return;
        if (!history.length) {
          el.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:14px;font-size:12px;">「計測する」ボタンを押すと履歴が記録されます</div>';
          return;
        }
        el.innerHTML = `<table style="width:100%;border-collapse:collapse;font-size:11px;">
          <thead><tr style="color:var(--text-muted);border-bottom:1px solid var(--border-soft);">
            <th style="text-align:left;padding:4px;">日時</th>
            <th style="text-align:center;padding:4px;">スコア</th>
            <th style="text-align:center;padding:4px;">変化</th>
            <th style="text-align:right;padding:4px;">ロード</th>
            <th style="text-align:right;padding:4px;">ヒープ</th>
            <th style="text-align:right;padding:4px;">FPS</th>
          </tr></thead>
          <tbody>${history.map((h,i) => {
            const prev = history[i+1];
            const diff = prev != null ? h.score - prev.score : null;
            const diffStr = diff == null ? '<span style="color:var(--text-muted)">初回</span>'
              : diff > 0  ? `<span style="color:#4ade80">▲+${diff}</span>`
              : diff < 0  ? `<span style="color:#ef5350">▼${diff}</span>`
              : `<span style="color:var(--text-muted)">±0</span>`;
            const { color } = _scoreInfo(h.score);
            const dt = new Date(h.ts).toLocaleString('ja-JP',{month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
            return `<tr style="border-bottom:1px solid rgba(255,255,255,0.04);">
              <td style="padding:4px;color:var(--text-muted);">${dt}</td>
              <td style="text-align:center;font-weight:800;color:${color};">${h.score}</td>
              <td style="text-align:center;">${diffStr}</td>
              <td style="text-align:right;color:var(--text-muted);">${h.metrics?.pageLoad??'--'}ms</td>
              <td style="text-align:right;color:var(--text-muted);">${h.metrics?.heapUsedMB??'--'}MB</td>
              <td style="text-align:right;color:var(--text-muted);">${h.metrics?.fps??'--'}</td>
            </tr>`;
          }).join('')}</tbody></table>`;
      }

      /* ─── AI ベンチマーク ────────────────────────────── */
      async function _runAiBench() {
        const el = document.getElementById('perf-ai-bench-result');
        if (!el) return;
        el.innerHTML = '<div style="color:var(--text-muted);font-size:12px;padding:8px;">APIキーを確認中...</div>';
        let sens = null;
        try { sens = await loadSensitiveData(); } catch(_) {}
        const models = [
          { name:'Claude (Haiku)',  key: sens?.aiKeyClaude,  fn: _bClaude },
          { name:'GPT-4o mini',    key: sens?.aiKeyOpenAI,  fn: _bOpenAI },
          { name:'Gemini Flash',   key: sens?.aiKeyGemini,  fn: _bGemini },
        ].filter(m => m.key);
        if (!models.length) {
          el.innerHTML = '<div style="color:var(--text-muted);font-size:12px;padding:8px;">⚠️ AIタブでAPIキーを設定してから実行してください。設定済みのモデルのみ計測されます。</div>';
          return;
        }
        const PROMPT = 'ベンチマーク: 「パフォーマンス」を英語で一言だけ答えてください。';
        el.innerHTML = `<div style="color:var(--text-muted);font-size:12px;padding:8px;">⏱ 計測中 (${models.length}モデル)... ${PROMPT}</div>`;
        const results = [];
        for (const m of models) {
          const t0 = performance.now();
          try {
            const { text } = await m.fn(m.key, PROMPT);
            const ms = Math.round(performance.now() - t0);
            results.push({ name:m.name, ms, chars:text.length, cps:Math.round(text.length/ms*1000), ok:true, text });
          } catch(e) {
            results.push({ name:m.name, ms:Math.round(performance.now()-t0), ok:false, err:e.message });
          }
        }
        const best = results.filter(r=>r.ok).sort((a,b)=>a.ms-b.ms)[0];
        el.innerHTML = `
          <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">
            プロンプト: <em>「${PROMPT}」</em><br>
            ${best ? `🏆 最速: <strong style="color:#a3e635">${best.name}</strong> — ${best.ms}ms` : ''}
          </div>
          <div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:12px;min-width:320px;">
            <thead><tr style="color:var(--text-muted);border-bottom:1px solid var(--border-soft);">
              <th style="text-align:left;padding:5px;">モデル</th>
              <th style="text-align:right;padding:5px;">応答時間</th>
              <th style="text-align:right;padding:5px;">文字/秒</th>
              <th style="text-align:right;padding:5px;">文字数</th>
              <th style="text-align:left;padding:5px;">応答内容</th>
            </tr></thead>
            <tbody>${results.map(r => {
              const isBest = best && r.name===best.name;
              const c = isBest?'#a3e635':'var(--text-primary)';
              return `<tr style="border-bottom:1px solid rgba(255,255,255,0.04);${isBest?'background:rgba(163,230,53,0.05);':''}">
                <td style="padding:5px;font-weight:${isBest?'700':'400'};color:${c};">${isBest?'🏆 ':''}${r.name}</td>
                <td style="text-align:right;padding:5px;font-family:monospace;">${r.ok?r.ms+'ms':'ERR'}</td>
                <td style="text-align:right;padding:5px;font-family:monospace;">${r.ok?r.cps+'字/秒':'--'}</td>
                <td style="text-align:right;padding:5px;color:var(--text-muted);">${r.ok?r.chars+'字':'--'}</td>
                <td style="padding:5px;color:var(--text-muted);font-size:10px;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${r.ok?(r.text||''):(r.err||'')}</td>
              </tr>`;
            }).join('')}</tbody>
          </table></div>
          <div style="font-size:10px;color:var(--text-muted);margin-top:8px;line-height:1.6;">
            ※ 応答時間 = ブラウザ〜APIサーバー往復時間（ネットワーク遅延込み）。文字/秒 = 応答文字数÷応答時間×1000。<br>
            ※ AIエージェント設計では「最速モデルをルーティング」することでシステム全体のスループットを最大化できます。
          </div>`;
      }

      async function _bClaude(key, p) {
        const r = await fetch('https://api.anthropic.com/v1/messages',{method:'POST',
          headers:{'x-api-key':key,'anthropic-version':'2023-06-01','content-type':'application/json','anthropic-dangerous-allow-browser':'true'},
          body:JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:30,messages:[{role:'user',content:p}]}),
          signal:AbortSignal.timeout(30000)});
        const d = await r.json(); return {text:d.content?.[0]?.text||''};
      }
      async function _bOpenAI(key, p) {
        const r = await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',
          headers:{'Authorization':`Bearer ${key}`,'Content-Type':'application/json'},
          body:JSON.stringify({model:'gpt-4o-mini',max_tokens:30,messages:[{role:'user',content:p}]}),
          signal:AbortSignal.timeout(30000)});
        const d = await r.json(); return {text:d.choices?.[0]?.message?.content||''};
      }
      async function _bGemini(key, p) {
        const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`,{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({contents:[{parts:[{text:p}]}],generationConfig:{maxOutputTokens:30}}),
          signal:AbortSignal.timeout(30000)});
        const d = await r.json(); return {text:d.candidates?.[0]?.content?.parts?.[0]?.text||''};
      }

      /* ─── 学習ロードマップ ───────────────────────────── */
      function _renderLearningMap() {
        const el = document.getElementById('perf-learning-map');
        if (!el) return;
        const items = [
          { phase:'Phase 1', icon:'📐', label:'Web Vitals 習得',
            desc:'LCP・FID・CLS・TTFBをGoogleの標準指標として理解し、自分で計測できるようにする。銀行系システムのSLA設計にも直結する基礎スキル。',
            tools:'Lighthouse, Chrome DevTools, PageSpeed Insights', color:'#4ade80' },
          { phase:'Phase 2', icon:'🔍', label:'プロファイリング技術',
            desc:'CPU・メモリ・ネットワーク・レンダリングのボトルネックを特定できるようになる。Long Taskの検出・Heap Snapshotの読み方を習得。',
            tools:'Chrome DevTools Performance/Memory タブ, React Profiler', color:'#a3e635' },
          { phase:'Phase 3', icon:'⚡', label:'AI推論高速化 (重要)',
            desc:'モデル量子化・バッチ処理・KVキャッシュ・ストリーミング応答を使いAI APIのコストと遅延を最小化する。複数モデルの並列実行とルーティング設計。',
            tools:'Anthropic/OpenAI API, vLLM, ONNX Runtime, TensorRT', color:'#fbbf24' },
          { phase:'Phase 4', icon:'🏗', label:'フロントエンド最適化設計',
            desc:'コードスプリッティング・遅延ロード・Service Worker・CDNエッジキャッシュを組み合わせたパフォーマンスアーキテクチャを設計できる。',
            tools:'Webpack/Vite, Workbox, Cloudflare Workers', color:'#fb923c' },
          { phase:'Phase 5', icon:'🏦', label:'金融系パフォーマンス要件',
            desc:'リスク計算エンジンの応答時間SLA・大量バッチ処理の並列化・リアルタイム監視ダッシュボード設計。現業の銀行システム知識が武器になる。',
            tools:'JMeter, Gatling, Prometheus, Grafana', color:'#f87171' },
          { phase:'Phase 6', icon:'🤖', label:'AIエージェント × パフォーマンス',
            desc:'複数AIエージェントの並列実行・推論パイプラインの設計・コスト対効果の最適化・人間の介入を最小化する自律システムの性能チューニング。これが次世代の差別化スキル。',
            tools:'Claude API, LangGraph, CrewAI, Temporal, Ray', color:'#e879f9' },
        ];
        el.innerHTML = items.map(item => `
          <div style="display:flex;gap:12px;margin-bottom:14px;align-items:flex-start;">
            <div style="width:36px;height:36px;border-radius:50%;background:${item.color};display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;">${item.icon}</div>
            <div style="flex:1;border-left:2px solid var(--border-soft);padding-left:12px;">
              <div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;">
                <span style="font-size:9px;background:${item.color};color:#000;padding:1px 7px;border-radius:10px;font-weight:700;">${item.phase}</span>
                <span style="font-size:13px;font-weight:700;">${item.label}</span>
              </div>
              <div style="font-size:11px;color:var(--text-muted);line-height:1.6;margin-bottom:3px;">${item.desc}</div>
              <div style="font-size:10px;color:#60a5fa;">🔧 推奨ツール: ${item.tools}</div>
            </div>
          </div>`).join('');
      }

      /* ─── タブ初期化 ──────────────────────────────────── */
      window._initPerfTab = async function() {
        // 学習マップは常に表示
        _renderLearningMap();

        // 既存履歴を表示
        let history = [];
        try { history = JSON.parse(localStorage.getItem(_PERF_HISTORY_KEY) || '[]'); } catch(_) {}
        _renderHistory(history);
        if (history[0]) {
          _renderScore(history[0].score, history[1]?.score);
          _renderMetrics(history[0].metrics);
          _renderSuggestions(history[0].metrics);
        }

        // 計測ボタン（2重バインド防止）
        const btn = document.getElementById('perf-measure-btn');
        if (btn && !btn._perfBound) {
          btn._perfBound = true;
          btn.addEventListener('click', async () => {
            btn.disabled = true; btn.textContent = '計測中...';
            try {
              const result = await _measureAll();
              const hist   = _saveHistory(result);
              _renderScore(result.score, hist[1]?.score);
              _renderMetrics(result.metrics);
              _renderSuggestions(result.metrics);
              _renderHistory(hist);
              toast(`⚡ 計測完了: ${result.score}点`);
            } finally {
              btn.disabled = false; btn.textContent = '📊 計測する';
            }
          });
        }

        // AI ベンチマークボタン
        const aiBtn = document.getElementById('perf-ai-bench-btn');
        if (aiBtn && !aiBtn._perfBound) {
          aiBtn._perfBound = true;
          aiBtn.addEventListener('click', async () => {
            aiBtn.disabled = true; aiBtn.textContent = '計測中...';
            await _runAiBench();
            aiBtn.disabled = false; aiBtn.textContent = '▶ 実行';
          });
        }

        // 履歴クリア
        const clrBtn = document.getElementById('perf-history-clear');
        if (clrBtn && !clrBtn._perfBound) {
          clrBtn._perfBound = true;
          clrBtn.addEventListener('click', () => {
            if (!confirm('計測履歴をすべて削除しますか？')) return;
            localStorage.removeItem(_PERF_HISTORY_KEY);
            _renderHistory([]);
            toast('🗑 計測履歴を削除しました');
          });
        }
      };
    })();

    /* =====================================================
       LOGS TAB
       ===================================================== */
    (function _initLogsTabModule() {
      const _LOG_FIX_PATTERNS = [
        { re: /openpyxl/i,                         fix: '▶ pip install openpyxl を実行してください' },
        { re: /Connection reset by peer/i,          fix: '▶ watchdog 再起動の可能性。ThreadingMixIn が有効か確認してください' },
        { re: /Address already in use/i,            fix: '▶ 既存プロセスが port 8899 を使用中。lsof -i:8899 で確認して kill してください' },
        { re: /ModuleNotFoundError/i,               fix: '▶ 必要なモジュールがありません。pip install -r requirements.txt を実行してください' },
        { re: /PermissionError/i,                   fix: '▶ ファイルアクセス権限エラー。chmod 644 対象ファイル で修正してください' },
        { re: /Traceback/i,                         fix: '▶ Python 例外が発生しています。server_err.log の詳細を確認してください' },
        { re: /ReferenceError.*uninitialized/i,     fix: '▶ JavaScript 変数の TDZ (一時的デッドゾーン) エラー。変数宣言位置を確認してください' },
        { re: /Cannot access.*before initialization/i, fix: '▶ JavaScript const/let の宣言順序に問題があります。使用前に宣言してください' },
        { re: /IDB復元スキップ/i,                   fix: '▶ IndexedDB 復元に失敗しました。ブラウザのストレージ権限を確認するか、設定 → バックアップから手動復元してください' },
        { re: /SyntaxError/i,                       fix: '▶ コードの構文エラーです。開発者ツールのコンソールで詳細を確認してください' },
        { re: /TypeError/i,                         fix: '▶ 型エラーです。null/undefined のプロパティアクセスがないか確認してください' },
        { re: /NetworkError|fetch.*failed|Load failed/i, fix: '▶ ネットワークエラーです。サーバーが起動しているか、URL が正しいか確認してください' },
        { re: /ECONNREFUSED|connect ECONNREFUSED/i, fix: '▶ サーバーへの接続が拒否されました。jinjer_server.py が起動しているか確認してください (launchctl list | grep kintai)' },
        { re: /timeout|ETIMEDOUT/i,                 fix: '▶ タイムアウトです。サーバーが高負荷か停止している可能性があります' },
        { re: /login|認証|auth/i,                   fix: '▶ 認証エラーです。jinjer のログイン情報 (.env) を確認してください' },
        { re: /disk.*full|No space left/i,          fix: '▶ ディスクがいっぱいです。不要なファイルを削除してください (df -h で確認)' },
      ];

      let _logsCurrentSrc   = 'app';   // アプリログはサーバー不要で常時表示
      let _logsCurrentLevel = 'all';
      let _rawLines         = [];
      let _rawObjects       = null;    // アプリソース時のみ JSON オブジェクト配列

      function _classifyLine(line) {
        if (/\bFATAL\b/i.test(line))                                        return 'fatal';
        if (/\bERROR\b|\bError\b|Traceback|Exception|ECONNREFUSED/i.test(line)) return 'error';
        if (/\bWARN(ING)?\b|警告/i.test(line))                              return 'warn';
        return 'info';
      }

      function _esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

      function _renderLines(keyword) {
        const el = document.getElementById('logs-content');
        const countEl = document.getElementById('logs-count');
        if (!el) return;
        // {line, obj} ペアを作成（オブジェクト情報を保持）
        const pairs = _rawLines.map((line, i) => ({ line, obj: _rawObjects ? _rawObjects[i] : null }));
        const filtered = pairs.filter(({ line }) => {
          if (_logsCurrentLevel !== 'all' && _classifyLine(line) !== _logsCurrentLevel) return false;
          if (keyword && !line.toLowerCase().includes(keyword.toLowerCase())) return false;
          return true;
        });
        countEl.textContent = `${filtered.length} 件 / 全 ${_rawLines.length} 件`;
        if (filtered.length === 0) {
          el.innerHTML = `<div style="color:#4b5563;font-size:12px;text-align:center;padding:20px;">該当ログなし</div>`;
          return;
        }
        el.innerHTML = filtered.map(({ line, obj }) => {
          const level = _classifyLine(line);
          let cls = 'color:#a3e635;';
          if (level === 'fatal') cls = 'color:#ff1744;background:rgba(198,40,40,0.2);border-left:3px solid #ff1744;padding-left:6px;';
          else if (level === 'error') cls = 'color:#ef5350;background:rgba(198,40,40,0.12);border-left:3px solid #ef5350;padding-left:6px;';
          else if (level === 'warn')  cls = 'color:#ffa726;background:rgba(230,81,0,0.08);border-left:3px solid #ffa726;padding-left:6px;';
          let hint = '';
          if (level === 'error' || level === 'warn' || level === 'fatal') {
            if (obj && window._logSuggestion) {
              // アプリログ: オブジェクトから contextual 改善提案
              const sug = window._logSuggestion(obj.source || obj.tag, obj.msg, obj.level);
              if (sug) hint = `<div style="font-size:11px;color:#60a5fa;padding:3px 8px 3px 12px;background:rgba(96,165,250,0.08);border-radius:4px;margin:2px 0;">💡 ${_esc(sug)}</div>`;
            }
            if (!hint) {
              // サーバーログ or マッチなし: テキストパターンマッチ
              const pat = _LOG_FIX_PATTERNS.find(p => p.re.test(line));
              if (pat) hint = `<div style="font-size:11px;color:#60a5fa;padding:3px 8px 3px 12px;background:rgba(96,165,250,0.08);border-radius:4px;margin:2px 0;">▶ ${_esc(pat.fix)}</div>`;
            }
          }
          return `<div style="padding:1px 4px;line-height:1.6;${cls}">${_esc(line)}${hint}</div>`;
        }).join('');
        el.scrollTop = el.scrollHeight;
      }

      async function _loadLogs(src) {
        const el = document.getElementById('logs-content');
        if (!el) return;
        el.innerHTML = `<div style="color:#4b5563;font-size:12px;text-align:center;padding:20px;">読み込み中...</div>`;
        if (src === 'app') {
          // アプリログ: localStorage の _kintai_log から取得（オブジェクト保持）
          try {
            const raw = localStorage.getItem('_kintai_log') || '[]';
            const entries = JSON.parse(raw);
            _rawObjects = entries;
            _rawLines   = entries.map(e => {
              const ts  = (e.ts || '').replace('T', ' ').slice(0, 19);
              const lvl = (e.level || 'info').toUpperCase();
              const src = e.source || e.tag || 'app';
              return `${ts} [${lvl}] [${src}] ${e.msg || ''}`;
            });
          } catch(_) { _rawObjects = null; _rawLines = ['(アプリログ取得失敗)']; }
          _renderLines();
          return;
        }
        _rawObjects = null;  // サーバー/Watchdog ソースはオブジェクトなし
        const base = window._srvBase || 'http://localhost:8899';
        try {
          const r = await fetch(`${base}/api/system/logs?type=${src}&lines=500`, { signal: AbortSignal.timeout(6000) });
          if (!r.ok) throw new Error('HTTP ' + r.status);
          const d = await r.json();
          _rawLines = (d.lines || []);
        } catch(e) {
          _rawLines = [`(ログ取得失敗: サーバーに接続できません — ${e.message})`];
        }
        _renderLines();
      }

      let _logsCurrentDate = new Date().toISOString().slice(0, 10);
      let _logsBound = false;

      // IDB日次ログからアプリログを読み込む（日付ブラウザ用）
      async function _loadAppLogForDate(date) {
        const today = new Date().toISOString().slice(0, 10);
        if (date === today) {
          // 当日はリングバッファから（最新）
          try {
            const raw = localStorage.getItem('_kintai_log') || '[]';
            const entries = JSON.parse(raw);
            _rawObjects = entries;
            _rawLines   = entries.map(e => {
              const ts  = (e.ts || '').replace('T', ' ').slice(0, 19);
              const lvl = (e.level || 'info').toUpperCase();
              const src = e.source || e.tag || 'app';
              return `${ts} [${lvl}] [${src}] ${e.msg || ''}`;
            });
          } catch(_) { _rawObjects = null; _rawLines = ['(アプリログ取得失敗)']; }
        } else {
          // 過去日はIDBアーカイブから
          try {
            const rec = await idbLoadLogsDaily(date);
            const entries = rec?.entries || [];
            if (entries.length === 0) {
              _rawObjects = null;
              _rawLines = [`(${date} のログはアーカイブにありません)`];
            } else {
              _rawObjects = entries;
              _rawLines   = entries.map(e => {
                const ts  = (e.ts || '').replace('T', ' ').slice(0, 19);
                const lvl = (e.level || 'info').toUpperCase();
                const src = e.source || e.tag || 'app';
                return `${ts} [${lvl}] [${src}] ${e.msg || ''}`;
              });
            }
          } catch(_) { _rawObjects = null; _rawLines = [`(${date} のIDB読み込み失敗)`]; }
        }
        _renderLines();
      }

      // 直近7日の統計サマリー + ミニグラフ
      async function _renderStats() {
        const barEl = document.getElementById('logs-stats-bar');
        const cvs   = document.getElementById('logs-mini-chart');
        if (!barEl || !cvs) return;

        const today = new Date().toISOString().slice(0, 10);
        // 当日のリングバッファ統計
        let fatal = 0, error = 0, warn = 0, info = 0;
        try {
          const raw = localStorage.getItem('_kintai_log') || '[]';
          JSON.parse(raw).forEach(e => {
            const lv = (e.level || 'info').toLowerCase();
            if (lv === 'fatal') fatal++;
            else if (lv === 'error') error++;
            else if (lv === 'warn') warn++;
            else info++;
          });
        } catch(_) {}
        barEl.innerHTML = [
          fatal > 0 ? `<span style="color:#ff1744;font-weight:700;">💀 FATAL: ${fatal}</span>` : '',
          `<span style="color:#ef5350;">🔴 ERROR: ${error}</span>`,
          `<span style="color:#ffa726;">🟡 WARN: ${warn}</span>`,
          `<span style="color:#60a5fa;">🔵 INFO: ${info}</span>`,
          `<span style="color:var(--text-muted);font-size:10px;">(当日・リングバッファ)</span>`,
        ].filter(Boolean).join('&nbsp;&nbsp;');

        // 直近7日ミニバーグラフ
        const days = [];
        for (let i = 6; i >= 0; i--) {
          const d = new Date(); d.setDate(d.getDate() - i);
          days.push(d.toISOString().slice(0, 10));
        }
        const counts = await Promise.all(days.map(async d => {
          if (d === today) return { fatal, error, warn, info };
          try {
            const rec = await idbLoadLogsDaily(d);
            const arr = rec?.entries || [];
            let f=0,e=0,w=0,n=0;
            arr.forEach(en => {
              const lv = (en.level||'info').toLowerCase();
              if (lv==='fatal') f++; else if (lv==='error') e++; else if (lv==='warn') w++; else n++;
            });
            return {fatal:f,error:e,warn:w,info:n};
          } catch(_) { return {fatal:0,error:0,warn:0,info:0}; }
        }));

        const ctx = cvs.getContext('2d');
        const W = cvs.offsetWidth || 300; cvs.width = W;
        const H = cvs.height = 36;
        ctx.clearRect(0, 0, W, H);
        const maxTotal = Math.max(1, ...counts.map(c => c.fatal + c.error + c.warn + c.info));
        const bw = Math.floor(W / 7) - 2;
        days.forEach((d, i) => {
          const c = counts[i];
          const total = c.fatal + c.error + c.warn + c.info;
          const x = i * (bw + 2) + 1;
          let y = H;
          const draw = (val, col) => {
            if (!val) return;
            const h = Math.max(2, Math.round((val / maxTotal) * (H - 4)));
            ctx.fillStyle = col; y -= h;
            ctx.fillRect(x, y, bw, h);
          };
          draw(c.info,  '#1e3a5f');
          draw(c.warn,  '#7c3300');
          draw(c.error, '#7f1d1d');
          draw(c.fatal, '#ff1744');
          if (d === today) { ctx.strokeStyle = '#a3e635'; ctx.lineWidth = 1; ctx.strokeRect(x-0.5, 1, bw+1, H-2); }
        });
      }

      window._initLogsTab = function() {
        if (_logsBound) { _loadLogs(_logsCurrentSrc); _renderStats(); return; }
        _logsBound = true;

        // 日付入力を今日で初期化
        const dateInput = document.getElementById('logs-date-input');
        if (dateInput) dateInput.value = _logsCurrentDate;

        // フィルターボタン
        document.querySelectorAll('.logs-lvl-btn').forEach(btn => {
          btn.onclick = () => {
            _logsCurrentLevel = btn.dataset.level;
            document.querySelectorAll('.logs-lvl-btn').forEach(b => {
              b.style.background = 'none';
              b.style.color = b.dataset.level === 'all' ? 'var(--text-primary)' : (b.style.borderColor || 'var(--text-muted)');
            });
            btn.style.background = 'var(--accent,#a3e635)';
            btn.style.color = '#000';
            _renderLines(document.getElementById('logs-search-input')?.value.trim());
          };
        });

        // ソースボタン
        document.querySelectorAll('.logs-src-btn').forEach(btn => {
          btn.onclick = () => {
            _logsCurrentSrc = btn.dataset.src;
            document.querySelectorAll('.logs-src-btn').forEach(b => {
              b.style.background = 'none'; b.style.fontWeight = 'normal';
            });
            btn.style.background = 'var(--bg-card-solid,#1e293b)';
            btn.style.fontWeight = '700';
            _loadLogs(_logsCurrentSrc);
          };
        });

        // 日付ナビゲーション
        function _shiftDate(days) {
          const d = new Date(_logsCurrentDate + 'T00:00:00');
          d.setDate(d.getDate() + days);
          const nd = d.toISOString().slice(0, 10);
          const today = new Date().toISOString().slice(0, 10);
          if (nd > today) return;  // 未来には進まない
          _logsCurrentDate = nd;
          if (dateInput) dateInput.value = nd;
          if (_logsCurrentSrc === 'app') _loadAppLogForDate(nd);
          else _loadLogs(_logsCurrentSrc);
        }
        document.getElementById('logs-date-prev')?.addEventListener('click', () => _shiftDate(-1));
        document.getElementById('logs-date-next')?.addEventListener('click', () => _shiftDate(+1));
        dateInput?.addEventListener('change', e => {
          _logsCurrentDate = e.target.value;
          if (_logsCurrentSrc === 'app') _loadAppLogForDate(_logsCurrentDate);
          else _loadLogs(_logsCurrentSrc);
        });

        // 更新ボタン
        document.getElementById('logs-refresh-btn')?.addEventListener('click', () => {
          _loadLogs(_logsCurrentSrc);
          _renderStats();
        });

        // キーワード検索
        document.getElementById('logs-search-input')?.addEventListener('input', e => {
          _renderLines(e.target.value.trim());
        });

        // エクスポートボタン
        document.getElementById('logs-export-btn')?.addEventListener('click', () => {
          const kw = document.getElementById('logs-search-input')?.value.trim() || '';
          const pairs = _rawLines.map((line, i) => ({ line, obj: _rawObjects ? _rawObjects[i] : null }));
          const out = pairs.filter(({ line }) => {
            if (_logsCurrentLevel !== 'all' && _classifyLine(line) !== _logsCurrentLevel) return false;
            if (kw && !line.toLowerCase().includes(kw.toLowerCase())) return false;
            return true;
          }).map(({ line, obj }) => obj || line);
          const blob = new Blob([JSON.stringify({
            exported_at: new Date().toISOString(), src: _logsCurrentSrc,
            date: _logsCurrentDate, level: _logsCurrentLevel, count: out.length, entries: out
          }, null, 2)], { type: 'application/json' });
          const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
          a.download = `kintai_log_${_logsCurrentSrc}_${_logsCurrentDate}.json`;
          a.click();
        });

        // 初回ロード + 統計
        _loadLogs(_logsCurrentSrc);
        _renderStats();
      };
    })();

    /* =====================================================
       EMERGENCY MODAL
       ===================================================== */
    (function initEmergencyModal() {
      const modal    = document.getElementById('emergency-modal');
      const closeBtn = document.getElementById('emergency-modal-close');
      const fabRecover = document.getElementById('fab-recover');
      const btnRecover = document.getElementById('btn-recover');
      const diagEl   = document.getElementById('em-diag');

      function openEmergencyModal() {
        modal.classList.add('show');
        // 診断情報を更新
        (async () => {
          try {
            let lines = [];
            // localStorage サイズ
            let lsSize = 0;
            for (const k of Object.keys(localStorage)) lsSize += (localStorage.getItem(k) || '').length;
            lines.push(`LS使用量: ${Math.round(lsSize/1024)}KB`);
            // IDB確認
            const idbData = await idbLoad();
            const idbMonths = Object.keys(idbData?.months || {}).length;
            lines.push(`IDB: ${idbMonths}ヶ月分`);
            // スナップショット
            const snaps = listSnapshots();
            lines.push(`スナップ: ${snaps.length}件`);
            if (snaps.length > 0) {
              const d = new Date(snaps[0].ts);
              lines.push(`  最新: ${d.toLocaleDateString('ja')} ${d.toLocaleTimeString('ja')}`);
              lines.push(`  データ: ${snaps[0].months}ヶ月分`);
            }
            // エラーログ
            const errs = JSON.parse(localStorage.getItem(_ERR_KEY) || '[]');
            lines.push(`エラーログ: ${errs.length}件`);
            if (errs.length > 0) {
              lines.push(`  最新: ${errs[0].type} (${errs[0].ts.slice(0,16)})`);
            }
            // クラッシュカウント
            lines.push(`クラッシュ: ${localStorage.getItem(_CRASH_KEY) || '0'}回`);
            diagEl.textContent = lines.join('\n');
          } catch(e) {
            diagEl.textContent = '診断情報の取得に失敗: ' + e.message;
          }
        })();
      }

      function closeEmergencyModal() {
        modal.classList.remove('show');
      }

      if (fabRecover) fabRecover.addEventListener('click', openEmergencyModal);
      if (btnRecover) btnRecover.addEventListener('click', openEmergencyModal);
      closeBtn.addEventListener('click', closeEmergencyModal);
      modal.addEventListener('click', e => { if (e.target === modal) closeEmergencyModal(); });

      // SW強制更新
      document.getElementById('em-sw-reload').addEventListener('click', async () => {
        try {
          const regs = await navigator.serviceWorker.getRegistrations();
          for (const r of regs) await r.update();
          toast('✅ Service Worker を更新しました');
        } catch(e) { toast('SW更新失敗: ' + e.message); }
        closeEmergencyModal();
        runHealthCheck();
      });

      // キャッシュ・SWクリア（データ保持）
      document.getElementById('em-cache-clear').addEventListener('click', async () => {
        if (!confirm('キャッシュとService Workerをクリアします。\nデータは保持されます。')) return;
        try {
          const regs = await navigator.serviceWorker.getRegistrations();
          for (const r of regs) await r.unregister();
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
          toast('✅ キャッシュ・SWをクリアしました — 再読込します');
          setTimeout(() => location.reload(), 1200);
        } catch(e) { toast('クリア失敗: ' + e.message); }
      });

      // スナップショットから復元
      document.getElementById('em-snap-restore').addEventListener('click', () => {
        const snap = loadLatestSnapshot();
        if (!snap) { toast('⚠️ 復元できるスナップショットがありません'); return; }
        const d = new Date(snap.meta.ts);
        const fmt = `${d.toLocaleDateString('ja')} ${d.toLocaleTimeString('ja')}`;
        if (!confirm(`スナップショット（${fmt}、${snap.meta.months}ヶ月分）からデータを復元しますか？\n現在のデータは上書きされます。`)) return;
        try {
          localStorage.setItem(STORE_KEY, JSON.stringify(snap.data));
          idbSave(snap.data);
          toast('✅ スナップショットから復元しました — 再読込します');
          closeEmergencyModal();
          setTimeout(() => location.reload(), 1200);
        } catch(e) { toast('復元失敗: ' + e.message); }
      });

      // 全データ消去リセット（PIN認証 → confirm の順）
      document.getElementById('em-full-reset').addEventListener('click', async () => {
        // ① まずPIN/DELETE認証（最初に壁を設ける）
        const pinOk = await requirePin('全データ消去してリセット');
        if (!pinOk) { toast('❌ 認証失敗 — リセットを中止しました'); return; }
        // ② 認証後に最終確認ポップアップ
        if (!confirm('⚠️ 勤怠データを含む全データを削除してリセットします。\n本当によいですか？\n\nこの操作は取り消せません。')) return;
        if (!confirm('最終確認：本当にすべて削除しますか？')) return;
        try {
          const regs = await navigator.serviceWorker.getRegistrations();
          for (const r of regs) await r.unregister();
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
          localStorage.clear();
          indexedDB.deleteDatabase(IDB_NAME);
          toast('✅ 全リセット完了 — 再読込します');
          setTimeout(() => location.replace(location.pathname), 1200);
        } catch(e) { toast('リセット失敗: ' + e.message); }
      });

      // サーバーブリッジから復元（別端末 / 別URL から引き継ぎ）
      document.getElementById('em-bridge-restore')?.addEventListener('click', async () => {
        const btn = document.getElementById('em-bridge-restore');
        btn.textContent = '⏳ 復元中...';
        btn.disabled = true;
        let restoredAny = false;
        try {
          const serverKintai = await _restoreFromServer('kintai');
          if (serverKintai && Object.keys(serverKintai.months || {}).length > 0) {
            const clean = { months: serverKintai.months };
            localStorage.setItem(STORE_KEY, JSON.stringify(clean));
            await idbSave(clean);
            restoredAny = true;
          }
          const serverTasks = await _restoreFromServer('tasks');
          const tasks = serverTasks?.tasks;
          if (Array.isArray(tasks) && tasks.length > 0) {
            localStorage.setItem(TASKS_KEY, JSON.stringify(tasks));
            await idbSaveTasksUnified(tasks);
            restoredAny = true;
          }
          if (restoredAny) {
            toast('✅ サーバーブリッジから復元しました — 再読込します');
            closeEmergencyModal();
            setTimeout(() => location.reload(), 1200);
          } else {
            toast('⚠ サーバーにデータがありません。先に元のURLでページを開いてください');
          }
        } catch(e) {
          toast('❌ 復元失敗: ' + e.message);
        } finally {
          btn.textContent = '☁️ サーバーブリッジから復元（別端末/別URL移行）';
          btn.disabled = false;
        }
      });

      // iOS Safari ウェブサイトデータへのショートカット（iOS のみ表示）
      if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
        const safariBtn = document.getElementById('em-safari-settings');
        if (safariBtn) safariBtn.style.display = '';

        safariBtn?.addEventListener('click', () => {
          // App-Prefs: ディープリンクで設定 → Safari → ウェブサイトデータを試行
          const a = document.createElement('a');
          a.href = 'App-Prefs:root=SAFARI&path=WEBSITE_DATA';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          // 2秒後に開かなかった場合は手動ガイドを表示
          setTimeout(() => {
            const guide = [
              '設定アプリが開かない場合:',
              '',
              '1. ホーム画面 →「設定」アプリを開く',
              '2. 下にスクロールして「Safari」をタップ',
              '3.「詳細」をタップ',
              '4.「Webサイトデータ」をタップ',
              '',
              '⚠ データを削除する前にバックアップを取ってください。',
              '   ハブタブ →「JSON書き出し」でバックアップできます。',
            ].join('\n');
            alert(guide);
          }, 2000);
        });
      }

      // 緊急FABは他のモーダルが開いているとき隠す（邪魔にならないよう）
      const hideObs = new MutationObserver(() => {
        const anyOpen = document.getElementById('memo-modal')?.classList.contains('show')
                     || document.getElementById('settings-modal')?.classList.contains('show')
                     || document.getElementById('task-modal')?.classList.contains('show');
        if (fabRecover) fabRecover.classList.toggle('hidden', anyOpen);
      });
      ['memo-modal','settings-modal','task-modal'].forEach(id => {
        const el = document.getElementById(id);
        if (el) hideObs.observe(el, { attributes: true });
      });
    })();

    /* =====================================================
       PIN AUTHENTICATION SYSTEM
       ===================================================== */
    const PIN_HASH_KEY = 'kintai_pin_hash';
    const PIN_FAIL_KEY = 'kintai_pin_fails';
    const PIN_LOCK_KEY = 'kintai_pin_lock';
    const PIN_MAX_FAILS = 3;
    const PIN_LOCKOUT_MS = 60000;

    async function sha256(text) {
      try {
        const data = new TextEncoder().encode(String(text));
        const hash = await crypto.subtle.digest('SHA-256', data);
        return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
      } catch(_) { return null; }
    }

    function isPinSet() { return !!localStorage.getItem(PIN_HASH_KEY); }
    function getPinLockUntil() { return Number(localStorage.getItem(PIN_LOCK_KEY) || 0); }
    function getPinFails() { return Number(localStorage.getItem(PIN_FAIL_KEY) || 0); }

    // Returns Promise<boolean>: true=authenticated, false=cancelled/failed
    function requirePin(purpose) {
      if (!isPinSet()) {
        // PINが未設定 → "DELETE"入力で代替確認（設定を促す）
        const label = purpose || 'この危険な操作';
        const msg = `🔐 PIN未設定\n\n「${label}」\n\n⚠️ セキュリティPINが未設定のため、\n文字確認に切り替えます。\n\n続行するには「DELETE」と入力してください。\n（設定 ⚙️ → セキュリティPIN で事前設定を推奨）`;
        const input = prompt(msg);
        return Promise.resolve(input === 'DELETE');
      }
      return new Promise(resolve => {
        const modal    = document.getElementById('pin-modal');
        const purposeEl = document.getElementById('pin-purpose');
        const dotsEl   = document.getElementById('pin-dots');
        const errorEl  = document.getElementById('pin-error');
        const lockEl   = document.getElementById('pin-lock-msg');

        purposeEl.textContent = purpose || 'この操作にはPINが必要です';
        let pin = '', resolved = false, lockTimer = null;

        function updateDots() {
          dotsEl.querySelectorAll('.pin-dot').forEach((d, i) => d.classList.toggle('filled', i < pin.length));
        }

        function checkLockout() {
          const lockUntil = getPinLockUntil();
          if (lockUntil > Date.now()) {
            const rem = Math.ceil((lockUntil - Date.now()) / 1000);
            lockEl.textContent = `🔒 ${rem}秒後に再試行できます`;
            return true;
          }
          lockEl.textContent = '';
          return false;
        }

        async function submitPin() {
          if (checkLockout()) return;
          if (pin.length < 4) { errorEl.textContent = '4桁以上入力してください'; return; }
          const hash = await sha256(pin);
          const stored = localStorage.getItem(PIN_HASH_KEY);
          if (hash === stored) {
            localStorage.setItem(PIN_FAIL_KEY, '0');
            errorEl.textContent = '';
            cleanup(true);
          } else {
            const fails = getPinFails() + 1;
            localStorage.setItem(PIN_FAIL_KEY, String(fails));
            if (fails >= PIN_MAX_FAILS) {
              localStorage.setItem(PIN_LOCK_KEY, String(Date.now() + PIN_LOCKOUT_MS));
              localStorage.setItem(PIN_FAIL_KEY, '0');
              startLockTimer();
            }
            const rem = Math.max(0, PIN_MAX_FAILS - fails);
            errorEl.textContent = `❌ PINが違います${rem > 0 ? `（残り${rem}回）` : ''}`;
            pin = ''; updateDots();
          }
        }

        function startLockTimer() {
          clearInterval(lockTimer);
          lockTimer = setInterval(() => { if (!checkLockout()) clearInterval(lockTimer); }, 1000);
          checkLockout();
        }

        function onKey(k) {
          if (checkLockout()) return;
          if (k === 'del') { pin = pin.slice(0, -1); updateDots(); errorEl.textContent = ''; }
          else if (pin.length < 6) { pin += k; updateDots(); if (pin.length >= 4) submitPin(); }
        }

        function cleanup(ok) {
          if (resolved) return;
          resolved = true;
          clearInterval(lockTimer);
          modal.classList.remove('show');
          pin = ''; updateDots(); errorEl.textContent = '';
          resolve(ok);
        }

        modal.querySelectorAll('[data-key]').forEach(btn => { btn.onclick = () => onKey(btn.dataset.key); });
        document.getElementById('pin-key-del').onclick    = () => onKey('del');
        document.getElementById('pin-key-cancel').onclick = () => cleanup(false);
        document.getElementById('pin-modal-cancel').onclick = () => cleanup(false);
        modal.onclick = e => { if (e.target === modal) cleanup(false); };

        if (getPinLockUntil() > Date.now()) startLockTimer();
        pin = ''; updateDots(); errorEl.textContent = '';
        modal.classList.add('show');
      });
    }

    async function setupPin(newPin) {
      const hash = await sha256(newPin);
      if (!hash) { toast('PIN設定に失敗しました'); return false; }
      localStorage.setItem(PIN_HASH_KEY, hash);
      localStorage.removeItem(PIN_FAIL_KEY);
      localStorage.removeItem(PIN_LOCK_KEY);
      return true;
    }

    function clearPin() {
      localStorage.removeItem(PIN_HASH_KEY);
      localStorage.removeItem(PIN_FAIL_KEY);
      localStorage.removeItem(PIN_LOCK_KEY);
    }

    function updatePinUI() {
      const set = isPinSet();
      const hint = document.getElementById('pin-status-hint');
      const clearBtn = document.getElementById('btn-clear-pin');
      if (hint) hint.textContent = set ? '✅ PINが設定されています' : '⚠️ PINが未設定です';
      if (clearBtn) clearBtn.style.display = set ? '' : 'none';
    }

    (function initPinSettings() {
      const btnSet   = document.getElementById('btn-set-pin');
      const btnClear = document.getElementById('btn-clear-pin');
      if (!btnSet) return;

      btnSet.addEventListener('click', async () => {
        if (isPinSet()) {
          const ok = await requirePin('現在のPINで認証してください');
          if (!ok) return;
        }
        const p1 = prompt('新しいPINを入力してください（4〜6桁の数字）');
        if (!p1 || !/^\d{4,6}$/.test(p1)) { toast('4〜6桁の数字を入力してください'); return; }
        const p2 = prompt('もう一度入力してください（確認）');
        if (p1 !== p2) { toast('⚠️ PINが一致しません'); return; }
        await setupPin(p1);
        updatePinUI();
        toast('✅ PINを設定しました');
      });

      btnClear.addEventListener('click', async () => {
        const ok = await requirePin('PINを解除するには現在のPINを入力してください');
        if (!ok) return;
        if (!confirm('PINを解除します。よいですか？')) return;
        clearPin();
        updatePinUI();
        toast('✅ PINを解除しました');
      });
    })();

    /* =====================================================
       TAB NAVIGATION
       ===================================================== */
    // タブナビゲーションは _initTabManager (下部) で動的に管理します

    /* =====================================================
       FAB GROUP TOGGLE
       ===================================================== */
    (function initFabGroup() {
      const group  = document.getElementById('fab-group');
      const toggle = document.getElementById('fab-toggle');
      if (!group || !toggle) return;

      toggle.addEventListener('click', e => {
        e.stopPropagation();
        group.classList.toggle('open');
      });

      // グループ外クリックで閉じる
      document.addEventListener('click', e => {
        if (group && !group.contains(e.target)) group.classList.remove('open');
      });

      // モーダルが開いたとき自動でグループを閉じる
      document.querySelectorAll('.modal-backdrop').forEach(m => {
        new MutationObserver(() => {
          const open = m.classList.contains('show') || m.style.display === 'flex';
          if (open) group.classList.remove('open');
        }).observe(m, { attributes: true, attributeFilter: ['class', 'style'] });
      });
    })();

    /* =====================================================
       HUB CARD SORT
       ===================================================== */
    (function initHubCardSort() {
      const HUB_CARD_ORDER_KEY = '_kintai_hub_card_order_v1';
      const HUB_CARD_DEFS = [
        { id: 'weather-card-wrap',  label: '🌤 天気予報' },
        { id: 'hub-launcher-card',  label: '🚀 クイックランチャー' },
        { id: 'sysinfo-card',       label: '📁 システム情報' },
        { id: 'db-status-card',     label: '🗄 データストア状態' },
        { id: 'ts-card-wrap',       label: '🔒 Tailscale VPN' },
        { id: 'iphone-guide-card',  label: '📱 iPhone接続ガイド' },
        { id: 'improvement-card',   label: '🚀 システム改善ロードマップ' },
        { id: 'stock-analysis-card',label: '📈 株価画像分析' },
        { id: 'bolt-card',          label: '⚡ Bolt.new' },
      ];

      function loadHubOrder() {
        try { return JSON.parse(localStorage.getItem(HUB_CARD_ORDER_KEY) || 'null'); } catch(_) { return null; }
      }
      function saveHubOrder(order) { localStorage.setItem(HUB_CARD_ORDER_KEY, JSON.stringify(order)); }

      function applyHubCardOrder() {
        const hub = document.getElementById('page-hub');
        if (!hub) return;
        // display は触らない（CSSクラス管理に任せる）
        const order = loadHubOrder() || HUB_CARD_DEFS.map(d => d.id);
        // 指定順にDOMを物理的に並び替え
        order.forEach(id => {
          const el = document.getElementById(id);
          if (el && el.parentElement === hub) hub.appendChild(el);
        });
        // 定義にないカードは末尾
        HUB_CARD_DEFS.forEach(d => {
          if (!order.includes(d.id)) {
            const el = document.getElementById(d.id);
            if (el && el.parentElement === hub) hub.appendChild(el);
          }
        });
      }
      applyHubCardOrder();

      // 並び替えモーダル
      const modal = document.getElementById('hub-sort-modal');
      const listEl = document.getElementById('hub-sort-list');
      let _sortOrder = [];
      let _dragSrcIdx = null;

      function renderHubSortList() {
        if (!listEl) return;
        listEl.innerHTML = '';
        _sortOrder.forEach((id, idx) => {
          const def = HUB_CARD_DEFS.find(d => d.id === id);
          if (!def) return;
          const row = document.createElement('div');
          row.className = 'tab-mgr-item';
          row.dataset.idx = idx;
          row.setAttribute('draggable', 'true');
          row.innerHTML = `<span class="tab-mgr-handle" title="ドラッグで並び替え">☰</span><span class="tab-mgr-label">${def.label}</span>`;
          listEl.appendChild(row);
        });
        listEl.querySelectorAll('.tab-mgr-item').forEach(row => {
          row.addEventListener('dragstart', e => {
            _dragSrcIdx = parseInt(row.dataset.idx);
            row.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
          });
          row.addEventListener('dragend', () => {
            listEl.querySelectorAll('.tab-mgr-item').forEach(r => r.classList.remove('dragging','drag-over'));
          });
          row.addEventListener('dragover', e => {
            e.preventDefault();
            const over = parseInt(row.dataset.idx);
            if (over !== _dragSrcIdx) {
              listEl.querySelectorAll('.tab-mgr-item').forEach(r => r.classList.remove('drag-over'));
              row.classList.add('drag-over');
            }
          });
          row.addEventListener('drop', e => {
            e.preventDefault();
            const dest = parseInt(row.dataset.idx);
            if (_dragSrcIdx !== null && _dragSrcIdx !== dest) {
              const moved = _sortOrder.splice(_dragSrcIdx, 1)[0];
              _sortOrder.splice(dest, 0, moved);
              renderHubSortList();
            }
          });
        });
        // タッチ対応（tab-mgrと同パターン）
        let _touchSrc = null, _touchClone = null, _touchStartY = 0;
        listEl.querySelectorAll('.tab-mgr-handle').forEach(handle => {
          handle.addEventListener('touchstart', e => {
            const row = handle.closest('.tab-mgr-item');
            _touchSrc = parseInt(row.dataset.idx);
            _touchStartY = e.touches[0].clientY;
            row.classList.add('dragging');
            _touchClone = row.cloneNode(true);
            _touchClone.style.cssText = `position:fixed;left:14px;right:14px;z-index:9999;opacity:0.85;pointer-events:none;background:var(--bg-card-solid);border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,0.2);padding:0 10px;`;
            _touchClone.style.top = row.getBoundingClientRect().top + 'px';
            document.body.appendChild(_touchClone);
            e.preventDefault();
          }, { passive: false });
          handle.addEventListener('touchmove', e => {
            if (!_touchClone) return;
            const dy = e.touches[0].clientY - _touchStartY;
            const srcRow = listEl.children[_touchSrc];
            _touchClone.style.top = (srcRow?.getBoundingClientRect().top + dy) + 'px';
            const touchY = e.touches[0].clientY;
            listEl.querySelectorAll('.tab-mgr-item').forEach(r => r.classList.remove('drag-over'));
            let hovered = null;
            listEl.querySelectorAll('.tab-mgr-item').forEach(r => {
              const rect = r.getBoundingClientRect();
              if (touchY >= rect.top && touchY <= rect.bottom) hovered = r;
            });
            if (hovered) hovered.classList.add('drag-over');
            e.preventDefault();
          }, { passive: false });
          handle.addEventListener('touchend', () => {
            if (_touchClone) { _touchClone.remove(); _touchClone = null; }
            const destRow = listEl.querySelector('.tab-mgr-item.drag-over');
            const dest = destRow ? parseInt(destRow.dataset.idx) : null;
            listEl.querySelectorAll('.tab-mgr-item').forEach(r => r.classList.remove('dragging','drag-over'));
            if (_touchSrc !== null && dest !== null && _touchSrc !== dest) {
              const moved = _sortOrder.splice(_touchSrc, 1)[0];
              _sortOrder.splice(dest, 0, moved);
              renderHubSortList();
            }
            _touchSrc = null;
          });
        });
      }

      document.getElementById('hub-sort-btn')?.addEventListener('click', () => {
        const saved = loadHubOrder() || HUB_CARD_DEFS.map(d => d.id);
        // 存在するカードのみ
        _sortOrder = saved.filter(id => HUB_CARD_DEFS.some(d => d.id === id));
        HUB_CARD_DEFS.forEach(d => { if (!_sortOrder.includes(d.id)) _sortOrder.push(d.id); });
        renderHubSortList();
        modal?.classList.add('show');
      });
      document.getElementById('hub-sort-close')?.addEventListener('click', () => modal?.classList.remove('show'));
      modal?.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('show'); });
      document.getElementById('hub-sort-save')?.addEventListener('click', () => {
        saveHubOrder(_sortOrder);
        applyHubCardOrder();
        modal?.classList.remove('show');
        toast('✓ カード順を保存しました');
      });
    })();

    /* =====================================================
       BOLT.NEW 統合
       ===================================================== */
    (function initBoltIntegration() {
      const KINTAI_GITHUB = 'yu-philia-ctrl/kintai-pwa';

      document.getElementById('bolt-new-btn')?.addEventListener('click', () => {
        const prompt = document.getElementById('bolt-prompt')?.value.trim();
        const url = prompt
          ? 'https://bolt.new/?prompt=' + encodeURIComponent(prompt)
          : 'https://bolt.new/';
        window.open(url, '_blank', 'noopener');
      });

      document.getElementById('bolt-kintai-btn')?.addEventListener('click', () => {
        window.open('https://bolt.new/github/' + KINTAI_GITHUB, '_blank', 'noopener');
      });
    })();

    /* =====================================================
       STOCK IMAGE ANALYSIS
       ===================================================== */
    (function initStockAnalysis() {
      const input   = document.getElementById('stock-img-input');
      const preview = document.getElementById('stock-analysis-preview');
      const btn     = document.getElementById('stock-analyze-btn');
      const result  = document.getElementById('stock-analysis-result');
      if (!input || !btn || !result) return;

      let _stockImages = []; // { name, base64, mime }

      input.addEventListener('change', async e => {
        _stockImages = [];
        preview.innerHTML = '';
        for (const file of (e.target.files || [])) {
          const b64 = await new Promise(res => {
            const r = new FileReader();
            r.onload = ev => res(ev.target.result.split(',')[1]);
            r.readAsDataURL(file);
          });
          const mime = file.type || 'image/jpeg';
          _stockImages.push({ name: file.name, base64: b64, mime });
          const img = document.createElement('img');
          img.src = `data:${mime};base64,${b64}`;
          img.style.cssText = 'width:80px;height:60px;object-fit:cover;border-radius:8px;border:1px solid var(--border-soft);';
          img.title = file.name;
          preview.appendChild(img);
        }
        btn.style.display = _stockImages.length ? 'block' : 'none';
        result.textContent = '';
        e.target.value = ''; // 再選択できるようにリセット
      });

      btn.addEventListener('click', async () => {
        if (_stockImages.length === 0) { toast('⚠️ 画像を選択してください'); return; }
        const sens = await loadSensitiveData().catch(() => null);
        const apiKey = sens?.aiKeyClaude;
        if (!apiKey) { toast('⚠️ AI タブで Claude APIキーを設定してください'); return; }

        btn.disabled = true;
        result.textContent = '分析中...';
        try {
          const content = [
            {
              type: 'text',
              text: '以下の株価チャート画像を分析してください。\n' +
                'テクニカル分析（移動平均・RSI・MACD・出来高等）、現在のトレンド方向（上昇・下降・横ばい）、' +
                'サポートライン・レジスタンスライン、総合的な売買シグナル（買い・売り・中立）を日本語で解説してください。\n' +
                '複数枚ある場合は各チャートを個別に分析し、最後に総評をまとめてください。'
            },
            ..._stockImages.map(img => ({
              type: 'image',
              source: { type: 'base64', media_type: img.mime, data: img.base64 }
            }))
          ];
          const res = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'x-api-key': apiKey,
              'anthropic-version': '2023-06-01',
              'anthropic-dangerous-allow-browser': 'true',
              'content-type': 'application/json'
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-6',
              max_tokens: 2000,
              messages: [{ role: 'user', content }]
            })
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err?.error?.message || `HTTP ${res.status}`);
          }
          const data = await res.json();
          result.textContent = data.content?.[0]?.text || '（応答なし）';
        } catch(e) {
          result.textContent = `分析失敗: ${e.message}`;
          _appLog('error', 'stock-analysis', e.message);
        }
        btn.disabled = false;
      });
    })();

    /* =====================================================
       LAUNCHER / QUICK LINKS
       ===================================================== */
    const LAUNCHER_KEY = 'kintai_launcher_v1';
    const LAUNCHER_DEFAULTS = [
      { id: 'gcal',  name: 'Gカレンダー', url: 'https://calendar.google.com',        icon: '📆' },
      { id: 'gmail', name: 'Gmail',        url: 'https://mail.google.com',            icon: '📧' },
      { id: 'gdrive',name: 'Drive',        url: 'https://drive.google.com',           icon: '🗂' },
      { id: 'slack', name: 'Slack',        url: 'https://slack.com',                  icon: '💬' },
    ];

    function loadLinks() {
      try {
        const r = localStorage.getItem(LAUNCHER_KEY);
        return r ? JSON.parse(r) : [...LAUNCHER_DEFAULTS];
      } catch { return [...LAUNCHER_DEFAULTS]; }
    }
    function saveLinks(links) { localStorage.setItem(LAUNCHER_KEY, JSON.stringify(links)); }

    function renderLauncher() {
      const grid = document.getElementById('links-grid');
      if (!grid) return;

      // 天気予報を更新（キャッシュがあれば即反映）
      renderWeather(false);

      // jinjer カードのURLをconfigから動的設定
      const cfg = loadConfig();
      const jinjerUrl = cfg.jinjerUrl || 'https://kintai.jinjer.biz/staffs/top';
      const jinjerLink = document.getElementById('jinjer-link');
      if (jinjerLink) jinjerLink.href = jinjerUrl;

      // 今日の打刻状況をPWAデータから表示
      const bar = document.getElementById('jinjer-today-bar');
      const statusEl = document.getElementById('jinjer-today-status');
      if (bar && statusEl) {
        try {
          const today = new Date().toISOString().slice(0, 10);
          const store = loadStore();
          const ym = today.slice(0, 7);
          const day = store.months?.[ym]?.[today];
          if (day) {
            const stStr = day.start ? `🟢 ${day.start}` : '打刻なし';
            const edStr = day.end   ? ` 〜 🔴 ${day.end}` : '';
            const stLabel = day.status && day.status !== '未' ? `【${day.status}】 ` : '';
            statusEl.textContent = stLabel + stStr + edStr;
            bar.style.display = '';
          } else {
            bar.style.display = 'none';
          }
        } catch(_) { bar.style.display = 'none'; }
      }

      const links = loadLinks();
      grid.innerHTML = links.map(l => `
        <div class="link-tile-wrap">
          <a href="${_esc(l.url)}" target="_blank" rel="noopener" class="link-tile" title="${_esc(l.name)}">
            <div class="link-tile-icon">${l.icon || '🔗'}</div>
            <div>${_esc(l.name)}</div>
          </a>
          <span class="link-tile-del" data-id="${_esc(l.id)}" title="削除">×</span>
        </div>`).join('') +
        `<div class="link-tile-wrap">
          <button class="link-tile link-tile-add" id="btn-add-link" style="background:rgba(255,255,255,0.5);border:1.5px dashed rgba(180,190,220,0.7);color:var(--text-muted);">
            <div class="link-tile-icon">➕</div><div>追加</div>
          </button>
        </div>`;

      grid.querySelectorAll('.link-tile-del').forEach(btn => {
        btn.addEventListener('click', e => {
          e.preventDefault(); e.stopPropagation();
          saveLinks(loadLinks().filter(l => l.id !== btn.dataset.id));
          renderLauncher();
        });
      });
      document.getElementById('btn-add-link')?.addEventListener('click', showAddLinkDialog);
    }

    function showAddLinkDialog() {
      const name = prompt('リンク名（例: 資格アプリ、社内Wiki）');
      if (!name?.trim()) return;
      const url = prompt('URL（例: https://example.com）');
      if (!url?.trim() || !url.startsWith('http')) { toast('正しいURLを入力してください（https://〜）'); return; }
      const icon = prompt('絵文字アイコン（例: 📝 ）', '🔗') || '🔗';
      saveLinks([...loadLinks(), { id: Date.now().toString(), name: name.trim(), url: url.trim(), icon: icon.trim().slice(0, 2) }]);
      renderLauncher();
      toast('✅ リンクを追加しました');
    }

    /* =====================================================
       STUDY / CERTIFICATION TRACKER
       ===================================================== */
    const STUDY_KEY = 'kintai_study_v1';
    const STUDY_COLORS = ['#7c5fe6','#4f8dfd','#2e7d32','#ef6c00','#c62828','#1565c0','#00838f'];

    function loadStudy() {
      try { const r = localStorage.getItem(STUDY_KEY); return r ? JSON.parse(r) : []; } catch { return []; }
    }
    function saveStudy(d) { localStorage.setItem(STUDY_KEY, JSON.stringify(d)); }

    function renderStudy() {
      const container = document.getElementById('study-list');
      if (!container) return;

      // 今週サマリー
      const weekSummary = document.getElementById('study-week-summary');
      if (weekSummary) {
        const today = new Date();
        const dow   = today.getDay(); // 0=Sun
        const weekDates = Array.from({ length: 7 }, (_, i) => {
          const d = new Date(today);
          d.setDate(today.getDate() - dow + i);
          return d.toISOString().slice(0, 10);
        });
        const allStudy = loadStudy();
        let weekTotal = 0;
        weekDates.forEach(dt => {
          allStudy.forEach(s => {
            weekTotal += (s.logs || []).filter(l => l.date === dt).reduce((a, l) => a + l.hours, 0);
          });
        });
        const dayTotals = weekDates.map(dt => {
          let h = 0;
          allStudy.forEach(s => { h += (s.logs || []).filter(l => l.date === dt).reduce((a, l) => a + l.hours, 0); });
          return { dt, h };
        });
        const dayNames = ['日','月','火','水','木','金','土'];
        const maxH = Math.max(...dayTotals.map(d => d.h), 1);
        weekSummary.innerHTML = `
          <div style="width:100%;">
            <div style="display:flex;align-items:flex-end;gap:4px;height:48px;margin-bottom:4px;">
              ${dayTotals.map(({ dt, h }, i) => {
                const isToday = dt === today.toISOString().slice(0,10);
                const barH = Math.round((h / maxH) * 40);
                return `<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;">
                  <div style="font-size:9px;color:var(--text-muted);font-weight:700;">${h > 0 ? h + 'h' : ''}</div>
                  <div style="width:100%;height:${Math.max(barH,2)}px;background:${isToday ? 'var(--accent-purple)' : 'var(--accent-blue)'};border-radius:3px;opacity:${h > 0 ? 1 : 0.15};"></div>
                  <div style="font-size:9px;color:${isToday ? 'var(--accent-blue)' : 'var(--text-muted)'};font-weight:${isToday ? '900' : '600'};">${dayNames[new Date(dt+'T00:00:00').getDay()]}</div>
                </div>`;
              }).join('')}
            </div>
            <div style="font-size:11px;color:var(--text-muted);text-align:right;">今週合計: <strong style="color:var(--accent-purple);">${weekTotal.toFixed(1)}h</strong></div>
          </div>`;
      }

      const data = loadStudy();
      if (!data.length) {
        container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:24px 0 16px;font-size:13px;line-height:1.8;">資格・学習目標を追加してください<br>試験日・目標時間・進捗を管理できます</div>';
        return;
      }
      container.innerHTML = data.map(s => {
        const total  = (s.logs || []).reduce((sum, l) => sum + (l.hours || 0), 0);
        const target = s.targetHours || 100;
        const pct    = Math.min(100, Math.round(total / target * 100));
        let cdText = '', cdStyle = '';
        if (s.examDate) {
          const days = Math.ceil((new Date(s.examDate) - new Date()) / 86400000);
          if      (days > 0)  { cdText = `あと${days}日`; cdStyle = days <= 30 ? 'background:#ffebee;color:#c62828' : days <= 60 ? 'background:#fff8e1;color:#ef6c00' : 'background:#e8f5e9;color:#2e7d32'; }
          else if (days === 0){ cdText = '今日！'; cdStyle = 'background:#ffebee;color:#c62828'; }
          else                { cdText = `${-days}日経過`; cdStyle = 'background:#f4f4f6;color:#888'; }
        }
        const today = new Date().toISOString().slice(0,10);
        const todayH = (s.logs || []).filter(l => l.date === today).reduce((sum, l) => sum + l.hours, 0);
        return `<div class="study-item" data-id="${s.id}">
          <div class="study-header">
            <div class="study-color-dot" style="background:${s.color};"></div>
            <div class="study-name">${_esc(s.name)}</div>
            ${cdText ? `<span class="study-countdown" style="${cdStyle};">${cdText}</span>` : ''}
            <button class="study-del-btn" data-id="${s.id}" title="削除">🗑</button>
          </div>
          <div class="study-progress-wrap"><div class="study-progress-fill" style="width:${pct}%;background:${s.color};"></div></div>
          <div class="study-stats">
            <span>📖 ${total.toFixed(1)}h / ${target}h${todayH > 0 ? ` (今日+${todayH}h)` : ''}</span>
            <span style="font-weight:800;color:${s.color};">${pct}%</span>
          </div>
          <div class="study-today">
            <input type="number" class="study-hours-input" data-id="${s.id}" min="0" max="24" step="0.25" placeholder="今日の時間">
            <button class="study-add-btn" data-id="${s.id}">＋ 追記</button>
          </div>
        </div>`;
      }).join('');

      container.querySelectorAll('.study-del-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          if (!confirm('この資格データを削除しますか？')) return;
          saveStudy(loadStudy().filter(s => s.id !== btn.dataset.id));
          renderStudy();
        });
      });
      container.querySelectorAll('.study-add-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id    = btn.dataset.id;
          const input = container.querySelector(`.study-hours-input[data-id="${id}"]`);
          const hours = parseFloat(input?.value || '0');
          if (!hours || hours <= 0) { toast('時間を入力してください'); return; }
          const data = loadStudy(), idx = data.findIndex(s => s.id === id);
          if (idx === -1) return;
          if (!data[idx].logs) data[idx].logs = [];
          data[idx].logs.push({ date: new Date().toISOString().slice(0,10), hours });
          saveStudy(data);
          if (input) input.value = '';
          renderStudy();
          toast(`✅ ${hours}h を追記しました`);
        });
      });
    }

    document.getElementById('btn-add-study')?.addEventListener('click', () => {
      const name = prompt('資格・学習名（例: 応用情報技術者試験）');
      if (!name?.trim()) return;
      const targetStr = prompt('目標学習時間（時間、例: 200）', '100');
      const target = parseFloat(targetStr || '100') || 100;
      const examDate = prompt('試験日（YYYY-MM-DD形式、なければ空欄）') || '';
      const data = loadStudy();
      data.push({ id: Date.now().toString(), name: name.trim(), targetHours: target, examDate: examDate.trim(), color: STUDY_COLORS[data.length % STUDY_COLORS.length], logs: [] });
      saveStudy(data);
      renderStudy();
      toast('✅ 資格を追加しました');
    });

    /* =====================================================
       PROJECT TRACKER
       ===================================================== */
    const PROJECT_KEY = 'kintai_projects_v1';
    const PROJECT_STATUSES = ['未着手', '進行中', '完了', '保留'];

    function loadProjects() {
      try { const r = localStorage.getItem(PROJECT_KEY); return r ? JSON.parse(r) : []; } catch { return []; }
    }
    function saveProjects(p) { localStorage.setItem(PROJECT_KEY, JSON.stringify(p)); }

    function renderProjects() {
      const container = document.getElementById('project-list');
      if (!container) return;
      const projects = loadProjects();

      // サマリーカード
      const summaryEl = document.getElementById('project-summary');
      if (summaryEl) {
        const counts = { 未着手: 0, 進行中: 0, 完了: 0, 保留: 0 };
        let avgPct = 0;
        projects.forEach(p => { counts[p.status || '未着手']++; avgPct += (p.progress || 0); });
        if (projects.length) avgPct = Math.round(avgPct / projects.length);
        const chips = [
          { label: '進行中', val: counts['進行中'], cls: 'stat-office' },
          { label: '完了',   val: counts['完了'],   cls: 'stat-home' },
          { label: '未着手', val: counts['未着手'],  cls: 'stat-weekly-toggle' },
          { label: '保留',   val: counts['保留'],    cls: 'stat-off' },
          { label: '平均進捗', val: avgPct + '%',   cls: 'stat-hours' },
        ];
        summaryEl.innerHTML = chips.map(c =>
          `<span class="stat-chip ${c.cls}">${c.label} <b>${c.val}</b></span>`
        ).join('');
      }
      if (!projects.length) {
        container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:24px 0 16px;font-size:13px;line-height:1.8;">プロジェクトを追加してください<br>進捗・ステータス・期限を一元管理できます</div>';
        return;
      }
      container.innerHTML = projects.map(p => {
        let dlStr = '';
        if (p.deadline) {
          const d = Math.ceil((new Date(p.deadline) - new Date()) / 86400000);
          if      (d > 0)  dlStr = `⏰ あと${d}日`;
          else if (d === 0) dlStr = '⚠️ 今日が期限';
          else              dlStr = `⚠️ ${-d}日超過`;
        }
        return `<div class="project-item" data-id="${p.id}">
          <div class="project-header">
            <div class="project-name">${_esc(p.name)}</div>
            <span class="project-status-badge project-status-${_esc(p.status || '未着手')}">${_esc(p.status || '未着手')}</span>
            <button class="project-del-btn" data-id="${p.id}" title="削除">🗑</button>
          </div>
          <div class="project-progress-wrap"><div class="project-progress-fill" style="width:${p.progress || 0}%;" id="proj-fill-${p.id}"></div></div>
          <div class="project-footer">
            <span style="font-size:11px;">${dlStr}</span>
            <div style="display:flex;align-items:center;gap:8px;">
              <input type="range" min="0" max="100" value="${p.progress || 0}"
                class="project-progress-range" data-id="${p.id}"
                style="width:80px;accent-color:var(--accent-blue);">
              <span style="font-weight:800;color:var(--text-main);min-width:32px;" id="proj-pct-${p.id}">${p.progress || 0}%</span>
              <select class="project-status-select" data-id="${p.id}"
                style="padding:3px 6px;border-radius:8px;border:1px solid var(--border-soft);font-size:11px;font-family:inherit;">
                ${PROJECT_STATUSES.map(s => `<option${s === (p.status || '未着手') ? ' selected' : ''}>${s}</option>`).join('')}
              </select>
            </div>
          </div>
        </div>`;
      }).join('');

      container.querySelectorAll('.project-progress-range').forEach(range => {
        range.addEventListener('input', () => {
          const id = range.dataset.id, pct = parseInt(range.value);
          const pctEl  = document.getElementById(`proj-pct-${id}`);
          const fillEl = document.getElementById(`proj-fill-${id}`);
          if (pctEl)  pctEl.textContent  = pct + '%';
          if (fillEl) fillEl.style.width = pct + '%';
        });
        range.addEventListener('change', () => {
          const projects = loadProjects(), idx = projects.findIndex(p => p.id === range.dataset.id);
          if (idx !== -1) { projects[idx].progress = parseInt(range.value); saveProjects(projects); }
        });
      });
      container.querySelectorAll('.project-status-select').forEach(sel => {
        sel.addEventListener('change', () => {
          const projects = loadProjects(), idx = projects.findIndex(p => p.id === sel.dataset.id);
          if (idx !== -1) { projects[idx].status = sel.value; saveProjects(projects); renderProjects(); }
        });
      });
      container.querySelectorAll('.project-del-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          if (!confirm('このプロジェクトを削除しますか？')) return;
          saveProjects(loadProjects().filter(p => p.id !== btn.dataset.id));
          renderProjects();
        });
      });
    }

    document.getElementById('btn-add-project')?.addEventListener('click', () => {
      const name = prompt('プロジェクト名');
      if (!name?.trim()) return;
      const deadline = prompt('期限（YYYY-MM-DD形式、なければ空欄）') || '';
      const projects = loadProjects();
      projects.push({ id: Date.now().toString(), name: name.trim(), deadline: deadline.trim(), progress: 0, status: '未着手' });
      saveProjects(projects);
      renderProjects();
      toast('✅ プロジェクトを追加しました');
    });

    /* =====================================================
       REPORT TAB — 業務報告書管理
       ===================================================== */
    const _getRS = () => window._srvBase || 'http://localhost:8899';
    let _reportList       = [];   // ファイル一覧キャッシュ
    let _reportData       = null; // 現在表示中の月データ
    let _reportMonth      = null; // 'YYYY-MM'
    let _reportServerOk   = false;
    let _reportInitDone   = false;

    async function checkReportServer() {
      try {
        const r = await fetch(`${_getRS()}/api/reports`, { signal: AbortSignal.timeout(2000) });
        _reportServerOk = r.ok;
      } catch {
        _reportServerOk = false;
      }
      return _reportServerOk;
    }

    async function initReportTab() {
      if (_reportInitDone) { renderReportMonthNav(); return; }
      _reportInitDone = true;

      // 自動化パネル
      const toggle = document.getElementById('report-auto-toggle');
      const body   = document.getElementById('report-auto-body');
      const arrow  = document.getElementById('report-auto-arrow');
      toggle?.addEventListener('click', () => {
        const open = body.classList.toggle('open');
        arrow.style.transform = open ? 'rotate(90deg)' : '';
        if (open) loadLaunchdStatus();
      });

      // ボタンイベント
      document.getElementById('btn-report-load')?.addEventListener('click', async () => {
        if (!_reportMonth) { toast('月を選択してください'); return; }
        await loadReportData(_reportMonth);
      });

      document.getElementById('btn-report-sync')?.addEventListener('click', async () => {
        if (!_reportMonth) { toast('月を選択してください'); return; }
        await syncKintaiToReport(_reportMonth);
      });

      document.getElementById('btn-report-generate')?.addEventListener('click', async () => {
        if (!_reportMonth) { toast('月を選択してください'); return; }
        await generateNextMonthReport(_reportMonth);
      });

      // Excelを直接開く（サーバー不要 — SheetJS でクライアント側パース）
      document.getElementById('report-local-file')?.addEventListener('change', async e => {
        const file = e.target.files?.[0];
        if (!file) return;
        try {
          await loadXlsxLib();
          const ab = await file.arrayBuffer();
          const wb = XLSX.read(ab, { type: 'array', cellDates: true });
          const ws = wb.Sheets[wb.SheetNames[0]];
          _reportData = _parseXlsxSheet(ws, file.name);
          renderReportStatusCard(_reportData);
          renderReportMeta(_reportData.meta);
          renderReportSummary(_reportData.days);
          renderReportTable(_reportData.days);
          toast('📊 Excel を読み込みました');
        } catch(err) {
          toast(`⚠️ Excel読み込み失敗: ${err.message}`);
        }
        e.target.value = ''; // 再選択できるようにリセット
      });

      await checkReportServer();
      const banner = document.getElementById('report-server-banner');
      if (banner) banner.style.display = _reportServerOk ? 'none' : 'block';

      if (_reportServerOk) {
        await loadReportList();
      } else {
        renderReportMonthNav();
      }
    }

    function _parseXlsxSheet(ws, filename) {
      const g = (c) => ws[c]?.v ?? '';
      // メタ情報（Excel構造: META_START=(4,10)=K5, META_END=(5,10)=K6 → 取引先等は K/L 列）
      const meta = {
        client:  String(g('K5') || g('K6') || ''),
        project: String(g('B4') || g('B5') || ''),
        dept:    String(g('L5') || ''),
        tech:    String(g('L4') || ''),
      };
      const days = [];
      // 行12以降: A=日付, C=開始, D=終了, E=休憩, F=合計, G=作業内容, L=備考
      for (let r = 12; r <= 43; r++) {
        const dateVal = ws[`A${r}`]?.v;
        if (!dateVal) continue;
        let dateStr;
        if (dateVal instanceof Date) {
          dateStr = dateVal.toISOString().slice(0, 10);
        } else if (typeof dateVal === 'number') {
          // Excel シリアル日付
          const d = new Date(Math.round((dateVal - 25569) * 86400 * 1000));
          dateStr = d.toISOString().slice(0, 10);
        } else {
          dateStr = String(dateVal).slice(0, 10);
        }
        const start   = String(g(`C${r}`) || '');
        const end     = String(g(`D${r}`) || '');
        if (!start && !end) continue; // 空行スキップ
        days.push({
          date:    dateStr,
          start,
          end,
          break:   String(g(`E${r}`) || ''),
          total:   String(g(`F${r}`) || ''),
          content: String(g(`G${r}`) || ''),
          note:    String(g(`L${r}`) || ''),
        });
      }
      return { status: 'draft', filename, meta, days };
    }

    async function loadReportList() {
      try {
        const r = await fetch(`${_getRS()}/api/reports`);
        _reportList = await r.json();
      } catch {
        _reportList = [];
      }
      renderReportMonthNav();
    }

    function renderReportMonthNav() {
      const nav = document.getElementById('report-month-nav');
      if (!nav) return;
      nav.innerHTML = '';

      let chips = [];

      if (_reportList.length > 0) {
        // サーバーからファイル一覧を取得できた場合
        chips = _reportList.map(item => ({
          label: `${item.year}-${String(item.month).padStart(2,'0')}`,
          icon:  item.status === 'approved' ? '✅' : item.status === 'reviewing' ? '🔍' : '📝',
          year:  item.year, month: item.month,
        }));
      } else {
        // サーバー未接続: kintaiデータ + 直近12ヶ月から生成
        const store        = loadStore();
        const kintaiMonths = new Set(Object.keys(store.months || {}));
        const now          = new Date();
        const manual       = [];
        for (let i = 0; i < 12; i++) {
          const d  = new Date(now.getFullYear(), now.getMonth() - i, 1);
          const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          manual.push(ym);
        }
        // kintaiデータがある月 ∪ 直近12ヶ月を降順で表示
        const all = [...new Set([...Array.from(kintaiMonths).sort().reverse(), ...manual])].sort().reverse();
        chips = all.map(ym => {
          const [y, m] = ym.split('-');
          return { label: ym, icon: kintaiMonths.has(ym) ? '📊' : '📋', year: y, month: m };
        });
      }

      if (chips.length === 0) {
        nav.innerHTML = '<span style="font-size:12px;color:var(--text-muted);">データなし</span>';
        return;
      }

      chips.forEach(item => {
        const btn = document.createElement('button');
        btn.className = 'report-month-chip' + (_reportMonth === item.label ? ' active' : '');
        btn.textContent = `${item.icon} ${item.label}`;
        btn.onclick = () => {
          _reportMonth = item.label;
          document.querySelectorAll('.report-month-chip').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          loadReportData(item.year, item.month);
        };
        nav.appendChild(btn);
      });
    }

    async function loadReportData(yearOrLabel, month) {
      let year, mon;
      if (month) {
        year = yearOrLabel; mon = month;
      } else {
        [year, mon] = yearOrLabel.split('-');
      }
      mon = mon.padStart(2, '0');

      const tableArea = document.getElementById('report-table-area');
      tableArea.innerHTML = '<div class="report-loading">読み込み中...</div>';

      try {
        const r = await fetch(`${_getRS()}/api/reports/read?year=${year}&month=${mon}`);
        if (!r.ok) throw new Error(await r.text());
        _reportData = await r.json();
        renderReportStatusCard(_reportData);
        renderReportMeta(_reportData.meta);
        renderReportSummary(_reportData.days);
        renderReportTable(_reportData.days);
      } catch (e) {
        tableArea.innerHTML = `<div class="report-empty">⚠️ 読み込み失敗<br><span style="font-size:11px;">${e.message}</span></div>`;
      }
    }

    function renderReportStatusCard(data) {
      const area = document.getElementById('report-status-area');
      if (!area) return;
      const badgeClass = { approved: 'report-badge-approved', reviewing: 'report-badge-reviewing', draft: 'report-badge-draft' }[data.status] || 'report-badge-draft';
      const badgeText  = { approved: '✅ 承認済み', reviewing: '🔍 確認中', draft: '📝 作成中' }[data.status] || '?';
      area.innerHTML = `
        <div class="report-status-card">
          <span class="report-status-badge ${badgeClass}">${badgeText}</span>
          <span class="report-filename">${data.filename}</span>
        </div>`;
    }

    function renderReportMeta(meta) {
      const grid = document.getElementById('report-meta-grid');
      if (!grid) return;
      if (!meta) { grid.style.display = 'none'; return; }
      grid.style.display = 'grid';
      const items = [
        ['取引先', meta.client],
        ['案件名', meta.project],
        ['部署',   meta.dept],
        ['担当者', meta.tech],
      ];
      grid.innerHTML = items.map(([label, val]) => `
        <div class="report-meta-item">
          <div class="report-meta-label">${label}</div>
          <div class="report-meta-value">${val || '-'}</div>
        </div>`).join('');
    }

    function renderReportSummary(days) {
      const bar = document.getElementById('report-summary-bar');
      if (!bar) return;
      if (!days?.length) { bar.style.display = 'none'; return; }
      bar.style.display = 'flex';

      let home = 0, office = 0, vacation = 0, totalMin = 0;
      days.forEach(d => {
        if (d.note === '在宅') home++;
        else if (d.note === '出社') office++;
        else if (d.note === '有給') vacation++;
        if (d.total) {
          const [h, m] = d.total.split(':').map(Number);
          if (!isNaN(h)) totalMin += h * 60 + (m || 0);
        }
      });
      const totalH = Math.floor(totalMin / 60);
      const totalM = totalMin % 60;

      bar.innerHTML = [
        office  ? `<span class="stat-chip stat-office"><b>${office}</b>日 出社</span>` : '',
        home    ? `<span class="stat-chip stat-home"><b>${home}</b>日 在宅</span>` : '',
        vacation? `<span class="stat-chip stat-off"><b>${vacation}</b>日 休暇</span>` : '',
        totalH  ? `<span class="stat-chip stat-hours"><b>${totalH}h${totalM ? totalM + 'm' : ''}</b> 合計</span>` : '',
      ].filter(Boolean).join('');
    }

    function renderReportTable(days) {
      const area = document.getElementById('report-table-area');
      if (!area) return;
      if (!days?.length) {
        area.innerHTML = '<div class="report-empty">データなし</div>';
        return;
      }

      const noteToRowClass = { '在宅': 'report-row-home', '出社': 'report-row-office', '有給': 'report-row-vacation', '祝日': 'report-row-holiday' };
      const noteToNoteClass = { '在宅': 'report-note-在宅', '出社': 'report-note-出社', '有給': 'report-note-有給', '祝日': 'report-note-祝日', '休日': 'report-note-休日' };

      const rows = days.map(d => {
        const wd = d.weekday;
        const isWeekend = wd === '土' || wd === '日';
        const noteClass = noteToNoteClass[d.note] || '';
        const rowClass  = isWeekend ? 'report-row-weekend' : (noteToRowClass[d.note] || '');
        const noteHTML  = d.note ? `<span class="report-note-badge ${noteClass}">${d.note}</span>` : '';
        const timeStr   = d.start ? `${d.start}–${d.end}` : '';
        return `<tr class="${rowClass}">
          <td style="text-align:center;font-weight:700;">${d.date.slice(5)}</td>
          <td style="text-align:center;color:${wd==='日'?'#c62828':wd==='土'?'#1565c0':'inherit'};font-weight:700;">${wd}</td>
          <td style="text-align:center;">${noteHTML}</td>
          <td style="text-align:center;white-space:nowrap;">${timeStr}</td>
          <td style="text-align:center;">${d.total || ''}</td>
          <td style="font-size:11px;max-width:200px;">${d.content || ''}</td>
        </tr>`;
      }).join('');

      area.innerHTML = `
        <div class="report-table-wrap">
          <table class="report-table">
            <thead>
              <tr>
                <th>日付</th><th>曜</th><th>区分</th>
                <th>時間</th><th>合計</th><th>作業内容</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>`;
    }

    async function syncKintaiToReport(label) {
      if (!_reportServerOk) { toast('⚠️ サーバー未起動'); return; }
      const [year, mon] = label.split('-');
      const monthKey = label;
      const monthResult = getMonthData ? getMonthData(monthKey) : null;
      const kdata = monthResult?.data ?? null;
      if (!kdata || Object.keys(kdata).length === 0) {
        toast('⚠️ kintai にデータがありません');
        return;
      }
      try {
        const r = await fetch(`${_getRS()}/api/reports/sync`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ year, month: mon, kintai_data: kdata }),
        });
        const res = await r.json();
        if (res.ok) {
          toast(`✅ ${res.updated} 行を Excel に書き込みました`);
          await loadReportData(year, mon);
        } else {
          toast(`⚠️ ${res.error}`);
        }
      } catch (e) {
        toast(`⚠️ 同期失敗: ${e.message}`);
      }
    }

    async function generateNextMonthReport(label) {
      if (!_reportServerOk) { toast('⚠️ サーバー未起動'); return; }
      const [year, mon] = label.split('-');
      try {
        const r = await fetch(`${_getRS()}/api/reports/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ year, month: mon }),
        });
        const res = await r.json();
        if (res.ok) {
          toast(`✅ ${res.filename} を生成しました`);
          _reportInitDone = false;
          await loadReportList();
        } else {
          toast(`ℹ️ ${res.error}`);
        }
      } catch (e) {
        toast(`⚠️ 生成失敗: ${e.message}`);
      }
    }

    async function loadLaunchdStatus() {
      const el = document.getElementById('report-auto-launchd-status');
      if (!el) return;
      if (!_reportServerOk) {
        el.innerHTML = '<div style="font-size:11px;color:var(--text-muted);">⚠️ launchd 状態確認にはサーバー起動が必要です</div>';
        return;
      }
      try {
        const r = await fetch(`${_getRS()}/api/structure`);
        if (!r.ok) { el.innerHTML = ''; return; }
        const text = await r.text();
        const match = text.match(/## launchd 自動化ジョブ状態\n([\s\S]*?)\n\n/);
        if (match) {
          el.innerHTML = `<div style="font-size:11px;background:rgba(245,246,251,0.9);border-radius:10px;padding:8px 10px;margin-bottom:6px;">${
            match[1].replace(/- \*\*(.*?)\*\*: /g, (_, name) => `<b>${name}:</b> `).replace(/\n/g, '<br>')
          }</div>`;
        }
      } catch { el.innerHTML = ''; }
    }

    /* =====================================================
       JOBS TAB — フリーランス案件フィード
       jinjer_server.py /api/jobs 経由で Crowdworks / Lancers を取得
       ===================================================== */
    let _jobsData = null;
    let _jobsInitDone = false;

    async function initJobsTab() {
      if (_jobsInitDone) return;
      _jobsInitDone = true;
      // プラットフォームチップのクリックイベント
      document.querySelectorAll('.jobs-platform-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          chip.classList.toggle('active');
        });
      });
      document.getElementById('jobs-refresh-btn')?.addEventListener('click', async () => {
        _jobsInitDone = false;  // 強制再取得
        _jobsData = null;
        _jobsInitDone = true;
        await _loadJobsData();
      });
      await _loadJobsData();
    }

    async function _loadJobsData() {
      const cfg      = loadConfig();
      const skills   = (cfg.jobSkills    || '').trim();
      const cats     = (cfg.jobCategories || '1,2,3').split(',').filter(Boolean);
      const platforms= (cfg.jobPlatforms  || 'crowdworks,lancers').split(',').filter(Boolean);
      // アクティブなプラットフォームチップの状態を反映
      const activeChips = [...document.querySelectorAll('.jobs-platform-chip.active')]
        .map(c => c.dataset.platform).filter(Boolean);
      const effectivePlatforms = activeChips.length ? activeChips : platforms;

      const statusEl  = document.getElementById('jobs-fetch-status');
      const banner    = document.getElementById('jobs-server-banner');
      const container = document.getElementById('jobs-list-container');
      const refreshBtn = document.getElementById('jobs-refresh-btn');

      if (statusEl) statusEl.textContent = '📡 読み込み中...';
      if (refreshBtn) refreshBtn.classList.add('spinning');

      // スキルタグ表示
      const skillDisplay = document.getElementById('jobs-skill-display');
      if (skillDisplay) {
        const tags = skills.split(',').map(s => s.trim()).filter(Boolean);
        skillDisplay.innerHTML = tags.map(s =>
          `<span class="jobs-skill-tag">${s}</span>`).join('');
      }

      const params = new URLSearchParams({
        categories: cats.join(','),
        platforms:  effectivePlatforms.join(','),
        keywords:   skills,
      });

      try {
        const res = await fetch(`${window._srvBase || 'http://localhost:8899'}/api/jobs?${params}`,
          { signal: AbortSignal.timeout(20000) });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        _jobsData = await res.json();
        if (banner) banner.style.display = 'none';

        _renderJobsPickup(_jobsData.jobs);
        _renderJobCards(_jobsData.jobs);

        const fetchTime = _jobsData.fetched_at
          ? new Date(_jobsData.fetched_at).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })
          : '';
        if (statusEl) statusEl.textContent =
          `${_jobsData.total}件 取得済 (${fetchTime})`;
      } catch (e) {
        if (banner) banner.style.display = 'flex';
        if (container) container.innerHTML =
          `<div class="jobs-empty">⚠️ 取得できませんでした<br>
           <small style="color:var(--text-muted)">ローカルサーバーを起動してください<br>
           <code style="font-size:11px;">python3 jinjer_server.py</code></small></div>`;
        if (statusEl) statusEl.textContent = '';
      } finally {
        if (refreshBtn) refreshBtn.classList.remove('spinning');
      }
    }

    function _renderJobsPickup(jobs) {
      const el = document.getElementById('jobs-pickup-list');
      if (!el) return;
      // スコアが高い順 or 最新3件
      const withScore = jobs.filter(j => (j.match_score || 0) > 0);
      const top = (withScore.length > 0 ? withScore : jobs).slice(0, 3);
      if (top.length === 0) {
        el.innerHTML = '<div class="jobs-empty" style="font-size:11px;padding:10px;">おすすめ案件なし</div>';
        return;
      }
      el.innerHTML = top.map(j => _jobCardHtml(j, true)).join('');
      _attachJobClicks(el);
    }

    function _renderJobCards(jobs) {
      const container = document.getElementById('jobs-list-container');
      if (!container) return;
      if (jobs.length === 0) {
        container.innerHTML = '<div class="jobs-empty">案件が見つかりません<br><small>スキルタグや設定を変更してみてください</small></div>';
        return;
      }
      container.innerHTML = `<div class="jobs-cards-list">${jobs.map(j => _jobCardHtml(j, false)).join('')}</div>`;
      _attachJobClicks(container);
    }

    function _jobCardHtml(job, compact) {
      const badge = job.platform === 'crowdworks'
        ? '<span class="jobs-platform-badge jobs-badge-cw">CW</span>'
        : '<span class="jobs-platform-badge jobs-badge-lancers">L</span>';
      const score = (job.match_score > 0)
        ? `<span class="jobs-match-score">⭐${job.match_score}</span>` : '';
      const budget = job.budget
        ? `<span class="jobs-budget">💴 ${job.budget}</span>` : '';
      const summary = (!compact && job.summary)
        ? `<div class="jobs-summary">${job.summary}</div>` : '';
      const upd = job.updated
        ? new Date(job.updated).toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric' })
        : '';
      return `<div class="jobs-card" data-url="${job.url || ''}">
        <div class="jobs-card-header">
          ${badge}
          <span class="jobs-category-tag">${job.category || ''}</span>
          ${score}
          <span class="jobs-updated">${upd}</span>
        </div>
        <div class="jobs-title">${job.title || '（タイトルなし）'}</div>
        ${budget}
        ${summary}
      </div>`;
    }

    function _attachJobClicks(container) {
      container.querySelectorAll('.jobs-card[data-url]').forEach(card => {
        card.addEventListener('click', () => {
          const url = card.dataset.url;
          if (url) window.open(url, '_blank', 'noopener');
        });
      });
    }

    /* =====================================================
       WEATHER FORECAST + OUTFIT RECOMMENDATION
       Open-Meteo API (free, no key, CORS-friendly)
       ===================================================== */
    const WEATHER_CACHE_KEY = '_kintai_weather_cache_v2';
    const WEATHER_CACHE_TTL = 30 * 60 * 1000; // 30分

    const WMO_CODE = {
      0:  { label: '快晴',              emoji: '☀️' },
      1:  { label: 'ほぼ晴れ',          emoji: '🌤' },
      2:  { label: '一部曇り',          emoji: '⛅️' },
      3:  { label: '曇り',              emoji: '☁️' },
      45: { label: '霧',                emoji: '🌫' },
      48: { label: '霧氷',              emoji: '🌫' },
      51: { label: '霧雨（弱）',        emoji: '🌦' },
      53: { label: '霧雨',              emoji: '🌦' },
      55: { label: '霧雨（強）',        emoji: '🌧' },
      61: { label: '雨（弱）',          emoji: '🌧' },
      63: { label: '雨',                emoji: '🌧' },
      65: { label: '雨（強）',          emoji: '🌧' },
      71: { label: '雪（弱）',          emoji: '🌨' },
      73: { label: '雪',                emoji: '❄️' },
      75: { label: '大雪',              emoji: '❄️' },
      77: { label: '雪粒',              emoji: '🌨' },
      80: { label: 'にわか雨（弱）',    emoji: '🌦' },
      81: { label: 'にわか雨',          emoji: '🌧' },
      82: { label: 'にわか雨（強）',    emoji: '⛈' },
      85: { label: 'にわか雪',          emoji: '🌨' },
      86: { label: 'にわか雪（強）',    emoji: '❄️' },
      95: { label: '雷雨',              emoji: '⛈' },
      96: { label: '雷雨＋ひょう',      emoji: '⛈' },
      99: { label: '雷雨＋大ひょう',    emoji: '⛈' },
    };

    function _wmo(code) {
      return WMO_CODE[code] || { label: '不明', emoji: '❓' };
    }

    // スタイルラベル表
    const STYLE_LABEL = {
      casual: 'カジュアル', business: 'ビジネス', street: 'ストリート',
      sports: 'スポーティ', formal: 'フォーマル', outdoor: 'アウトドア',
    };
    const COLOR_HINT = {
      basic: '', earth: 'アース系カラー', dark: 'ダーク系', bright: 'カラフル', pastel: 'パステルカラー',
    };

    // Amazon検索URL生成
    function _amzUrl(query) {
      return `https://www.amazon.co.jp/s?k=${encodeURIComponent(query)}`;
    }

    // outfit item helper: { emoji, label, q } — q は Amazon検索クエリ
    function _item(emoji, label, baseQ, profile) {
      const g = profile.gender || '';
      const c = COLOR_HINT[profile.color] || '';
      return { emoji, label, q: [baseQ, g, c].filter(Boolean).join(' ') };
    }

    function _outfitAdvice(maxTemp, minTemp, weatherCode, windspeed, genderOverride) {
      const cfg    = loadConfig();
      const style  = cfg.styleType   || 'casual';
      const gender = genderOverride || cfg.styleGender || 'メンズ';
      const color  = cfg.styleColor  || 'basic';
      const p      = { gender, color };
      const items  = [], warn = [];
      const isRain  = [51,53,55,61,63,65,80,81,82,95,96,99].includes(weatherCode);
      const isSnow  = [71,73,75,77,85,86].includes(weatherCode);
      const isThund = [95,96,99].includes(weatherCode);

      const isF = (gender === 'レディース');
      // ─── 気温 × スタイル別トップス・ボトムス ───
      if (maxTemp >= 30) {
        if (isF) {
          if (style === 'business') {
            items.push(_item('👗','ユニクロ ノースリーブブラウス','UNIQLO エアリズム ノースリーブ ブラウス ビジネス 夏',p));
            items.push(_item('👗','ユニクロ フレアスカート','UNIQLO フレアスカート 薄手 ひざ丈 ビジネス 夏',p));
          } else if (style === 'sports') {
            items.push(_item('🏃','ナイキ ドライフィット タンクトップ','NIKE ドライフィット タンクトップ レディース 吸汗速乾',p));
            items.push(_item('🩳','ナイキ ランニングショーツ レディース','NIKE レディース ランニングショーツ 速乾 インナー付き',p));
          } else if (style === 'street') {
            items.push(_item('👕','GU オーバーサイズT レディース','GU オーバーサイズ Tシャツ レディース ストリート',p));
            items.push(_item('🩳','GU バイカーショーツ','GU バイカーショーツ レディース 夏 ストリート',p));
          } else {
            items.push(_item('👗','ユニクロ リネンブレンドシャツワンピース','UNIQLO リネン シャツワンピース 夏 涼しい レディース',p));
            items.push(_item('🩴','ユニクロ フットベッドサンダル','UNIQLO フットベッド サンダル レディース 歩きやすい',p));
          }
        } else {
          if (style === 'business') {
            items.push(_item('👔','ユニクロ エアリズムポロシャツ','UNIQLO エアリズム ポロシャツ 吸汗速乾 クールビズ',p));
            items.push(_item('👖','ユニクロ スマートアンクルパンツ','UNIQLO スマートアンクルパンツ 夏 軽量 ストレッチ',p));
          } else if (style === 'sports') {
            items.push(_item('🏃','ナイキ ドライフィットTシャツ','NIKE ドライフィット 半袖Tシャツ 吸汗速乾 UPF50',p));
            items.push(_item('🩳','ナイキ フレックスランショーツ','NIKE フレックス ランニングショーツ 速乾 5インチ',p));
          } else if (style === 'street') {
            items.push(_item('👕','チャンピオン オーバーサイズT','Champion リバースウィーブ Tシャツ オーバーサイズ ストリート',p));
            items.push(_item('🩳','GU カーゴショーツ','GU カーゴショーツ バギー ストリート ハーフパンツ',p));
          } else if (style === 'outdoor') {
            items.push(_item('🏕','コロンビア サンシールドシャツ','Columbia サンシールド 長袖シャツ UPF50 速乾 アウトドア',p));
            items.push(_item('🩳','モンベル トレッキングショーツ','mont-bell トレッキングショーツ 軽量 速乾',p));
          } else {
            items.push(_item('👕','ユニクロ ドライEX Tシャツ','UNIQLO ドライEX 半袖Tシャツ 吸汗速乾 UVカット',p));
            items.push(_item('🩳','GU リラックスショーツ','GU リラックスフィット カジュアルショーツ 綿',p));
          }
        }
        warn.push('🥵 熱中症注意！こまめな水分補給を');
      } else if (maxTemp >= 25) {
        if (isF) {
          if (style === 'business') {
            items.push(_item('👔','ユニクロ 半袖ブラウス','UNIQLO ポプリン 半袖 ブラウス ビジネス レディース',p));
            items.push(_item('👗','ユニクロ チノタイトスカート','UNIQLO チノ タイトスカート ひざ丈 ビジネス',p));
          } else if (style === 'sports') {
            items.push(_item('🏃','アンダーアーマー レディースTシャツ','Under Armour テック Tシャツ レディース 半袖 吸汗',p));
            items.push(_item('🩳','アディダス レギンスショーツ','adidas レギンス ショーツ レディース スポーツ',p));
          } else if (style === 'street') {
            items.push(_item('👕','ナイキ ウィメンズT','NIKE ウィメンズ ルーズフィット Tシャツ ストリート',p));
            items.push(_item('👗','GU フレアミニスカート','GU フレア ミニスカート レディース ストリート カジュアル',p));
          } else {
            items.push(_item('👗','ユニクロ コットンリネンワンピース','UNIQLO コットン リネン ノースリーブワンピース 夏',p));
            items.push(_item('🩴','GU クロスストラップサンダル','GU クロスストラップ サンダル レディース 夏',p));
          }
        } else {
          if (style === 'business') {
            items.push(_item('👔','ORIHICA ノーアイロンシャツ','ORIHICA ノーアイロン 半袖シャツ ビジネス イージーケア',p));
            items.push(_item('👖','ユニクロ スマートスラックス','UNIQLO スマートスラックス 夏 ウォッシャブル ストレッチ',p));
          } else if (style === 'sports') {
            items.push(_item('🏃','アンダーアーマー コンプレッション','Under Armour コンプレッションシャツ 半袖 吸汗速乾',p));
            items.push(_item('🩳','ナイキ スポーツパンツ','NIKE スポーツパンツ インナー付き 夏 ランニング',p));
          } else if (style === 'street') {
            items.push(_item('👕','ナイキ ルーズフィットT','NIKE ルーズフィット Tシャツ ストリート ドロップショルダー',p));
            items.push(_item('👖','GU ワイドバギーデニム','GU ワイドバギーデニム ストリート ゆったり',p));
          } else {
            items.push(_item('👕','ユニクロ コットンリラックスT','UNIQLO コットン 半袖Tシャツ リラックスフィット 無地',p));
            items.push(_item('👖','ユニクロ スリムチノパンツ','UNIQLO スリムフィット チノパンツ 薄手 ストレッチ',p));
          }
        }
      } else if (maxTemp >= 20) {
        if (isF) {
          if (style === 'business') {
            items.push(_item('👔','ユニクロ 長袖ブラウス','UNIQLO 長袖 ブラウス ビジネス レディース ポプリン',p));
            items.push(_item('🧥','ユニクロ テーラードジャケット レディース','UNIQLO ストレッチ テーラードジャケット レディース',p));
            items.push(_item('👗','ユニクロ プリーツパンツ レディース','UNIQLO プリーツ パンツ レディース ビジネスカジュアル',p));
          } else if (style === 'street') {
            items.push(_item('👕','グラミチ ウィメンズロンT','Gramicci ロゴ 長袖Tシャツ レディース オーバーサイズ',p));
            items.push(_item('🧥','ユニクロ デニムジャケット レディース','UNIQLO デニムジャケット レディース オーバーサイズ',p));
            items.push(_item('👗','GU マーメイドスカート','GU マーメイドスカート レディース ストリート',p));
          } else {
            items.push(_item('👗','ユニクロ ニットワンピース','UNIQLO ニット ワンピース レディース 秋 春 薄手',p));
            if (minTemp < 15) items.push(_item('🧥','ユニクロ コットンカーディガン レディース','UNIQLO コットン カーディガン レディース 薄手 羽織り',p));
          }
        } else {
          if (style === 'business') {
            items.push(_item('👔','ユニクロ エクストラファインコットンシャツ','UNIQLO エクストラファインコットン ボタンダウン 長袖',p));
            items.push(_item('🧥','ユニクロ ストレッチジャケット','UNIQLO ストレッチ テーラードジャケット ビジネス セットアップ',p));
            items.push(_item('👖','ユニクロ スリムスラックス','UNIQLO スリムフィット スラックス ストレッチ ビジネス',p));
          } else if (style === 'formal') {
            items.push(_item('🎩','青山 スリムスーツ','洋服の青山 スリムスーツ ジャケット フォーマル',p));
            items.push(_item('👔','ユニクロ 形態安定シャツ','UNIQLO 形態安定 ドレスシャツ ホワイト フォーマル',p));
            items.push(_item('👖','AOKIスラックス センタープレス','AOKI フォーマルスラックス スリム センタープレス',p));
          } else if (style === 'street') {
            items.push(_item('👕','グラミチ ロゴロンT','Gramicci ロゴ 長袖Tシャツ ストリート オーバーサイズ',p));
            items.push(_item('🧥','オープンカラーシャツ（ストリート）','オープンカラーシャツ 柄シャツ アロハ ストリート',p));
            items.push(_item('👖','リーバイス 511 スリムデニム','Levis 511 スリムフィット ストレッチデニム テーパード',p));
          } else {
            items.push(_item('👕','ユニクロ プレミアムリネンシャツ','UNIQLO プレミアムリネン シャツ 長袖 薄手',p));
            if (minTemp < 15) items.push(_item('🧥','ユニクロ コットンカーディガン','UNIQLO コットン カーディガン 薄手 羽織り',p));
            items.push(_item('👖','ユニクロ テーパードデニム','UNIQLO テーパードフィット デニム ストレッチ',p));
          }
        }
      } else if (maxTemp >= 15) {
        if (isF) {
          if (style === 'business') {
            items.push(_item('🧥','ユニクロ ウールブレンドジャケット レディース','UNIQLO ウール混 テーラードジャケット レディース',p));
            items.push(_item('👔','ユニクロ 形態安定シャツ レディース','UNIQLO 形態安定 ストレッチ ビジネスシャツ レディース',p));
            items.push(_item('👗','ユニクロ スマートアンクルパンツ レディース','UNIQLO スマートアンクル パンツ レディース ビジネス',p));
          } else {
            items.push(_item('🧥','ユニクロ スウィングコート','UNIQLO スウィング コート レディース 秋 薄手',p));
            items.push(_item('👗','ユニクロ チェックフレアスカート','UNIQLO チェック フレアスカート レディース 秋',p));
            items.push(_item('🧶','ユニクロ リブニットセーター レディース','UNIQLO リブ ニットセーター レディース 薄手 秋',p));
          }
        } else {
          if (style === 'business') {
            items.push(_item('🧥','ユニクロ ウールブレンドジャケット','UNIQLO ウール混 テーラードジャケット ビジネスカジュアル',p));
            items.push(_item('👔','ユニクロ 形態安定ビジネスシャツ','UNIQLO 形態安定 ストレッチ ビジネスシャツ 長袖',p));
            items.push(_item('👖','ユニクロ スリムスラックス（秋冬）','UNIQLO スラックス スリム ストレッチ 秋冬',p));
          } else if (style === 'outdoor') {
            items.push(_item('🧥','ノースフェイス フリースジャケット','The North Face フリースジャケット アウトドア 軽量 保温',p));
            items.push(_item('👖','コロンビア トレッキングパンツ','Columbia トレッキングパンツ ストレッチ 撥水 秋',p));
          } else {
            items.push(_item('🧥','ユニクロ ライトウェイトブルゾン','UNIQLO ライトウェイト コンパクトジャケット 秋 軽量',p));
            items.push(_item('👔','ユニクロ フランネルチェックシャツ','UNIQLO フランネル チェックシャツ 長袖 カジュアル',p));
            items.push(_item('👖','リーバイス 512 テーパードデニム','Levis 512 スリムテーパード デニム ストレッチ',p));
          }
        }
      } else if (maxTemp >= 10) {
        if (isF) {
          if (style === 'business') {
            items.push(_item('🧥','ユニクロ ウールコート レディース','UNIQLO ウール混 チェスターコート レディース ビジネス',p));
            items.push(_item('🧶','ユニクロ メリノニット レディース','UNIQLO メリノウール Vネックニット レディース',p));
          } else {
            items.push(_item('🧥','ユニクロ ダウンコート レディース','UNIQLO ウルトラライトダウン コート レディース 軽量',p));
            items.push(_item('🧶','ユニクロ ニットセーター レディース','UNIQLO ウール混 タートルネック セーター レディース',p));
          }
          items.push(_item('👗','ユニクロ 極暖スキニー レディース','UNIQLO ヒートテック 極暖 スキニー レディース 保温',p));
        } else {
          if (style === 'business') {
            items.push(_item('🧥','ユニクロ ウールコート','UNIQLO ウール混 ステンカラーコート ビジネス 秋冬',p));
            items.push(_item('👔','ユニクロ Vネックニット','UNIQLO ウール混 Vネックニット セーター ビジネスカジュアル',p));
          } else if (style === 'outdoor') {
            items.push(_item('🧥','ノースフェイス マウンテンジャケット','The North Face マウンテンジャケット 防水 防風 アウトドア',p));
            items.push(_item('🧤','ブラックダイヤモンド グローブ','Black Diamond アウトドアグローブ 防寒 防風 保温',p));
          } else {
            items.push(_item('🧥','ユニクロ スウェットフルジップパーカ','UNIQLO スウェット フルジップパーカ 裏起毛 プルオーバー',p));
            items.push(_item('👕','ユニクロ クルーネックセーター','UNIQLO ウール混 クルーネックセーター 薄手 秋冬',p));
          }
          items.push(_item('👖','ユニクロ 裏起毛ストレッチパンツ','UNIQLO 暖パン 裏起毛 ストレッチ スキニー 保温',p));
        }
      } else if (maxTemp >= 5) {
        if (isF) {
          items.push(_item('🧥','ユニクロ ウルトラライトダウンロングコート レディース','UNIQLO ウルトラライトダウン ロングコート レディース 防寒',p));
          items.push(_item('🧣','GU ウールライクマフラー レディース','GU ウールライク マフラー レディース 防寒 冬',p));
          items.push(_item('👗','ユニクロ 極暖ヒートテックレギンス','UNIQLO 極暖 ヒートテック レギンス レディース 冬 防寒',p));
        } else {
          items.push(_item('🧥','ユニクロ ウルトラライトダウンロングコート','UNIQLO ウルトラライトダウン ロングコート 防寒 軽量',p));
          items.push(_item('🧣','GU リブニットマフラー','GU リブニット マフラー 防寒 ロング 冬',p));
          items.push(_item('👖','ユニクロ 暖パン テーパード','UNIQLO 暖パン ウォームEX テーパード 防寒 冬',p));
        }
      } else {
        if (isF) {
          items.push(_item('🧥','ユニクロ ウルトラライトダウンパーカ レディース','UNIQLO ウルトラライトダウン パーカ レディース 極暖 防風',p));
          items.push(_item('🧣','ユニクロ フリースマフラー レディース','UNIQLO フリース マフラー 手袋 セット レディース 極暖',p));
          items.push(_item('👗','ユニクロ 極暖ヒートテックレギンスパンツ','UNIQLO 極暖 ヒートテック レギンスパンツ レディース 厚手',p));
        } else {
          items.push(_item('🧥','ユニクロ ウルトラライトダウンパーカ','UNIQLO ウルトラライトダウン パーカ 極暖 防風 撥水',p));
          items.push(_item('🧣','ユニクロ フリースマフラー＆手袋セット','UNIQLO フリース マフラー 手袋 セット 極暖 防寒',p));
          items.push(_item('👖','ユニクロ 極暖ヒートテックパンツ','UNIQLO 極暖 ヒートテック テーパードパンツ 冬',p));
        }
        warn.push('🥶 防寒対策を万全に！');
      }

      // ─── シューズ ───
      const hasShoe = items.some(it => ['👟','👞','🥾','🩴','👠','🥿'].includes(it.emoji));
      if (!hasShoe) {
        if (isF) {
          if (style === 'business' || style === 'formal')
            items.push(_item('👠','ユニクロ バレエシューズ','UNIQLO バレエシューズ レディース ビジネス フラット 本革',p));
          else if (style === 'sports')
            items.push(_item('👟','ナイキ フリーラン レディース','NIKE Free Run レディース ランニングシューズ 軽量',p));
          else if (style === 'outdoor')
            items.push(_item('🥾','サロモン ハイキングシューズ レディース','Salomon XA PRO ゴアテックス レディース ハイキング',p));
          else
            items.push(_item('👟','コンバース オールスター レディース','Converse All Star レディース ローカット キャンバス',p));
        } else {
          if (style === 'business' || style === 'formal')
            items.push(_item('👞','スコッチグレイン プレーントゥ','スコッチグレイン ビジネスシューズ プレーントゥ 本革 国産',p));
          else if (style === 'sports')
            items.push(_item('👟','ナイキ ペガサス ランシューズ','NIKE ペガサス ランニングシューズ クッション 軽量',p));
          else if (style === 'outdoor')
            items.push(_item('🥾','サロモン ハイキングブーツ','Salomon X-ULTRA ゴアテックス ハイキングブーツ 防水',p));
          else
            items.push(_item('👟','コンバース オールスター','Converse Chuck Taylor All Star ローカット キャンバス 定番',p));
        }
      }

      // ─── 雨雪 ───
      if (isRain) {
        items.push(_item('☂️','ユニクロ コンパクトアンブレラ','UNIQLO コンパクト 折りたたみ傘 軽量 晴雨兼用 自動開閉',p));
        items.push(_item('🥿','アシックス ペダラ 防水シューズ','ASICS ペダラ 防水 ウォーキングシューズ 雨 快適',p));
      }
      if (isSnow) {
        items.push(_item('🥾','ソレル カリブー スノーブーツ','Sorel Caribou スノーブーツ 防水 防滑 雪道 冬',p));
        warn.push('⚠️ 路面凍結に注意');
      }
      if (isThund) warn.push('⛈ 雷雨の恐れ — 外出注意');
      // ─── 風・UV ───
      if (windspeed >= 30) {
        items.push(_item('🧢','ナイキ エアロビルキャップ','NIKE エアロビル キャップ 帽子 ストラップ 飛ばされない',p));
        warn.push('💨 強風注意（スカート注意）');
      } else if (windspeed >= 20) {
        warn.push('💨 風が強めです');
      }
      if (maxTemp >= 22 && !isRain)
        items.push(_item('🧴','アネッサ パーフェクトUV','ANESSA パーフェクトUV スキンケアミルク SPF50+ PA++++',p));

      return { items, warn, style, maxT: maxTemp, minT: minTemp, weatherCode, windspeed };
    }

    function _loadWeatherCache() {
      try {
        const r = localStorage.getItem(WEATHER_CACHE_KEY);
        if (!r) return null;
        const d = JSON.parse(r);
        if (!d.ts || Date.now() - d.ts > WEATHER_CACHE_TTL) return null;
        return d.data;
      } catch { return null; }
    }
    function _saveWeatherCache(data) {
      try { localStorage.setItem(WEATHER_CACHE_KEY, JSON.stringify({ ts: Date.now(), data })); } catch(_) {}
    }

    async function _fetchWeatherByCoords(lat, lon) {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
        `&daily=weathercode,temperature_2m_max,temperature_2m_min,windspeed_10m_max,precipitation_probability_max` +
        `&hourly=temperature_2m,apparent_temperature,weathercode,precipitation_probability,windspeed_10m` +
        `&current_weather=true&timezone=Asia%2FTokyo&forecast_days=7`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    async function _geocodeCity(city) {
      const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=ja&format=json`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const d = await res.json();
      if (!d.results?.length) throw new Error(`「${city}」が見つかりません`);
      return { lat: d.results[0].latitude, lon: d.results[0].longitude, name: d.results[0].name };
    }

    function _getGPSCoords() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) { reject(new Error('GPS非対応')); return; }
        navigator.geolocation.getCurrentPosition(
          p => resolve({ lat: p.coords.latitude, lon: p.coords.longitude, name: '現在地' }),
          () => reject(new Error('GPS取得失敗 — 設定で都市名を入力してください')),
          { timeout: 8000 }
        );
      });
    }

    async function _fetchWeatherData() {
      const city = loadConfig().city || '';
      const coords = city ? await _geocodeCity(city) : await _getGPSCoords();
      const raw = await _fetchWeatherByCoords(coords.lat, coords.lon);
      return { raw, locationName: coords.name };
    }


    // コーデキャッシュ（同条件の再レンダリング防止）
    let _outfitBoardCache = { key: null, html: null };

    // 服のカラーパレット（styleColorに対応）
    const _CLOTH_PAL = {
      basic:  { top:'#eceff1', btm:'#546e7a', out:'#37474f', sho:'#212121', sca:'#b0bec5', acc:'#90a4ae' },
      earth:  { top:'#efebe9', btm:'#a1887f', out:'#6d4c41', sho:'#3e2723', sca:'#d7ccc8', acc:'#bcaaa4' },
      dark:   { top:'#78909c', btm:'#263238', out:'#102027', sho:'#000a12', sca:'#455a64', acc:'#546e7a' },
      bright: { top:'#f06292', btm:'#4fc3f7', out:'#ba68c8', sho:'#ff7043', sca:'#fff176', acc:'#80cbc4' },
      pastel: { top:'#f8bbd0', btm:'#b3e5fc', out:'#c8e6c9', sho:'#ffccbc', sca:'#e1bee7', acc:'#f0f4c3' },
    };

    // ファッションイラスト風アバターSVGを生成（スタイリッシュ 8頭身）
    function _buildMannequinSVG(items, colorKey) {
      const p = _CLOTH_PAL[colorKey] || _CLOTH_PAL.basic;
      const has = emoji => items.some(it => emoji.includes(it.emoji));
      const hasHat   = has(['🧢','🎩','👒']);
      const hasScarf = has(['🧣']);
      const hasOuter = has(['🧥']);
      const hasTop   = has(['👔','👕','🏃','🏕','🎩']);
      const hasBot   = has(['👖','🩳']);
      const hasShoe  = has(['👟','👞','🥾','🥿']);
      const hasAcc   = has(['🧤']);
      const sleeveC  = hasOuter ? p.out : (hasTop ? p.top : null);
      const u = Math.random().toString(36).slice(2,7);

      return `<svg class="vp-svg" viewBox="0 0 100 240" xmlns="http://www.w3.org/2000/svg">
<defs>
  <linearGradient id="sk${u}" x1="30%" y1="0%" x2="70%" y2="100%">
    <stop offset="0%" stop-color="#FDDBB4"/><stop offset="100%" stop-color="#F0B880"/>
  </linearGradient>
  <linearGradient id="lg${u}" x1="0%" y1="0%" x2="100%" y2="100%">
    <stop offset="0%" stop-color="#F5C498"/><stop offset="100%" stop-color="#E0A070"/>
  </linearGradient>
</defs>
<ellipse cx="50" cy="236" rx="20" ry="3.5" fill="rgba(0,0,0,0.10)"/>
<!-- HAIR -->
<path d="M36.5 13 Q36 1 50 0 Q64 1 63.5 13 Q66 8 65 20 Q64 30 62 36 Q56 40 50 40 Q44 40 38 36 Q36 30 35 20 Q34 8 36.5 13 Z" fill="#1c1410"/>
<path d="M37 15 Q32 24 34 36 Q36 42 38 44 Q36 38 37 28 Q37 18 38 14 Z" fill="#221810"/>
<path d="M63 15 Q68 24 66 36 Q64 42 62 44 Q64 38 63 28 Q63 18 62 14 Z" fill="#221810"/>
<path d="M41 2 Q50 0 59 2" stroke="rgba(255,255,255,0.18)" stroke-width="1.8" fill="none" stroke-linecap="round"/>
<!-- FACE -->
<ellipse cx="50" cy="16" rx="12.5" ry="14.5" fill="url(#sk${u})"/>
<path d="M40 19 Q40 29 44 32 Q47 34 50 34 Q53 34 56 32 Q60 29 60 19" fill="url(#sk${u})"/>
<ellipse cx="37.8" cy="18" rx="2.8" ry="4" fill="#FDCBA0"/>
<ellipse cx="62.2" cy="18" rx="2.8" ry="4" fill="#FDCBA0"/>
<ellipse cx="37.8" cy="18" rx="1.5" ry="2.4" fill="#E8A878"/>
<ellipse cx="62.2" cy="18" rx="1.5" ry="2.4" fill="#E8A878"/>
<!-- Eyebrows — thin arched -->
<path d="M39.5 10.5 Q42.5 8.5 46.5 10.5" stroke="#221810" stroke-width="1.3" fill="none" stroke-linecap="round"/>
<path d="M53.5 10.5 Q57.5 8.5 60.5 10.5" stroke="#221810" stroke-width="1.3" fill="none" stroke-linecap="round"/>
<!-- Eyes — almond/cat-eye -->
<path d="M38.5 16 Q42.5 12.5 46.5 16 Q42.5 20 38.5 16 Z" fill="white"/>
<ellipse cx="42.5" cy="16.2" rx="2" ry="2.5" fill="#2a1a10"/>
<circle cx="41.6" cy="15.3" r="0.75" fill="rgba(255,255,255,0.90)"/>
<path d="M38.5 16 Q42.5 12.5 46.5 16" stroke="#1c1410" stroke-width="1.5" fill="none" stroke-linecap="round"/>
<path d="M53.5 16 Q57.5 12.5 61.5 16 Q57.5 20 53.5 16 Z" fill="white"/>
<ellipse cx="57.5" cy="16.2" rx="2" ry="2.5" fill="#2a1a10"/>
<circle cx="56.6" cy="15.3" r="0.75" fill="rgba(255,255,255,0.90)"/>
<path d="M53.5 16 Q57.5 12.5 61.5 16" stroke="#1c1410" stroke-width="1.5" fill="none" stroke-linecap="round"/>
<!-- Nose subtle -->
<path d="M48.5 23 Q50 25 51.5 23" stroke="#C08862" stroke-width="0.9" fill="none" stroke-linecap="round"/>
<!-- Lips -->
<path d="M45.5 28.5 Q47.5 31 50 30.5 Q52.5 31 54.5 28.5" stroke="#B84848" stroke-width="1.6" fill="none" stroke-linecap="round"/>
<path d="M45.5 28.5 Q50 27 54.5 28.5" stroke="#D46060" stroke-width="0.9" fill="none" stroke-linecap="round"/>
<ellipse cx="37" cy="23" rx="4" ry="2.2" fill="rgba(255,110,100,0.16)"/>
<ellipse cx="63" cy="23" rx="4" ry="2.2" fill="rgba(255,110,100,0.16)"/>
<!-- NECK -->
<path d="M45.5 33 L44.5 44 L55.5 44 L54.5 33" fill="#FDCBA0"/>
<path d="M45.5 33 L45 39 L50 38.5 L50 33 Z" fill="rgba(0,0,0,0.05)"/>
<!-- ARMS skin -->
<path d="M19 54 C 11 70 9 107 11 128 C 12 135 15.5 138 20 136 C 23 135 24 128 24 122 L24 54 Z" fill="#FDCBA0"/>
<path d="M81 54 C 89 70 91 107 89 128 C 88 135 84.5 138 80 136 C 77 135 76 128 76 122 L76 54 Z" fill="#FDCBA0"/>
<ellipse cx="15" cy="138" rx="6" ry="7.5" fill="#FDCBA0"/>
<ellipse cx="85" cy="138" rx="6" ry="7.5" fill="#FDCBA0"/>
<path d="M10 135.5 Q15 133 20 135.5" stroke="rgba(0,0,0,0.08)" stroke-width="0.8" fill="none"/>
<path d="M80 135.5 Q85 133 90 135.5" stroke="rgba(0,0,0,0.08)" stroke-width="0.8" fill="none"/>
<!-- TORSO skin -->
<path d="M24 53 Q22 51 50 47 Q78 51 76 53 L74 126 Q72 138 50 139 Q28 138 26 126 Z" fill="#FDCBA0"/>
<path d="M26 126 Q24 137 28 143 Q40 152 50 152 Q60 152 72 143 Q76 137 74 126 Q60 139 50 139 Q40 139 26 126 Z" fill="#E8A870"/>
<!-- LEGS skin -->
<path d="M28 143 C 26 165 26 196 28 218 C 29 227 34 230 40 229 C 45 228 47 220 47 213 L47 143 Z" fill="url(#lg${u})"/>
<path d="M72 143 C 74 165 74 196 72 218 C 71 227 66 230 60 229 C 55 228 53 220 53 213 L53 143 Z" fill="url(#lg${u})"/>
<ellipse cx="37" cy="180" rx="6.5" ry="4" fill="rgba(255,255,255,0.14)"/>
<ellipse cx="63" cy="180" rx="6.5" ry="4" fill="rgba(255,255,255,0.14)"/>
<path d="M28 143 L31 143 L31 218 L28 217 Z" fill="rgba(0,0,0,0.055)"/>
<path d="M72 143 L69 143 L69 218 L72 217 Z" fill="rgba(0,0,0,0.055)"/>
<!-- Bare feet -->
<path d="M24 218 Q18 225 19 230 Q29 235 42 230 Q49 226 48 218 L40 217 Z" fill="#C88A68"/>
<path d="M76 218 Q82 225 81 230 Q71 235 58 230 Q51 226 52 218 L60 217 Z" fill="#C88A68"/>
<!-- CLOTHING LAYERS -->
${hasBot ? `<path d="M26 137 Q24 147 28 155 Q40 164 50 164 Q60 164 72 155 Q76 147 74 137 Q60 149 50 151 Q40 149 26 137 Z" fill="${p.btm}"/>
<path d="M28 155 L40 155 L40 219 L32 222 Q24 222 22 218 Z" fill="${p.btm}"/>
<path d="M72 155 L60 155 L60 219 L68 222 Q76 222 78 218 Z" fill="${p.btm}"/>
<line x1="50" y1="155" x2="50" y2="219" stroke="rgba(0,0,0,0.09)" stroke-width="0.9"/>
<path d="M28 155 L32 155 L32 219 L28 218 Z" fill="rgba(0,0,0,0.07)"/>
<path d="M72 155 L68 155 L68 219 L72 218 Z" fill="rgba(0,0,0,0.07)"/>
<path d="M39 157 L40 155 L40 215 L39 217 Z" fill="rgba(255,255,255,0.12)"/>
<path d="M61 157 L60 155 L60 215 L61 217 Z" fill="rgba(255,255,255,0.12)"/>` : ''}
${sleeveC ? `<path d="M19 56 C 11 72 9 107 11 128 C 12 134 15 137 19 136 L24 136 C 24 126 24 106 24 56 Z" fill="${sleeveC}"/>
<path d="M81 56 C 89 72 91 107 89 128 C 88 134 85 137 81 136 L76 136 C 76 126 76 106 76 56 Z" fill="${sleeveC}"/>
<path d="M20 57 C 12 72 10 106 12 126 L17 136 C 11 135 11.5 133 11 128 C 9 107 11 72 19 56 Z" fill="rgba(0,0,0,0.08)"/>
<path d="M80 57 C 88 72 90 106 88 126 L83 136 C 89 135 88.5 133 89 128 C 91 107 89 72 81 56 Z" fill="rgba(0,0,0,0.08)"/>` : ''}
${hasTop ? `<path d="M24 54 Q22 52 50 48 Q78 52 76 54 L74 131 Q72 140 50 141 Q28 140 26 131 Z" fill="${p.top}"/>
<path d="M50 48 L50 141 Q62 141 70 136 L74 131 L76 54 Q63 52 50 48 Z" fill="rgba(0,0,0,0.055)"/>
<path d="M44 48 Q50 45 56 48 L54 54 Q50 52 46 54 Z" fill="rgba(0,0,0,0.075)"/>
<path d="M46 54 Q50 58 54 54" stroke="rgba(0,0,0,0.14)" stroke-width="0.9" fill="none"/>
<path d="M27 57 L26 131 Q26 136 28 138 L24 131 L24 54 Z" fill="rgba(255,255,255,0.09)"/>` : ''}
${hasOuter ? `<path d="M15 51 Q13 49 50 45 Q87 49 85 51 L82 126 Q80 136 50 137 Q20 136 18 126 Z" fill="${p.out}"/>
<path d="M50 45 L50 137 Q64 137 72 131 L82 126 L85 51 Q68 49 50 45 Z" fill="rgba(0,0,0,0.07)"/>
<path d="M48 45 L43 58 Q47 58 50 62 Q53 58 57 58 L52 45 Z" fill="rgba(0,0,0,0.09)"/>
<line x1="50" y1="62" x2="50" y2="137" stroke="rgba(0,0,0,0.08)" stroke-width="0.85"/>
<circle cx="50" cy="80" r="1.3" fill="rgba(0,0,0,0.18)"/>
<circle cx="50" cy="98" r="1.3" fill="rgba(0,0,0,0.18)"/>
<circle cx="50" cy="116" r="1.3" fill="rgba(0,0,0,0.18)"/>
<path d="M20 54 L18 126 Q18 130 20 132 L15 51 Z" fill="rgba(255,255,255,0.11)"/>` : ''}
${hasScarf ? `<path d="M36 40 Q50 35 64 40 Q66 47 64 50 Q50 46 36 50 Q34 47 36 40 Z" fill="${p.sca}"/>
<path d="M44 50 L43 67 Q43 70 46 70 L50 70 Q50 70 50 67 L50 50 Z" fill="${p.sca}"/>
<path d="M36 42 Q50 37 64 42" stroke="rgba(255,255,255,0.26)" stroke-width="1.1" fill="none"/>
<path d="M36 47 Q50 43 64 47" stroke="rgba(0,0,0,0.08)" stroke-width="0.8" fill="none"/>` : ''}
${hasHat ? `<ellipse cx="50" cy="5" rx="23" ry="6" fill="${p.out}"/>
<path d="M34 5 Q37 -5 50 -7 Q63 -5 66 5 Z" fill="${p.out}"/>
<path d="M36 4.5 Q50 1 64 4.5" stroke="rgba(255,255,255,0.30)" stroke-width="1.5" fill="none"/>
<path d="M34 5 Q37 -5 50 -7 Q56 -4 58 3 Q52 5 50 5 Q42 5 40 5 Z" fill="rgba(0,0,0,0.11)"/>` : ''}
${hasAcc ? `<ellipse cx="15" cy="138" rx="6.5" ry="8" fill="${p.acc}"/>
<ellipse cx="85" cy="138" rx="6.5" ry="8" fill="${p.acc}"/>
<path d="M9.5 135 Q15 132 20.5 135" stroke="rgba(255,255,255,0.26)" stroke-width="0.9" fill="none"/>
<path d="M79.5 135 Q85 132 90.5 135" stroke="rgba(255,255,255,0.26)" stroke-width="0.9" fill="none"/>` : ''}
${hasShoe ? `<path d="M24 218 Q18 226 19 230 Q30 235 43 230 Q49 226 48 219 L40 217 Z" fill="${p.sho}"/>
<path d="M76 218 Q82 226 81 230 Q70 235 57 230 Q51 226 52 219 L60 217 Z" fill="${p.sho}"/>
<path d="M24 218 Q19 224 19 228 Q30 230 43 226 L48 219 Q40 222 27 221 Q19 220 24 218 Z" fill="rgba(255,255,255,0.16)"/>
<path d="M76 218 Q81 224 81 228 Q70 230 57 226 L52 219 Q60 222 73 221 Q81 220 76 218 Z" fill="rgba(255,255,255,0.16)"/>` : ''}
</svg>`;
    }

    // コーデアイテムの理由テキスト
    function _outfitReason(emoji, maxT, minT) {
      if (['🧥'].includes(emoji)) return maxT < 15 ? '防寒対策' : maxT < 20 ? '羽織り推奨' : '気温差対策';
      if (['🧣'].includes(emoji)) return '首元の保温';
      if (['🧤'].includes(emoji)) return '手先の防寒';
      if (['🧢','🎩','👒'].includes(emoji)) return maxT >= 25 ? '紫外線対策' : '防寒アクセント';
      if (['👟','🥾'].includes(emoji)) return 'アクティブ向け';
      if (['👞'].includes(emoji)) return 'フォーマル向け';
      if (['🩳'].includes(emoji)) return '快適な通気性';
      return '';
    }

    // フラットレイ服表示（マネキンSVGの代わり）
    function _buildFlatLay(items) {
      const shown = items.slice(0, 6);
      const cards = shown.map(it => {
        const shortName = it.label.replace(/^(ユニクロ|UNIQLO|GU|ナイキ|NIKE|コンバース|Champion|チャンピオン|アシックス|ASICS|アンダーアーマー|ノースフェイス|コロンビア|モンベル)\s/i, '');
        return `<div class="fl-card"><div class="fl-card-em">${it.emoji}</div><div class="fl-card-nm">${_esc(shortName)}</div></div>`;
      }).join('');
      return `<div class="vp-flatlay">${cards}</div>`;
    }

    // 服装ボードHTML生成（メンズ＋レディース両方表示・キャッシュ対応）
    function _buildOutfitBoard(outfit, cacheKey) {
      if (cacheKey && cacheKey === _outfitBoardCache.key) return _outfitBoardCache.html;
      const { warn, style } = outfit;
      const styleLabel = STYLE_LABEL[style] || style;

      // レディースコーデも計算
      const outfitF = _outfitAdvice(outfit.maxT, outfit.minT, outfit.weatherCode, outfit.windspeed, 'レディース');
      const outfitM = _outfitAdvice(outfit.maxT, outfit.minT, outfit.weatherCode, outfit.windspeed, 'メンズ');

      function _buildSection(o, label) {
        const flatlay = _buildFlatLay(o.items);
        const cards = o.items.map(it => {
          const reason = _outfitReason(it.emoji, o.maxT || 20, o.minT || 10);
          return `<a href="${_esc(_amzUrl(it.q))}" target="_blank" rel="noopener" class="oic">` +
            `<div class="oic-em">${it.emoji}</div>` +
            `<div class="oic-nm">${_esc(it.label)}</div>` +
            (reason ? `<div class="oic-why">${_esc(reason)}</div>` : '') +
            `<div class="oic-amz">🛒 Amazon</div>` +
          `</a>`;
        }).join('');
        return `<div class="outfit-gender-section">` +
          `<div class="outfit-gender-label">${_esc(label)}</div>` +
          `<div class="outfit-mannequin-row">${flatlay}<div class="oic-grid" style="flex:1;">${cards}</div></div>` +
        `</div>`;
      }

      const warnHtml = warn.length
        ? `<div class="outfit-warn-row">${warn.map(w => `<div class="outfit-warn">${w}</div>`).join('')}</div>`
        : '';

      const allQ = outfitM.items.map(it => it.label).join(' ');
      const html = `<div class="outfit-board-wrap">` +
        `<div class="outfit-board-title">👗 今日のコーデ提案 <span class="outfit-style-tag">${_esc(styleLabel)}</span></div>` +
        _buildSection(outfitM, '👔 メンズ') +
        _buildSection(outfitF, '👗 レディース') +
        warnHtml +
        `<a href="${_esc(_amzUrl(allQ))}" target="_blank" rel="noopener" class="outfit-all-btn">🛒 コーデ全体をAmazonで探す</a>` +
      `</div>`;
      if (cacheKey) _outfitBoardCache = { key: cacheKey, html };
      return html;
    }

    function _buildHealthAdvice(daily, today, ti) {
      const maxT  = daily.temperature_2m_max[ti];
      const minT  = daily.temperature_2m_min[ti];
      const code  = daily.weathercode[ti];
      const wind  = daily.windspeed_10m_max[ti];
      const rain  = daily.precipitation_probability_max[ti] || 0;
      const month = new Date().getMonth() + 1;
      const cards = [];

      // 寒暖差
      const diff = maxT - minT;
      cards.push(diff >= 12
        ? { icon:'🌡', label:'寒暖差', level:'alert', lv:'大きい', tip:`気温差${Math.round(diff)}°C。薄着の重ね着で対応を。` }
        : diff >= 7
        ? { icon:'🌡', label:'寒暖差', level:'warn',  lv:'やや大', tip:`気温差${Math.round(diff)}°C。羽織りを1枚持参。` }
        : { icon:'🌡', label:'寒暖差', level:'ok',    lv:'小さい', tip:`過ごしやすい気温差です。` });

      // 熱中症・防寒
      if (maxT >= 33)
        cards.push({ icon:'🥵', label:'熱中症', level:'alert', lv:'危険',  tip:'30分おきに水分補給。屋外は朝夕に。' });
      else if (maxT >= 28)
        cards.push({ icon:'☀️', label:'熱中症', level:'warn',  lv:'注意',  tip:'こまめな水分補給。日傘・帽子を。' });
      else if (minT <= 3)
        cards.push({ icon:'🥶', label:'防寒',   level:'alert', lv:'厳寒',  tip:'体幹を温めて外出。防寒具必携。' });
      else if (minT <= 10)
        cards.push({ icon:'🧣', label:'防寒',   level:'warn',  lv:'寒い',  tip:'マフラー・手袋推奨。' });

      // UV
      const isCloud = [1,2,3,45,48,51,53,55,61,63,65,71,73,75,80,81,82].includes(code);
      const uvEst   = isCloud ? (maxT >= 25 ? 3 : 1) : (month >= 4 && month <= 9) ? (maxT >= 30 ? 7 : 5) : 2;
      cards.push(uvEst >= 6
        ? { icon:'🔆', label:'UV', level:'alert', lv:'非常に強', tip:'SPF50+必須。10〜14時の外出を避けて。' }
        : uvEst >= 4
        ? { icon:'🔆', label:'UV', level:'warn',  lv:'強い',   tip:'SPF30+推奨。長時間外出は要注意。' }
        : { icon:'🔆', label:'UV', level:'ok',    lv:'弱い',   tip:'UVリスクは低めです。' });

      // 感染症
      const fluRisk = (month <= 3 || month === 12 || (minT <= 8 && wind >= 15));
      cards.push(fluRisk
        ? { icon:'🤧', label:'感染症', level:'warn', lv:'注意',    tip:'インフル流行期。手洗い・うがい徹底。' }
        : { icon:'🌿', label:'感染症', level:'ok',   lv:'低リスク', tip:'感染症リスクは比較的低め。' });

      // 花粉
      if (month >= 2 && month <= 8) {
        const isRain = [51,53,55,61,63,65,80,81,82,95].includes(code);
        cards.push((!isRain && wind >= 10)
          ? { icon:'🌸', label:'花粉', level:'alert', lv:'多い',    tip:'晴れ+風で飛散多。マスク必携。' }
          : isRain
          ? { icon:'🌸', label:'花粉', level:'ok',    lv:'少ない',  tip:'雨の日は花粉少なめ。' }
          : { icon:'🌸', label:'花粉', level:'warn',  lv:'やや多',  tip:'花粉シーズン。外出後は払い落とし。' });
      }

      // 週間トレンド
      const maxTemps  = daily.temperature_2m_max.slice(0, 7);
      const rainDays  = (daily.precipitation_probability_max || []).slice(0, 7).filter(p => p >= 50).length;
      const tempTrend = maxTemps[6] - maxTemps[0];
      let trend = '';
      if (tempTrend > 4)       trend += `📈 今週は気温<strong>上昇傾向</strong>（+${Math.round(tempTrend)}°C）。週後半は薄着準備を。`;
      else if (tempTrend < -4) trend += `📉 今週は気温<strong>下降傾向</strong>（${Math.round(tempTrend)}°C）。防寒を早めに準備。`;
      else                     trend += `🌤 今週の気温は<strong>ほぼ安定</strong>しています。`;
      if (rainDays >= 4)       trend += ` 雨の日が<strong>${rainDays}日</strong>予想。傘を常備して。`;
      else if (rainDays >= 2)  trend += ` 一時雨が<strong>${rainDays}日</strong>あります。`;

      return `<div class="health-advice-wrap">
        <div class="health-advice-title">🩺 健康・生活アドバイス</div>
        <div class="health-advice-grid">
          ${cards.map(c => `<div class="ha-card">
            <div class="ha-card-icon">${c.icon}</div>
            <div class="ha-card-label">${c.label}</div>
            <span class="ha-card-level ha-level-${c.level}">${c.lv}</span>
            <div class="ha-card-tip">${c.tip}</div>
          </div>`).join('')}
        </div>
        <div class="health-advice-trend">${trend}</div>
      </div>`;
    }

    function _renderWeatherUI(data) {
      const { raw, locationName } = data;
      const daily  = raw.daily;
      const hourly = raw.hourly;
      const now    = new Date();
      const today  = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
      const curH   = now.getHours();
      const ti     = Math.max(0, daily.time.findIndex(t => t === today));
      const maxT   = daily.temperature_2m_max[ti];
      const minT   = daily.temperature_2m_min[ti];
      const code   = daily.weathercode[ti];
      const wind   = daily.windspeed_10m_max[ti];
      const rain   = daily.precipitation_probability_max[ti];
      const wi     = _wmo(code);

      // 今日のメイン天気
      const todayEl = document.getElementById('weather-today');
      if (todayEl) {
        todayEl.innerHTML =
          `<div class="weather-loc">📍 ${_esc(locationName)}</div>` +
          `<div class="weather-main-row">` +
            `<div class="weather-big-emoji">${wi.emoji}</div>` +
            `<div class="weather-temps">` +
              `<div class="weather-temp-max">${Math.round(maxT)}°</div>` +
              `<div class="weather-temp-min">${Math.round(minT)}°</div>` +
            `</div>` +
            `<div class="weather-cond">` +
              `<div class="weather-label">${wi.label}</div>` +
              `<div class="weather-sub">💧${rain}%　💨${Math.round(wind)}km/h</div>` +
            `</div>` +
          `</div>`;
      }

      // 1時間毎の予報
      const hourlyEl = document.getElementById('hourly-scroll');
      if (hourlyEl) {
        hourlyEl.innerHTML = _buildHourlyCards(hourly, today, true);
        setTimeout(() => {
          const nowCard = hourlyEl.querySelector('.h-now');
          if (nowCard) nowCard.scrollIntoView({ inline: 'start', behavior: 'smooth', block: 'nearest' });
        }, 100);
      }

      // 服装おすすめ（楽天/Amazon連携、HA対応）
      const boardEl = document.getElementById('outfit-board');
      if (boardEl) {
        const outfitKey = `${Math.round(maxT)},${Math.round(minT)},${code},${Math.round(wind)}`;
        try {
          const outfit = _outfitAdvice(maxT, minT, code, wind);
          boardEl.innerHTML = _buildOutfitBoard(outfit, outfitKey);
        } catch(e) {
          console.warn('[outfit]', e);
          boardEl.innerHTML = '<div class="outfit-fallback">👗 コーデ情報を読み込めませんでした</div>';
        }
      }

      // 健康・生活アドバイス
      const haBoard = document.getElementById('health-advice-board');
      if (haBoard) {
        try { haBoard.innerHTML = _buildHealthAdvice(daily, today, ti); } catch(_) {}
      }

      // 7日間予報
      const forecastEl = document.getElementById('forecast-scroll');
      if (forecastEl) {
        forecastEl.innerHTML = daily.time.map((dateStr, i) => {
          const d    = new Date(dateStr + 'T00:00:00');
          const dow  = ['日','月','火','水','木','金','土'][d.getDay()];
          const isTd = (dateStr === today);
          const wi2  = _wmo(daily.weathercode[i]);
          return `<div class="fc-card${isTd ? ' fc-today' : ''}">` +
            `<div class="fc-dow">${isTd ? '今日' : dow}</div>` +
            `<div class="fc-emoji">${wi2.emoji}</div>` +
            `<div class="fc-max">${Math.round(daily.temperature_2m_max[i])}°</div>` +
            `<div class="fc-min">${Math.round(daily.temperature_2m_min[i])}°</div>` +
            `<div class="fc-rain">${daily.precipitation_probability_max[i]}%</div>` +
          `</div>`;
        }).join('');
      }

      document.getElementById('weather-main-section').style.display = '';
      document.getElementById('weather-loading').style.display = 'none';
      document.getElementById('weather-error').style.display = 'none';
    }

    // ローカル今日日付ヘルパー
    function _localToday() {
      const n = new Date();
      return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`;
    }

    // 時間別カードHTML生成（ハブ・カレンダー共通）
    function _buildHourlyCards(hourly, targetDate, highlightCurrent) {
      if (!hourly) return '';
      const curH   = new Date().getHours();
      const cards  = [];
      const DOW    = ['日','月','火','水','木','金','土'];
      let count    = 0;
      let lastDate = null;
      for (let i = 0; i < hourly.time.length && count < 28; i++) {
        const t    = hourly.time[i];
        const date = t.slice(0, 10);
        const h    = parseInt(t.slice(11, 13));
        if (date < targetDate) continue;
        if (date === targetDate && h < curH) continue;

        // 日付が変わったら仕切りカードを挿入
        if (date !== lastDate) {
          if (lastDate !== null) {
            const d   = new Date(date + 'T00:00:00');
            const mm  = d.getMonth() + 1;
            const dd  = d.getDate();
            const dow = DOW[d.getDay()];
            const isTomorrow = (() => {
              const td = new Date(targetDate + 'T00:00:00');
              const nd = new Date(d); nd.setDate(nd.getDate());
              return (d - td) / 86400000 <= 1;
            })();
            cards.push(
              `<div class="h-date-sep">` +
                (isTomorrow ? `<span class="h-ds-today">翌日</span>` : '') +
                `<span>${mm}/${dd}</span>` +
                `<span>${dow}</span>` +
              `</div>`
            );
          }
          lastDate = date;
        }

        const isNow = highlightCurrent && (date === targetDate && h === curH);
        const wi2   = _wmo(hourly.weathercode[i]);
        const tmp   = Math.round(hourly.temperature_2m[i]);
        const feel  = Math.round(hourly.apparent_temperature[i]);
        const rn    = hourly.precipitation_probability[i];
        cards.push(
          `<div class="h-card${isNow ? ' h-now' : ''}">` +
            `<div class="h-time">${isNow ? '現在' : h + '時'}</div>` +
            `<div class="h-emoji">${wi2.emoji}</div>` +
            `<div class="h-temp">${tmp}°</div>` +
            `<div class="h-feels">体感${feel}°</div>` +
            `<div class="h-rain">${rn}%</div>` +
          `</div>`
        );
        count++;
      }
      return cards.join('');
    }

    // カレンダータブのミニバナーを更新
    function _renderCalWeather(data) {
      const wrap = document.getElementById('cal-weather-wrap');
      if (!wrap) return;
      const { raw, locationName } = data;
      const daily  = raw.daily;
      const hourly = raw.hourly;
      const today  = _localToday();
      const ti     = Math.max(0, daily.time.findIndex(t => t === today));
      const maxT   = daily.temperature_2m_max[ti];
      const minT   = daily.temperature_2m_min[ti];
      const code   = daily.weathercode[ti];
      const wind   = daily.windspeed_10m_max[ti];
      const rain   = daily.precipitation_probability_max[ti];
      const wi     = _wmo(code);

      document.getElementById('cal-w-emoji').textContent = wi.emoji;
      document.getElementById('cal-w-cond').textContent  = wi.label;
      document.getElementById('cal-w-sub').textContent   = `💧${rain}%  💨${Math.round(wind)}km/h  📍${locationName}`;
      document.getElementById('cal-w-temps').textContent = `${Math.round(maxT)}° / ${Math.round(minT)}°`;
      wrap.style.display = '';

      // ⏱ 時間別ボタン
      const hourlyBtn = document.getElementById('cal-hourly-btn');
      if (hourlyBtn) {
        hourlyBtn.onclick = () => {
          const ex = document.getElementById('cal-hourly-expand');
          if (!ex) return;
          const open = ex.style.display !== 'none';
          if (open) {
            ex.style.display = 'none';
            hourlyBtn.textContent = '⏱ 時間別';
          } else {
            const scrollEl = document.getElementById('cal-hourly-scroll');
            if (scrollEl && hourly) {
              scrollEl.innerHTML = _buildHourlyCards(hourly, today, true);
              // 現在時刻カードへスクロール
              setTimeout(() => {
                const nowCard = scrollEl.querySelector('.h-now');
                if (nowCard) nowCard.scrollIntoView({ inline: 'start', behavior: 'smooth', block: 'nearest' });
              }, 80);
            }
            ex.style.display = '';
            hourlyBtn.textContent = '⏱ 閉じる';
          }
        };
      }

      // 👗 服装ボタン
      const outfitBtn = document.getElementById('cal-outfit-btn');
      if (outfitBtn) {
        outfitBtn.onclick = () => {
          const expand = document.getElementById('cal-outfit-expand');
          if (!expand) return;
          const open = expand.style.display !== 'none';
          if (open) {
            expand.style.display = 'none';
            outfitBtn.textContent = '👗 服装';
          } else {
            const card = document.getElementById('cal-outfit-card');
            if (card) {
              const outfitKey = `cal,${Math.round(maxT)},${Math.round(minT)},${code},${Math.round(wind)}`;
              try {
                const outfit = _outfitAdvice(maxT, minT, code, wind);
                card.innerHTML = _buildOutfitBoard(outfit, outfitKey);
                card.style.padding = '0';
                card.style.border  = 'none';
                card.style.background = 'none';
              } catch(e) {
                card.innerHTML = '<div class="outfit-fallback">👗 コーデを読み込めませんでした</div>';
              }
            }
            expand.style.display = '';
            outfitBtn.textContent = '✕ 閉じる';
          }
        };
      }
    }

    async function renderWeather(forceRefresh) {
      const cached = forceRefresh ? null : _loadWeatherCache();
      if (cached) {
        _renderWeatherUI(cached);
        _renderCalWeather(cached);
        return;
      }

      // ハブカードのローディング状態
      const loadingEl = document.getElementById('weather-loading');
      const mainEl    = document.getElementById('weather-main-section');
      const errEl     = document.getElementById('weather-error');
      if (loadingEl) loadingEl.style.display = '';
      if (mainEl)    mainEl.style.display    = 'none';
      if (errEl)     errEl.style.display     = 'none';

      try {
        const data = await _fetchWeatherData();
        _saveWeatherCache(data);
        _appLog('info', 'weather', `取得完了: ${data.locationName}`);
        _renderWeatherUI(data);
        _renderCalWeather(data);
      } catch (err) {
        if (loadingEl) loadingEl.style.display = 'none';
        if (errEl) {
          errEl.style.display  = '';
          errEl.textContent = `⚠️ 天気取得失敗: ${err.message}`;
        }
        // カレンダーバナーにもエラー表示
        const sub = document.getElementById('cal-w-sub');
        if (sub) sub.textContent = `取得失敗: ${err.message}`;
      }
    }

    document.getElementById('weather-refresh-btn')?.addEventListener('click', () => {
      renderWeather(true);
    });

    /* =====================================================
       LOG VIEWER
       ===================================================== */
    function openLogModal(filterLevel) {
      const fl = filterLevel || 'all';
      document.querySelectorAll('.log-filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === fl));
      document.getElementById('log-modal').classList.add('show'); // 先にモーダルを開く
      _populateLogDateSel().then(() => _renderLogList(fl));       // IDB から非同期で populate
    }
    async function _populateLogDateSel() {
      const sel = document.getElementById('log-date-sel');
      if (!sel) return;
      const dates = await idbListLogDates(); // IDB から日付一覧（降順）
      const days = [{ value: '', label: '今日（直近200件）' }];
      for (const d of dates) {
        const rec = await idbLoadLogsDaily(d);
        const cnt = rec?.entries?.length || 0;
        days.push({ value: d, label: `${d}（${cnt}件）` });
      }
      sel.innerHTML = days.map(d => `<option value="${_esc(d.value)}">${_esc(d.label)}</option>`).join('');
    }

    async function _renderLogList(filter, dateKey) {
      const listEl = document.getElementById('log-list');
      if (!listEl) return;
      let appLogs = [], errLogs = [];
      if (dateKey) {
        // IDB 日次アーカイブを表示（dateKey = 'YYYY-MM-DD'）
        const rec = await idbLoadLogsDaily(dateKey);
        appLogs = rec?.entries || [];
      } else {
        // 今日: リングバッファ + グローバルエラー
        try { appLogs = JSON.parse(localStorage.getItem(_LOG_KEY) || '[]'); } catch(_) {}
        try {
          errLogs = JSON.parse(localStorage.getItem(_ERR_KEY) || '[]').map(e => ({
            ts: e.ts, level: 'error', source: e.type || 'global', msg: e.detail
          }));
        } catch(_) {}
      }
      const all = [...appLogs, ...errLogs].sort((a, b) => b.ts.localeCompare(a.ts));
      const filtered = filter === 'all' ? all : all.filter(e => e.level === filter);
      if (filtered.length === 0) {
        listEl.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:32px 0;font-size:13px;">📋 ログなし</div>';
        return;
      }
      const _LEVEL_MAP = {
        fatal: ['log-badge-fatal', '💀 致命'],
        error: ['log-badge-error', '🔴 エラー'],
        warn:  ['log-badge-warn',  '🟡 警告'],
        info:  ['log-badge-info',  '🔵 情報'],
      };
      listEl.innerHTML = filtered.map(e => {
        const d  = new Date(e.ts);
        const ts = `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
        const [bc, bl] = _LEVEL_MAP[e.level] || ['log-badge-info', '情報'];
        const suggestion = (e.level === 'fatal' || e.level === 'error' || e.level === 'warn')
          ? _logSuggestion(e.source, e.msg, e.level) : null;
        return `<div class="log-entry">` +
          `<div class="log-row1">` +
            `<span class="log-ts">${ts}</span>` +
            `<span class="log-badge ${bc}">${bl}</span>` +
            `<span class="log-src">[${_esc(e.source || 'app')}]</span>` +
          `</div>` +
          `<div class="log-msg">${_esc(e.msg || '')}</div>` +
          (suggestion ? `<div class="log-suggest">${_esc(suggestion)}</div>` : '') +
        `</div>`;
      }).join('');
    }

    document.getElementById('log-close').addEventListener('click', () =>
      document.getElementById('log-modal').classList.remove('show'));
    document.getElementById('log-close2').addEventListener('click', () =>
      document.getElementById('log-modal').classList.remove('show'));
    document.getElementById('log-clear').addEventListener('click', async () => {
      const dk = document.getElementById('log-date-sel')?.value || '';
      if (dk) {
        // IDB 日次アーカイブ（dateKey = 'YYYY-MM-DD'）を消去
        if (!confirm(`${dk} のログを消去しますか？`)) return;
        try {
          const db = await _openIDB();
          if (db) db.transaction('logs_archive', 'readwrite').objectStore('logs_archive').delete(dk);
        } catch(_) {}
        await _populateLogDateSel();
        document.getElementById('log-date-sel').value = '';
        await _renderLogList('all');
      } else {
        if (!confirm('今日のログをすべて消去しますか？')) return;
        try { localStorage.removeItem(_LOG_KEY); localStorage.removeItem(_ERR_KEY); } catch(_) {}
        await _renderLogList('all');
      }
      document.querySelectorAll('.log-filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === 'all'));
    });
    document.querySelectorAll('.log-filter-btn').forEach(btn =>
      btn.addEventListener('click', () => {
        document.querySelectorAll('.log-filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const dk = document.getElementById('log-date-sel')?.value || '';
        _renderLogList(btn.dataset.filter, dk); // async 呼び出し（戻り値は無視）
      })
    );
    document.getElementById('log-date-sel').addEventListener('change', e => {
      const fl = document.querySelector('.log-filter-btn.active')?.dataset.filter || 'all';
      _renderLogList(fl, e.target.value || ''); // value は 'YYYY-MM-DD' or ''
    });
    document.getElementById('health-log-btn').addEventListener('click', () => openLogModal('all'));
    document.getElementById('health-err-item').addEventListener('click', () => openLogModal('error'));
    document.getElementById('health-idb-item').addEventListener('click', () => openLogModal('all'));
    document.getElementById('health-perf-btn').addEventListener('click', () => openPerfModal());

    /* =====================================================
       PERFORMANCE VIEWER (powertop風)
       ===================================================== */
    let _perfFpsLoop = null, _perfFps = 0;

    function _startFpsMeter() {
      let last = performance.now(), frames = 0;
      _perfFps = 0;
      function loop(ts) {
        frames++;
        if (ts - last >= 1000) {
          _perfFps = frames;
          frames = 0;
          last = ts;
        }
        _perfFpsLoop = requestAnimationFrame(loop);
      }
      _perfFpsLoop = requestAnimationFrame(loop);
    }
    function _stopFpsMeter() {
      if (_perfFpsLoop) { cancelAnimationFrame(_perfFpsLoop); _perfFpsLoop = null; }
    }

    function _dotClass(pct) {
      return pct >= 80 ? 'perf-dot-crit' : pct >= 50 ? 'perf-dot-warn' : 'perf-dot-ok';
    }
    function _barClass(pct) {
      return pct >= 80 ? 'perf-bar-crit' : pct >= 50 ? 'perf-bar-warn' : 'perf-bar-ok';
    }
    function _colorVal(pct, val) {
      const c = pct >= 80 ? '#b71c1c' : pct >= 50 ? '#e65100' : '#2e7d32';
      return `<span style="color:${c}">${val}</span>`;
    }

    async function _buildPerfReport() {
      // LocalStorage usage
      let lsUsed = 0;
      try {
        for (let i = 0; i < localStorage.length; i++) {
          const k = localStorage.key(i);
          lsUsed += (localStorage.getItem(k) || '').length + k.length;
        }
      } catch(_) {}
      const lsKB = (lsUsed / 1024).toFixed(1);
      const lsMax = 5120; // ~5MB typical limit
      const lsPct = Math.min(100, Math.round(lsUsed / 1024 / lsMax * 100));

      // Memory
      const mem = (performance.memory) ? {
        used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024),
        total: Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024),
        pct: Math.round(performance.memory.usedJSHeapSize / performance.memory.jsHeapSizeLimit * 100)
      } : null;

      // Error counts
      let errCount = 0, fatalCount = 0, warnCount = 0;
      try {
        const logs = JSON.parse(localStorage.getItem(_LOG_KEY) || '[]');
        errCount  = logs.filter(l => l.level === 'error').length;
        fatalCount= logs.filter(l => l.level === 'fatal').length;
        warnCount = logs.filter(l => l.level === 'warn').length;
      } catch(_) {}
      const errLegacy = JSON.parse(localStorage.getItem(_ERR_KEY) || '[]').length;
      const totalErr = errCount + fatalCount + errLegacy;
      const errPct = Math.min(100, totalErr * 5);

      // Network
      const online = navigator.onLine;
      let navTime = null;
      try {
        const nav = performance.getEntriesByType('navigation')[0];
        if (nav) navTime = Math.round(nav.loadEventEnd - nav.startTime);
      } catch(_) {}

      // SW cache
      let swCaches = 0;
      try {
        const keys = await caches.keys();
        swCaches = keys.length;
      } catch(_) {}

      // FPS
      const fps = _perfFps;
      const fpsPct = fps < 20 ? 90 : fps < 40 ? 50 : 10; // inverted: low fps = high pct = bad

      const row = (dot, label, val) =>
        `<div class="perf-metric"><div class="perf-dot ${dot}"></div><div class="perf-label">${label}</div><div class="perf-val">${val}</div></div>`;
      const bar = (pct) =>
        `<div class="perf-bar-wrap"><div class="perf-bar ${_barClass(pct)}" style="width:${pct}%"></div></div>`;

      return `
<div class="perf-section">
  <div class="perf-section-title">💾 ストレージ</div>
  ${row(_dotClass(lsPct), 'LocalStorage', _colorVal(lsPct, `${lsKB} KB / ${lsMax} KB`))}
  ${bar(lsPct)}
  ${row('perf-dot-ok', 'SW キャッシュ', `${swCaches} 件`)}
</div>
<div class="perf-section">
  <div class="perf-section-title">🧠 メモリ</div>
  ${mem
    ? row(_dotClass(mem.pct), 'JS ヒープ', _colorVal(mem.pct, `${mem.used} / ${mem.total} MB`)) + bar(mem.pct)
    : row('perf-dot-ok', 'JS ヒープ', '<span style="color:var(--text-muted)">計測不可 (Safari)</span>')}
</div>
<div class="perf-section">
  <div class="perf-section-title">🌐 ネットワーク</div>
  ${row(online ? 'perf-dot-ok' : 'perf-dot-crit', 'オンライン状態', online ? '✅ オンライン' : '❌ オフライン')}
  ${navTime !== null ? row('perf-dot-ok', 'ページロード時間', `${navTime} ms`) : ''}
</div>
<div class="perf-section">
  <div class="perf-section-title">⚠️ エラー（セッション累計）</div>
  ${row(_dotClass(Math.min(100,fatalCount*20)), '致命的エラー', _colorVal(Math.min(100,fatalCount*20), `${fatalCount} 件`))}
  ${row(_dotClass(Math.min(100,errPct)), 'エラー合計', _colorVal(Math.min(100,errPct), `${totalErr} 件`))}
  ${row(_dotClass(Math.min(100,warnCount*3)), '警告', _colorVal(Math.min(100,warnCount*3), `${warnCount} 件`))}
</div>
<div class="perf-section">
  <div class="perf-section-title">🖥 レンダリング</div>
  <div class="perf-fps-display">
    <div class="perf-fps-num" style="color:${fps >= 50 ? '#2e7d32' : fps >= 30 ? '#e65100' : fps > 0 ? '#b71c1c' : 'var(--text-muted)'}">${fps > 0 ? fps : '--'}</div>
    <div class="perf-fps-label">FPS (画面描画レート)</div>
  </div>
  ${bar(fpsPct)}
  ${row(_dotClass(fpsPct), 'フレームレート評価', fps >= 50 ? '✅ 良好' : fps >= 30 ? '⚠️ やや低下' : fps > 0 ? '🔴 低下中' : '-- 計測中')}
</div>`;
    }

    async function openPerfModal() {
      document.getElementById('perf-modal').classList.add('show');
      document.getElementById('perf-content').innerHTML =
        '<div style="text-align:center;color:var(--text-muted);font-size:13px;padding:24px 0;">計測中…</div>';
      _startFpsMeter();
      // Give FPS meter 1 second to stabilize
      await new Promise(r => setTimeout(r, 1200));
      document.getElementById('perf-content').innerHTML = await _buildPerfReport();
    }

    document.getElementById('perf-close').addEventListener('click', () => {
      document.getElementById('perf-modal').classList.remove('show');
      _stopFpsMeter();
    });
    document.getElementById('perf-close2').addEventListener('click', () => {
      document.getElementById('perf-modal').classList.remove('show');
      _stopFpsMeter();
    });
    document.getElementById('perf-refresh').addEventListener('click', async () => {
      document.getElementById('perf-content').innerHTML =
        '<div style="text-align:center;color:var(--text-muted);font-size:13px;padding:24px 0;">再計測中…</div>';
      _stopFpsMeter();
      _startFpsMeter();
      await new Promise(r => setTimeout(r, 1200));
      document.getElementById('perf-content').innerHTML = await _buildPerfReport();
    });

    /* =====================================================
       TAILSCALE VPN / SSH
       IPアドレスは常に暗号化保存 / マスク表示
       ===================================================== */
    async function renderTailscaleCard() {
      const cfg  = loadConfig();
      const sens = await loadSensitiveData();
      const macIp  = sens.tsMac   || '';
      const iphone = sens.tsIphone || '';
      const user   = cfg.tsUser   || '';
      const wrap   = document.getElementById('ts-card-wrap');
      if (!wrap) return;
      if (!macIp && !iphone) { wrap.style.display = 'none'; return; }
      wrap.style.display = '';
      // 表示は常にマスク（実IPは画面に出さない）
      document.getElementById('ts-mac-ip-disp').textContent    = maskIp(macIp);
      document.getElementById('ts-iphone-ip-disp').textContent = maskIp(iphone);

      // SSH/SFTPリンクはURLに実IPを含むが、href属性はブラウザが管理（画面上には表示しない）
      const sshUrl  = user && macIp ? `ssh://${user}@${macIp}` : '#';
      const sftpUrl = user && macIp ? `ftp://${user}@${macIp}:22` : '#';
      document.getElementById('ts-ssh-btn').href  = sshUrl;
      document.getElementById('ts-sftp-btn').href = sftpUrl;

      // コピーボタン（実IPをクリップボードにコピー、ログには記録しない）
      const copyMac = document.getElementById('ts-copy-mac');
      const copyIph = document.getElementById('ts-copy-iphone');
      copyMac.onclick = () => {
        navigator.clipboard?.writeText(macIp).then(() => toast('📋 MacBook IP をコピーしました'));
      };
      copyIph.onclick = () => {
        navigator.clipboard?.writeText(iphone).then(() => toast('📋 iPhone IP をコピーしました'));
      };

      // 疎通確認（Tailscale経由でMacにアクセス可能かチェック）
      document.getElementById('ts-ping-btn').onclick = async () => {
        const res = document.getElementById('ts-ping-result');
        const dot = document.getElementById('ts-status-dot');
        res.style.display = '';
        res.textContent = '📡 確認中…';
        dot.className = 'ts-status-dot offline';
        document.getElementById('ts-status-label').textContent = '確認中…';
        // 最新のIPを都度取得（クロージャ内の古い値を使わない）
        const curSens = await loadSensitiveData();
        const curIp = curSens.tsMac || '';
        if (!curIp) { res.textContent = '⚠️ MacBook IPが未設定です'; return; }
        try {
          const ctrl = new AbortController();
          setTimeout(() => ctrl.abort(), 4000);
          await fetch(`http://${curIp}:22`, { signal: ctrl.signal, mode: 'no-cors' });
          dot.className = 'ts-status-dot';
          document.getElementById('ts-status-label').textContent = '接続可能';
          // 結果にはIPを表示しない（マスク表示）
          res.textContent = `✅ ${maskIp(curIp)} — 到達可能`;
          _appLog('info', 'tailscale', '疎通確認成功');
        } catch(e) {
          const reachable = e.name !== 'AbortError';
          dot.className = reachable ? 'ts-status-dot' : 'ts-status-dot offline';
          document.getElementById('ts-status-label').textContent = reachable ? '接続可能' : 'タイムアウト';
          res.textContent = reachable
            ? `✅ ${maskIp(curIp)} — SSH接続可能`
            : `❌ ${maskIp(curIp)} — 到達不可（VPN確認）`;
          _appLog(reachable ? 'info' : 'warn', 'tailscale', `疎通確認: ${e.name}`);
        }
      };
    }

    /* =====================================================
       議事録・文字起こし (Web Speech API)
       ===================================================== */
    const _MIN_LS_KEY = '_kintai_minutes_hist';
    let _minActive = false, _minRec = null, _minTimer = null, _minElapsed = 0;
    let _minBlocks = [];      // { ts, text }[]
    let _minLastFinalTime = 0;
    const _MIN_PAUSE_MS = 2800; // この間隔以上空いたら新ブロック

    function _minFmtTime(sec) {
      return `${String(Math.floor(sec/60)).padStart(2,'0')}:${String(sec%60).padStart(2,'0')}`;
    }
    function _minWallTs() {
      const d = new Date();
      return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
    }
    function _minRenderTranscript(interimText) {
      const body = document.getElementById('min-transcript-body');
      if (!body) return;
      if (!_minBlocks.length && !interimText) {
        body.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:28px 0;font-size:12px;line-height:1.8;">🎙 録音開始でリアルタイム文字起こし<br><span style="font-size:11px;">Chrome / Safari (iOS 14.5+)　日本語</span></div>';
        return;
      }
      let html = _minBlocks.map((b, i) =>
        `<div class="min-block">` +
          `<div class="min-speaker">発言 ${i+1} · ${b.ts}</div>` +
          `<div class="min-text">${_esc(b.text)}</div>` +
        `</div>`
      ).join('');
      if (interimText) {
        html += `<div class="min-block" style="opacity:.6;border-color:#bdbdbd;">` +
          `<div class="min-speaker">認識中...</div>` +
          `<div class="min-text interim">${_esc(interimText)}</div>` +
        `</div>`;
      }
      body.innerHTML = html;
      const t = document.getElementById('min-transcript');
      if (t) t.scrollTop = t.scrollHeight;
    }

    function _minSetupSR() {
      if (!_minActive) return;
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) return;
      _minRec = new SR();
      _minRec.lang = 'ja-JP';
      _minRec.continuous = false;
      _minRec.interimResults = true;
      _minRec.maxAlternatives = 1;

      _minRec.onresult = ev => {
        const now = Date.now();
        let interim = '', final = '';
        for (const r of ev.results) {
          if (r.isFinal) final += r[0].transcript;
          else interim += r[0].transcript;
        }
        if (final) {
          const isNew = (now - _minLastFinalTime) > _MIN_PAUSE_MS || !_minBlocks.length;
          if (isNew) {
            _minBlocks.push({ ts: _minWallTs(), text: final });
          } else {
            _minBlocks[_minBlocks.length - 1].text += '　' + final;
          }
          _minLastFinalTime = now;
          _minRenderTranscript('');
        } else {
          _minRenderTranscript(interim);
        }
      };
      _minRec.onerror = ev => {
        if (ev.error === 'no-speech' || ev.error === 'aborted') return;
        const st = document.getElementById('min-status');
        if (st) st.textContent = `⚠️ ${ev.error}`;
        _appLog('warn', 'minutes', `SR error: ${ev.error}`);
      };
      _minRec.onend = () => { if (_minActive) setTimeout(_minSetupSR, 80); };
      try { _minRec.start(); } catch(_) { setTimeout(_minSetupSR, 500); }
    }

    function _minStart() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { toast('❌ このブラウザは音声認識に非対応です（Chrome/Safariを使用）'); return; }
      _minActive = true; _minElapsed = 0;
      _minTimer = setInterval(() => {
        _minElapsed++;
        const el = document.getElementById('min-timer');
        if (el) el.textContent = _minFmtTime(_minElapsed);
      }, 1000);
      const btn = document.getElementById('min-rec-btn');
      btn.textContent = '⏹ 停止';
      btn.classList.replace('start', 'stop');
      document.getElementById('min-status').style.display = '';
      _minSetupSR();
      _appLog('info', 'minutes', '録音開始');
    }

    function _minStop() {
      _minActive = false;
      if (_minRec) { try { _minRec.stop(); } catch(_) {} _minRec = null; }
      if (_minTimer) { clearInterval(_minTimer); _minTimer = null; }
      const btn = document.getElementById('min-rec-btn');
      btn.textContent = '🔴 録音開始';
      btn.classList.replace('stop', 'start');
      document.getElementById('min-status').style.display = 'none';
      _minRenderTranscript('');
      _appLog('info', 'minutes', `録音停止: ${_minFmtTime(_minElapsed)}, ${_minBlocks.length}ブロック`);
    }

    function _minBuildText() {
      const title = document.getElementById('min-title')?.value.trim() || '議事録';
      const d = new Date();
      const dStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      const md = `# ${title}\n日時: ${dStr}  \n録音時間: ${_minFmtTime(_minElapsed)}\n\n` +
        _minBlocks.map((b, i) => `## 発言 ${i+1} (${b.ts})\n${b.text}`).join('\n\n');
      return { title, dStr, md };
    }

    function _minSaveHistory() {
      try {
        const { title, dStr, md } = _minBuildText();
        const hist = JSON.parse(localStorage.getItem(_MIN_LS_KEY) || '[]');
        hist.unshift({ id: Date.now(), title, date: dStr, blocks: _minBlocks.length, md });
        if (hist.length > 50) hist.length = 50;
        localStorage.setItem(_MIN_LS_KEY, JSON.stringify(hist));
        toast('💾 議事録を保存しました');
        _appLog('info', 'minutes', `保存: ${title}`);
      } catch(e) { toast('❌ 保存失敗: ' + e.message); }
    }

    function _minRenderHistory() {
      const el = document.getElementById('min-hist-list');
      if (!el) return;
      let hist = [];
      try { hist = JSON.parse(localStorage.getItem(_MIN_LS_KEY) || '[]'); } catch(_) {}
      if (!hist.length) {
        el.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:24px 0;font-size:12px;">保存された議事録はありません</div>';
        return;
      }
      el.innerHTML = hist.map(h =>
        `<div class="min-hist-item" data-id="${h.id}">` +
          `<div class="min-hist-title">${_esc(h.title)}</div>` +
          `<div class="min-hist-meta">${h.date} · ${h.blocks}ブロック</div>` +
        `</div>`
      ).join('');
      el.querySelectorAll('.min-hist-item').forEach(item => {
        item.addEventListener('click', () => {
          const id = Number(item.dataset.id);
          const rec = hist.find(h => h.id === id);
          if (!rec) return;
          navigator.clipboard?.writeText(rec.md).then(() => toast('📋 Markdownをコピーしました'));
        });
      });
    }

    // Tab toggle
    function _minSwitchTab(tab) {
      ['rec','hist','video'].forEach(t => {
        const panel = document.getElementById('min-panel-' + t);
        const btn   = document.getElementById('min-tab-' + t);
        const active = t === tab;
        if (panel) panel.style.display = active ? 'flex' : 'none';
        if (btn) {
          btn.style.borderBottomColor = active ? 'var(--accent-blue)' : 'transparent';
          btn.style.color = active ? 'var(--accent-blue)' : 'var(--text-muted)';
        }
      });
      if (tab === 'hist') _minRenderHistory();
    }

    function openMinModal() {
      _minRenderTranscript('');
      document.getElementById('min-modal').classList.add('show');
    }

    document.getElementById('btn-minutes').addEventListener('click', openMinModal);
    document.getElementById('min-close').addEventListener('click', () => {
      if (_minActive) _minStop();
      document.getElementById('min-modal').classList.remove('show');
    });
    document.getElementById('min-tab-rec').addEventListener('click',   () => _minSwitchTab('rec'));
    document.getElementById('min-tab-hist').addEventListener('click',  () => _minSwitchTab('hist'));
    document.getElementById('min-tab-video').addEventListener('click', () => _minSwitchTab('video'));
    document.getElementById('min-rec-btn').addEventListener('click', () => {
      _minActive ? _minStop() : _minStart();
    });
    document.getElementById('min-copy').addEventListener('click', () => {
      if (!_minBlocks.length) { toast('⚠️ 文字起こし内容がありません'); return; }
      const { md } = _minBuildText();
      navigator.clipboard?.writeText(md).then(() => toast('📋 テキストをコピーしました'))
        .catch(() => toast('❌ クリップボードへのアクセスが拒否されました'));
    });
    document.getElementById('min-md').addEventListener('click', () => {
      if (!_minBlocks.length) { toast('⚠️ 内容がありません'); return; }
      const { md, title, dStr } = _minBuildText();
      const blob = new Blob([md], { type: 'text/markdown;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${dStr}_${title}.md`;
      a.click();
      URL.revokeObjectURL(a.href);
    });
    document.getElementById('min-obsidian').addEventListener('click', () => {
      if (!_minBlocks.length) { toast('⚠️ 内容がありません'); return; }
      const cfg = loadConfig();
      const vault = cfg.vault || '';
      if (!vault) { toast('⚠️ 設定でObsidian Vault名を設定してください'); return; }
      const { md, title, dStr } = _minBuildText();
      const sub = cfg.subdir ? cfg.subdir + '/' : '';
      const file = encodeURIComponent(`${sub}${dStr}_${title}`);
      const content = encodeURIComponent(md);
      location.href = `obsidian://new?vault=${encodeURIComponent(vault)}&file=${file}&content=${content}`;
    });
    document.getElementById('min-save-min').addEventListener('click', () => {
      if (!_minBlocks.length) { toast('⚠️ 内容がありません'); return; }
      _minSaveHistory();
    });
    document.getElementById('min-clear').addEventListener('click', () => {
      if (!confirm('文字起こし内容をクリアしますか？')) return;
      if (_minActive) _minStop();
      _minBlocks = []; _minElapsed = 0;
      document.getElementById('min-timer').textContent = '00:00';
      document.getElementById('min-title').value = '';
      _minRenderTranscript('');
    });

    /* =====================================================
       CAMERA SIZE MEASUREMENT
       ===================================================== */
    (function() {
      let _camStream = null;
      let _camFacing = 'environment';
      let _camScale  = null;   // px per mm (set after calibration)
      let _camState  = 0;      // 0=ref pt1, 1=ref pt2, 2=meas pt1, 3=meas pt2, 4=done
      let _camPts    = [];
      let _camRefW   = 85.6;   // mm
      let _camType   = 'foot';

      const vidEl    = document.getElementById('measure-video');
      const cvs      = document.getElementById('measure-canvas');
      const ctx      = cvs.getContext('2d');
      const stepEl   = document.getElementById('measure-step');
      const camMsg   = document.getElementById('measure-cam-msg');
      const resultEl = document.getElementById('measure-result');
      const resultMm = document.getElementById('measure-result-mm');
      const resultSz = document.getElementById('measure-result-size');

      const STEPS = [
        '① 基準物の端（A点）をタップ',
        '② 基準物の逆端（B点）をタップ',
        '③ 計測箇所の始点（C点）をタップ',
        '④ 計測箇所の終点（D点）をタップ',
        '✅ 計測完了！リセットで再計測できます',
      ];

      function _resize() {
        const wrap = document.getElementById('measure-cam-wrap');
        if (!wrap) return;
        cvs.width  = wrap.offsetWidth;
        cvs.height = wrap.offsetHeight;
        _draw();
      }

      function _draw() {
        ctx.clearRect(0, 0, cvs.width, cvs.height);
        const colors = ['#FFD600','#FF6F00','#00BCD4','#00E676'];
        const labels = ['A','B','C','D'];
        _camPts.forEach((pt, i) => {
          ctx.beginPath();
          ctx.arc(pt.x, pt.y, 9, 0, Math.PI * 2);
          ctx.fillStyle = colors[i] + 'CC';
          ctx.fill();
          ctx.strokeStyle = 'white';
          ctx.lineWidth = 2;
          ctx.stroke();
          ctx.fillStyle = 'white';
          ctx.font = 'bold 11px sans-serif';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(labels[i], pt.x, pt.y);
        });
        if (_camPts.length >= 2) {
          ctx.beginPath();
          ctx.moveTo(_camPts[0].x, _camPts[0].y);
          ctx.lineTo(_camPts[1].x, _camPts[1].y);
          ctx.strokeStyle = '#FFD600CC';
          ctx.lineWidth = 2;
          ctx.setLineDash([7, 4]);
          ctx.stroke();
          ctx.setLineDash([]);
        }
        if (_camPts.length >= 4) {
          ctx.beginPath();
          ctx.moveTo(_camPts[2].x, _camPts[2].y);
          ctx.lineTo(_camPts[3].x, _camPts[3].y);
          ctx.strokeStyle = '#00E676CC';
          ctx.lineWidth = 2.5;
          ctx.setLineDash([7, 4]);
          ctx.stroke();
          ctx.setLineDash([]);
        }
      }

      function _ptFromEvent(e) {
        const rect = cvs.getBoundingClientRect();
        const sx = cvs.width / rect.width;
        const sy = cvs.height / rect.height;
        const src = e.touches ? e.touches[0] : e;
        return { x: (src.clientX - rect.left) * sx, y: (src.clientY - rect.top) * sy };
      }

      function _dist(a, b) {
        return Math.sqrt((b.x - a.x) ** 2 + (b.y - a.y) ** 2);
      }

      function _sizeSuggestion(mm, type) {
        const cm = mm / 10;
        if (type === 'foot') {
          const sz = (Math.round(cm * 2) / 2).toFixed(1);
          return `足の長さ: ${cm.toFixed(1)}cm\n推奨シューズ: ${sz}cm`;
        }
        if (type === 'shoulder') {
          const sz = cm < 40 ? 'S' : cm < 44 ? 'M' : cm < 48 ? 'L' : 'XL';
          return `肩幅: ${cm.toFixed(1)}cm → ${sz}サイズ`;
        }
        if (type === 'waist') {
          const sz = cm < 72 ? 'S' : cm < 78 ? 'M' : cm < 84 ? 'L' : 'XL';
          return `ウエスト: ${cm.toFixed(1)}cm → ${sz}サイズ`;
        }
        return `計測値: ${cm.toFixed(1)} cm`;
      }

      function _onTap(e) {
        e.preventDefault();
        if (_camState >= 4) return;
        const pt = _ptFromEvent(e);
        _camPts.push(pt);
        if (_camState === 1) {
          const px = _dist(_camPts[0], _camPts[1]);
          _camScale = px / _camRefW;
        }
        if (_camState === 3) {
          const px = _dist(_camPts[2], _camPts[3]);
          const mm = px / _camScale;
          resultMm.textContent = `${Math.round(mm)} mm (${(mm / 10).toFixed(1)} cm)`;
          resultSz.textContent = _sizeSuggestion(mm, _camType);
          resultSz.style.whiteSpace = 'pre-line';
          resultEl.style.display = '';
        }
        _camState = Math.min(_camState + 1, 4);
        stepEl.textContent = STEPS[_camState > 4 ? 4 : _camState];
        _draw();
      }

      function _reset() {
        _camState = 0; _camPts = []; _camScale = null;
        resultEl.style.display = 'none';
        stepEl.textContent = STEPS[0];
        _draw();
      }

      async function _startCam() {
        if (_camStream) { _camStream.getTracks().forEach(t => t.stop()); _camStream = null; }
        camMsg.style.display = 'flex';
        camMsg.textContent = '📷 カメラを起動中...';
        try {
          _camStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: _camFacing, width: { ideal: 1280 }, height: { ideal: 720 } }
          });
          vidEl.srcObject = _camStream;
          await vidEl.play();
          camMsg.style.display = 'none';
        } catch(err) {
          camMsg.textContent = `❌ カメラにアクセスできません: ${err.message}`;
        }
      }

      function _stopCam() {
        if (_camStream) { _camStream.getTracks().forEach(t => t.stop()); _camStream = null; }
        vidEl.srcObject = null;
      }

      // Reference buttons
      document.querySelectorAll('.measure-ref-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.measure-ref-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          _camRefW = parseFloat(btn.dataset.w);
          _reset();
        });
      });

      // Type buttons
      document.querySelectorAll('.measure-type-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.measure-type-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          _camType = btn.dataset.type;
        });
      });

      cvs.addEventListener('click', _onTap);
      cvs.addEventListener('touchend', _onTap, { passive: false });
      document.getElementById('measure-reset').addEventListener('click', _reset);
      document.getElementById('measure-flip').addEventListener('click', async () => {
        _camFacing = _camFacing === 'environment' ? 'user' : 'environment';
        await _startCam();
      });

      document.getElementById('btn-measure').addEventListener('click', async () => {
        document.getElementById('measure-modal').classList.add('show');
        _reset();
        setTimeout(_resize, 100);
        await _startCam();
      });

      document.getElementById('measure-close').addEventListener('click', () => {
        document.getElementById('measure-modal').classList.remove('show');
        _stopCam();
      });

      vidEl.addEventListener('loadedmetadata', _resize);
      window.addEventListener('resize', () => {
        if (document.getElementById('measure-modal').classList.contains('show')) _resize();
      });
    })();

    /* =====================================================
       動画・音声ファイル 文字起こし
       ===================================================== */
    (() => {
      let _vsr = null;         // SpeechRecognition instance
      let _vBlocks = [];       // transcript blocks [{text, ts}]
      let _vAudioEl = null;

      function _vRender() {
        const body = document.getElementById('min-video-transcript-body');
        if (!body) return;
        if (!_vBlocks.length) {
          body.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:28px 0;font-size:12px;line-height:1.8;">📁 動画または音声ファイルを選択して<br>「文字起こし開始」を押してください<br><span style="font-size:11px;opacity:0.8;">⚠️ スピーカー再生＋マイク認識方式<br>ヘッドフォンを外してご使用ください</span></div>';
          return;
        }
        body.innerHTML = _vBlocks.map((b, i) =>
          `<div class="min-block" data-i="${i}"><span class="min-ts">${b.ts}</span><span class="min-text">${_esc(b.text)}</span></div>`
        ).join('');
        body.scrollTop = body.scrollHeight;
      }

      function _vStop() {
        const statusEl = document.getElementById('min-video-status');
        const startBtn = document.getElementById('min-video-start');
        const stopBtn  = document.getElementById('min-video-stop');
        if (_vsr) { try { _vsr.stop(); } catch(e) {} _vsr = null; }
        if (_vAudioEl) { _vAudioEl.pause(); }
        if (statusEl) { statusEl.style.display = 'none'; statusEl.textContent = ''; }
        if (startBtn) startBtn.style.display = '';
        if (stopBtn)  stopBtn.style.display  = 'none';
      }

      function _vStart() {
        const audio = document.getElementById('min-video-audio');
        const statusEl = document.getElementById('min-video-status');
        const startBtn = document.getElementById('min-video-start');
        const stopBtn  = document.getElementById('min-video-stop');
        _vAudioEl = audio;

        if (!audio.src || audio.src === window.location.href) {
          toast('⚠️ 先にファイルを選択してください'); return;
        }
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SR) { toast('❌ このブラウザは音声認識に対応していません'); return; }

        _vBlocks = [];
        _vRender();

        const sr = new SR();
        _vsr = sr;
        sr.lang = 'ja-JP';
        sr.continuous = true;
        sr.interimResults = false;
        sr.maxAlternatives = 1;

        sr.onresult = e => {
          for (let i = e.resultIndex; i < e.results.length; i++) {
            const txt = e.results[i][0].transcript.trim();
            if (!txt) continue;
            const now = new Date();
            const ts = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
            _vBlocks.push({ text: txt, ts });
          }
          _vRender();
        };
        sr.onerror = e => {
          if (e.error === 'aborted') return;
          if (statusEl) statusEl.textContent = `⚠️ 認識エラー: ${e.error}`;
        };
        sr.onend = () => {
          // Restart if audio is still playing
          if (_vsr && _vAudioEl && !_vAudioEl.paused && !_vAudioEl.ended) {
            try { _vsr.start(); } catch(ex) {}
          } else {
            _vStop();
          }
        };

        sr.start();
        audio.play().catch(err => {
          toast(`⚠️ 再生エラー: ${err.message}`);
          _vStop();
        });
        audio.onended = () => _vStop();

        if (statusEl) { statusEl.textContent = '🎙 再生中・文字起こし中…'; statusEl.style.display = ''; }
        if (startBtn) startBtn.style.display = 'none';
        if (stopBtn)  stopBtn.style.display  = '';
      }

      // File picker
      document.getElementById('min-video-pick').addEventListener('click', () => {
        document.getElementById('min-video-file').click();
      });
      document.getElementById('min-video-file').addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        e.target.value = '';
        const url = URL.createObjectURL(file);
        const audio = document.getElementById('min-video-audio');
        audio.src = url;
        document.getElementById('min-video-player-wrap').style.display = '';
        document.getElementById('min-video-file-info').textContent = `📄 ${file.name}  (${(file.size/1024/1024).toFixed(1)} MB)`;
        document.getElementById('min-video-title').value = file.name.replace(/\.[^.]+$/, '');
        _vBlocks = [];
        _vRender();
      });

      document.getElementById('min-video-start').addEventListener('click', _vStart);
      document.getElementById('min-video-stop').addEventListener('click',  _vStop);

      document.getElementById('min-video-copy').addEventListener('click', () => {
        if (!_vBlocks.length) { toast('⚠️ 文字起こし内容がありません'); return; }
        const txt = _vBlocks.map(b => `[${b.ts}] ${b.text}`).join('\n');
        navigator.clipboard?.writeText(txt).then(() => toast('📋 テキストをコピーしました'))
          .catch(() => toast('❌ クリップボードへのアクセスが拒否されました'));
      });

      document.getElementById('min-video-save').addEventListener('click', () => {
        if (!_vBlocks.length) { toast('⚠️ 内容がありません'); return; }
        const title = document.getElementById('min-video-title').value || '動画文字起こし';
        const now = new Date();
        const dStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
        const content = `# ${title}\n\n作成日: ${dStr}\n\n` + _vBlocks.map(b => `[${b.ts}] ${b.text}`).join('\n');
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${title}_${dStr}.txt`;
        a.click();
        toast('💾 テキストファイルを保存しました');
      });

      document.getElementById('min-video-clear').addEventListener('click', () => {
        _vStop();
        _vBlocks = [];
        _vRender();
        const audio = document.getElementById('min-video-audio');
        audio.src = '';
        document.getElementById('min-video-player-wrap').style.display = 'none';
        document.getElementById('min-video-title').value = '';
      });
    })();

    /* =====================================================
       AI CHAT  — Claude / ChatGPT / Gemini + System Tools
       ===================================================== */
    (function initAiChat() {
      const _getSrv = () => window._srvBase || 'http://localhost:8899';
      const MAX_HIST = 60;

      // --- ツール定義 (共通スキーマ) ---
      const TOOL_DEFS = [
        {
          name: 'get_system_status',
          description: 'サーバーの状態・アップタイム・機能フラグを取得する',
          parameters: { type: 'object', properties: {}, required: [] },
        },
        {
          name: 'list_files',
          description: 'プロジェクトのファイル一覧を取得する',
          parameters: { type: 'object', properties: {}, required: [] },
        },
        {
          name: 'read_file',
          description: 'ファイルの内容を読み込む（ソースコード・設定・ログなど）',
          parameters: {
            type: 'object',
            properties: { path: { type: 'string', description: 'ファイルパス (例: sw.js, STRUCTURE.md)' } },
            required: ['path'],
          },
        },
        {
          name: 'get_logs',
          description: 'サーバーまたはウォッチドッグの直近ログを取得する',
          parameters: {
            type: 'object',
            properties: {
              type:  { type: 'string', description: 'server または watchdog (デフォルト: server)' },
              lines: { type: 'number', description: '取得行数 (デフォルト: 80)' },
            },
            required: [],
          },
        },
        {
          name: 'restart_server',
          description: 'ローカル API サーバー (port 8899) を再起動する',
          parameters: { type: 'object', properties: {}, required: [] },
        },
        {
          name: 'get_kintai_config',
          description: '勤怠アプリの設定情報を取得する（デフォルト勤務時間・場所など）',
          parameters: { type: 'object', properties: {}, required: [] },
        },
        {
          name: 'get_structure',
          description: 'システムのディレクトリ構成 (STRUCTURE.md) を取得する',
          parameters: { type: 'object', properties: {}, required: [] },
        },
      ];

      // --- ツール実行 ---
      async function _execTool(name, args) {
        try {
          switch (name) {
            case 'get_system_status': {
              const r = await fetch(`${_getSrv()}/api/health`).then(r => r.json());
              return JSON.stringify(r, null, 2);
            }
            case 'list_files': {
              const r = await fetch(`${_getSrv()}/api/files`).then(r => r.json());
              return JSON.stringify(r.files?.map(f => ({ path: f.path, is_dir: f.is_dir, size: f.size, modified: f.modified })), null, 2);
            }
            case 'read_file': {
              const r = await fetch(`${_getSrv()}/api/files/read?path=${encodeURIComponent(args.path || '')}`).then(r => r.json());
              if (r.error) return `エラー: ${r.error}`;
              return r.truncated ? r.content + '\n\n[200KB を超えたため切り詰めました]' : r.content;
            }
            case 'get_logs': {
              const type  = args.type  || 'server';
              const lines = args.lines || 80;
              const r = await fetch(`${_getSrv()}/api/system/logs?type=${type}&lines=${lines}`).then(r => r.json());
              if (r.error) return `エラー: ${r.error}`;
              return r.lines.join('\n');
            }
            case 'restart_server': {
              const r = await fetch(`${_getSrv()}/api/system/restart`, { method: 'POST' }).then(r => r.json());
              return JSON.stringify(r);
            }
            case 'get_kintai_config': {
              const cfg = JSON.parse(localStorage.getItem('kintaiConfig') || '{}');
              const safe = { ...cfg };
              delete safe.jinjerPass;
              return JSON.stringify(safe, null, 2);
            }
            case 'get_structure': {
              return await fetch(`${_getSrv()}/api/structure`).then(r => r.text());
            }
            default:
              return `不明なツール: ${name}`;
          }
        } catch (e) {
          return `ツール実行エラー: ${e.message}`;
        }
      }

      // --- システムプロンプト ---
      function _sysPrompt() {
        return `あなたは kintai PWA（勤怠管理アプリ）の AI アシスタントです。
このシステムは Mac で動作し、以下のコンポーネントで構成されています:
- index.html: PWA 本体（勤怠/ハブ/学習/進捗/報告書/案件/AI タブ）
- jinjer_server.py: ローカル API サーバー (port 8899)
- sw.js: Service Worker (PWA キャッシュ制御)
- watchdog.py: サーバー死活監視（60秒ごと自動再起動）
- sync_jinjer.py: jinjer から勤怠データを取得 (Playwright)
- report_sync.py: Excel ↔ kintai データ変換

利用可能なツールを使ってシステムの状態確認・ファイル確認・ログ確認・設定変更を行えます。
破壊的な変更（サーバー再起動・設定変更）は実行前にユーザーへ確認してください。
日本語で回答してください。`;
      }

      // --- UI ヘルパー ---
      function _md(text) {
        return text
          .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
          .replace(/```([\s\S]*?)```/g, (_,c) => `<pre><code>${c.trimStart()}</code></pre>`)
          .replace(/`([^`\n]+)`/g, '<code>$1</code>')
          .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
          .replace(/^#{1,3} (.+)$/gm, '<strong>$1</strong>')
          .replace(/^[•\-\*] (.+)$/gm, '• $1')
          .replace(/\n/g, '<br>');
      }

      function _appendMsg(role, text) {
        const el = document.getElementById('ai-messages');
        if (!el) return;
        const div = document.createElement('div');
        div.className = role === 'user' ? 'ai-msg-user' : 'ai-msg-assistant';
        if (role === 'assistant') div.innerHTML = _md(text);
        else div.textContent = text;
        el.appendChild(div);
        el.scrollTop = el.scrollHeight;
      }

      function _appendTool(name, args) {
        const el = document.getElementById('ai-messages');
        if (!el) return;
        const div = document.createElement('div');
        div.className = 'ai-msg-tool';
        const a = Object.keys(args || {}).length ? ` (${JSON.stringify(args)})` : '';
        div.textContent = `🔧 ${name}${a}`;
        el.appendChild(div);
        el.scrollTop = el.scrollHeight;
      }

      function _appendSys(text) {
        const el = document.getElementById('ai-messages');
        if (!el) return;
        const div = document.createElement('div');
        div.className = 'ai-msg-system';
        div.textContent = text;
        el.appendChild(div);
        el.scrollTop = el.scrollHeight;
      }

      // --- history: [{role:'user'|'assistant', content:string}] ---
      let _history = [];
      let _busy = false;
      let _initialized = false;

      // ===== Claude (Anthropic) =====
      async function _runClaude(userText, apiKey) {
        const tools = TOOL_DEFS.map(t => ({
          name: t.name, description: t.description,
          input_schema: { type: 'object', properties: t.parameters.properties, required: t.parameters.required },
        }));
        // build local messages from clean history + new user msg
        const localMsgs = _history.map(m => ({ role: m.role, content: m.content }));
        localMsgs.push({ role: 'user', content: userText });

        let finalText = '';
        for (let i = 0; i < 6; i++) {
          const resp = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'x-api-key': apiKey,
              'anthropic-version': '2023-06-01',
              'anthropic-dangerous-allow-browser': 'true',
              'content-type': 'application/json',
            },
            body: JSON.stringify({ model: 'claude-sonnet-4-6', max_tokens: 4096, system: _sysPrompt(), tools, messages: localMsgs }),
          });
          if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            throw new Error(err.error?.message || `HTTP ${resp.status}`);
          }
          const res = await resp.json();
          const texts = (res.content || []).filter(b => b.type === 'text').map(b => b.text);
          if (texts.length) finalText += texts.join('');

          if (res.stop_reason === 'tool_use') {
            const toolBlocks = res.content.filter(b => b.type === 'tool_use');
            localMsgs.push({ role: 'assistant', content: res.content });
            const results = [];
            for (const tb of toolBlocks) {
              _appendTool(tb.name, tb.input);
              const out = await _execTool(tb.name, tb.input || {});
              results.push({ type: 'tool_result', tool_use_id: tb.id, content: out });
            }
            localMsgs.push({ role: 'user', content: results });
          } else { break; }
        }
        return finalText || '(応答なし)';
      }

      // ===== OpenAI =====
      async function _runOpenAI(userText, apiKey) {
        const tools = TOOL_DEFS.map(t => ({
          type: 'function',
          function: { name: t.name, description: t.description, parameters: { type: 'object', properties: t.parameters.properties, required: t.parameters.required } },
        }));
        const msgs = [
          { role: 'system', content: _sysPrompt() },
          ..._history.map(m => ({ role: m.role, content: m.content })),
          { role: 'user', content: userText },
        ];
        for (let i = 0; i < 6; i++) {
          const resp = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${apiKey}`, 'content-type': 'application/json' },
            body: JSON.stringify({ model: 'gpt-4o', messages: msgs, tools, tool_choice: 'auto' }),
          });
          if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            throw new Error(err.error?.message || `HTTP ${resp.status}`);
          }
          const res = await resp.json();
          const msg = res.choices?.[0]?.message;
          if (!msg) throw new Error('OpenAI: no message returned');

          if (msg.tool_calls?.length) {
            msgs.push(msg);
            for (const tc of msg.tool_calls) {
              const args = JSON.parse(tc.function.arguments || '{}');
              _appendTool(tc.function.name, args);
              const out = await _execTool(tc.function.name, args);
              msgs.push({ role: 'tool', tool_call_id: tc.id, content: out });
            }
          } else {
            return msg.content || '(応答なし)';
          }
        }
        return '(最大ループ数に達しました)';
      }

      // ===== Gemini =====
      async function _runGemini(userText, apiKey) {
        const tools = [{
          functionDeclarations: TOOL_DEFS.map(t => ({
            name: t.name, description: t.description,
            parameters: {
              type: 'OBJECT',
              properties: Object.fromEntries(
                Object.entries(t.parameters.properties || {}).map(([k, v]) => [k, { type: (v.type || 'string').toUpperCase(), description: v.description || '' }])
              ),
            },
          })),
        }];
        const contents = [
          ..._history.map(m => ({ role: m.role === 'assistant' ? 'model' : 'user', parts: [{ text: m.content }] })),
          { role: 'user', parts: [{ text: userText }] },
        ];
        const sysInst = { parts: [{ text: _sysPrompt() }] };
        for (let i = 0; i < 6; i++) {
          const resp = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,
            { method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify({ contents, tools, systemInstruction: sysInst }) }
          );
          if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            throw new Error(err.error?.message || `HTTP ${resp.status}`);
          }
          const res = await resp.json();
          const parts = res.candidates?.[0]?.content?.parts || [];
          const funcCalls = parts.filter(p => p.functionCall);
          const textParts = parts.filter(p => p.text);

          if (funcCalls.length) {
            contents.push({ role: 'model', parts });
            const funcResps = [];
            for (const fc of funcCalls) {
              _appendTool(fc.functionCall.name, fc.functionCall.args);
              const out = await _execTool(fc.functionCall.name, fc.functionCall.args || {});
              funcResps.push({ functionResponse: { name: fc.functionCall.name, response: { result: out } } });
            }
            contents.push({ role: 'user', parts: funcResps });
          } else {
            return textParts.map(p => p.text).join('') || '(応答なし)';
          }
        }
        return '(最大ループ数に達しました)';
      }

      // --- 送信メイン ---
      async function _send() {
        if (_busy) return;
        const input = document.getElementById('ai-input');
        const text = input?.value.trim();
        if (!text) return;

        const model = document.getElementById('ai-model-select')?.value || 'claude';
        const sens = await loadSensitiveData();
        const keyMap = { claude: sens.aiKeyClaude, openai: sens.aiKeyOpenAI, gemini: sens.aiKeyGemini };
        const apiKey = keyMap[model];
        if (!apiKey) {
          _appendSys('⚠️ APIキーが未設定です。⚙️ ボタンから設定してください。');
          return;
        }

        _appendMsg('user', text);
        _history.push({ role: 'user', content: text });
        input.value = '';
        input.style.height = 'auto';

        _busy = true;
        const sendBtn = document.getElementById('ai-send-btn');
        if (sendBtn) sendBtn.disabled = true;

        // Thinking indicator
        const msgEl = document.getElementById('ai-messages');
        const thinkDiv = document.createElement('div');
        thinkDiv.id = 'ai-thinking';
        thinkDiv.className = 'ai-msg-assistant';
        thinkDiv.innerHTML = '<span style="opacity:0.45">思考中 ⏳</span>';
        msgEl?.appendChild(thinkDiv);
        msgEl && (msgEl.scrollTop = msgEl.scrollHeight);

        try {
          let reply = '';
          if (model === 'claude')  reply = await _runClaude(text, apiKey);
          if (model === 'openai')  reply = await _runOpenAI(text, apiKey);
          if (model === 'gemini')  reply = await _runGemini(text, apiKey);
          document.getElementById('ai-thinking')?.remove();
          _appendMsg('assistant', reply);
          _history.push({ role: 'assistant', content: reply });
        } catch (e) {
          document.getElementById('ai-thinking')?.remove();
          _appendSys(`❌ エラー: ${e.message}`);
          _history.pop(); // user msg を戻す
        } finally {
          _busy = false;
          if (sendBtn) sendBtn.disabled = false;
        }
        if (_history.length > MAX_HIST) _history = _history.slice(-MAX_HIST);
      }

      // --- API キー設定 ---
      async function _loadKeys() {
        const s = await loadSensitiveData();
        ['claude','openai','gemini'].forEach(p => {
          const el = document.getElementById(`ai-key-${p}`);
          const keyName = p === 'claude' ? 'aiKeyClaude' : p === 'openai' ? 'aiKeyOpenAI' : 'aiKeyGemini';
          if (el && s[keyName]) el.value = s[keyName];
        });
      }

      async function _saveKeys() {
        const kc = document.getElementById('ai-key-claude')?.value.trim() || '';
        const ko = document.getElementById('ai-key-openai')?.value.trim() || '';
        const kg = document.getElementById('ai-key-gemini')?.value.trim() || '';
        const cur = await loadSensitiveData();
        await saveSensitiveData({ ...cur, aiKeyClaude: kc, aiKeyOpenAI: ko, aiKeyGemini: kg });
        if (typeof toast === 'function') toast('✅ APIキーを保存しました');
        document.getElementById('ai-settings-modal').style.display = 'none';
      }

      // --- タブ初期化 (switchTab から呼ばれる) ---
      window.initAiTab = function() {
        if (_initialized) return;
        _initialized = true;
        _appendSys('🤖 AI アシスタントへようこそ');
        _appendSys('⚙️ ボタンから API キーを設定してください（Claude / ChatGPT / Gemini）');
        _appendSys('ローカルサーバーが起動中なら、ファイル確認・ログ確認・サーバー再起動なども依頼できます。');
      };

      window.addEventListener('load', () => {
        document.getElementById('ai-send-btn')?.addEventListener('click', _send);
        document.getElementById('ai-input')?.addEventListener('keydown', e => {
          if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); _send(); }
        });
        document.getElementById('ai-input')?.addEventListener('input', function() {
          this.style.height = 'auto';
          this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        });
        document.getElementById('ai-clear-btn')?.addEventListener('click', () => {
          _history = [];
          const el = document.getElementById('ai-messages');
          if (el) el.innerHTML = '';
          _initialized = false;
          window.initAiTab();
        });
        // ── AI プロンプト例チップ ─────────────────────────────────
        const _PROMPT_CHIPS = [
          // 🔧 IT・技術
          { icon: '🔧', text: 'このコードの問題点を分析して改善案を提案して' },
          { icon: '🐍', text: 'PythonでCSVを集計してグラフ化するスクリプトを書いて' },
          { icon: '🐳', text: 'Dockerfileを最適化するベストプラクティスを教えて' },
          { icon: '🗄', text: 'SQLクエリのパフォーマンスを改善する方法を教えて' },
          { icon: '⚙️', text: 'CI/CDパイプラインをGitHub Actionsで構築する方法を教えて' },
          // 💼 ビジネス・仕事
          { icon: '📝', text: 'この文章を簡潔でわかりやすいビジネス文書に書き直して' },
          { icon: '📊', text: 'プレゼン資料の構成案を3パターン提案して' },
          { icon: '📧', text: 'クライアントへの丁寧なお詫びメールの文面を作成して' },
          { icon: '📋', text: '議事録を要約して次回のアクションアイテムを整理して' },
          { icon: '💰', text: '以下のデータから経営判断に使えるインサイトを抽出して' },
          // 🚀 キャリア・副業
          { icon: '🚀', text: 'フリーランスエンジニアで年収1000万を目指す具体的な戦略を教えて' },
          { icon: '📈', text: '2026年に需要が高いITスキルトップ10とその学習ロードマップを教えて' },
          { icon: '💡', text: '副業・フリーランスを始めるための最初のステップを教えて' },
          { icon: '🎯', text: 'ポートフォリオに載せるべきプロジェクト選定の基準を教えて' },
          // 🧠 分析・思考
          { icon: '🧠', text: 'このアイデアのメリット・デメリットを多角的に分析して' },
          { icon: '🔍', text: '問題を解決するためのロジカルシンキングフレームワークを適用して' },
          { icon: '⚖️', text: '意思決定に迷っているので判断軸を整理して決断を助けて' },
          { icon: '💬', text: '複雑な技術概念を非エンジニアに伝わるように説明して' },
          // ⚡ 生産性・日常
          { icon: '📅', text: '効率的な週次レビューのテンプレートと実施手順を作成して' },
          { icon: '⏱', text: '集中力を高めるための科学的に証明されたテクニックを教えて' },
          { icon: '🏥', text: 'デスクワーク中心の生活で健康を維持する具体的な方法を教えて' },
          { icon: '💪', text: '睡眠の質を改善するための実践的なアドバイスをください' },
        ];
        (function _renderPromptChips() {
          const wrap = document.getElementById('ai-prompts-wrap');
          if (!wrap) return;
          wrap.innerHTML = _PROMPT_CHIPS.map(c =>
            `<button class="ai-prompt-chip" data-prompt="${c.text.replace(/"/g,'&quot;')}">${c.icon} ${c.text.slice(0,18)}…</button>`
          ).join('');
          wrap.querySelectorAll('.ai-prompt-chip').forEach(btn => {
            btn.addEventListener('click', () => {
              const inp = document.getElementById('ai-input');
              if (inp) {
                inp.value = btn.dataset.prompt;
                inp.focus();
                inp.dispatchEvent(new Event('input'));
              }
            });
          });
        })();

        document.getElementById('ai-settings-btn')?.addEventListener('click', async () => {
          await _loadKeys();
          document.getElementById('ai-settings-modal').style.display = 'flex';
        });
        document.getElementById('ai-settings-close')?.addEventListener('click', () => {
          document.getElementById('ai-settings-modal').style.display = 'none';
        });
        document.getElementById('ai-settings-save')?.addEventListener('click', _saveKeys);
        ['claude','openai','gemini'].forEach(p => {
          document.getElementById(`ai-key-${p}-toggle`)?.addEventListener('click', () => {
            const inp = document.getElementById(`ai-key-${p}`);
            if (inp) inp.type = inp.type === 'password' ? 'text' : 'password';
          });
        });
      });
    })();

    /* =====================================================
       HTTPS MIXED CONTENT BANNER
       ===================================================== */
    (function initHttpsBanner() {
      // HTTPS ページから HTTP localhost への接続は Safari でブロックされる
      // → GitHub Pages(HTTPS) でアクセスしている場合のみバナーを表示
      const isHttps = location.protocol === 'https:';
      const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
      if (!isHttps || isLocalhost) return;

      // ローカルサーバー存在チェック (fetch できれば非表示)
      const DISMISSED_KEY = '_kintai_https_banner_dismissed';
      if (sessionStorage.getItem(DISMISSED_KEY)) return;

      const banner = document.getElementById('https-banner');
      if (!banner) return;

      // localhost だけでなく外部HTTPS URLも試してサーバーが見つからない場合のみ表示
      _resolveServerUrl(8899).then(base => {
        if (!base) banner.style.display = 'block';
      });

      document.getElementById('https-banner-close')?.addEventListener('click', () => {
        banner.style.display = 'none';
        sessionStorage.setItem(DISMISSED_KEY, '1');
      });
    })();

    /* =====================================================
       TAB MANAGER — 動的タブバー + 表示/非表示/ドラッグ並び替え
       ===================================================== */
    (function _initTabManager() {
      const TAB_CFG_KEY    = '_kintai_tab_config_v1';
      const CUSTOM_TAB_KEY = '_kintai_custom_tabs_v1';

      // ── 組み込みタブ定義 ──────────────────────────────────────────────────
      const _BUILTIN_TABS = [
        { id: 'calendar',  icon: '📅', label: '勤怠',    defaultVisible: true  },
        { id: 'hub',       icon: '🚀', label: 'ハブ',    defaultVisible: true  },
        { id: 'study',     icon: '📚', label: '学習',    defaultVisible: true  },
        { id: 'project',   icon: '📊', label: '進捗',    defaultVisible: true  },
        { id: 'report',    icon: '📋', label: '報告書',  defaultVisible: true  },
        { id: 'jobs',      icon: '💼', label: '案件',    defaultVisible: true  },
        { id: 'ai',        icon: '🤖', label: 'AI',      defaultVisible: true  },
        { id: 'system',    icon: '🔧', label: 'システム',defaultVisible: true  },
        { id: 'employee',  icon: '👥', label: '従業員',  defaultVisible: false },
        { id: 'market',    icon: '📈', label: '市場価値',defaultVisible: false },
        { id: 'db',        icon: '🗄', label: 'DB管理',  defaultVisible: true  },
        { id: 'spec',      icon: '📁', label: '仕様',    defaultVisible: false },
        { id: 'logs',      icon: '📋', label: 'ログ',    defaultVisible: false },
        { id: 'perf',      icon: '⚡', label: 'パフォーマンス', defaultVisible: false },
        { id: 'bizai',     icon: '🗂', label: '業務AI',      defaultVisible: true  },
        { id: 'docker',    icon: '🐳', label: 'Docker',      defaultVisible: false },
      ];

      // ── カスタムタブ CRUD ──────────────────────────────────────────────────
      // 各カスタムタブ: { id, icon, label, type: 'url'|'note'|'blank', content }
      function loadCustomTabs() {
        try { return JSON.parse(localStorage.getItem(CUSTOM_TAB_KEY) || '[]'); } catch(_) { return []; }
      }
      function saveCustomTabs(tabs) { localStorage.setItem(CUSTOM_TAB_KEY, JSON.stringify(tabs)); }

      function _getAllTabs() {
        return [..._BUILTIN_TABS, ...loadCustomTabs()];
      }

      // カスタムタブの HTML ページを動的生成（なければ）
      function _ensureCustomTabPage(tab) {
        const pageId = 'page-' + tab.id;
        if (document.getElementById(pageId)) return;
        const div = document.createElement('div');
        div.id = pageId;
        div.className = 'tab-page';
        if (tab.type === 'url' && tab.content) {
          div.innerHTML = `<iframe src="${tab.content}" style="width:100%;height:calc(100vh - 80px);border:none;border-radius:12px;" allow="fullscreen" loading="lazy"></iframe>`;
        } else if (tab.type === 'note') {
          div.innerHTML = `<div class="card">
            <div class="card-title">${tab.icon} ${tab.label}</div>
            <textarea id="note-${tab.id}" placeholder="メモを入力..." style="width:100%;min-height:300px;padding:10px;border:1px solid var(--border-soft);border-radius:8px;font-size:13px;font-family:inherit;resize:vertical;box-sizing:border-box;background:var(--bg-card);color:var(--text-primary);">${tab.content||''}</textarea>
            <button onclick="(function(){const ta=document.getElementById('note-${tab.id}');const tabs=JSON.parse(localStorage.getItem('${CUSTOM_TAB_KEY}')||'[]');const t=tabs.find(x=>x.id==='${tab.id}');if(t){t.content=ta.value;localStorage.setItem('${CUSTOM_TAB_KEY}',JSON.stringify(tabs));toast('💾 メモを保存しました');}})();" class="btn-primary" style="margin-top:8px;">💾 保存</button>
          </div>`;
        } else {
          div.innerHTML = `<div class="card"><div class="card-title">${tab.icon} ${tab.label}</div><div style="color:var(--text-muted);font-size:13px;">カスタムタブ（空白）</div></div>`;
        }
        // タブページコンテナに追加
        const nav = document.getElementById('bottom-tabs');
        nav?.parentNode?.insertBefore(div, nav);
      }

      // 起動時: 既存カスタムタブのページを生成
      loadCustomTabs().forEach(_ensureCustomTabPage);

      function loadTabConfig() {
        try { const r = localStorage.getItem(TAB_CFG_KEY); if (r) return JSON.parse(r); } catch(_) {}
        return null;
      }
      function saveTabConfig(cfg) { localStorage.setItem(TAB_CFG_KEY, JSON.stringify(cfg)); }

      function getEffectiveConfig() {
        const allTabs = _getAllTabs();
        const saved = loadTabConfig();
        const base = saved || allTabs.map(t => ({ id: t.id, visible: t.defaultVisible ?? true }));
        const knownIds = new Set(base.map(c => c.id));
        const merged = [...base];
        for (const t of allTabs) {
          if (!knownIds.has(t.id)) merged.push({ id: t.id, visible: t.defaultVisible ?? true });
        }
        return merged;
      }

      let _currentTab = 'calendar';

      function switchTab(tabName) {
        _currentTab = tabName;
        document.querySelectorAll('.tab-btn[data-tab]').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.tab === tabName);
        });
        document.querySelectorAll('.tab-page').forEach(p => {
          p.classList.toggle('active', p.id === 'page-' + tabName);
        });
        document.getElementById('fab-group')?.classList.toggle('hidden', tabName !== 'calendar');
        window.scrollTo({ top: 0, behavior: 'smooth' });
        if (tabName === 'hub')      { renderLauncher(); renderTailscaleCard(); if (window._refreshDbStatus) window._refreshDbStatus(); if (window._refreshDockerSysinfo) window._refreshDockerSysinfo(); }
        if (tabName === 'study')    renderStudy();
        if (tabName === 'project')  renderProjects();
        if (tabName === 'report')   { initReportTab(); }
        if (tabName === 'jobs')     { initJobsTab(); }
        if (tabName === 'ai')       { if (window.initAiTab) window.initAiTab(); }
        if (tabName === 'system')   { if (window._initSystemTab) window._initSystemTab(); }
        if (tabName === 'employee') { if (window._renderEmployeeList) window._renderEmployeeList(); }
        if (tabName === 'market')   { if (window._renderMarket) window._renderMarket(); }
        if (tabName === 'db')       { if (window._initDbTab) window._initDbTab(); }
        if (tabName === 'spec')     { if (window._initSpecTab) window._initSpecTab(); }
        if (tabName === 'logs')     { if (window._initLogsTab) window._initLogsTab(); }
        if (tabName === 'perf')     { if (window._initPerfTab) window._initPerfTab(); }
        if (tabName === 'docker')   { if (window._initDockerTab) window._initDockerTab(); }
      }
      window._switchTab = switchTab;

      function renderTabBar() {
        const nav = document.getElementById('bottom-tabs');
        if (!nav) return;
        const config = getEffectiveConfig();
        const manageBtn = nav.querySelector('#tab-manage-btn');
        nav.querySelectorAll('.tab-btn[data-tab]').forEach(b => b.remove());

        const visibleIds = config.filter(c => c.visible).map(c => c.id);
        if (visibleIds.length > 0 && !visibleIds.includes(_currentTab)) {
          _currentTab = visibleIds[0];
        }

        config.filter(c => c.visible).forEach(cfg => {
          const info = _getAllTabs().find(t => t.id === cfg.id);
          if (!info) return;
          const btn = document.createElement('button');
          btn.className = 'tab-btn' + (cfg.id === _currentTab ? ' active' : '');
          btn.dataset.tab = cfg.id;
          btn.innerHTML = `<span class="tab-icon">${info.icon}</span>${info.label}`;
          btn.addEventListener('click', () => switchTab(cfg.id));
          nav.insertBefore(btn, manageBtn);
        });

        document.querySelectorAll('.tab-page').forEach(p => {
          p.classList.toggle('active', p.id === 'page-' + _currentTab);
        });
        document.getElementById('fab-group')?.classList.toggle('hidden', _currentTab !== 'calendar');
      }

      renderTabBar();

      // ===== ドラッグ&ドロップ (マウス + タッチ対応) =====
      const modal = document.getElementById('tab-mgr-modal');
      const listEl = document.getElementById('tab-mgr-list');
      let _editConfig = [];
      let _dragSrcIdx = null;

      function renderMgrList() {
        if (!listEl) return;
        listEl.innerHTML = '';
        _editConfig.forEach((cfg, idx) => {
          const info = _getAllTabs().find(t => t.id === cfg.id);
          if (!info) return;
          const isCustom = !_BUILTIN_TABS.find(t => t.id === cfg.id);
          const row = document.createElement('div');
          row.className = 'tab-mgr-item';
          row.dataset.idx = idx;
          row.setAttribute('draggable', 'true');
          row.innerHTML = `
            <span class="tab-mgr-handle" title="ドラッグで並び替え">☰</span>
            <span class="tab-mgr-icon">${info.icon}</span>
            <span class="tab-mgr-label">${info.label}</span>
            ${isCustom ? `<button class="tab-mgr-delete" data-tab-id="${cfg.id}" title="削除" style="background:none;border:none;font-size:14px;cursor:pointer;padding:4px 6px;color:var(--danger,#c62828);opacity:0.7;margin-right:2px;">🗑</button>` : ''}
            <button class="tab-mgr-toggle ${cfg.visible ? 'on' : ''}" data-idx="${idx}"></button>
          `;
          listEl.appendChild(row);
        });

        // ─── マウスドラッグ ───────────────────────────────────────────────
        listEl.querySelectorAll('.tab-mgr-item').forEach(row => {
          row.addEventListener('dragstart', e => {
            _dragSrcIdx = parseInt(row.dataset.idx);
            row.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
          });
          row.addEventListener('dragend', () => {
            listEl.querySelectorAll('.tab-mgr-item').forEach(r => r.classList.remove('dragging', 'drag-over'));
          });
          row.addEventListener('dragover', e => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const over = parseInt(row.dataset.idx);
            if (over !== _dragSrcIdx) {
              listEl.querySelectorAll('.tab-mgr-item').forEach(r => r.classList.remove('drag-over'));
              row.classList.add('drag-over');
            }
          });
          row.addEventListener('drop', e => {
            e.preventDefault();
            const destIdx = parseInt(row.dataset.idx);
            if (_dragSrcIdx !== null && _dragSrcIdx !== destIdx) {
              const moved = _editConfig.splice(_dragSrcIdx, 1)[0];
              _editConfig.splice(destIdx, 0, moved);
              renderMgrList();
            }
          });
        });

        // ─── タッチドラッグ (iOS / Android) ──────────────────────────────
        let _touchSrcIdx = null, _touchClone = null, _touchStartY = 0;
        listEl.querySelectorAll('.tab-mgr-handle').forEach(handle => {
          handle.addEventListener('touchstart', e => {
            const row = handle.closest('.tab-mgr-item');
            _touchSrcIdx = parseInt(row.dataset.idx);
            _touchStartY = e.touches[0].clientY;
            row.classList.add('dragging');
            // 視覚クローン
            _touchClone = row.cloneNode(true);
            _touchClone.style.cssText = `position:fixed;left:14px;right:14px;z-index:9999;opacity:0.85;
              pointer-events:none;background:var(--bg-card-solid);border-radius:12px;
              box-shadow:0 6px 24px rgba(0,0,0,0.2);padding:0 10px;`;
            _touchClone.style.top = (row.getBoundingClientRect().top) + 'px';
            document.body.appendChild(_touchClone);
            e.preventDefault();
          }, { passive: false });

          handle.addEventListener('touchmove', e => {
            if (_touchClone == null) return;
            const dy = e.touches[0].clientY - _touchStartY;
            const srcRow = listEl.children[_touchSrcIdx];
            const top = srcRow?.getBoundingClientRect().top + dy;
            _touchClone.style.top = top + 'px';

            // 現在どの行の上にいるか検出
            const touchY = e.touches[0].clientY;
            listEl.querySelectorAll('.tab-mgr-item').forEach(r => r.classList.remove('drag-over'));
            let hovered = null;
            listEl.querySelectorAll('.tab-mgr-item').forEach(r => {
              const rect = r.getBoundingClientRect();
              if (touchY >= rect.top && touchY <= rect.bottom) hovered = r;
            });
            if (hovered) hovered.classList.add('drag-over');
            e.preventDefault();
          }, { passive: false });

          handle.addEventListener('touchend', () => {
            if (_touchClone) { _touchClone.remove(); _touchClone = null; }
            const destRow = listEl.querySelector('.tab-mgr-item.drag-over');
            const destIdx = destRow ? parseInt(destRow.dataset.idx) : null;
            listEl.querySelectorAll('.tab-mgr-item').forEach(r => r.classList.remove('dragging', 'drag-over'));
            if (_touchSrcIdx !== null && destIdx !== null && _touchSrcIdx !== destIdx) {
              const moved = _editConfig.splice(_touchSrcIdx, 1)[0];
              _editConfig.splice(destIdx, 0, moved);
              renderMgrList();
            }
            _touchSrcIdx = null;
          });
        });

        // ─── トグル ─────────────────────────────────────────────────────
        listEl.querySelectorAll('.tab-mgr-toggle').forEach(btn => {
          btn.addEventListener('click', () => {
            const idx = parseInt(btn.dataset.idx);
            if (_editConfig[idx].id === 'calendar' && _editConfig[idx].visible) return;
            _editConfig[idx].visible = !_editConfig[idx].visible;
            btn.classList.toggle('on', _editConfig[idx].visible);
          });
        });

        // ─── カスタムタブ削除 ─────────────────────────────────────────
        listEl.querySelectorAll('.tab-mgr-delete').forEach(btn => {
          btn.addEventListener('click', () => {
            const tabId = btn.dataset.tabId;
            if (!confirm(`「${_getAllTabs().find(t=>t.id===tabId)?.label || tabId}」を削除しますか？`)) return;
            saveCustomTabs(loadCustomTabs().filter(t => t.id !== tabId));
            const eIdx = _editConfig.findIndex(c => c.id === tabId);
            if (eIdx !== -1) _editConfig.splice(eIdx, 1);
            document.getElementById('page-' + tabId)?.remove();
            renderMgrList();
            toast('🗑 タブを削除しました');
          });
        });
      }

      // ─── FABショートカット ────────────────────────────────────────────
      const FAB_CONFIG_KEY = '_kintai_fab_config_v1';
      function loadFabConfig() {
        try { return JSON.parse(localStorage.getItem(FAB_CONFIG_KEY) || '[]'); } catch(_) { return []; }
      }
      function saveFabConfig(ids) { localStorage.setItem(FAB_CONFIG_KEY, JSON.stringify(ids)); }

      function renderFabMgrList() {
        const el = document.getElementById('fab-mgr-list');
        if (!el) return;
        const saved = loadFabConfig();
        const tabs = _getAllTabs().filter(t => t.id !== 'calendar');
        el.innerHTML = tabs.map(t => `
          <label style="display:flex;align-items:center;gap:8px;padding:5px 0;font-size:13px;cursor:pointer;">
            <input type="checkbox" class="fab-mgr-check" value="${t.id}"
              ${saved.includes(t.id) ? 'checked' : ''}>
            <span>${t.icon} ${t.label}</span>
          </label>`).join('');
        function updateDisabled() {
          const checked = [...el.querySelectorAll('.fab-mgr-check:checked')];
          el.querySelectorAll('.fab-mgr-check:not(:checked)').forEach(c => {
            c.disabled = checked.length >= 3;
          });
        }
        el.querySelectorAll('.fab-mgr-check').forEach(cb => cb.addEventListener('change', updateDisabled));
        updateDisabled();
      }

      function renderFabItems() {
        const menu = document.getElementById('fab-group-menu');
        if (!menu) return;
        menu.querySelectorAll('.fab-custom').forEach(el => el.remove());
        loadFabConfig().forEach(tabId => {
          const info = _getAllTabs().find(t => t.id === tabId);
          if (!info) return;
          const btn = document.createElement('button');
          btn.className = 'fab-custom';
          btn.title = info.label;
          btn.textContent = info.icon;
          btn.addEventListener('click', () => {
            document.getElementById('fab-group')?.classList.remove('open');
            window._switchTab(tabId);
          });
          menu.insertBefore(btn, menu.firstChild);
        });
      }
      renderFabItems(); // 起動時に適用

      function openTabMgr() {
        _editConfig = getEffectiveConfig().map(c => ({ ...c }));
        renderMgrList();
        renderFabMgrList(); // FABセクション更新
        modal.classList.add('show');
      }

      document.getElementById('tab-manage-btn')?.addEventListener('click', openTabMgr);
      document.getElementById('tab-mgr-close')?.addEventListener('click', () => modal.classList.remove('show'));
      document.getElementById('tab-mgr-save')?.addEventListener('click', () => {
        saveTabConfig(_editConfig);
        renderTabBar();
        // FAB設定を保存
        const fabIds = [...document.querySelectorAll('.fab-mgr-check:checked')].map(c => c.value);
        saveFabConfig(fabIds);
        renderFabItems();
        modal.classList.remove('show');
        toast('✓ タブ設定を保存しました');
      });
      modal?.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('show'); });

      // ─── タブ追加フォーム ─────────────────────────────────────────────
      const _addForm = document.getElementById('tab-add-form');
      document.getElementById('tab-add-btn')?.addEventListener('click', () => {
        _addForm.style.display = _addForm.style.display === 'none' ? 'block' : 'none';
        if (_addForm.style.display === 'block') document.getElementById('tab-add-label')?.focus();
      });
      document.getElementById('tab-add-cancel-btn')?.addEventListener('click', () => {
        _addForm.style.display = 'none';
      });
      document.getElementById('tab-add-type')?.addEventListener('change', e => {
        const row = document.getElementById('tab-add-content-row');
        const inp = document.getElementById('tab-add-content');
        if (e.target.value === 'url') {
          row.style.display = 'block';
          inp.placeholder = 'URL (例: https://example.com)';
        } else {
          row.style.display = 'none';
        }
      });
      document.getElementById('tab-add-confirm-btn')?.addEventListener('click', () => {
        const icon  = (document.getElementById('tab-add-icon')?.value  || '').trim() || '📄';
        const label = (document.getElementById('tab-add-label')?.value || '').trim();
        const type  = document.getElementById('tab-add-type')?.value || 'blank';
        const content = (document.getElementById('tab-add-content')?.value || '').trim();
        if (!label) { toast('⚠️ タブ名を入力してください'); return; }
        const id = 'custom_' + Date.now();
        const newTab = { id, icon, label, type, content };
        const customs = loadCustomTabs();
        customs.push(newTab);
        saveCustomTabs(customs);
        _ensureCustomTabPage(newTab);
        _editConfig.push({ id, visible: true });
        // フォームリセット
        _addForm.style.display = 'none';
        document.getElementById('tab-add-label').value = '';
        document.getElementById('tab-add-icon').value  = '🔗';
        document.getElementById('tab-add-type').value  = 'url';
        document.getElementById('tab-add-content').value = '';
        document.getElementById('tab-add-content-row').style.display = 'block';
        renderMgrList();
        toast('✓ タブを追加しました');
      });
    })();

    /* =====================================================
       EMPLOYEE MANAGEMENT
       ===================================================== */
    (function _initEmployeeManager() {
      const EMP_KEY = '_kintai_employees_v1';
      const EMPLOYMENT_TYPES = ['正社員', '契約社員', 'パート・アルバイト', '業務委託', '派遣社員', 'インターン'];
      const ROLES = ['エンジニア', 'デザイナー', 'プロジェクトマネージャー', 'ディレクター', 'マーケター', '営業', '経理', '人事', 'その他'];

      function loadEmployees() {
        try { return JSON.parse(localStorage.getItem(EMP_KEY) || '[]'); } catch(_) { return []; }
      }
      function saveEmployees(list) {
        localStorage.setItem(EMP_KEY, JSON.stringify(list));
      }
      function newId() { return 'emp_' + Date.now() + '_' + Math.random().toString(36).slice(2,7); }

      window._renderEmployeeList = function() {
        const listEl = document.getElementById('emp-list');
        if (!listEl) return;
        const emps = loadEmployees();
        if (emps.length === 0) {
          listEl.innerHTML = '<div class="emp-empty">👥 従業員が登録されていません<br><small>「従業員を追加」ボタンから登録してください</small></div>';
          return;
        }
        listEl.innerHTML = '';
        emps.forEach(emp => {
          const card = document.createElement('div');
          card.className = 'emp-card';
          const initials = emp.name ? emp.name.charAt(0) : '?';
          const statusTag = emp.status === 'inactive'
            ? '<span class="emp-tag inactive-tag">退職</span>'
            : '<span class="emp-tag active-tag">在籍</span>';
          card.innerHTML = `
            <div class="emp-avatar">${initials}</div>
            <div class="emp-info">
              <div class="emp-name">${emp.name || '(名前未設定)'}</div>
              <div class="emp-role">${emp.role || ''} ${emp.department ? '/ ' + emp.department : ''}</div>
              <div class="emp-tags">
                ${statusTag}
                ${emp.employmentType ? `<span class="emp-tag">${emp.employmentType}</span>` : ''}
                ${emp.startDate ? `<span class="emp-tag">入社: ${emp.startDate}</span>` : ''}
              </div>
            </div>
            <div class="emp-actions">
              <button class="emp-action-btn" data-id="${emp.id}" data-action="edit">✏️</button>
              <button class="emp-action-btn" data-id="${emp.id}" data-action="delete" style="color:#e53935;">🗑</button>
            </div>
          `;
          listEl.appendChild(card);
        });

        listEl.querySelectorAll('.emp-action-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            const action = btn.dataset.action;
            if (action === 'edit') _openEmpModal(id);
            if (action === 'delete') _deleteEmployee(id);
          });
        });
      };

      function _deleteEmployee(id) {
        if (!confirm('この従業員を削除しますか？')) return;
        const list = loadEmployees().filter(e => e.id !== id);
        saveEmployees(list);
        window._renderEmployeeList();
        toast('🗑 従業員を削除しました');
      }

      function _openEmpModal(editId) {
        const emps = loadEmployees();
        const existing = editId ? emps.find(e => e.id === editId) : null;

        // 動的にモーダル生成
        let modal = document.getElementById('emp-modal');
        if (!modal) {
          modal = document.createElement('div');
          modal.id = 'emp-modal';
          modal.className = 'modal-backdrop';
          modal.innerHTML = `
            <div class="modal-sheet" style="max-height:88vh;overflow-y:auto;">
              <div class="modal-handle"></div>
              <div class="modal-header">
                <div class="modal-title" id="emp-modal-title">従業員を追加</div>
                <button class="modal-close" id="emp-modal-close">✕</button>
              </div>
              <div style="padding:0 14px 14px;display:flex;flex-direction:column;gap:10px;">
                <label style="font-size:12px;font-weight:700;color:var(--text-muted);">氏名 *</label>
                <input id="emp-f-name" class="settings-input" placeholder="山田 太郎" style="margin:0;">
                <label style="font-size:12px;font-weight:700;color:var(--text-muted);">メールアドレス</label>
                <input id="emp-f-email" class="settings-input" type="email" placeholder="yamada@example.com" style="margin:0;">
                <label style="font-size:12px;font-weight:700;color:var(--text-muted);">職種・役割</label>
                <select id="emp-f-role" class="settings-input" style="margin:0;">
                  ${ROLES.map(r => `<option>${r}</option>`).join('')}
                </select>
                <label style="font-size:12px;font-weight:700;color:var(--text-muted);">部署</label>
                <input id="emp-f-dept" class="settings-input" placeholder="開発部" style="margin:0;">
                <label style="font-size:12px;font-weight:700;color:var(--text-muted);">雇用形態</label>
                <select id="emp-f-type" class="settings-input" style="margin:0;">
                  ${EMPLOYMENT_TYPES.map(t => `<option>${t}</option>`).join('')}
                </select>
                <label style="font-size:12px;font-weight:700;color:var(--text-muted);">入社日</label>
                <input id="emp-f-start" class="settings-input" type="date" style="margin:0;">
                <label style="font-size:12px;font-weight:700;color:var(--text-muted);">状態</label>
                <select id="emp-f-status" class="settings-input" style="margin:0;">
                  <option value="active">在籍中</option>
                  <option value="inactive">退職</option>
                </select>
                <label style="font-size:12px;font-weight:700;color:var(--text-muted);">備考</label>
                <textarea id="emp-f-notes" class="settings-input" rows="2" placeholder="メモ..." style="margin:0;resize:none;"></textarea>
                <button id="emp-f-save" class="btn-primary" style="margin-top:6px;">保存</button>
              </div>
            </div>`;
          document.body.appendChild(modal);
          modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('show'); });
          document.getElementById('emp-modal-close').addEventListener('click', () => modal.classList.remove('show'));
        }

        // フォームに既存データをセット
        document.getElementById('emp-modal-title').textContent = existing ? '従業員を編集' : '従業員を追加';
        document.getElementById('emp-f-name').value = existing?.name || '';
        document.getElementById('emp-f-email').value = existing?.email || '';
        document.getElementById('emp-f-role').value = existing?.role || ROLES[0];
        document.getElementById('emp-f-dept').value = existing?.department || '';
        document.getElementById('emp-f-type').value = existing?.employmentType || EMPLOYMENT_TYPES[0];
        document.getElementById('emp-f-start').value = existing?.startDate || '';
        document.getElementById('emp-f-status').value = existing?.status || 'active';
        document.getElementById('emp-f-notes').value = existing?.notes || '';

        const saveBtn = document.getElementById('emp-f-save');
        const newSaveBtn = saveBtn.cloneNode(true);
        saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
        newSaveBtn.addEventListener('click', () => {
          const name = document.getElementById('emp-f-name').value.trim();
          if (!name) { toast('❌ 氏名は必須です'); return; }
          const emp = {
            id: existing?.id || newId(),
            name,
            email: document.getElementById('emp-f-email').value.trim(),
            role: document.getElementById('emp-f-role').value,
            department: document.getElementById('emp-f-dept').value.trim(),
            employmentType: document.getElementById('emp-f-type').value,
            startDate: document.getElementById('emp-f-start').value,
            status: document.getElementById('emp-f-status').value,
            notes: document.getElementById('emp-f-notes').value.trim(),
            updatedAt: new Date().toISOString(),
          };
          const list = loadEmployees();
          if (existing) {
            const i = list.findIndex(e => e.id === existing.id);
            if (i >= 0) list[i] = emp; else list.push(emp);
          } else {
            list.push(emp);
          }
          saveEmployees(list);
          window._renderEmployeeList();
          modal.classList.remove('show');
          toast(existing ? '✓ 従業員情報を更新しました' : '✓ 従業員を追加しました');
        });

        modal.classList.add('show');
      }

      document.getElementById('emp-add-btn')?.addEventListener('click', () => _openEmpModal(null));
    })();

    /* =====================================================
       MARKET VALUE ASSESSMENT
       ===================================================== */
    (function _initMarketValue() {
      const MKT_KEY = '_kintai_market_v1';

      const SKILLS = {
        lang:  [
          { id: 'js',     label: 'JavaScript', pts: 15 },
          { id: 'ts',     label: 'TypeScript',  pts: 18 },
          { id: 'python', label: 'Python',       pts: 16 },
          { id: 'java',   label: 'Java',         pts: 15 },
          { id: 'go',     label: 'Go',           pts: 20 },
          { id: 'rust',   label: 'Rust',         pts: 22 },
          { id: 'swift',  label: 'Swift',        pts: 16 },
          { id: 'kotlin', label: 'Kotlin',       pts: 16 },
          { id: 'php',    label: 'PHP',          pts: 10 },
          { id: 'ruby',   label: 'Ruby',         pts: 12 },
        ],
        fw: [
          { id: 'react',    label: 'React',       pts: 18 },
          { id: 'vue',      label: 'Vue.js',      pts: 14 },
          { id: 'angular',  label: 'Angular',     pts: 13 },
          { id: 'nextjs',   label: 'Next.js',     pts: 18 },
          { id: 'django',   label: 'Django',      pts: 14 },
          { id: 'fastapi',  label: 'FastAPI',     pts: 16 },
          { id: 'spring',   label: 'Spring',      pts: 15 },
          { id: 'nodejs',   label: 'Node.js',     pts: 14 },
          { id: 'flutter',  label: 'Flutter',     pts: 16 },
          { id: 'llm',      label: 'LLM/AI統合',  pts: 25 },
        ],
        cloud: [
          { id: 'aws',    label: 'AWS',           pts: 22 },
          { id: 'gcp',    label: 'GCP',           pts: 20 },
          { id: 'azure',  label: 'Azure',         pts: 20 },
          { id: 'docker', label: 'Docker',        pts: 16 },
          { id: 'k8s',    label: 'Kubernetes',    pts: 22 },
          { id: 'ci',     label: 'CI/CD',         pts: 14 },
          { id: 'linux',  label: 'Linux',         pts: 12 },
          { id: 'pg',     label: 'PostgreSQL',    pts: 12 },
        ],
        cert: [
          { id: 'ap',      label: '応用情報技術者',      pts: 20 },
          { id: 'fe',      label: '基本情報技術者',      pts: 12 },
          { id: 'aws_saa', label: 'AWS SAA',             pts: 20 },
          { id: 'aws_pro', label: 'AWS Professional',    pts: 30 },
          { id: 'gcp_ace', label: 'GCP Associate',       pts: 18 },
          { id: 'pmp',     label: 'PMP',                 pts: 25 },
          { id: 'scrum',   label: 'Scrum Master',        pts: 18 },
          { id: 'sec',     label: '情報セキュリティ SP',  pts: 22 },
        ],
      };

      function loadState() {
        try { return JSON.parse(localStorage.getItem(MKT_KEY) || '{}'); } catch(_) { return {}; }
      }
      function saveState(s) { localStorage.setItem(MKT_KEY, JSON.stringify(s)); }

      function renderSkillGrid(containerId, skills, selected) {
        const el = document.getElementById(containerId);
        if (!el) return;
        el.innerHTML = '';
        skills.forEach(sk => {
          const btn = document.createElement('button');
          btn.className = 'market-skill-chip' + (selected.has(sk.id) ? ' selected' : '');
          btn.textContent = sk.label;
          btn.dataset.id = sk.id;
          btn.addEventListener('click', () => {
            btn.classList.toggle('selected');
            recalc();
          });
          el.appendChild(btn);
        });
      }

      function getSelected(containerId) {
        return new Set(
          [...document.querySelectorAll(`#${containerId} .market-skill-chip.selected`)].map(b => b.dataset.id)
        );
      }

      function recalc() {
        const expIt   = parseInt(document.getElementById('mkt-exp-it')?.value   || 0);
        const expRole = parseInt(document.getElementById('mkt-exp-role')?.value || 0);
        const expMgmt = parseInt(document.getElementById('mkt-exp-mgmt')?.value || 0);

        // スキルポイント合計 (カテゴリ別上限あり)
        const allCats = { lang: 60, fw: 60, cloud: 50, cert: 60 };
        let skillPts = 0;
        const catPts = {};
        for (const [cat, skills] of Object.entries(SKILLS)) {
          const sel = getSelected(`mkt-skills-${cat}`);
          let pts = skills.filter(sk => sel.has(sk.id)).reduce((s, sk) => s + sk.pts, 0);
          pts = Math.min(pts, allCats[cat]);
          catPts[cat] = pts;
          skillPts += pts;
        }

        // 経験年数ポイント
        const expPts = Math.min(expIt * 8, 80) + Math.min(expRole * 5, 40) + Math.min(expMgmt * 10, 50);

        // 総スコア (最大 300)
        const raw = skillPts + expPts;
        const score = Math.min(Math.round(raw * 300 / 400), 300);

        // 推定年収 (万円)
        const baseIncome = 300;
        const incomeRange = score * 2.2;
        const incLow  = Math.round((baseIncome + incomeRange * 0.7) / 10) * 10;
        const incHigh = Math.round((baseIncome + incomeRange * 1.2) / 10) * 10;

        // スコアリング UI 更新
        const scoreEl = document.getElementById('market-score-num');
        const arcEl   = document.getElementById('market-ring-arc');
        if (scoreEl) scoreEl.textContent = score;
        if (arcEl) {
          const pct = score / 300;
          const circumference = 314;
          arcEl.style.strokeDashoffset = String(circumference - circumference * pct);
        }

        document.getElementById('market-income-box').style.display = '';
        document.getElementById('market-income-low').textContent  = incLow;
        document.getElementById('market-income-high').textContent = incHigh;

        // 内訳
        const bdEl = document.getElementById('mkt-breakdown');
        if (bdEl) {
          const rows = [
            { label: '言語スキル',       val: catPts.lang,  max: 60 },
            { label: 'FW/ライブラリ',    val: catPts.fw,    max: 60 },
            { label: 'クラウド/インフラ', val: catPts.cloud, max: 50 },
            { label: '資格',             val: catPts.cert,  max: 60 },
            { label: 'IT 経験年数',       val: Math.min(expIt*8, 80),    max: 80 },
            { label: '職種経験年数',      val: Math.min(expRole*5, 40),  max: 40 },
            { label: 'マネジメント',      val: Math.min(expMgmt*10, 50), max: 50 },
          ];
          bdEl.innerHTML = rows.map(r => `
            <div class="market-bd-row">
              <span class="market-bd-label">${r.label}</span>
              <div class="market-bd-bar-wrap"><div class="market-bd-bar" style="width:${Math.round(r.val/r.max*100)}%"></div></div>
              <span class="market-bd-val">${r.val}</span>
            </div>`).join('');
        }

        // アドバイス
        const recoEl = document.getElementById('mkt-reco');
        if (recoEl) {
          const advice = [];
          if (catPts.cloud < 20) advice.push('<strong>☁️ クラウド</strong>: AWS/GCP の基礎資格を取得すると年収が大幅アップします。');
          if (catPts.cert < 20)  advice.push('<strong>📜 資格</strong>: 応用情報技術者・AWS SAA など実績として評価されやすい資格を狙いましょう。');
          if (!getSelected('mkt-skills-fw').has('llm')) advice.push('<strong>🤖 AI/LLM</strong>: LLM 統合スキルは現在最も市場価値が高い領域の一つです。');
          if (expMgmt < 2) advice.push('<strong>👔 マネジメント</strong>: チームリードや副PM を経験すると年収レンジが大きく上昇します。');
          if (expIt < 5)   advice.push('<strong>⏱ 経験</strong>: IT 経験 5 年以上でスコアが大きく伸びます。継続的な実務が重要です。');
          if (advice.length === 0) advice.push('<strong>🏆 素晴らしい！</strong>現在のスキルセットは非常に競争力があります。継続的な学習で更に差をつけましょう。');
          recoEl.innerHTML = advice.join('<br><br>');
        }

        // 状態を保存
        const state = {
          expIt, expRole, expMgmt,
          selected: {
            lang:  [...getSelected('mkt-skills-lang')],
            fw:    [...getSelected('mkt-skills-fw')],
            cloud: [...getSelected('mkt-skills-cloud')],
            cert:  [...getSelected('mkt-skills-cert')],
          }
        };
        saveState(state);
      }

      window._renderMarket = function() {
        const state = loadState();
        const sel = state.selected || {};

        // スライダー初期値
        ['it', 'role', 'mgmt'].forEach(k => {
          const inp = document.getElementById(`mkt-exp-${k}`);
          const val = document.getElementById(`mkt-exp-${k}-val`);
          if (inp && state[`exp${k.charAt(0).toUpperCase()+k.slice(1)}`] != null) {
            inp.value = state[`exp${k.charAt(0).toUpperCase()+k.slice(1)}`];
          }
          if (inp && val) val.textContent = inp.value + '年';
          inp?.addEventListener('input', () => {
            if (val) val.textContent = inp.value + '年';
            recalc();
          });
        });

        // スキルグリッド描画 (保存済み選択を反映)
        for (const [cat, skills] of Object.entries(SKILLS)) {
          renderSkillGrid(`mkt-skills-${cat}`, skills, new Set(sel[cat] || []));
        }
        recalc();
      };
    })();

    /* =====================================================
       業務AI タブ
       ===================================================== */
    (function _initBizAiTab() {
      const BIZAI_HIST_KEY = '_kintai_bizai_hist_v1';
      const TEMPLATES = {
        email_reply: {
          label: '📧 メール返信',
          placeholder: '返信したいメールの内容を貼り付けてください...',
          prompt: (text, tone, len) =>
            `以下のメールに対して、${_toneLabel(tone)}で${_lenLabel(len)}返信メールを作成してください。\n\n【受信メール】\n${text}`
        },
        minutes: {
          label: '📝 議事録要約',
          placeholder: '会議の発言録や録音の文字起こしを貼り付けてください...',
          prompt: (text, tone, len) =>
            `以下の会議内容を議事録として整理してください。決定事項・アクションアイテム・担当者を明確に。文体は${_toneLabel(tone)}、${_lenLabel(len)}でまとめてください。\n\n【会議内容】\n${text}`
        },
        report_weekly: {
          label: '📊 週報作成',
          placeholder: '今週やったこと・課題・来週の予定などをメモ書きで入力してください...',
          prompt: (text, tone, len) =>
            `以下のメモを元に、${_toneLabel(tone)}の週次報告書を作成してください。フォーマット：【今週の成果】【課題・懸念事項】【来週の計画】の3セクション構成で${_lenLabel(len)}。\n\n【メモ】\n${text}`
        },
        contract_check: {
          label: '📄 契約書チェック',
          placeholder: '確認したい契約書の条項や文章を貼り付けてください...',
          prompt: (text, tone, len) =>
            `以下の契約書文章を確認し、注意すべき点・不明瞭な箇所・リスクがある条項を${_lenLabel(len)}で指摘してください。法的アドバイスではなく一般的なチェックポイントのみ。\n\n【契約書文章】\n${text}`
        },
        presentation: {
          label: '🎯 資料構成案',
          placeholder: 'プレゼンのテーマや伝えたい内容を入力してください...',
          prompt: (text, tone, len) =>
            `以下のテーマでプレゼンテーション資料の構成案を作成してください。各スライドのタイトルと要点を${_lenLabel(len)}で提案してください。\n\n【テーマ・内容】\n${text}`
        },
        schedule: {
          label: '🗓 日程調整文',
          placeholder: '調整したい打ち合わせの目的や候補日時を入力してください...',
          prompt: (text, tone, len) =>
            `以下の情報を元に、日程調整の依頼メール文を${_toneLabel(tone)}で作成してください。${_lenLabel(len)}。\n\n【情報】\n${text}`
        },
        estimate: {
          label: '💰 見積もり作成',
          placeholder: '作業内容・工数・単価などをメモ書きで入力してください...',
          prompt: (text, tone, len) =>
            `以下の情報を元に、見積書の項目と金額の案を作成し、${_toneLabel(tone)}の添え状文も付けてください。${_lenLabel(len)}。\n\n【情報】\n${text}`
        },
        complaint: {
          label: '🤝 クレーム対応',
          placeholder: 'クレームの内容と状況を入力してください...',
          prompt: (text, tone, len) =>
            `以下のクレームに対して、誠実かつ${_toneLabel(tone)}のお詫び・対応文を作成してください。${_lenLabel(len)}。感情的にならず事実に基づいた内容で。\n\n【クレーム内容】\n${text}`
        },
        free: {
          label: '✏️ フリー入力',
          placeholder: 'AIへの指示と素材をここに入力してください...',
          prompt: (text) => text
        }
      };

      function _toneLabel(t) {
        return { formal: 'ビジネス敬語（丁寧語）', semi: 'やや丁寧な口調', casual: 'カジュアルな口調' }[t] || '丁寧語';
      }
      function _lenLabel(l) {
        return { short: '200字以内の簡潔さ', medium: '400字程度の標準的な長さ', long: '800字以上の詳細な内容' }[l] || '標準的な長さ';
      }

      let _currentTpl = null;
      const inputEl  = document.getElementById('bizai-input');
      const labelEl  = document.getElementById('bizai-input-label');
      const runBtn   = document.getElementById('bizai-run-btn');
      const resultCard = document.getElementById('bizai-result-card');
      const resultEl = document.getElementById('bizai-result-text');
      const copyBtn  = document.getElementById('bizai-copy-btn');
      const resetBtn = document.getElementById('bizai-reset-btn');
      const histList = document.getElementById('bizai-history-list');
      const histClearBtn = document.getElementById('bizai-history-clear');

      // テンプレートボタン
      document.querySelectorAll('.bizai-tpl-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tpl = TEMPLATES[btn.dataset.tpl];
          if (!tpl) return;
          document.querySelectorAll('.bizai-tpl-btn').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          _currentTpl = btn.dataset.tpl;
          labelEl.textContent = tpl.label + '：内容を入力';
          inputEl.placeholder = tpl.placeholder;
          inputEl.value = '';
          runBtn.disabled = true;
          resultCard.style.display = 'none';
        });
      });

      inputEl?.addEventListener('input', () => {
        runBtn.disabled = !inputEl.value.trim() || !_currentTpl;
      });

      runBtn?.addEventListener('click', async () => {
        const text = inputEl.value.trim();
        if (!text || !_currentTpl) return;
        const tpl = TEMPLATES[_currentTpl];
        const tone = document.getElementById('bizai-tone')?.value || 'formal';
        const len  = document.getElementById('bizai-length')?.value || 'medium';
        const prompt = tpl.prompt(text, tone, len);

        runBtn.disabled = true;
        runBtn.textContent = '⏳ 生成中...';
        resultCard.style.display = 'none';

        try {
          const sens = await loadSensitiveData();
          const apiKey = sens?.aiKeyClaude;
          if (!apiKey) {
            toast('⚠️ ClaudeのAPIキーがAIタブ→設定に未入力です');
            return;
          }
          const res = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'x-api-key': apiKey,
              'anthropic-version': '2023-06-01',
              'anthropic-dangerous-allow-browser': 'true',
              'content-type': 'application/json'
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-6',
              max_tokens: 1500,
              messages: [{ role: 'user', content: prompt }]
            })
          });
          if (!res.ok) throw new Error(`API error ${res.status}`);
          const data = await res.json();
          const output = data.content?.[0]?.text || '（応答なし）';
          resultEl.textContent = output;
          resultCard.style.display = 'block';
          resultCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

          // 履歴保存
          const hist = _loadHistory();
          hist.unshift({
            ts: new Date().toISOString(),
            tpl: _currentTpl,
            label: tpl.label,
            preview: output.slice(0, 60) + (output.length > 60 ? '...' : '')
          });
          if (hist.length > 20) hist.length = 20;
          _saveHistory(hist);
          _renderHistory();
        } catch (e) {
          toast('❌ エラー: ' + e.message);
        } finally {
          runBtn.disabled = false;
          runBtn.textContent = '🤖 AI生成';
        }
      });

      copyBtn?.addEventListener('click', () => {
        const txt = resultEl.textContent;
        if (!txt) return;
        navigator.clipboard.writeText(txt).then(() => toast('📋 コピーしました')).catch(() => {
          const ta = document.createElement('textarea');
          ta.value = txt; document.body.appendChild(ta); ta.select();
          document.execCommand('copy'); document.body.removeChild(ta);
          toast('📋 コピーしました');
        });
      });

      resetBtn?.addEventListener('click', () => {
        inputEl.value = '';
        resultCard.style.display = 'none';
        runBtn.disabled = true;
        document.querySelectorAll('.bizai-tpl-btn').forEach(b => b.classList.remove('selected'));
        _currentTpl = null;
        labelEl.textContent = '内容を入力してください';
        inputEl.placeholder = '例）受信したメールの内容をここに貼り付けてください...';
      });

      function _loadHistory() {
        try { return JSON.parse(localStorage.getItem(BIZAI_HIST_KEY) || '[]'); } catch(_) { return []; }
      }
      function _saveHistory(h) { localStorage.setItem(BIZAI_HIST_KEY, JSON.stringify(h)); }
      function _renderHistory() {
        const hist = _loadHistory();
        if (!histList) return;
        if (!hist.length) {
          histList.innerHTML = '<div style="padding:8px 0;color:var(--text-muted);">履歴はまだありません</div>';
          return;
        }
        histList.innerHTML = hist.map(h => `
          <div style="display:flex;gap:8px;padding:6px 0;border-bottom:1px solid var(--border-soft);align-items:flex-start;">
            <span style="flex-shrink:0;font-size:11px;color:var(--text-muted);white-space:nowrap;">${h.ts.slice(5,16).replace('T',' ')}</span>
            <div style="flex:1;min-width:0;">
              <div style="font-size:11px;font-weight:700;color:var(--accent-blue);">${_esc(h.label)}</div>
              <div style="font-size:12px;color:var(--text-primary);margin-top:2px;word-break:break-all;">${_esc(h.preview)}</div>
            </div>
          </div>`).join('');
      }

      histClearBtn?.addEventListener('click', () => {
        if (!confirm('履歴をすべて削除しますか？')) return;
        localStorage.removeItem(BIZAI_HIST_KEY);
        _renderHistory();
      });

      _renderHistory();
    })();

    /* =====================================================
       DOCKER TAB
       ===================================================== */
    (() => {
      const _SRV = () => window._srvBase || 'http://localhost:8899';

      let _dockerView = 'containers'; // 'containers' | 'stats' | 'images'
      let _dockerLogModal = null;
      let _logAutoRefreshTimer = null;
      let _logCurrentCid = null;

      // ── ビュー切り替え ─────────────────────────────────────────────────────
      document.querySelectorAll('.docker-view-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          _dockerView = btn.dataset.view;
          document.querySelectorAll('.docker-view-btn').forEach(b => {
            const active = b.dataset.view === _dockerView;
            b.classList.toggle('active', active);
            b.style.background = active ? 'var(--bg-card-solid)' : 'var(--bg-card)';
            b.style.fontWeight = active ? '700' : '400';
          });
          document.getElementById('docker-containers-view').style.display =
            _dockerView === 'containers' ? '' : 'none';
          document.getElementById('docker-stats-view').style.display =
            _dockerView === 'stats' ? '' : 'none';
          document.getElementById('docker-images-view').style.display =
            _dockerView === 'images' ? '' : 'none';
          _loadDockerView();
        });
      });

      // ── 更新ボタン ────────────────────────────────────────────────────────
      document.getElementById('docker-refresh-btn')?.addEventListener('click', _loadDockerView);

      // ── ログモーダル ──────────────────────────────────────────────────────
      _dockerLogModal = document.getElementById('docker-log-modal');
      document.getElementById('docker-log-close')?.addEventListener('click', () => {
        _stopLogAutoRefresh();
        _dockerLogModal.classList.remove('show');
      });

      // ── 状態バッジ ────────────────────────────────────────────────────────
      function _stateBadge(state) {
        const colors = { running: '#2da44e', exited: '#8b949e', paused: '#e3b341', created: '#58a6ff' };
        const c = colors[state?.toLowerCase()] || '#8b949e';
        return `<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${c};margin-right:5px;flex-shrink:0;"></span>${state || '-'}`;
      }

      // ── リソースバー描画 ───────────────────────────────────────────────────
      function _usageBar(pct, type) {
        const cls = pct >= 90 ? 'danger' : pct >= 70 ? 'warn' : type;
        return `
          <div class="docker-stat-bar-wrap">
            <div class="docker-stat-bar ${cls}" style="width:${Math.min(pct,100)}%;"></div>
          </div>`;
      }

      // ── コンテナ一覧 ─────────────────────────────────────────────────────
      async function _loadContainers() {
        const listEl = document.getElementById('docker-container-list');
        if (!listEl) return;
        listEl.innerHTML = '<div style="color:var(--text-muted);font-size:12px;padding:8px;">読み込み中...</div>';
        try {
          const r = await fetch(`${_SRV()}/api/docker/containers`, { signal: AbortSignal.timeout(8000) });
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          const data = await r.json();
          if (data.error) throw new Error(data.error);
          const containers = data.containers || [];
          const running = containers.filter(c => c.state === 'running').length;
          document.getElementById('docker-status-bar').textContent =
            `🐳 ${running}台稼働 / 全${containers.length}台`;
          if (!containers.length) {
            listEl.innerHTML = '<div style="color:var(--text-muted);font-size:13px;padding:12px;text-align:center;">コンテナはありません</div>';
            return;
          }
          listEl.innerHTML = containers.map(c => {
            const isRunning = c.state === 'running';
            const restartBadge = c.status?.includes('Restarting')
              ? `<span style="color:#e3b341;font-size:10px;margin-left:4px;">🔄 再起動中</span>` : '';
            return `
            <div class="card" style="margin:0;padding:12px;" data-cid="${_esc(c.id)}" data-cname="${_esc(c.name)}">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;gap:6px;">
                <div style="font-size:13px;font-weight:700;word-break:break-all;flex:1;">${_esc(c.name)}${restartBadge}</div>
                <div style="font-size:11px;display:flex;align-items:center;white-space:nowrap;">${_stateBadge(c.state)}</div>
              </div>
              <div style="font-size:11px;color:var(--text-muted);margin-bottom:3px;">🖼 ${_esc(c.image)}</div>
              <div style="font-size:11px;color:var(--text-muted);margin-bottom:${c.ports ? 3 : 8}px;">${_esc(c.status)}</div>
              ${c.ports ? `<div style="font-size:11px;color:var(--accent-blue);margin-bottom:8px;">🔌 ${_esc(c.ports)}</div>` : ''}
              <div style="display:flex;gap:6px;flex-wrap:wrap;">
                ${isRunning
                  ? `<button class="docker-action-btn btn-secondary" data-action="stop" style="font-size:11px;padding:4px 10px;">⏹ 停止</button>
                     <button class="docker-action-btn btn-secondary" data-action="restart" style="font-size:11px;padding:4px 10px;">🔄 再起動</button>`
                  : `<button class="docker-action-btn btn-secondary" data-action="start" style="font-size:11px;padding:4px 10px;">▶ 起動</button>
                     <button class="docker-action-btn btn-secondary" data-action="rm" style="font-size:11px;padding:4px 10px;color:#e05252;">🗑 削除</button>`
                }
                <button class="docker-log-btn btn-secondary" style="font-size:11px;padding:4px 10px;">📄 ログ</button>
              </div>
            </div>`;
          }).join('');

          // アクションボタン
          listEl.querySelectorAll('.docker-action-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
              const card = btn.closest('[data-cid]');
              const cid = card.dataset.cid;
              const cname = card.dataset.cname;
              const action = btn.dataset.action;
              if (action === 'rm' && !confirm(`「${cname}」を削除しますか？`)) return;
              btn.disabled = true;
              const orig = btn.textContent;
              btn.textContent = '…';
              try {
                const r2 = await fetch(`${_SRV()}/api/docker/action`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ action, id: cid }),
                  signal: AbortSignal.timeout(35000)
                });
                const d2 = await r2.json();
                if (d2.error) toast(`❌ ${d2.error}`);
                else { toast(`✓ ${action}: ${cname}`); setTimeout(_loadContainers, 800); }
              } catch(e) {
                toast(`❌ ${e.message}`);
              } finally {
                btn.disabled = false;
                btn.textContent = orig;
              }
            });
          });

          // ログボタン → 自動更新ログ
          listEl.querySelectorAll('.docker-log-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const card = btn.closest('[data-cid]');
              _openLogModal(card.dataset.cid, card.dataset.cname);
            });
          });

          // Hub sysinfo Docker 行も更新
          _updateSysinfoDockerRow(running, containers.length);
        } catch(e) {
          listEl.innerHTML = `<div class="card" style="margin:0;padding:12px;color:#e05252;font-size:12px;">
            ❌ Docker に接続できません: ${_esc(e.message)}<br>
            <span style="color:var(--text-muted);">Docker Desktop が起動しているか確認してください</span>
          </div>`;
          document.getElementById('docker-status-bar').textContent = '⚠️ Docker 未接続';
          _updateSysinfoDockerRow(-1, 0);
        }
      }

      // ── ログモーダル（自動更新つき）────────────────────────────────────────
      async function _openLogModal(cid, cname) {
        _logCurrentCid = cid;
        document.getElementById('docker-log-title').textContent = `📄 ${cname}`;
        document.getElementById('docker-log-content').textContent = '読み込み中...';
        _dockerLogModal.classList.add('show');
        await _fetchLog(cid);
        _startLogAutoRefresh(cid);
      }

      async function _fetchLog(cid) {
        try {
          const r = await fetch(`${_SRV()}/api/docker/logs?id=${encodeURIComponent(cid)}&lines=300`,
            { signal: AbortSignal.timeout(15000) });
          const d = await r.json();
          const el = document.getElementById('docker-log-content');
          el.textContent = d.logs || d.error || '(ログなし)';
          el.scrollTop = el.scrollHeight; // 最下部にスクロール
        } catch(e) {
          document.getElementById('docker-log-content').textContent = `エラー: ${e.message}`;
        }
      }

      function _startLogAutoRefresh(cid) {
        _stopLogAutoRefresh();
        _logAutoRefreshTimer = setInterval(() => {
          const autoRefresh = document.getElementById('docker-log-autorefresh');
          if (autoRefresh?.checked && _dockerLogModal.classList.contains('show')) {
            _fetchLog(cid);
          }
        }, 3000);
      }

      function _stopLogAutoRefresh() {
        if (_logAutoRefreshTimer) { clearInterval(_logAutoRefreshTimer); _logAutoRefreshTimer = null; }
        _logCurrentCid = null;
      }

      // ── 統計ビュー（CPU/MEM バー）─────────────────────────────────────────
      async function _loadStats() {
        const listEl = document.getElementById('docker-stats-list');
        if (!listEl) return;
        listEl.innerHTML = '<div style="color:var(--text-muted);font-size:12px;padding:8px;">読み込み中（数秒かかります）...</div>';
        try {
          const r = await fetch(`${_SRV()}/api/docker/stats`, { signal: AbortSignal.timeout(20000) });
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          const data = await r.json();
          if (data.error) throw new Error(data.error);
          const stats = data.stats || [];
          if (!stats.length) {
            listEl.innerHTML = '<div style="color:var(--text-muted);font-size:13px;padding:12px;text-align:center;">実行中のコンテナがありません</div>';
            return;
          }
          listEl.innerHTML = stats.map(s => {
            const cpuPct  = parseFloat(s.CPUPerc  || '0');
            const memPct  = parseFloat(s.MemPerc  || '0');
            return `
              <div class="card" style="margin:0;padding:12px;">
                <div style="font-size:13px;font-weight:700;margin-bottom:10px;">${_esc(s.Name || s.Container)}</div>
                <div style="margin-bottom:8px;">
                  <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                    <span style="font-size:11px;color:var(--text-muted);width:32px;">CPU</span>
                    ${_usageBar(cpuPct, 'cpu')}
                    <span style="font-size:11px;font-weight:700;width:40px;text-align:right;">${s.CPUPerc || '-'}</span>
                  </div>
                  <div style="display:flex;align-items:center;gap:8px;">
                    <span style="font-size:11px;color:var(--text-muted);width:32px;">MEM</span>
                    ${_usageBar(memPct, 'mem')}
                    <span style="font-size:11px;font-weight:700;width:40px;text-align:right;">${s.MemPerc || '-'}</span>
                  </div>
                </div>
                <div style="font-size:10px;color:var(--text-muted);">
                  💾 ${_esc(s.MemUsage || '-')} &nbsp;|&nbsp; 🌐 ${_esc(s.NetIO || '-')} &nbsp;|&nbsp; 💿 ${_esc(s.BlockIO || '-')}
                </div>
              </div>`;
          }).join('');
        } catch(e) {
          listEl.innerHTML = `<div class="card" style="margin:0;color:#e05252;font-size:12px;">❌ ${_esc(e.message)}</div>`;
        }
      }

      // ── イメージ一覧 ─────────────────────────────────────────────────────
      async function _loadImages() {
        const listEl = document.getElementById('docker-image-list');
        if (!listEl) return;
        listEl.innerHTML = '<div style="color:var(--text-muted);font-size:12px;padding:8px;">読み込み中...</div>';
        try {
          const r = await fetch(`${_SRV()}/api/docker/images`, { signal: AbortSignal.timeout(8000) });
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          const data = await r.json();
          if (data.error) throw new Error(data.error);
          const images = data.images || [];
          // datalist にイメージ候補を追加
          const dl = document.getElementById('docker-image-datalist');
          if (dl) dl.innerHTML = images.map(i => `<option value="${_esc(i.repo + ':' + i.tag)}">`).join('');
          if (!images.length) {
            listEl.innerHTML = '<div style="color:var(--text-muted);font-size:13px;padding:12px;text-align:center;">イメージはありません</div>';
            return;
          }
          listEl.innerHTML = images.map(img => `
            <div class="card" style="margin:0;padding:12px;">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                <div>
                  <div style="font-size:13px;font-weight:700;">${_esc(img.repo)}<span style="color:var(--text-muted);font-weight:400;">:${_esc(img.tag)}</span></div>
                  <div style="font-size:11px;color:var(--text-muted);margin-top:3px;">${_esc(img.size)} &nbsp;|&nbsp; ${_esc(img.created)}</div>
                  <div style="font-size:10px;color:var(--text-muted);font-family:monospace;">${_esc(img.id)}</div>
                </div>
                <button class="docker-image-run-btn btn-secondary" data-image="${_esc(img.repo + ':' + img.tag)}"
                  style="font-size:11px;padding:4px 8px;white-space:nowrap;flex-shrink:0;">▶ 起動</button>
              </div>
            </div>`).join('');

          // イメージから即起動
          listEl.querySelectorAll('.docker-image-run-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              document.getElementById('docker-new-image').value = btn.dataset.image;
              _openCreateModal();
            });
          });
        } catch(e) {
          listEl.innerHTML = `<div class="card" style="margin:0;color:#e05252;font-size:12px;">❌ ${_esc(e.message)}</div>`;
        }
      }

      // ── コンテナ作成モーダル ──────────────────────────────────────────────
      function _openCreateModal() {
        document.getElementById('docker-create-modal').classList.add('show');
      }
      function _closeCreateModal() {
        document.getElementById('docker-create-modal').classList.remove('show');
        document.getElementById('docker-pull-status').style.display = 'none';
      }
      document.getElementById('docker-create-btn')?.addEventListener('click', _openCreateModal);
      document.getElementById('docker-create-close')?.addEventListener('click', _closeCreateModal);

      // Pull ボタン
      document.getElementById('docker-pull-btn')?.addEventListener('click', async () => {
        const image = document.getElementById('docker-new-image').value.trim();
        if (!image) { toast('イメージ名を入力してください'); return; }
        const statusEl = document.getElementById('docker-pull-status');
        const btn = document.getElementById('docker-pull-btn');
        statusEl.style.display = '';
        statusEl.textContent = `📥 Pull 中: ${image} ...`;
        btn.disabled = true;
        try {
          const r = await fetch(`${_SRV()}/api/docker/pull`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image }),
            signal: AbortSignal.timeout(125000)
          });
          const d = await r.json();
          if (d.error) { statusEl.textContent = `❌ ${d.error}`; statusEl.style.color = '#e05252'; }
          else {
            statusEl.textContent = `✓ Pull 完了: ${image}`;
            statusEl.style.color = '#2da44e';
            if (_dockerView === 'images') _loadImages(); // イメージ一覧を更新
          }
        } catch(e) {
          statusEl.textContent = `❌ ${e.message}`;
          statusEl.style.color = '#e05252';
        } finally {
          btn.disabled = false;
        }
      });

      // Run ボタン
      document.getElementById('docker-run-btn')?.addEventListener('click', async () => {
        const image   = document.getElementById('docker-new-image').value.trim();
        const name    = document.getElementById('docker-new-name').value.trim();
        const ports   = document.getElementById('docker-new-ports').value.trim();
        const restart = document.getElementById('docker-new-restart').value;
        const env     = document.getElementById('docker-new-env').value.trim();
        if (!image) { toast('イメージ名を入力してください'); return; }
        const btn = document.getElementById('docker-run-btn');
        btn.disabled = true;
        btn.textContent = '起動中...';
        try {
          const r = await fetch(`${_SRV()}/api/docker/run`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image, name, ports, restart, env }),
            signal: AbortSignal.timeout(65000)
          });
          const d = await r.json();
          if (d.error) { toast(`❌ ${d.error}`); }
          else {
            toast(`✓ 起動完了: ${name || image} (${d.id})`);
            _closeCreateModal();
            // フォームをリセット
            ['docker-new-image','docker-new-name','docker-new-ports','docker-new-env'].forEach(id => {
              const el = document.getElementById(id); if (el) el.value = '';
            });
            document.getElementById('docker-new-restart').value = 'always';
            // コンテナ一覧を更新
            _dockerView = 'containers';
            document.querySelectorAll('.docker-view-btn').forEach(b => {
              const active = b.dataset.view === 'containers';
              b.classList.toggle('active', active);
              b.style.background = active ? 'var(--bg-card-solid)' : 'var(--bg-card)';
              b.style.fontWeight = active ? '700' : '400';
            });
            document.getElementById('docker-containers-view').style.display = '';
            document.getElementById('docker-stats-view').style.display = 'none';
            document.getElementById('docker-images-view').style.display = 'none';
            setTimeout(_loadContainers, 800);
          }
        } catch(e) {
          toast(`❌ ${e.message}`);
        } finally {
          btn.disabled = false;
          btn.textContent = '▶ 起動';
        }
      });

      // ── Hub sysinfo カード — Docker 行更新 ──────────────────────────────
      function _updateSysinfoDockerRow(running, total) {
        const el = document.getElementById('sysinfo-docker-status');
        if (!el) return;
        if (running < 0) {
          el.textContent = '🐳 Docker: 未接続';
          el.style.color = '#e05252';
        } else if (running === 0) {
          el.textContent = `🐳 Docker: 停止中 (全${total}台)`;
          el.style.color = 'var(--text-muted)';
        } else {
          el.textContent = `🐳 Docker: ${running}台稼働 / 全${total}台`;
          el.style.color = '#2da44e';
        }
      }

      // sysinfo-docker-tab-btn → Docker タブに遷移
      document.getElementById('sysinfo-docker-tab-btn')?.addEventListener('click', () => {
        if (window._switchTab) window._switchTab('docker');
      });

      // Hub タブ切り替え時に Docker 状態だけ軽くチェック（statsは叩かない）
      window._refreshDockerSysinfo = async () => {
        try {
          const r = await fetch(`${_SRV()}/api/docker/containers`, { signal: AbortSignal.timeout(4000) });
          if (!r.ok) throw new Error('ng');
          const d = await r.json();
          const cs = d.containers || [];
          _updateSysinfoDockerRow(cs.filter(c => c.state === 'running').length, cs.length);
        } catch { _updateSysinfoDockerRow(-1, 0); }
      };

      // ── メインロード ─────────────────────────────────────────────────────
      function _loadDockerView() {
        if (_dockerView === 'containers') _loadContainers();
        else if (_dockerView === 'stats')  _loadStats();
        else _loadImages();
      }

      window._initDockerTab = _loadDockerView;
    })();

    /* =====================================================
       SERVICE WORKER
       ===================================================== */
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(err => {
        console.warn('ServiceWorker registration failed:', err);
      });
    }
  </script>
</body>
</html>
