<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>å‹¤æ€ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="å‹¤æ€ ">
  <link rel="apple-touch-icon" href="icon-apple.png">

  <!-- Android / General PWA -->
  <meta name="theme-color" content="#7c5fe6">
  <link rel="manifest" href="manifest.json">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; connect-src 'self';">
  <!-- ãƒªã‚½ãƒ¼ã‚¹ãƒ’ãƒ³ãƒˆ: xlsxé…å»¶ãƒ­ãƒ¼ãƒ‰æ™‚ã®DNS/TCPå¾…æ©Ÿã‚’äº‹å‰ã«è§£æ¶ˆ -->
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <!-- xlsx ã¯ Excelå‡ºåŠ›ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã«é…å»¶ãƒ­ãƒ¼ãƒ‰ï¼ˆiOS OOMå¯¾ç­–ï¼‰ -->

  <style>
    :root {
      --bg-page: #eef1fb;
      --bg-card: rgba(255,255,255,0.82);
      --bg-card-solid: #ffffff;
      --border-soft: rgba(180,190,220,0.5);
      --border-color: rgba(180,190,220,0.5);
      --accent-blue: #4f8dfd;
      --accent-purple: #7c5fe6;
      --text-main: #1a1c2e;
      --text-muted: #8890a0;
      --radius-card: 28px;
      --glass-blur: blur(22px) saturate(1.4);
      --shadow-card: 0 8px 40px rgba(60,80,200,0.09), 0 1px 0 rgba(255,255,255,0.7) inset;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --tab-bar-h: 60px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: calc(max(var(--safe-top), 12px)) 12px calc(max(var(--safe-bottom), 0px) + var(--tab-bar-h) + 16px);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      background: linear-gradient(145deg, #d8e8ff 0%, #e8ddff 45%, #ffd8f0 100%) fixed;
      color: var(--text-main);
      min-height: 100dvh;
    }

    /* ======= CARD ======= */
    .card {
      max-width: 960px;
      margin: 0 auto;
      background: var(--bg-card);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border-radius: var(--radius-card);
      border: 1px solid rgba(255,255,255,0.65);
      box-shadow: var(--shadow-card);
      padding: 16px 16px 12px;
      position: relative;
      overflow: hidden;
    }

    .card-title {
      font-size: 11px;
      font-weight: 800;
      margin-bottom: 10px;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    /* ======= HEADER ======= */
    .header-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }
    .header-left, .header-right {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .pill-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 7px 14px;
      font-size: 13px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.7);
      background: rgba(255,255,255,0.55);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      cursor: pointer;
      user-select: none;
      font-family: inherit;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .pill-button .icon { margin-right: 5px; font-size: 13px; }
    .pill-button-primary {
      background: #eef3ff;
      border-color: #c5d2ff;
      color: var(--accent-blue);
      font-weight: 600;
    }
    .pill-button-lock-on {
      background: #ffece5;
      border-color: #ffc1a6;
      color: #f57c00;
      font-weight: 800;
    }
    .month-label { font-size: 20px; font-weight: 800; letter-spacing: -.02em; }
    .nav-arrow {
      width: 32px; height: 32px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.7);
      background: rgba(255,255,255,0.5);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 17px;
      user-select: none;
      font-family: inherit;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    }
    .nav-arrow:active { transform: scale(0.93); }

    /* ======= CALENDAR ======= */
    .calendar-wrapper {
      margin-top: 8px;
      border-radius: 20px;
      overflow: hidden;
      border: 1px solid rgba(180,190,220,0.35);
      box-shadow: 0 2px 12px rgba(60,80,200,0.06);
    }
    table.calendar {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 11px;
    }
    table.calendar th {
      background: rgba(245,246,251,0.7);
      text-align: center;
      padding: 7px 0;
      color: var(--text-muted);
      font-weight: 700;
      font-size: 12px;
      letter-spacing: .02em;
    }
    table.calendar td {
      padding: 3px;
      background: #fff;
      vertical-align: top;
    }
    .day-card {
      border-radius: 14px;
      border: 1.5px solid #e3e7f0;
      padding: 5px 5px 26px;
      min-height: 60px;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 3px;
      background: #fbfbfe;
      transition: border-color 0.12s, box-shadow 0.12s, background 0.12s;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .day-card:active { transform: scale(0.98); }
    .day-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 3px;
    }
    .day-number {
      font-size: 12px;
      font-weight: 800;
      color: var(--text-main);
      min-width: 16px;
    }
    .day-number.sun { color: #c62828; }
    .day-number.sat { color: #1565c0; }
    .status-pill {
      flex: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid transparent;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 700;
      user-select: none;
    }
    .status-pill-æœª    { background:#f4f4f6; color:var(--text-muted); border-color:#e0e0e5; }
    .status-pill-å‡ºç¤¾  { background:#e3f2fd; color:#1565c0; border-color:#bbdefb; }
    .status-pill-åœ¨å®…  { background:#e8f5e9; color:#2e7d32; border-color:#c8e6c9; }
    .status-pill-ä¼‘ã¿  { background:#fff8e1; color:#ef6c00; border-color:#ffe0b2; }
    .status-pill-ç¥æ—¥  { background:#ffebee; color:#c62828; border-color:#ffcdd2; }
    .status-pill-ä¼‘æ—¥  { background:#ede7f6; color:#5e35b1; border-color:#d1c4e9; }

    .day-card-status-æœª    { border-color:#e4e5f0; background:#fbfbfe; }
    .day-card-status-å‡ºç¤¾  { border-color:#8ab4ff; background:#eaf3ff; }
    .day-card-status-åœ¨å®…  { border-color:#7bc47f; background:#e9f7ec; }
    .day-card-status-ä¼‘ã¿  { border-color:#ffb74d; background:#fff5e3; }
    .day-card-status-ç¥æ—¥  { border-color:#ef5350; background:#ffebee; }
    .day-card-status-ä¼‘æ—¥  { border-color:#b39ddb; background:#f3e5f5; }

    .dropdown-icon { font-size: 9px; padding-left: 3px; opacity:.7; }
    .memo-dot { font-size:11px; color:#ff9800; margin-left:3px; user-select:none; }
    .today-ring { box-shadow: 0 0 0 2px var(--accent-blue); }
    .selected-day { box-shadow: 0 0 0 2px var(--accent-blue); }
    .subline {
      font-size: 10px; color:#6b7280; line-height:1.2;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      user-select:none;
    }
    .holiday-name {
      font-size: 10px; color:#c62828; line-height:1.2;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      user-select:none;
    }
    .cell-actions {
      position:absolute; right:5px; bottom:5px;
      display:flex; gap:5px; z-index:2;
    }
    .mini-btn {
      border:1px solid rgba(0,0,0,0.08);
      background:rgba(255,255,255,0.9);
      backdrop-filter:blur(6px);
      -webkit-backdrop-filter:blur(6px);
      padding:3px 7px;
      border-radius:999px;
      font-size:10px; font-weight:900; color:#2563eb;
      cursor:pointer; user-select:none; line-height:1;
      box-shadow:0 4px 10px rgba(0,0,0,0.06);
      font-family:inherit;
    }
    .mini-btn:active { transform:scale(0.97); }
    .locked .day-card { opacity:0.55; }
    .locked .day-card { cursor:default; pointer-events:none; }

    /* ======= FOOTER ======= */
    .footer {
      margin-top: 8px;
      font-size: 10px;
      color: var(--text-muted);
      line-height: 1.4;
    }
    .legend span.badge {
      padding:2px 6px; border-radius:6px;
      margin-right:3px; font-weight:700; display:inline-block;
    }
    .badge-work   { background:#e3f2fd; color:#1565c0; }
    .badge-home   { background:#e8f5e9; color:#2e7d32; }
    .badge-holiday{ background:#fff8e1; color:#ef6c00; }
    .badge-shuku  { background:#ffebee; color:#c62828; }
    .badge-kyujitsu{ background:#ede7f6; color:#5e35b1; }

    .data-actions {
      margin-top: 8px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .data-btn {
      padding: 7px 13px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.7);
      background: rgba(255,255,255,0.65);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      cursor: pointer;
      user-select: none;
      font-weight: 700;
      font-family: inherit;
      color: var(--text-main);
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .data-btn:active { transform: scale(0.96); }

    /* ======= MODAL ======= */
    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 999;
    }
    .modal-backdrop.show { display: flex; }
    .modal-sheet {
      width: 100%;
      max-width: 560px;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(28px) saturate(1.4);
      -webkit-backdrop-filter: blur(28px) saturate(1.4);
      border-radius: 26px 26px 0 0;
      border-top: 1px solid rgba(255,255,255,0.8);
      padding: 12px 16px calc(max(var(--safe-bottom), 14px));
      box-shadow: 0 -8px 36px rgba(60,80,200,0.13);
    }
    .modal-handle {
      width: 34px; height: 4px;
      border-radius: 999px; background: #d0d0d5;
      margin: 0 auto 10px;
    }
    .modal-header {
      display: flex; align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 13px; font-weight: 800;
    }
    .modal-close {
      font-size: 22px; line-height:1;
      cursor:pointer; color:var(--text-muted); user-select:none;
    }
    .modal-section-title {
      font-size:11px; color:var(--text-muted);
      margin-bottom:5px; font-weight:700;
    }
    .status-chip-row { display:flex; gap:5px; margin-bottom:10px; flex-wrap:wrap; }
    .status-chip {
      flex:1; min-width:56px;
      border-radius:999px; padding:8px 6px;
      font-size:12px; text-align:center;
      border:1px solid var(--border-soft);
      background:#f6f7fb;
      cursor:pointer; user-select:none; font-weight:700;
      font-family:inherit;
    }
    .status-chip.active {
      border-color:var(--accent-blue);
      background:#e3edff; color:var(--accent-blue);
    }
    .row-time { display:flex; gap:8px; align-items:center; margin-bottom:10px; }
    .time-input {
      flex:1; padding:10px 10px;
      border-radius:12px; border:1px solid var(--border-soft);
      font-size:14px; font-family:inherit; background:#fff;
    }
    .memo-textarea {
      width:100%; min-height:80px; resize:vertical;
      border-radius:12px; border:1px solid var(--border-soft);
      padding:10px; font-size:13px; font-family:inherit;
    }
    .dup-row { display:flex; gap:8px; margin:4px 0 10px; }
    .dup-row .btn-secondary { flex:1; }
    .obs-row { display:flex; gap:8px; margin:6px 0 4px; }
    .obs-row .btn-secondary { flex:1; }
    .modal-footer {
      margin-top:10px; display:flex;
      justify-content:flex-end; gap:10px;
    }
    .btn-secondary {
      padding:10px 14px; font-size:13px;
      border-radius:999px; border:1px solid var(--border-soft);
      background:#f4f5f9; cursor:pointer; user-select:none;
      font-weight:700; font-family:inherit;
    }
    .btn-primary {
      padding:10px 20px; font-size:13px;
      border-radius:999px; border:none;
      background:linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
      color:#fff;
      font-weight:900; cursor:pointer; user-select:none;
      font-family:inherit;
      box-shadow: 0 4px 14px rgba(79,141,253,0.38);
    }
    .btn-primary:active { transform: scale(0.97); }

    /* ======= SETTINGS MODAL ======= */
    .settings-body { display:flex; flex-direction:column; gap:12px; }
    .settings-row { display:flex; flex-direction:column; gap:5px; }
    .settings-label { font-size:12px; font-weight:700; color:var(--text-muted); }
    .settings-input {
      padding:10px; border-radius:12px;
      border:1px solid var(--border-soft);
      font-size:14px; font-family:inherit; background:#fff;
    }
    .settings-hint { font-size:11px; color:var(--text-muted); line-height:1.4; }

    /* ======= OVERLAY / SPINNER ======= */
    .overlay {
      position:absolute; inset:0;
      background:rgba(255,255,255,0.65);
      display:none; align-items:center; justify-content:center;
      z-index:50;
      backdrop-filter:blur(2px); -webkit-backdrop-filter:blur(2px);
    }
    .overlay.show { display:flex; }
    .spinner {
      width:28px; height:28px; border-radius:999px;
      border:3px solid rgba(79,141,253,0.25);
      border-top-color:rgba(79,141,253,1);
      animation:spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* ======= TOAST ======= */
    .toast {
      position:fixed; left:50%; bottom:calc(max(var(--safe-bottom), 20px) + 4px);
      transform:translateX(-50%);
      background:rgba(0,0,0,0.78); color:#fff;
      padding:10px 14px; border-radius:999px;
      font-size:12px; font-weight:700;
      z-index:2000; display:none;
      max-width:92vw; white-space:nowrap;
      overflow:hidden; text-overflow:ellipsis;
    }
    .toast.show { display:block; }

    /* ======= PROGRESS OVERLAY ======= */
    .progress-overlay {
      position:fixed; inset:0; z-index:3000;
      background:rgba(0,0,0,0.55);
      display:none; align-items:center; justify-content:center;
    }
    .progress-overlay.show { display:flex; }
    .progress-box {
      background:var(--bg-card); border-radius:18px;
      padding:24px 28px; min-width:260px; max-width:90vw;
      box-shadow:0 8px 32px rgba(0,0,0,0.25);
      display:flex; flex-direction:column; gap:14px; align-items:center;
    }
    .progress-title { font-size:15px; font-weight:800; color:var(--text-main); }
    .progress-step  { font-size:13px; color:var(--text-muted); text-align:center; line-height:1.6; }
    .progress-bar-wrap {
      width:100%; height:8px; background:var(--border-color);
      border-radius:999px; overflow:hidden;
    }
    .progress-bar-fill {
      height:100%; background:var(--accent-blue);
      border-radius:999px;
      transition:width 0.3s ease;
      width:0%;
    }
    .progress-spinner {
      width:32px; height:32px;
      border:3px solid var(--border-color);
      border-top-color:var(--accent-blue);
      border-radius:50%;
      animation:spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* ======= NETWORK STATUS BANNER ======= */
    .net-banner {
      position: fixed; top: calc(max(var(--safe-top), 0px));
      left: 0; right: 0; z-index: 4000;
      background: rgba(30,30,30,0.92);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      color: #fff; font-size: 13px; font-weight: 700;
      padding: 10px 16px; text-align: center;
      transform: translateY(-100%);
      transition: transform 0.35s cubic-bezier(0.4,0,0.2,1);
    }
    .net-banner.show  { transform: translateY(0); }
    .net-banner.online  { background: rgba(34,136,56,0.92); }
    .net-banner.offline { background: rgba(180,30,30,0.92); }

    /* ======= INSTALL BANNER ======= */
    .install-banner {
      background:#eef3ff; border:1px solid #c5d2ff;
      border-radius:14px; padding:10px 14px;
      margin-bottom:10px; font-size:12px;
      color:#1565c0; line-height:1.5;
      display:none;
    }
    .install-banner.show { display:block; }
    .install-banner strong { font-weight:800; }
    .install-close {
      float:right; cursor:pointer;
      font-size:18px; line-height:1; color:#1565c0;
      margin-left:8px;
    }

    /* ======= BACKUP BANNER ======= */
    .backup-banner {
      background:#fff8e1; border:1px solid #ffe0b2;
      border-radius:14px; padding:10px 14px;
      margin-bottom:10px; font-size:12px;
      color:#e65100; line-height:1.5; display:none;
    }
    .backup-banner.show { display:block; }
    .backup-banner-row {
      display:flex; align-items:center;
      justify-content:space-between; gap:8px;
    }
    .backup-banner-text { flex:1; }
    .backup-banner strong { font-weight:800; }
    .backup-now-btn {
      padding:7px 14px; font-size:12px; font-weight:800;
      border-radius:999px; border:none;
      background:#f57c00; color:#fff;
      cursor:pointer; white-space:nowrap;
      font-family:inherit;
    }
    .backup-dismiss {
      cursor:pointer; font-size:16px; opacity:.6;
      margin-left:4px; user-select:none;
    }

    /* ======= STATS BAR ======= */
    .stats-bar {
      display:flex; gap:5px; flex-wrap:wrap;
      padding:6px 0 8px;
      margin-bottom:4px;
    }
    .stat-chip {
      display:inline-flex; align-items:center; gap:4px;
      padding:4px 11px; border-radius:999px;
      font-size:11px; font-weight:700;
      border:1px solid rgba(255,255,255,0.65);
      box-shadow:0 1px 4px rgba(0,0,0,0.06);
    }
    .stat-chip b { font-size:13px; }
    .stat-office  { background:rgba(227,242,253,0.92); color:#1565c0; border-color:#bbdefb; }
    .stat-home    { background:rgba(232,245,233,0.92); color:#2e7d32; border-color:#c8e6c9; }
    .stat-off     { background:rgba(255,248,225,0.92); color:#ef6c00; border-color:#ffe0b2; }
    .stat-hours   { background:rgba(243,229,245,0.92); color:#6a1b9a; border-color:#e1bee7; }
    .stat-weekly-toggle {
      background:rgba(237,231,246,0.92); color:#5e35b1; border-color:#d1c4e9;
      cursor:pointer; font-family:inherit;
      transition:background 0.15s;
    }
    .stat-weekly-toggle:active { background:rgba(220,208,240,1); transform:scale(0.97); }

    /* ======= WEEKLY STATS (æŠ˜ã‚ŠãŸãŸã¿) ======= */
    .weekly-stats {
      font-size: 12px;
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.38s cubic-bezier(0.4,0,0.2,1), padding 0.2s;
      padding: 0;
    }
    .weekly-stats.open {
      max-height: 320px;
      padding: 8px 0 4px;
      border-top: 1px solid var(--border-soft);
      margin-bottom: 4px;
    }
    .weekly-stats table {
      width: 100%;
      border-collapse: collapse;
    }
    .weekly-stats td {
      padding: 4px 4px;
      vertical-align: middle;
    }
    .weekly-stats .w-label { color: var(--text-muted); min-width: 112px; font-size:11px; }
    .weekly-stats .w-hours { font-weight: 700; min-width: 60px; color: var(--text-main); }
    .weekly-stats .w-pm    { color: var(--accent-purple); font-weight: 800; text-align: right; white-space:nowrap; }
    .weekly-stats .w-bar-cell { width: 100%; padding-left: 8px; }
    .w-bar-bg  { background: rgba(124,95,230,0.12); border-radius: 4px; height: 7px; overflow: hidden; }
    .w-bar-fill{ background: linear-gradient(90deg,#7c5fe6,#a78bfa); height: 100%; border-radius: 4px; transition: width .45s ease; }

    /* ======= TASK FAB ======= */
    .fab-task {
      position:fixed;
      right: calc(max(env(safe-area-inset-right), 16px) + 62px);
      bottom: calc(max(env(safe-area-inset-bottom), 0px) + var(--tab-bar-h) + 20px);
      width:52px; height:52px;
      border-radius:999px;
      background:linear-gradient(135deg,#ff9800,#f06000);
      color:#fff; font-size:22px;
      border:none; cursor:pointer;
      box-shadow:0 4px 18px rgba(255,140,0,0.52);
      display:flex; align-items:center; justify-content:center;
      z-index:900;
      font-family:inherit;
      transition:opacity 0.2s, transform 0.15s;
    }
    .fab-task:active { transform:scale(0.93); }
    .fab-task.hidden { opacity:0; pointer-events:none; }

    /* ======= TASK MODAL ======= */
    .task-add-form { padding:12px 16px 4px; display:flex; flex-direction:column; gap:8px; }
    .task-add-input { padding:8px 10px; border:1.5px solid var(--border-color); border-radius:8px; font-size:15px; font-family:inherit; background:var(--bg-card); color:var(--text-main); outline:none; }
    .task-add-input:focus { border-color:var(--accent-blue); }
    .task-add-textarea { height:60px; resize:none; }
    .task-add-submit { background:var(--accent-blue); color:#fff; border:none; border-radius:8px; padding:9px; font-size:15px; font-weight:700; cursor:pointer; font-family:inherit; }
    .task-section-title { font-size:11px; font-weight:700; color:var(--text-muted); padding:8px 16px 2px; text-transform:uppercase; letter-spacing:.05em; }
    .task-list { padding:0 16px; }
    .task-item { display:flex; align-items:flex-start; gap:10px; padding:10px 0; border-bottom:1px solid var(--border-color); }
    .task-item:last-child { border-bottom:none; }
    .task-check { width:20px; height:20px; flex-shrink:0; margin-top:2px; cursor:pointer; accent-color:var(--accent-blue); }
    .task-body { flex:1; min-width:0; }
    .task-title { font-size:15px; font-weight:700; word-break:break-all; }
    .task-memo { font-size:12px; color:var(--text-muted); margin-top:3px; white-space:pre-wrap; word-break:break-all; }
    .task-item.done .task-title { text-decoration:line-through; opacity:0.5; }
    .task-item.done .task-memo { opacity:0.4; }
    .task-del { background:none; border:none; color:#e57373; font-size:18px; cursor:pointer; padding:0 4px; align-self:center; line-height:1; }
    .task-empty { text-align:center; color:var(--text-muted); padding:24px 0; font-size:14px; line-height:1.8; }

    /* ======= FLOATING TODAY BUTTON ======= */
    .fab-today {
      position:fixed;
      right: calc(max(env(safe-area-inset-right), 16px));
      bottom: calc(max(env(safe-area-inset-bottom), 0px) + var(--tab-bar-h) + 20px);
      width:52px; height:52px;
      border-radius:999px;
      background:linear-gradient(135deg,#4f8dfd,#7c5fe6);
      color:#fff; font-size:11px; font-weight:900;
      border:none; cursor:pointer;
      box-shadow:0 4px 18px rgba(79,141,253,0.52);
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      gap:1px; z-index:900;
      font-family:inherit;
      transition:opacity 0.2s, transform 0.15s;
    }
    .fab-today:active { transform:scale(0.93); }
    .fab-today .fab-day { font-size:18px; font-weight:900; line-height:1; }
    .fab-today .fab-label { font-size:9px; opacity:.85; }
    .fab-today.hidden { opacity:0; pointer-events:none; }

    /* ======= BOTTOM TAB NAVIGATION ======= */
    .bottom-tabs {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 800;
      background: rgba(255,255,255,0.94);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid rgba(180,190,220,0.35);
      display: flex;
      padding-bottom: env(safe-area-inset-bottom, 0);
      box-shadow: 0 -2px 20px rgba(60,80,200,0.08);
    }
    .tab-btn {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      padding: 8px 2px 6px; font-size: 9px; font-weight: 700;
      color: var(--text-muted); border: none; background: none;
      cursor: pointer; font-family: inherit; gap: 2px;
      transition: color 0.15s;
      -webkit-tap-highlight-color: transparent;
    }
    .tab-btn.active { color: var(--accent-blue); }
    .tab-icon { font-size: 20px; line-height: 1; }

    /* ======= TAB PAGES ======= */
    .tab-page { display: none; }
    .tab-page.active { display: block; }

    /* ======= HUB / LAUNCHER ======= */
    .jinjer-card {
      display: flex; align-items: center; gap: 14px;
      background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
      border-radius: 20px; padding: 18px 20px;
      color: #fff; cursor: pointer; text-decoration: none;
      box-shadow: 0 6px 28px rgba(21,101,192,0.38);
      margin-bottom: 12px; user-select: none;
      -webkit-tap-highlight-color: transparent;
      transition: transform 0.15s, opacity 0.15s;
    }
    .jinjer-card:active { transform: scale(0.98); opacity: 0.9; }
    .jinjer-icon { font-size: 38px; }
    .jinjer-info { flex: 1; }
    .jinjer-label { font-size: 18px; font-weight: 900; }
    .jinjer-sub   { font-size: 12px; opacity: 0.82; margin-top: 3px; }
    .jinjer-arrow { font-size: 22px; opacity: 0.7; }
    .links-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(76px, 1fr));
      gap: 10px; margin-bottom: 12px;
    }
    .link-tile-wrap { position: relative; }
    .link-tile {
      display: flex; flex-direction: column; align-items: center;
      gap: 6px; padding: 12px 6px;
      background: var(--bg-card); border-radius: 16px;
      border: 1px solid var(--border-soft);
      cursor: pointer; text-decoration: none;
      font-size: 11px; font-weight: 700; color: var(--text-main);
      text-align: center; width: 100%;
      -webkit-tap-highlight-color: transparent;
      transition: transform 0.12s;
    }
    .link-tile:active { transform: scale(0.94); }
    .link-tile-icon { font-size: 26px; }
    .link-tile-add {
      border: 1.5px dashed rgba(180,190,220,0.7);
      background: rgba(255,255,255,0.4); color: var(--text-muted); border: none;
    }
    .link-tile-del {
      position: absolute; top: 3px; right: 3px; font-size: 16px;
      color: #e57373; line-height: 1; cursor: pointer; z-index: 2;
      background: rgba(255,255,255,0.9); border-radius: 50%;
      width: 18px; height: 18px; display: flex; align-items: center; justify-content: center;
      font-size: 12px; font-weight: 900;
    }

    /* ======= STUDY TRACKER ======= */
    .study-item {
      background: var(--bg-card-solid); border-radius: 16px;
      border: 1px solid var(--border-soft);
      padding: 14px 14px 12px; margin-bottom: 10px;
    }
    .study-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .study-color-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
    .study-name { font-size: 15px; font-weight: 800; flex: 1; }
    .study-countdown {
      font-size: 10px; font-weight: 800; padding: 2px 8px;
      border-radius: 999px; white-space: nowrap;
    }
    .study-progress-wrap {
      height: 8px; background: #f0f0f5; border-radius: 999px;
      overflow: hidden; margin-bottom: 6px;
    }
    .study-progress-fill { height: 100%; border-radius: 999px; transition: width 0.4s ease; }
    .study-stats { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted); }
    .study-today { display: flex; align-items: center; gap: 8px; margin-top: 10px; }
    .study-hours-input {
      width: 72px; padding: 6px 8px; border-radius: 8px;
      border: 1px solid var(--border-soft); font-size: 14px;
      font-family: inherit; text-align: center;
    }
    .study-add-btn {
      flex: 1; padding: 7px; border: none; border-radius: 8px;
      background: var(--accent-blue); color: #fff; font-weight: 700;
      font-size: 12px; cursor: pointer; font-family: inherit;
    }
    .study-del-btn { background: none; border: none; color: #e57373; font-size: 16px; cursor: pointer; padding: 0 4px; }

    /* ======= PROJECT TRACKER ======= */
    .project-item {
      background: var(--bg-card-solid); border-radius: 16px;
      border: 1px solid var(--border-soft);
      padding: 12px 14px; margin-bottom: 8px;
    }
    .project-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .project-status-badge { font-size: 10px; font-weight: 800; padding: 2px 8px; border-radius: 999px; }
    .project-status-æœªç€æ‰‹ { background: #f4f4f6; color: var(--text-muted); }
    .project-status-é€²è¡Œä¸­ { background: #e3f2fd; color: #1565c0; }
    .project-status-å®Œäº†   { background: #e8f5e9; color: #2e7d32; }
    .project-status-ä¿ç•™   { background: #fff8e1; color: #ef6c00; }
    .project-name { font-size: 14px; font-weight: 800; flex: 1; min-width: 0; word-break: break-all; }
    .project-progress-wrap {
      height: 6px; background: #f0f0f5; border-radius: 999px;
      overflow: hidden; margin-bottom: 6px;
    }
    .project-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
      border-radius: 999px; transition: width 0.4s;
    }
    .project-footer { display: flex; justify-content: space-between; align-items: center; font-size: 11px; color: var(--text-muted); gap: 8px; flex-wrap: wrap; }
    .project-del-btn { background: none; border: none; color: #e57373; font-size: 15px; cursor: pointer; padding: 0; flex-shrink: 0; }

    /* ======= PIN MODAL ======= */
    .pin-modal-body { padding: 4px 0 8px; text-align: center; }
    .pin-purpose { font-size: 13px; color: var(--text-muted); margin-bottom: 16px; line-height: 1.5; }
    .pin-dots { display: flex; justify-content: center; gap: 14px; margin-bottom: 16px; }
    .pin-dot {
      width: 16px; height: 16px; border-radius: 50%;
      border: 2px solid #ccc; background: transparent; transition: all 0.15s;
    }
    .pin-dot.filled { background: var(--accent-blue); border-color: var(--accent-blue); }
    .pin-error-msg { font-size: 12px; color: #c62828; min-height: 18px; margin-bottom: 12px; font-weight: 700; }
    .pin-keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 260px; margin: 0 auto; }
    .pin-key {
      padding: 16px; font-size: 20px; font-weight: 700;
      border: 1px solid var(--border-soft); border-radius: 14px;
      background: rgba(255,255,255,0.9); cursor: pointer;
      font-family: inherit; color: var(--text-main);
      -webkit-tap-highlight-color: transparent; transition: background 0.1s;
    }
    .pin-key:active { background: #e8efff; transform: scale(0.96); }
    .pin-key-sm { font-size: 13px; color: var(--text-muted); }
    .pin-lock-msg { font-size: 12px; color: #c62828; margin-top: 12px; font-weight: 700; min-height: 18px; }

    /* ======= HEALTH INDICATOR ======= */
    .health-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,0.5);
      border: 1px solid rgba(180,190,220,0.3);
      font-size: 11px;
      color: var(--text-muted);
      flex-wrap: wrap;
    }
    .health-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      display: inline-block;
      flex-shrink: 0;
    }
    .health-dot-ok     { background: #4caf50; box-shadow: 0 0 4px rgba(76,175,80,0.6); }
    .health-dot-warn   { background: #ff9800; box-shadow: 0 0 4px rgba(255,152,0,0.6); }
    .health-dot-error  { background: #f44336; box-shadow: 0 0 4px rgba(244,67,54,0.6); }
    .health-item { display: flex; align-items: center; gap: 4px; }

    /* ======= EMERGENCY FAB ======= */
    .fab-recover {
      position: fixed;
      left: calc(max(env(safe-area-inset-left), 16px));
      bottom: calc(max(env(safe-area-inset-bottom), 0px) + var(--tab-bar-h) + 20px);
      width: 52px; height: 52px;
      border-radius: 999px;
      background: linear-gradient(135deg, #f44336, #b71c1c);
      color: #fff; font-size: 20px;
      border: none; cursor: pointer;
      box-shadow: 0 4px 18px rgba(244,67,54,0.55);
      display: flex; align-items: center; justify-content: center;
      z-index: 900;
      font-family: inherit;
      transition: opacity 0.2s, transform 0.15s;
    }
    .fab-recover:active { transform: scale(0.93); }
    .fab-recover.hidden { opacity: 0; pointer-events: none; }

    /* ======= EMERGENCY MODAL ======= */
    .emergency-modal-body {
      display: flex; flex-direction: column; gap: 8px;
    }
    .emergency-section-title {
      font-size: 11px; font-weight: 700; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: .06em;
      margin-top: 4px;
    }
    .emergency-btn {
      display: block; width: 100%;
      padding: 12px 14px;
      border-radius: 12px; border: none;
      font-size: 14px; font-weight: 700;
      cursor: pointer; text-align: left;
      font-family: inherit;
      transition: opacity 0.15s;
    }
    .emergency-btn:active { opacity: 0.8; }
    .emergency-btn-safe   { background: #e3f2fd; color: #1565c0; }
    .emergency-btn-warn   { background: #fff8e1; color: #e65100; }
    .emergency-btn-danger { background: #ffebee; color: #c62828; }
    .emergency-btn-link   { background: #f4f5f9; color: var(--text-main); }
    .emergency-diag {
      background: #f4f5f9; border-radius: 10px;
      padding: 10px 12px; font-size: 11px;
      color: var(--text-muted); line-height: 1.8;
      font-family: monospace;
    }
  </style>
</head>

<body>
  <!-- Network status banner -->
  <div class="net-banner" id="net-banner" role="status" aria-live="polite"></div>

  <!-- Install banner (iOS) -->
  <div class="install-banner" id="install-banner">
    <span class="install-close" id="install-close">Ã—</span>
    <strong>ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ã‚¢ãƒ—ãƒªã¨ã—ã¦ä½¿ã†</strong><br>
    Safari ã® <strong>å…±æœ‰ãƒœã‚¿ãƒ³ï¼ˆâ†‘ï¼‰â†’ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€</strong> ã‚’ã‚¿ãƒƒãƒ—
  </div>

  <!-- Auto-backup reminder banner -->
  <div class="backup-banner" id="backup-banner">
    <div class="backup-banner-row">
      <div class="backup-banner-text">
        <strong>âš ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ãŠå‹§ã‚ã—ã¾ã™</strong><br>
        <span id="backup-days-msg">å‰å›ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰7æ—¥ä»¥ä¸ŠçµŒéã—ã¦ã„ã¾ã™</span>
      </div>
      <button class="backup-now-btn" id="btn-backup-now">ä¸€æ‹¬ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
      <span class="backup-dismiss" id="backup-dismiss">Ã—</span>
    </div>
  </div>

  <!-- ===== TAB: å‹¤æ€ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ===== -->
  <div id="page-calendar" class="tab-page active">
  <div class="card" id="calendar-card">
    <div class="overlay" id="overlay"><div class="spinner"></div></div>

    <div class="card-title">å‹¤æ€ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆãƒ¡ãƒ¢ä»˜ãï¼‰</div>

    <!-- Monthly stats bar -->
    <div class="stats-bar" id="stats-bar">
      <span class="stat-chip stat-office">å‡ºç¤¾ <b id="stat-office">0</b>æ—¥</span>
      <span class="stat-chip stat-home">åœ¨å®… <b id="stat-home">0</b>æ—¥</span>
      <span class="stat-chip stat-off">ä¼‘æš‡ <b id="stat-off">0</b>æ—¥</span>
      <span class="stat-chip stat-hours">å‹¤å‹™ <b id="stat-hours">0h</b></span>
      <button class="stat-chip stat-weekly-toggle" id="weekly-toggle">é€±æ¬¡äººæœˆ <span id="weekly-arrow">â–¾</span></button>
    </div>
    <!-- Weekly person-month breakdown (æŠ˜ã‚ŠãŸãŸã¿) -->
    <div class="weekly-stats" id="weekly-stats"></div>

    <div class="header-bar">
      <div class="header-left">
        <button class="nav-arrow" id="prev-month">â€¹</button>
        <button class="pill-button pill-button-primary" id="today-button">ä»Šæ—¥</button>
      </div>
      <div class="month-label" id="month-label">----</div>
      <div class="header-right">
        <button class="pill-button" id="lock-toggle">
          <span class="icon">ğŸ”’</span><span id="lock-label">ãƒ­ãƒƒã‚¯</span>
        </button>
        <button class="nav-arrow" id="next-month">â€º</button>
      </div>
    </div>

    <div class="calendar-wrapper">
      <table class="calendar">
        <thead>
          <tr>
            <th>æ—¥</th><th>æœˆ</th><th>ç«</th><th>æ°´</th><th>æœ¨</th><th>é‡‘</th><th>åœŸ</th>
          </tr>
        </thead>
        <tbody id="calendar-body"></tbody>
      </table>
    </div>

    <div class="footer">
      <div class="legend">
        ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼š
        <span class="badge badge-work">å‡º</span>
        <span class="badge badge-home">åœ¨</span>
        <span class="badge badge-kyujitsu">ä¼‘æ—¥</span>
        <span class="badge badge-holiday">ä¼‘ã¿</span>
        <span class="badge badge-shuku">ç¥æ—¥</span><br>
        æ—¥æ›œâ†’ä¼‘æ—¥ / åœŸæ›œâ†’ä¼‘ã¿ / ç¥æ—¥ã¯è‡ªå‹•åˆ¤å®šã€‚ãƒ¡ãƒ¢ã‚ã‚Šï¼<span style="color:#ff9800;font-weight:800;">â—</span>
      </div>
      <div class="data-actions">
        <button class="data-btn" id="btn-xlsx">ğŸ“Š xlsxæ›¸ãå‡ºã—</button>
        <button class="data-btn" id="btn-export">ğŸ’¾ JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
        <button class="data-btn" id="btn-import">ğŸ“¥ JSONèª­ã¿è¾¼ã¿</button>
        <button class="data-btn" id="btn-migrate">ğŸ”„ iSHç‰ˆã‚’å–ã‚Šè¾¼ã‚€</button>
        <button class="data-btn" id="btn-jinjer">ğŸ¢ jinjeråŒæœŸ</button>
        <button class="data-btn" id="btn-settings">âš™ï¸ è¨­å®š</button>
        <button class="data-btn" id="btn-recover" style="color:#c62828;border-color:#ffcdd2;background:rgba(255,235,238,0.7);">ğŸš¨ ç·Šæ€¥å¾©æ—§</button>
      </div>
      <!-- Health status bar -->
      <div class="health-bar" id="health-bar">
        <span class="health-item"><span class="health-dot" id="health-dot-ls"></span><span id="health-ls">LS: --</span></span>
        <span class="health-item"><span class="health-dot" id="health-dot-idb"></span><span id="health-idb">IDB: --</span></span>
        <span class="health-item"><span class="health-dot" id="health-dot-err"></span><span id="health-err">ã‚¨ãƒ©ãƒ¼: --</span></span>
        <span style="flex:1"></span>
        <span id="health-snap" style="font-size:10px;"></span>
      </div>
      <input type="file" id="file-import"  accept=".json" style="display:none">
      <input type="file" id="file-jinjer" accept=".json" style="display:none">
    </div>
  </div>
  </div><!-- /page-calendar -->

  <!-- ===== TAB: ãƒãƒ– / ã‚¯ã‚¤ãƒƒã‚¯ãƒ©ãƒ³ãƒãƒ£ãƒ¼ ===== -->
  <div id="page-hub" class="tab-page">
    <div class="card">
      <div class="card-title">ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ãƒ©ãƒ³ãƒãƒ£ãƒ¼</div>
      <!-- jinjer æ‰“åˆ»ãƒœã‚¿ãƒ³ï¼ˆå¤§ï¼‰ -->
      <a href="https://kintai.jinjer.biz/staffs/top" target="_blank" rel="noopener" class="jinjer-card" id="jinjer-link">
        <div class="jinjer-icon">ğŸ¢</div>
        <div class="jinjer-info">
          <div class="jinjer-label">jinjer æ‰“åˆ»</div>
          <div class="jinjer-sub" id="jinjer-card-sub">å‡ºå‹¤ãƒ»é€€å‹¤ã‚’è¨˜éŒ²ã™ã‚‹ â†—</div>
        </div>
        <div class="jinjer-arrow">â±</div>
      </a>
      <div id="jinjer-today-bar" style="background:#e3f2fd;border-radius:12px;padding:10px 14px;margin-bottom:10px;font-size:12px;display:none;">
        <span style="font-weight:800;color:#1565c0;">ğŸ“ ä»Šæ—¥ã®æ‰“åˆ»çŠ¶æ³</span>
        <span id="jinjer-today-status" style="margin-left:10px;"></span>
      </div>
      <div class="card-title" style="margin-top:4px;">ãƒã‚¤ã‚¢ãƒ—ãƒªãƒ»ãƒªãƒ³ã‚¯</div>
      <div class="links-grid" id="links-grid"></div>
      <div style="font-size:11px;color:var(--text-muted);line-height:1.5;margin-top:4px;">
        â• ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‚ˆãä½¿ã†ã‚µãƒ¼ãƒ“ã‚¹ã‚’è¿½åŠ ã§ãã¾ã™
      </div>
    </div>
  </div>

  <!-- ===== TAB: è³‡æ ¼ãƒ»å­¦ç¿’é€²æ— ===== -->
  <div id="page-study" class="tab-page">
    <!-- ä»Šé€±ã®å­¦ç¿’ã‚µãƒãƒªãƒ¼ -->
    <div class="card" style="margin-bottom:10px;">
      <div class="card-title">ğŸ“ˆ ä»Šé€±ã®å­¦ç¿’</div>
      <div id="study-week-summary" style="display:flex;gap:8px;flex-wrap:wrap;padding:2px 0 4px;"></div>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“š è³‡æ ¼ãƒ»å­¦ç¿’é€²æ—</div>
      <div id="study-list"></div>
      <button class="data-btn" id="btn-add-study" style="width:100%;text-align:center;margin-top:4px;">ï¼‹ è³‡æ ¼ãƒ»å­¦ç¿’ç›®æ¨™ã‚’è¿½åŠ </button>
    </div>
  </div>

  <!-- ===== TAB: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé€²æ— ===== -->
  <div id="page-project" class="tab-page">
    <div class="card" style="margin-bottom:10px;">
      <div class="card-title">ğŸ“Š ã‚µãƒãƒªãƒ¼</div>
      <div id="project-summary" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§</div>
      <div id="project-list"></div>
      <button class="data-btn" id="btn-add-project" style="width:100%;text-align:center;margin-top:4px;">ï¼‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ </button>
    </div>
  </div>

  <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-backdrop" id="memo-modal">
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div id="modal-date-label"></div>
        <div class="modal-close" id="modal-close">Ã—</div>
      </div>

      <div class="modal-section-title">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
      <div class="status-chip-row" id="status-chip-row"></div>

      <div class="modal-section-title">æ¥­å‹™æ™‚é–“ï¼ˆ1åˆ†å˜ä½ï¼‰</div>
      <div class="row-time">
        <input id="start-time" class="time-input" type="time" step="60">
        <span style="color:var(--text-muted);font-weight:800;">ã€œ</span>
        <input id="end-time" class="time-input" type="time" step="60">
      </div>

      <div class="dup-row">
        <button class="btn-secondary" id="btn-dup-prev">å‰æ—¥ã‚’è¤‡è£½</button>
        <button class="btn-secondary" id="btn-dup-last">ç›´è¿‘ã‚’è¤‡è£½</button>
      </div>

      <div class="modal-section-title">ãƒ¡ãƒ¢</div>
      <textarea id="memo-textarea" class="memo-textarea" placeholder="ã“ã®æ—¥ã®ãƒ¡ãƒ¢ã‚’å…¥åŠ›"></textarea>

      <div class="modal-section-title" style="margin-top:10px;">Obsidian</div>
      <div class="obs-row">
        <button class="btn-secondary" id="btn-obs-open">ğŸ“ Obsidianã§é–‹ã</button>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" id="modal-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn-primary" id="modal-save">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- PIN èªè¨¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-backdrop" id="pin-modal">
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div>ğŸ” PIN èªè¨¼</div>
        <div class="modal-close" id="pin-modal-cancel">Ã—</div>
      </div>
      <div class="pin-modal-body">
        <div class="pin-purpose" id="pin-purpose">ã“ã®æ“ä½œã«ã¯PINãŒå¿…è¦ã§ã™</div>
        <div class="pin-dots" id="pin-dots">
          <div class="pin-dot"></div>
          <div class="pin-dot"></div>
          <div class="pin-dot"></div>
          <div class="pin-dot"></div>
        </div>
        <div class="pin-error-msg" id="pin-error"></div>
        <div class="pin-keypad">
          <button class="pin-key" data-key="1">1</button>
          <button class="pin-key" data-key="2">2</button>
          <button class="pin-key" data-key="3">3</button>
          <button class="pin-key" data-key="4">4</button>
          <button class="pin-key" data-key="5">5</button>
          <button class="pin-key" data-key="6">6</button>
          <button class="pin-key" data-key="7">7</button>
          <button class="pin-key" data-key="8">8</button>
          <button class="pin-key" data-key="9">9</button>
          <button class="pin-key pin-key-sm" id="pin-key-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="pin-key" data-key="0">0</button>
          <button class="pin-key pin-key-sm" id="pin-key-del">âŒ«</button>
        </div>
        <div class="pin-lock-msg" id="pin-lock-msg"></div>
      </div>
    </div>
  </div>

  <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-backdrop" id="settings-modal">
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div>è¨­å®š</div>
        <div class="modal-close" id="settings-close">Ã—</div>
      </div>
      <div class="settings-body">
        <div class="settings-row">
          <div class="settings-label">Obsidian Vault å</div>
          <input id="settings-vault" class="settings-input" type="text" placeholder="ä¾‹: MyVault">
          <div class="settings-hint">Obsidianã§é–‹ãã¨ãã«ä½¿ã†Vaultåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>
        </div>
        <div class="settings-row">
          <div class="settings-label">Obsidian ã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€</div>
          <input id="settings-subdir" class="settings-input" type="text" placeholder="ä¾‹: ã€æ¥­å‹™ã€‘/å‹¤æ€ ">
          <div class="settings-hint">Vaultã®ã©ã®ãƒ•ã‚©ãƒ«ãƒ€ã«MDãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã‹ã®ãƒ‘ã‚¹ã€‚</div>
        </div>
        <hr style="border:none;border-top:1px solid var(--border-soft);margin:4px 0;">
        <div class="settings-row">
          <div class="settings-label">ğŸ¢ jinjer æ‰“åˆ»URL</div>
          <input id="settings-jinjer-url" class="settings-input" type="url" placeholder="https://kintai.jinjer.biz/staffs/top">
          <div class="settings-hint">ãƒãƒ–ã®ã€Œjinjeræ‰“åˆ»ã€ãƒœã‚¿ãƒ³ã®é·ç§»å…ˆURLã€‚ä¼šç¤¾ã«ã‚ˆã£ã¦ã¯ç•°ãªã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã®å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</div>
        </div>
        <hr style="border:none;border-top:1px solid var(--border-soft);margin:4px 0;">
        <div class="settings-row">
          <div class="settings-label">ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£PIN</div>
          <div class="settings-hint" id="pin-status-hint" style="margin-bottom:6px;"></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn-secondary" id="btn-set-pin" style="flex:1;">PINã‚’è¨­å®š/å¤‰æ›´</button>
            <button class="btn-secondary" id="btn-clear-pin" style="flex:1;color:#c62828;display:none;">PINã‚’è§£é™¤</button>
          </div>
          <div class="settings-hint" style="margin-top:6px;">
            å±é™ºãªæ“ä½œï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿æ¶ˆå»ãªã©ï¼‰ã«PINãƒ­ãƒƒã‚¯ã‚’ã‹ã‘ã¾ã™ã€‚4ã€œ6æ¡ã®æ•°å­—ã€‚
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="settings-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn-primary" id="settings-save">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- Task modal -->
  <div class="modal-backdrop" id="task-modal">
    <div class="modal-sheet" style="max-height:85vh;overflow:hidden;display:flex;flex-direction:column;">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div>ğŸ“‹ ã‚¿ã‚¹ã‚¯</div>
        <div class="modal-close" id="task-modal-close">Ã—</div>
      </div>
      <div class="task-add-form">
        <input id="task-title-input" class="task-add-input" type="text" placeholder="ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›">
        <textarea id="task-memo-input" class="task-add-input task-add-textarea" placeholder="ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰"></textarea>
        <button class="task-add-submit" id="task-add-btn">ï¼‹ è¿½åŠ </button>
      </div>
      <div id="task-list-container" style="overflow-y:auto;flex:1;padding-bottom:16px;"></div>
    </div>
  </div>

  <!-- Emergency recovery modal -->
  <div class="modal-backdrop" id="emergency-modal">
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div style="color:#c62828;">ğŸš¨ ç·Šæ€¥å¾©æ—§</div>
        <div class="modal-close" id="emergency-modal-close">Ã—</div>
      </div>
      <div class="emergency-modal-body">
        <div class="emergency-section-title">ã‚¯ã‚¤ãƒƒã‚¯å¾©æ—§</div>
        <button class="emergency-btn emergency-btn-safe" id="em-sw-reload">ğŸ”„ Service Worker ã‚’å¼·åˆ¶æ›´æ–°</button>
        <button class="emergency-btn emergency-btn-warn" id="em-cache-clear">ğŸ—‚ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»SWã‚’ã‚¯ãƒªã‚¢ï¼ˆãƒ‡ãƒ¼ã‚¿ä¿æŒï¼‰</button>
        <button class="emergency-btn emergency-btn-warn" id="em-snap-restore">ğŸ“¦ è‡ªå‹•ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‹ã‚‰å¾©å…ƒ</button>

        <div class="emergency-section-title">å®Œå…¨ãƒªã‚»ãƒƒãƒˆ</div>
        <button class="emergency-btn emergency-btn-danger" id="em-full-reset">ğŸ—‘ å…¨ãƒ‡ãƒ¼ã‚¿æ¶ˆå»ã—ã¦ãƒªã‚»ãƒƒãƒˆ</button>
        <a href="./recover.html" class="emergency-btn emergency-btn-link" style="text-decoration:none;display:block;">ğŸ”— recover.html ã‚’é–‹ãï¼ˆè©³ç´°ï¼‰</a>

        <div class="emergency-section-title">è¨ºæ–­æƒ…å ±</div>
        <div class="emergency-diag" id="em-diag">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
  </div>

  <!-- Emergency FAB -->
  <button class="fab-recover" id="fab-recover" title="ç·Šæ€¥å¾©æ—§">ğŸš¨</button>

  <!-- Floating today button -->
  <button class="fab-today" id="fab-today">
    <span class="fab-day" id="fab-day">--</span>
    <span class="fab-label">ä»Šæ—¥</span>
  </button>

  <!-- Task FAB -->
  <button class="fab-task" id="fab-task">ğŸ“‹</button>

  <!-- Bottom Tab Navigation -->
  <nav class="bottom-tabs" id="bottom-tabs">
    <button class="tab-btn active" data-tab="calendar">
      <span class="tab-icon">ğŸ“…</span>å‹¤æ€ 
    </button>
    <button class="tab-btn" data-tab="hub">
      <span class="tab-icon">ğŸš€</span>ãƒãƒ–
    </button>
    <button class="tab-btn" data-tab="study">
      <span class="tab-icon">ğŸ“š</span>å­¦ç¿’
    </button>
    <button class="tab-btn" data-tab="project">
      <span class="tab-icon">ğŸ“Š</span>é€²æ—
    </button>
  </nav>

  <!-- Progress overlayï¼ˆjinjeråŒæœŸãƒ»é‡ã„å‡¦ç†ç”¨ï¼‰ -->
  <div class="progress-overlay" id="progress-overlay">
    <div class="progress-box">
      <div class="progress-spinner" id="progress-spinner"></div>
      <div class="progress-title" id="progress-title">å‡¦ç†ä¸­...</div>
      <div class="progress-bar-wrap">
        <div class="progress-bar-fill" id="progress-bar"></div>
      </div>
      <div class="progress-step" id="progress-step"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /* =====================================================
       HIGH-AVAILABILITY: ç·Šæ€¥ãƒªã‚»ãƒƒãƒˆ / ã‚¯ãƒ©ãƒƒã‚·ãƒ¥æ¤œå‡º / ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼æ•æ‰
       ===================================================== */

    // â‘  URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚ˆã‚‹ç·Šæ€¥ãƒªã‚»ãƒƒãƒˆ (?reset)
    if (location.search.includes('reset')) {
      (async () => {
        try { const r = await navigator.serviceWorker.getRegistrations(); for(const s of r) await s.unregister(); } catch(_){}
        try { const k = await caches.keys(); await Promise.all(k.map(c => caches.delete(c))); } catch(_){}
        try { localStorage.clear(); } catch(_){}
        try { indexedDB.deleteDatabase('kintai_idb'); } catch(_){}
        location.replace(location.pathname); // ?reset ã‚’é™¤ã„ã¦ãƒªãƒ­ãƒ¼ãƒ‰
      })();
    }

    // â‘¡ ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ãƒ«ãƒ¼ãƒ—æ¤œå‡ºï¼ˆ3å›é€£ç¶šã§ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ãŸã‚‰å¾©æ—§UIã‚’è¡¨ç¤ºï¼‰
    //    sessionStorage ã¯iOSãŒãƒ—ãƒ­ã‚»ã‚¹ã‚’killã™ã‚‹ã¨æ¶ˆãˆã‚‹ãŸã‚ localStorage ã‚’ä½¿ã†
    const _CRASH_KEY = '_kintai_crash';
    const _crashes   = Number(localStorage.getItem(_CRASH_KEY) || 0);
    localStorage.setItem(_CRASH_KEY, _crashes + 1);
    window.addEventListener('load', () => localStorage.setItem(_CRASH_KEY, '0'));

    if (_crashes >= 3) {
      document.addEventListener('DOMContentLoaded', () => {
        document.body.innerHTML = `
          <div style="font-family:-apple-system,sans-serif;max-width:360px;margin:60px auto;padding:24px;
               background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(0,0,0,0.12);text-align:center;">
            <div style="font-size:40px;">ğŸš¨</div>
            <h2 style="margin:8px 0 6px;font-size:18px;">ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã‚’ç¹°ã‚Šè¿”ã—ã¦ã„ã¾ã™</h2>
            <p style="font-size:13px;color:#666;line-height:1.6;margin:0 0 20px">
              ãƒ‡ãƒ¼ã‚¿ãŒç ´æã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚<br>å¾©æ—§ãƒšãƒ¼ã‚¸ã§ä¿®å¾©ã—ã¦ãã ã•ã„ã€‚
            </p>
            <a href="./recover.html" style="display:block;background:#4f8dfd;color:#fff;
               padding:13px;border-radius:12px;text-decoration:none;font-weight:700;font-size:15px;
               margin-bottom:10px;">ğŸ›  å¾©æ—§ãƒšãƒ¼ã‚¸ã¸</a>
            <button onclick="localStorage.setItem('${_CRASH_KEY}','0');location.reload()"
              style="width:100%;background:#fff;border:1.5px solid #ddd;color:#555;
              padding:11px;border-radius:12px;font-size:14px;cursor:pointer;font-family:inherit;">
              âš¡ ã“ã®ã¾ã¾èµ·å‹•ã‚’å†è©¦è¡Œ
            </button>
          </div>`;
      });
      throw new Error('RECOVERY_MODE'); // ä»¥é™ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä¸€åˆ‡å®Ÿè¡Œã—ãªã„
    }

    // â‘¢ ã‚¨ãƒ©ãƒ¼ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªï¼ˆãƒ­ãƒ¼ã‚«ãƒ« ring buffer â€” æœ€æ–°20ä»¶ã‚’localStorageã«ä¿å­˜ï¼‰
    const _ERR_KEY  = '_kintai_errors';
    const _ERR_MAX  = 20;
    function _logError(type, detail) {
      try {
        const log = JSON.parse(localStorage.getItem(_ERR_KEY) || '[]');
        log.unshift({ ts: new Date().toISOString(), type, detail: String(detail).slice(0, 200) });
        if (log.length > _ERR_MAX) log.length = _ERR_MAX;
        localStorage.setItem(_ERR_KEY, JSON.stringify(log));
      } catch(_) {}
    }
    window.addEventListener('error', ev => {
      console.error('[GLOBAL ERROR]', ev.message, ev.filename, ev.lineno);
      _logError('js_error', `${ev.message} @ ${ev.filename}:${ev.lineno}`);
    });
    window.addEventListener('unhandledrejection', ev => {
      console.error('[UNHANDLED REJECTION]', ev.reason);
      _logError('unhandled_rejection', ev.reason);
      ev.preventDefault(); // iOS Safari ã®å¼·åˆ¶ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã‚’æŠ‘åˆ¶
    });

    /* =====================================================
       HA: è‡ªå‹•ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼ˆ3ä¸–ä»£ãƒ­ãƒ¼ãƒªãƒ³ã‚°ä¿å­˜ï¼‰
       ===================================================== */
    const _SNAP_KEY   = '_kintai_snap_';   // _kintai_snap_0 / _1 / _2
    const _SNAP_IDX   = '_kintai_snap_idx';
    const _SNAP_GENS  = 3;

    function saveSnapshot(store) {
      try {
        const idx = (Number(localStorage.getItem(_SNAP_IDX) || 0) + 1) % _SNAP_GENS;
        const meta = { ts: new Date().toISOString(), months: Object.keys(store.months || {}).length };
        localStorage.setItem(_SNAP_KEY + idx, JSON.stringify({ meta, data: store }));
        localStorage.setItem(_SNAP_IDX, String(idx));
      } catch(_) {}
    }

    function loadLatestSnapshot() {
      try {
        const idx = Number(localStorage.getItem(_SNAP_IDX) || 0);
        for (let i = 0; i < _SNAP_GENS; i++) {
          const si = (idx - i + _SNAP_GENS) % _SNAP_GENS;
          const raw = localStorage.getItem(_SNAP_KEY + si);
          if (!raw) continue;
          const { meta, data } = JSON.parse(raw);
          if (data && data.months && Object.keys(data.months).length > 0) return { meta, data };
        }
      } catch(_) {}
      return null;
    }

    function listSnapshots() {
      const result = [];
      const idx = Number(localStorage.getItem(_SNAP_IDX) || 0);
      for (let i = 0; i < _SNAP_GENS; i++) {
        const si = (idx - i + _SNAP_GENS) % _SNAP_GENS;
        const raw = localStorage.getItem(_SNAP_KEY + si);
        if (!raw) continue;
        try {
          const { meta } = JSON.parse(raw);
          result.push({ slot: si, ...meta });
        } catch(_) {}
      }
      return result;
    }

    /* =====================================================
       HA: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ & ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
       ===================================================== */
    async function runHealthCheck() {
      // localStorage ã‚µã‚¤ã‚ºæ¨å®š
      let lsSize = 0;
      try {
        for (const k of Object.keys(localStorage)) {
          lsSize += (localStorage.getItem(k) || '').length;
        }
      } catch(_) {}

      // IDB ç¢ºèª
      let idbOk = false;
      try {
        const idbData = await idbLoad();
        idbOk = !!(idbData && Object.keys(idbData.months || {}).length > 0);
      } catch(_) {}

      // ã‚¨ãƒ©ãƒ¼æ•°
      let errCount = 0;
      try {
        errCount = JSON.parse(localStorage.getItem(_ERR_KEY) || '[]').length;
      } catch(_) {}

      // ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆæœ€æ–°æ™‚åˆ»
      const snaps = listSnapshots();
      const latestSnap = snaps.length > 0 ? snaps[0] : null;

      // UI æ›´æ–°
      const dotLS  = document.getElementById('health-dot-ls');
      const dotIDB = document.getElementById('health-dot-idb');
      const dotErr = document.getElementById('health-dot-err');
      const txtLS  = document.getElementById('health-ls');
      const txtIDB = document.getElementById('health-idb');
      const txtErr = document.getElementById('health-err');
      const txtSnap= document.getElementById('health-snap');

      if (!dotLS) return;

      const lsKB = Math.round(lsSize / 1024);
      const lsWarn = lsKB > 4000;
      dotLS.className  = 'health-dot ' + (lsWarn ? 'health-dot-warn' : 'health-dot-ok');
      txtLS.textContent = `LS: ${lsKB}KB`;

      dotIDB.className  = 'health-dot ' + (idbOk ? 'health-dot-ok' : 'health-dot-warn');
      txtIDB.textContent = `IDB: ${idbOk ? 'âœ“' : 'ç©º'}`;

      dotErr.className  = 'health-dot ' + (errCount === 0 ? 'health-dot-ok' : errCount < 5 ? 'health-dot-warn' : 'health-dot-error');
      txtErr.textContent = `ã‚¨ãƒ©ãƒ¼: ${errCount}ä»¶`;

      if (latestSnap) {
        const d = new Date(latestSnap.ts);
        const fmt = `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        txtSnap.textContent = `ã‚¹ãƒŠãƒƒãƒ—: ${fmt}`;
      } else {
        txtSnap.textContent = 'ã‚¹ãƒŠãƒƒãƒ—: ãªã—';
      }
    }

    /* =====================================================
       CONSTANTS
       ===================================================== */
    const STATUS_LIST = ["æœª", "å‡ºç¤¾", "åœ¨å®…", "ä¼‘æ—¥", "ä¼‘ã¿", "ç¥æ—¥"];
    const STORE_KEY   = 'kintai_store_v1';
    const LAST_KEY    = 'att_last_template';
    const CFG_KEY     = 'kintai_config_v1';

    /* =====================================================
       JAPANESE HOLIDAY CALCULATION
       ===================================================== */
    const _hCache = {};

    function getHolidays(year) {
      if (_hCache[year]) return _hCache[year];
      const h = {};
      const f = (m, d, name) => {
        h[`${year}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`] = name;
      };

      // Fixed
      f(1,1,'å…ƒæ—¥');
      f(2,11,'å»ºå›½è¨˜å¿µã®æ—¥');
      f(2,23,'å¤©çš‡èª•ç”Ÿæ—¥');
      f(4,29,'æ˜­å’Œã®æ—¥');
      f(5,3,'æ†²æ³•è¨˜å¿µæ—¥');
      f(5,4,'ã¿ã©ã‚Šã®æ—¥');
      f(5,5,'ã“ã©ã‚‚ã®æ—¥');
      f(8,11,'å±±ã®æ—¥');
      f(11,3,'æ–‡åŒ–ã®æ—¥');
      f(11,23,'å‹¤åŠ´æ„Ÿè¬ã®æ—¥');

      // nth weekday helper (wd: JS format 0=Sun,1=Mon,...,6=Sat)
      function nthWD(month, wd, n) {
        const d = new Date(year, month - 1, 1);
        let c = 0;
        while (true) {
          if (d.getDay() === wd && ++c === n) return d.getDate();
          d.setDate(d.getDate() + 1);
        }
      }
      f(1,  nthWD(1, 1, 2), 'æˆäººã®æ—¥');
      f(7,  nthWD(7, 1, 3), 'æµ·ã®æ—¥');
      f(9,  nthWD(9, 1, 3), 'æ•¬è€ã®æ—¥');
      f(10, nthWD(10,1, 2), 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥');

      // æ˜¥åˆ†ã®æ—¥ãƒ»ç§‹åˆ†ã®æ—¥ (è¿‘ä¼¼å¼)
      const sy = year - 1980;
      const shunbun = Math.floor(20.8431 + 0.242194 * sy - Math.floor(sy / 4));
      const shubun  = Math.floor(23.2488 + 0.242194 * sy - Math.floor(sy / 4));
      f(3, shunbun, 'æ˜¥åˆ†ã®æ—¥');
      f(9, shubun,  'ç§‹åˆ†ã®æ—¥');

      // æŒ¯æ›¿ä¼‘æ—¥: ç¥æ—¥ãŒæ—¥æ›œ â†’ ç¿Œæœˆæ›œï¼ˆé€£é–å¯¾å¿œï¼‰
      const hkeys = Object.keys(h).sort();
      for (const k of hkeys) {
        const d = new Date(k + 'T00:00:00');
        if (d.getDay() === 0) {
          let nxt = new Date(d);
          nxt.setDate(nxt.getDate() + 1);
          while (h[nxt.toISOString().slice(0, 10)]) nxt.setDate(nxt.getDate() + 1);
          h[nxt.toISOString().slice(0, 10)] = 'æŒ¯æ›¿ä¼‘æ—¥';
        }
      }

      // å›½æ°‘ã®ä¼‘æ—¥: 2ã¤ã®ç¥æ—¥ã«æŒŸã¾ã‚ŒãŸå¹³æ—¥
      const all = Object.keys(h).sort();
      for (let i = 0; i < all.length - 1; i++) {
        const d1 = new Date(all[i] + 'T00:00:00');
        const d2 = new Date(all[i + 1] + 'T00:00:00');
        if ((d2 - d1) / 86400000 === 2) {
          const mid = new Date(d1);
          mid.setDate(mid.getDate() + 1);
          const mk = mid.toISOString().slice(0, 10);
          if (!h[mk] && mid.getDay() !== 0) h[mk] = 'å›½æ°‘ã®ä¼‘æ—¥';
        }
      }

      _hCache[year] = h;
      return h;
    }

    function holidayName(dateStr) {
      return getHolidays(+dateStr.slice(0, 4))[dateStr] || null;
    }

    /* =====================================================
       CONFIG
       ===================================================== */
    function loadConfig() {
      try {
        const r = localStorage.getItem(CFG_KEY);
        return r ? JSON.parse(r) : {};
      } catch { return {}; }
    }
    function saveConfig(cfg) {
      localStorage.setItem(CFG_KEY, JSON.stringify(cfg));
    }

    /* =====================================================
       DATA STORAGE â€” IndexedDBï¼ˆä¸»ï¼‰+ localStorageï¼ˆé«˜é€Ÿã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
       æ›¸ãè¾¼ã¿: ä¸¡æ–¹ã«åŒæœŸ
       èª­ã¿è¾¼ã¿: localStorageï¼ˆé«˜é€Ÿï¼‰
       å¾©å…ƒ:     localStorage ãŒç©ºã®å ´åˆ IndexedDB ã‹ã‚‰è‡ªå‹•å¾©å…ƒ
       ===================================================== */
    const IDB_NAME    = 'kintai_idb';
    const IDB_VERSION = 1;
    const IDB_STORE   = 'attendance';

    function _openIDB() {
      return new Promise((resolve) => {
        try {
          const req = indexedDB.open(IDB_NAME, IDB_VERSION);
          req.onupgradeneeded = e => {
            e.target.result.createObjectStore(IDB_STORE, { keyPath: 'id' });
          };
          req.onsuccess = e => resolve(e.target.result);
          req.onerror   = () => resolve(null);
        } catch (_) { resolve(null); }
      });
    }

    async function idbSave(data) {
      const db = await _openIDB();
      if (!db) return;
      try {
        const tx = db.transaction(IDB_STORE, 'readwrite');
        tx.objectStore(IDB_STORE).put({ id: 'main', data, saved_at: new Date().toISOString() });
      } catch (_) {}
    }

    async function idbLoad() {
      const db = await _openIDB();
      if (!db) return null;
      return new Promise(resolve => {
        try {
          const req = db.transaction(IDB_STORE).objectStore(IDB_STORE).get('main');
          req.onsuccess = () => resolve(req.result?.data || null);
          req.onerror   = () => resolve(null);
        } catch (_) { resolve(null); }
      });
    }

    // localStorage ã‹ã‚‰èª­ã‚€ï¼ˆé«˜é€Ÿãƒ»åŒæœŸï¼‰
    function loadStore() {
      try {
        const r = localStorage.getItem(STORE_KEY);
        if (!r) return { months: {} };
        const d = JSON.parse(r);
        return (d && d.months) ? d : { months: {} };
      } catch { return { months: {} }; }
    }

    // ä¸¡æ–¹ã«æ›¸ãï¼ˆlocalStorage æ›¸ãè¾¼ã¿å¤±æ•—æ™‚ã¯ IDB ã®ã¿ï¼‰
    function saveStore(store) {
      const json = JSON.stringify(store);
      try {
        localStorage.setItem(STORE_KEY, json);
      } catch(e) {
        console.warn('[saveStore] localStorage æ›¸ãè¾¼ã¿å¤±æ•— (quota?):', e);
        // Quotaè¶…éãªã‚‰å¤ã„æœˆã‚’å‰Šé™¤ã—ã¦å†è©¦è¡Œ
        try {
          const months = Object.keys(store.months || {}).sort();
          if (months.length > 3) {
            delete store.months[months[0]]; // æœ€å¤æœˆã‚’å‰Šé™¤
            localStorage.setItem(STORE_KEY, JSON.stringify(store));
            console.warn('[saveStore] æœ€å¤æœˆã‚’å‰Šé™¤ã—ã¦ä¿å­˜ã—ã¾ã—ãŸ:', months[0]);
          }
        } catch(_) { console.error('[saveStore] ä¿å­˜å®Œå…¨å¤±æ•—'); }
      }
      idbSave(store); // éåŒæœŸãƒŸãƒ©ãƒ¼ï¼ˆfire-and-forgetï¼‰
      // ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ: 30åˆ†ã«1å›ã ã‘ä¿å­˜ï¼ˆé »ç¹ãªæ›¸ãè¾¼ã¿ã‚’æŠ‘åˆ¶ï¼‰
      try {
        const lastSnap = localStorage.getItem('_kintai_snap_last') || '0';
        if (Date.now() - Number(lastSnap) > 30 * 60 * 1000) {
          saveSnapshot(store);
          localStorage.setItem('_kintai_snap_last', String(Date.now()));
        }
      } catch(_) {}
    }

    // èµ·å‹•æ™‚: localStorage ãŒç©ºãªã‚‰ IndexedDB ã‹ã‚‰å¾©å…ƒ
    async function restoreFromIDBIfNeeded() {
      const ls = localStorage.getItem(STORE_KEY);
      const isEmpty = !ls || ls === '{"months":{}}';
      if (!isEmpty) return false;
      const idbData = await idbLoad();
      if (idbData && Object.keys(idbData.months || {}).length > 0) {
        localStorage.setItem(STORE_KEY, JSON.stringify(idbData));
        toast('ğŸ’¾ IndexedDBã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
        return true;
      }
      return false;
    }

    function buildSkeleton(ym) {
      const [y, m] = ym.split('-').map(Number);
      const last = new Date(y, m, 0).getDate();
      const out = {};
      for (let day = 1; day <= last; day++) {
        const d = `${ym}-${String(day).padStart(2, '0')}`;
        out[d] = { date: d, status: 'æœª', start: '', end: '', memo: '', updated_at: '' };
      }
      return out;
    }

    function autoStatus(dateStr) {
      if (holidayName(dateStr)) return 'ç¥æ—¥';
      const wd = new Date(dateStr + 'T00:00:00').getDay();
      if (wd === 0) return 'ä¼‘æ—¥';
      if (wd === 6) return 'ä¼‘ã¿';
      return 'æœª';
    }

    function applyAutoRules(monthData) {
      const out = {}, holidays = {};
      for (const [d, rec] of Object.entries(monthData)) {
        const r = { ...rec };
        const hn = holidayName(d);
        if (hn) holidays[d] = hn;
        const st = (r.status || 'æœª').trim() || 'æœª';
        r.status = (st === 'æœª') ? autoStatus(d) : st;
        out[d] = r;
      }
      return { data: out, holidays };
    }

    function getMonthData(ym) {
      const store = loadStore();
      if (!store.months[ym]) {
        store.months[ym] = buildSkeleton(ym);
        saveStore(store);
      }
      return applyAutoRules(store.months[ym]);
    }

    function saveDayData(dateStr, status, start, end, memo) {
      const ym = dateStr.slice(0, 7);
      const store = loadStore();
      if (!store.months[ym]) store.months[ym] = buildSkeleton(ym);
      if (!store.months[ym][dateStr]) {
        store.months[ym][dateStr] = {
          date: dateStr, status: 'æœª', start: '', end: '', memo: '', updated_at: ''
        };
      }
      if (status !== '') store.months[ym][dateStr].status = status;
      store.months[ym][dateStr].start = start;
      store.months[ym][dateStr].end   = end;
      store.months[ym][dateStr].memo  = memo;
      store.months[ym][dateStr].updated_at = new Date().toISOString().slice(0, 19);
      saveStore(store);
      // return view-corrected record
      const { data } = applyAutoRules({ [dateStr]: store.months[ym][dateStr] });
      return data[dateStr];
    }

    /* =====================================================
       APP STATE
       ===================================================== */
    let currentYear, currentMonth;
    let attendanceData = {};
    let holidaysData   = {};
    let currentEditDate = null;
    let locked = false;
    let selectedDateStr = null;

    const toastEl   = document.getElementById('toast');
    const overlayEl = document.getElementById('overlay');

    function toast(msg) {
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      setTimeout(() => toastEl.classList.remove('show'), 1400);
    }

    function setLoading(v) {
      overlayEl.classList.toggle('show', !!v);
    }

    /* =====================================================
       FORMAT HELPERS
       ===================================================== */
    function ymLabel(y, m) {
      return `${y}å¹´${m}æœˆ`;
    }

    function formatDateJP(dateStr) {
      const d = new Date(dateStr + 'T00:00:00');
      const wdays = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
      return `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥ï¼ˆ${wdays[d.getDay()]}ï¼‰`;
    }

    function prevDateStr(dateStr) {
      const d = new Date(dateStr + 'T00:00:00');
      d.setDate(d.getDate() - 1);
      return d.toISOString().slice(0, 10);
    }

    /* =====================================================
       LOAD MONTH
       ===================================================== */
    function loadMonth(year, month) {
      currentYear  = year;
      currentMonth = month;
      document.getElementById('month-label').textContent = ymLabel(year, month);

      setLoading(true);
      try {
        const ym = `${year}-${String(month).padStart(2, '0')}`;
        const { data, holidays } = getMonthData(ym);
        attendanceData = data;
        holidaysData   = holidays;
        renderCalendar(year, month);
        renderStats(year, month);
      } finally {
        setLoading(false);
      }
    }

    /* =====================================================
       SAVE ATTENDANCE
       ===================================================== */
    function saveAttendance(dateStr, status, memo, start, end) {
      const prev = attendanceData[dateStr] ? { ...attendanceData[dateStr] } : null;
      try {
        const day = saveDayData(dateStr, status, start, end, memo);
        attendanceData[dateStr] = day;
        const hn = holidayName(dateStr);
        if (hn) holidaysData[dateStr] = hn;

        localStorage.setItem(LAST_KEY, JSON.stringify({ status, memo, start, end }));
        renderCalendar(currentYear, currentMonth);
        return true;
      } catch (e) {
        if (prev) attendanceData[dateStr] = prev;
        else delete attendanceData[dateStr];
        renderCalendar(currentYear, currentMonth);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        return false;
      }
    }

    function getLastTemplate() {
      try {
        const r = localStorage.getItem(LAST_KEY);
        return r ? JSON.parse(r) : null;
      } catch { return null; }
    }

    function quickDuplicateLast(targetDate) {
      if (locked) return;
      const t = getLastTemplate();
      if (!t) { alert('ç›´è¿‘ãƒ†ãƒ³ãƒ—ãƒ¬ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
      const ok = saveAttendance(targetDate, t.status||'æœª', t.memo||'', t.start||'', t.end||'');
      if (ok) toast(`${targetDate} ã«ç›´è¿‘ã‚’åæ˜ `);
    }

    /* =====================================================
       RENDER CALENDAR
       ===================================================== */
    function renderCalendar(year, month) {
      const tbody = document.getElementById('calendar-body');
      tbody.innerHTML = '';

      const first      = new Date(year, month - 1, 1);
      const lastDay    = new Date(year, month, 0).getDate();
      const firstWd    = first.getDay();

      const today = new Date();
      const todayY = today.getFullYear();
      const todayM = today.getMonth() + 1;
      const todayD = today.getDate();

      let row = document.createElement('tr');

      for (let i = 0; i < firstWd; i++) row.appendChild(document.createElement('td'));

      for (let day = 1; day <= lastDay; day++) {
        if (row.children.length === 7) {
          tbody.appendChild(row);
          row = document.createElement('tr');
        }

        const td      = document.createElement('td');
        const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const dbData  = attendanceData[dateStr] || null;
        const hname   = holidaysData[dateStr] || null;
        const w       = new Date(year, month - 1, day).getDay();

        let status = 'æœª', memo = '', start = '', end = '';
        if (dbData) {
          status = dbData.status || 'æœª';
          memo   = dbData.memo   || '';
          start  = dbData.start  || '';
          end    = dbData.end    || '';
        }

        const card = document.createElement('div');
        card.className = `day-card day-card-status-${status}`;
        if (year === todayY && month === todayM && day === todayD) card.classList.add('today-ring');
        if (selectedDateStr === dateStr) card.classList.add('selected-day');
        card.dataset.date = dateStr;

        // Header
        const header = document.createElement('div');
        header.className = 'day-header';

        const num = document.createElement('div');
        num.className = 'day-number' + (w === 0 ? ' sun' : w === 6 ? ' sat' : '');
        num.textContent = day;

        const pill = document.createElement('div');
        pill.className = `status-pill status-pill-${status}`;
        pill.textContent = status;
        const ddIcon = document.createElement('span');
        ddIcon.className = 'dropdown-icon';
        ddIcon.textContent = 'â–¾';
        pill.appendChild(ddIcon);

        const dot = document.createElement('span');
        dot.className = 'memo-dot';
        dot.textContent = memo ? 'â—' : '';

        header.appendChild(num);
        header.appendChild(pill);
        header.appendChild(dot);
        card.appendChild(header);

        if (start || end) {
          const tm = document.createElement('div');
          tm.className = 'subline';
          tm.textContent = `${start || '--:--'}ã€œ${end || '--:--'}`;
          card.appendChild(tm);
        }

        if (hname) {
          const hl = document.createElement('div');
          hl.className = 'holiday-name';
          hl.textContent = hname;
          card.appendChild(hl);
        }

        // ç›´è¿‘ãƒœã‚¿ãƒ³
        const actions = document.createElement('div');
        actions.className = 'cell-actions';
        const bLast = document.createElement('button');
        bLast.type = 'button';
        bLast.className = 'mini-btn';
        bLast.textContent = 'ç›´è¿‘';
        bLast.addEventListener('click', e => {
          e.stopPropagation();
          quickDuplicateLast(dateStr);
        });
        actions.appendChild(bLast);
        card.appendChild(actions);

        td.appendChild(card);
        row.appendChild(td);
      }

      if (row.children.length > 0) {
        while (row.children.length < 7) row.appendChild(document.createElement('td'));
        tbody.appendChild(row);
      }

      document.getElementById('calendar-card').classList.toggle('locked', locked);
    }

    /* =====================================================
       MODAL
       ===================================================== */
    function openModal(dateStr) {
      if (locked) return;
      currentEditDate = dateStr;

      const dbData = attendanceData[dateStr] || null;
      let status = 'æœª', memo = '', start = '', end = '';
      if (dbData) {
        status = dbData.status || 'æœª';
        memo   = dbData.memo   || '';
        start  = dbData.start  || '';
        end    = dbData.end    || '';
      }

      document.getElementById('modal-date-label').textContent = formatDateJP(dateStr);
      document.getElementById('memo-textarea').value  = memo;
      document.getElementById('start-time').value     = start || '09:00';
      document.getElementById('end-time').value       = end   || '18:00';

      const row = document.getElementById('status-chip-row');
      row.innerHTML = '';
      STATUS_LIST.forEach(s => {
        const chip = document.createElement('div');
        chip.className = 'status-chip' + (s === status ? ' active' : '');
        chip.textContent = s;
        chip.dataset.value = s;
        row.appendChild(chip);
      });

      document.getElementById('memo-modal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('memo-modal').classList.remove('show');
      currentEditDate = null;
    }

    function getModalStatus() {
      for (const c of document.querySelectorAll('.status-chip')) {
        if (c.classList.contains('active')) return c.dataset.value;
      }
      return 'æœª';
    }

    function applyTemplate(t) {
      if (!t) return;
      document.querySelectorAll('.status-chip')
        .forEach(c => c.classList.toggle('active', c.dataset.value === t.status));
      document.getElementById('memo-textarea').value = t.memo  || '';
      document.getElementById('start-time').value    = t.start || '09:00';
      document.getElementById('end-time').value      = t.end   || '18:00';
    }

    /* =====================================================
       OBSIDIAN
       ===================================================== */
    function obsidianOpen(dateStr) {
      const cfg    = loadConfig();
      const vault  = (cfg.vault  || 'Phi_Memo').trim();
      const subdir = (cfg.subdir || 'ã€æ¥­å‹™ã€‘/å‹¤æ€ ').trim();
      const file   = encodeURIComponent(`${subdir}/${dateStr}.md`);
      location.href = `obsidian://open?vault=${encodeURIComponent(vault)}&file=${file}`;
    }

    /* =====================================================
       xlsx æ›¸ãå‡ºã—ï¼ˆSheetJSï¼‰â€” é…å»¶ãƒ­ãƒ¼ãƒ‰ç‰ˆ
       ===================================================== */
    const XLSX_CDN = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
    function loadXlsxLib() {
      if (typeof XLSX !== 'undefined') return Promise.resolve();
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = XLSX_CDN;
        s.onload = resolve;
        s.onerror = () => reject(new Error('xlsx ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'));
        document.head.appendChild(s);
      });
    }

    async function exportXlsx() {
      try { await loadXlsxLib(); } catch(e) { alert(e.message); return; }
      const store  = loadStore();
      const months = Object.keys(store.months).sort();
      if (months.length === 0) { alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }

      const wb    = XLSX.utils.book_new();
      const wdays = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];

      for (const ym of months) {
        const monthData = store.months[ym];
        const header = ['æ—¥ä»˜','æ›œæ—¥','ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹','é–‹å§‹','çµ‚äº†','å‹¤å‹™æ™‚é–“','ç¥æ—¥','ãƒ¡ãƒ¢'];
        const rows   = [header];

        Object.keys(monthData).sort().forEach(d => {
          const rec = monthData[d];
          const dt  = new Date(d + 'T00:00:00');
          const wd  = wdays[dt.getDay()];

          // å‹¤å‹™æ™‚é–“ã‚’è¨ˆç®—
          let workHours = '';
          if (rec.start && rec.end) {
            const [sh, sm] = rec.start.split(':').map(Number);
            const [eh, em] = rec.end.split(':').map(Number);
            const diff = (eh * 60 + em) - (sh * 60 + sm);
            if (diff > 0) workHours = `${Math.floor(diff / 60)}:${String(diff % 60).padStart(2, '0')}`;
          }

          rows.push([
            d,
            wd,
            rec.status  || 'æœª',
            rec.start   || '',
            rec.end     || '',
            workHours,
            holidayName(d) || '',
            rec.memo    || ''
          ]);
        });

        const ws = XLSX.utils.aoa_to_sheet(rows);
        // åˆ—å¹…
        ws['!cols'] = [
          {wch:12},{wch:4},{wch:8},{wch:6},{wch:6},{wch:8},{wch:14},{wch:60}
        ];
        // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆèƒŒæ™¯è‰²ãªã©ï¼‰ã¯ xlsx.full ã§ã¯åˆ¥é€”è¦è¨­å®šã®ãŸã‚çœç•¥
        XLSX.utils.book_append_sheet(wb, ws, ym);
      }

      const fname = `kintai_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, fname);
      toast(`ğŸ“Š ${fname} ã‚’æ›¸ãå‡ºã—ã¾ã—ãŸ`);
    }

    document.getElementById('btn-xlsx').addEventListener('click', exportXlsx);

    /* =====================================================
       iSHç‰ˆãƒ‡ãƒ¼ã‚¿ç§»è¡Œï¼ˆPWAå†…ã‹ã‚‰åŒä¸€ã‚ªãƒªã‚¸ãƒ³fetchï¼‰
       ===================================================== */
    document.getElementById('btn-migrate').addEventListener('click', async () => {
      if (!confirm('iSHç‰ˆã®å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆ4ãƒ¶æœˆãƒ»73ä»¶ã®è¨˜éŒ²ï¼‰ã‚’ã“ã®ã‚¢ãƒ—ãƒªã«å–ã‚Šè¾¼ã¿ã¾ã™ã€‚\næ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¨ãƒãƒ¼ã‚¸ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
      setLoading(true);
      try {
        const res = await fetch('./kintai_backup_2026-02-22.json', { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (!data || !data.months) throw new Error('ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');

        // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨ãƒãƒ¼ã‚¸ï¼ˆæ—¢å­˜ã‚’å„ªå…ˆï¼‰
        const existing = loadStore();
        const merged = { months: { ...data.months, ...existing.months } };
        saveStore(merged);

        // æœˆã”ã¨ã®ä»¶æ•°é›†è¨ˆ
        const months = Object.keys(data.months);
        const total  = months.reduce((s, m) => s + Object.values(data.months[m]).filter(v => v.status && v.status !== 'æœª').length, 0);

        loadMonth(currentYear, currentMonth);
        toast(`âœ… ç§»è¡Œå®Œäº†ï¼${months.length}ãƒ¶æœˆãƒ»${total}ä»¶ã®è¨˜éŒ²ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸ`);
      } catch (e) {
        alert(`å–ã‚Šè¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}`);
      } finally {
        setLoading(false);
      }
    });

    /* =====================================================
       IMPORT / EXPORT
       ===================================================== */
    document.getElementById('btn-export').addEventListener('click', () => {
      exportJSON();
      markBackedUp();
      document.getElementById('backup-banner').classList.remove('show');
      toast('ğŸ’¾ JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    });

    document.getElementById('btn-import').addEventListener('click', () => {
      document.getElementById('file-import').click();
    });

    document.getElementById('file-import').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          const data = JSON.parse(ev.target.result);
          if (!data || !data.months) throw new Error('invalid format');
          if (!confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿï¼ˆå…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰')) return;
          saveStore(data);
          loadMonth(currentYear, currentMonth);
          toast('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
        } catch {
          alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    });

    /* =====================================================
       PROGRESS OVERLAY ãƒ˜ãƒ«ãƒ‘ãƒ¼
       ===================================================== */
    const _overlay  = document.getElementById('progress-overlay');
    const _progBar  = document.getElementById('progress-bar');
    const _progStep = document.getElementById('progress-step');
    const _progTitle= document.getElementById('progress-title');

    function showProgress(title) {
      _progTitle.textContent = title || 'å‡¦ç†ä¸­...';
      _progBar.style.width   = '0%';
      _progStep.textContent  = '';
      _overlay.classList.add('show');
      console.log(`[Progress] ${title}`);
    }
    function updateProgress(pct, stepMsg) {
      _progBar.style.width  = `${Math.min(pct, 100)}%`;
      _progStep.textContent = stepMsg || '';
      console.log(`[Progress] ${pct}% â€” ${stepMsg}`);
    }
    function hideProgress() {
      _overlay.classList.remove('show');
      console.log('[Progress] å®Œäº†');
    }

    /* =====================================================
       JINJER åŒæœŸï¼ˆãƒãƒ¼ã‚¸ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼‰
       ===================================================== */
    document.getElementById('btn-jinjer').addEventListener('click', () => {
      document.getElementById('file-jinjer').click();
    });

    document.getElementById('file-jinjer').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) { e.target.value = ''; return; }
      e.target.value = '';

      showProgress('ğŸ¢ jinjeråŒæœŸ');
      updateProgress(5, 'ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...');
      console.log('[jinjer] é–‹å§‹:', file.name, file.size, 'bytes');

      const reader = new FileReader();

      reader.onload = async ev => {
        try {
          // â‘  JSONè§£æï¼ˆUI ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ã‚ˆã† yieldï¼‰
          await tick();
          updateProgress(15, 'ğŸ” ãƒ‡ãƒ¼ã‚¿ã‚’è§£æä¸­...');
          let jinjer;
          try {
            jinjer = JSON.parse(ev.target.result);
          } catch(parseErr) {
            throw new Error('JSONã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + parseErr.message);
          }
          if (!jinjer || typeof jinjer.months !== 'object') throw new Error('months ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“');

          const monthKeys = Object.keys(jinjer.months);
          if (!monthKeys.length) throw new Error('å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
          console.log('[jinjer] å¯¾è±¡æœˆ:', monthKeys);
          updateProgress(25, `ğŸ“… å¯¾è±¡: ${monthKeys.join(', ')}`);

          // â‘¡ æ—¢å­˜ã‚¹ãƒˆã‚¢ã‚’èª­ã‚€
          await tick();
          updateProgress(35, 'ğŸ“– æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...');
          let store;
          try {
            store = loadStore();
          } catch(storeErr) {
            console.warn('[jinjer] loadStoreå¤±æ•—ã€ç©ºã‚¹ãƒˆã‚¢ã§ç¶šè¡Œ:', storeErr);
            store = { months: {} };
          }

          // â‘¢ ãƒãƒ£ãƒ³ã‚¯å‡¦ç†ï¼ˆ7æ—¥ãšã¤ã€å„ãƒãƒ£ãƒ³ã‚¯é–“ã§UIã«åˆ¶å¾¡ã‚’è¿”ã™ï¼‰
          const allDays = [];
          for (const [mk, days] of Object.entries(jinjer.months)) {
            if (!store.months[mk]) store.months[mk] = {};
            for (const [dk, jd] of Object.entries(days)) {
              allDays.push({ mk, dk, jd });
            }
          }
          const total = allDays.length;
          console.log(`[jinjer] å‡¦ç†å¯¾è±¡: ${total}æ—¥åˆ†`);

          const CHUNK = 7;
          let done = 0;
          for (let i = 0; i < allDays.length; i += CHUNK) {
            const chunk = allDays.slice(i, i + CHUNK);
            for (const { mk, dk, jd } of chunk) {
              const ex = store.months[mk][dk] || {};
              store.months[mk][dk] = {
                ...ex,                           // statusãƒ»memoãƒ»updated_at ç­‰ã‚’å…¨ã¦ä¿æŒ
                start: jd.start || ex.start || '', // å‡ºå‹¤æ™‚é–“ã®ã¿ä¸Šæ›¸ã
                end:   jd.end   || ex.end   || '', // é€€å‹¤æ™‚é–“ã®ã¿ä¸Šæ›¸ã
                // status ã¨ memo ã¯ jinjer ã§ã¯ä¸Šæ›¸ãã—ãªã„
              };
              done++;
            }
            const pct = 35 + Math.round((done / total) * 45); // 35â†’80%
            updateProgress(pct, `ğŸ”„ ${done} / ${total} æ—¥ã‚’å‡¦ç†ä¸­...`);
            await tick(); // UIã«åˆ¶å¾¡ã‚’è¿”ã™
          }

          // â‘£ localStorage ã«ä¿å­˜ï¼ˆIDB ã¯éåŒæœŸfire-and-forgetï¼‰
          await tick();
          updateProgress(85, 'ğŸ’¾ localStorage ã«ä¿å­˜ä¸­...');
          try {
            localStorage.setItem(STORE_KEY, JSON.stringify(store));
            console.log('[jinjer] localStorage ä¿å­˜å®Œäº†');
          } catch(lsErr) {
            console.error('[jinjer] localStorage ä¿å­˜å¤±æ•—:', lsErr);
            throw new Error('ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç©ºãå®¹é‡ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
          }

          // â‘¤ IDB ãƒŸãƒ©ãƒ¼ï¼ˆå¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œï¼‰
          updateProgress(90, 'ğŸ’¾ IndexedDB ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸­...');
          try {
            await idbSave(store);
            console.log('[jinjer] IDB ä¿å­˜å®Œäº†');
          } catch(idbErr) {
            console.warn('[jinjer] IDB ä¿å­˜å¤±æ•—ï¼ˆç„¡è¦–ï¼‰:', idbErr);
          }

          // â‘¥ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å†æç”»
          await tick();
          updateProgress(97, 'ğŸ—“ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°ä¸­...');
          try {
            loadMonth(currentYear, currentMonth);
          } catch(renderErr) {
            console.warn('[jinjer] ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å†æç”»å¤±æ•—:', renderErr);
          }

          updateProgress(100, `âœ… ${done}æ—¥åˆ†ã®åŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸï¼`);
          console.log(`[jinjer] å®Œäº†: ${done}æ—¥åˆ†`);

          await new Promise(r => setTimeout(r, 900));
          hideProgress();
          toast(`âœ… jinjeråŒæœŸå®Œäº†ï¼ˆ${done}æ—¥åˆ†ï¼‰`);

        } catch(err) {
          console.error('[jinjer] è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼:', err);
          hideProgress();
          toast(`âŒ ${err.message || 'jinjeråŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ'}`);
        }
      };

      reader.onerror = () => {
        console.error('[jinjer] FileReader ã‚¨ãƒ©ãƒ¼');
        hideProgress();
        toast('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      };

      reader.readAsText(file, 'utf-8');
    });

    // UIã«åˆ¶å¾¡ã‚’è¿”ã™å°ã•ãªãƒ˜ãƒ«ãƒ‘ãƒ¼
    function tick() {
      return new Promise(r => setTimeout(r, 0));
    }

    /* =====================================================
       SETTINGS MODAL
       ===================================================== */
    document.getElementById('btn-settings').addEventListener('click', () => {
      const cfg = loadConfig();
      document.getElementById('settings-vault').value     = cfg.vault     || 'Phi_Memo';
      document.getElementById('settings-subdir').value   = cfg.subdir   || 'ã€æ¥­å‹™ã€‘/å‹¤æ€ ';
      document.getElementById('settings-jinjer-url').value = cfg.jinjerUrl || 'https://kintai.jinjer.biz/staffs/top';
      updatePinUI();
      document.getElementById('settings-modal').classList.add('show');
    });

    document.getElementById('settings-close').addEventListener('click', () => {
      document.getElementById('settings-modal').classList.remove('show');
    });
    document.getElementById('settings-cancel').addEventListener('click', () => {
      document.getElementById('settings-modal').classList.remove('show');
    });
    document.getElementById('settings-save').addEventListener('click', () => {
      const rawJinjer = document.getElementById('settings-jinjer-url').value.trim();
      const cfg = {
        vault:     document.getElementById('settings-vault').value.trim()  || 'Phi_Memo',
        subdir:    document.getElementById('settings-subdir').value.trim() || 'ã€æ¥­å‹™ã€‘/å‹¤æ€ ',
        jinjerUrl: (rawJinjer && rawJinjer.startsWith('http')) ? rawJinjer : 'https://kintai.jinjer.biz/staffs/top',
      };
      saveConfig(cfg);
      // jinjerã‚«ãƒ¼ãƒ‰ã®hrefã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
      const jinjerLink = document.getElementById('jinjer-link');
      if (jinjerLink) jinjerLink.href = cfg.jinjerUrl;
      document.getElementById('settings-modal').classList.remove('show');
      toast('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    });

    /* =====================================================
       EVENT HANDLERS
       ===================================================== */

    // Calendar click â†’ open modal
    document.addEventListener('click', ev => {
      const card = ev.target.closest('.day-card');
      if (card && !locked) {
        const dateStr = card.dataset.date;
        if (!dateStr) return;
        selectedDateStr = dateStr;
        document.querySelectorAll('.day-card.selected-day')
          .forEach(c => c.classList.remove('selected-day'));
        card.classList.add('selected-day');
        openModal(dateStr);
        return;
      }

      // Status chip
      const chip = ev.target.closest('.status-chip');
      if (chip && document.getElementById('memo-modal').classList.contains('show')) {
        document.querySelectorAll('.status-chip').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        return;
      }

      // Backdrop close
      const mModal = document.getElementById('memo-modal');
      if (mModal.classList.contains('show') && ev.target === mModal) { closeModal(); return; }
      const sModal = document.getElementById('settings-modal');
      if (sModal.classList.contains('show') && ev.target === sModal) {
        sModal.classList.remove('show');
      }
    });

    document.getElementById('modal-close').addEventListener('click', closeModal);
    document.getElementById('modal-cancel').addEventListener('click', closeModal);

    // Save
    document.getElementById('modal-save').addEventListener('click', () => {
      if (!currentEditDate) return;
      const status = getModalStatus();
      const memo   = document.getElementById('memo-textarea').value;
      const start  = document.getElementById('start-time').value || '';
      const end    = document.getElementById('end-time').value   || '';
      const ok = saveAttendance(currentEditDate, status, memo, start, end);
      if (ok) { closeModal(); toast('ä¿å­˜ã—ã¾ã—ãŸ'); }
    });

    // Duplicate: last template
    document.getElementById('btn-dup-last').addEventListener('click', () => {
      const t = getLastTemplate();
      if (!t) { alert('ç›´è¿‘ãƒ†ãƒ³ãƒ—ãƒ¬ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
      applyTemplate(t);
    });

    // Duplicate: prev day
    document.getElementById('btn-dup-prev').addEventListener('click', () => {
      if (!currentEditDate) return;
      const p = prevDateStr(currentEditDate);
      const prev = attendanceData[p];
      if (!prev) { alert('å‰æ—¥ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
      applyTemplate(prev);
    });

    // Obsidian
    document.getElementById('btn-obs-open').addEventListener('click', () => {
      if (!currentEditDate) return;
      obsidianOpen(currentEditDate);
    });

    // Month navigation
    document.getElementById('prev-month').addEventListener('click', () => {
      let y = currentYear, m = currentMonth - 1;
      if (m === 0) { m = 12; y--; }
      loadMonth(y, m);
    });
    document.getElementById('next-month').addEventListener('click', () => {
      let y = currentYear, m = currentMonth + 1;
      if (m === 13) { m = 1; y++; }
      loadMonth(y, m);
    });
    document.getElementById('today-button').addEventListener('click', () => {
      const t = new Date();
      loadMonth(t.getFullYear(), t.getMonth() + 1);
    });

    // Lock
    document.getElementById('lock-toggle').addEventListener('click', () => {
      locked = !locked;
      const btn   = document.getElementById('lock-toggle');
      const label = document.getElementById('lock-label');
      btn.classList.toggle('pill-button-lock-on', locked);
      label.textContent = locked ? 'ãƒ­ãƒƒã‚¯ä¸­' : 'ãƒ­ãƒƒã‚¯';
      document.getElementById('calendar-card').classList.toggle('locked', locked);
    });

    // Install banner
    const installBanner = document.getElementById('install-banner');
    const isStandalone  = window.matchMedia('(display-mode: standalone)').matches
                       || navigator.standalone === true;
    const bannerDismissed = sessionStorage.getItem('install_banner_dismissed');
    if (!isStandalone && !bannerDismissed) {
      installBanner.classList.add('show');
    }
    document.getElementById('install-close').addEventListener('click', () => {
      installBanner.classList.remove('show');
      sessionStorage.setItem('install_banner_dismissed', '1');
    });

    /* =====================================================
       MONTHLY STATS
       ===================================================== */
    function calcMonthStats(year, month) {
      const ym   = `${year}-${String(month).padStart(2,'0')}`;
      const raw  = loadStore().months[ym] || {};
      let office = 0, home = 0, off = 0, totalMin = 0;

      Object.values(raw).forEach(rec => {
        const { data } = applyAutoRules({ [rec.date]: rec });
        const st = data[rec.date]?.status || 'æœª';
        if (st === 'å‡ºç¤¾')                           office++;
        else if (st === 'åœ¨å®…')                      home++;
        else if (['ä¼‘ã¿','ä¼‘æ—¥','ç¥æ—¥'].includes(st)) off++;

        if (rec.start && rec.end) {
          const [sh, sm] = rec.start.split(':').map(Number);
          const [eh, em] = rec.end.split(':').map(Number);
          const d = (eh * 60 + em) - (sh * 60 + sm);
          if (d > 0) totalMin += d;
        }
      });

      const h = Math.floor(totalMin / 60);
      const m = totalMin % 60;
      return { office, home, off, hours: h, mins: m };
    }

    function renderStats(year, month) {
      const s = calcMonthStats(year, month);
      document.getElementById('stat-office').textContent = s.office;
      document.getElementById('stat-home').textContent   = s.home;
      document.getElementById('stat-off').textContent    = s.off;
      document.getElementById('stat-hours').textContent  =
        s.hours > 0 ? `${s.hours}h${s.mins > 0 ? s.mins + 'm' : ''}` : '0h';
      renderWeeklyStats(year, month);
    }

    /* =====================================================
       WEEKLY PERSON-MONTH STATS  (1äººæœˆ = 8h)
       ===================================================== */
    function calcWeeklyStats(year, month) {
      const ym      = `${year}-${String(month).padStart(2,'0')}`;
      const raw     = loadStore().months[ym] || {};
      const lastDay = new Date(year, month, 0).getDate();
      const firstWd = new Date(year, month - 1, 1).getDay(); // 0=Sun
      const pad2    = n => String(n).padStart(2,'0');
      const weeks   = [];
      let wStart = 1, wMin = 0;

      for (let day = 1; day <= lastDay; day++) {
        const dk  = `${ym}-${pad2(day)}`;
        const rec = raw[dk];
        if (rec && rec.start && rec.end) {
          const [sh, sm] = rec.start.split(':').map(Number);
          const [eh, em] = rec.end.split(':').map(Number);
          const d = (eh * 60 + em) - (sh * 60 + sm);
          if (d > 0) wMin += d;
        }
        const gridPos = (firstWd + day - 1) % 7; // 0=Sun â€¦ 6=Sat
        if (gridPos === 6 || day === lastDay) {
          weeks.push({ start: wStart, end: day, minutes: wMin });
          wStart = day + 1;
          wMin   = 0;
        }
      }
      return weeks;
    }

    function renderWeeklyStats(year, month) {
      const el    = document.getElementById('weekly-stats');
      const weeks = calcWeeklyStats(year, month);
      const pad2  = n => String(n).padStart(2,'0');
      const mm    = String(month).padStart(2,'0');
      // æœ€å¤§åˆ†æ•°ï¼ˆãƒãƒ¼æ¯”ç‡ç”¨ï¼‰
      const maxMin = Math.max(...weeks.map(w => w.minutes), 1);

      let html = '<table>';
      weeks.forEach((w, i) => {
        const h   = Math.floor(w.minutes / 60);
        const m   = w.minutes % 60;
        const pm  = (w.minutes / 60 / 8).toFixed(2);
        const pct = Math.round(w.minutes / maxMin * 100);
        const lbl = `W${i+1} ${mm}/${pad2(w.start)}ã€œ${mm}/${pad2(w.end)}`;
        const hStr = w.minutes > 0 ? `${h}h${m > 0 ? m+'m' : ''}` : 'â€”';
        html += `<tr>
          <td class="w-label">${lbl}</td>
          <td class="w-hours">${hStr}</td>
          <td class="w-bar-cell"><div class="w-bar-bg"><div class="w-bar-fill" style="width:${pct}%"></div></div></td>
          <td class="w-pm">${w.minutes > 0 ? pm+'äººæœˆ' : 'â€”'}</td>
        </tr>`;
      });
      html += '</table>';
      el.innerHTML = html;
    }

    /* =====================================================
       AUTO BACKUP SYSTEM
       ===================================================== */
    const BACKUP_KEY           = 'kintai_last_backup';
    const BACKUP_INTERVAL_DAYS = 7;

    function daysSinceBackup() {
      const last = localStorage.getItem(BACKUP_KEY);
      if (!last) return 999;
      return Math.floor((Date.now() - parseInt(last)) / 86400000);
    }

    function markBackedUp() {
      localStorage.setItem(BACKUP_KEY, Date.now().toString());
    }

    function checkBackupReminder() {
      const days = daysSinceBackup();
      if (days >= BACKUP_INTERVAL_DAYS) {
        const msg = days >= 999
          ? 'ã¾ã ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“'
          : `å‰å›ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ <strong>${days}æ—¥</strong> çµŒéã—ã¦ã„ã¾ã™`;
        document.getElementById('backup-days-msg').innerHTML = msg;
        document.getElementById('backup-banner').classList.add('show');
      }
    }

    // JSON ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆå˜ä½“ï¼‰
    function exportJSON() {
      const store = loadStore();
      const blob  = new Blob([JSON.stringify(store, null, 2)], { type: 'application/json' });
      const a     = document.createElement('a');
      a.href      = URL.createObjectURL(blob);
      a.download  = `kintai_backup_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // JSON + xlsx ã‚’é€£ç¶šãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆä¸€æ‹¬ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰
    async function oneClickBackup() {
      exportJSON();
      markBackedUp();
      document.getElementById('backup-banner').classList.remove('show');
      toast('âœ… JSON + xlsx ã‚’ä¿å­˜ã—ã¾ã™...');
      await new Promise(r => setTimeout(r, 800)); // iOS ã§åŒæ™‚DLãŒè©°ã¾ã‚‰ãªã„ã‚ˆã†å°‘ã—é–“éš”ã‚’ç½®ã
      await exportXlsx();
    }

    document.getElementById('btn-backup-now').addEventListener('click', oneClickBackup);
    document.getElementById('weekly-toggle').addEventListener('click', () => {
      const el    = document.getElementById('weekly-stats');
      const arrow = document.getElementById('weekly-arrow');
      const open  = el.classList.toggle('open');
      arrow.textContent = open ? 'â–´' : 'â–¾';
    });
    document.getElementById('backup-dismiss').addEventListener('click', () => {
      document.getElementById('backup-banner').classList.remove('show');
    });

    // ã‚¢ãƒ—ãƒªãŒå‰é¢ã«æ¥ã‚‹ãŸã³ã«ãƒã‚§ãƒƒã‚¯
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') checkBackupReminder();
    });

    /* =====================================================
       SWIPE GESTUREï¼ˆå·¦å³ã‚¹ãƒ¯ã‚¤ãƒ—ã§æœˆåˆ‡ã‚Šæ›¿ãˆï¼‰
       ===================================================== */
    let _swipeX = 0, _swipeY = 0;
    document.getElementById('calendar-card').addEventListener('touchstart', e => {
      _swipeX = e.touches[0].clientX;
      _swipeY = e.touches[0].clientY;
    }, { passive: true });

    document.getElementById('calendar-card').addEventListener('touchend', e => {
      const dx = e.changedTouches[0].clientX - _swipeX;
      const dy = e.changedTouches[0].clientY - _swipeY;
      if (Math.abs(dx) < 50 || Math.abs(dx) < Math.abs(dy) * 1.2) return; // ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é™¤å¤–
      if (dx < 0) {
        // å·¦ã‚¹ãƒ¯ã‚¤ãƒ— â†’ æ¬¡æœˆ
        let y = currentYear, m = currentMonth + 1;
        if (m === 13) { m = 1; y++; }
        loadMonth(y, m);
      } else {
        // å³ã‚¹ãƒ¯ã‚¤ãƒ— â†’ å‰æœˆ
        let y = currentYear, m = currentMonth - 1;
        if (m === 0) { m = 12; y--; }
        loadMonth(y, m);
      }
    }, { passive: true });

    /* =====================================================
       FLOATING TODAY BUTTON
       ===================================================== */
    (function initFab() {
      const t   = new Date();
      const fab = document.getElementById('fab-today');
      document.getElementById('fab-day').textContent = t.getDate();

      fab.addEventListener('click', () => {
        const today = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;
        // ä»Šæœˆã§ãªã‘ã‚Œã°ä»Šæœˆã¸ç§»å‹•ã—ã¦ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        if (currentYear !== t.getFullYear() || currentMonth !== t.getMonth() + 1) {
          loadMonth(t.getFullYear(), t.getMonth() + 1);
          setTimeout(() => openModal(today), 150);
        } else {
          openModal(today);
        }
      });

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ã‚‹ã¨ãã¯éš ã™
      const observer = new MutationObserver(() => {
        const modalOpen = document.getElementById('memo-modal').classList.contains('show')
                       || document.getElementById('settings-modal').classList.contains('show');
        fab.classList.toggle('hidden', modalOpen);
      });
      observer.observe(document.getElementById('memo-modal'),     { attributes: true });
      observer.observe(document.getElementById('settings-modal'), { attributes: true });
    })();

    /* =====================================================
       GENERATE APP ICON (canvas â†’ apple-touch-icon)
       ===================================================== */
    (function generateIcon() {
      try {
        const c   = document.createElement('canvas');
        c.width   = 192;
        c.height  = 192;
        const ctx = c.getContext('2d');
        // Background
        ctx.fillStyle = '#4f8dfd';
        ctx.beginPath();
        ctx.roundRect(0, 0, 192, 192, 36);
        ctx.fill();
        // Text
        ctx.fillStyle = '#ffffff';
        ctx.font = 'bold 90px -apple-system, "Helvetica Neue", sans-serif';
        ctx.textAlign    = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('å‹¤', 96, 102);
        document.getElementById('apple-touch-icon-link').href = c.toDataURL('image/png');
      } catch (_) {}
    })();

    /* =====================================================
       INIT
       ===================================================== */
    (async function init() {
      try {
        const t = new Date();
        // IDBå¾©å…ƒï¼ˆå¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œï¼‰
        let restored = false;
        try { restored = await restoreFromIDBIfNeeded(); } catch(e) { console.warn('[init] IDBå¾©å…ƒã‚¹ã‚­ãƒƒãƒ—:', e); }
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»ï¼ˆå¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œï¼‰
        try { loadMonth(t.getFullYear(), t.getMonth() + 1); } catch(e) { console.warn('[init] loadMonthå¤±æ•—:', e); }
        if (restored) {
          try { renderCalendar(t.getFullYear(), t.getMonth() + 1); } catch(e) {}
          try { renderStats(t.getFullYear(), t.getMonth() + 1); }  catch(e) {}
        }
        try { checkBackupReminder(); } catch(e) {}
        // ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆéåŒæœŸï¼‰
        try { runHealthCheck(); } catch(e) {}
        // èµ·å‹•æˆåŠŸ â†’ ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã‚«ã‚¦ãƒ³ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
        localStorage.setItem(_CRASH_KEY, '0');
        // åˆå›ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼ˆèµ·å‹•æ™‚ã«1å›ï¼‰
        try {
          const store = loadStore();
          if (Object.keys(store.months || {}).length > 0) {
            const lastSnap = localStorage.getItem('_kintai_snap_last') || '0';
            if (Date.now() - Number(lastSnap) > 5 * 60 * 1000) { // 5åˆ†è¶…ãªã‚‰ä¿å­˜
              saveSnapshot(store);
              localStorage.setItem('_kintai_snap_last', String(Date.now()));
            }
          }
        } catch(e) {}
      } catch(fatal) {
        console.error('[init] è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼:', fatal);
      }
    })();

    /* =====================================================
       NETWORK STATUS MONITORï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³/ã‚ªãƒ³ãƒ©ã‚¤ãƒ³é€šçŸ¥ï¼‰
       ===================================================== */
    (function initNetworkMonitor() {
      const banner = document.getElementById('net-banner');
      let hideTimer = null;

      function showBanner(msg, type, autohide = true) {
        banner.textContent = msg;
        banner.className = `net-banner show ${type}`;
        clearTimeout(hideTimer);
        if (autohide) hideTimer = setTimeout(() => banner.classList.remove('show'), 2800);
      }

      window.addEventListener('online',  () => showBanner('âœ… ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«å¾©å¸°ã—ã¾ã—ãŸ', 'online'));
      window.addEventListener('offline', () => showBanner('ğŸ“µ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã™ â€” ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã§å‹•ä½œä¸­', 'offline', false));

      // åˆæœŸçŠ¶æ…‹ãŒã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã®å ´åˆ
      if (!navigator.onLine) showBanner('ğŸ“µ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã™ â€” ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã§å‹•ä½œä¸­', 'offline', false);
    })();

    /* =====================================================
       KEYBOARD SHORTCUTSï¼ˆãƒ‘ãƒ¯ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ï¼‰
       ===================================================== */
    document.addEventListener('keydown', e => {
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»å…¥åŠ›ä¸­ã¯ç„¡åŠ¹
      const tag = document.activeElement?.tagName;
      if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

      const memoOpen  = document.getElementById('memo-modal')?.classList.contains('show');
      const taskOpen  = document.getElementById('task-modal')?.classList.contains('show');
      const setsOpen  = document.getElementById('settings-modal')?.classList.contains('show');
      const anyModal  = memoOpen || taskOpen || setsOpen;

      if (e.key === 'Escape' && anyModal) {
        // ESC ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        if (memoOpen) document.getElementById('memo-modal').classList.remove('show');
        if (taskOpen) document.getElementById('task-modal').classList.remove('show');
        if (setsOpen) document.getElementById('settings-modal').classList.remove('show');
        return;
      }
      if (anyModal) return;

      if (e.key === 'ArrowLeft'  && !e.metaKey) { e.preventDefault(); document.getElementById('prev-month')?.click(); }
      if (e.key === 'ArrowRight' && !e.metaKey) { e.preventDefault(); document.getElementById('next-month')?.click(); }
      if (e.key === 't' || e.key === 'T')        document.getElementById('today-button')?.click();
    });

    /* =====================================================
       TASK MANAGEMENT
       ===================================================== */
    const TASKS_KEY = 'kintai_tasks_v1';

    function loadTasks() {
      try { return JSON.parse(localStorage.getItem(TASKS_KEY) || '[]'); } catch { return []; }
    }

    function saveTasks(tasks) {
      localStorage.setItem(TASKS_KEY, JSON.stringify(tasks));
    }

    function _esc(s) {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function taskItemHTML(t) {
      const memoHTML = t.memo ? `<div class="task-memo">${_esc(t.memo)}</div>` : '';
      return `<div class="task-item${t.done ? ' done' : ''}">
        <input type="checkbox" class="task-check" data-id="${t.id}" ${t.done ? 'checked' : ''}>
        <div class="task-body">
          <div class="task-title">${_esc(t.title)}</div>${memoHTML}
        </div>
        <button class="task-del" data-id="${t.id}" title="å‰Šé™¤">ğŸ—‘</button>
      </div>`;
    }

    function renderTaskList() {
      const tasks     = loadTasks();
      const container = document.getElementById('task-list-container');
      const todo      = tasks.filter(t => !t.done);
      const done      = tasks.filter(t => t.done);
      let html = '';
      if (!todo.length && !done.length) {
        html = '<div class="task-empty">ã‚¿ã‚¹ã‚¯ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“<br>ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è¿½åŠ ã§ãã¾ã™</div>';
      } else {
        if (todo.length) html += '<div class="task-section-title">æœªå®Œäº†</div><div class="task-list">' + todo.map(taskItemHTML).join('') + '</div>';
        if (done.length) html += '<div class="task-section-title">å®Œäº†æ¸ˆã¿</div><div class="task-list">' + done.map(taskItemHTML).join('') + '</div>';
      }
      container.innerHTML = html;

      container.querySelectorAll('.task-check').forEach(cb => {
        cb.addEventListener('change', () => {
          const ts = loadTasks();
          const idx = ts.findIndex(t => t.id === cb.dataset.id);
          if (idx !== -1) { ts[idx].done = cb.checked; saveTasks(ts); renderTaskList(); }
        });
      });
      container.querySelectorAll('.task-del').forEach(btn => {
        btn.addEventListener('click', () => {
          if (!confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
          saveTasks(loadTasks().filter(t => t.id !== btn.dataset.id));
          renderTaskList();
        });
      });
    }

    (function initTaskModal() {
      const modal    = document.getElementById('task-modal');
      const fab      = document.getElementById('fab-task');
      const closeBtn = document.getElementById('task-modal-close');
      const addBtn   = document.getElementById('task-add-btn');
      const titleIn  = document.getElementById('task-title-input');
      const memoIn   = document.getElementById('task-memo-input');

      function openTaskModal() {
        modal.classList.add('show');
        renderTaskList();
        setTimeout(() => titleIn.focus(), 100);
      }
      function closeTaskModal() {
        modal.classList.remove('show');
        titleIn.value = '';
        memoIn.value  = '';
      }

      fab.addEventListener('click', openTaskModal);
      closeBtn.addEventListener('click', closeTaskModal);
      modal.addEventListener('click', e => { if (e.target === modal) closeTaskModal(); });

      addBtn.addEventListener('click', () => {
        const title = titleIn.value.trim();
        if (!title) { toast('ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); titleIn.focus(); return; }
        const ts = loadTasks();
        ts.unshift({ id: Date.now().toString(), title, memo: memoIn.value.trim(), done: false, created: new Date().toISOString() });
        saveTasks(ts);
        titleIn.value = '';
        memoIn.value  = '';
        renderTaskList();
        toast('âœ… ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
      });

      titleIn.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); addBtn.click(); }
      });

      // fab-task ã¯ memo-modal / settings-modal ãŒé–‹ã„ã¦ã„ã‚‹ã¨ãéš ã™
      const fabToday = document.getElementById('fab-today');
      const hideOnOtherModal = new MutationObserver(() => {
        const anyOther = document.getElementById('memo-modal').classList.contains('show')
                      || document.getElementById('settings-modal').classList.contains('show');
        fab.classList.toggle('hidden', anyOther);
      });
      hideOnOtherModal.observe(document.getElementById('memo-modal'),     { attributes: true });
      hideOnOtherModal.observe(document.getElementById('settings-modal'), { attributes: true });

      // fab-today ã¯ task-modal ãŒé–‹ã„ã¦ã„ã‚‹ã¨ãéš ã™
      new MutationObserver(() => {
        const open = modal.classList.contains('show');
        fabToday.classList.toggle('hidden', open);
        fab.classList.toggle('hidden', open);
      }).observe(modal, { attributes: true });
    })();

    /* =====================================================
       EMERGENCY MODAL
       ===================================================== */
    (function initEmergencyModal() {
      const modal    = document.getElementById('emergency-modal');
      const closeBtn = document.getElementById('emergency-modal-close');
      const fabRecover = document.getElementById('fab-recover');
      const btnRecover = document.getElementById('btn-recover');
      const diagEl   = document.getElementById('em-diag');

      function openEmergencyModal() {
        modal.classList.add('show');
        // è¨ºæ–­æƒ…å ±ã‚’æ›´æ–°
        (async () => {
          try {
            let lines = [];
            // localStorage ã‚µã‚¤ã‚º
            let lsSize = 0;
            for (const k of Object.keys(localStorage)) lsSize += (localStorage.getItem(k) || '').length;
            lines.push(`LSä½¿ç”¨é‡: ${Math.round(lsSize/1024)}KB`);
            // IDBç¢ºèª
            const idbData = await idbLoad();
            const idbMonths = Object.keys(idbData?.months || {}).length;
            lines.push(`IDB: ${idbMonths}ãƒ¶æœˆåˆ†`);
            // ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
            const snaps = listSnapshots();
            lines.push(`ã‚¹ãƒŠãƒƒãƒ—: ${snaps.length}ä»¶`);
            if (snaps.length > 0) {
              const d = new Date(snaps[0].ts);
              lines.push(`  æœ€æ–°: ${d.toLocaleDateString('ja')} ${d.toLocaleTimeString('ja')}`);
              lines.push(`  ãƒ‡ãƒ¼ã‚¿: ${snaps[0].months}ãƒ¶æœˆåˆ†`);
            }
            // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
            const errs = JSON.parse(localStorage.getItem(_ERR_KEY) || '[]');
            lines.push(`ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°: ${errs.length}ä»¶`);
            if (errs.length > 0) {
              lines.push(`  æœ€æ–°: ${errs[0].type} (${errs[0].ts.slice(0,16)})`);
            }
            // ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã‚«ã‚¦ãƒ³ãƒˆ
            lines.push(`ã‚¯ãƒ©ãƒƒã‚·ãƒ¥: ${localStorage.getItem(_CRASH_KEY) || '0'}å›`);
            diagEl.textContent = lines.join('\n');
          } catch(e) {
            diagEl.textContent = 'è¨ºæ–­æƒ…å ±ã®å–å¾—ã«å¤±æ•—: ' + e.message;
          }
        })();
      }

      function closeEmergencyModal() {
        modal.classList.remove('show');
      }

      if (fabRecover) fabRecover.addEventListener('click', openEmergencyModal);
      if (btnRecover) btnRecover.addEventListener('click', openEmergencyModal);
      closeBtn.addEventListener('click', closeEmergencyModal);
      modal.addEventListener('click', e => { if (e.target === modal) closeEmergencyModal(); });

      // SWå¼·åˆ¶æ›´æ–°
      document.getElementById('em-sw-reload').addEventListener('click', async () => {
        try {
          const regs = await navigator.serviceWorker.getRegistrations();
          for (const r of regs) await r.update();
          toast('âœ… Service Worker ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        } catch(e) { toast('SWæ›´æ–°å¤±æ•—: ' + e.message); }
        closeEmergencyModal();
        runHealthCheck();
      });

      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»SWã‚¯ãƒªã‚¢ï¼ˆãƒ‡ãƒ¼ã‚¿ä¿æŒï¼‰
      document.getElementById('em-cache-clear').addEventListener('click', async () => {
        if (!confirm('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨Service Workerã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã€‚\nãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã¾ã™ã€‚')) return;
        try {
          const regs = await navigator.serviceWorker.getRegistrations();
          for (const r of regs) await r.unregister();
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
          toast('âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»SWã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ â€” å†èª­è¾¼ã—ã¾ã™');
          setTimeout(() => location.reload(), 1200);
        } catch(e) { toast('ã‚¯ãƒªã‚¢å¤±æ•—: ' + e.message); }
      });

      // ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‹ã‚‰å¾©å…ƒ
      document.getElementById('em-snap-restore').addEventListener('click', () => {
        const snap = loadLatestSnapshot();
        if (!snap) { toast('âš ï¸ å¾©å…ƒã§ãã‚‹ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“'); return; }
        const d = new Date(snap.meta.ts);
        const fmt = `${d.toLocaleDateString('ja')} ${d.toLocaleTimeString('ja')}`;
        if (!confirm(`ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼ˆ${fmt}ã€${snap.meta.months}ãƒ¶æœˆåˆ†ï¼‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ\nç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚`)) return;
        try {
          localStorage.setItem(STORE_KEY, JSON.stringify(snap.data));
          idbSave(snap.data);
          toast('âœ… ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸ â€” å†èª­è¾¼ã—ã¾ã™');
          closeEmergencyModal();
          setTimeout(() => location.reload(), 1200);
        } catch(e) { toast('å¾©å…ƒå¤±æ•—: ' + e.message); }
      });

      // å…¨ãƒ‡ãƒ¼ã‚¿æ¶ˆå»ãƒªã‚»ãƒƒãƒˆï¼ˆPINèªè¨¼ â†’ confirm ã®é †ï¼‰
      document.getElementById('em-full-reset').addEventListener('click', async () => {
        // â‘  ã¾ãšPIN/DELETEèªè¨¼ï¼ˆæœ€åˆã«å£ã‚’è¨­ã‘ã‚‹ï¼‰
        const pinOk = await requirePin('å…¨ãƒ‡ãƒ¼ã‚¿æ¶ˆå»ã—ã¦ãƒªã‚»ãƒƒãƒˆ');
        if (!pinOk) { toast('âŒ èªè¨¼å¤±æ•— â€” ãƒªã‚»ãƒƒãƒˆã‚’ä¸­æ­¢ã—ã¾ã—ãŸ'); return; }
        // â‘¡ èªè¨¼å¾Œã«æœ€çµ‚ç¢ºèªãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
        if (!confirm('âš ï¸ å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚€å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚\næœ¬å½“ã«ã‚ˆã„ã§ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;
        if (!confirm('æœ€çµ‚ç¢ºèªï¼šæœ¬å½“ã«ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        try {
          const regs = await navigator.serviceWorker.getRegistrations();
          for (const r of regs) await r.unregister();
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
          localStorage.clear();
          indexedDB.deleteDatabase(IDB_NAME);
          toast('âœ… å…¨ãƒªã‚»ãƒƒãƒˆå®Œäº† â€” å†èª­è¾¼ã—ã¾ã™');
          setTimeout(() => location.replace(location.pathname), 1200);
        } catch(e) { toast('ãƒªã‚»ãƒƒãƒˆå¤±æ•—: ' + e.message); }
      });

      // ç·Šæ€¥FABã¯ä»–ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ã‚‹ã¨ãéš ã™ï¼ˆé‚ªé­”ã«ãªã‚‰ãªã„ã‚ˆã†ï¼‰
      const hideObs = new MutationObserver(() => {
        const anyOpen = document.getElementById('memo-modal')?.classList.contains('show')
                     || document.getElementById('settings-modal')?.classList.contains('show')
                     || document.getElementById('task-modal')?.classList.contains('show');
        if (fabRecover) fabRecover.classList.toggle('hidden', anyOpen);
      });
      ['memo-modal','settings-modal','task-modal'].forEach(id => {
        const el = document.getElementById(id);
        if (el) hideObs.observe(el, { attributes: true });
      });
    })();

    /* =====================================================
       PIN AUTHENTICATION SYSTEM
       ===================================================== */
    const PIN_HASH_KEY = 'kintai_pin_hash';
    const PIN_FAIL_KEY = 'kintai_pin_fails';
    const PIN_LOCK_KEY = 'kintai_pin_lock';
    const PIN_MAX_FAILS = 3;
    const PIN_LOCKOUT_MS = 60000;

    async function sha256(text) {
      try {
        const data = new TextEncoder().encode(String(text));
        const hash = await crypto.subtle.digest('SHA-256', data);
        return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
      } catch(_) { return null; }
    }

    function isPinSet() { return !!localStorage.getItem(PIN_HASH_KEY); }
    function getPinLockUntil() { return Number(localStorage.getItem(PIN_LOCK_KEY) || 0); }
    function getPinFails() { return Number(localStorage.getItem(PIN_FAIL_KEY) || 0); }

    // Returns Promise<boolean>: true=authenticated, false=cancelled/failed
    function requirePin(purpose) {
      if (!isPinSet()) {
        // PINãŒæœªè¨­å®š â†’ "DELETE"å…¥åŠ›ã§ä»£æ›¿ç¢ºèªï¼ˆè¨­å®šã‚’ä¿ƒã™ï¼‰
        const label = purpose || 'ã“ã®å±é™ºãªæ“ä½œ';
        const msg = `ğŸ” PINæœªè¨­å®š\n\nã€Œ${label}ã€\n\nâš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£PINãŒæœªè¨­å®šã®ãŸã‚ã€\næ–‡å­—ç¢ºèªã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚\n\nç¶šè¡Œã™ã‚‹ã«ã¯ã€ŒDELETEã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\nï¼ˆè¨­å®š âš™ï¸ â†’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£PIN ã§äº‹å‰è¨­å®šã‚’æ¨å¥¨ï¼‰`;
        const input = prompt(msg);
        return Promise.resolve(input === 'DELETE');
      }
      return new Promise(resolve => {
        const modal    = document.getElementById('pin-modal');
        const purposeEl = document.getElementById('pin-purpose');
        const dotsEl   = document.getElementById('pin-dots');
        const errorEl  = document.getElementById('pin-error');
        const lockEl   = document.getElementById('pin-lock-msg');

        purposeEl.textContent = purpose || 'ã“ã®æ“ä½œã«ã¯PINãŒå¿…è¦ã§ã™';
        let pin = '', resolved = false, lockTimer = null;

        function updateDots() {
          dotsEl.querySelectorAll('.pin-dot').forEach((d, i) => d.classList.toggle('filled', i < pin.length));
        }

        function checkLockout() {
          const lockUntil = getPinLockUntil();
          if (lockUntil > Date.now()) {
            const rem = Math.ceil((lockUntil - Date.now()) / 1000);
            lockEl.textContent = `ğŸ”’ ${rem}ç§’å¾Œã«å†è©¦è¡Œã§ãã¾ã™`;
            return true;
          }
          lockEl.textContent = '';
          return false;
        }

        async function submitPin() {
          if (checkLockout()) return;
          if (pin.length < 4) { errorEl.textContent = '4æ¡ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„'; return; }
          const hash = await sha256(pin);
          const stored = localStorage.getItem(PIN_HASH_KEY);
          if (hash === stored) {
            localStorage.setItem(PIN_FAIL_KEY, '0');
            errorEl.textContent = '';
            cleanup(true);
          } else {
            const fails = getPinFails() + 1;
            localStorage.setItem(PIN_FAIL_KEY, String(fails));
            if (fails >= PIN_MAX_FAILS) {
              localStorage.setItem(PIN_LOCK_KEY, String(Date.now() + PIN_LOCKOUT_MS));
              localStorage.setItem(PIN_FAIL_KEY, '0');
              startLockTimer();
            }
            const rem = Math.max(0, PIN_MAX_FAILS - fails);
            errorEl.textContent = `âŒ PINãŒé•ã„ã¾ã™${rem > 0 ? `ï¼ˆæ®‹ã‚Š${rem}å›ï¼‰` : ''}`;
            pin = ''; updateDots();
          }
        }

        function startLockTimer() {
          clearInterval(lockTimer);
          lockTimer = setInterval(() => { if (!checkLockout()) clearInterval(lockTimer); }, 1000);
          checkLockout();
        }

        function onKey(k) {
          if (checkLockout()) return;
          if (k === 'del') { pin = pin.slice(0, -1); updateDots(); errorEl.textContent = ''; }
          else if (pin.length < 6) { pin += k; updateDots(); if (pin.length >= 4) submitPin(); }
        }

        function cleanup(ok) {
          if (resolved) return;
          resolved = true;
          clearInterval(lockTimer);
          modal.classList.remove('show');
          pin = ''; updateDots(); errorEl.textContent = '';
          resolve(ok);
        }

        modal.querySelectorAll('[data-key]').forEach(btn => { btn.onclick = () => onKey(btn.dataset.key); });
        document.getElementById('pin-key-del').onclick    = () => onKey('del');
        document.getElementById('pin-key-cancel').onclick = () => cleanup(false);
        document.getElementById('pin-modal-cancel').onclick = () => cleanup(false);
        modal.onclick = e => { if (e.target === modal) cleanup(false); };

        if (getPinLockUntil() > Date.now()) startLockTimer();
        pin = ''; updateDots(); errorEl.textContent = '';
        modal.classList.add('show');
      });
    }

    async function setupPin(newPin) {
      const hash = await sha256(newPin);
      if (!hash) { toast('PINè¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ'); return false; }
      localStorage.setItem(PIN_HASH_KEY, hash);
      localStorage.removeItem(PIN_FAIL_KEY);
      localStorage.removeItem(PIN_LOCK_KEY);
      return true;
    }

    function clearPin() {
      localStorage.removeItem(PIN_HASH_KEY);
      localStorage.removeItem(PIN_FAIL_KEY);
      localStorage.removeItem(PIN_LOCK_KEY);
    }

    function updatePinUI() {
      const set = isPinSet();
      const hint = document.getElementById('pin-status-hint');
      const clearBtn = document.getElementById('btn-clear-pin');
      if (hint) hint.textContent = set ? 'âœ… PINãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™' : 'âš ï¸ PINãŒæœªè¨­å®šã§ã™';
      if (clearBtn) clearBtn.style.display = set ? '' : 'none';
    }

    (function initPinSettings() {
      const btnSet   = document.getElementById('btn-set-pin');
      const btnClear = document.getElementById('btn-clear-pin');
      if (!btnSet) return;

      btnSet.addEventListener('click', async () => {
        if (isPinSet()) {
          const ok = await requirePin('ç¾åœ¨ã®PINã§èªè¨¼ã—ã¦ãã ã•ã„');
          if (!ok) return;
        }
        const p1 = prompt('æ–°ã—ã„PINã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ4ã€œ6æ¡ã®æ•°å­—ï¼‰');
        if (!p1 || !/^\d{4,6}$/.test(p1)) { toast('4ã€œ6æ¡ã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
        const p2 = prompt('ã‚‚ã†ä¸€åº¦å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆç¢ºèªï¼‰');
        if (p1 !== p2) { toast('âš ï¸ PINãŒä¸€è‡´ã—ã¾ã›ã‚“'); return; }
        await setupPin(p1);
        updatePinUI();
        toast('âœ… PINã‚’è¨­å®šã—ã¾ã—ãŸ');
      });

      btnClear.addEventListener('click', async () => {
        const ok = await requirePin('PINã‚’è§£é™¤ã™ã‚‹ã«ã¯ç¾åœ¨ã®PINã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        if (!ok) return;
        if (!confirm('PINã‚’è§£é™¤ã—ã¾ã™ã€‚ã‚ˆã„ã§ã™ã‹ï¼Ÿ')) return;
        clearPin();
        updatePinUI();
        toast('âœ… PINã‚’è§£é™¤ã—ã¾ã—ãŸ');
      });
    })();

    /* =====================================================
       TAB NAVIGATION
       ===================================================== */
    (function initTabs() {
      const tabs   = document.querySelectorAll('.tab-btn[data-tab]');
      const pages  = document.querySelectorAll('.tab-page');
      const calFabs = ['fab-today', 'fab-task', 'fab-recover'].map(id => document.getElementById(id));

      function switchTab(tabName) {
        tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === tabName));
        pages.forEach(p => p.classList.toggle('active', p.id === 'page-' + tabName));
        const isCal = (tabName === 'calendar');
        calFabs.forEach(f => f?.classList.toggle('hidden', !isCal));
        window.scrollTo({ top: 0, behavior: 'smooth' });
        if (tabName === 'hub')     renderLauncher();
        if (tabName === 'study')   renderStudy();
        if (tabName === 'project') renderProjects();
      }

      tabs.forEach(t => t.addEventListener('click', () => switchTab(t.dataset.tab)));
    })();

    /* =====================================================
       LAUNCHER / QUICK LINKS
       ===================================================== */
    const LAUNCHER_KEY = 'kintai_launcher_v1';
    const LAUNCHER_DEFAULTS = [
      { id: 'gcal',  name: 'Gã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼', url: 'https://calendar.google.com',        icon: 'ğŸ“†' },
      { id: 'gmail', name: 'Gmail',        url: 'https://mail.google.com',            icon: 'ğŸ“§' },
      { id: 'gdrive',name: 'Drive',        url: 'https://drive.google.com',           icon: 'ğŸ—‚' },
      { id: 'slack', name: 'Slack',        url: 'https://slack.com',                  icon: 'ğŸ’¬' },
    ];

    function loadLinks() {
      try {
        const r = localStorage.getItem(LAUNCHER_KEY);
        return r ? JSON.parse(r) : [...LAUNCHER_DEFAULTS];
      } catch { return [...LAUNCHER_DEFAULTS]; }
    }
    function saveLinks(links) { localStorage.setItem(LAUNCHER_KEY, JSON.stringify(links)); }

    function renderLauncher() {
      const grid = document.getElementById('links-grid');
      if (!grid) return;

      // jinjer ã‚«ãƒ¼ãƒ‰ã®URLã‚’configã‹ã‚‰å‹•çš„è¨­å®š
      const cfg = loadConfig();
      const jinjerUrl = cfg.jinjerUrl || 'https://kintai.jinjer.biz/staffs/top';
      const jinjerLink = document.getElementById('jinjer-link');
      if (jinjerLink) jinjerLink.href = jinjerUrl;

      // ä»Šæ—¥ã®æ‰“åˆ»çŠ¶æ³ã‚’PWAãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è¡¨ç¤º
      const bar = document.getElementById('jinjer-today-bar');
      const statusEl = document.getElementById('jinjer-today-status');
      if (bar && statusEl) {
        try {
          const today = new Date().toISOString().slice(0, 10);
          const store = loadStore();
          const ym = today.slice(0, 7);
          const day = store.months?.[ym]?.[today];
          if (day) {
            const stStr = day.start ? `ğŸŸ¢ ${day.start}` : 'æ‰“åˆ»ãªã—';
            const edStr = day.end   ? ` ã€œ ğŸ”´ ${day.end}` : '';
            const stLabel = day.status && day.status !== 'æœª' ? `ã€${day.status}ã€‘ ` : '';
            statusEl.textContent = stLabel + stStr + edStr;
            bar.style.display = '';
          } else {
            bar.style.display = 'none';
          }
        } catch(_) { bar.style.display = 'none'; }
      }

      const links = loadLinks();
      grid.innerHTML = links.map(l => `
        <div class="link-tile-wrap">
          <a href="${_esc(l.url)}" target="_blank" rel="noopener" class="link-tile" title="${_esc(l.name)}">
            <div class="link-tile-icon">${l.icon || 'ğŸ”—'}</div>
            <div>${_esc(l.name)}</div>
          </a>
          <span class="link-tile-del" data-id="${_esc(l.id)}" title="å‰Šé™¤">Ã—</span>
        </div>`).join('') +
        `<div class="link-tile-wrap">
          <button class="link-tile link-tile-add" id="btn-add-link" style="background:rgba(255,255,255,0.5);border:1.5px dashed rgba(180,190,220,0.7);color:var(--text-muted);">
            <div class="link-tile-icon">â•</div><div>è¿½åŠ </div>
          </button>
        </div>`;

      grid.querySelectorAll('.link-tile-del').forEach(btn => {
        btn.addEventListener('click', e => {
          e.preventDefault(); e.stopPropagation();
          saveLinks(loadLinks().filter(l => l.id !== btn.dataset.id));
          renderLauncher();
        });
      });
      document.getElementById('btn-add-link')?.addEventListener('click', showAddLinkDialog);
    }

    function showAddLinkDialog() {
      const name = prompt('ãƒªãƒ³ã‚¯åï¼ˆä¾‹: è³‡æ ¼ã‚¢ãƒ—ãƒªã€ç¤¾å†…Wikiï¼‰');
      if (!name?.trim()) return;
      const url = prompt('URLï¼ˆä¾‹: https://example.comï¼‰');
      if (!url?.trim() || !url.startsWith('http')) { toast('æ­£ã—ã„URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆhttps://ã€œï¼‰'); return; }
      const icon = prompt('çµµæ–‡å­—ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆä¾‹: ğŸ“ ï¼‰', 'ğŸ”—') || 'ğŸ”—';
      saveLinks([...loadLinks(), { id: Date.now().toString(), name: name.trim(), url: url.trim(), icon: icon.trim().slice(0, 2) }]);
      renderLauncher();
      toast('âœ… ãƒªãƒ³ã‚¯ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
    }

    /* =====================================================
       STUDY / CERTIFICATION TRACKER
       ===================================================== */
    const STUDY_KEY = 'kintai_study_v1';
    const STUDY_COLORS = ['#7c5fe6','#4f8dfd','#2e7d32','#ef6c00','#c62828','#1565c0','#00838f'];

    function loadStudy() {
      try { const r = localStorage.getItem(STUDY_KEY); return r ? JSON.parse(r) : []; } catch { return []; }
    }
    function saveStudy(d) { localStorage.setItem(STUDY_KEY, JSON.stringify(d)); }

    function renderStudy() {
      const container = document.getElementById('study-list');
      if (!container) return;

      // ä»Šé€±ã‚µãƒãƒªãƒ¼
      const weekSummary = document.getElementById('study-week-summary');
      if (weekSummary) {
        const today = new Date();
        const dow   = today.getDay(); // 0=Sun
        const weekDates = Array.from({ length: 7 }, (_, i) => {
          const d = new Date(today);
          d.setDate(today.getDate() - dow + i);
          return d.toISOString().slice(0, 10);
        });
        const allStudy = loadStudy();
        let weekTotal = 0;
        weekDates.forEach(dt => {
          allStudy.forEach(s => {
            weekTotal += (s.logs || []).filter(l => l.date === dt).reduce((a, l) => a + l.hours, 0);
          });
        });
        const dayTotals = weekDates.map(dt => {
          let h = 0;
          allStudy.forEach(s => { h += (s.logs || []).filter(l => l.date === dt).reduce((a, l) => a + l.hours, 0); });
          return { dt, h };
        });
        const dayNames = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
        const maxH = Math.max(...dayTotals.map(d => d.h), 1);
        weekSummary.innerHTML = `
          <div style="width:100%;">
            <div style="display:flex;align-items:flex-end;gap:4px;height:48px;margin-bottom:4px;">
              ${dayTotals.map(({ dt, h }, i) => {
                const isToday = dt === today.toISOString().slice(0,10);
                const barH = Math.round((h / maxH) * 40);
                return `<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;">
                  <div style="font-size:9px;color:var(--text-muted);font-weight:700;">${h > 0 ? h + 'h' : ''}</div>
                  <div style="width:100%;height:${Math.max(barH,2)}px;background:${isToday ? 'var(--accent-purple)' : 'var(--accent-blue)'};border-radius:3px;opacity:${h > 0 ? 1 : 0.15};"></div>
                  <div style="font-size:9px;color:${isToday ? 'var(--accent-blue)' : 'var(--text-muted)'};font-weight:${isToday ? '900' : '600'};">${dayNames[new Date(dt+'T00:00:00').getDay()]}</div>
                </div>`;
              }).join('')}
            </div>
            <div style="font-size:11px;color:var(--text-muted);text-align:right;">ä»Šé€±åˆè¨ˆ: <strong style="color:var(--accent-purple);">${weekTotal.toFixed(1)}h</strong></div>
          </div>`;
      }

      const data = loadStudy();
      if (!data.length) {
        container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:24px 0 16px;font-size:13px;line-height:1.8;">è³‡æ ¼ãƒ»å­¦ç¿’ç›®æ¨™ã‚’è¿½åŠ ã—ã¦ãã ã•ã„<br>è©¦é¨“æ—¥ãƒ»ç›®æ¨™æ™‚é–“ãƒ»é€²æ—ã‚’ç®¡ç†ã§ãã¾ã™</div>';
        return;
      }
      container.innerHTML = data.map(s => {
        const total  = (s.logs || []).reduce((sum, l) => sum + (l.hours || 0), 0);
        const target = s.targetHours || 100;
        const pct    = Math.min(100, Math.round(total / target * 100));
        let cdText = '', cdStyle = '';
        if (s.examDate) {
          const days = Math.ceil((new Date(s.examDate) - new Date()) / 86400000);
          if      (days > 0)  { cdText = `ã‚ã¨${days}æ—¥`; cdStyle = days <= 30 ? 'background:#ffebee;color:#c62828' : days <= 60 ? 'background:#fff8e1;color:#ef6c00' : 'background:#e8f5e9;color:#2e7d32'; }
          else if (days === 0){ cdText = 'ä»Šæ—¥ï¼'; cdStyle = 'background:#ffebee;color:#c62828'; }
          else                { cdText = `${-days}æ—¥çµŒé`; cdStyle = 'background:#f4f4f6;color:#888'; }
        }
        const today = new Date().toISOString().slice(0,10);
        const todayH = (s.logs || []).filter(l => l.date === today).reduce((sum, l) => sum + l.hours, 0);
        return `<div class="study-item" data-id="${s.id}">
          <div class="study-header">
            <div class="study-color-dot" style="background:${s.color};"></div>
            <div class="study-name">${_esc(s.name)}</div>
            ${cdText ? `<span class="study-countdown" style="${cdStyle};">${cdText}</span>` : ''}
            <button class="study-del-btn" data-id="${s.id}" title="å‰Šé™¤">ğŸ—‘</button>
          </div>
          <div class="study-progress-wrap"><div class="study-progress-fill" style="width:${pct}%;background:${s.color};"></div></div>
          <div class="study-stats">
            <span>ğŸ“– ${total.toFixed(1)}h / ${target}h${todayH > 0 ? ` (ä»Šæ—¥+${todayH}h)` : ''}</span>
            <span style="font-weight:800;color:${s.color};">${pct}%</span>
          </div>
          <div class="study-today">
            <input type="number" class="study-hours-input" data-id="${s.id}" min="0" max="24" step="0.25" placeholder="ä»Šæ—¥ã®æ™‚é–“">
            <button class="study-add-btn" data-id="${s.id}">ï¼‹ è¿½è¨˜</button>
          </div>
        </div>`;
      }).join('');

      container.querySelectorAll('.study-del-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          if (!confirm('ã“ã®è³‡æ ¼ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
          saveStudy(loadStudy().filter(s => s.id !== btn.dataset.id));
          renderStudy();
        });
      });
      container.querySelectorAll('.study-add-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id    = btn.dataset.id;
          const input = container.querySelector(`.study-hours-input[data-id="${id}"]`);
          const hours = parseFloat(input?.value || '0');
          if (!hours || hours <= 0) { toast('æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
          const data = loadStudy(), idx = data.findIndex(s => s.id === id);
          if (idx === -1) return;
          if (!data[idx].logs) data[idx].logs = [];
          data[idx].logs.push({ date: new Date().toISOString().slice(0,10), hours });
          saveStudy(data);
          if (input) input.value = '';
          renderStudy();
          toast(`âœ… ${hours}h ã‚’è¿½è¨˜ã—ã¾ã—ãŸ`);
        });
      });
    }

    document.getElementById('btn-add-study')?.addEventListener('click', () => {
      const name = prompt('è³‡æ ¼ãƒ»å­¦ç¿’åï¼ˆä¾‹: å¿œç”¨æƒ…å ±æŠ€è¡“è€…è©¦é¨“ï¼‰');
      if (!name?.trim()) return;
      const targetStr = prompt('ç›®æ¨™å­¦ç¿’æ™‚é–“ï¼ˆæ™‚é–“ã€ä¾‹: 200ï¼‰', '100');
      const target = parseFloat(targetStr || '100') || 100;
      const examDate = prompt('è©¦é¨“æ—¥ï¼ˆYYYY-MM-DDå½¢å¼ã€ãªã‘ã‚Œã°ç©ºæ¬„ï¼‰') || '';
      const data = loadStudy();
      data.push({ id: Date.now().toString(), name: name.trim(), targetHours: target, examDate: examDate.trim(), color: STUDY_COLORS[data.length % STUDY_COLORS.length], logs: [] });
      saveStudy(data);
      renderStudy();
      toast('âœ… è³‡æ ¼ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
    });

    /* =====================================================
       PROJECT TRACKER
       ===================================================== */
    const PROJECT_KEY = 'kintai_projects_v1';
    const PROJECT_STATUSES = ['æœªç€æ‰‹', 'é€²è¡Œä¸­', 'å®Œäº†', 'ä¿ç•™'];

    function loadProjects() {
      try { const r = localStorage.getItem(PROJECT_KEY); return r ? JSON.parse(r) : []; } catch { return []; }
    }
    function saveProjects(p) { localStorage.setItem(PROJECT_KEY, JSON.stringify(p)); }

    function renderProjects() {
      const container = document.getElementById('project-list');
      if (!container) return;
      const projects = loadProjects();

      // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰
      const summaryEl = document.getElementById('project-summary');
      if (summaryEl) {
        const counts = { æœªç€æ‰‹: 0, é€²è¡Œä¸­: 0, å®Œäº†: 0, ä¿ç•™: 0 };
        let avgPct = 0;
        projects.forEach(p => { counts[p.status || 'æœªç€æ‰‹']++; avgPct += (p.progress || 0); });
        if (projects.length) avgPct = Math.round(avgPct / projects.length);
        const chips = [
          { label: 'é€²è¡Œä¸­', val: counts['é€²è¡Œä¸­'], cls: 'stat-office' },
          { label: 'å®Œäº†',   val: counts['å®Œäº†'],   cls: 'stat-home' },
          { label: 'æœªç€æ‰‹', val: counts['æœªç€æ‰‹'],  cls: 'stat-weekly-toggle' },
          { label: 'ä¿ç•™',   val: counts['ä¿ç•™'],    cls: 'stat-off' },
          { label: 'å¹³å‡é€²æ—', val: avgPct + '%',   cls: 'stat-hours' },
        ];
        summaryEl.innerHTML = chips.map(c =>
          `<span class="stat-chip ${c.cls}">${c.label} <b>${c.val}</b></span>`
        ).join('');
      }
      if (!projects.length) {
        container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:24px 0 16px;font-size:13px;line-height:1.8;">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„<br>é€²æ—ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»æœŸé™ã‚’ä¸€å…ƒç®¡ç†ã§ãã¾ã™</div>';
        return;
      }
      container.innerHTML = projects.map(p => {
        let dlStr = '';
        if (p.deadline) {
          const d = Math.ceil((new Date(p.deadline) - new Date()) / 86400000);
          if      (d > 0)  dlStr = `â° ã‚ã¨${d}æ—¥`;
          else if (d === 0) dlStr = 'âš ï¸ ä»Šæ—¥ãŒæœŸé™';
          else              dlStr = `âš ï¸ ${-d}æ—¥è¶…é`;
        }
        return `<div class="project-item" data-id="${p.id}">
          <div class="project-header">
            <div class="project-name">${_esc(p.name)}</div>
            <span class="project-status-badge project-status-${_esc(p.status || 'æœªç€æ‰‹')}">${_esc(p.status || 'æœªç€æ‰‹')}</span>
            <button class="project-del-btn" data-id="${p.id}" title="å‰Šé™¤">ğŸ—‘</button>
          </div>
          <div class="project-progress-wrap"><div class="project-progress-fill" style="width:${p.progress || 0}%;" id="proj-fill-${p.id}"></div></div>
          <div class="project-footer">
            <span style="font-size:11px;">${dlStr}</span>
            <div style="display:flex;align-items:center;gap:8px;">
              <input type="range" min="0" max="100" value="${p.progress || 0}"
                class="project-progress-range" data-id="${p.id}"
                style="width:80px;accent-color:var(--accent-blue);">
              <span style="font-weight:800;color:var(--text-main);min-width:32px;" id="proj-pct-${p.id}">${p.progress || 0}%</span>
              <select class="project-status-select" data-id="${p.id}"
                style="padding:3px 6px;border-radius:8px;border:1px solid var(--border-soft);font-size:11px;font-family:inherit;">
                ${PROJECT_STATUSES.map(s => `<option${s === (p.status || 'æœªç€æ‰‹') ? ' selected' : ''}>${s}</option>`).join('')}
              </select>
            </div>
          </div>
        </div>`;
      }).join('');

      container.querySelectorAll('.project-progress-range').forEach(range => {
        range.addEventListener('input', () => {
          const id = range.dataset.id, pct = parseInt(range.value);
          const pctEl  = document.getElementById(`proj-pct-${id}`);
          const fillEl = document.getElementById(`proj-fill-${id}`);
          if (pctEl)  pctEl.textContent  = pct + '%';
          if (fillEl) fillEl.style.width = pct + '%';
        });
        range.addEventListener('change', () => {
          const projects = loadProjects(), idx = projects.findIndex(p => p.id === range.dataset.id);
          if (idx !== -1) { projects[idx].progress = parseInt(range.value); saveProjects(projects); }
        });
      });
      container.querySelectorAll('.project-status-select').forEach(sel => {
        sel.addEventListener('change', () => {
          const projects = loadProjects(), idx = projects.findIndex(p => p.id === sel.dataset.id);
          if (idx !== -1) { projects[idx].status = sel.value; saveProjects(projects); renderProjects(); }
        });
      });
      container.querySelectorAll('.project-del-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          if (!confirm('ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
          saveProjects(loadProjects().filter(p => p.id !== btn.dataset.id));
          renderProjects();
        });
      });
    }

    document.getElementById('btn-add-project')?.addEventListener('click', () => {
      const name = prompt('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå');
      if (!name?.trim()) return;
      const deadline = prompt('æœŸé™ï¼ˆYYYY-MM-DDå½¢å¼ã€ãªã‘ã‚Œã°ç©ºæ¬„ï¼‰') || '';
      const projects = loadProjects();
      projects.push({ id: Date.now().toString(), name: name.trim(), deadline: deadline.trim(), progress: 0, status: 'æœªç€æ‰‹' });
      saveProjects(projects);
      renderProjects();
      toast('âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸ');
    });

    /* =====================================================
       SERVICE WORKER
       ===================================================== */
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(err => {
        console.warn('ServiceWorker registration failed:', err);
      });
    }
  </script>
</body>
</html>
