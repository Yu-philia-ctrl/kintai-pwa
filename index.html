<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Âã§ÊÄ†„Ç´„É¨„É≥„ÉÄ„Éº</title>

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Âã§ÊÄ†">
  <link rel="apple-touch-icon" href="icon-apple.png">

  <!-- Android / General PWA -->
  <meta name="theme-color" content="#7c5fe6">
  <link rel="manifest" href="manifest.json">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; connect-src 'self' https://api.open-meteo.com https://geocoding-api.open-meteo.com http:;">
  <!-- „É™„ÇΩ„Éº„Çπ„Éí„É≥„Éà: xlsxÈÅÖÂª∂„É≠„Éº„ÉâÊôÇ„ÅÆDNS/TCPÂæÖÊ©ü„Çí‰∫ãÂâç„Å´Ëß£Ê∂à -->
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <!-- xlsx „ÅØ ExcelÂá∫Âäõ„Éú„Çø„É≥Êäº‰∏ãÊôÇ„Å´ÈÅÖÂª∂„É≠„Éº„ÉâÔºàiOS OOMÂØæÁ≠ñÔºâ -->

  <style>
    :root {
      --bg-page: #eef1fb;
      --bg-card: rgba(255,255,255,0.82);
      --bg-card-solid: #ffffff;
      --border-soft: rgba(180,190,220,0.5);
      --border-color: rgba(180,190,220,0.5);
      --accent-blue: #4f8dfd;
      --accent-purple: #7c5fe6;
      --text-main: #1a1c2e;
      --text-muted: #8890a0;
      --radius-card: 28px;
      --glass-blur: blur(22px) saturate(1.4);
      --shadow-card: 0 8px 40px rgba(60,80,200,0.09), 0 1px 0 rgba(255,255,255,0.7) inset;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --tab-bar-h: 60px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: calc(max(var(--safe-top), 12px)) 12px calc(max(var(--safe-bottom), 0px) + var(--tab-bar-h) + 16px);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      background: linear-gradient(145deg, #d8e8ff 0%, #e8ddff 45%, #ffd8f0 100%) fixed;
      color: var(--text-main);
      min-height: 100dvh;
    }

    /* ======= CARD ======= */
    .card {
      max-width: 960px;
      margin: 0 auto;
      background: var(--bg-card);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border-radius: var(--radius-card);
      border: 1px solid rgba(255,255,255,0.65);
      box-shadow: var(--shadow-card);
      padding: 16px 16px 12px;
      position: relative;
      overflow: hidden;
    }

    .card-title {
      font-size: 11px;
      font-weight: 800;
      margin-bottom: 10px;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    /* ======= HEADER ======= */
    .header-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }
    .header-left, .header-right {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .pill-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 7px 14px;
      font-size: 13px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.7);
      background: rgba(255,255,255,0.55);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      cursor: pointer;
      user-select: none;
      font-family: inherit;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .pill-button .icon { margin-right: 5px; font-size: 13px; }
    .pill-button-primary {
      background: #eef3ff;
      border-color: #c5d2ff;
      color: var(--accent-blue);
      font-weight: 600;
    }
    .pill-button-lock-on {
      background: #ffece5;
      border-color: #ffc1a6;
      color: #f57c00;
      font-weight: 800;
    }
    .month-label { font-size: 20px; font-weight: 800; letter-spacing: -.02em; }
    .nav-arrow {
      width: 32px; height: 32px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.7);
      background: rgba(255,255,255,0.5);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 17px;
      user-select: none;
      font-family: inherit;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    }
    .nav-arrow:active { transform: scale(0.93); }

    /* ======= CALENDAR ======= */
    .calendar-wrapper {
      margin-top: 8px;
      border-radius: 20px;
      overflow: hidden;
      border: 1px solid rgba(180,190,220,0.35);
      box-shadow: 0 2px 12px rgba(60,80,200,0.06);
    }
    table.calendar {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 11px;
    }
    table.calendar th {
      background: rgba(245,246,251,0.7);
      text-align: center;
      padding: 7px 0;
      color: var(--text-muted);
      font-weight: 700;
      font-size: 12px;
      letter-spacing: .02em;
    }
    table.calendar td {
      padding: 3px;
      background: #fff;
      vertical-align: top;
    }
    .day-card {
      border-radius: 14px;
      border: 1.5px solid #e3e7f0;
      padding: 5px 5px 26px;
      min-height: 60px;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 3px;
      background: #fbfbfe;
      transition: border-color 0.12s, box-shadow 0.12s, background 0.12s;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .day-card:active { transform: scale(0.98); }
    .day-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 3px;
    }
    .day-number {
      font-size: 12px;
      font-weight: 800;
      color: var(--text-main);
      min-width: 16px;
    }
    .day-number.sun { color: #c62828; }
    .day-number.sat { color: #1565c0; }
    .status-pill {
      flex: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid transparent;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 700;
      user-select: none;
    }
    .status-pill-Êú™    { background:#f4f4f6; color:var(--text-muted); border-color:#e0e0e5; }
    .status-pill-Âá∫Á§æ  { background:#e3f2fd; color:#1565c0; border-color:#bbdefb; }
    .status-pill-Âú®ÂÆÖ  { background:#e8f5e9; color:#2e7d32; border-color:#c8e6c9; }
    .status-pill-‰ºë„Åø  { background:#fff8e1; color:#ef6c00; border-color:#ffe0b2; }
    .status-pill-Á•ùÊó•  { background:#ffebee; color:#c62828; border-color:#ffcdd2; }
    .status-pill-‰ºëÊó•  { background:#ede7f6; color:#5e35b1; border-color:#d1c4e9; }

    .day-card-status-Êú™    { border-color:#e4e5f0; background:#fbfbfe; }
    .day-card-status-Âá∫Á§æ  { border-color:#8ab4ff; background:#eaf3ff; }
    .day-card-status-Âú®ÂÆÖ  { border-color:#7bc47f; background:#e9f7ec; }
    .day-card-status-‰ºë„Åø  { border-color:#ffb74d; background:#fff5e3; }
    .day-card-status-Á•ùÊó•  { border-color:#ef5350; background:#ffebee; }
    .day-card-status-‰ºëÊó•  { border-color:#b39ddb; background:#f3e5f5; }

    .dropdown-icon { font-size: 9px; padding-left: 3px; opacity:.7; }
    .memo-dot { font-size:11px; color:#ff9800; margin-left:3px; user-select:none; }
    .today-ring { box-shadow: 0 0 0 2px var(--accent-blue); }
    .selected-day { box-shadow: 0 0 0 2px var(--accent-blue); }
    .subline {
      font-size: 10px; color:#6b7280; line-height:1.2;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      user-select:none;
    }
    .holiday-name {
      font-size: 10px; color:#c62828; line-height:1.2;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      user-select:none;
    }
    .cell-actions {
      position:absolute; right:5px; bottom:5px;
      display:flex; gap:5px; z-index:2;
    }
    .mini-btn {
      border:1px solid rgba(0,0,0,0.08);
      background:rgba(255,255,255,0.9);
      backdrop-filter:blur(6px);
      -webkit-backdrop-filter:blur(6px);
      padding:3px 7px;
      border-radius:999px;
      font-size:10px; font-weight:900; color:#2563eb;
      cursor:pointer; user-select:none; line-height:1;
      box-shadow:0 4px 10px rgba(0,0,0,0.06);
      font-family:inherit;
    }
    .mini-btn:active { transform:scale(0.97); }
    .locked .day-card { opacity:0.55; }
    .locked .day-card { cursor:default; pointer-events:none; }

    /* ======= FOOTER ======= */
    .footer {
      margin-top: 8px;
      font-size: 10px;
      color: var(--text-muted);
      line-height: 1.4;
    }
    .legend span.badge {
      padding:2px 6px; border-radius:6px;
      margin-right:3px; font-weight:700; display:inline-block;
    }
    .badge-work   { background:#e3f2fd; color:#1565c0; }
    .badge-home   { background:#e8f5e9; color:#2e7d32; }
    .badge-holiday{ background:#fff8e1; color:#ef6c00; }
    .badge-shuku  { background:#ffebee; color:#c62828; }
    .badge-kyujitsu{ background:#ede7f6; color:#5e35b1; }

    .data-actions {
      margin-top: 8px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .data-btn {
      padding: 7px 13px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.7);
      background: rgba(255,255,255,0.65);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      cursor: pointer;
      user-select: none;
      font-weight: 700;
      font-family: inherit;
      color: var(--text-main);
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .data-btn:active { transform: scale(0.96); }

    /* ======= MODAL ======= */
    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 999;
    }
    .modal-backdrop.show { display: flex; }
    .modal-sheet {
      width: 100%;
      max-width: 560px;
      max-height: 92vh;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(28px) saturate(1.4);
      -webkit-backdrop-filter: blur(28px) saturate(1.4);
      border-radius: 26px 26px 0 0;
      border-top: 1px solid rgba(255,255,255,0.8);
      padding: 12px 16px calc(max(var(--safe-bottom), 14px));
      box-shadow: 0 -8px 36px rgba(60,80,200,0.13);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .modal-handle {
      width: 34px; height: 4px;
      border-radius: 999px; background: #d0d0d5;
      margin: 0 auto 10px;
    }
    .modal-header {
      display: flex; align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 13px; font-weight: 800;
    }
    .modal-close {
      font-size: 22px; line-height:1;
      cursor:pointer; color:var(--text-muted); user-select:none;
    }
    .modal-section-title {
      font-size:11px; color:var(--text-muted);
      margin-bottom:5px; font-weight:700;
    }
    .status-chip-row { display:flex; gap:5px; margin-bottom:10px; flex-wrap:wrap; }
    .status-chip {
      flex:1; min-width:56px;
      border-radius:999px; padding:8px 6px;
      font-size:12px; text-align:center;
      border:1px solid var(--border-soft);
      background:#f6f7fb;
      cursor:pointer; user-select:none; font-weight:700;
      font-family:inherit;
    }
    .status-chip.active {
      border-color:var(--accent-blue);
      background:#e3edff; color:var(--accent-blue);
    }
    .row-time { display:flex; gap:8px; align-items:center; margin-bottom:10px; }
    .time-input {
      flex:1; padding:10px 10px;
      border-radius:12px; border:1px solid var(--border-soft);
      font-size:14px; font-family:inherit; background:#fff;
    }
    .memo-textarea {
      width:100%; min-height:80px; resize:vertical;
      border-radius:12px; border:1px solid var(--border-soft);
      padding:10px; font-size:13px; font-family:inherit;
    }
    .dup-row { display:flex; gap:8px; margin:4px 0 10px; }
    .dup-row .btn-secondary { flex:1; }
    .obs-row { display:flex; gap:8px; margin:6px 0 4px; }
    .obs-row .btn-secondary { flex:1; }
    .modal-footer {
      margin-top:10px; display:flex;
      justify-content:flex-end; gap:10px; flex-shrink:0;
    }
    .btn-secondary {
      padding:10px 14px; font-size:13px;
      border-radius:999px; border:1px solid var(--border-soft);
      background:#f4f5f9; cursor:pointer; user-select:none;
      font-weight:700; font-family:inherit;
    }
    .btn-primary {
      padding:10px 20px; font-size:13px;
      border-radius:999px; border:none;
      background:linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
      color:#fff;
      font-weight:900; cursor:pointer; user-select:none;
      font-family:inherit;
      box-shadow: 0 4px 14px rgba(79,141,253,0.38);
    }
    .btn-primary:active { transform: scale(0.97); }

    /* ======= SETTINGS MODAL ======= */
    .settings-body { display:flex; flex-direction:column; gap:12px; overflow-y:auto; -webkit-overflow-scrolling:touch; flex:1; min-height:0; }
    .settings-row { display:flex; flex-direction:column; gap:5px; }
    .settings-label { font-size:12px; font-weight:700; color:var(--text-muted); }
    .settings-input {
      padding:10px; border-radius:12px;
      border:1px solid var(--border-soft);
      font-size:14px; font-family:inherit; background:#fff;
    }
    .settings-hint { font-size:11px; color:var(--text-muted); line-height:1.4; }

    /* ======= OVERLAY / SPINNER ======= */
    .overlay {
      position:absolute; inset:0;
      background:rgba(255,255,255,0.65);
      display:none; align-items:center; justify-content:center;
      z-index:50;
      backdrop-filter:blur(2px); -webkit-backdrop-filter:blur(2px);
    }
    .overlay.show { display:flex; }
    .spinner {
      width:28px; height:28px; border-radius:999px;
      border:3px solid rgba(79,141,253,0.25);
      border-top-color:rgba(79,141,253,1);
      animation:spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* ======= TOAST ======= */
    .toast {
      position:fixed; left:50%; bottom:calc(max(var(--safe-bottom), 20px) + 4px);
      transform:translateX(-50%);
      background:rgba(0,0,0,0.78); color:#fff;
      padding:10px 14px; border-radius:999px;
      font-size:12px; font-weight:700;
      z-index:2000; display:none;
      max-width:92vw; white-space:nowrap;
      overflow:hidden; text-overflow:ellipsis;
    }
    .toast.show { display:block; }

    /* ======= PROGRESS OVERLAY ======= */
    .progress-overlay {
      position:fixed; inset:0; z-index:3000;
      background:rgba(0,0,0,0.55);
      display:none; align-items:center; justify-content:center;
    }
    .progress-overlay.show { display:flex; }
    .progress-box {
      background:var(--bg-card); border-radius:18px;
      padding:24px 28px; min-width:260px; max-width:90vw;
      box-shadow:0 8px 32px rgba(0,0,0,0.25);
      display:flex; flex-direction:column; gap:14px; align-items:center;
    }
    .progress-title { font-size:15px; font-weight:800; color:var(--text-main); }
    .progress-step  { font-size:13px; color:var(--text-muted); text-align:center; line-height:1.6; }
    .progress-bar-wrap {
      width:100%; height:8px; background:var(--border-color);
      border-radius:999px; overflow:hidden;
    }
    .progress-bar-fill {
      height:100%; background:var(--accent-blue);
      border-radius:999px;
      transition:width 0.3s ease;
      width:0%;
    }
    .progress-spinner {
      width:32px; height:32px;
      border:3px solid var(--border-color);
      border-top-color:var(--accent-blue);
      border-radius:50%;
      animation:spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* ======= NETWORK STATUS BANNER ======= */
    .net-banner {
      position: fixed; top: calc(max(var(--safe-top), 0px));
      left: 0; right: 0; z-index: 4000;
      background: rgba(30,30,30,0.92);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      color: #fff; font-size: 13px; font-weight: 700;
      padding: 10px 16px; text-align: center;
      transform: translateY(-100%);
      transition: transform 0.35s cubic-bezier(0.4,0,0.2,1);
    }
    .net-banner.show  { transform: translateY(0); }
    .net-banner.online  { background: rgba(34,136,56,0.92); }
    .net-banner.offline { background: rgba(180,30,30,0.92); }

    /* ======= INSTALL BANNER ======= */
    .install-banner {
      background:#eef3ff; border:1px solid #c5d2ff;
      border-radius:14px; padding:10px 14px;
      margin-bottom:10px; font-size:12px;
      color:#1565c0; line-height:1.5;
      display:none;
    }
    .install-banner.show { display:block; }
    .install-banner strong { font-weight:800; }
    .install-close {
      float:right; cursor:pointer;
      font-size:18px; line-height:1; color:#1565c0;
      margin-left:8px;
    }

    /* ======= BACKUP BANNER ======= */
    .backup-banner {
      background:#fff8e1; border:1px solid #ffe0b2;
      border-radius:14px; padding:10px 14px;
      margin-bottom:10px; font-size:12px;
      color:#e65100; line-height:1.5; display:none;
    }
    .backup-banner.show { display:block; }
    .backup-banner-row {
      display:flex; align-items:center;
      justify-content:space-between; gap:8px;
    }
    .backup-banner-text { flex:1; }
    .backup-banner strong { font-weight:800; }
    .backup-now-btn {
      padding:7px 14px; font-size:12px; font-weight:800;
      border-radius:999px; border:none;
      background:#f57c00; color:#fff;
      cursor:pointer; white-space:nowrap;
      font-family:inherit;
    }
    .backup-dismiss {
      cursor:pointer; font-size:16px; opacity:.6;
      margin-left:4px; user-select:none;
    }

    /* ======= STATS BAR ======= */
    .stats-bar {
      display:flex; gap:5px; flex-wrap:wrap;
      padding:6px 0 8px;
      margin-bottom:4px;
    }
    .stat-chip {
      display:inline-flex; align-items:center; gap:4px;
      padding:4px 11px; border-radius:999px;
      font-size:11px; font-weight:700;
      border:1px solid rgba(255,255,255,0.65);
      box-shadow:0 1px 4px rgba(0,0,0,0.06);
    }
    .stat-chip b { font-size:13px; }
    .stat-office  { background:rgba(227,242,253,0.92); color:#1565c0; border-color:#bbdefb; }
    .stat-home    { background:rgba(232,245,233,0.92); color:#2e7d32; border-color:#c8e6c9; }
    .stat-off     { background:rgba(255,248,225,0.92); color:#ef6c00; border-color:#ffe0b2; }
    .stat-hours   { background:rgba(243,229,245,0.92); color:#6a1b9a; border-color:#e1bee7; }
    .stat-weekly-toggle {
      background:rgba(237,231,246,0.92); color:#5e35b1; border-color:#d1c4e9;
      cursor:pointer; font-family:inherit;
      transition:background 0.15s;
    }
    .stat-weekly-toggle:active { background:rgba(220,208,240,1); transform:scale(0.97); }

    /* ======= WEEKLY STATS (Êäò„Çä„Åü„Åü„Åø) ======= */
    .weekly-stats {
      font-size: 12px;
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.38s cubic-bezier(0.4,0,0.2,1), padding 0.2s;
      padding: 0;
    }
    .weekly-stats.open {
      max-height: 320px;
      padding: 8px 0 4px;
      border-top: 1px solid var(--border-soft);
      margin-bottom: 4px;
    }
    .weekly-stats table {
      width: 100%;
      border-collapse: collapse;
    }
    .weekly-stats td {
      padding: 4px 4px;
      vertical-align: middle;
    }
    .weekly-stats .w-label { color: var(--text-muted); min-width: 112px; font-size:11px; }
    .weekly-stats .w-hours { font-weight: 700; min-width: 60px; color: var(--text-main); }
    .weekly-stats .w-pm    { color: var(--accent-purple); font-weight: 800; text-align: right; white-space:nowrap; }
    .weekly-stats .w-bar-cell { width: 100%; padding-left: 8px; }
    .w-bar-bg  { background: rgba(124,95,230,0.12); border-radius: 4px; height: 7px; overflow: hidden; }
    .w-bar-fill{ background: linear-gradient(90deg,#7c5fe6,#a78bfa); height: 100%; border-radius: 4px; transition: width .45s ease; }

    /* ======= TASK FAB ======= */
    .fab-task {
      position:fixed;
      right: calc(max(env(safe-area-inset-right), 16px) + 62px);
      bottom: calc(max(env(safe-area-inset-bottom), 0px) + var(--tab-bar-h) + 20px);
      width:52px; height:52px;
      border-radius:999px;
      background:linear-gradient(135deg,#ff9800,#f06000);
      color:#fff; font-size:22px;
      border:none; cursor:pointer;
      box-shadow:0 4px 18px rgba(255,140,0,0.52);
      display:flex; align-items:center; justify-content:center;
      z-index:900;
      font-family:inherit;
      transition:opacity 0.2s, transform 0.15s;
    }
    .fab-task:active { transform:scale(0.93); }
    .fab-task.hidden { opacity:0; pointer-events:none; }

    /* ======= TASK MODAL ======= */
    .task-add-form { padding:12px 16px 4px; display:flex; flex-direction:column; gap:8px; }
    .task-add-input { padding:8px 10px; border:1.5px solid var(--border-color); border-radius:8px; font-size:15px; font-family:inherit; background:var(--bg-card); color:var(--text-main); outline:none; }
    .task-add-input:focus { border-color:var(--accent-blue); }
    .task-add-textarea { height:60px; resize:none; }
    .task-add-submit { background:var(--accent-blue); color:#fff; border:none; border-radius:8px; padding:9px; font-size:15px; font-weight:700; cursor:pointer; font-family:inherit; }
    .task-section-title { font-size:11px; font-weight:700; color:var(--text-muted); padding:8px 16px 2px; text-transform:uppercase; letter-spacing:.05em; }
    .task-list { padding:0 16px; }
    .task-item { display:flex; align-items:flex-start; gap:10px; padding:10px 0; border-bottom:1px solid var(--border-color); }
    .task-item:last-child { border-bottom:none; }
    .task-check { width:20px; height:20px; flex-shrink:0; margin-top:2px; cursor:pointer; accent-color:var(--accent-blue); }
    .task-body { flex:1; min-width:0; }
    .task-title { font-size:15px; font-weight:700; word-break:break-all; }
    .task-memo { font-size:12px; color:var(--text-muted); margin-top:3px; white-space:pre-wrap; word-break:break-all; }
    .task-item.done .task-title { text-decoration:line-through; opacity:0.5; }
    .task-item.done .task-memo { opacity:0.4; }
    .task-del { background:none; border:none; color:#e57373; font-size:18px; cursor:pointer; padding:0 4px; align-self:center; line-height:1; }
    .task-empty { text-align:center; color:var(--text-muted); padding:24px 0; font-size:14px; line-height:1.8; }

    /* ======= FLOATING TODAY BUTTON ======= */
    .fab-today {
      position:fixed;
      right: calc(max(env(safe-area-inset-right), 16px));
      bottom: calc(max(env(safe-area-inset-bottom), 0px) + var(--tab-bar-h) + 20px);
      width:52px; height:52px;
      border-radius:999px;
      background:linear-gradient(135deg,#4f8dfd,#7c5fe6);
      color:#fff; font-size:11px; font-weight:900;
      border:none; cursor:pointer;
      box-shadow:0 4px 18px rgba(79,141,253,0.52);
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      gap:1px; z-index:900;
      font-family:inherit;
      transition:opacity 0.2s, transform 0.15s;
    }
    .fab-today:active { transform:scale(0.93); }
    .fab-today .fab-day { font-size:18px; font-weight:900; line-height:1; }
    .fab-today .fab-label { font-size:9px; opacity:.85; }
    .fab-today.hidden { opacity:0; pointer-events:none; }

    /* ======= BOTTOM TAB NAVIGATION ======= */
    .bottom-tabs {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 800;
      background: rgba(255,255,255,0.94);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid rgba(180,190,220,0.35);
      display: flex;
      padding-bottom: env(safe-area-inset-bottom, 0);
      box-shadow: 0 -2px 20px rgba(60,80,200,0.08);
    }
    .tab-btn {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      padding: 8px 2px 6px; font-size: 9px; font-weight: 700;
      color: var(--text-muted); border: none; background: none;
      cursor: pointer; font-family: inherit; gap: 2px;
      transition: color 0.15s;
      -webkit-tap-highlight-color: transparent;
    }
    .tab-btn.active { color: var(--accent-blue); }
    .tab-icon { font-size: 20px; line-height: 1; }

    /* ======= TAB PAGES ======= */
    .tab-page { display: none; }
    .tab-page.active { display: block; }

    /* ======= HUB / LAUNCHER ======= */
    .jinjer-card {
      display: flex; align-items: center; gap: 14px;
      background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
      border-radius: 20px; padding: 18px 20px;
      color: #fff; cursor: pointer; text-decoration: none;
      box-shadow: 0 6px 28px rgba(21,101,192,0.38);
      margin-bottom: 12px; user-select: none;
      -webkit-tap-highlight-color: transparent;
      transition: transform 0.15s, opacity 0.15s;
    }
    .jinjer-card:active { transform: scale(0.98); opacity: 0.9; }
    .jinjer-icon { font-size: 38px; }
    .jinjer-info { flex: 1; }
    .jinjer-label { font-size: 18px; font-weight: 900; }
    .jinjer-sub   { font-size: 12px; opacity: 0.82; margin-top: 3px; }
    .jinjer-arrow { font-size: 22px; opacity: 0.7; }
    .links-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(76px, 1fr));
      gap: 10px; margin-bottom: 12px;
    }
    .link-tile-wrap { position: relative; }
    .link-tile {
      display: flex; flex-direction: column; align-items: center;
      gap: 6px; padding: 12px 6px;
      background: var(--bg-card); border-radius: 16px;
      border: 1px solid var(--border-soft);
      cursor: pointer; text-decoration: none;
      font-size: 11px; font-weight: 700; color: var(--text-main);
      text-align: center; width: 100%;
      -webkit-tap-highlight-color: transparent;
      transition: transform 0.12s;
    }
    .link-tile:active { transform: scale(0.94); }
    .link-tile-icon { font-size: 26px; }
    .link-tile-add {
      border: 1.5px dashed rgba(180,190,220,0.7);
      background: rgba(255,255,255,0.4); color: var(--text-muted); border: none;
    }
    .link-tile-del {
      position: absolute; top: 3px; right: 3px; font-size: 16px;
      color: #e57373; line-height: 1; cursor: pointer; z-index: 2;
      background: rgba(255,255,255,0.9); border-radius: 50%;
      width: 18px; height: 18px; display: flex; align-items: center; justify-content: center;
      font-size: 12px; font-weight: 900;
    }

    /* ======= STUDY TRACKER ======= */
    .study-item {
      background: var(--bg-card-solid); border-radius: 16px;
      border: 1px solid var(--border-soft);
      padding: 14px 14px 12px; margin-bottom: 10px;
    }
    .study-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .study-color-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
    .study-name { font-size: 15px; font-weight: 800; flex: 1; }
    .study-countdown {
      font-size: 10px; font-weight: 800; padding: 2px 8px;
      border-radius: 999px; white-space: nowrap;
    }
    .study-progress-wrap {
      height: 8px; background: #f0f0f5; border-radius: 999px;
      overflow: hidden; margin-bottom: 6px;
    }
    .study-progress-fill { height: 100%; border-radius: 999px; transition: width 0.4s ease; }
    .study-stats { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted); }
    .study-today { display: flex; align-items: center; gap: 8px; margin-top: 10px; }
    .study-hours-input {
      width: 72px; padding: 6px 8px; border-radius: 8px;
      border: 1px solid var(--border-soft); font-size: 14px;
      font-family: inherit; text-align: center;
    }
    .study-add-btn {
      flex: 1; padding: 7px; border: none; border-radius: 8px;
      background: var(--accent-blue); color: #fff; font-weight: 700;
      font-size: 12px; cursor: pointer; font-family: inherit;
    }
    .study-del-btn { background: none; border: none; color: #e57373; font-size: 16px; cursor: pointer; padding: 0 4px; }

    /* ======= PROJECT TRACKER ======= */
    .project-item {
      background: var(--bg-card-solid); border-radius: 16px;
      border: 1px solid var(--border-soft);
      padding: 12px 14px; margin-bottom: 8px;
    }
    .project-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .project-status-badge { font-size: 10px; font-weight: 800; padding: 2px 8px; border-radius: 999px; }
    .project-status-Êú™ÁùÄÊâã { background: #f4f4f6; color: var(--text-muted); }
    .project-status-ÈÄ≤Ë°å‰∏≠ { background: #e3f2fd; color: #1565c0; }
    .project-status-ÂÆå‰∫Ü   { background: #e8f5e9; color: #2e7d32; }
    .project-status-‰øùÁïô   { background: #fff8e1; color: #ef6c00; }
    .project-name { font-size: 14px; font-weight: 800; flex: 1; min-width: 0; word-break: break-all; }
    .project-progress-wrap {
      height: 6px; background: #f0f0f5; border-radius: 999px;
      overflow: hidden; margin-bottom: 6px;
    }
    .project-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
      border-radius: 999px; transition: width 0.4s;
    }
    .project-footer { display: flex; justify-content: space-between; align-items: center; font-size: 11px; color: var(--text-muted); gap: 8px; flex-wrap: wrap; }
    .project-del-btn { background: none; border: none; color: #e57373; font-size: 15px; cursor: pointer; padding: 0; flex-shrink: 0; }

    /* ======= CALENDAR WEATHER STRIP ======= */
    .cal-weather-strip {
      display: flex; align-items: center; gap: 10px;
      background: linear-gradient(135deg, #e3f2fd 0%, #ede7f6 100%);
      border-radius: 14px; padding: 9px 13px;
      border: 1px solid rgba(124,95,230,0.15);
      -webkit-tap-highlight-color: transparent;
    }
    .cal-w-emoji { font-size: 28px; line-height: 1; flex-shrink: 0; }
    .cal-weather-info { flex: 1; min-width: 0; }
    .cal-w-cond { font-size: 13px; font-weight: 800; color: var(--text-main); }
    .cal-w-sub  { font-size: 10px; color: var(--text-muted); margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .cal-w-temps { font-size: 15px; font-weight: 900; color: var(--text-main); white-space: nowrap; flex-shrink: 0; }
    .cal-outfit-btn {
      flex-shrink: 0;
      background: linear-gradient(135deg, #7c5fe6, #4f8dfd);
      color: #fff; border: none; border-radius: 999px;
      padding: 5px 11px; font-size: 11px; font-weight: 800;
      cursor: pointer; font-family: inherit; white-space: nowrap;
      -webkit-tap-highlight-color: transparent; transition: opacity 0.15s;
    }
    .cal-outfit-btn:active { opacity: 0.8; }

    /* ======= WEATHER FORECAST ======= */
    .weather-card-wrap { margin-bottom: 10px; }
    .weather-loading { text-align: center; color: var(--text-muted); font-size: 13px; padding: 18px 0; }
    .weather-loc { font-size: 11px; color: var(--text-muted); font-weight: 700; letter-spacing: 0.04em; margin-bottom: 8px; }
    .weather-main-row {
      display: flex; align-items: center; gap: 14px;
      background: linear-gradient(135deg, #1b6ca8 0%, #2980b9 60%, #6dd5fa 100%);
      border-radius: 20px; padding: 16px 18px; color: #fff; margin-bottom: 10px;
    }
    .weather-big-emoji { font-size: 52px; line-height: 1; }
    .weather-temps { display: flex; flex-direction: column; align-items: center; min-width: 52px; }
    .weather-temp-max { font-size: 28px; font-weight: 900; line-height: 1; }
    .weather-temp-min { font-size: 16px; font-weight: 700; opacity: 0.72; margin-top: 2px; }
    .weather-cond { flex: 1; }
    .weather-label { font-size: 17px; font-weight: 900; }
    .weather-sub { font-size: 12px; opacity: 0.82; margin-top: 4px; letter-spacing: 0.04em; }
    .outfit-card {
      background: rgba(255,255,255,0.65); border-radius: 16px;
      border: 1px solid var(--border-soft); padding: 12px 14px; margin-bottom: 10px;
    }
    .outfit-title { font-size: 13px; font-weight: 800; margin-bottom: 8px; color: var(--text-main); }
    .outfit-chips { display: flex; flex-wrap: wrap; gap: 6px; }
    .outfit-chip {
      background: linear-gradient(135deg, #ede7f6, #e3f2fd);
      border-radius: 999px; padding: 5px 12px;
      font-size: 12px; font-weight: 700; color: var(--text-main);
      border: 1px solid rgba(124,95,230,0.15);
    }
    .outfit-warns { margin-top: 8px; display: flex; flex-direction: column; gap: 4px; }
    .outfit-warn {
      font-size: 11px; font-weight: 700; color: #c62828;
      background: #ffebee; border-radius: 8px; padding: 4px 10px;
    }
    .forecast-scroll {
      display: flex; gap: 8px; overflow-x: auto;
      padding-bottom: 4px; scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .forecast-scroll::-webkit-scrollbar { display: none; }
    .fc-card {
      flex-shrink: 0; scroll-snap-align: start;
      width: 60px; text-align: center;
      background: rgba(255,255,255,0.7); border-radius: 14px;
      padding: 10px 4px; border: 1px solid var(--border-soft);
      display: flex; flex-direction: column; align-items: center; gap: 4px;
    }
    .fc-today {
      background: linear-gradient(135deg, #e8effe, #f0e8ff);
      border: 1.5px solid rgba(124,95,230,0.35);
    }
    .fc-dow { font-size: 10px; font-weight: 800; color: var(--text-muted); }
    .fc-today .fc-dow { color: var(--accent-purple); }
    .fc-emoji { font-size: 22px; line-height: 1; }
    .fc-max { font-size: 14px; font-weight: 900; color: var(--text-main); }
    .fc-min { font-size: 11px; color: var(--text-muted); }
    .fc-rain { font-size: 10px; color: #1976d2; font-weight: 700; }
    .weather-refresh-btn {
      display: block; width: 100%; text-align: center;
      font-size: 11px; color: var(--text-muted); margin-top: 8px;
      background: none; border: none; cursor: pointer; padding: 4px;
      font-family: inherit;
    }
    .weather-refresh-btn:active { opacity: 0.6; }
    /* -- Hourly timeline -- */
    .hourly-section { margin: 10px 0 12px; }
    .hourly-label, .forecast-label {
      font-size: 11px; font-weight: 800; color: var(--text-muted);
      letter-spacing: 0.05em; margin-bottom: 7px;
    }
    .forecast-label { margin-top: 14px; }
    .hourly-scroll {
      display: flex; gap: 5px; overflow-x: auto;
      padding-bottom: 4px; scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .hourly-scroll::-webkit-scrollbar { display: none; }
    .h-card {
      flex-shrink: 0; scroll-snap-align: start; width: 54px;
      text-align: center; border-radius: 14px; padding: 8px 3px;
      border: 1px solid var(--border-soft);
      background: rgba(255,255,255,0.65);
      display: flex; flex-direction: column; align-items: center; gap: 3px;
      transition: transform 0.1s;
    }
    .h-card.h-now {
      background: linear-gradient(160deg, #1565c0 0%, #42a5f5 100%);
      border: none; box-shadow: 0 4px 14px rgba(21,101,192,0.35);
    }
    .h-time  { font-size: 10px; font-weight: 800; color: var(--text-muted); }
    .h-emoji { font-size: 18px; line-height: 1; }
    .h-temp  { font-size: 13px; font-weight: 900; color: var(--text-main); }
    .h-feels { font-size: 9px; color: var(--text-muted); }
    .h-rain  { font-size: 10px; font-weight: 700; color: #1976d2; }
    .h-card.h-now .h-time,
    .h-card.h-now .h-temp,
    .h-card.h-now .h-feels,
    .h-card.h-now .h-rain { color: rgba(255,255,255,0.9); }
    /* -- Outfit Amazon board -- */
    .outfit-board-wrap {
      background: rgba(255,255,255,0.55);
      border-radius: 18px; border: 1px solid var(--border-soft);
      padding: 12px 12px 10px; margin-bottom: 4px;
    }
    .outfit-board-title {
      font-size: 13px; font-weight: 800; margin-bottom: 4px;
      display: flex; align-items: center; gap: 6px;
    }
    .outfit-style-tag {
      font-size: 10px; font-weight: 800; padding: 2px 9px;
      border-radius: 999px; background: linear-gradient(135deg,#7c5fe6,#4f8dfd);
      color: #fff;
    }
    /* Mannequin visual */
    .outfit-mannequin-row {
      display: flex; gap: 10px; align-items: flex-start; margin-bottom: 10px;
    }
    .vp-mannequin {
      position: relative; width: 96px; height: 192px;
      flex-shrink: 0; overflow: visible;
    }
    .vp-svg {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; user-select: none;
    }
    /* „Éï„É©„ÉÉ„Éà„É¨„Ç§ clothing display */
    .vp-flatlay {
      display: grid; grid-template-columns: 1fr 1fr; gap: 5px;
      width: 108px; flex-shrink: 0; align-content: start;
    }
    .fl-card {
      background: var(--card-bg); border-radius: 9px; padding: 6px 4px;
      text-align: center; border: 1px solid var(--border-soft);
    }
    .fl-card-em { font-size: 22px; line-height: 1; }
    .fl-card-nm {
      font-size: 8px; color: var(--text-sub); margin-top: 2px;
      line-height: 1.2; overflow: hidden; display: -webkit-box;
      -webkit-line-clamp: 2; -webkit-box-orient: vertical;
    }
    /* jinjer sync option buttons */
    .jinjer-sync-opt-btn {
      width: 100%; text-align: left; padding: 12px 14px; border-radius: 12px;
      border: 1.5px solid var(--border-soft); background: var(--card-bg);
      cursor: pointer; font-family: inherit; margin-bottom: 8px; display: block;
    }
    .jinjer-sync-opt-btn:active { opacity: 0.7; }
    .jinjer-sync-opt-title { font-size: 14px; font-weight: 800; color: var(--text-primary); }
    .jinjer-sync-opt-sub { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    /* outfit gender sections */
    .outfit-gender-section { margin-bottom: 10px; }
    .outfit-gender-label {
      font-size: 11px; font-weight: 800; color: var(--text-muted);
      margin-bottom: 6px; letter-spacing: 0.03em;
    }
    .vp-item {
      position: absolute; left: 50%; transform: translateX(-50%);
      font-size: 22px; line-height: 1; text-decoration: none;
      display: flex; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.92); border-radius: 50%;
      width: 34px; height: 34px; border: 1.5px solid rgba(124,95,230,0.3);
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      transition: transform 0.12s; cursor: pointer;
      -webkit-tap-highlight-color: transparent; z-index: 2;
    }
    .vp-item:active { transform: translateX(-50%) scale(0.86); }
    .vp-hat    { top: -10px; }
    .vp-scarf  { top: 30px; }
    .vp-outer  { top: 43px; }
    .vp-top    { top: 55px; }
    .vp-bottom { top: 108px; }
    .vp-feet   { top: 162px; }
    .vp-acc    { top: 92px; left: calc(50% + 30px); }
    /* Card grid */
    .oic-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(76px, 1fr));
      gap: 7px;
    }
    .oic {
      display: flex; flex-direction: column; align-items: center;
      gap: 5px; padding: 10px 5px 8px;
      background: #fff; border-radius: 14px;
      border: 1px solid rgba(124,95,230,0.15);
      text-decoration: none; color: var(--text-main); text-align: center;
      cursor: pointer; transition: transform 0.12s, box-shadow 0.12s;
      -webkit-tap-highlight-color: transparent;
    }
    .oic:active { transform: scale(0.93); box-shadow: none; }
    .oic:hover  { box-shadow: 0 3px 12px rgba(124,95,230,0.18); }
    .oic-em  { font-size: 30px; line-height: 1; }
    .oic-nm  { font-size: 10px; font-weight: 800; line-height: 1.3; }
    .oic-amz {
      font-size: 9px; font-weight: 800; color: #c45500;
      background: #fff3e0; border-radius: 999px; padding: 2px 7px;
      border: 1px solid #ffe0b2; white-space: nowrap;
    }
    .outfit-warn-row { margin: 8px 0 4px; display: flex; flex-direction: column; gap: 4px; }
    .outfit-all-btn {
      display: flex; align-items: center; justify-content: center; gap: 6px;
      margin-top: 10px; padding: 11px;
      background: linear-gradient(135deg, #ff9900 0%, #ff6d00 100%);
      color: #fff; border-radius: 14px; font-size: 13px; font-weight: 800;
      text-decoration: none; letter-spacing: 0.02em;
      box-shadow: 0 4px 16px rgba(255,153,0,0.35);
      -webkit-tap-highlight-color: transparent;
      transition: opacity 0.15s;
    }
    .outfit-all-btn:active { opacity: 0.8; }
    .outfit-fallback { display: flex; flex-wrap: wrap; gap: 8px; padding: 10px 0; font-size: 13px; color: var(--text-muted); }
    .oic-why { font-size: 9px; color: var(--text-muted); text-align: center; line-height: 1.3; }

    /* ======= CAMERA MEASUREMENT ======= */
    .measure-ref-btn, .measure-type-btn {
      padding: 5px 10px; border-radius: 20px;
      border: 2px solid var(--border-soft); background: var(--bg-card);
      color: var(--text-sub); font-size: 11px; font-weight: 700;
      font-family: inherit; cursor: pointer; transition: all 0.15s;
    }
    .measure-ref-btn.active, .measure-type-btn.active {
      background: var(--accent-blue); color: white; border-color: var(--accent-blue);
    }

    /* ======= HOURLY DATE SEPARATOR ======= */
    .h-date-sep {
      flex-shrink: 0; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 1px;
      background: linear-gradient(180deg, rgba(124,95,230,0.18) 0%, rgba(124,95,230,0.06) 100%);
      border-radius: 14px; padding: 8px 5px; min-width: 30px;
      border: 1.5px solid rgba(124,95,230,0.28);
    }
    .h-date-sep span { font-size: 9px; font-weight: 800; color: var(--accent); line-height: 1.3; }
    .h-date-sep .h-ds-today { font-size: 8px; background: var(--accent); color: #fff; border-radius: 4px; padding: 1px 3px; }

    /* ======= SYSTEM LOG MODAL ======= */
    .log-filter-bar { display: flex; gap: 5px; padding: 8px 12px; border-bottom: 1px solid var(--border-soft); flex-shrink: 0; }
    .log-filter-btn { flex: 1; padding: 5px 2px; border-radius: 8px; border: none; background: var(--bg-card); font-size: 11px; font-weight: 700; cursor: pointer; color: var(--text-muted); font-family: inherit; }
    .log-filter-btn.active { background: var(--accent); color: #fff; }
    .log-entry { display: flex; flex-direction: column; gap: 3px; padding: 8px 0; border-bottom: 1px solid var(--border-soft); }
    .log-entry:last-child { border-bottom: none; }
    .log-row1 { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
    .log-ts { font-size: 10px; color: var(--text-muted); font-family: monospace; white-space: nowrap; }
    .log-badge { font-size: 9px; font-weight: 800; border-radius: 999px; padding: 1px 6px; white-space: nowrap; }
    .log-badge-error { background: #fce4ec; color: #c62828; }
    .log-badge-warn  { background: #fff3e0; color: #e65100; }
    .log-badge-info  { background: #e3f2fd; color: #1565c0; }
    .log-src { font-size: 10px; font-weight: 700; color: var(--accent); }
    .log-msg { font-size: 11px; color: var(--text-main); line-height: 1.4; word-break: break-all; padding-left: 2px; }
    .health-log-btn { background: none; border: none; font-size: 14px; cursor: pointer; padding: 2px 5px; border-radius: 6px; opacity: 0.7; transition: opacity 0.15s; line-height: 1; }
    .health-log-btn:active { opacity: 1; }
    .health-item-btn { cursor: pointer; border-radius: 6px; padding: 0 2px; transition: background 0.15s; }
    .health-item-btn:active { background: rgba(124,95,230,0.12); }
    .log-badge-fatal { background: #880e4f; color: #fff; font-weight: 900; letter-spacing: 0.03em; }
    .log-suggest { font-size: 10px; color: #283593; background: #e8eaf6; border-radius: 6px; padding: 3px 7px; margin-top: 3px; line-height: 1.5; display: flex; gap: 5px; align-items: flex-start; }
    .log-suggest::before { content: "üí°"; flex-shrink: 0; }

    /* ======= PERFORMANCE MODAL ======= */
    .perf-section { margin-bottom: 14px; }
    .perf-section-title { font-size: 11px; font-weight: 800; letter-spacing: 0.07em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px; display: flex; align-items: center; gap: 5px; }
    .perf-bar-wrap { background: rgba(0,0,0,0.07); border-radius: 999px; height: 8px; overflow: hidden; margin: 3px 0 6px; }
    .perf-bar { height: 100%; border-radius: 999px; transition: width 0.6s cubic-bezier(0.4,0,0.2,1); }
    .perf-bar-ok   { background: linear-gradient(90deg, #2e7d32, #66bb6a); }
    .perf-bar-warn { background: linear-gradient(90deg, #e65100, #ffb300); }
    .perf-bar-crit { background: linear-gradient(90deg, #b71c1c, #ef5350); }
    .perf-metric { display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid var(--border-soft); font-size: 12px; }
    .perf-metric:last-child { border-bottom: none; }
    .perf-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }
    .perf-dot-ok   { background: #2e7d32; box-shadow: 0 0 5px rgba(46,125,50,0.6); }
    .perf-dot-warn { background: #e65100; box-shadow: 0 0 5px rgba(230,81,0,0.6); }
    .perf-dot-crit { background: #b71c1c; box-shadow: 0 0 5px rgba(183,28,28,0.6); }
    .perf-label { flex: 1; color: var(--text-muted); font-weight: 700; }
    .perf-val { font-weight: 800; font-family: monospace; font-size: 13px; }
    .perf-fps-display { text-align: center; padding: 10px 0 4px; }
    .perf-fps-num { font-size: 42px; font-weight: 900; line-height: 1; letter-spacing: -0.04em; }
    .perf-fps-label { font-size: 11px; color: var(--text-muted); margin-top: 2px; font-weight: 700; }

    /* ======= JINJER SYNC CHOICE MODAL ======= */
    .jinjer-sync-opt { display: flex; align-items: center; gap: 14px; padding: 14px 12px; border-radius: 16px; background: rgba(255,255,255,0.7); border: 1px solid var(--border-soft); cursor: pointer; transition: background 0.15s, transform 0.1s; -webkit-tap-highlight-color: transparent; margin-bottom: 10px; }
    .jinjer-sync-opt:active { background: rgba(124,95,230,0.08); transform: scale(0.98); }
    .jinjer-sync-opt-icon { font-size: 32px; flex-shrink: 0; }
    .jinjer-sync-opt-title { font-size: 14px; font-weight: 800; color: var(--text-main); }
    .jinjer-sync-opt-sub { font-size: 11px; color: var(--text-muted); line-height: 1.5; margin-top: 2px; }

    /* ======= Ë≠∞‰∫ãÈå≤ MODAL ======= */
    .min-controls { display:flex; align-items:center; gap:10px; padding:6px 0 10px; flex-wrap:wrap; flex-shrink:0; }
    .min-rec-btn { display:flex; align-items:center; gap:6px; padding:11px 20px; border-radius:999px; border:none; font-size:13px; font-weight:800; font-family:inherit; cursor:pointer; user-select:none; transition:transform .15s; }
    .min-rec-btn:active { transform:scale(0.96); }
    .min-rec-btn.start { background:linear-gradient(135deg,#e53935,#ef5350); color:#fff; box-shadow:0 4px 14px rgba(229,57,53,0.38); }
    .min-rec-btn.stop  { background:#fff3e0; color:#bf360c; border:2px solid #ffccbc; }
    .min-timer { font-size:20px; font-weight:900; font-variant-numeric:tabular-nums; color:var(--text-main); letter-spacing:.02em; }
    .min-status-badge { font-size:11px; color:#2e7d32; background:#e8f5e9; padding:3px 10px; border-radius:999px; font-weight:700; animation:minPulse 1.5s ease-in-out infinite; }
    @keyframes minPulse { 0%,100%{opacity:1} 50%{opacity:.4} }
    .min-transcript { overflow-y:auto; flex:1; min-height:0; border:1px solid var(--border-soft); border-radius:14px; padding:12px; background:#fafbff; }
    .min-block { margin-bottom:12px; border-left:3px solid var(--accent-blue); padding-left:10px; }
    .min-speaker { font-size:10px; font-weight:800; color:var(--text-muted); margin-bottom:2px; letter-spacing:.06em; text-transform:uppercase; }
    .min-text { font-size:14px; line-height:1.75; color:var(--text-main); }
    .min-text.interim { color:#9e9e9e; font-style:italic; }
    .min-actions { display:flex; gap:8px; flex-wrap:wrap; padding:10px 0 0; flex-shrink:0; }
    .min-action-btn { padding:8px 14px; font-size:12px; border-radius:999px; border:1px solid var(--border-soft); background:#f4f5f9; cursor:pointer; font-weight:700; font-family:inherit; user-select:none; }
    .min-action-btn:active { transform:scale(0.96); }
    .min-hist-item { padding:11px 14px; border-radius:12px; background:#f4f5f9; margin-bottom:8px; cursor:pointer; }
    .min-hist-item:active { background:#e8eaf6; }
    .min-hist-title { font-size:13px; font-weight:800; color:var(--text-main); }
    .min-hist-meta { font-size:11px; color:var(--text-muted); margin-top:2px; }

    /* ======= TAILSCALE CARD ======= */
    .ts-card { background: linear-gradient(135deg, #0d1b2a 0%, #1b263b 100%); border-radius: 16px; padding: 14px; margin-bottom: 10px; color: #e0e8f0; }
    .ts-card-title { font-size: 13px; font-weight: 800; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
    .ts-status-dot { width: 8px; height: 8px; border-radius: 50%; background: #4caf50; box-shadow: 0 0 6px #4caf50; flex-shrink: 0; animation: tsPulse 2s infinite; }
    .ts-status-dot.offline { background: #9e9e9e; box-shadow: none; animation: none; }
    @keyframes tsPulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
    .ts-ip-row { display: flex; align-items: center; gap: 8px; padding: 7px 0; border-bottom: 1px solid rgba(255,255,255,0.08); }
    .ts-ip-row:last-of-type { border-bottom: none; }
    .ts-ip-icon { font-size: 18px; flex-shrink: 0; }
    .ts-ip-info { flex: 1; min-width: 0; }
    .ts-ip-label { font-size: 10px; color: #90a4ae; font-weight: 700; }
    .ts-ip-addr { font-size: 13px; font-weight: 800; font-family: monospace; color: #e0f7fa; letter-spacing: 0.03em; }
    .ts-btn-row { display: flex; gap: 6px; margin-top: 10px; }
    .ts-btn { flex: 1; padding: 9px 4px; border-radius: 10px; border: none; font-size: 11px; font-weight: 800; cursor: pointer; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 4px; transition: opacity 0.15s; font-family: inherit; }
    .ts-btn:active { opacity: 0.8; }
    .ts-btn-ssh { background: linear-gradient(135deg, #00897b, #26a69a); color: #fff; }
    .ts-btn-copy { background: rgba(255,255,255,0.1); color: #e0e8f0; border: 1px solid rgba(255,255,255,0.15); }
    .ts-btn-sftp { background: linear-gradient(135deg, #1565c0, #42a5f5); color: #fff; }

    /* ======= PIN MODAL ======= */
    .pin-modal-body { padding: 4px 0 8px; text-align: center; }
    .pin-purpose { font-size: 13px; color: var(--text-muted); margin-bottom: 16px; line-height: 1.5; }
    .pin-dots { display: flex; justify-content: center; gap: 14px; margin-bottom: 16px; }
    .pin-dot {
      width: 16px; height: 16px; border-radius: 50%;
      border: 2px solid #ccc; background: transparent; transition: all 0.15s;
    }
    .pin-dot.filled { background: var(--accent-blue); border-color: var(--accent-blue); }
    .pin-error-msg { font-size: 12px; color: #c62828; min-height: 18px; margin-bottom: 12px; font-weight: 700; }
    .pin-keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 260px; margin: 0 auto; }
    .pin-key {
      padding: 16px; font-size: 20px; font-weight: 700;
      border: 1px solid var(--border-soft); border-radius: 14px;
      background: rgba(255,255,255,0.9); cursor: pointer;
      font-family: inherit; color: var(--text-main);
      -webkit-tap-highlight-color: transparent; transition: background 0.1s;
    }
    .pin-key:active { background: #e8efff; transform: scale(0.96); }
    .pin-key-sm { font-size: 13px; color: var(--text-muted); }
    .pin-lock-msg { font-size: 12px; color: #c62828; margin-top: 12px; font-weight: 700; min-height: 18px; }

    /* ======= HEALTH INDICATOR ======= */
    .health-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,0.5);
      border: 1px solid rgba(180,190,220,0.3);
      font-size: 11px;
      color: var(--text-muted);
      flex-wrap: wrap;
    }
    .health-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      display: inline-block;
      flex-shrink: 0;
    }
    .health-dot-ok     { background: #4caf50; box-shadow: 0 0 4px rgba(76,175,80,0.6); }
    .health-dot-warn   { background: #ff9800; box-shadow: 0 0 4px rgba(255,152,0,0.6); }
    .health-dot-error  { background: #f44336; box-shadow: 0 0 4px rgba(244,67,54,0.6); }
    .health-item { display: flex; align-items: center; gap: 4px; }

    /* ======= EMERGENCY FAB ======= */
    .fab-recover {
      position: fixed;
      left: calc(max(env(safe-area-inset-left), 16px));
      bottom: calc(max(env(safe-area-inset-bottom), 0px) + var(--tab-bar-h) + 20px);
      width: 52px; height: 52px;
      border-radius: 999px;
      background: linear-gradient(135deg, #f44336, #b71c1c);
      color: #fff; font-size: 20px;
      border: none; cursor: pointer;
      box-shadow: 0 4px 18px rgba(244,67,54,0.55);
      display: flex; align-items: center; justify-content: center;
      z-index: 900;
      font-family: inherit;
      transition: opacity 0.2s, transform 0.15s;
    }
    .fab-recover:active { transform: scale(0.93); }
    .fab-recover.hidden { opacity: 0; pointer-events: none; }

    /* ======= EMERGENCY MODAL ======= */
    .emergency-modal-body {
      display: flex; flex-direction: column; gap: 8px;
    }
    .emergency-section-title {
      font-size: 11px; font-weight: 700; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: .06em;
      margin-top: 4px;
    }
    .emergency-btn {
      display: block; width: 100%;
      padding: 12px 14px;
      border-radius: 12px; border: none;
      font-size: 14px; font-weight: 700;
      cursor: pointer; text-align: left;
      font-family: inherit;
      transition: opacity 0.15s;
    }
    .emergency-btn:active { opacity: 0.8; }
    .emergency-btn-safe   { background: #e3f2fd; color: #1565c0; }
    .emergency-btn-warn   { background: #fff8e1; color: #e65100; }
    .emergency-btn-danger { background: #ffebee; color: #c62828; }
    .emergency-btn-link   { background: #f4f5f9; color: var(--text-main); }
    .emergency-diag {
      background: #f4f5f9; border-radius: 10px;
      padding: 10px 12px; font-size: 11px;
      color: var(--text-muted); line-height: 1.8;
      font-family: monospace;
    }
  </style>
</head>

<body>
  <!-- Network status banner -->
  <div class="net-banner" id="net-banner" role="status" aria-live="polite"></div>

  <!-- Install banner (iOS) -->
  <div class="install-banner" id="install-banner">
    <span class="install-close" id="install-close">√ó</span>
    <strong>„Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†„Åó„Å¶„Ç¢„Éó„É™„Å®„Åó„Å¶‰Ωø„ÅÜ</strong><br>
    Safari „ÅÆ <strong>ÂÖ±Êúâ„Éú„Çø„É≥Ôºà‚ÜëÔºâ‚Üí„Äå„Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†„Äç</strong> „Çí„Çø„ÉÉ„Éó
  </div>

  <!-- Auto-backup reminder banner -->
  <div class="backup-banner" id="backup-banner">
    <div class="backup-banner-row">
      <div class="backup-banner-text">
        <strong>‚ö†Ô∏è „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí„ÅäÂãß„ÇÅ„Åó„Åæ„Åô</strong><br>
        <span id="backup-days-msg">ÂâçÂõû„ÅÆ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Åã„Çâ7Êó•‰ª•‰∏äÁµåÈÅé„Åó„Å¶„ÅÑ„Åæ„Åô</span>
      </div>
      <button class="backup-now-btn" id="btn-backup-now">‰∏ÄÊã¨„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó</button>
      <span class="backup-dismiss" id="backup-dismiss">√ó</span>
    </div>
  </div>

  <!-- ===== TAB: Âã§ÊÄ†„Ç´„É¨„É≥„ÉÄ„Éº ===== -->
  <div id="page-calendar" class="tab-page active">
  <div class="card" id="calendar-card">
    <div class="overlay" id="overlay"><div class="spinner"></div></div>

    <div class="card-title">Âã§ÊÄ†„Ç´„É¨„É≥„ÉÄ„ÉºÔºà„É°„É¢‰ªò„ÅçÔºâ</div>

    <!-- Monthly stats bar -->
    <div class="stats-bar" id="stats-bar">
      <span class="stat-chip stat-office">Âá∫Á§æ <b id="stat-office">0</b>Êó•</span>
      <span class="stat-chip stat-home">Âú®ÂÆÖ <b id="stat-home">0</b>Êó•</span>
      <span class="stat-chip stat-off">‰ºëÊöá <b id="stat-off">0</b>Êó•</span>
      <span class="stat-chip stat-hours">Âã§Âãô <b id="stat-hours">0h</b></span>
      <button class="stat-chip stat-weekly-toggle" id="weekly-toggle">ÈÄ±Ê¨°‰∫∫Êúà <span id="weekly-arrow">‚ñæ</span></button>
    </div>
    <!-- Weekly person-month breakdown (Êäò„Çä„Åü„Åü„Åø) -->
    <div class="weekly-stats" id="weekly-stats"></div>

    <!-- ‰ªäÊó•„ÅÆÂ§©Ê∞ó„Éü„Éã„Éê„Éä„Éº -->
    <div id="cal-weather-wrap" style="display:none;margin-bottom:6px;">
      <div class="cal-weather-strip" id="cal-weather-strip">
        <div class="cal-w-emoji" id="cal-w-emoji">üå§</div>
        <div class="cal-weather-info">
          <div class="cal-w-cond" id="cal-w-cond">--</div>
          <div class="cal-w-sub" id="cal-w-sub">Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶</div>
        </div>
        <div class="cal-w-temps" id="cal-w-temps">--¬∞/--¬∞</div>
        <button class="cal-outfit-btn" id="cal-hourly-btn">‚è± ÊôÇÈñìÂà•</button>
        <button class="cal-outfit-btn" id="cal-outfit-btn" style="background:linear-gradient(135deg,#2e7d32,#66bb6a);">üëó ÊúçË£Ö</button>
      </div>
      <!-- ÊôÇÈñìÂà•‰∫àÂ†±Â±ïÈñã -->
      <div id="cal-hourly-expand" style="display:none;margin-top:6px;padding:8px 4px 4px;background:rgba(255,255,255,0.6);border-radius:12px;">
        <div class="hourly-scroll" id="cal-hourly-scroll"></div>
      </div>
      <!-- ÊúçË£ÖÂ±ïÈñã -->
      <div id="cal-outfit-expand" style="display:none;margin-top:6px;">
        <div class="outfit-card" id="cal-outfit-card"></div>
      </div>
    </div>

    <div class="header-bar">
      <div class="header-left">
        <button class="nav-arrow" id="prev-month">‚Äπ</button>
        <button class="pill-button pill-button-primary" id="today-button">‰ªäÊó•</button>
      </div>
      <div class="month-label" id="month-label">----</div>
      <div class="header-right">
        <button class="pill-button" id="lock-toggle">
          <span class="icon">üîí</span><span id="lock-label">„É≠„ÉÉ„ÇØ</span>
        </button>
        <button class="nav-arrow" id="next-month">‚Ä∫</button>
      </div>
    </div>

    <div class="calendar-wrapper">
      <table class="calendar">
        <thead>
          <tr>
            <th>Êó•</th><th>Êúà</th><th>ÁÅ´</th><th>Ê∞¥</th><th>Êú®</th><th>Èáë</th><th>Âúü</th>
          </tr>
        </thead>
        <tbody id="calendar-body"></tbody>
      </table>
    </div>

    <div class="footer">
      <div class="legend">
        „Çπ„ÉÜ„Éº„Çø„ÇπÔºö
        <span class="badge badge-work">Âá∫</span>
        <span class="badge badge-home">Âú®</span>
        <span class="badge badge-kyujitsu">‰ºëÊó•</span>
        <span class="badge badge-holiday">‰ºë„Åø</span>
        <span class="badge badge-shuku">Á•ùÊó•</span><br>
        Êó•Êõú‚Üí‰ºëÊó• / ÂúüÊõú‚Üí‰ºë„Åø / Á•ùÊó•„ÅØËá™ÂãïÂà§ÂÆö„ÄÇ„É°„É¢„ÅÇ„ÇäÔºù<span style="color:#ff9800;font-weight:800;">‚óè</span>
      </div>
      <div class="data-actions">
        <button class="data-btn" id="btn-xlsx">üìä xlsxÊõ∏„ÅçÂá∫„Åó</button>
        <button class="data-btn" id="btn-export">üíæ JSON„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó</button>
        <button class="data-btn" id="btn-import">üì• JSONË™≠„ÅøËæº„Åø</button>
        <button class="data-btn" id="btn-migrate">üîÑ iSHÁâà„ÇíÂèñ„ÇäËæº„ÇÄ</button>
        <button class="data-btn" id="btn-jinjer">üè¢ jinjerÂêåÊúü</button>
        <button class="data-btn" id="btn-minutes">üìù Ë≠∞‰∫ãÈå≤</button>
        <button class="data-btn" id="btn-measure">üìè „Çµ„Ç§„Ç∫Ë®àÊ∏¨</button>
        <button class="data-btn" id="btn-settings">‚öôÔ∏è Ë®≠ÂÆö</button>
        <button class="data-btn" id="btn-recover" style="color:#c62828;border-color:#ffcdd2;background:rgba(255,235,238,0.7);">üö® Á∑äÊÄ•Âæ©Êóß</button>
      </div>
      <!-- Health status bar -->
      <div class="health-bar" id="health-bar">
        <span class="health-item"><span class="health-dot" id="health-dot-ls"></span><span id="health-ls">LS: --</span></span>
        <span class="health-item health-item-btn" id="health-idb-item" title="„Çø„ÉÉ„Éó„Åß„É≠„Ç∞„ÇíÁ¢∫Ë™ç"><span class="health-dot" id="health-dot-idb"></span><span id="health-idb">IDB: --</span></span>
        <span class="health-item health-item-btn" id="health-err-item" title="„Çø„ÉÉ„Éó„Åß„Ç®„É©„Éº„É≠„Ç∞„ÇíÁ¢∫Ë™ç"><span class="health-dot" id="health-dot-err"></span><span id="health-err">„Ç®„É©„Éº: --</span></span>
        <span style="flex:1"></span>
        <span id="health-snap" style="font-size:10px;color:var(--text-muted);"></span>
        <button class="health-log-btn" id="health-perf-btn" title="„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ">üìä</button>
        <button class="health-log-btn" id="health-log-btn" title="„Ç∑„Çπ„ÉÜ„É†„É≠„Ç∞">üìã</button>
      </div>
      <input type="file" id="file-import"  accept=".json" style="display:none">
      <input type="file" id="file-jinjer" accept=".json" style="display:none">
    </div>
  </div>
  </div><!-- /page-calendar -->

  <!-- ===== TAB: „Éè„Éñ / „ÇØ„Ç§„ÉÉ„ÇØ„É©„É≥„ÉÅ„É£„Éº ===== -->
  <div id="page-hub" class="tab-page">

    <!-- Â§©Ê∞ó‰∫àÂ†±„Ç´„Éº„Éâ -->
    <div class="card weather-card-wrap" id="weather-card-wrap">
      <div class="card-title">üå§ Â§©Ê∞ó‰∫àÂ†±</div>
      <div class="weather-loading" id="weather-loading">Â§©Ê∞óÊÉÖÂ†±„ÇíÂèñÂæó‰∏≠‚Ä¶</div>
      <div id="weather-main-section" style="display:none;">
        <div id="weather-today"></div>
        <!-- 1ÊôÇÈñìÊØé„ÅÆ‰∫àÂ†± -->
        <div class="hourly-section">
          <div class="hourly-label">‚è± ÊôÇÈñì„Åî„Å®„ÅÆÂ§©Ê∞ó</div>
          <div class="hourly-scroll" id="hourly-scroll"></div>
        </div>
        <!-- ÊúçË£Ö„Åä„Åô„Åô„ÇÅÔºàAmazonÈÄ£Êê∫Ôºâ -->
        <div id="outfit-board"></div>
        <!-- 7Êó•Èñì‰∫àÂ†± -->
        <div class="forecast-label">üìÖ 7Êó•Èñì‰∫àÂ†±</div>
        <div class="forecast-scroll" id="forecast-scroll"></div>
      </div>
      <div id="weather-error" style="display:none;color:var(--text-muted);font-size:13px;text-align:center;padding:8px 0;"></div>
      <button class="weather-refresh-btn" id="weather-refresh-btn">üîÑ Êõ¥Êñ∞</button>
    </div>

    <div class="card">
      <div class="card-title">üöÄ „ÇØ„Ç§„ÉÉ„ÇØ„É©„É≥„ÉÅ„É£„Éº</div>
      <!-- jinjer ÊâìÂàª„Éú„Çø„É≥ÔºàÂ§ßÔºâ -->
      <a href="https://kintai.jinjer.biz/staffs/top" target="_blank" rel="noopener" class="jinjer-card" id="jinjer-link">
        <div class="jinjer-icon">üè¢</div>
        <div class="jinjer-info">
          <div class="jinjer-label">jinjer ÊâìÂàª</div>
          <div class="jinjer-sub" id="jinjer-card-sub">Âá∫Âã§„ÉªÈÄÄÂã§„ÇíË®òÈå≤„Åô„Çã ‚Üó</div>
        </div>
        <div class="jinjer-arrow">‚è±</div>
      </a>
      <div id="jinjer-today-bar" style="background:#e3f2fd;border-radius:12px;padding:10px 14px;margin-bottom:10px;font-size:12px;display:none;">
        <span style="font-weight:800;color:#1565c0;">üìç ‰ªäÊó•„ÅÆÊâìÂàªÁä∂Ê≥Å</span>
        <span id="jinjer-today-status" style="margin-left:10px;"></span>
      </div>
      <div class="card-title" style="margin-top:4px;">„Éû„Ç§„Ç¢„Éó„É™„Éª„É™„É≥„ÇØ</div>
      <div class="links-grid" id="links-grid"></div>
      <div style="font-size:11px;color:var(--text-muted);line-height:1.5;margin-top:4px;">
        ‚ûï „Çí„Çø„ÉÉ„Éó„Åó„Å¶„Çà„Åè‰Ωø„ÅÜ„Çµ„Éº„Éì„Çπ„ÇíËøΩÂä†„Åß„Åç„Åæ„Åô
      </div>
    </div>

    <!-- Tailscale VPN / SSH card -->
    <div class="card" id="ts-card-wrap" style="display:none;">
      <div class="ts-card">
        <div class="ts-card-title">
          <span class="ts-status-dot" id="ts-status-dot"></span>
          üîí Tailscale VPN
          <span id="ts-status-label" style="font-size:10px;opacity:0.7;margin-left:4px;"></span>
        </div>
        <div class="ts-ip-row">
          <div class="ts-ip-icon">üíª</div>
          <div class="ts-ip-info">
            <div class="ts-ip-label">MacBook („Åì„ÅÆ„Éá„Éê„Ç§„Çπ)</div>
            <div class="ts-ip-addr" id="ts-mac-ip-disp">--</div>
          </div>
          <button class="ts-btn ts-btn-copy" id="ts-copy-mac" style="flex:none;padding:6px 10px;">üìã</button>
        </div>
        <div class="ts-ip-row">
          <div class="ts-ip-icon">üì±</div>
          <div class="ts-ip-info">
            <div class="ts-ip-label">iPhone 13 Pro</div>
            <div class="ts-ip-addr" id="ts-iphone-ip-disp">--</div>
          </div>
          <button class="ts-btn ts-btn-copy" id="ts-copy-iphone" style="flex:none;padding:6px 10px;">üìã</button>
        </div>
        <div class="ts-btn-row">
          <a class="ts-btn ts-btn-ssh" id="ts-ssh-btn" href="#" target="_blank" rel="noopener">üñ• SSHÊé•Á∂ö</a>
          <a class="ts-btn ts-btn-sftp" id="ts-sftp-btn" href="#" target="_blank" rel="noopener">üìÅ SFTP</a>
          <button class="ts-btn ts-btn-copy" id="ts-ping-btn">üì° ÁñéÈÄöÁ¢∫Ë™ç</button>
        </div>
        <div id="ts-ping-result" style="font-size:11px;margin-top:8px;text-align:center;display:none;"></div>
      </div>
    </div>
  </div>

  <!-- ===== TAB: Ë≥áÊ†º„ÉªÂ≠¶ÁøíÈÄ≤Êçó ===== -->
  <div id="page-study" class="tab-page">
    <!-- ‰ªäÈÄ±„ÅÆÂ≠¶Áøí„Çµ„Éû„É™„Éº -->
    <div class="card" style="margin-bottom:10px;">
      <div class="card-title">üìà ‰ªäÈÄ±„ÅÆÂ≠¶Áøí</div>
      <div id="study-week-summary" style="display:flex;gap:8px;flex-wrap:wrap;padding:2px 0 4px;"></div>
    </div>
    <div class="card">
      <div class="card-title">üìö Ë≥áÊ†º„ÉªÂ≠¶ÁøíÈÄ≤Êçó</div>
      <div id="study-list"></div>
      <button class="data-btn" id="btn-add-study" style="width:100%;text-align:center;margin-top:4px;">Ôºã Ë≥áÊ†º„ÉªÂ≠¶ÁøíÁõÆÊ®ô„ÇíËøΩÂä†</button>
    </div>
  </div>

  <!-- ===== TAB: „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÄ≤Êçó ===== -->
  <div id="page-project" class="tab-page">
    <div class="card" style="margin-bottom:10px;">
      <div class="card-title">üìä „Çµ„Éû„É™„Éº</div>
      <div id="project-summary" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
    </div>
    <div class="card">
      <div class="card-title">üìã „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß</div>
      <div id="project-list"></div>
      <button class="data-btn" id="btn-add-project" style="width:100%;text-align:center;margin-top:4px;">Ôºã „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíËøΩÂä†</button>
    </div>
  </div>

  <!-- Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
  <div class="modal-backdrop" id="memo-modal">
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div id="modal-date-label"></div>
        <div class="modal-close" id="modal-close">√ó</div>
      </div>

      <div class="modal-section-title">„Çπ„ÉÜ„Éº„Çø„Çπ</div>
      <div class="status-chip-row" id="status-chip-row"></div>

      <div class="modal-section-title">Ê•≠ÂãôÊôÇÈñìÔºà1ÂàÜÂçò‰ΩçÔºâ</div>
      <div class="row-time">
        <input id="start-time" class="time-input" type="time" step="60">
        <span style="color:var(--text-muted);font-weight:800;">„Äú</span>
        <input id="end-time" class="time-input" type="time" step="60">
      </div>

      <div class="dup-row">
        <button class="btn-secondary" id="btn-dup-prev">ÂâçÊó•„ÇíË§áË£Ω</button>
        <button class="btn-secondary" id="btn-dup-last">Áõ¥Ëøë„ÇíË§áË£Ω</button>
      </div>

      <div class="modal-section-title">„É°„É¢</div>
      <textarea id="memo-textarea" class="memo-textarea" placeholder="„Åì„ÅÆÊó•„ÅÆ„É°„É¢„ÇíÂÖ•Âäõ"></textarea>

      <div class="modal-section-title" style="margin-top:10px;">Obsidian</div>
      <div class="obs-row">
        <button class="btn-secondary" id="btn-obs-open">üìù Obsidian„ÅßÈñã„Åè</button>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" id="modal-cancel">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="btn-primary" id="modal-save">‰øùÂ≠ò</button>
      </div>
    </div>
  </div>

  <!-- PIN Ë™çË®º„É¢„Éº„ÉÄ„É´ -->
  <div class="modal-backdrop" id="pin-modal">
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div>üîê PIN Ë™çË®º</div>
        <div class="modal-close" id="pin-modal-cancel">√ó</div>
      </div>
      <div class="pin-modal-body">
        <div class="pin-purpose" id="pin-purpose">„Åì„ÅÆÊìç‰Ωú„Å´„ÅØPIN„ÅåÂøÖË¶Å„Åß„Åô</div>
        <div class="pin-dots" id="pin-dots">
          <div class="pin-dot"></div>
          <div class="pin-dot"></div>
          <div class="pin-dot"></div>
          <div class="pin-dot"></div>
        </div>
        <div class="pin-error-msg" id="pin-error"></div>
        <div class="pin-keypad">
          <button class="pin-key" data-key="1">1</button>
          <button class="pin-key" data-key="2">2</button>
          <button class="pin-key" data-key="3">3</button>
          <button class="pin-key" data-key="4">4</button>
          <button class="pin-key" data-key="5">5</button>
          <button class="pin-key" data-key="6">6</button>
          <button class="pin-key" data-key="7">7</button>
          <button class="pin-key" data-key="8">8</button>
          <button class="pin-key" data-key="9">9</button>
          <button class="pin-key pin-key-sm" id="pin-key-cancel">„Ç≠„É£„É≥„Çª„É´</button>
          <button class="pin-key" data-key="0">0</button>
          <button class="pin-key pin-key-sm" id="pin-key-del">‚å´</button>
        </div>
        <div class="pin-lock-msg" id="pin-lock-msg"></div>
      </div>
    </div>
  </div>

  <!-- Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
  <div class="modal-backdrop" id="settings-modal">
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div>Ë®≠ÂÆö</div>
        <div class="modal-close" id="settings-close">√ó</div>
      </div>
      <div class="settings-body">
        <div class="settings-row">
          <div class="settings-label">Obsidian Vault Âêç</div>
          <input id="settings-vault" class="settings-input" type="text" placeholder="‰æã: MyVault">
          <div class="settings-hint">Obsidian„ÅßÈñã„Åè„Å®„Åç„Å´‰Ωø„ÅÜVaultÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</div>
        </div>
        <div class="settings-row">
          <div class="settings-label">Obsidian „Çµ„Éñ„Éï„Ç©„É´„ÉÄ</div>
          <input id="settings-subdir" class="settings-input" type="text" placeholder="‰æã: „ÄêÊ•≠Âãô„Äë/Âã§ÊÄ†">
          <div class="settings-hint">Vault„ÅÆ„Å©„ÅÆ„Éï„Ç©„É´„ÉÄ„Å´MD„Éï„Ç°„Ç§„É´„ÇíÈñã„Åè„Åã„ÅÆ„Éë„Çπ„ÄÇ</div>
        </div>
        <hr style="border:none;border-top:1px solid var(--border-soft);margin:4px 0;">
        <div class="settings-row">
          <div class="settings-label">üè¢ jinjer ÊâìÂàªURL</div>
          <input id="settings-jinjer-url" class="settings-input" type="url" placeholder="https://kintai.jinjer.biz/staffs/top">
          <div class="settings-hint">„Éè„Éñ„ÅÆ„ÄåjinjerÊâìÂàª„Äç„Éú„Çø„É≥„ÅÆÈÅ∑ÁßªÂÖàURL„ÄÇ‰ºöÁ§æ„Å´„Çà„Å£„Å¶„ÅØÁï∞„Å™„Çã„Éâ„É°„Ç§„É≥„ÅÆÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ</div>
        </div>
        <div class="settings-row">
          <div class="settings-label">üè¢ jinjer ‰ºöÁ§æ„Ç≥„Éº„Éâ</div>
          <input id="settings-jinjer-company" class="settings-input" type="text" placeholder="‰æã: 15733" autocomplete="off">
        </div>
        <div class="settings-row">
          <div class="settings-label">üìß jinjer „É°„Éº„É´ / Á§æÂì°„Ç≥„Éº„Éâ</div>
          <input id="settings-jinjer-email" class="settings-input" type="text" placeholder="„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ or Á§æÂì°„Ç≥„Éº„Éâ" autocomplete="off">
        </div>
        <div class="settings-row">
          <div class="settings-label">üîë jinjer „Éë„Çπ„ÉØ„Éº„Éâ</div>
          <input id="settings-jinjer-pass" class="settings-input" type="password" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ" autocomplete="new-password">
          <div class="settings-hint">TailscaleÁµåÁî±„ÅÆËá™ÂãïÂêåÊúü„Å´‰Ωø„ÅÑ„Åæ„Åô„ÄÇÁ´ØÊú´ÂÜÖ„Å´„ÅÆ„Åø‰øùÂ≠ò„Åï„Çå„Åæ„Åô„ÄÇ</div>
        </div>
        <div class="settings-row">
          <div class="settings-label">üìç Â§©Ê∞ó„ÅÆÂèñÂæóÂ†¥ÊâÄ</div>
          <select id="settings-city" class="settings-input">
            <option value="">üìç GPS Ëá™ÂãïÂèñÂæóÔºàÊé®Â•®Ôºâ</option>
            <optgroup label="üáØüáµ Êó•Êú¨">
              <option value="Tokyo">Êù±‰∫¨</option>
              <option value="Yokohama">Ê®™Êµú</option>
              <option value="Osaka">Â§ßÈò™</option>
              <option value="Kyoto">‰∫¨ÈÉΩ</option>
              <option value="Kobe">Á•ûÊà∏</option>
              <option value="Nagoya">ÂêçÂè§Â±ã</option>
              <option value="Sapporo">Êú≠Âπå</option>
              <option value="Sendai">‰ªôÂè∞</option>
              <option value="Hiroshima">Â∫ÉÂ≥∂</option>
              <option value="Fukuoka">Á¶èÂ≤°</option>
              <option value="Naha">ÈÇ£Ë¶áÔºàÊ≤ñÁ∏ÑÔºâ</option>
            </optgroup>
            <optgroup label="üá∞üá∑ ÈüìÂõΩ„Éªüá®üá≥ ‰∏≠ÂõΩ">
              <option value="Seoul">„ÇΩ„Ç¶„É´</option>
              <option value="Busan">ÈáúÂ±±</option>
              <option value="Beijing">Âåó‰∫¨</option>
              <option value="Shanghai">‰∏äÊµ∑</option>
              <option value="Shenzhen">Ê∑±„Çª„É≥</option>
              <option value="Chengdu">ÊàêÈÉΩ</option>
            </optgroup>
            <optgroup label="üáπüáºüá≠üá∞ Âè∞Êπæ„ÉªÈ¶ôÊ∏Ø">
              <option value="Taipei">Âè∞Âåó</option>
              <option value="Hong Kong">È¶ôÊ∏Ø</option>
            </optgroup>
            <optgroup label="üåè Êù±Âçó„Ç¢„Ç∏„Ç¢">
              <option value="Bangkok">„Éê„É≥„Ç≥„ÇØ</option>
              <option value="Singapore">„Ç∑„É≥„Ç¨„Éù„Éº„É´</option>
              <option value="Kuala Lumpur">„ÇØ„Ç¢„É©„É´„É≥„Éó„Éº„É´</option>
              <option value="Ho Chi Minh City">„Éõ„Éº„ÉÅ„Éü„É≥</option>
              <option value="Hanoi">„Éè„Éé„Ç§</option>
              <option value="Jakarta">„Ç∏„É£„Ç´„É´„Çø</option>
              <option value="Manila">„Éû„Éã„É©</option>
              <option value="Yangon">„É§„É≥„Ç¥„É≥</option>
            </optgroup>
            <optgroup label="üáÆüá≥ Âçó„Ç¢„Ç∏„Ç¢„Éªüá¶üá™ ‰∏≠Êù±">
              <option value="Mumbai">„É†„É≥„Éê„Ç§</option>
              <option value="Delhi">„Éá„É™„Éº</option>
              <option value="Dubai">„Éâ„Éê„Ç§</option>
              <option value="Riyadh">„É™„É§„Éâ</option>
            </optgroup>
            <optgroup label="üá¶üá∫ „Ç™„Çª„Ç¢„Éã„Ç¢">
              <option value="Sydney">„Ç∑„Éâ„Éã„Éº</option>
              <option value="Melbourne">„É°„É´„Éú„É´„É≥</option>
              <option value="Brisbane">„Éñ„É™„Çπ„Éô„É≥</option>
              <option value="Auckland">„Ç™„Éº„ÇØ„É©„É≥„Éâ</option>
            </optgroup>
            <optgroup label="üá¨üáßüá´üá∑ „É®„Éº„É≠„ÉÉ„Éë">
              <option value="London">„É≠„É≥„Éâ„É≥</option>
              <option value="Paris">„Éë„É™</option>
              <option value="Berlin">„Éô„É´„É™„É≥</option>
              <option value="Rome">„É≠„Éº„Éû</option>
              <option value="Madrid">„Éû„Éâ„É™„Éº„Éâ</option>
              <option value="Amsterdam">„Ç¢„É†„Çπ„ÉÜ„É´„ÉÄ„É†</option>
              <option value="Zurich">„ÉÅ„É•„Éº„É™„ÉÉ„Éí</option>
              <option value="Stockholm">„Çπ„Éà„ÉÉ„ÇØ„Éõ„É´„É†</option>
              <option value="Vienna">„Ç¶„Ç£„Éº„É≥</option>
              <option value="Warsaw">„ÉØ„É´„Ç∑„É£„ÉØ</option>
              <option value="Moscow">„É¢„Çπ„ÇØ„ÉØ</option>
            </optgroup>
            <optgroup label="üá∫üá∏üá®üá¶ ÂåóÁ±≥">
              <option value="New York">„Éã„É•„Éº„É®„Éº„ÇØ</option>
              <option value="Los Angeles">„É≠„Çµ„É≥„Çº„É´„Çπ</option>
              <option value="Chicago">„Ç∑„Ç´„Ç¥</option>
              <option value="San Francisco">„Çµ„É≥„Éï„É©„É≥„Ç∑„Çπ„Ç≥</option>
              <option value="Seattle">„Ç∑„Ç¢„Éà„É´</option>
              <option value="Miami">„Éû„Ç§„Ç¢„Éü</option>
              <option value="Toronto">„Éà„É≠„É≥„Éà</option>
              <option value="Vancouver">„Éê„É≥„ÇØ„Éº„Éê„Éº</option>
            </optgroup>
            <optgroup label="üáßüá∑ ‰∏≠ÂçóÁ±≥">
              <option value="Mexico City">„É°„Ç≠„Ç∑„Ç≥„Ç∑„ÉÜ„Ç£</option>
              <option value="S√£o Paulo">„Çµ„É≥„Éë„Ç¶„É≠</option>
              <option value="Buenos Aires">„Éñ„Ç®„Éé„Çπ„Ç¢„Ç§„É¨„Çπ</option>
            </optgroup>
            <optgroup label="üåç „Ç¢„Éï„É™„Ç´">
              <option value="Cairo">„Ç´„Ç§„É≠</option>
              <option value="Lagos">„É©„Ç¥„Çπ</option>
              <option value="Nairobi">„Éä„Ç§„É≠„Éì</option>
            </optgroup>
          </select>
          <div class="settings-hint">Â§©Ê∞ó‰∫àÂ†±„Å´‰Ωø„ÅÜÂ†¥ÊâÄ„ÄÇGPSËá™ÂãïÂèñÂæó„Å™„ÇâÁ©∫Ê¨Ñ„ÅÆ„Åæ„ÅæÔºà„Éñ„É©„Ç¶„Ç∂„ÅÆ‰ΩçÁΩÆÊÉÖÂ†±Ë®±ÂèØ„ÅåÂøÖË¶ÅÔºâ„ÄÇ</div>
        </div>
        <div class="settings-row">
          <div class="settings-label">üë§ ÊÄßÂà•ÔºàAmazonÊ§úÁ¥¢ÊúÄÈÅ©ÂåñÔºâ</div>
          <select id="settings-style-gender" class="settings-input">
            <option value="„É°„É≥„Ç∫">„É°„É≥„Ç∫</option>
            <option value="„É¨„Éá„Ç£„Éº„Çπ">„É¨„Éá„Ç£„Éº„Çπ</option>
            <option value="">ÊåáÂÆö„Å™„Åó</option>
          </select>
        </div>
        <div class="settings-row">
          <div class="settings-label">üëî „Éï„Ç°„ÉÉ„Ç∑„Éß„É≥„Çπ„Çø„Ç§„É´</div>
          <select id="settings-style-type" class="settings-input">
            <option value="casual">„Ç´„Ç∏„É•„Ç¢„É´</option>
            <option value="business">„Éì„Ç∏„Éç„Çπ / „Ç™„Éï„Ç£„Çπ</option>
            <option value="street">„Çπ„Éà„É™„Éº„Éà</option>
            <option value="sports">„Çπ„Éù„Éº„ÉÜ„Ç£</option>
            <option value="formal">„Éï„Ç©„Éº„Éû„É´</option>
            <option value="outdoor">„Ç¢„Ç¶„Éà„Éâ„Ç¢</option>
          </select>
        </div>
        <div class="settings-row">
          <div class="settings-label">üé® Â•Ω„Åø„ÅÆ„Ç´„É©„ÉºÁ≥ªÁµ±</div>
          <select id="settings-style-color" class="settings-input">
            <option value="basic">„Éô„Éº„Ç∑„ÉÉ„ÇØÔºàÁôΩ„ÉªÈªí„Éª„Ç∞„É¨„ÉºÔºâ</option>
            <option value="earth">„Ç¢„Éº„ÇπÁ≥ªÔºà„Éô„Éº„Ç∏„É•„Éª„Éñ„É©„Ç¶„É≥Ôºâ</option>
            <option value="dark">„ÉÄ„Éº„ÇØÁ≥ªÔºà„Éç„Ç§„Éì„Éº„ÉªÈªíÔºâ</option>
            <option value="bright">„Éì„Éì„ÉÉ„ÉâÔºà„Ç´„É©„Éï„É´Ôºâ</option>
            <option value="pastel">„Éë„Çπ„ÉÜ„É´ÔºàÊ∑°„ÅÑËâ≤Ôºâ</option>
          </select>
          <div class="settings-hint">„Çπ„Çø„Ç§„É´„Å®Ëâ≤„ÅÆÂ•Ω„Åø„ÇíË®≠ÂÆö„Åô„Çã„Å®„ÄÅÊúçË£ÖÊèêÊ°à„ÅåÊúÄÈÅ©Âåñ„Åï„Çå„Åæ„Åô„ÄÇ</div>
        </div>
        <hr style="border:none;border-top:1px solid var(--border-soft);margin:4px 0;">
        <div class="settings-row">
          <div class="settings-label">üîí Tailscale MacBook IP</div>
          <input type="text" id="settings-ts-mac" class="settings-input" placeholder="‰æã: 100.65.221.66" autocomplete="off" inputmode="decimal">
        </div>
        <div class="settings-row">
          <div class="settings-label">üì± Tailscale iPhone IP</div>
          <input type="text" id="settings-ts-iphone" class="settings-input" placeholder="‰æã: 100.93.30.114" autocomplete="off" inputmode="decimal">
        </div>
        <div class="settings-row">
          <div class="settings-label">üë§ SSH „É¶„Éº„Ç∂„ÉºÂêç</div>
          <input type="text" id="settings-ts-user" class="settings-input" placeholder="‰æã: your_username" autocomplete="off">
          <div class="settings-hint">Ë®≠ÂÆö„Åô„Çã„Å®„Éè„Éñ„Å´Tailscale VPN„Ç´„Éº„Éâ„ÅåË°®Á§∫„Åï„Çå„ÄÅiPhone„Åã„ÇâSSHÊé•Á∂ö„Åß„Åç„Åæ„Åô„ÄÇ</div>
        </div>
        <hr style="border:none;border-top:1px solid var(--border-soft);margin:4px 0;">
        <div class="settings-row">
          <div class="settings-label">üîê „Çª„Ç≠„É•„É™„ÉÜ„Ç£PIN</div>
          <div class="settings-hint" id="pin-status-hint" style="margin-bottom:6px;"></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn-secondary" id="btn-set-pin" style="flex:1;">PIN„ÇíË®≠ÂÆö/Â§âÊõ¥</button>
            <button class="btn-secondary" id="btn-clear-pin" style="flex:1;color:#c62828;display:none;">PIN„ÇíËß£Èô§</button>
          </div>
          <div class="settings-hint" style="margin-top:6px;">
            Âç±Èô∫„Å™Êìç‰ΩúÔºàÂÖ®„Éá„Éº„ÇøÊ∂àÂéª„Å™„Å©Ôºâ„Å´PIN„É≠„ÉÉ„ÇØ„Çí„Åã„Åë„Åæ„Åô„ÄÇ4„Äú6Ê°Å„ÅÆÊï∞Â≠ó„ÄÇ
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="settings-cancel">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="btn-primary" id="settings-save">‰øùÂ≠ò</button>
      </div>
    </div>
  </div>

  <!-- Task modal -->
  <div class="modal-backdrop" id="task-modal">
    <div class="modal-sheet" style="max-height:85vh;overflow:hidden;display:flex;flex-direction:column;">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div>üìã „Çø„Çπ„ÇØ</div>
        <div class="modal-close" id="task-modal-close">√ó</div>
      </div>
      <div class="task-add-form">
        <input id="task-title-input" class="task-add-input" type="text" placeholder="„Çø„Çπ„ÇØÂêç„ÇíÂÖ•Âäõ">
        <textarea id="task-memo-input" class="task-add-input task-add-textarea" placeholder="„É°„É¢Ôºà‰ªªÊÑèÔºâ"></textarea>
        <button class="task-add-submit" id="task-add-btn">Ôºã ËøΩÂä†</button>
      </div>
      <div id="task-list-container" style="overflow-y:auto;flex:1;padding-bottom:16px;"></div>
    </div>
  </div>

  <!-- Emergency recovery modal -->
  <div class="modal-backdrop" id="emergency-modal">
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div style="color:#c62828;">üö® Á∑äÊÄ•Âæ©Êóß</div>
        <div class="modal-close" id="emergency-modal-close">√ó</div>
      </div>
      <div class="emergency-modal-body">
        <div class="emergency-section-title">„ÇØ„Ç§„ÉÉ„ÇØÂæ©Êóß</div>
        <button class="emergency-btn emergency-btn-safe" id="em-sw-reload">üîÑ Service Worker „ÇíÂº∑Âà∂Êõ¥Êñ∞</button>
        <button class="emergency-btn emergency-btn-warn" id="em-cache-clear">üóÇ „Ç≠„É£„ÉÉ„Ç∑„É•„ÉªSW„Çí„ÇØ„É™„Ç¢Ôºà„Éá„Éº„Çø‰øùÊåÅÔºâ</button>
        <button class="emergency-btn emergency-btn-warn" id="em-snap-restore">üì¶ Ëá™Âãï„Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„Éà„Åã„ÇâÂæ©ÂÖÉ</button>

        <div class="emergency-section-title">ÂÆåÂÖ®„É™„Çª„ÉÉ„Éà</div>
        <button class="emergency-btn emergency-btn-danger" id="em-full-reset">üóë ÂÖ®„Éá„Éº„ÇøÊ∂àÂéª„Åó„Å¶„É™„Çª„ÉÉ„Éà</button>
        <a href="./recover.html" class="emergency-btn emergency-btn-link" style="text-decoration:none;display:block;">üîó recover.html „ÇíÈñã„ÅèÔºàË©≥Á¥∞Ôºâ</a>

        <div class="emergency-section-title">Ë®∫Êñ≠ÊÉÖÂ†±</div>
        <div class="emergency-diag" id="em-diag">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
      </div>
    </div>
  </div>

  <!-- Emergency FAB -->
  <button class="fab-recover" id="fab-recover" title="Á∑äÊÄ•Âæ©Êóß">üö®</button>

  <!-- Floating today button -->
  <button class="fab-today" id="fab-today">
    <span class="fab-day" id="fab-day">--</span>
    <span class="fab-label">‰ªäÊó•</span>
  </button>

  <!-- Task FAB -->
  <button class="fab-task" id="fab-task">üìã</button>

  <!-- Bottom Tab Navigation -->
  <nav class="bottom-tabs" id="bottom-tabs">
    <button class="tab-btn active" data-tab="calendar">
      <span class="tab-icon">üìÖ</span>Âã§ÊÄ†
    </button>
    <button class="tab-btn" data-tab="hub">
      <span class="tab-icon">üöÄ</span>„Éè„Éñ
    </button>
    <button class="tab-btn" data-tab="study">
      <span class="tab-icon">üìö</span>Â≠¶Áøí
    </button>
    <button class="tab-btn" data-tab="project">
      <span class="tab-icon">üìä</span>ÈÄ≤Êçó
    </button>
  </nav>

  <!-- Progress overlayÔºàjinjerÂêåÊúü„ÉªÈáç„ÅÑÂá¶ÁêÜÁî®Ôºâ -->
  <div class="progress-overlay" id="progress-overlay">
    <div class="progress-box">
      <div class="progress-spinner" id="progress-spinner"></div>
      <div class="progress-title" id="progress-title">Âá¶ÁêÜ‰∏≠...</div>
      <div class="progress-bar-wrap">
        <div class="progress-bar-fill" id="progress-bar"></div>
      </div>
      <div class="progress-step" id="progress-step"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Log viewer modal -->
  <div class="modal-backdrop" id="log-modal">
    <div class="modal-sheet" style="max-height:85vh;overflow:hidden;display:flex;flex-direction:column;">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div class="modal-title">üìã „Ç∑„Çπ„ÉÜ„É†„É≠„Ç∞</div>
        <button class="modal-close" id="log-close">‚úï</button>
      </div>
      <div style="padding:0 14px 6px;display:flex;align-items:center;gap:8px;">
        <span style="font-size:11px;color:var(--text-muted);flex-shrink:0;">üìÖ Êó•‰ªò:</span>
        <select id="log-date-sel" style="font-size:11px;border:1px solid var(--border-soft);border-radius:8px;padding:3px 8px;background:#f4f5f9;font-family:inherit;flex:1;min-width:0;"></select>
      </div>
      <div class="log-filter-bar">
        <button class="log-filter-btn active" data-filter="all">„Åô„Åπ„Å¶</button>
        <button class="log-filter-btn" data-filter="fatal">üíÄ Ëá¥ÂëΩ</button>
        <button class="log-filter-btn" data-filter="error">üî¥ „Ç®„É©„Éº</button>
        <button class="log-filter-btn" data-filter="warn">üü° Ë≠¶Âëä</button>
        <button class="log-filter-btn" data-filter="info">üîµ ÊÉÖÂ†±</button>
      </div>
      <div style="overflow-y:auto;flex:1;padding:0 14px 12px;" id="log-scroll">
        <div id="log-list"></div>
      </div>
      <div class="modal-footer" style="gap:8px;">
        <button class="btn-secondary" id="log-clear" style="flex:1;">üóë „É≠„Ç∞Ê∂àÂéª</button>
        <button class="btn-primary" id="log-close2" style="flex:1;">Èñâ„Åò„Çã</button>
      </div>
    </div>
  </div>

  <!-- jinjer ÂêåÊúü„Çπ„ÉÜ„Éº„Çø„Çπ„É¢„Éº„ÉÄ„É´ -->
  <div class="modal-backdrop" id="jinjer-sync-modal">
    <div class="modal-sheet" style="max-height:70vh;">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div class="modal-title">üè¢ jinjerÂêåÊúü</div>
        <button class="modal-close" id="jinjer-sync-close">‚úï</button>
      </div>
      <div style="padding:4px 16px 16px;">
        <!-- ÂêåÊúüÊñπÊ≥ï„ÅÆÈÅ∏Êäû -->
        <div id="jinjer-sync-opts">
          <button class="jinjer-sync-opt-btn" id="jinjer-sync-opt-file">
            <div class="jinjer-sync-opt-title">üìÇ „Éï„Ç°„Ç§„É´„Åã„ÇâÂêåÊúü</div>
            <div class="jinjer-sync-opt-sub">iCloud kintai„Éï„Ç©„É´„ÉÄ„ÅÆJSON„ÇíË™≠„ÅøËæº„ÇÄ</div>
          </button>
          <button class="jinjer-sync-opt-btn" id="jinjer-sync-opt-auto">
            <div class="jinjer-sync-opt-title">üñ• Mac„Åã„ÇâËá™ÂãïÂêåÊúü</div>
            <div class="jinjer-sync-opt-sub">TailscaleÁµåÁî±„ÅßMac„ÅÆ„Çµ„Éº„Éê„Éº„Åã„ÇâÂèñÂæó</div>
          </button>
        </div>
        <div id="jinjer-sync-status" style="font-size:13px;color:var(--text-sub);text-align:center;padding:16px 0;line-height:1.6;display:none;"></div>
        <div id="jinjer-sync-cmd-box" style="display:none;margin-top:4px;">
          <div style="font-size:11px;font-weight:800;color:var(--text-muted);margin-bottom:6px;">Mac„Åß‰ª•‰∏ã„ÇíÂÆüË°å„Åó„Å¶„Çµ„Éº„Éê„Éº„ÇíËµ∑Âãï:</div>
          <div style="background:#1a1a2e;color:#e0f2fe;border-radius:10px;padding:10px 12px;font-family:monospace;font-size:11px;line-height:1.6;word-break:break-all;" id="jinjer-sync-cmd-text"></div>
          <button class="btn-secondary" id="jinjer-sync-cmd-copy" style="width:100%;margin-top:8px;font-size:11px;">üìã „Ç≥„Éû„É≥„Éâ„Çí„Ç≥„Éî„Éº</button>
          <button class="btn-secondary" id="jinjer-sync-retry" style="width:100%;margin-top:6px;font-size:11px;">üîÑ ÂÜçË©¶Ë°å</button>
        </div>
      </div>
    </div>
  </div>

  <!-- „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„Éì„É•„Éº„Ç¢„Éº„É¢„Éº„ÉÄ„É´ -->
  <div class="modal-backdrop" id="perf-modal">
    <div class="modal-sheet" style="max-height:88vh;overflow:hidden;display:flex;flex-direction:column;">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div class="modal-title">üìä „Ç∑„Çπ„ÉÜ„É†„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ</div>
        <button class="modal-close" id="perf-close">‚úï</button>
      </div>
      <div style="overflow-y:auto;flex:1;padding:4px 16px 16px;" id="perf-content">
        <div style="text-align:center;color:var(--text-muted);font-size:13px;padding:24px 0;">Ë®àÊ∏¨‰∏≠‚Ä¶</div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="perf-refresh" style="flex:1;">üîÑ ÂÜçË®àÊ∏¨</button>
        <button class="btn-primary" id="perf-close2" style="flex:1;">Èñâ„Åò„Çã</button>
      </div>
    </div>
  </div>

  <!-- Ë≠∞‰∫ãÈå≤„ÉªÊñáÂ≠óËµ∑„Åì„Åó„É¢„Éº„ÉÄ„É´ -->
  <div class="modal-backdrop" id="min-modal">
    <div class="modal-sheet" style="max-height:92vh;overflow:hidden;display:flex;flex-direction:column;">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div class="modal-title">üìù Ë≠∞‰∫ãÈå≤„ÉªÊñáÂ≠óËµ∑„Åì„Åó</div>
        <button class="modal-close" id="min-close">‚úï</button>
      </div>
      <!-- „Çø„Éñ -->
      <div style="display:flex;border-bottom:1px solid var(--border-soft);margin:0 -16px;padding:0 16px;flex-shrink:0;">
        <button id="min-tab-rec"  style="flex:1;padding:8px 0;font-size:12px;font-weight:800;font-family:inherit;border:none;background:none;border-bottom:2.5px solid var(--accent-blue);color:var(--accent-blue);cursor:pointer;">üéô Èå≤Èü≥</button>
        <button id="min-tab-hist" style="flex:1;padding:8px 0;font-size:12px;font-weight:800;font-family:inherit;border:none;background:none;border-bottom:2.5px solid transparent;color:var(--text-muted);cursor:pointer;">üìÅ Â±•Ê≠¥</button>
        <button id="min-tab-video" style="flex:1;padding:8px 0;font-size:12px;font-weight:800;font-family:inherit;border:none;background:none;border-bottom:2.5px solid transparent;color:var(--text-muted);cursor:pointer;">üé¨ ÂãïÁîª</button>
      </div>
      <!-- Èå≤Èü≥„Éë„Éç„É´ -->
      <div id="min-panel-rec" style="flex:1;display:flex;flex-direction:column;min-height:0;overflow:hidden;padding-top:10px;">
        <input id="min-title" class="settings-input" type="text" placeholder="‰ºöË≠∞ÂêçÔºà‰æã: ÈÄ±Ê¨°MTGÔºâ" style="flex-shrink:0;margin-bottom:4px;">
        <div class="min-controls">
          <button class="min-rec-btn start" id="min-rec-btn">üî¥ Èå≤Èü≥ÈñãÂßã</button>
          <span class="min-timer" id="min-timer">00:00</span>
          <span class="min-status-badge" id="min-status" style="display:none;">üéô Ë™çË≠ò‰∏≠</span>
        </div>
        <div class="min-transcript" id="min-transcript">
          <div id="min-transcript-body">
            <div style="text-align:center;color:var(--text-muted);padding:28px 0;font-size:12px;line-height:1.8;">
              üéô Èå≤Èü≥ÈñãÂßã„Åß„É™„Ç¢„É´„Çø„Ç§„É†ÊñáÂ≠óËµ∑„Åì„Åó<br>
              <span style="font-size:11px;">ÂØæÂøú: Chrome / Safari (iOS 14.5+)„ÄÄÊó•Êú¨Ë™û Á≤æÂ∫¶È´ò</span>
            </div>
          </div>
        </div>
        <div class="min-actions">
          <button class="min-action-btn" id="min-copy">üìã „Ç≥„Éî„Éº</button>
          <button class="min-action-btn" id="min-md">üìÑ MD‰øùÂ≠ò</button>
          <button class="min-action-btn" id="min-obsidian">üîó Obsidian</button>
          <button class="min-action-btn" id="min-save-min">üíæ ‰øùÂ≠ò</button>
          <button class="min-action-btn" id="min-clear" style="color:#c62828;">üóë „ÇØ„É™„Ç¢</button>
        </div>
      </div>
      <!-- Â±•Ê≠¥„Éë„Éç„É´ -->
      <div id="min-panel-hist" style="flex:1;display:none;flex-direction:column;min-height:0;overflow:hidden;padding-top:8px;">
        <div id="min-hist-list" style="overflow-y:auto;flex:1;"></div>
      </div>
      <!-- ÂãïÁîªÊñáÂ≠óËµ∑„Åì„Åó„Éë„Éç„É´ -->
      <div id="min-panel-video" style="flex:1;display:none;flex-direction:column;min-height:0;overflow:hidden;padding-top:10px;">
        <input id="min-video-title" class="settings-input" type="text" placeholder="„Éï„Ç°„Ç§„É´ÂêçÔºàËá™ÂãïÂÖ•ÂäõÔºâ" style="flex-shrink:0;margin-bottom:6px;">
        <div style="flex-shrink:0;margin-bottom:8px;">
          <button class="min-action-btn" id="min-video-pick" style="width:100%;font-size:13px;padding:10px 0;">üìÅ ÂãïÁîª„ÉªÈü≥Â£∞„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû</button>
          <input type="file" id="min-video-file" accept="video/*,audio/*" style="display:none">
        </div>
        <div id="min-video-player-wrap" style="display:none;flex-shrink:0;margin-bottom:8px;padding:0 2px;">
          <audio id="min-video-audio" controls style="width:100%;height:36px;"></audio>
          <div id="min-video-file-info" style="font-size:11px;color:var(--text-muted);margin-top:4px;text-align:center;"></div>
        </div>
        <div id="min-video-status" style="font-size:12px;font-weight:700;color:var(--accent-blue);text-align:center;padding:4px 0;display:none;flex-shrink:0;"></div>
        <div class="min-transcript" id="min-video-transcript" style="flex:1;overflow-y:auto;">
          <div id="min-video-transcript-body">
            <div style="text-align:center;color:var(--text-muted);padding:28px 0;font-size:12px;line-height:1.8;">
              üìÅ ÂãïÁîª„Åæ„Åü„ÅØÈü≥Â£∞„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶<br>„ÄåÊñáÂ≠óËµ∑„Åì„ÅóÈñãÂßã„Äç„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ<br>
              <span style="font-size:11px;opacity:0.8;">‚ö†Ô∏è „Çπ„Éî„Éº„Ç´„ÉºÂÜçÁîüÔºã„Éû„Ç§„ÇØË™çË≠òÊñπÂºè<br>„Éò„ÉÉ„Éâ„Éï„Ç©„É≥„ÇíÂ§ñ„Åó„Å¶„Åî‰ΩøÁî®„Åè„Å†„Åï„ÅÑ</span>
            </div>
          </div>
        </div>
        <div class="min-actions" style="flex-shrink:0;">
          <button class="min-action-btn" id="min-video-start">‚ñ∂ ÊñáÂ≠óËµ∑„Åì„ÅóÈñãÂßã</button>
          <button class="min-action-btn" id="min-video-stop" style="display:none;color:#c62828;">‚èπ ÂÅúÊ≠¢</button>
          <button class="min-action-btn" id="min-video-copy">üìã „Ç≥„Éî„Éº</button>
          <button class="min-action-btn" id="min-video-save">üíæ ‰øùÂ≠ò</button>
          <button class="min-action-btn" id="min-video-clear" style="color:#c62828;">üóë „ÇØ„É™„Ç¢</button>
        </div>
      </div>
    </div>
  </div>

  <!-- „Ç´„É°„É© „Çµ„Ç§„Ç∫Ë®àÊ∏¨„É¢„Éº„ÉÄ„É´ -->
  <div class="modal-backdrop" id="measure-modal">
    <div class="modal-sheet" style="max-height:98vh;overflow:hidden;display:flex;flex-direction:column;">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div class="modal-title">üìè „Çµ„Ç§„Ç∫Ë®àÊ∏¨</div>
        <button class="modal-close" id="measure-close">‚úï</button>
      </div>
      <!-- „Ç´„É°„É©„Éì„É•„Éº„Éù„Éº„Éà -->
      <div id="measure-cam-wrap" style="position:relative;background:#111;overflow:hidden;flex:1;min-height:180px;max-height:46vh;">
        <video id="measure-video" style="width:100%;height:100%;object-fit:cover;display:block;" playsinline muted></video>
        <canvas id="measure-canvas" style="position:absolute;top:0;left:0;width:100%;height:100%;touch-action:none;"></canvas>
        <div id="measure-cam-msg" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.75);font-size:13px;pointer-events:none;text-align:center;padding:16px;background:rgba(0,0,0,0.55);">üì∑ „Ç´„É°„É©„ÇíËµ∑Âãï‰∏≠...</div>
      </div>
      <!-- „Çπ„ÉÜ„ÉÉ„ÉóË°®Á§∫ -->
      <div id="measure-step" style="padding:8px 16px 2px;font-size:12px;font-weight:700;color:var(--accent-blue);text-align:center;flex-shrink:0;min-height:26px;"></div>
      <!-- „Ç≥„É≥„Éà„É≠„Éº„É´ -->
      <div style="padding:4px 16px 14px;flex-shrink:0;overflow-y:auto;">
        <!-- ‚ë† Âü∫Ê∫ñÁâ© -->
        <div style="margin-bottom:10px;">
          <div style="font-size:11px;font-weight:800;color:var(--text-muted);margin-bottom:6px;">‚ë† Âü∫Ê∫ñÁâ©„ÇíÁîªÈù¢ÂÜÖ„Å´ÁΩÆ„ÅÑ„Å¶„Çø„ÉÉ„Éó„ÅßÊåáÂÆö:</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;">
            <button class="measure-ref-btn active" data-w="85.6" data-label="„ÇØ„É¨„Ç´ÂπÖ">üí≥ „ÇØ„É¨„Ç´ (85.6mm)</button>
            <button class="measure-ref-btn" data-w="26.5" data-label="500ÂÜÜÁéâÂæÑ">ü™ô 500ÂÜÜÁéâ (26.5mm)</button>
            <button class="measure-ref-btn" data-w="210" data-label="A4ÂπÖ">üìÑ A4ÂπÖ (210mm)</button>
          </div>
        </div>
        <!-- ‚ë° Ë®àÊ∏¨ÁÆáÊâÄ -->
        <div style="margin-bottom:10px;">
          <div style="font-size:11px;font-weight:800;color:var(--text-muted);margin-bottom:6px;">‚ë° Ë®àÊ∏¨„Åô„ÇãÁÆáÊâÄ„ÇíÈÅ∏Êäû:</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;">
            <button class="measure-type-btn active" data-type="foot">üëü Ë∂≥„ÅÆÈï∑„Åï</button>
            <button class="measure-type-btn" data-type="shoulder">üëî ËÇ©ÂπÖ</button>
            <button class="measure-type-btn" data-type="waist">üëñ „Ç¶„Ç®„Çπ„Éà</button>
            <button class="measure-type-btn" data-type="custom">üìê Ëá™Áî±Ë®àÊ∏¨</button>
          </div>
        </div>
        <!-- Ë®àÊ∏¨ÁµêÊûú -->
        <div id="measure-result" style="display:none;background:var(--bg-hover);border-radius:14px;padding:12px;text-align:center;margin-bottom:10px;">
          <div id="measure-result-mm" style="font-size:22px;font-weight:900;color:var(--accent-blue);"></div>
          <div id="measure-result-size" style="font-size:12px;color:var(--text-sub);margin-top:4px;line-height:1.7;"></div>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="btn-secondary" id="measure-reset" style="flex:1;font-size:12px;">üóë „É™„Çª„ÉÉ„Éà</button>
          <button class="btn-secondary" id="measure-flip" style="flex:1;font-size:12px;">üîÑ „Ç´„É°„É©ÂàáÊõø</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* =====================================================
       HIGH-AVAILABILITY: Á∑äÊÄ•„É™„Çª„ÉÉ„Éà / „ÇØ„É©„ÉÉ„Ç∑„É•Ê§úÂá∫ / „Ç∞„É≠„Éº„Éê„É´„Ç®„É©„ÉºÊçïÊçâ
       ===================================================== */

    // ‚ë† URL„Éë„É©„É°„Éº„Çø„Å´„Çà„ÇãÁ∑äÊÄ•„É™„Çª„ÉÉ„Éà (?reset)
    if (location.search.includes('reset')) {
      (async () => {
        try { const r = await navigator.serviceWorker.getRegistrations(); for(const s of r) await s.unregister(); } catch(_){}
        try { const k = await caches.keys(); await Promise.all(k.map(c => caches.delete(c))); } catch(_){}
        try { localStorage.clear(); } catch(_){}
        try { indexedDB.deleteDatabase('kintai_idb'); } catch(_){}
        location.replace(location.pathname); // ?reset „ÇíÈô§„ÅÑ„Å¶„É™„É≠„Éº„Éâ
      })();
    }

    // ‚ë° „ÇØ„É©„ÉÉ„Ç∑„É•„É´„Éº„ÉóÊ§úÂá∫Ôºà3ÂõûÈÄ£Á∂ö„Åß„ÇØ„É©„ÉÉ„Ç∑„É•„Åó„Åü„ÇâÂæ©ÊóßUI„ÇíË°®Á§∫Ôºâ
    //    sessionStorage „ÅØiOS„Åå„Éó„É≠„Çª„Çπ„Çíkill„Åô„Çã„Å®Ê∂à„Åà„Çã„Åü„ÇÅ localStorage „Çí‰Ωø„ÅÜ
    const _CRASH_KEY = '_kintai_crash';
    const _crashes   = Number(localStorage.getItem(_CRASH_KEY) || 0);
    localStorage.setItem(_CRASH_KEY, _crashes + 1);
    window.addEventListener('load', () => localStorage.setItem(_CRASH_KEY, '0'));

    if (_crashes >= 3) {
      document.addEventListener('DOMContentLoaded', () => {
        document.body.innerHTML = `
          <div style="font-family:-apple-system,sans-serif;max-width:360px;margin:60px auto;padding:24px;
               background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(0,0,0,0.12);text-align:center;">
            <div style="font-size:40px;">üö®</div>
            <h2 style="margin:8px 0 6px;font-size:18px;">„ÇØ„É©„ÉÉ„Ç∑„É•„ÇíÁπ∞„ÇäËøî„Åó„Å¶„ÅÑ„Åæ„Åô</h2>
            <p style="font-size:13px;color:#666;line-height:1.6;margin:0 0 20px">
              „Éá„Éº„Çø„ÅåÁ†¥Êêç„Åó„Å¶„ÅÑ„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ<br>Âæ©Êóß„Éö„Éº„Ç∏„Åß‰øÆÂæ©„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
            </p>
            <a href="./recover.html" style="display:block;background:#4f8dfd;color:#fff;
               padding:13px;border-radius:12px;text-decoration:none;font-weight:700;font-size:15px;
               margin-bottom:10px;">üõ† Âæ©Êóß„Éö„Éº„Ç∏„Å∏</a>
            <button onclick="localStorage.setItem('${_CRASH_KEY}','0');location.reload()"
              style="width:100%;background:#fff;border:1.5px solid #ddd;color:#555;
              padding:11px;border-radius:12px;font-size:14px;cursor:pointer;font-family:inherit;">
              ‚ö° „Åì„ÅÆ„Åæ„ÅæËµ∑Âãï„ÇíÂÜçË©¶Ë°å
            </button>
          </div>`;
      });
      throw new Error('RECOVERY_MODE'); // ‰ª•Èôç„ÅÆ„Çπ„ÇØ„É™„Éó„Éà„Çí‰∏ÄÂàáÂÆüË°å„Åó„Å™„ÅÑ
    }

    // ‚ë¢ „Ç®„É©„Éº„ÉÜ„É¨„É°„Éà„É™Ôºà„É≠„Éº„Ç´„É´ ring buffer ‚Äî ÊúÄÊñ∞20‰ª∂„ÇílocalStorage„Å´‰øùÂ≠òÔºâ
    const _ERR_KEY  = '_kintai_errors';
    const _ERR_MAX  = 20;
    function _logError(type, detail) {
      try {
        const log = JSON.parse(localStorage.getItem(_ERR_KEY) || '[]');
        log.unshift({ ts: new Date().toISOString(), type, detail: String(detail).slice(0, 200) });
        if (log.length > _ERR_MAX) log.length = _ERR_MAX;
        localStorage.setItem(_ERR_KEY, JSON.stringify(log));
      } catch(_) {}
    }
    window.addEventListener('error', ev => {
      _logError('js_error', `${ev.message} @ ${ev.filename}:${ev.lineno}`);
      _appLog('fatal', 'GLOBAL', `${ev.message} @ ${(ev.filename||'').split('/').pop()}:${ev.lineno}`);
    });
    window.addEventListener('unhandledrejection', ev => {
      _logError('unhandled_rejection', ev.reason);
      _appLog('fatal', 'PROMISE', String(ev.reason).slice(0, 200));
      ev.preventDefault(); // iOS Safari „ÅÆÂº∑Âà∂„ÇØ„É©„ÉÉ„Ç∑„É•„ÇíÊäëÂà∂
    });

    // ‚ë£ „Ç¢„Éó„É™„É≠„Ç∞Ôºàring buffer ‚Äî ÊúÄÊñ∞80‰ª∂„ÄÅinfo/warn/error„ÇíË®òÈå≤Ôºâ
    const _LOG_KEY = '_kintai_log';
    const _LOG_MAX = 80;
    const _LOG_ARCHIVE_PFX = '_kintai_daily_';
    const _LOG_ARCHIVE_DAYS = 30;
    function _pruneOldDailyLogs() {
      try {
        const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - _LOG_ARCHIVE_DAYS);
        const cutoffStr = cutoff.toISOString().slice(0, 10);
        const toRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
          const k = localStorage.key(i);
          if (k && k.startsWith(_LOG_ARCHIVE_PFX) && k.slice(_LOG_ARCHIVE_PFX.length) < cutoffStr) toRemove.push(k);
        }
        toRemove.forEach(k => localStorage.removeItem(k));
      } catch(_) {}
    }
    function _appLog(level, source, msg) {
      try {
        const entry = { ts: new Date().toISOString(), level, source, msg: String(msg).slice(0, 300) };
        // „É°„Ç§„É≥„É™„É≥„Ç∞„Éê„ÉÉ„Éï„Ç°ÔºàÁõ¥Ëøë80‰ª∂Ôºâ
        const log = JSON.parse(localStorage.getItem(_LOG_KEY) || '[]');
        log.unshift(entry);
        if (log.length > _LOG_MAX) log.length = _LOG_MAX;
        localStorage.setItem(_LOG_KEY, JSON.stringify(log));
        // Êó•Ê¨°„Ç¢„Éº„Ç´„Ç§„ÉñÔºàsyslogÂΩ¢Âºè„ÄÅ30Êó•‰øùÊåÅÔºâ
        const dayKey = _LOG_ARCHIVE_PFX + entry.ts.slice(0, 10);
        const dayLog = JSON.parse(localStorage.getItem(dayKey) || '[]');
        dayLog.unshift(entry);
        if (dayLog.length > 500) dayLog.length = 500;
        localStorage.setItem(dayKey, JSON.stringify(dayLog));
        if (Math.random() < 0.02) _pruneOldDailyLogs();
      } catch(_) {}
    }
    // console.warn / console.error „Çí„Ç§„É≥„Çø„Éº„Çª„Éó„Éà„Åó„Å¶Ëá™ÂãïË®òÈå≤
    (function patchConsole() {
      const _ow = console.warn.bind(console);
      const _oe = console.error.bind(console);
      function _src(args) {
        const m = String(args[0]).match(/\[([^\]]+)\]/);
        return m ? m[1] : 'app';
      }
      console.warn  = (...a) => { _ow(...a);  _appLog('warn',  _src(a), a.join(' ')); };
      console.error = (...a) => { _oe(...a);  _appLog('error', _src(a), a.join(' ')); };
    })();

    // „É≠„Ç∞„Ç®„É≥„Éà„É™„ÅÆÊîπÂñÑÊèêÊ°à„ÇíËøî„Åô
    function _logSuggestion(source, msg, level) {
      const s = (source || '').toLowerCase();
      const m = (msg || '').toLowerCase();
      if (level === 'fatal') {
        if (m.includes('quota') || m.includes('storage'))
          return '„Çπ„Éà„É¨„Éº„Ç∏„ÅåÊ∫ÄÊùØ„Åß„Åô„ÄÇË®≠ÂÆö ‚Üí Á∑äÊÄ•Âæ©Êóß ‚Üí ‰∏çË¶Å„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
        if (m.includes('syntaxerror') || m.includes('json'))
          return '„Éá„Éº„Çø„ÅåÁ†¥Êêç„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„Éà„Åã„ÇâÂæ©ÂÖÉ„ÇíË©¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
        if (m.includes('referenceerror'))
          return '„Ç¢„Éó„É™„ÅÆÂàùÊúüÂåñ„Ç®„É©„Éº„Åß„Åô„ÄÇ„Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
        return '„ÇØ„É™„ÉÜ„Ç£„Ç´„É´„Ç®„É©„Éº„ÄÇÁîªÈù¢Âè≥‰∏äüö®„Åã„ÇâÁ∑äÊÄ•Âæ©Êóß„ÇíË©¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
      }
      if (s === 'jinjer' || m.includes('jinjer'))
        return 'jinjerÂêåÊúü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇË®≠ÂÆö„ÅßjinjerË™çË®ºÊÉÖÂ†±„ÇíÁ¢∫Ë™ç„ÅóÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
      if (s === 'weather' || m.includes('open-meteo') || m.includes('geocod'))
        return 'Â§©Ê∞óAPI„Å∏„ÅÆÊé•Á∂öÂ§±Êïó„ÄÇË®≠ÂÆö„ÅßÈÉΩÂ∏Ç„ÇíÂ§âÊõ¥„Åô„Çã„ÅãGPSÊ®©Èôê„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
      if (s === 'idb' || m.includes('indexeddb') || m.includes('idbsave'))
        return 'IndexedDB„Å∏„ÅÆ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÅåÂ§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆ„Çπ„Éà„É¨„Éº„Ç∏Ê®©Èôê„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
      if (s === 'serviceworker' || m.includes('serviceworker'))
        return 'Service Worker„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÁ∑äÊÄ•Âæ©Êóß‚ÜíSW„ÇíÂº∑Âà∂Êõ¥Êñ∞„ÇíË©¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
      if (s === 'tailscale' || m.includes('tailscale') || m.includes('timeout'))
        return 'Tailscale„Çø„Ç§„É†„Ç¢„Ç¶„Éà„ÄÇVPN„ÅåÊé•Á∂ö‰∏≠„Åã„ÄÅË®≠ÂÆö„ÅÆMac IP„Ç¢„Éâ„É¨„Çπ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
      if (m.includes('quota') || m.includes('storage'))
        return '„Çπ„Éà„É¨„Éº„Ç∏ÂÆπÈáè‰∏çË∂≥„ÄÇÂè§„ÅÑ„Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„Éà„ÇÑ‰∏çË¶Å„Å™„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
      if (m.includes('network') || m.includes('fetch') || m.includes('failed to fetch'))
        return '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Ç™„Éï„É©„Ç§„É≥„ÅÆÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ';
      if (m.includes('parse') || m.includes('json'))
        return 'JSON„Éá„Éº„Çø„ÅÆËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Ç§„É≥„Éù„Éº„Éà„Éï„Ç°„Ç§„É´„ÅÆÂΩ¢Âºè„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
      return null;
    }

    /* =====================================================
       HA: Ëá™Âãï„Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„ÉàÔºà3‰∏ñ‰ª£„É≠„Éº„É™„É≥„Ç∞‰øùÂ≠òÔºâ
       ===================================================== */
    const _SNAP_KEY   = '_kintai_snap_';   // _kintai_snap_0 / _1 / _2
    const _SNAP_IDX   = '_kintai_snap_idx';
    const _SNAP_GENS  = 3;

    function saveSnapshot(store) {
      try {
        const idx = (Number(localStorage.getItem(_SNAP_IDX) || 0) + 1) % _SNAP_GENS;
        const meta = { ts: new Date().toISOString(), months: Object.keys(store.months || {}).length };
        localStorage.setItem(_SNAP_KEY + idx, JSON.stringify({ meta, data: store }));
        localStorage.setItem(_SNAP_IDX, String(idx));
      } catch(_) {}
    }

    function loadLatestSnapshot() {
      try {
        const idx = Number(localStorage.getItem(_SNAP_IDX) || 0);
        for (let i = 0; i < _SNAP_GENS; i++) {
          const si = (idx - i + _SNAP_GENS) % _SNAP_GENS;
          const raw = localStorage.getItem(_SNAP_KEY + si);
          if (!raw) continue;
          const { meta, data } = JSON.parse(raw);
          if (data && data.months && Object.keys(data.months).length > 0) return { meta, data };
        }
      } catch(_) {}
      return null;
    }

    function listSnapshots() {
      const result = [];
      const idx = Number(localStorage.getItem(_SNAP_IDX) || 0);
      for (let i = 0; i < _SNAP_GENS; i++) {
        const si = (idx - i + _SNAP_GENS) % _SNAP_GENS;
        const raw = localStorage.getItem(_SNAP_KEY + si);
        if (!raw) continue;
        try {
          const { meta } = JSON.parse(raw);
          result.push({ slot: si, ...meta });
        } catch(_) {}
      }
      return result;
    }

    /* =====================================================
       HA: „Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØ & „Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº
       ===================================================== */
    async function runHealthCheck() {
      // localStorage „Çµ„Ç§„Ç∫Êé®ÂÆö
      let lsSize = 0;
      try {
        for (const k of Object.keys(localStorage)) {
          lsSize += (localStorage.getItem(k) || '').length;
        }
      } catch(_) {}

      // IDB Á¢∫Ë™ç
      let idbOk = false;
      try {
        const idbData = await idbLoad();
        idbOk = !!(idbData && Object.keys(idbData.months || {}).length > 0);
      } catch(_) {}

      // „Ç®„É©„ÉºÊï∞
      let errCount = 0;
      try {
        errCount = JSON.parse(localStorage.getItem(_ERR_KEY) || '[]').length;
      } catch(_) {}

      // „Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„ÉàÊúÄÊñ∞ÊôÇÂàª
      const snaps = listSnapshots();
      const latestSnap = snaps.length > 0 ? snaps[0] : null;

      // UI Êõ¥Êñ∞
      const dotLS  = document.getElementById('health-dot-ls');
      const dotIDB = document.getElementById('health-dot-idb');
      const dotErr = document.getElementById('health-dot-err');
      const txtLS  = document.getElementById('health-ls');
      const txtIDB = document.getElementById('health-idb');
      const txtErr = document.getElementById('health-err');
      const txtSnap= document.getElementById('health-snap');

      if (!dotLS) return;

      const lsKB = Math.round(lsSize / 1024);
      const lsWarn = lsKB > 4000;
      dotLS.className  = 'health-dot ' + (lsWarn ? 'health-dot-warn' : 'health-dot-ok');
      txtLS.textContent = `LS: ${lsKB}KB`;

      dotIDB.className  = 'health-dot ' + (idbOk ? 'health-dot-ok' : 'health-dot-warn');
      txtIDB.textContent = `IDB: ${idbOk ? '‚úì' : 'Á©∫'}`;

      dotErr.className  = 'health-dot ' + (errCount === 0 ? 'health-dot-ok' : errCount < 5 ? 'health-dot-warn' : 'health-dot-error');
      txtErr.textContent = `„Ç®„É©„Éº: ${errCount}‰ª∂`;

      if (latestSnap) {
        const d = new Date(latestSnap.ts);
        const fmt = `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        txtSnap.textContent = `„Çπ„Éä„ÉÉ„Éó: ${fmt}`;
      } else {
        txtSnap.textContent = '„Çπ„Éä„ÉÉ„Éó: „Å™„Åó';
      }
    }

    /* =====================================================
       CONSTANTS
       ===================================================== */
    const STATUS_LIST = ["Êú™", "Âá∫Á§æ", "Âú®ÂÆÖ", "‰ºëÊó•", "‰ºë„Åø", "Á•ùÊó•"];
    const STORE_KEY   = 'kintai_store_v1';
    const LAST_KEY    = 'att_last_template';
    const CFG_KEY     = 'kintai_config_v1';

    /* =====================================================
       JAPANESE HOLIDAY CALCULATION
       ===================================================== */
    const _hCache = {};

    function getHolidays(year) {
      if (_hCache[year]) return _hCache[year];
      const h = {};
      const f = (m, d, name) => {
        h[`${year}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`] = name;
      };

      // Fixed
      f(1,1,'ÂÖÉÊó•');
      f(2,11,'Âª∫ÂõΩË®òÂøµ„ÅÆÊó•');
      f(2,23,'Â§©ÁöáË™ïÁîüÊó•');
      f(4,29,'Êò≠Âíå„ÅÆÊó•');
      f(5,3,'ÊÜ≤Ê≥ïË®òÂøµÊó•');
      f(5,4,'„Åø„Å©„Çä„ÅÆÊó•');
      f(5,5,'„Åì„Å©„ÇÇ„ÅÆÊó•');
      f(8,11,'Â±±„ÅÆÊó•');
      f(11,3,'ÊñáÂåñ„ÅÆÊó•');
      f(11,23,'Âã§Âä¥ÊÑüË¨ù„ÅÆÊó•');

      // nth weekday helper (wd: JS format 0=Sun,1=Mon,...,6=Sat)
      function nthWD(month, wd, n) {
        const d = new Date(year, month - 1, 1);
        let c = 0;
        while (true) {
          if (d.getDay() === wd && ++c === n) return d.getDate();
          d.setDate(d.getDate() + 1);
        }
      }
      f(1,  nthWD(1, 1, 2), 'Êàê‰∫∫„ÅÆÊó•');
      f(7,  nthWD(7, 1, 3), 'Êµ∑„ÅÆÊó•');
      f(9,  nthWD(9, 1, 3), 'Êï¨ËÄÅ„ÅÆÊó•');
      f(10, nthWD(10,1, 2), '„Çπ„Éù„Éº„ÉÑ„ÅÆÊó•');

      // Êò•ÂàÜ„ÅÆÊó•„ÉªÁßãÂàÜ„ÅÆÊó• (Ëøë‰ººÂºè)
      const sy = year - 1980;
      const shunbun = Math.floor(20.8431 + 0.242194 * sy - Math.floor(sy / 4));
      const shubun  = Math.floor(23.2488 + 0.242194 * sy - Math.floor(sy / 4));
      f(3, shunbun, 'Êò•ÂàÜ„ÅÆÊó•');
      f(9, shubun,  'ÁßãÂàÜ„ÅÆÊó•');

      // ÊåØÊõø‰ºëÊó•: Á•ùÊó•„ÅåÊó•Êõú ‚Üí ÁøåÊúàÊõúÔºàÈÄ£ÈéñÂØæÂøúÔºâ
      const hkeys = Object.keys(h).sort();
      for (const k of hkeys) {
        const d = new Date(k + 'T00:00:00');
        if (d.getDay() === 0) {
          let nxt = new Date(d);
          nxt.setDate(nxt.getDate() + 1);
          while (h[nxt.toISOString().slice(0, 10)]) nxt.setDate(nxt.getDate() + 1);
          h[nxt.toISOString().slice(0, 10)] = 'ÊåØÊõø‰ºëÊó•';
        }
      }

      // ÂõΩÊ∞ë„ÅÆ‰ºëÊó•: 2„Å§„ÅÆÁ•ùÊó•„Å´Êåü„Åæ„Çå„ÅüÂπ≥Êó•
      const all = Object.keys(h).sort();
      for (let i = 0; i < all.length - 1; i++) {
        const d1 = new Date(all[i] + 'T00:00:00');
        const d2 = new Date(all[i + 1] + 'T00:00:00');
        if ((d2 - d1) / 86400000 === 2) {
          const mid = new Date(d1);
          mid.setDate(mid.getDate() + 1);
          const mk = mid.toISOString().slice(0, 10);
          if (!h[mk] && mid.getDay() !== 0) h[mk] = 'ÂõΩÊ∞ë„ÅÆ‰ºëÊó•';
        }
      }

      _hCache[year] = h;
      return h;
    }

    function holidayName(dateStr) {
      return getHolidays(+dateStr.slice(0, 4))[dateStr] || null;
    }

    /* =====================================================
       CONFIG
       ===================================================== */
    function loadConfig() {
      try {
        const r = localStorage.getItem(CFG_KEY);
        return r ? JSON.parse(r) : {};
      } catch { return {}; }
    }
    function saveConfig(cfg) {
      localStorage.setItem(CFG_KEY, JSON.stringify(cfg));
    }

    /* =====================================================
       DATA STORAGE ‚Äî IndexedDBÔºà‰∏ªÔºâ+ localStorageÔºàÈ´òÈÄü„Ç≠„É£„ÉÉ„Ç∑„É•Ôºâ
       Êõ∏„ÅçËæº„Åø: ‰∏°Êñπ„Å´ÂêåÊúü
       Ë™≠„ÅøËæº„Åø: localStorageÔºàÈ´òÈÄüÔºâ
       Âæ©ÂÖÉ:     localStorage „ÅåÁ©∫„ÅÆÂ†¥Âêà IndexedDB „Åã„ÇâËá™ÂãïÂæ©ÂÖÉ
       ===================================================== */
    const IDB_NAME    = 'kintai_idb';
    const IDB_VERSION = 1;
    const IDB_STORE   = 'attendance';

    function _openIDB() {
      return new Promise((resolve) => {
        try {
          const req = indexedDB.open(IDB_NAME, IDB_VERSION);
          req.onupgradeneeded = e => {
            e.target.result.createObjectStore(IDB_STORE, { keyPath: 'id' });
          };
          req.onsuccess = e => resolve(e.target.result);
          req.onerror   = () => resolve(null);
        } catch (_) { resolve(null); }
      });
    }

    async function idbSave(data) {
      const db = await _openIDB();
      if (!db) return;
      try {
        const tx = db.transaction(IDB_STORE, 'readwrite');
        tx.objectStore(IDB_STORE).put({ id: 'main', data, saved_at: new Date().toISOString() });
      } catch (_) {}
    }

    async function idbLoad() {
      const db = await _openIDB();
      if (!db) return null;
      return new Promise(resolve => {
        try {
          const req = db.transaction(IDB_STORE).objectStore(IDB_STORE).get('main');
          req.onsuccess = () => resolve(req.result?.data || null);
          req.onerror   = () => resolve(null);
        } catch (_) { resolve(null); }
      });
    }

    // localStorage „Åã„ÇâË™≠„ÇÄÔºàÈ´òÈÄü„ÉªÂêåÊúüÔºâ
    function loadStore() {
      try {
        const r = localStorage.getItem(STORE_KEY);
        if (!r) return { months: {} };
        const d = JSON.parse(r);
        return (d && d.months) ? d : { months: {} };
      } catch { return { months: {} }; }
    }

    // ‰∏°Êñπ„Å´Êõ∏„ÅèÔºàlocalStorage Êõ∏„ÅçËæº„ÅøÂ§±ÊïóÊôÇ„ÅØ IDB „ÅÆ„ÅøÔºâ
    function saveStore(store) {
      const json = JSON.stringify(store);
      try {
        localStorage.setItem(STORE_KEY, json);
      } catch(e) {
        console.warn('[saveStore] localStorage Êõ∏„ÅçËæº„ÅøÂ§±Êïó (quota?):', e);
        // QuotaË∂ÖÈÅé„Å™„ÇâÂè§„ÅÑÊúà„ÇíÂâäÈô§„Åó„Å¶ÂÜçË©¶Ë°å
        try {
          const months = Object.keys(store.months || {}).sort();
          if (months.length > 3) {
            delete store.months[months[0]]; // ÊúÄÂè§Êúà„ÇíÂâäÈô§
            localStorage.setItem(STORE_KEY, JSON.stringify(store));
            console.warn('[saveStore] ÊúÄÂè§Êúà„ÇíÂâäÈô§„Åó„Å¶‰øùÂ≠ò„Åó„Åæ„Åó„Åü:', months[0]);
          }
        } catch(_) { console.error('[saveStore] ‰øùÂ≠òÂÆåÂÖ®Â§±Êïó'); }
      }
      idbSave(store); // ÈùûÂêåÊúü„Éü„É©„ÉºÔºàfire-and-forgetÔºâ
      // „Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„Éà: 30ÂàÜ„Å´1Âõû„Å†„Åë‰øùÂ≠òÔºàÈ†ªÁπÅ„Å™Êõ∏„ÅçËæº„Åø„ÇíÊäëÂà∂Ôºâ
      try {
        const lastSnap = localStorage.getItem('_kintai_snap_last') || '0';
        if (Date.now() - Number(lastSnap) > 30 * 60 * 1000) {
          saveSnapshot(store);
          localStorage.setItem('_kintai_snap_last', String(Date.now()));
        }
      } catch(_) {}
    }

    // Ëµ∑ÂãïÊôÇ: localStorage „ÅåÁ©∫„Å™„Çâ IndexedDB „Åã„ÇâÂæ©ÂÖÉ
    async function restoreFromIDBIfNeeded() {
      const ls = localStorage.getItem(STORE_KEY);
      const isEmpty = !ls || ls === '{"months":{}}';
      if (!isEmpty) return false;
      const idbData = await idbLoad();
      if (idbData && Object.keys(idbData.months || {}).length > 0) {
        localStorage.setItem(STORE_KEY, JSON.stringify(idbData));
        toast('üíæ IndexedDB„Åã„Çâ„Éá„Éº„Çø„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åó„Åü');
        return true;
      }
      return false;
    }

    function buildSkeleton(ym) {
      const [y, m] = ym.split('-').map(Number);
      const last = new Date(y, m, 0).getDate();
      const out = {};
      for (let day = 1; day <= last; day++) {
        const d = `${ym}-${String(day).padStart(2, '0')}`;
        out[d] = { date: d, status: 'Êú™', start: '', end: '', memo: '', updated_at: '' };
      }
      return out;
    }

    function autoStatus(dateStr) {
      if (holidayName(dateStr)) return 'Á•ùÊó•';
      const wd = new Date(dateStr + 'T00:00:00').getDay();
      if (wd === 0) return '‰ºëÊó•';
      if (wd === 6) return '‰ºë„Åø';
      return 'Êú™';
    }

    function applyAutoRules(monthData) {
      const out = {}, holidays = {};
      for (const [d, rec] of Object.entries(monthData)) {
        const r = { ...rec };
        const hn = holidayName(d);
        if (hn) holidays[d] = hn;
        const st = (r.status || 'Êú™').trim() || 'Êú™';
        r.status = (st === 'Êú™') ? autoStatus(d) : st;
        out[d] = r;
      }
      return { data: out, holidays };
    }

    function getMonthData(ym) {
      const store = loadStore();
      if (!store.months[ym]) {
        store.months[ym] = buildSkeleton(ym);
        saveStore(store);
      }
      return applyAutoRules(store.months[ym]);
    }

    function saveDayData(dateStr, status, start, end, memo) {
      const ym = dateStr.slice(0, 7);
      const store = loadStore();
      if (!store.months[ym]) store.months[ym] = buildSkeleton(ym);
      if (!store.months[ym][dateStr]) {
        store.months[ym][dateStr] = {
          date: dateStr, status: 'Êú™', start: '', end: '', memo: '', updated_at: ''
        };
      }
      if (status !== '') store.months[ym][dateStr].status = status;
      store.months[ym][dateStr].start = start;
      store.months[ym][dateStr].end   = end;
      store.months[ym][dateStr].memo  = memo;
      store.months[ym][dateStr].updated_at = new Date().toISOString().slice(0, 19);
      saveStore(store);
      // return view-corrected record
      const { data } = applyAutoRules({ [dateStr]: store.months[ym][dateStr] });
      return data[dateStr];
    }

    /* =====================================================
       APP STATE
       ===================================================== */
    let currentYear, currentMonth;
    let attendanceData = {};
    let holidaysData   = {};
    let currentEditDate = null;
    let locked = false;
    let selectedDateStr = null;

    const toastEl   = document.getElementById('toast');
    const overlayEl = document.getElementById('overlay');

    function toast(msg) {
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      setTimeout(() => toastEl.classList.remove('show'), 1400);
    }

    function setLoading(v) {
      overlayEl.classList.toggle('show', !!v);
    }

    /* =====================================================
       FORMAT HELPERS
       ===================================================== */
    function ymLabel(y, m) {
      return `${y}Âπ¥${m}Êúà`;
    }

    function formatDateJP(dateStr) {
      const d = new Date(dateStr + 'T00:00:00');
      const wdays = ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'];
      return `${d.getFullYear()}Âπ¥${d.getMonth()+1}Êúà${d.getDate()}Êó•Ôºà${wdays[d.getDay()]}Ôºâ`;
    }

    function prevDateStr(dateStr) {
      const d = new Date(dateStr + 'T00:00:00');
      d.setDate(d.getDate() - 1);
      return d.toISOString().slice(0, 10);
    }

    /* =====================================================
       LOAD MONTH
       ===================================================== */
    function loadMonth(year, month) {
      currentYear  = year;
      currentMonth = month;
      document.getElementById('month-label').textContent = ymLabel(year, month);

      setLoading(true);
      try {
        const ym = `${year}-${String(month).padStart(2, '0')}`;
        const { data, holidays } = getMonthData(ym);
        attendanceData = data;
        holidaysData   = holidays;
        renderCalendar(year, month);
        renderStats(year, month);
      } finally {
        setLoading(false);
      }
    }

    /* =====================================================
       SAVE ATTENDANCE
       ===================================================== */
    function saveAttendance(dateStr, status, memo, start, end) {
      const prev = attendanceData[dateStr] ? { ...attendanceData[dateStr] } : null;
      try {
        const day = saveDayData(dateStr, status, start, end, memo);
        attendanceData[dateStr] = day;
        const hn = holidayName(dateStr);
        if (hn) holidaysData[dateStr] = hn;

        localStorage.setItem(LAST_KEY, JSON.stringify({ status, memo, start, end }));
        renderCalendar(currentYear, currentMonth);
        return true;
      } catch (e) {
        if (prev) attendanceData[dateStr] = prev;
        else delete attendanceData[dateStr];
        renderCalendar(currentYear, currentMonth);
        alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
        return false;
      }
    }

    function getLastTemplate() {
      try {
        const r = localStorage.getItem(LAST_KEY);
        return r ? JSON.parse(r) : null;
      } catch { return null; }
    }

    function quickDuplicateLast(targetDate) {
      if (locked) return;
      const t = getLastTemplate();
      if (!t) { alert('Áõ¥Ëøë„ÉÜ„É≥„Éó„É¨„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'); return; }
      const ok = saveAttendance(targetDate, t.status||'Êú™', t.memo||'', t.start||'', t.end||'');
      if (ok) toast(`${targetDate} „Å´Áõ¥Ëøë„ÇíÂèçÊò†`);
    }

    /* =====================================================
       RENDER CALENDAR
       ===================================================== */
    function renderCalendar(year, month) {
      const tbody = document.getElementById('calendar-body');
      tbody.innerHTML = '';

      const first      = new Date(year, month - 1, 1);
      const lastDay    = new Date(year, month, 0).getDate();
      const firstWd    = first.getDay();

      const today = new Date();
      const todayY = today.getFullYear();
      const todayM = today.getMonth() + 1;
      const todayD = today.getDate();

      let row = document.createElement('tr');

      for (let i = 0; i < firstWd; i++) row.appendChild(document.createElement('td'));

      for (let day = 1; day <= lastDay; day++) {
        if (row.children.length === 7) {
          tbody.appendChild(row);
          row = document.createElement('tr');
        }

        const td      = document.createElement('td');
        const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const dbData  = attendanceData[dateStr] || null;
        const hname   = holidaysData[dateStr] || null;
        const w       = new Date(year, month - 1, day).getDay();

        let status = 'Êú™', memo = '', start = '', end = '';
        if (dbData) {
          status = dbData.status || 'Êú™';
          memo   = dbData.memo   || '';
          start  = dbData.start  || '';
          end    = dbData.end    || '';
        }

        const card = document.createElement('div');
        card.className = `day-card day-card-status-${status}`;
        if (year === todayY && month === todayM && day === todayD) card.classList.add('today-ring');
        if (selectedDateStr === dateStr) card.classList.add('selected-day');
        card.dataset.date = dateStr;

        // Header
        const header = document.createElement('div');
        header.className = 'day-header';

        const num = document.createElement('div');
        num.className = 'day-number' + (w === 0 ? ' sun' : w === 6 ? ' sat' : '');
        num.textContent = day;

        const pill = document.createElement('div');
        pill.className = `status-pill status-pill-${status}`;
        pill.textContent = status;
        const ddIcon = document.createElement('span');
        ddIcon.className = 'dropdown-icon';
        ddIcon.textContent = '‚ñæ';
        pill.appendChild(ddIcon);

        const dot = document.createElement('span');
        dot.className = 'memo-dot';
        dot.textContent = memo ? '‚óè' : '';

        header.appendChild(num);
        header.appendChild(pill);
        header.appendChild(dot);
        card.appendChild(header);

        if (start || end) {
          const tm = document.createElement('div');
          tm.className = 'subline';
          tm.textContent = `${start || '--:--'}„Äú${end || '--:--'}`;
          card.appendChild(tm);
        }

        if (hname) {
          const hl = document.createElement('div');
          hl.className = 'holiday-name';
          hl.textContent = hname;
          card.appendChild(hl);
        }

        // Áõ¥Ëøë„Éú„Çø„É≥
        const actions = document.createElement('div');
        actions.className = 'cell-actions';
        const bLast = document.createElement('button');
        bLast.type = 'button';
        bLast.className = 'mini-btn';
        bLast.textContent = 'Áõ¥Ëøë';
        bLast.addEventListener('click', e => {
          e.stopPropagation();
          quickDuplicateLast(dateStr);
        });
        actions.appendChild(bLast);
        card.appendChild(actions);

        td.appendChild(card);
        row.appendChild(td);
      }

      if (row.children.length > 0) {
        while (row.children.length < 7) row.appendChild(document.createElement('td'));
        tbody.appendChild(row);
      }

      document.getElementById('calendar-card').classList.toggle('locked', locked);
    }

    /* =====================================================
       MODAL
       ===================================================== */
    function openModal(dateStr) {
      if (locked) return;
      currentEditDate = dateStr;

      const dbData = attendanceData[dateStr] || null;
      let status = 'Êú™', memo = '', start = '', end = '';
      if (dbData) {
        status = dbData.status || 'Êú™';
        memo   = dbData.memo   || '';
        start  = dbData.start  || '';
        end    = dbData.end    || '';
      }

      document.getElementById('modal-date-label').textContent = formatDateJP(dateStr);
      document.getElementById('memo-textarea').value  = memo;
      document.getElementById('start-time').value     = start || '09:00';
      document.getElementById('end-time').value       = end   || '18:00';

      const row = document.getElementById('status-chip-row');
      row.innerHTML = '';
      STATUS_LIST.forEach(s => {
        const chip = document.createElement('div');
        chip.className = 'status-chip' + (s === status ? ' active' : '');
        chip.textContent = s;
        chip.dataset.value = s;
        row.appendChild(chip);
      });

      document.getElementById('memo-modal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('memo-modal').classList.remove('show');
      currentEditDate = null;
    }

    function getModalStatus() {
      for (const c of document.querySelectorAll('.status-chip')) {
        if (c.classList.contains('active')) return c.dataset.value;
      }
      return 'Êú™';
    }

    function applyTemplate(t) {
      if (!t) return;
      document.querySelectorAll('.status-chip')
        .forEach(c => c.classList.toggle('active', c.dataset.value === t.status));
      document.getElementById('memo-textarea').value = t.memo  || '';
      document.getElementById('start-time').value    = t.start || '09:00';
      document.getElementById('end-time').value      = t.end   || '18:00';
    }

    /* =====================================================
       OBSIDIAN
       ===================================================== */
    function obsidianOpen(dateStr) {
      const cfg    = loadConfig();
      const vault  = (cfg.vault  || 'Phi_Memo').trim();
      const subdir = (cfg.subdir || '„ÄêÊ•≠Âãô„Äë/Âã§ÊÄ†').trim();
      const file   = encodeURIComponent(`${subdir}/${dateStr}.md`);
      location.href = `obsidian://open?vault=${encodeURIComponent(vault)}&file=${file}`;
    }

    /* =====================================================
       xlsx Êõ∏„ÅçÂá∫„ÅóÔºàSheetJSÔºâ‚Äî ÈÅÖÂª∂„É≠„Éº„ÉâÁâà
       ===================================================== */
    const XLSX_CDN = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
    function loadXlsxLib() {
      if (typeof XLSX !== 'undefined') return Promise.resolve();
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = XLSX_CDN;
        s.onload = resolve;
        s.onerror = () => reject(new Error('xlsx „ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'));
        document.head.appendChild(s);
      });
    }

    async function exportXlsx() {
      try { await loadXlsxLib(); } catch(e) { alert(e.message); return; }
      const store  = loadStore();
      const months = Object.keys(store.months).sort();
      if (months.length === 0) { alert('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'); return; }

      const wb    = XLSX.utils.book_new();
      const wdays = ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'];

      for (const ym of months) {
        const monthData = store.months[ym];
        const header = ['Êó•‰ªò','ÊõúÊó•','„Çπ„ÉÜ„Éº„Çø„Çπ','ÈñãÂßã','ÁµÇ‰∫Ü','Âã§ÂãôÊôÇÈñì','Á•ùÊó•','„É°„É¢'];
        const rows   = [header];

        Object.keys(monthData).sort().forEach(d => {
          const rec = monthData[d];
          const dt  = new Date(d + 'T00:00:00');
          const wd  = wdays[dt.getDay()];

          // Âã§ÂãôÊôÇÈñì„ÇíË®àÁÆó
          let workHours = '';
          if (rec.start && rec.end) {
            const [sh, sm] = rec.start.split(':').map(Number);
            const [eh, em] = rec.end.split(':').map(Number);
            const diff = (eh * 60 + em) - (sh * 60 + sm);
            if (diff > 0) workHours = `${Math.floor(diff / 60)}:${String(diff % 60).padStart(2, '0')}`;
          }

          rows.push([
            d,
            wd,
            rec.status  || 'Êú™',
            rec.start   || '',
            rec.end     || '',
            workHours,
            holidayName(d) || '',
            rec.memo    || ''
          ]);
        });

        const ws = XLSX.utils.aoa_to_sheet(rows);
        // ÂàóÂπÖ
        ws['!cols'] = [
          {wch:12},{wch:4},{wch:8},{wch:6},{wch:6},{wch:8},{wch:14},{wch:60}
        ];
        // „Éò„ÉÉ„ÉÄ„ÉºË°å„ÅÆ„Çπ„Çø„Ç§„É´ÔºàËÉåÊôØËâ≤„Å™„Å©Ôºâ„ÅØ xlsx.full „Åß„ÅØÂà•ÈÄîË¶ÅË®≠ÂÆö„ÅÆ„Åü„ÇÅÁúÅÁï•
        XLSX.utils.book_append_sheet(wb, ws, ym);
      }

      const fname = `kintai_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, fname);
      toast(`üìä ${fname} „ÇíÊõ∏„ÅçÂá∫„Åó„Åæ„Åó„Åü`);
    }

    document.getElementById('btn-xlsx').addEventListener('click', exportXlsx);

    /* =====================================================
       iSHÁâà„Éá„Éº„ÇøÁßªË°åÔºàPWAÂÜÖ„Åã„ÇâÂêå‰∏Ä„Ç™„É™„Ç∏„É≥fetchÔºâ
       ===================================================== */
    document.getElementById('btn-migrate').addEventListener('click', async () => {
      if (!confirm('iSHÁâà„ÅÆÂÖ®„Éá„Éº„ÇøÔºà4„É∂Êúà„Éª73‰ª∂„ÅÆË®òÈå≤Ôºâ„Çí„Åì„ÅÆ„Ç¢„Éó„É™„Å´Âèñ„ÇäËæº„Åø„Åæ„Åô„ÄÇ\nÊó¢Â≠ò„ÅÆ„Éá„Éº„Çø„Å®„Éû„Éº„Ç∏„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) return;
      setLoading(true);
      try {
        const res = await fetch('./kintai_backup_2026-02-22.json', { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (!data || !data.months) throw new Error('„Éá„Éº„ÇøÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì');

        // Êó¢Â≠ò„Éá„Éº„Çø„Å®„Éû„Éº„Ç∏ÔºàÊó¢Â≠ò„ÇíÂÑ™ÂÖàÔºâ
        const existing = loadStore();
        const merged = { months: { ...data.months, ...existing.months } };
        saveStore(merged);

        // Êúà„Åî„Å®„ÅÆ‰ª∂Êï∞ÈõÜË®à
        const months = Object.keys(data.months);
        const total  = months.reduce((s, m) => s + Object.values(data.months[m]).filter(v => v.status && v.status !== 'Êú™').length, 0);

        loadMonth(currentYear, currentMonth);
        toast(`‚úÖ ÁßªË°åÂÆå‰∫ÜÔºÅ${months.length}„É∂Êúà„Éª${total}‰ª∂„ÅÆË®òÈå≤„ÇíÂèñ„ÇäËæº„Åø„Åæ„Åó„Åü`);
      } catch (e) {
        alert(`Âèñ„ÇäËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${e.message}`);
      } finally {
        setLoading(false);
      }
    });

    /* =====================================================
       IMPORT / EXPORT
       ===================================================== */
    document.getElementById('btn-export').addEventListener('click', () => {
      exportJSON();
      markBackedUp();
      document.getElementById('backup-banner').classList.remove('show');
      toast('üíæ JSON„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
    });

    document.getElementById('btn-import').addEventListener('click', () => {
      document.getElementById('file-import').click();
    });

    document.getElementById('file-import').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          const data = JSON.parse(ev.target.result);
          if (!data || !data.months) throw new Error('invalid format');
          if (!confirm('ÁèæÂú®„ÅÆ„Éá„Éº„Çø„Çí‰∏äÊõ∏„Åç„Åó„Åæ„Åô„ÅãÔºüÔºàÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„ÇìÔºâ')) return;
          saveStore(data);
          loadMonth(currentYear, currentMonth);
          toast('„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü');
        } catch {
          alert('„Éï„Ç°„Ç§„É´„ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì');
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    });

    /* =====================================================
       PROGRESS OVERLAY „Éò„É´„Éë„Éº
       ===================================================== */
    const _overlay  = document.getElementById('progress-overlay');
    const _progBar  = document.getElementById('progress-bar');
    const _progStep = document.getElementById('progress-step');
    const _progTitle= document.getElementById('progress-title');

    function showProgress(title) {
      _progTitle.textContent = title || 'Âá¶ÁêÜ‰∏≠...';
      _progBar.style.width   = '0%';
      _progStep.textContent  = '';
      _overlay.classList.add('show');
      console.log(`[Progress] ${title}`);
    }
    function updateProgress(pct, stepMsg) {
      _progBar.style.width  = `${Math.min(pct, 100)}%`;
      _progStep.textContent = stepMsg || '';
      console.log(`[Progress] ${pct}% ‚Äî ${stepMsg}`);
    }
    function hideProgress() {
      _overlay.classList.remove('show');
      console.log('[Progress] ÂÆå‰∫Ü');
    }

    /* =====================================================
       JINJER ÂêåÊúüÔºà„Éû„Éº„Ç∏„Ç§„É≥„Éù„Éº„ÉàÔºâ
       ===================================================== */
    async function _doJinjerAutoSync() {
      const cfg = loadConfig();
      const macIp = cfg.tsMac || '';
      const statusEl = document.getElementById('jinjer-sync-status');
      const cmdBox = document.getElementById('jinjer-sync-cmd-box');
      const optsEl = document.getElementById('jinjer-sync-opts');
      document.getElementById('jinjer-sync-modal').classList.add('show');
      optsEl.style.display = 'none';
      statusEl.style.display = '';
      cmdBox.style.display = 'none';
      if (!macIp) {
        statusEl.textContent = '‚ö†Ô∏è Ë®≠ÂÆö„ÅßTailscale MacBook IP„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
        return;
      }
      statusEl.textContent = 'üì° Mac„ÅÆ„Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö‰∏≠‚Ä¶';
      const today = new Date();
      const month = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
      const port = cfg.jinjerServerPort || '8899';
      try {
        const ctrl = new AbortController();
        setTimeout(() => ctrl.abort(), 12000);
        const res = await fetch(`http://${macIp}:${port}/api/jinjer?months=${month}`, { signal: ctrl.signal });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const jinjer = await res.json();
        document.getElementById('jinjer-sync-modal').classList.remove('show');
        _processJinjerData(jinjer);
        _appLog('info', 'jinjer', `TailscaleËá™ÂãïÂêåÊúü: ${month}`);
      } catch(e) {
        statusEl.textContent = `‚ùå „Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü`;
        const projDir = '~/root/attendance-pwa';
        const cmd = `cd ${projDir} && python3 jinjer_server.py`;
        document.getElementById('jinjer-sync-cmd-text').textContent = cmd;
        cmdBox.style.display = '';
        document.getElementById('jinjer-sync-cmd-copy').onclick = () => {
          navigator.clipboard?.writeText(cmd).then(() => toast('üìã „Ç≥„Éû„É≥„Éâ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü'));
        };
        document.getElementById('jinjer-sync-retry').onclick = () => _doJinjerAutoSync();
        _appLog('warn', 'jinjer', `TailscaleÊé•Á∂öÂ§±Êïó: ${e.message}`);
      }
    }

    document.getElementById('btn-jinjer').addEventListener('click', () => {
      const optsEl = document.getElementById('jinjer-sync-opts');
      const statusEl = document.getElementById('jinjer-sync-status');
      const cmdBox = document.getElementById('jinjer-sync-cmd-box');
      optsEl.style.display = '';
      statusEl.style.display = 'none';
      cmdBox.style.display = 'none';
      document.getElementById('jinjer-sync-modal').classList.add('show');
    });
    document.getElementById('jinjer-sync-opt-file').addEventListener('click', () => {
      document.getElementById('jinjer-sync-modal').classList.remove('show');
      document.getElementById('file-jinjer').click();
    });
    document.getElementById('jinjer-sync-opt-auto').addEventListener('click', () => _doJinjerAutoSync());
    document.getElementById('jinjer-sync-close').addEventListener('click', () =>
      document.getElementById('jinjer-sync-modal').classList.remove('show'));

    // jinjer„Éá„Éº„ÇøÂá¶ÁêÜÔºà„Éï„Ç°„Ç§„É´/Tailscale‰∏°Êñπ„Åã„Çâ‰Ωø„ÅÜÂÖ±ÈÄöÂá¶ÁêÜÔºâ
    async function _processJinjerData(jinjer) {
      showProgress('üè¢ jinjerÂêåÊúü');
      try {
        await tick();
        updateProgress(15, 'üîç „Éá„Éº„Çø„ÇíËß£Êûê‰∏≠...');
        if (!jinjer || typeof jinjer.months !== 'object') throw new Error('months „Éï„Ç£„Éº„É´„Éâ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
        const monthKeys = Object.keys(jinjer.months);
        if (!monthKeys.length) throw new Error('ÂØæË±°„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
        console.log('[jinjer] ÂØæË±°Êúà:', monthKeys);
        updateProgress(25, `üìÖ ÂØæË±°: ${monthKeys.join(', ')}`);

        await tick();
        updateProgress(35, 'üìñ Êó¢Â≠ò„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...');
        let store;
        try { store = loadStore(); } catch(e) { store = { months: {} }; }

        const allDays = [];
        for (const [mk, days] of Object.entries(jinjer.months)) {
          if (!store.months[mk]) store.months[mk] = {};
          for (const [dk, jd] of Object.entries(days)) allDays.push({ mk, dk, jd });
        }
        const total = allDays.length;
        const CHUNK = 7;
        let done = 0;
        for (let i = 0; i < allDays.length; i += CHUNK) {
          for (const { mk, dk, jd } of allDays.slice(i, i + CHUNK)) {
            const ex = store.months[mk][dk] || {};
            store.months[mk][dk] = { ...ex, status: jd.status || ex.status || 'Êú™', start: jd.start || ex.start || '', end: jd.end || ex.end || '', memo: ex.memo || '' };
            done++;
          }
          updateProgress(35 + Math.round((done / total) * 45), `üîÑ ${done} / ${total} Êó•„ÇíÂá¶ÁêÜ‰∏≠...`);
          await tick();
        }

        await tick();
        updateProgress(85, 'üíæ localStorage „Å´‰øùÂ≠ò‰∏≠...');
        try {
          localStorage.setItem(STORE_KEY, JSON.stringify(store));
        } catch(e) {
          throw new Error('„Çπ„Éà„É¨„Éº„Ç∏„Å∏„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÁ©∫„ÅçÂÆπÈáè„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        }
        updateProgress(90, 'üíæ IndexedDB „Çí„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰∏≠...');
        try { await idbSave(store); } catch(_) {}

        await tick();
        updateProgress(97, 'üóì „Ç´„É¨„É≥„ÉÄ„Éº„ÇíÊõ¥Êñ∞‰∏≠...');
        try { loadMonth(currentYear, currentMonth); } catch(_) {}

        updateProgress(100, `‚úÖ ${done}Êó•ÂàÜ„ÅÆÂêåÊúü„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ`);
        _appLog('info', 'jinjer', `ÂêåÊúüÂÆå‰∫Ü: ${done}Êó•ÂàÜ`);
        await new Promise(r => setTimeout(r, 900));
        hideProgress();
        toast(`‚úÖ jinjerÂêåÊúüÂÆå‰∫ÜÔºà${done}Êó•ÂàÜÔºâ`);
      } catch(err) {
        console.error('[jinjer]', err);
        hideProgress();
        toast(`‚ùå ${err.message || 'jinjerÂêåÊúü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'}`);
      }
    }

    document.getElementById('file-jinjer').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) { e.target.value = ''; return; }
      e.target.value = '';
      console.log('[jinjer] „Éï„Ç°„Ç§„É´ÈñãÂßã:', file.name, file.size, 'bytes');
      const reader = new FileReader();
      reader.onload = async ev => {
        let jinjer;
        try { jinjer = JSON.parse(ev.target.result); }
        catch(e) { toast('‚ùå JSON„ÅÆËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'); return; }
        await _processJinjerData(jinjer);
      };
      reader.onerror = () => toast('‚ùå „Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      reader.readAsText(file, 'utf-8');
    });

    // UI„Å´Âà∂Âæ°„ÇíËøî„ÅôÂ∞è„Åï„Å™„Éò„É´„Éë„Éº
    function tick() {
      return new Promise(r => setTimeout(r, 0));
    }

    /* =====================================================
       SETTINGS MODAL
       ===================================================== */
    document.getElementById('btn-settings').addEventListener('click', () => {
      const cfg = loadConfig();
      document.getElementById('settings-vault').value     = cfg.vault     || 'Phi_Memo';
      document.getElementById('settings-subdir').value   = cfg.subdir   || '„ÄêÊ•≠Âãô„Äë/Âã§ÊÄ†';
      document.getElementById('settings-jinjer-url').value = cfg.jinjerUrl || 'https://kintai.jinjer.biz/staffs/top';
      document.getElementById('settings-city').value          = cfg.city          || '';
      document.getElementById('settings-style-gender').value = cfg.styleGender   || '„É°„É≥„Ç∫';
      document.getElementById('settings-style-type').value   = cfg.styleType     || 'casual';
      document.getElementById('settings-style-color').value  = cfg.styleColor    || 'basic';
      document.getElementById('settings-ts-mac').value       = cfg.tsMac         || '100.65.221.66';
      document.getElementById('settings-ts-iphone').value    = cfg.tsIphone      || '100.93.30.114';
      document.getElementById('settings-ts-user').value      = cfg.tsUser        || '';
      document.getElementById('settings-jinjer-company').value = cfg.jinjerCompany || '';
      document.getElementById('settings-jinjer-email').value   = cfg.jinjerEmail   || '';
      document.getElementById('settings-jinjer-pass').value    = cfg.jinjerPass    || '';
      updatePinUI();
      document.getElementById('settings-modal').classList.add('show');
    });

    document.getElementById('settings-close').addEventListener('click', () => {
      document.getElementById('settings-modal').classList.remove('show');
    });
    document.getElementById('settings-cancel').addEventListener('click', () => {
      document.getElementById('settings-modal').classList.remove('show');
    });
    document.getElementById('settings-save').addEventListener('click', () => {
      const rawJinjer = document.getElementById('settings-jinjer-url').value.trim();
      const cfg = {
        vault:     document.getElementById('settings-vault').value.trim()  || 'Phi_Memo',
        subdir:    document.getElementById('settings-subdir').value.trim() || '„ÄêÊ•≠Âãô„Äë/Âã§ÊÄ†',
        jinjerUrl: (rawJinjer && rawJinjer.startsWith('http')) ? rawJinjer : 'https://kintai.jinjer.biz/staffs/top',
        city:        document.getElementById('settings-city').value.trim(),
        styleGender: document.getElementById('settings-style-gender').value,
        styleType:   document.getElementById('settings-style-type').value,
        styleColor:  document.getElementById('settings-style-color').value,
        tsMac:          document.getElementById('settings-ts-mac').value.trim(),
        tsIphone:       document.getElementById('settings-ts-iphone').value.trim(),
        tsUser:         document.getElementById('settings-ts-user').value.trim(),
        jinjerCompany:  document.getElementById('settings-jinjer-company').value.trim(),
        jinjerEmail:    document.getElementById('settings-jinjer-email').value.trim(),
        jinjerPass:     document.getElementById('settings-jinjer-pass').value,
      };
      // ÈÉΩÂ∏Ç or „Çπ„Çø„Ç§„É´„ÅåÂ§â„Çè„Å£„Åü„ÇâÂ§©Ê∞ó„Ç≠„É£„ÉÉ„Ç∑„É•„Çí„ÇØ„É™„Ç¢„Åó„Å¶ÂÜçÂèñÂæó
      const prevCfg = loadConfig();
      if (prevCfg.city !== cfg.city || prevCfg.styleType !== cfg.styleType ||
          prevCfg.styleGender !== cfg.styleGender || prevCfg.styleColor !== cfg.styleColor) {
        try { localStorage.removeItem('_kintai_weather_cache'); } catch(_) {}
      }
      saveConfig(cfg);
      renderTailscaleCard();
      // jinjer„Ç´„Éº„Éâ„ÅÆhref„Çí„É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞
      const jinjerLink = document.getElementById('jinjer-link');
      if (jinjerLink) jinjerLink.href = cfg.jinjerUrl;
      document.getElementById('settings-modal').classList.remove('show');
      toast('Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
    });

    /* =====================================================
       EVENT HANDLERS
       ===================================================== */

    // Calendar click ‚Üí open modal
    document.addEventListener('click', ev => {
      const card = ev.target.closest('.day-card');
      if (card && !locked) {
        const dateStr = card.dataset.date;
        if (!dateStr) return;
        selectedDateStr = dateStr;
        document.querySelectorAll('.day-card.selected-day')
          .forEach(c => c.classList.remove('selected-day'));
        card.classList.add('selected-day');
        openModal(dateStr);
        return;
      }

      // Status chip
      const chip = ev.target.closest('.status-chip');
      if (chip && document.getElementById('memo-modal').classList.contains('show')) {
        document.querySelectorAll('.status-chip').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        return;
      }

      // Backdrop close
      const mModal = document.getElementById('memo-modal');
      if (mModal.classList.contains('show') && ev.target === mModal) { closeModal(); return; }
      const sModal = document.getElementById('settings-modal');
      if (sModal.classList.contains('show') && ev.target === sModal) {
        sModal.classList.remove('show');
      }
    });

    document.getElementById('modal-close').addEventListener('click', closeModal);
    document.getElementById('modal-cancel').addEventListener('click', closeModal);

    // Save
    document.getElementById('modal-save').addEventListener('click', () => {
      if (!currentEditDate) return;
      const status = getModalStatus();
      const memo   = document.getElementById('memo-textarea').value;
      const start  = document.getElementById('start-time').value || '';
      const end    = document.getElementById('end-time').value   || '';
      const ok = saveAttendance(currentEditDate, status, memo, start, end);
      if (ok) { closeModal(); toast('‰øùÂ≠ò„Åó„Åæ„Åó„Åü'); }
    });

    // Duplicate: last template
    document.getElementById('btn-dup-last').addEventListener('click', () => {
      const t = getLastTemplate();
      if (!t) { alert('Áõ¥Ëøë„ÉÜ„É≥„Éó„É¨„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'); return; }
      applyTemplate(t);
    });

    // Duplicate: prev day
    document.getElementById('btn-dup-prev').addEventListener('click', () => {
      if (!currentEditDate) return;
      const p = prevDateStr(currentEditDate);
      const prev = attendanceData[p];
      if (!prev) { alert('ÂâçÊó•„ÅÆ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'); return; }
      applyTemplate(prev);
    });

    // Obsidian
    document.getElementById('btn-obs-open').addEventListener('click', () => {
      if (!currentEditDate) return;
      obsidianOpen(currentEditDate);
    });

    // Month navigation
    document.getElementById('prev-month').addEventListener('click', () => {
      let y = currentYear, m = currentMonth - 1;
      if (m === 0) { m = 12; y--; }
      loadMonth(y, m);
    });
    document.getElementById('next-month').addEventListener('click', () => {
      let y = currentYear, m = currentMonth + 1;
      if (m === 13) { m = 1; y++; }
      loadMonth(y, m);
    });
    document.getElementById('today-button').addEventListener('click', () => {
      const t = new Date();
      loadMonth(t.getFullYear(), t.getMonth() + 1);
    });

    // Lock
    document.getElementById('lock-toggle').addEventListener('click', () => {
      locked = !locked;
      const btn   = document.getElementById('lock-toggle');
      const label = document.getElementById('lock-label');
      btn.classList.toggle('pill-button-lock-on', locked);
      label.textContent = locked ? '„É≠„ÉÉ„ÇØ‰∏≠' : '„É≠„ÉÉ„ÇØ';
      document.getElementById('calendar-card').classList.toggle('locked', locked);
    });

    // Install banner
    const installBanner = document.getElementById('install-banner');
    const isStandalone  = window.matchMedia('(display-mode: standalone)').matches
                       || navigator.standalone === true;
    const bannerDismissed = sessionStorage.getItem('install_banner_dismissed');
    if (!isStandalone && !bannerDismissed) {
      installBanner.classList.add('show');
    }
    document.getElementById('install-close').addEventListener('click', () => {
      installBanner.classList.remove('show');
      sessionStorage.setItem('install_banner_dismissed', '1');
    });

    /* =====================================================
       MONTHLY STATS
       ===================================================== */
    function calcMonthStats(year, month) {
      const ym   = `${year}-${String(month).padStart(2,'0')}`;
      const raw  = loadStore().months[ym] || {};
      let office = 0, home = 0, off = 0, totalMin = 0;

      Object.values(raw).forEach(rec => {
        const { data } = applyAutoRules({ [rec.date]: rec });
        const st = data[rec.date]?.status || 'Êú™';
        if (st === 'Âá∫Á§æ')                           office++;
        else if (st === 'Âú®ÂÆÖ')                      home++;
        else if (['‰ºë„Åø','‰ºëÊó•','Á•ùÊó•'].includes(st)) off++;

        if (rec.start && rec.end) {
          const [sh, sm] = rec.start.split(':').map(Number);
          const [eh, em] = rec.end.split(':').map(Number);
          const d = (eh * 60 + em) - (sh * 60 + sm);
          if (d > 0) totalMin += d;
        }
      });

      const h = Math.floor(totalMin / 60);
      const m = totalMin % 60;
      return { office, home, off, hours: h, mins: m };
    }

    function renderStats(year, month) {
      const s = calcMonthStats(year, month);
      document.getElementById('stat-office').textContent = s.office;
      document.getElementById('stat-home').textContent   = s.home;
      document.getElementById('stat-off').textContent    = s.off;
      document.getElementById('stat-hours').textContent  =
        s.hours > 0 ? `${s.hours}h${s.mins > 0 ? s.mins + 'm' : ''}` : '0h';
      renderWeeklyStats(year, month);
    }

    /* =====================================================
       WEEKLY PERSON-MONTH STATS  (1‰∫∫Êúà = 8h)
       ===================================================== */
    function calcWeeklyStats(year, month) {
      const ym      = `${year}-${String(month).padStart(2,'0')}`;
      const raw     = loadStore().months[ym] || {};
      const lastDay = new Date(year, month, 0).getDate();
      const firstWd = new Date(year, month - 1, 1).getDay(); // 0=Sun
      const pad2    = n => String(n).padStart(2,'0');
      const weeks   = [];
      let wStart = 1, wMin = 0;

      for (let day = 1; day <= lastDay; day++) {
        const dk  = `${ym}-${pad2(day)}`;
        const rec = raw[dk];
        if (rec && rec.start && rec.end) {
          const [sh, sm] = rec.start.split(':').map(Number);
          const [eh, em] = rec.end.split(':').map(Number);
          const d = (eh * 60 + em) - (sh * 60 + sm);
          if (d > 0) wMin += d;
        }
        const gridPos = (firstWd + day - 1) % 7; // 0=Sun ‚Ä¶ 6=Sat
        if (gridPos === 6 || day === lastDay) {
          weeks.push({ start: wStart, end: day, minutes: wMin });
          wStart = day + 1;
          wMin   = 0;
        }
      }
      return weeks;
    }

    function renderWeeklyStats(year, month) {
      const el    = document.getElementById('weekly-stats');
      const weeks = calcWeeklyStats(year, month);
      const pad2  = n => String(n).padStart(2,'0');
      const mm    = String(month).padStart(2,'0');
      // ÊúÄÂ§ßÂàÜÊï∞Ôºà„Éê„ÉºÊØîÁéáÁî®Ôºâ
      const maxMin = Math.max(...weeks.map(w => w.minutes), 1);

      let html = '<table>';
      weeks.forEach((w, i) => {
        const h   = Math.floor(w.minutes / 60);
        const m   = w.minutes % 60;
        const pm  = (w.minutes / 60 / 8).toFixed(2);
        const pct = Math.round(w.minutes / maxMin * 100);
        const lbl = `W${i+1} ${mm}/${pad2(w.start)}„Äú${mm}/${pad2(w.end)}`;
        const hStr = w.minutes > 0 ? `${h}h${m > 0 ? m+'m' : ''}` : '‚Äî';
        html += `<tr>
          <td class="w-label">${lbl}</td>
          <td class="w-hours">${hStr}</td>
          <td class="w-bar-cell"><div class="w-bar-bg"><div class="w-bar-fill" style="width:${pct}%"></div></div></td>
          <td class="w-pm">${w.minutes > 0 ? pm+'‰∫∫Êúà' : '‚Äî'}</td>
        </tr>`;
      });
      html += '</table>';
      el.innerHTML = html;
    }

    /* =====================================================
       AUTO BACKUP SYSTEM
       ===================================================== */
    const BACKUP_KEY           = 'kintai_last_backup';
    const BACKUP_INTERVAL_DAYS = 7;

    function daysSinceBackup() {
      const last = localStorage.getItem(BACKUP_KEY);
      if (!last) return 999;
      return Math.floor((Date.now() - parseInt(last)) / 86400000);
    }

    function markBackedUp() {
      localStorage.setItem(BACKUP_KEY, Date.now().toString());
    }

    function checkBackupReminder() {
      const days = daysSinceBackup();
      if (days >= BACKUP_INTERVAL_DAYS) {
        const msg = days >= 999
          ? '„Åæ„Å†„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Åå‰ΩúÊàê„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì'
          : `ÂâçÂõû„ÅÆ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Åã„Çâ <strong>${days}Êó•</strong> ÁµåÈÅé„Åó„Å¶„ÅÑ„Åæ„Åô`;
        document.getElementById('backup-days-msg').innerHTML = msg;
        document.getElementById('backup-banner').classList.add('show');
      }
    }

    // JSON „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÔºàÂçò‰ΩìÔºâ
    function exportJSON() {
      const store = loadStore();
      const blob  = new Blob([JSON.stringify(store, null, 2)], { type: 'application/json' });
      const a     = document.createElement('a');
      a.href      = URL.createObjectURL(blob);
      a.download  = `kintai_backup_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // JSON + xlsx „ÇíÈÄ£Á∂ö„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÔºà‰∏ÄÊã¨„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÔºâ
    async function oneClickBackup() {
      exportJSON();
      markBackedUp();
      document.getElementById('backup-banner').classList.remove('show');
      toast('‚úÖ JSON + xlsx „Çí‰øùÂ≠ò„Åó„Åæ„Åô...');
      await new Promise(r => setTimeout(r, 800)); // iOS „ÅßÂêåÊôÇDL„ÅåË©∞„Åæ„Çâ„Å™„ÅÑ„Çà„ÅÜÂ∞ë„ÅóÈñìÈöî„ÇíÁΩÆ„Åè
      await exportXlsx();
    }

    document.getElementById('btn-backup-now').addEventListener('click', oneClickBackup);
    document.getElementById('weekly-toggle').addEventListener('click', () => {
      const el    = document.getElementById('weekly-stats');
      const arrow = document.getElementById('weekly-arrow');
      const open  = el.classList.toggle('open');
      arrow.textContent = open ? '‚ñ¥' : '‚ñæ';
    });
    document.getElementById('backup-dismiss').addEventListener('click', () => {
      document.getElementById('backup-banner').classList.remove('show');
    });

    // „Ç¢„Éó„É™„ÅåÂâçÈù¢„Å´Êù•„Çã„Åü„Å≥„Å´„ÉÅ„Çß„ÉÉ„ÇØ
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') checkBackupReminder();
    });

    /* =====================================================
       SWIPE GESTUREÔºàÂ∑¶Âè≥„Çπ„ÉØ„Ç§„Éó„ÅßÊúàÂàá„ÇäÊõø„ÅàÔºâ
       ===================================================== */
    let _swipeX = 0, _swipeY = 0, _swipeOnCal = false;
    document.getElementById('calendar-card').addEventListener('touchstart', e => {
      _swipeX = e.touches[0].clientX;
      _swipeY = e.touches[0].clientY;
      // „Ç´„É¨„É≥„ÉÄ„Éº„Ç∞„É™„ÉÉ„Éâ‰∏ä„ÅÆ„Çø„ÉÉ„ÉÅ„ÅÆ„ÅøÊúà„Çπ„ÉØ„Ç§„Éó„ÇíÊúâÂäπÂåñÔºà‰ªñÈ†òÂüü„Åß„ÅØÁÑ°ÂäπÔºâ
      _swipeOnCal = !!e.target.closest('.calendar-wrapper');
    }, { passive: true });

    document.getElementById('calendar-card').addEventListener('touchend', e => {
      if (!_swipeOnCal) return; // „Ç´„É¨„É≥„ÉÄ„Éº„Ç∞„É™„ÉÉ„ÉâÂ§ñ„ÅÆ„Çπ„ÉØ„Ç§„Éó„ÅØÊúàÁßªÂãï„Åó„Å™„ÅÑ
      const dx = e.changedTouches[0].clientX - _swipeX;
      const dy = e.changedTouches[0].clientY - _swipeY;
      if (Math.abs(dx) < 50 || Math.abs(dx) < Math.abs(dy) * 1.2) return; // Á∏¶„Çπ„ÇØ„É≠„Éº„É´„ÇíÈô§Â§ñ
      if (dx < 0) {
        // Â∑¶„Çπ„ÉØ„Ç§„Éó ‚Üí Ê¨°Êúà
        let y = currentYear, m = currentMonth + 1;
        if (m === 13) { m = 1; y++; }
        loadMonth(y, m);
      } else {
        // Âè≥„Çπ„ÉØ„Ç§„Éó ‚Üí ÂâçÊúà
        let y = currentYear, m = currentMonth - 1;
        if (m === 0) { m = 12; y--; }
        loadMonth(y, m);
      }
    }, { passive: true });

    /* =====================================================
       FLOATING TODAY BUTTON
       ===================================================== */
    (function initFab() {
      const t   = new Date();
      const fab = document.getElementById('fab-today');
      document.getElementById('fab-day').textContent = t.getDate();

      fab.addEventListener('click', () => {
        const today = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;
        // ‰ªäÊúà„Åß„Å™„Åë„Çå„Å∞‰ªäÊúà„Å∏ÁßªÂãï„Åó„Å¶„Åã„Çâ„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        if (currentYear !== t.getFullYear() || currentMonth !== t.getMonth() + 1) {
          loadMonth(t.getFullYear(), t.getMonth() + 1);
          setTimeout(() => openModal(today), 150);
        } else {
          openModal(today);
        }
      });

      // „É¢„Éº„ÉÄ„É´„ÅåÈñã„ÅÑ„Å¶„ÅÑ„Çã„Å®„Åç„ÅØÈö†„Åô
      const observer = new MutationObserver(() => {
        const modalOpen = document.getElementById('memo-modal').classList.contains('show')
                       || document.getElementById('settings-modal').classList.contains('show');
        fab.classList.toggle('hidden', modalOpen);
      });
      observer.observe(document.getElementById('memo-modal'),     { attributes: true });
      observer.observe(document.getElementById('settings-modal'), { attributes: true });
    })();

    /* =====================================================
       GENERATE APP ICON (canvas ‚Üí apple-touch-icon)
       ===================================================== */
    (function generateIcon() {
      try {
        const c   = document.createElement('canvas');
        c.width   = 192;
        c.height  = 192;
        const ctx = c.getContext('2d');
        // Background
        ctx.fillStyle = '#4f8dfd';
        ctx.beginPath();
        ctx.roundRect(0, 0, 192, 192, 36);
        ctx.fill();
        // Text
        ctx.fillStyle = '#ffffff';
        ctx.font = 'bold 90px -apple-system, "Helvetica Neue", sans-serif';
        ctx.textAlign    = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('Âã§', 96, 102);
        document.getElementById('apple-touch-icon-link').href = c.toDataURL('image/png');
      } catch (_) {}
    })();

    /* =====================================================
       INIT
       ===================================================== */
    (async function init() {
      try {
        const t = new Date();
        // IDBÂæ©ÂÖÉÔºàÂ§±Êïó„Åó„Å¶„ÇÇÁ∂öË°åÔºâ
        let restored = false;
        try { restored = await restoreFromIDBIfNeeded(); } catch(e) { console.warn('[init] IDBÂæ©ÂÖÉ„Çπ„Ç≠„ÉÉ„Éó:', e); }
        // „Ç´„É¨„É≥„ÉÄ„ÉºÊèèÁîªÔºàÂ§±Êïó„Åó„Å¶„ÇÇÁ∂öË°åÔºâ
        try { loadMonth(t.getFullYear(), t.getMonth() + 1); } catch(e) { console.warn('[init] loadMonthÂ§±Êïó:', e); }
        if (restored) {
          try { renderCalendar(t.getFullYear(), t.getMonth() + 1); } catch(e) {}
          try { renderStats(t.getFullYear(), t.getMonth() + 1); }  catch(e) {}
        }
        try { checkBackupReminder(); } catch(e) {}
        // „Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØÔºàÈùûÂêåÊúüÔºâ
        try { runHealthCheck(); } catch(e) {}
        // Â§©Ê∞óÂèñÂæóÔºà„Ç´„É¨„É≥„ÉÄ„Éº„Éü„Éã„Éê„Éä„ÉºÁî®„ÄÅÂ§±Êïó„Åó„Å¶„ÇÇÁ∂öË°åÔºâ
        try { renderWeather(false); } catch(e) {}
        // Ëµ∑ÂãïÊàêÂäü ‚Üí „ÇØ„É©„ÉÉ„Ç∑„É•„Ç´„Ç¶„É≥„Çø„Çí„É™„Çª„ÉÉ„Éà
        localStorage.setItem(_CRASH_KEY, '0');
        _appLog('info', 'init', 'Ëµ∑ÂãïÂÆå‰∫Ü');
        try { renderTailscaleCard(); } catch(e) {}
        // ÂàùÂõû„Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„ÉàÔºàËµ∑ÂãïÊôÇ„Å´1ÂõûÔºâ
        try {
          const store = loadStore();
          if (Object.keys(store.months || {}).length > 0) {
            const lastSnap = localStorage.getItem('_kintai_snap_last') || '0';
            if (Date.now() - Number(lastSnap) > 5 * 60 * 1000) { // 5ÂàÜË∂Ö„Å™„Çâ‰øùÂ≠ò
              saveSnapshot(store);
              localStorage.setItem('_kintai_snap_last', String(Date.now()));
            }
          }
        } catch(e) {}
      } catch(fatal) {
        console.error('[init] Ëá¥ÂëΩÁöÑ„Ç®„É©„Éº:', fatal);
      }
    })();

    /* =====================================================
       NETWORK STATUS MONITORÔºà„Ç™„Éï„É©„Ç§„É≥/„Ç™„É≥„É©„Ç§„É≥ÈÄöÁü•Ôºâ
       ===================================================== */
    (function initNetworkMonitor() {
      const banner = document.getElementById('net-banner');
      let hideTimer = null;

      function showBanner(msg, type, autohide = true) {
        banner.textContent = msg;
        banner.className = `net-banner show ${type}`;
        clearTimeout(hideTimer);
        if (autohide) hideTimer = setTimeout(() => banner.classList.remove('show'), 2800);
      }

      window.addEventListener('online',  () => showBanner('‚úÖ „Ç™„É≥„É©„Ç§„É≥„Å´Âæ©Â∏∞„Åó„Åæ„Åó„Åü', 'online'));
      window.addEventListener('offline', () => showBanner('üìµ „Ç™„Éï„É©„Ç§„É≥„Åß„Åô ‚Äî „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÅßÂãï‰Ωú‰∏≠', 'offline', false));

      // ÂàùÊúüÁä∂ÊÖã„Åå„Ç™„Éï„É©„Ç§„É≥„ÅÆÂ†¥Âêà
      if (!navigator.onLine) showBanner('üìµ „Ç™„Éï„É©„Ç§„É≥„Åß„Åô ‚Äî „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÅßÂãï‰Ωú‰∏≠', 'offline', false);
    })();

    /* =====================================================
       KEYBOARD SHORTCUTSÔºà„Éë„ÉØ„Éº„É¶„Éº„Ç∂„ÉºÂêë„ÅëÔºâ
       ===================================================== */
    document.addEventListener('keydown', e => {
      // „É¢„Éº„ÉÄ„É´„ÉªÂÖ•Âäõ‰∏≠„ÅØÁÑ°Âäπ
      const tag = document.activeElement?.tagName;
      if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

      const memoOpen  = document.getElementById('memo-modal')?.classList.contains('show');
      const taskOpen  = document.getElementById('task-modal')?.classList.contains('show');
      const setsOpen  = document.getElementById('settings-modal')?.classList.contains('show');
      const anyModal  = memoOpen || taskOpen || setsOpen;

      if (e.key === 'Escape' && anyModal) {
        // ESC „Åß„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        if (memoOpen) document.getElementById('memo-modal').classList.remove('show');
        if (taskOpen) document.getElementById('task-modal').classList.remove('show');
        if (setsOpen) document.getElementById('settings-modal').classList.remove('show');
        return;
      }
      if (anyModal) return;

      if (e.key === 'ArrowLeft'  && !e.metaKey) { e.preventDefault(); document.getElementById('prev-month')?.click(); }
      if (e.key === 'ArrowRight' && !e.metaKey) { e.preventDefault(); document.getElementById('next-month')?.click(); }
      if (e.key === 't' || e.key === 'T')        document.getElementById('today-button')?.click();
    });

    /* =====================================================
       TASK MANAGEMENT
       ===================================================== */
    const TASKS_KEY = 'kintai_tasks_v1';

    function loadTasks() {
      try { return JSON.parse(localStorage.getItem(TASKS_KEY) || '[]'); } catch { return []; }
    }

    function saveTasks(tasks) {
      localStorage.setItem(TASKS_KEY, JSON.stringify(tasks));
    }

    function _esc(s) {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function taskItemHTML(t) {
      const memoHTML = t.memo ? `<div class="task-memo">${_esc(t.memo)}</div>` : '';
      return `<div class="task-item${t.done ? ' done' : ''}">
        <input type="checkbox" class="task-check" data-id="${t.id}" ${t.done ? 'checked' : ''}>
        <div class="task-body">
          <div class="task-title">${_esc(t.title)}</div>${memoHTML}
        </div>
        <button class="task-del" data-id="${t.id}" title="ÂâäÈô§">üóë</button>
      </div>`;
    }

    function renderTaskList() {
      const tasks     = loadTasks();
      const container = document.getElementById('task-list-container');
      const todo      = tasks.filter(t => !t.done);
      const done      = tasks.filter(t => t.done);
      let html = '';
      if (!todo.length && !done.length) {
        html = '<div class="task-empty">„Çø„Çπ„ÇØ„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì<br>‰∏ä„ÅÆ„Éï„Ç©„Éº„É†„Åã„ÇâËøΩÂä†„Åß„Åç„Åæ„Åô</div>';
      } else {
        if (todo.length) html += '<div class="task-section-title">Êú™ÂÆå‰∫Ü</div><div class="task-list">' + todo.map(taskItemHTML).join('') + '</div>';
        if (done.length) html += '<div class="task-section-title">ÂÆå‰∫ÜÊ∏à„Åø</div><div class="task-list">' + done.map(taskItemHTML).join('') + '</div>';
      }
      container.innerHTML = html;

      container.querySelectorAll('.task-check').forEach(cb => {
        cb.addEventListener('change', () => {
          const ts = loadTasks();
          const idx = ts.findIndex(t => t.id === cb.dataset.id);
          if (idx !== -1) { ts[idx].done = cb.checked; saveTasks(ts); renderTaskList(); }
        });
      });
      container.querySelectorAll('.task-del').forEach(btn => {
        btn.addEventListener('click', () => {
          if (!confirm('„Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
          saveTasks(loadTasks().filter(t => t.id !== btn.dataset.id));
          renderTaskList();
        });
      });
    }

    (function initTaskModal() {
      const modal    = document.getElementById('task-modal');
      const fab      = document.getElementById('fab-task');
      const closeBtn = document.getElementById('task-modal-close');
      const addBtn   = document.getElementById('task-add-btn');
      const titleIn  = document.getElementById('task-title-input');
      const memoIn   = document.getElementById('task-memo-input');

      function openTaskModal() {
        modal.classList.add('show');
        renderTaskList();
        setTimeout(() => titleIn.focus(), 100);
      }
      function closeTaskModal() {
        modal.classList.remove('show');
        titleIn.value = '';
        memoIn.value  = '';
      }

      fab.addEventListener('click', openTaskModal);
      closeBtn.addEventListener('click', closeTaskModal);
      modal.addEventListener('click', e => { if (e.target === modal) closeTaskModal(); });

      addBtn.addEventListener('click', () => {
        const title = titleIn.value.trim();
        if (!title) { toast('„Çø„Çπ„ÇØÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); titleIn.focus(); return; }
        const ts = loadTasks();
        ts.unshift({ id: Date.now().toString(), title, memo: memoIn.value.trim(), done: false, created: new Date().toISOString() });
        saveTasks(ts);
        titleIn.value = '';
        memoIn.value  = '';
        renderTaskList();
        toast('‚úÖ „Çø„Çπ„ÇØ„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü');
      });

      titleIn.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); addBtn.click(); }
      });

      // fab-task „ÅØ memo-modal / settings-modal „ÅåÈñã„ÅÑ„Å¶„ÅÑ„Çã„Å®„ÅçÈö†„Åô
      const fabToday = document.getElementById('fab-today');
      const hideOnOtherModal = new MutationObserver(() => {
        const anyOther = document.getElementById('memo-modal').classList.contains('show')
                      || document.getElementById('settings-modal').classList.contains('show');
        fab.classList.toggle('hidden', anyOther);
      });
      hideOnOtherModal.observe(document.getElementById('memo-modal'),     { attributes: true });
      hideOnOtherModal.observe(document.getElementById('settings-modal'), { attributes: true });

      // fab-today „ÅØ task-modal „ÅåÈñã„ÅÑ„Å¶„ÅÑ„Çã„Å®„ÅçÈö†„Åô
      new MutationObserver(() => {
        const open = modal.classList.contains('show');
        fabToday.classList.toggle('hidden', open);
        fab.classList.toggle('hidden', open);
      }).observe(modal, { attributes: true });
    })();

    /* =====================================================
       EMERGENCY MODAL
       ===================================================== */
    (function initEmergencyModal() {
      const modal    = document.getElementById('emergency-modal');
      const closeBtn = document.getElementById('emergency-modal-close');
      const fabRecover = document.getElementById('fab-recover');
      const btnRecover = document.getElementById('btn-recover');
      const diagEl   = document.getElementById('em-diag');

      function openEmergencyModal() {
        modal.classList.add('show');
        // Ë®∫Êñ≠ÊÉÖÂ†±„ÇíÊõ¥Êñ∞
        (async () => {
          try {
            let lines = [];
            // localStorage „Çµ„Ç§„Ç∫
            let lsSize = 0;
            for (const k of Object.keys(localStorage)) lsSize += (localStorage.getItem(k) || '').length;
            lines.push(`LS‰ΩøÁî®Èáè: ${Math.round(lsSize/1024)}KB`);
            // IDBÁ¢∫Ë™ç
            const idbData = await idbLoad();
            const idbMonths = Object.keys(idbData?.months || {}).length;
            lines.push(`IDB: ${idbMonths}„É∂ÊúàÂàÜ`);
            // „Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„Éà
            const snaps = listSnapshots();
            lines.push(`„Çπ„Éä„ÉÉ„Éó: ${snaps.length}‰ª∂`);
            if (snaps.length > 0) {
              const d = new Date(snaps[0].ts);
              lines.push(`  ÊúÄÊñ∞: ${d.toLocaleDateString('ja')} ${d.toLocaleTimeString('ja')}`);
              lines.push(`  „Éá„Éº„Çø: ${snaps[0].months}„É∂ÊúàÂàÜ`);
            }
            // „Ç®„É©„Éº„É≠„Ç∞
            const errs = JSON.parse(localStorage.getItem(_ERR_KEY) || '[]');
            lines.push(`„Ç®„É©„Éº„É≠„Ç∞: ${errs.length}‰ª∂`);
            if (errs.length > 0) {
              lines.push(`  ÊúÄÊñ∞: ${errs[0].type} (${errs[0].ts.slice(0,16)})`);
            }
            // „ÇØ„É©„ÉÉ„Ç∑„É•„Ç´„Ç¶„É≥„Éà
            lines.push(`„ÇØ„É©„ÉÉ„Ç∑„É•: ${localStorage.getItem(_CRASH_KEY) || '0'}Âõû`);
            diagEl.textContent = lines.join('\n');
          } catch(e) {
            diagEl.textContent = 'Ë®∫Êñ≠ÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó: ' + e.message;
          }
        })();
      }

      function closeEmergencyModal() {
        modal.classList.remove('show');
      }

      if (fabRecover) fabRecover.addEventListener('click', openEmergencyModal);
      if (btnRecover) btnRecover.addEventListener('click', openEmergencyModal);
      closeBtn.addEventListener('click', closeEmergencyModal);
      modal.addEventListener('click', e => { if (e.target === modal) closeEmergencyModal(); });

      // SWÂº∑Âà∂Êõ¥Êñ∞
      document.getElementById('em-sw-reload').addEventListener('click', async () => {
        try {
          const regs = await navigator.serviceWorker.getRegistrations();
          for (const r of regs) await r.update();
          toast('‚úÖ Service Worker „ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
        } catch(e) { toast('SWÊõ¥Êñ∞Â§±Êïó: ' + e.message); }
        closeEmergencyModal();
        runHealthCheck();
      });

      // „Ç≠„É£„ÉÉ„Ç∑„É•„ÉªSW„ÇØ„É™„Ç¢Ôºà„Éá„Éº„Çø‰øùÊåÅÔºâ
      document.getElementById('em-cache-clear').addEventListener('click', async () => {
        if (!confirm('„Ç≠„É£„ÉÉ„Ç∑„É•„Å®Service Worker„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÄÇ\n„Éá„Éº„Çø„ÅØ‰øùÊåÅ„Åï„Çå„Åæ„Åô„ÄÇ')) return;
        try {
          const regs = await navigator.serviceWorker.getRegistrations();
          for (const r of regs) await r.unregister();
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
          toast('‚úÖ „Ç≠„É£„ÉÉ„Ç∑„É•„ÉªSW„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü ‚Äî ÂÜçË™≠Ëæº„Åó„Åæ„Åô');
          setTimeout(() => location.reload(), 1200);
        } catch(e) { toast('„ÇØ„É™„Ç¢Â§±Êïó: ' + e.message); }
      });

      // „Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„Éà„Åã„ÇâÂæ©ÂÖÉ
      document.getElementById('em-snap-restore').addEventListener('click', () => {
        const snap = loadLatestSnapshot();
        if (!snap) { toast('‚ö†Ô∏è Âæ©ÂÖÉ„Åß„Åç„Çã„Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'); return; }
        const d = new Date(snap.meta.ts);
        const fmt = `${d.toLocaleDateString('ja')} ${d.toLocaleTimeString('ja')}`;
        if (!confirm(`„Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„ÉàÔºà${fmt}„ÄÅ${snap.meta.months}„É∂ÊúàÂàÜÔºâ„Åã„Çâ„Éá„Éº„Çø„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åô„ÅãÔºü\nÁèæÂú®„ÅÆ„Éá„Éº„Çø„ÅØ‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇ`)) return;
        try {
          localStorage.setItem(STORE_KEY, JSON.stringify(snap.data));
          idbSave(snap.data);
          toast('‚úÖ „Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„Éà„Åã„ÇâÂæ©ÂÖÉ„Åó„Åæ„Åó„Åü ‚Äî ÂÜçË™≠Ëæº„Åó„Åæ„Åô');
          closeEmergencyModal();
          setTimeout(() => location.reload(), 1200);
        } catch(e) { toast('Âæ©ÂÖÉÂ§±Êïó: ' + e.message); }
      });

      // ÂÖ®„Éá„Éº„ÇøÊ∂àÂéª„É™„Çª„ÉÉ„ÉàÔºàPINË™çË®º ‚Üí confirm „ÅÆÈ†ÜÔºâ
      document.getElementById('em-full-reset').addEventListener('click', async () => {
        // ‚ë† „Åæ„ÅöPIN/DELETEË™çË®ºÔºàÊúÄÂàù„Å´Â£Å„ÇíË®≠„Åë„ÇãÔºâ
        const pinOk = await requirePin('ÂÖ®„Éá„Éº„ÇøÊ∂àÂéª„Åó„Å¶„É™„Çª„ÉÉ„Éà');
        if (!pinOk) { toast('‚ùå Ë™çË®ºÂ§±Êïó ‚Äî „É™„Çª„ÉÉ„Éà„Çí‰∏≠Ê≠¢„Åó„Åæ„Åó„Åü'); return; }
        // ‚ë° Ë™çË®ºÂæå„Å´ÊúÄÁµÇÁ¢∫Ë™ç„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó
        if (!confirm('‚ö†Ô∏è Âã§ÊÄ†„Éá„Éº„Çø„ÇíÂê´„ÇÄÂÖ®„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Å¶„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÄÇ\nÊú¨ÂΩì„Å´„Çà„ÅÑ„Åß„Åô„ÅãÔºü\n\n„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ')) return;
        if (!confirm('ÊúÄÁµÇÁ¢∫Ë™çÔºöÊú¨ÂΩì„Å´„Åô„Åπ„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
        try {
          const regs = await navigator.serviceWorker.getRegistrations();
          for (const r of regs) await r.unregister();
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
          localStorage.clear();
          indexedDB.deleteDatabase(IDB_NAME);
          toast('‚úÖ ÂÖ®„É™„Çª„ÉÉ„ÉàÂÆå‰∫Ü ‚Äî ÂÜçË™≠Ëæº„Åó„Åæ„Åô');
          setTimeout(() => location.replace(location.pathname), 1200);
        } catch(e) { toast('„É™„Çª„ÉÉ„ÉàÂ§±Êïó: ' + e.message); }
      });

      // Á∑äÊÄ•FAB„ÅØ‰ªñ„ÅÆ„É¢„Éº„ÉÄ„É´„ÅåÈñã„ÅÑ„Å¶„ÅÑ„Çã„Å®„ÅçÈö†„ÅôÔºàÈÇ™È≠î„Å´„Å™„Çâ„Å™„ÅÑ„Çà„ÅÜÔºâ
      const hideObs = new MutationObserver(() => {
        const anyOpen = document.getElementById('memo-modal')?.classList.contains('show')
                     || document.getElementById('settings-modal')?.classList.contains('show')
                     || document.getElementById('task-modal')?.classList.contains('show');
        if (fabRecover) fabRecover.classList.toggle('hidden', anyOpen);
      });
      ['memo-modal','settings-modal','task-modal'].forEach(id => {
        const el = document.getElementById(id);
        if (el) hideObs.observe(el, { attributes: true });
      });
    })();

    /* =====================================================
       PIN AUTHENTICATION SYSTEM
       ===================================================== */
    const PIN_HASH_KEY = 'kintai_pin_hash';
    const PIN_FAIL_KEY = 'kintai_pin_fails';
    const PIN_LOCK_KEY = 'kintai_pin_lock';
    const PIN_MAX_FAILS = 3;
    const PIN_LOCKOUT_MS = 60000;

    async function sha256(text) {
      try {
        const data = new TextEncoder().encode(String(text));
        const hash = await crypto.subtle.digest('SHA-256', data);
        return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
      } catch(_) { return null; }
    }

    function isPinSet() { return !!localStorage.getItem(PIN_HASH_KEY); }
    function getPinLockUntil() { return Number(localStorage.getItem(PIN_LOCK_KEY) || 0); }
    function getPinFails() { return Number(localStorage.getItem(PIN_FAIL_KEY) || 0); }

    // Returns Promise<boolean>: true=authenticated, false=cancelled/failed
    function requirePin(purpose) {
      if (!isPinSet()) {
        // PIN„ÅåÊú™Ë®≠ÂÆö ‚Üí "DELETE"ÂÖ•Âäõ„Åß‰ª£ÊõøÁ¢∫Ë™çÔºàË®≠ÂÆö„Çí‰øÉ„ÅôÔºâ
        const label = purpose || '„Åì„ÅÆÂç±Èô∫„Å™Êìç‰Ωú';
        const msg = `üîê PINÊú™Ë®≠ÂÆö\n\n„Äå${label}„Äç\n\n‚ö†Ô∏è „Çª„Ç≠„É•„É™„ÉÜ„Ç£PIN„ÅåÊú™Ë®≠ÂÆö„ÅÆ„Åü„ÇÅ„ÄÅ\nÊñáÂ≠óÁ¢∫Ë™ç„Å´Âàá„ÇäÊõø„Åà„Åæ„Åô„ÄÇ\n\nÁ∂öË°å„Åô„Çã„Å´„ÅØ„ÄåDELETE„Äç„Å®ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\nÔºàË®≠ÂÆö ‚öôÔ∏è ‚Üí „Çª„Ç≠„É•„É™„ÉÜ„Ç£PIN „Åß‰∫ãÂâçË®≠ÂÆö„ÇíÊé®Â•®Ôºâ`;
        const input = prompt(msg);
        return Promise.resolve(input === 'DELETE');
      }
      return new Promise(resolve => {
        const modal    = document.getElementById('pin-modal');
        const purposeEl = document.getElementById('pin-purpose');
        const dotsEl   = document.getElementById('pin-dots');
        const errorEl  = document.getElementById('pin-error');
        const lockEl   = document.getElementById('pin-lock-msg');

        purposeEl.textContent = purpose || '„Åì„ÅÆÊìç‰Ωú„Å´„ÅØPIN„ÅåÂøÖË¶Å„Åß„Åô';
        let pin = '', resolved = false, lockTimer = null;

        function updateDots() {
          dotsEl.querySelectorAll('.pin-dot').forEach((d, i) => d.classList.toggle('filled', i < pin.length));
        }

        function checkLockout() {
          const lockUntil = getPinLockUntil();
          if (lockUntil > Date.now()) {
            const rem = Math.ceil((lockUntil - Date.now()) / 1000);
            lockEl.textContent = `üîí ${rem}ÁßíÂæå„Å´ÂÜçË©¶Ë°å„Åß„Åç„Åæ„Åô`;
            return true;
          }
          lockEl.textContent = '';
          return false;
        }

        async function submitPin() {
          if (checkLockout()) return;
          if (pin.length < 4) { errorEl.textContent = '4Ê°Å‰ª•‰∏äÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'; return; }
          const hash = await sha256(pin);
          const stored = localStorage.getItem(PIN_HASH_KEY);
          if (hash === stored) {
            localStorage.setItem(PIN_FAIL_KEY, '0');
            errorEl.textContent = '';
            cleanup(true);
          } else {
            const fails = getPinFails() + 1;
            localStorage.setItem(PIN_FAIL_KEY, String(fails));
            if (fails >= PIN_MAX_FAILS) {
              localStorage.setItem(PIN_LOCK_KEY, String(Date.now() + PIN_LOCKOUT_MS));
              localStorage.setItem(PIN_FAIL_KEY, '0');
              startLockTimer();
            }
            const rem = Math.max(0, PIN_MAX_FAILS - fails);
            errorEl.textContent = `‚ùå PIN„ÅåÈÅï„ÅÑ„Åæ„Åô${rem > 0 ? `ÔºàÊÆã„Çä${rem}ÂõûÔºâ` : ''}`;
            pin = ''; updateDots();
          }
        }

        function startLockTimer() {
          clearInterval(lockTimer);
          lockTimer = setInterval(() => { if (!checkLockout()) clearInterval(lockTimer); }, 1000);
          checkLockout();
        }

        function onKey(k) {
          if (checkLockout()) return;
          if (k === 'del') { pin = pin.slice(0, -1); updateDots(); errorEl.textContent = ''; }
          else if (pin.length < 6) { pin += k; updateDots(); if (pin.length >= 4) submitPin(); }
        }

        function cleanup(ok) {
          if (resolved) return;
          resolved = true;
          clearInterval(lockTimer);
          modal.classList.remove('show');
          pin = ''; updateDots(); errorEl.textContent = '';
          resolve(ok);
        }

        modal.querySelectorAll('[data-key]').forEach(btn => { btn.onclick = () => onKey(btn.dataset.key); });
        document.getElementById('pin-key-del').onclick    = () => onKey('del');
        document.getElementById('pin-key-cancel').onclick = () => cleanup(false);
        document.getElementById('pin-modal-cancel').onclick = () => cleanup(false);
        modal.onclick = e => { if (e.target === modal) cleanup(false); };

        if (getPinLockUntil() > Date.now()) startLockTimer();
        pin = ''; updateDots(); errorEl.textContent = '';
        modal.classList.add('show');
      });
    }

    async function setupPin(newPin) {
      const hash = await sha256(newPin);
      if (!hash) { toast('PINË®≠ÂÆö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'); return false; }
      localStorage.setItem(PIN_HASH_KEY, hash);
      localStorage.removeItem(PIN_FAIL_KEY);
      localStorage.removeItem(PIN_LOCK_KEY);
      return true;
    }

    function clearPin() {
      localStorage.removeItem(PIN_HASH_KEY);
      localStorage.removeItem(PIN_FAIL_KEY);
      localStorage.removeItem(PIN_LOCK_KEY);
    }

    function updatePinUI() {
      const set = isPinSet();
      const hint = document.getElementById('pin-status-hint');
      const clearBtn = document.getElementById('btn-clear-pin');
      if (hint) hint.textContent = set ? '‚úÖ PIN„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô' : '‚ö†Ô∏è PIN„ÅåÊú™Ë®≠ÂÆö„Åß„Åô';
      if (clearBtn) clearBtn.style.display = set ? '' : 'none';
    }

    (function initPinSettings() {
      const btnSet   = document.getElementById('btn-set-pin');
      const btnClear = document.getElementById('btn-clear-pin');
      if (!btnSet) return;

      btnSet.addEventListener('click', async () => {
        if (isPinSet()) {
          const ok = await requirePin('ÁèæÂú®„ÅÆPIN„ÅßË™çË®º„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
          if (!ok) return;
        }
        const p1 = prompt('Êñ∞„Åó„ÅÑPIN„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà4„Äú6Ê°Å„ÅÆÊï∞Â≠óÔºâ');
        if (!p1 || !/^\d{4,6}$/.test(p1)) { toast('4„Äú6Ê°Å„ÅÆÊï∞Â≠ó„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
        const p2 = prompt('„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàÁ¢∫Ë™çÔºâ');
        if (p1 !== p2) { toast('‚ö†Ô∏è PIN„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„Çì'); return; }
        await setupPin(p1);
        updatePinUI();
        toast('‚úÖ PIN„ÇíË®≠ÂÆö„Åó„Åæ„Åó„Åü');
      });

      btnClear.addEventListener('click', async () => {
        const ok = await requirePin('PIN„ÇíËß£Èô§„Åô„Çã„Å´„ÅØÁèæÂú®„ÅÆPIN„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        if (!ok) return;
        if (!confirm('PIN„ÇíËß£Èô§„Åó„Åæ„Åô„ÄÇ„Çà„ÅÑ„Åß„Åô„ÅãÔºü')) return;
        clearPin();
        updatePinUI();
        toast('‚úÖ PIN„ÇíËß£Èô§„Åó„Åæ„Åó„Åü');
      });
    })();

    /* =====================================================
       TAB NAVIGATION
       ===================================================== */
    (function initTabs() {
      const tabs   = document.querySelectorAll('.tab-btn[data-tab]');
      const pages  = document.querySelectorAll('.tab-page');
      const calFabs = ['fab-today', 'fab-task', 'fab-recover'].map(id => document.getElementById(id));

      function switchTab(tabName) {
        tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === tabName));
        pages.forEach(p => p.classList.toggle('active', p.id === 'page-' + tabName));
        const isCal = (tabName === 'calendar');
        calFabs.forEach(f => f?.classList.toggle('hidden', !isCal));
        window.scrollTo({ top: 0, behavior: 'smooth' });
        if (tabName === 'hub')     { renderLauncher(); renderTailscaleCard(); }
        if (tabName === 'study')   renderStudy();
        if (tabName === 'project') renderProjects();
      }

      tabs.forEach(t => t.addEventListener('click', () => switchTab(t.dataset.tab)));
    })();

    /* =====================================================
       LAUNCHER / QUICK LINKS
       ===================================================== */
    const LAUNCHER_KEY = 'kintai_launcher_v1';
    const LAUNCHER_DEFAULTS = [
      { id: 'gcal',  name: 'G„Ç´„É¨„É≥„ÉÄ„Éº', url: 'https://calendar.google.com',        icon: 'üìÜ' },
      { id: 'gmail', name: 'Gmail',        url: 'https://mail.google.com',            icon: 'üìß' },
      { id: 'gdrive',name: 'Drive',        url: 'https://drive.google.com',           icon: 'üóÇ' },
      { id: 'slack', name: 'Slack',        url: 'https://slack.com',                  icon: 'üí¨' },
    ];

    function loadLinks() {
      try {
        const r = localStorage.getItem(LAUNCHER_KEY);
        return r ? JSON.parse(r) : [...LAUNCHER_DEFAULTS];
      } catch { return [...LAUNCHER_DEFAULTS]; }
    }
    function saveLinks(links) { localStorage.setItem(LAUNCHER_KEY, JSON.stringify(links)); }

    function renderLauncher() {
      const grid = document.getElementById('links-grid');
      if (!grid) return;

      // Â§©Ê∞ó‰∫àÂ†±„ÇíÊõ¥Êñ∞Ôºà„Ç≠„É£„ÉÉ„Ç∑„É•„Åå„ÅÇ„Çå„Å∞Âç≥ÂèçÊò†Ôºâ
      renderWeather(false);

      // jinjer „Ç´„Éº„Éâ„ÅÆURL„Çíconfig„Åã„ÇâÂãïÁöÑË®≠ÂÆö
      const cfg = loadConfig();
      const jinjerUrl = cfg.jinjerUrl || 'https://kintai.jinjer.biz/staffs/top';
      const jinjerLink = document.getElementById('jinjer-link');
      if (jinjerLink) jinjerLink.href = jinjerUrl;

      // ‰ªäÊó•„ÅÆÊâìÂàªÁä∂Ê≥Å„ÇíPWA„Éá„Éº„Çø„Åã„ÇâË°®Á§∫
      const bar = document.getElementById('jinjer-today-bar');
      const statusEl = document.getElementById('jinjer-today-status');
      if (bar && statusEl) {
        try {
          const today = new Date().toISOString().slice(0, 10);
          const store = loadStore();
          const ym = today.slice(0, 7);
          const day = store.months?.[ym]?.[today];
          if (day) {
            const stStr = day.start ? `üü¢ ${day.start}` : 'ÊâìÂàª„Å™„Åó';
            const edStr = day.end   ? ` „Äú üî¥ ${day.end}` : '';
            const stLabel = day.status && day.status !== 'Êú™' ? `„Äê${day.status}„Äë ` : '';
            statusEl.textContent = stLabel + stStr + edStr;
            bar.style.display = '';
          } else {
            bar.style.display = 'none';
          }
        } catch(_) { bar.style.display = 'none'; }
      }

      const links = loadLinks();
      grid.innerHTML = links.map(l => `
        <div class="link-tile-wrap">
          <a href="${_esc(l.url)}" target="_blank" rel="noopener" class="link-tile" title="${_esc(l.name)}">
            <div class="link-tile-icon">${l.icon || 'üîó'}</div>
            <div>${_esc(l.name)}</div>
          </a>
          <span class="link-tile-del" data-id="${_esc(l.id)}" title="ÂâäÈô§">√ó</span>
        </div>`).join('') +
        `<div class="link-tile-wrap">
          <button class="link-tile link-tile-add" id="btn-add-link" style="background:rgba(255,255,255,0.5);border:1.5px dashed rgba(180,190,220,0.7);color:var(--text-muted);">
            <div class="link-tile-icon">‚ûï</div><div>ËøΩÂä†</div>
          </button>
        </div>`;

      grid.querySelectorAll('.link-tile-del').forEach(btn => {
        btn.addEventListener('click', e => {
          e.preventDefault(); e.stopPropagation();
          saveLinks(loadLinks().filter(l => l.id !== btn.dataset.id));
          renderLauncher();
        });
      });
      document.getElementById('btn-add-link')?.addEventListener('click', showAddLinkDialog);
    }

    function showAddLinkDialog() {
      const name = prompt('„É™„É≥„ÇØÂêçÔºà‰æã: Ë≥áÊ†º„Ç¢„Éó„É™„ÄÅÁ§æÂÜÖWikiÔºâ');
      if (!name?.trim()) return;
      const url = prompt('URLÔºà‰æã: https://example.comÔºâ');
      if (!url?.trim() || !url.startsWith('http')) { toast('Ê≠£„Åó„ÅÑURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàhttps://„ÄúÔºâ'); return; }
      const icon = prompt('ÁµµÊñáÂ≠ó„Ç¢„Ç§„Ç≥„É≥Ôºà‰æã: üìù Ôºâ', 'üîó') || 'üîó';
      saveLinks([...loadLinks(), { id: Date.now().toString(), name: name.trim(), url: url.trim(), icon: icon.trim().slice(0, 2) }]);
      renderLauncher();
      toast('‚úÖ „É™„É≥„ÇØ„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü');
    }

    /* =====================================================
       STUDY / CERTIFICATION TRACKER
       ===================================================== */
    const STUDY_KEY = 'kintai_study_v1';
    const STUDY_COLORS = ['#7c5fe6','#4f8dfd','#2e7d32','#ef6c00','#c62828','#1565c0','#00838f'];

    function loadStudy() {
      try { const r = localStorage.getItem(STUDY_KEY); return r ? JSON.parse(r) : []; } catch { return []; }
    }
    function saveStudy(d) { localStorage.setItem(STUDY_KEY, JSON.stringify(d)); }

    function renderStudy() {
      const container = document.getElementById('study-list');
      if (!container) return;

      // ‰ªäÈÄ±„Çµ„Éû„É™„Éº
      const weekSummary = document.getElementById('study-week-summary');
      if (weekSummary) {
        const today = new Date();
        const dow   = today.getDay(); // 0=Sun
        const weekDates = Array.from({ length: 7 }, (_, i) => {
          const d = new Date(today);
          d.setDate(today.getDate() - dow + i);
          return d.toISOString().slice(0, 10);
        });
        const allStudy = loadStudy();
        let weekTotal = 0;
        weekDates.forEach(dt => {
          allStudy.forEach(s => {
            weekTotal += (s.logs || []).filter(l => l.date === dt).reduce((a, l) => a + l.hours, 0);
          });
        });
        const dayTotals = weekDates.map(dt => {
          let h = 0;
          allStudy.forEach(s => { h += (s.logs || []).filter(l => l.date === dt).reduce((a, l) => a + l.hours, 0); });
          return { dt, h };
        });
        const dayNames = ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'];
        const maxH = Math.max(...dayTotals.map(d => d.h), 1);
        weekSummary.innerHTML = `
          <div style="width:100%;">
            <div style="display:flex;align-items:flex-end;gap:4px;height:48px;margin-bottom:4px;">
              ${dayTotals.map(({ dt, h }, i) => {
                const isToday = dt === today.toISOString().slice(0,10);
                const barH = Math.round((h / maxH) * 40);
                return `<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;">
                  <div style="font-size:9px;color:var(--text-muted);font-weight:700;">${h > 0 ? h + 'h' : ''}</div>
                  <div style="width:100%;height:${Math.max(barH,2)}px;background:${isToday ? 'var(--accent-purple)' : 'var(--accent-blue)'};border-radius:3px;opacity:${h > 0 ? 1 : 0.15};"></div>
                  <div style="font-size:9px;color:${isToday ? 'var(--accent-blue)' : 'var(--text-muted)'};font-weight:${isToday ? '900' : '600'};">${dayNames[new Date(dt+'T00:00:00').getDay()]}</div>
                </div>`;
              }).join('')}
            </div>
            <div style="font-size:11px;color:var(--text-muted);text-align:right;">‰ªäÈÄ±ÂêàË®à: <strong style="color:var(--accent-purple);">${weekTotal.toFixed(1)}h</strong></div>
          </div>`;
      }

      const data = loadStudy();
      if (!data.length) {
        container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:24px 0 16px;font-size:13px;line-height:1.8;">Ë≥áÊ†º„ÉªÂ≠¶ÁøíÁõÆÊ®ô„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ<br>Ë©¶È®ìÊó•„ÉªÁõÆÊ®ôÊôÇÈñì„ÉªÈÄ≤Êçó„ÇíÁÆ°ÁêÜ„Åß„Åç„Åæ„Åô</div>';
        return;
      }
      container.innerHTML = data.map(s => {
        const total  = (s.logs || []).reduce((sum, l) => sum + (l.hours || 0), 0);
        const target = s.targetHours || 100;
        const pct    = Math.min(100, Math.round(total / target * 100));
        let cdText = '', cdStyle = '';
        if (s.examDate) {
          const days = Math.ceil((new Date(s.examDate) - new Date()) / 86400000);
          if      (days > 0)  { cdText = `„ÅÇ„Å®${days}Êó•`; cdStyle = days <= 30 ? 'background:#ffebee;color:#c62828' : days <= 60 ? 'background:#fff8e1;color:#ef6c00' : 'background:#e8f5e9;color:#2e7d32'; }
          else if (days === 0){ cdText = '‰ªäÊó•ÔºÅ'; cdStyle = 'background:#ffebee;color:#c62828'; }
          else                { cdText = `${-days}Êó•ÁµåÈÅé`; cdStyle = 'background:#f4f4f6;color:#888'; }
        }
        const today = new Date().toISOString().slice(0,10);
        const todayH = (s.logs || []).filter(l => l.date === today).reduce((sum, l) => sum + l.hours, 0);
        return `<div class="study-item" data-id="${s.id}">
          <div class="study-header">
            <div class="study-color-dot" style="background:${s.color};"></div>
            <div class="study-name">${_esc(s.name)}</div>
            ${cdText ? `<span class="study-countdown" style="${cdStyle};">${cdText}</span>` : ''}
            <button class="study-del-btn" data-id="${s.id}" title="ÂâäÈô§">üóë</button>
          </div>
          <div class="study-progress-wrap"><div class="study-progress-fill" style="width:${pct}%;background:${s.color};"></div></div>
          <div class="study-stats">
            <span>üìñ ${total.toFixed(1)}h / ${target}h${todayH > 0 ? ` (‰ªäÊó•+${todayH}h)` : ''}</span>
            <span style="font-weight:800;color:${s.color};">${pct}%</span>
          </div>
          <div class="study-today">
            <input type="number" class="study-hours-input" data-id="${s.id}" min="0" max="24" step="0.25" placeholder="‰ªäÊó•„ÅÆÊôÇÈñì">
            <button class="study-add-btn" data-id="${s.id}">Ôºã ËøΩË®ò</button>
          </div>
        </div>`;
      }).join('');

      container.querySelectorAll('.study-del-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          if (!confirm('„Åì„ÅÆË≥áÊ†º„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
          saveStudy(loadStudy().filter(s => s.id !== btn.dataset.id));
          renderStudy();
        });
      });
      container.querySelectorAll('.study-add-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id    = btn.dataset.id;
          const input = container.querySelector(`.study-hours-input[data-id="${id}"]`);
          const hours = parseFloat(input?.value || '0');
          if (!hours || hours <= 0) { toast('ÊôÇÈñì„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
          const data = loadStudy(), idx = data.findIndex(s => s.id === id);
          if (idx === -1) return;
          if (!data[idx].logs) data[idx].logs = [];
          data[idx].logs.push({ date: new Date().toISOString().slice(0,10), hours });
          saveStudy(data);
          if (input) input.value = '';
          renderStudy();
          toast(`‚úÖ ${hours}h „ÇíËøΩË®ò„Åó„Åæ„Åó„Åü`);
        });
      });
    }

    document.getElementById('btn-add-study')?.addEventListener('click', () => {
      const name = prompt('Ë≥áÊ†º„ÉªÂ≠¶ÁøíÂêçÔºà‰æã: ÂøúÁî®ÊÉÖÂ†±ÊäÄË°ìËÄÖË©¶È®ìÔºâ');
      if (!name?.trim()) return;
      const targetStr = prompt('ÁõÆÊ®ôÂ≠¶ÁøíÊôÇÈñìÔºàÊôÇÈñì„ÄÅ‰æã: 200Ôºâ', '100');
      const target = parseFloat(targetStr || '100') || 100;
      const examDate = prompt('Ë©¶È®ìÊó•ÔºàYYYY-MM-DDÂΩ¢Âºè„ÄÅ„Å™„Åë„Çå„Å∞Á©∫Ê¨ÑÔºâ') || '';
      const data = loadStudy();
      data.push({ id: Date.now().toString(), name: name.trim(), targetHours: target, examDate: examDate.trim(), color: STUDY_COLORS[data.length % STUDY_COLORS.length], logs: [] });
      saveStudy(data);
      renderStudy();
      toast('‚úÖ Ë≥áÊ†º„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü');
    });

    /* =====================================================
       PROJECT TRACKER
       ===================================================== */
    const PROJECT_KEY = 'kintai_projects_v1';
    const PROJECT_STATUSES = ['Êú™ÁùÄÊâã', 'ÈÄ≤Ë°å‰∏≠', 'ÂÆå‰∫Ü', '‰øùÁïô'];

    function loadProjects() {
      try { const r = localStorage.getItem(PROJECT_KEY); return r ? JSON.parse(r) : []; } catch { return []; }
    }
    function saveProjects(p) { localStorage.setItem(PROJECT_KEY, JSON.stringify(p)); }

    function renderProjects() {
      const container = document.getElementById('project-list');
      if (!container) return;
      const projects = loadProjects();

      // „Çµ„Éû„É™„Éº„Ç´„Éº„Éâ
      const summaryEl = document.getElementById('project-summary');
      if (summaryEl) {
        const counts = { Êú™ÁùÄÊâã: 0, ÈÄ≤Ë°å‰∏≠: 0, ÂÆå‰∫Ü: 0, ‰øùÁïô: 0 };
        let avgPct = 0;
        projects.forEach(p => { counts[p.status || 'Êú™ÁùÄÊâã']++; avgPct += (p.progress || 0); });
        if (projects.length) avgPct = Math.round(avgPct / projects.length);
        const chips = [
          { label: 'ÈÄ≤Ë°å‰∏≠', val: counts['ÈÄ≤Ë°å‰∏≠'], cls: 'stat-office' },
          { label: 'ÂÆå‰∫Ü',   val: counts['ÂÆå‰∫Ü'],   cls: 'stat-home' },
          { label: 'Êú™ÁùÄÊâã', val: counts['Êú™ÁùÄÊâã'],  cls: 'stat-weekly-toggle' },
          { label: '‰øùÁïô',   val: counts['‰øùÁïô'],    cls: 'stat-off' },
          { label: 'Âπ≥ÂùáÈÄ≤Êçó', val: avgPct + '%',   cls: 'stat-hours' },
        ];
        summaryEl.innerHTML = chips.map(c =>
          `<span class="stat-chip ${c.cls}">${c.label} <b>${c.val}</b></span>`
        ).join('');
      }
      if (!projects.length) {
        container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:24px 0 16px;font-size:13px;line-height:1.8;">„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ<br>ÈÄ≤Êçó„Éª„Çπ„ÉÜ„Éº„Çø„Çπ„ÉªÊúüÈôê„Çí‰∏ÄÂÖÉÁÆ°ÁêÜ„Åß„Åç„Åæ„Åô</div>';
        return;
      }
      container.innerHTML = projects.map(p => {
        let dlStr = '';
        if (p.deadline) {
          const d = Math.ceil((new Date(p.deadline) - new Date()) / 86400000);
          if      (d > 0)  dlStr = `‚è∞ „ÅÇ„Å®${d}Êó•`;
          else if (d === 0) dlStr = '‚ö†Ô∏è ‰ªäÊó•„ÅåÊúüÈôê';
          else              dlStr = `‚ö†Ô∏è ${-d}Êó•Ë∂ÖÈÅé`;
        }
        return `<div class="project-item" data-id="${p.id}">
          <div class="project-header">
            <div class="project-name">${_esc(p.name)}</div>
            <span class="project-status-badge project-status-${_esc(p.status || 'Êú™ÁùÄÊâã')}">${_esc(p.status || 'Êú™ÁùÄÊâã')}</span>
            <button class="project-del-btn" data-id="${p.id}" title="ÂâäÈô§">üóë</button>
          </div>
          <div class="project-progress-wrap"><div class="project-progress-fill" style="width:${p.progress || 0}%;" id="proj-fill-${p.id}"></div></div>
          <div class="project-footer">
            <span style="font-size:11px;">${dlStr}</span>
            <div style="display:flex;align-items:center;gap:8px;">
              <input type="range" min="0" max="100" value="${p.progress || 0}"
                class="project-progress-range" data-id="${p.id}"
                style="width:80px;accent-color:var(--accent-blue);">
              <span style="font-weight:800;color:var(--text-main);min-width:32px;" id="proj-pct-${p.id}">${p.progress || 0}%</span>
              <select class="project-status-select" data-id="${p.id}"
                style="padding:3px 6px;border-radius:8px;border:1px solid var(--border-soft);font-size:11px;font-family:inherit;">
                ${PROJECT_STATUSES.map(s => `<option${s === (p.status || 'Êú™ÁùÄÊâã') ? ' selected' : ''}>${s}</option>`).join('')}
              </select>
            </div>
          </div>
        </div>`;
      }).join('');

      container.querySelectorAll('.project-progress-range').forEach(range => {
        range.addEventListener('input', () => {
          const id = range.dataset.id, pct = parseInt(range.value);
          const pctEl  = document.getElementById(`proj-pct-${id}`);
          const fillEl = document.getElementById(`proj-fill-${id}`);
          if (pctEl)  pctEl.textContent  = pct + '%';
          if (fillEl) fillEl.style.width = pct + '%';
        });
        range.addEventListener('change', () => {
          const projects = loadProjects(), idx = projects.findIndex(p => p.id === range.dataset.id);
          if (idx !== -1) { projects[idx].progress = parseInt(range.value); saveProjects(projects); }
        });
      });
      container.querySelectorAll('.project-status-select').forEach(sel => {
        sel.addEventListener('change', () => {
          const projects = loadProjects(), idx = projects.findIndex(p => p.id === sel.dataset.id);
          if (idx !== -1) { projects[idx].status = sel.value; saveProjects(projects); renderProjects(); }
        });
      });
      container.querySelectorAll('.project-del-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          if (!confirm('„Åì„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
          saveProjects(loadProjects().filter(p => p.id !== btn.dataset.id));
          renderProjects();
        });
      });
    }

    document.getElementById('btn-add-project')?.addEventListener('click', () => {
      const name = prompt('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç');
      if (!name?.trim()) return;
      const deadline = prompt('ÊúüÈôêÔºàYYYY-MM-DDÂΩ¢Âºè„ÄÅ„Å™„Åë„Çå„Å∞Á©∫Ê¨ÑÔºâ') || '';
      const projects = loadProjects();
      projects.push({ id: Date.now().toString(), name: name.trim(), deadline: deadline.trim(), progress: 0, status: 'Êú™ÁùÄÊâã' });
      saveProjects(projects);
      renderProjects();
      toast('‚úÖ „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü');
    });

    /* =====================================================
       WEATHER FORECAST + OUTFIT RECOMMENDATION
       Open-Meteo API (free, no key, CORS-friendly)
       ===================================================== */
    const WEATHER_CACHE_KEY = '_kintai_weather_cache_v2';
    const WEATHER_CACHE_TTL = 30 * 60 * 1000; // 30ÂàÜ

    const WMO_CODE = {
      0:  { label: 'Âø´Êô¥',              emoji: '‚òÄÔ∏è' },
      1:  { label: '„Åª„ÅºÊô¥„Çå',          emoji: 'üå§' },
      2:  { label: '‰∏ÄÈÉ®Êõá„Çä',          emoji: '‚õÖÔ∏è' },
      3:  { label: 'Êõá„Çä',              emoji: '‚òÅÔ∏è' },
      45: { label: 'Èúß',                emoji: 'üå´' },
      48: { label: 'ÈúßÊ∞∑',              emoji: 'üå´' },
      51: { label: 'ÈúßÈõ®ÔºàÂº±Ôºâ',        emoji: 'üå¶' },
      53: { label: 'ÈúßÈõ®',              emoji: 'üå¶' },
      55: { label: 'ÈúßÈõ®ÔºàÂº∑Ôºâ',        emoji: 'üåß' },
      61: { label: 'Èõ®ÔºàÂº±Ôºâ',          emoji: 'üåß' },
      63: { label: 'Èõ®',                emoji: 'üåß' },
      65: { label: 'Èõ®ÔºàÂº∑Ôºâ',          emoji: 'üåß' },
      71: { label: 'Èõ™ÔºàÂº±Ôºâ',          emoji: 'üå®' },
      73: { label: 'Èõ™',                emoji: '‚ùÑÔ∏è' },
      75: { label: 'Â§ßÈõ™',              emoji: '‚ùÑÔ∏è' },
      77: { label: 'Èõ™Á≤í',              emoji: 'üå®' },
      80: { label: '„Å´„Çè„ÅãÈõ®ÔºàÂº±Ôºâ',    emoji: 'üå¶' },
      81: { label: '„Å´„Çè„ÅãÈõ®',          emoji: 'üåß' },
      82: { label: '„Å´„Çè„ÅãÈõ®ÔºàÂº∑Ôºâ',    emoji: '‚õà' },
      85: { label: '„Å´„Çè„ÅãÈõ™',          emoji: 'üå®' },
      86: { label: '„Å´„Çè„ÅãÈõ™ÔºàÂº∑Ôºâ',    emoji: '‚ùÑÔ∏è' },
      95: { label: 'Èõ∑Èõ®',              emoji: '‚õà' },
      96: { label: 'Èõ∑Èõ®Ôºã„Å≤„Çá„ÅÜ',      emoji: '‚õà' },
      99: { label: 'Èõ∑Èõ®ÔºãÂ§ß„Å≤„Çá„ÅÜ',    emoji: '‚õà' },
    };

    function _wmo(code) {
      return WMO_CODE[code] || { label: '‰∏çÊòé', emoji: '‚ùì' };
    }

    // „Çπ„Çø„Ç§„É´„É©„Éô„É´Ë°®
    const STYLE_LABEL = {
      casual: '„Ç´„Ç∏„É•„Ç¢„É´', business: '„Éì„Ç∏„Éç„Çπ', street: '„Çπ„Éà„É™„Éº„Éà',
      sports: '„Çπ„Éù„Éº„ÉÜ„Ç£', formal: '„Éï„Ç©„Éº„Éû„É´', outdoor: '„Ç¢„Ç¶„Éà„Éâ„Ç¢',
    };
    const COLOR_HINT = {
      basic: '', earth: '„Ç¢„Éº„ÇπÁ≥ª„Ç´„É©„Éº', dark: '„ÉÄ„Éº„ÇØÁ≥ª', bright: '„Ç´„É©„Éï„É´', pastel: '„Éë„Çπ„ÉÜ„É´„Ç´„É©„Éº',
    };

    // AmazonÊ§úÁ¥¢URLÁîüÊàê
    function _amzUrl(query) {
      return `https://www.amazon.co.jp/s?k=${encodeURIComponent(query)}`;
    }

    // outfit item helper: { emoji, label, q } ‚Äî q „ÅØ AmazonÊ§úÁ¥¢„ÇØ„Ç®„É™
    function _item(emoji, label, baseQ, profile) {
      const g = profile.gender || '';
      const c = COLOR_HINT[profile.color] || '';
      return { emoji, label, q: [baseQ, g, c].filter(Boolean).join(' ') };
    }

    function _outfitAdvice(maxTemp, minTemp, weatherCode, windspeed, genderOverride) {
      const cfg    = loadConfig();
      const style  = cfg.styleType   || 'casual';
      const gender = genderOverride || cfg.styleGender || '„É°„É≥„Ç∫';
      const color  = cfg.styleColor  || 'basic';
      const p      = { gender, color };
      const items  = [], warn = [];
      const isRain  = [51,53,55,61,63,65,80,81,82,95,96,99].includes(weatherCode);
      const isSnow  = [71,73,75,77,85,86].includes(weatherCode);
      const isThund = [95,96,99].includes(weatherCode);

      const isF = (gender === '„É¨„Éá„Ç£„Éº„Çπ');
      // ‚îÄ‚îÄ‚îÄ Ê∞óÊ∏© √ó „Çπ„Çø„Ç§„É´Âà•„Éà„ÉÉ„Éó„Çπ„Éª„Éú„Éà„É†„Çπ ‚îÄ‚îÄ‚îÄ
      if (maxTemp >= 30) {
        if (isF) {
          if (style === 'business') {
            items.push(_item('üëó','„É¶„Éã„ÇØ„É≠ „Éé„Éº„Çπ„É™„Éº„Éñ„Éñ„É©„Ç¶„Çπ','UNIQLO „Ç®„Ç¢„É™„Ç∫„É† „Éé„Éº„Çπ„É™„Éº„Éñ „Éñ„É©„Ç¶„Çπ „Éì„Ç∏„Éç„Çπ Â§è',p));
            items.push(_item('üëó','„É¶„Éã„ÇØ„É≠ „Éï„É¨„Ç¢„Çπ„Ç´„Éº„Éà','UNIQLO „Éï„É¨„Ç¢„Çπ„Ç´„Éº„Éà ËñÑÊâã „Å≤„Åñ‰∏à „Éì„Ç∏„Éç„Çπ Â§è',p));
          } else if (style === 'sports') {
            items.push(_item('üèÉ','„Éä„Ç§„Ç≠ „Éâ„É©„Ç§„Éï„Ç£„ÉÉ„Éà „Çø„É≥„ÇØ„Éà„ÉÉ„Éó','NIKE „Éâ„É©„Ç§„Éï„Ç£„ÉÉ„Éà „Çø„É≥„ÇØ„Éà„ÉÉ„Éó „É¨„Éá„Ç£„Éº„Çπ Âê∏Ê±óÈÄü‰πæ',p));
            items.push(_item('ü©≥','„Éä„Ç§„Ç≠ „É©„É≥„Éã„É≥„Ç∞„Ç∑„Éß„Éº„ÉÑ „É¨„Éá„Ç£„Éº„Çπ','NIKE „É¨„Éá„Ç£„Éº„Çπ „É©„É≥„Éã„É≥„Ç∞„Ç∑„Éß„Éº„ÉÑ ÈÄü‰πæ „Ç§„É≥„Éä„Éº‰ªò„Åç',p));
          } else if (style === 'street') {
            items.push(_item('üëï','GU „Ç™„Éº„Éê„Éº„Çµ„Ç§„Ç∫T „É¨„Éá„Ç£„Éº„Çπ','GU „Ç™„Éº„Éê„Éº„Çµ„Ç§„Ç∫ T„Ç∑„É£„ÉÑ „É¨„Éá„Ç£„Éº„Çπ „Çπ„Éà„É™„Éº„Éà',p));
            items.push(_item('ü©≥','GU „Éê„Ç§„Ç´„Éº„Ç∑„Éß„Éº„ÉÑ','GU „Éê„Ç§„Ç´„Éº„Ç∑„Éß„Éº„ÉÑ „É¨„Éá„Ç£„Éº„Çπ Â§è „Çπ„Éà„É™„Éº„Éà',p));
          } else {
            items.push(_item('üëó','„É¶„Éã„ÇØ„É≠ „É™„Éç„É≥„Éñ„É¨„É≥„Éâ„Ç∑„É£„ÉÑ„ÉØ„É≥„Éî„Éº„Çπ','UNIQLO „É™„Éç„É≥ „Ç∑„É£„ÉÑ„ÉØ„É≥„Éî„Éº„Çπ Â§è Ê∂º„Åó„ÅÑ „É¨„Éá„Ç£„Éº„Çπ',p));
            items.push(_item('ü©¥','„É¶„Éã„ÇØ„É≠ „Éï„ÉÉ„Éà„Éô„ÉÉ„Éâ„Çµ„É≥„ÉÄ„É´','UNIQLO „Éï„ÉÉ„Éà„Éô„ÉÉ„Éâ „Çµ„É≥„ÉÄ„É´ „É¨„Éá„Ç£„Éº„Çπ Ê≠©„Åç„ÇÑ„Åô„ÅÑ',p));
          }
        } else {
          if (style === 'business') {
            items.push(_item('üëî','„É¶„Éã„ÇØ„É≠ „Ç®„Ç¢„É™„Ç∫„É†„Éù„É≠„Ç∑„É£„ÉÑ','UNIQLO „Ç®„Ç¢„É™„Ç∫„É† „Éù„É≠„Ç∑„É£„ÉÑ Âê∏Ê±óÈÄü‰πæ „ÇØ„Éº„É´„Éì„Ç∫',p));
            items.push(_item('üëñ','„É¶„Éã„ÇØ„É≠ „Çπ„Éû„Éº„Éà„Ç¢„É≥„ÇØ„É´„Éë„É≥„ÉÑ','UNIQLO „Çπ„Éû„Éº„Éà„Ç¢„É≥„ÇØ„É´„Éë„É≥„ÉÑ Â§è ËªΩÈáè „Çπ„Éà„É¨„ÉÉ„ÉÅ',p));
          } else if (style === 'sports') {
            items.push(_item('üèÉ','„Éä„Ç§„Ç≠ „Éâ„É©„Ç§„Éï„Ç£„ÉÉ„ÉàT„Ç∑„É£„ÉÑ','NIKE „Éâ„É©„Ç§„Éï„Ç£„ÉÉ„Éà ÂçäË¢ñT„Ç∑„É£„ÉÑ Âê∏Ê±óÈÄü‰πæ UPF50',p));
            items.push(_item('ü©≥','„Éä„Ç§„Ç≠ „Éï„É¨„ÉÉ„ÇØ„Çπ„É©„É≥„Ç∑„Éß„Éº„ÉÑ','NIKE „Éï„É¨„ÉÉ„ÇØ„Çπ „É©„É≥„Éã„É≥„Ç∞„Ç∑„Éß„Éº„ÉÑ ÈÄü‰πæ 5„Ç§„É≥„ÉÅ',p));
          } else if (style === 'street') {
            items.push(_item('üëï','„ÉÅ„É£„É≥„Éî„Ç™„É≥ „Ç™„Éº„Éê„Éº„Çµ„Ç§„Ç∫T','Champion „É™„Éê„Éº„Çπ„Ç¶„Ç£„Éº„Éñ T„Ç∑„É£„ÉÑ „Ç™„Éº„Éê„Éº„Çµ„Ç§„Ç∫ „Çπ„Éà„É™„Éº„Éà',p));
            items.push(_item('ü©≥','GU „Ç´„Éº„Ç¥„Ç∑„Éß„Éº„ÉÑ','GU „Ç´„Éº„Ç¥„Ç∑„Éß„Éº„ÉÑ „Éê„ÇÆ„Éº „Çπ„Éà„É™„Éº„Éà „Éè„Éº„Éï„Éë„É≥„ÉÑ',p));
          } else if (style === 'outdoor') {
            items.push(_item('üèï','„Ç≥„É≠„É≥„Éì„Ç¢ „Çµ„É≥„Ç∑„Éº„É´„Éâ„Ç∑„É£„ÉÑ','Columbia „Çµ„É≥„Ç∑„Éº„É´„Éâ Èï∑Ë¢ñ„Ç∑„É£„ÉÑ UPF50 ÈÄü‰πæ „Ç¢„Ç¶„Éà„Éâ„Ç¢',p));
            items.push(_item('ü©≥','„É¢„É≥„Éô„É´ „Éà„É¨„ÉÉ„Ç≠„É≥„Ç∞„Ç∑„Éß„Éº„ÉÑ','mont-bell „Éà„É¨„ÉÉ„Ç≠„É≥„Ç∞„Ç∑„Éß„Éº„ÉÑ ËªΩÈáè ÈÄü‰πæ',p));
          } else {
            items.push(_item('üëï','„É¶„Éã„ÇØ„É≠ „Éâ„É©„Ç§EX T„Ç∑„É£„ÉÑ','UNIQLO „Éâ„É©„Ç§EX ÂçäË¢ñT„Ç∑„É£„ÉÑ Âê∏Ê±óÈÄü‰πæ UV„Ç´„ÉÉ„Éà',p));
            items.push(_item('ü©≥','GU „É™„É©„ÉÉ„ÇØ„Çπ„Ç∑„Éß„Éº„ÉÑ','GU „É™„É©„ÉÉ„ÇØ„Çπ„Éï„Ç£„ÉÉ„Éà „Ç´„Ç∏„É•„Ç¢„É´„Ç∑„Éß„Éº„ÉÑ Á∂ø',p));
          }
        }
        warn.push('ü•µ ÁÜ±‰∏≠ÁóáÊ≥®ÊÑèÔºÅ„Åì„Åæ„ÇÅ„Å™Ê∞¥ÂàÜË£úÁµ¶„Çí');
      } else if (maxTemp >= 25) {
        if (isF) {
          if (style === 'business') {
            items.push(_item('üëî','„É¶„Éã„ÇØ„É≠ ÂçäË¢ñ„Éñ„É©„Ç¶„Çπ','UNIQLO „Éù„Éó„É™„É≥ ÂçäË¢ñ „Éñ„É©„Ç¶„Çπ „Éì„Ç∏„Éç„Çπ „É¨„Éá„Ç£„Éº„Çπ',p));
            items.push(_item('üëó','„É¶„Éã„ÇØ„É≠ „ÉÅ„Éé„Çø„Ç§„Éà„Çπ„Ç´„Éº„Éà','UNIQLO „ÉÅ„Éé „Çø„Ç§„Éà„Çπ„Ç´„Éº„Éà „Å≤„Åñ‰∏à „Éì„Ç∏„Éç„Çπ',p));
          } else if (style === 'sports') {
            items.push(_item('üèÉ','„Ç¢„É≥„ÉÄ„Éº„Ç¢„Éº„Éû„Éº „É¨„Éá„Ç£„Éº„ÇπT„Ç∑„É£„ÉÑ','Under Armour „ÉÜ„ÉÉ„ÇØ T„Ç∑„É£„ÉÑ „É¨„Éá„Ç£„Éº„Çπ ÂçäË¢ñ Âê∏Ê±ó',p));
            items.push(_item('ü©≥','„Ç¢„Éá„Ç£„ÉÄ„Çπ „É¨„ÇÆ„É≥„Çπ„Ç∑„Éß„Éº„ÉÑ','adidas „É¨„ÇÆ„É≥„Çπ „Ç∑„Éß„Éº„ÉÑ „É¨„Éá„Ç£„Éº„Çπ „Çπ„Éù„Éº„ÉÑ',p));
          } else if (style === 'street') {
            items.push(_item('üëï','„Éä„Ç§„Ç≠ „Ç¶„Ç£„É°„É≥„Ç∫T','NIKE „Ç¶„Ç£„É°„É≥„Ç∫ „É´„Éº„Ç∫„Éï„Ç£„ÉÉ„Éà T„Ç∑„É£„ÉÑ „Çπ„Éà„É™„Éº„Éà',p));
            items.push(_item('üëó','GU „Éï„É¨„Ç¢„Éü„Éã„Çπ„Ç´„Éº„Éà','GU „Éï„É¨„Ç¢ „Éü„Éã„Çπ„Ç´„Éº„Éà „É¨„Éá„Ç£„Éº„Çπ „Çπ„Éà„É™„Éº„Éà „Ç´„Ç∏„É•„Ç¢„É´',p));
          } else {
            items.push(_item('üëó','„É¶„Éã„ÇØ„É≠ „Ç≥„ÉÉ„Éà„É≥„É™„Éç„É≥„ÉØ„É≥„Éî„Éº„Çπ','UNIQLO „Ç≥„ÉÉ„Éà„É≥ „É™„Éç„É≥ „Éé„Éº„Çπ„É™„Éº„Éñ„ÉØ„É≥„Éî„Éº„Çπ Â§è',p));
            items.push(_item('ü©¥','GU „ÇØ„É≠„Çπ„Çπ„Éà„É©„ÉÉ„Éó„Çµ„É≥„ÉÄ„É´','GU „ÇØ„É≠„Çπ„Çπ„Éà„É©„ÉÉ„Éó „Çµ„É≥„ÉÄ„É´ „É¨„Éá„Ç£„Éº„Çπ Â§è',p));
          }
        } else {
          if (style === 'business') {
            items.push(_item('üëî','ORIHICA „Éé„Éº„Ç¢„Ç§„É≠„É≥„Ç∑„É£„ÉÑ','ORIHICA „Éé„Éº„Ç¢„Ç§„É≠„É≥ ÂçäË¢ñ„Ç∑„É£„ÉÑ „Éì„Ç∏„Éç„Çπ „Ç§„Éº„Ç∏„Éº„Ç±„Ç¢',p));
            items.push(_item('üëñ','„É¶„Éã„ÇØ„É≠ „Çπ„Éû„Éº„Éà„Çπ„É©„ÉÉ„ÇØ„Çπ','UNIQLO „Çπ„Éû„Éº„Éà„Çπ„É©„ÉÉ„ÇØ„Çπ Â§è „Ç¶„Ç©„ÉÉ„Ç∑„É£„Éñ„É´ „Çπ„Éà„É¨„ÉÉ„ÉÅ',p));
          } else if (style === 'sports') {
            items.push(_item('üèÉ','„Ç¢„É≥„ÉÄ„Éº„Ç¢„Éº„Éû„Éº „Ç≥„É≥„Éó„É¨„ÉÉ„Ç∑„Éß„É≥','Under Armour „Ç≥„É≥„Éó„É¨„ÉÉ„Ç∑„Éß„É≥„Ç∑„É£„ÉÑ ÂçäË¢ñ Âê∏Ê±óÈÄü‰πæ',p));
            items.push(_item('ü©≥','„Éä„Ç§„Ç≠ „Çπ„Éù„Éº„ÉÑ„Éë„É≥„ÉÑ','NIKE „Çπ„Éù„Éº„ÉÑ„Éë„É≥„ÉÑ „Ç§„É≥„Éä„Éº‰ªò„Åç Â§è „É©„É≥„Éã„É≥„Ç∞',p));
          } else if (style === 'street') {
            items.push(_item('üëï','„Éä„Ç§„Ç≠ „É´„Éº„Ç∫„Éï„Ç£„ÉÉ„ÉàT','NIKE „É´„Éº„Ç∫„Éï„Ç£„ÉÉ„Éà T„Ç∑„É£„ÉÑ „Çπ„Éà„É™„Éº„Éà „Éâ„É≠„ÉÉ„Éó„Ç∑„Éß„É´„ÉÄ„Éº',p));
            items.push(_item('üëñ','GU „ÉØ„Ç§„Éâ„Éê„ÇÆ„Éº„Éá„Éã„É†','GU „ÉØ„Ç§„Éâ„Éê„ÇÆ„Éº„Éá„Éã„É† „Çπ„Éà„É™„Éº„Éà „ÇÜ„Å£„Åü„Çä',p));
          } else {
            items.push(_item('üëï','„É¶„Éã„ÇØ„É≠ „Ç≥„ÉÉ„Éà„É≥„É™„É©„ÉÉ„ÇØ„ÇπT','UNIQLO „Ç≥„ÉÉ„Éà„É≥ ÂçäË¢ñT„Ç∑„É£„ÉÑ „É™„É©„ÉÉ„ÇØ„Çπ„Éï„Ç£„ÉÉ„Éà ÁÑ°Âú∞',p));
            items.push(_item('üëñ','„É¶„Éã„ÇØ„É≠ „Çπ„É™„É†„ÉÅ„Éé„Éë„É≥„ÉÑ','UNIQLO „Çπ„É™„É†„Éï„Ç£„ÉÉ„Éà „ÉÅ„Éé„Éë„É≥„ÉÑ ËñÑÊâã „Çπ„Éà„É¨„ÉÉ„ÉÅ',p));
          }
        }
      } else if (maxTemp >= 20) {
        if (isF) {
          if (style === 'business') {
            items.push(_item('üëî','„É¶„Éã„ÇØ„É≠ Èï∑Ë¢ñ„Éñ„É©„Ç¶„Çπ','UNIQLO Èï∑Ë¢ñ „Éñ„É©„Ç¶„Çπ „Éì„Ç∏„Éç„Çπ „É¨„Éá„Ç£„Éº„Çπ „Éù„Éó„É™„É≥',p));
            items.push(_item('üß•','„É¶„Éã„ÇØ„É≠ „ÉÜ„Éº„É©„Éº„Éâ„Ç∏„É£„Ç±„ÉÉ„Éà „É¨„Éá„Ç£„Éº„Çπ','UNIQLO „Çπ„Éà„É¨„ÉÉ„ÉÅ „ÉÜ„Éº„É©„Éº„Éâ„Ç∏„É£„Ç±„ÉÉ„Éà „É¨„Éá„Ç£„Éº„Çπ',p));
            items.push(_item('üëó','„É¶„Éã„ÇØ„É≠ „Éó„É™„Éº„ÉÑ„Éë„É≥„ÉÑ „É¨„Éá„Ç£„Éº„Çπ','UNIQLO „Éó„É™„Éº„ÉÑ „Éë„É≥„ÉÑ „É¨„Éá„Ç£„Éº„Çπ „Éì„Ç∏„Éç„Çπ„Ç´„Ç∏„É•„Ç¢„É´',p));
          } else if (style === 'street') {
            items.push(_item('üëï','„Ç∞„É©„Éü„ÉÅ „Ç¶„Ç£„É°„É≥„Ç∫„É≠„É≥T','Gramicci „É≠„Ç¥ Èï∑Ë¢ñT„Ç∑„É£„ÉÑ „É¨„Éá„Ç£„Éº„Çπ „Ç™„Éº„Éê„Éº„Çµ„Ç§„Ç∫',p));
            items.push(_item('üß•','„É¶„Éã„ÇØ„É≠ „Éá„Éã„É†„Ç∏„É£„Ç±„ÉÉ„Éà „É¨„Éá„Ç£„Éº„Çπ','UNIQLO „Éá„Éã„É†„Ç∏„É£„Ç±„ÉÉ„Éà „É¨„Éá„Ç£„Éº„Çπ „Ç™„Éº„Éê„Éº„Çµ„Ç§„Ç∫',p));
            items.push(_item('üëó','GU „Éû„Éº„É°„Ç§„Éâ„Çπ„Ç´„Éº„Éà','GU „Éû„Éº„É°„Ç§„Éâ„Çπ„Ç´„Éº„Éà „É¨„Éá„Ç£„Éº„Çπ „Çπ„Éà„É™„Éº„Éà',p));
          } else {
            items.push(_item('üëó','„É¶„Éã„ÇØ„É≠ „Éã„ÉÉ„Éà„ÉØ„É≥„Éî„Éº„Çπ','UNIQLO „Éã„ÉÉ„Éà „ÉØ„É≥„Éî„Éº„Çπ „É¨„Éá„Ç£„Éº„Çπ Áßã Êò• ËñÑÊâã',p));
            if (minTemp < 15) items.push(_item('üß•','„É¶„Éã„ÇØ„É≠ „Ç≥„ÉÉ„Éà„É≥„Ç´„Éº„Éá„Ç£„Ç¨„É≥ „É¨„Éá„Ç£„Éº„Çπ','UNIQLO „Ç≥„ÉÉ„Éà„É≥ „Ç´„Éº„Éá„Ç£„Ç¨„É≥ „É¨„Éá„Ç£„Éº„Çπ ËñÑÊâã ÁæΩÁπî„Çä',p));
          }
        } else {
          if (style === 'business') {
            items.push(_item('üëî','„É¶„Éã„ÇØ„É≠ „Ç®„ÇØ„Çπ„Éà„É©„Éï„Ç°„Ç§„É≥„Ç≥„ÉÉ„Éà„É≥„Ç∑„É£„ÉÑ','UNIQLO „Ç®„ÇØ„Çπ„Éà„É©„Éï„Ç°„Ç§„É≥„Ç≥„ÉÉ„Éà„É≥ „Éú„Çø„É≥„ÉÄ„Ç¶„É≥ Èï∑Ë¢ñ',p));
            items.push(_item('üß•','„É¶„Éã„ÇØ„É≠ „Çπ„Éà„É¨„ÉÉ„ÉÅ„Ç∏„É£„Ç±„ÉÉ„Éà','UNIQLO „Çπ„Éà„É¨„ÉÉ„ÉÅ „ÉÜ„Éº„É©„Éº„Éâ„Ç∏„É£„Ç±„ÉÉ„Éà „Éì„Ç∏„Éç„Çπ „Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó',p));
            items.push(_item('üëñ','„É¶„Éã„ÇØ„É≠ „Çπ„É™„É†„Çπ„É©„ÉÉ„ÇØ„Çπ','UNIQLO „Çπ„É™„É†„Éï„Ç£„ÉÉ„Éà „Çπ„É©„ÉÉ„ÇØ„Çπ „Çπ„Éà„É¨„ÉÉ„ÉÅ „Éì„Ç∏„Éç„Çπ',p));
          } else if (style === 'formal') {
            items.push(_item('üé©','ÈùíÂ±± „Çπ„É™„É†„Çπ„Éº„ÉÑ','Ê¥ãÊúç„ÅÆÈùíÂ±± „Çπ„É™„É†„Çπ„Éº„ÉÑ „Ç∏„É£„Ç±„ÉÉ„Éà „Éï„Ç©„Éº„Éû„É´',p));
            items.push(_item('üëî','„É¶„Éã„ÇØ„É≠ ÂΩ¢ÊÖãÂÆâÂÆö„Ç∑„É£„ÉÑ','UNIQLO ÂΩ¢ÊÖãÂÆâÂÆö „Éâ„É¨„Çπ„Ç∑„É£„ÉÑ „Éõ„ÉØ„Ç§„Éà „Éï„Ç©„Éº„Éû„É´',p));
            items.push(_item('üëñ','AOKI„Çπ„É©„ÉÉ„ÇØ„Çπ „Çª„É≥„Çø„Éº„Éó„É¨„Çπ','AOKI „Éï„Ç©„Éº„Éû„É´„Çπ„É©„ÉÉ„ÇØ„Çπ „Çπ„É™„É† „Çª„É≥„Çø„Éº„Éó„É¨„Çπ',p));
          } else if (style === 'street') {
            items.push(_item('üëï','„Ç∞„É©„Éü„ÉÅ „É≠„Ç¥„É≠„É≥T','Gramicci „É≠„Ç¥ Èï∑Ë¢ñT„Ç∑„É£„ÉÑ „Çπ„Éà„É™„Éº„Éà „Ç™„Éº„Éê„Éº„Çµ„Ç§„Ç∫',p));
            items.push(_item('üß•','„Ç™„Éº„Éó„É≥„Ç´„É©„Éº„Ç∑„É£„ÉÑÔºà„Çπ„Éà„É™„Éº„ÉàÔºâ','„Ç™„Éº„Éó„É≥„Ç´„É©„Éº„Ç∑„É£„ÉÑ ÊüÑ„Ç∑„É£„ÉÑ „Ç¢„É≠„Éè „Çπ„Éà„É™„Éº„Éà',p));
            items.push(_item('üëñ','„É™„Éº„Éê„Ç§„Çπ 511 „Çπ„É™„É†„Éá„Éã„É†','Levis 511 „Çπ„É™„É†„Éï„Ç£„ÉÉ„Éà „Çπ„Éà„É¨„ÉÉ„ÉÅ„Éá„Éã„É† „ÉÜ„Éº„Éë„Éº„Éâ',p));
          } else {
            items.push(_item('üëï','„É¶„Éã„ÇØ„É≠ „Éó„É¨„Éü„Ç¢„É†„É™„Éç„É≥„Ç∑„É£„ÉÑ','UNIQLO „Éó„É¨„Éü„Ç¢„É†„É™„Éç„É≥ „Ç∑„É£„ÉÑ Èï∑Ë¢ñ ËñÑÊâã',p));
            if (minTemp < 15) items.push(_item('üß•','„É¶„Éã„ÇØ„É≠ „Ç≥„ÉÉ„Éà„É≥„Ç´„Éº„Éá„Ç£„Ç¨„É≥','UNIQLO „Ç≥„ÉÉ„Éà„É≥ „Ç´„Éº„Éá„Ç£„Ç¨„É≥ ËñÑÊâã ÁæΩÁπî„Çä',p));
            items.push(_item('üëñ','„É¶„Éã„ÇØ„É≠ „ÉÜ„Éº„Éë„Éº„Éâ„Éá„Éã„É†','UNIQLO „ÉÜ„Éº„Éë„Éº„Éâ„Éï„Ç£„ÉÉ„Éà „Éá„Éã„É† „Çπ„Éà„É¨„ÉÉ„ÉÅ',p));
          }
        }
      } else if (maxTemp >= 15) {
        if (isF) {
          if (style === 'business') {
            items.push(_item('üß•','„É¶„Éã„ÇØ„É≠ „Ç¶„Éº„É´„Éñ„É¨„É≥„Éâ„Ç∏„É£„Ç±„ÉÉ„Éà „É¨„Éá„Ç£„Éº„Çπ','UNIQLO „Ç¶„Éº„É´Ê∑∑ „ÉÜ„Éº„É©„Éº„Éâ„Ç∏„É£„Ç±„ÉÉ„Éà „É¨„Éá„Ç£„Éº„Çπ',p));
            items.push(_item('üëî','„É¶„Éã„ÇØ„É≠ ÂΩ¢ÊÖãÂÆâÂÆö„Ç∑„É£„ÉÑ „É¨„Éá„Ç£„Éº„Çπ','UNIQLO ÂΩ¢ÊÖãÂÆâÂÆö „Çπ„Éà„É¨„ÉÉ„ÉÅ „Éì„Ç∏„Éç„Çπ„Ç∑„É£„ÉÑ „É¨„Éá„Ç£„Éº„Çπ',p));
            items.push(_item('üëó','„É¶„Éã„ÇØ„É≠ „Çπ„Éû„Éº„Éà„Ç¢„É≥„ÇØ„É´„Éë„É≥„ÉÑ „É¨„Éá„Ç£„Éº„Çπ','UNIQLO „Çπ„Éû„Éº„Éà„Ç¢„É≥„ÇØ„É´ „Éë„É≥„ÉÑ „É¨„Éá„Ç£„Éº„Çπ „Éì„Ç∏„Éç„Çπ',p));
          } else {
            items.push(_item('üß•','„É¶„Éã„ÇØ„É≠ „Çπ„Ç¶„Ç£„É≥„Ç∞„Ç≥„Éº„Éà','UNIQLO „Çπ„Ç¶„Ç£„É≥„Ç∞ „Ç≥„Éº„Éà „É¨„Éá„Ç£„Éº„Çπ Áßã ËñÑÊâã',p));
            items.push(_item('üëó','„É¶„Éã„ÇØ„É≠ „ÉÅ„Çß„ÉÉ„ÇØ„Éï„É¨„Ç¢„Çπ„Ç´„Éº„Éà','UNIQLO „ÉÅ„Çß„ÉÉ„ÇØ „Éï„É¨„Ç¢„Çπ„Ç´„Éº„Éà „É¨„Éá„Ç£„Éº„Çπ Áßã',p));
            items.push(_item('üß∂','„É¶„Éã„ÇØ„É≠ „É™„Éñ„Éã„ÉÉ„Éà„Çª„Éº„Çø„Éº „É¨„Éá„Ç£„Éº„Çπ','UNIQLO „É™„Éñ „Éã„ÉÉ„Éà„Çª„Éº„Çø„Éº „É¨„Éá„Ç£„Éº„Çπ ËñÑÊâã Áßã',p));
          }
        } else {
          if (style === 'business') {
            items.push(_item('üß•','„É¶„Éã„ÇØ„É≠ „Ç¶„Éº„É´„Éñ„É¨„É≥„Éâ„Ç∏„É£„Ç±„ÉÉ„Éà','UNIQLO „Ç¶„Éº„É´Ê∑∑ „ÉÜ„Éº„É©„Éº„Éâ„Ç∏„É£„Ç±„ÉÉ„Éà „Éì„Ç∏„Éç„Çπ„Ç´„Ç∏„É•„Ç¢„É´',p));
            items.push(_item('üëî','„É¶„Éã„ÇØ„É≠ ÂΩ¢ÊÖãÂÆâÂÆö„Éì„Ç∏„Éç„Çπ„Ç∑„É£„ÉÑ','UNIQLO ÂΩ¢ÊÖãÂÆâÂÆö „Çπ„Éà„É¨„ÉÉ„ÉÅ „Éì„Ç∏„Éç„Çπ„Ç∑„É£„ÉÑ Èï∑Ë¢ñ',p));
            items.push(_item('üëñ','„É¶„Éã„ÇØ„É≠ „Çπ„É™„É†„Çπ„É©„ÉÉ„ÇØ„ÇπÔºàÁßãÂÜ¨Ôºâ','UNIQLO „Çπ„É©„ÉÉ„ÇØ„Çπ „Çπ„É™„É† „Çπ„Éà„É¨„ÉÉ„ÉÅ ÁßãÂÜ¨',p));
          } else if (style === 'outdoor') {
            items.push(_item('üß•','„Éé„Éº„Çπ„Éï„Çß„Ç§„Çπ „Éï„É™„Éº„Çπ„Ç∏„É£„Ç±„ÉÉ„Éà','The North Face „Éï„É™„Éº„Çπ„Ç∏„É£„Ç±„ÉÉ„Éà „Ç¢„Ç¶„Éà„Éâ„Ç¢ ËªΩÈáè ‰øùÊ∏©',p));
            items.push(_item('üëñ','„Ç≥„É≠„É≥„Éì„Ç¢ „Éà„É¨„ÉÉ„Ç≠„É≥„Ç∞„Éë„É≥„ÉÑ','Columbia „Éà„É¨„ÉÉ„Ç≠„É≥„Ç∞„Éë„É≥„ÉÑ „Çπ„Éà„É¨„ÉÉ„ÉÅ Êí•Ê∞¥ Áßã',p));
          } else {
            items.push(_item('üß•','„É¶„Éã„ÇØ„É≠ „É©„Ç§„Éà„Ç¶„Çß„Ç§„Éà„Éñ„É´„Çæ„É≥','UNIQLO „É©„Ç§„Éà„Ç¶„Çß„Ç§„Éà „Ç≥„É≥„Éë„ÇØ„Éà„Ç∏„É£„Ç±„ÉÉ„Éà Áßã ËªΩÈáè',p));
            items.push(_item('üëî','„É¶„Éã„ÇØ„É≠ „Éï„É©„É≥„Éç„É´„ÉÅ„Çß„ÉÉ„ÇØ„Ç∑„É£„ÉÑ','UNIQLO „Éï„É©„É≥„Éç„É´ „ÉÅ„Çß„ÉÉ„ÇØ„Ç∑„É£„ÉÑ Èï∑Ë¢ñ „Ç´„Ç∏„É•„Ç¢„É´',p));
            items.push(_item('üëñ','„É™„Éº„Éê„Ç§„Çπ 512 „ÉÜ„Éº„Éë„Éº„Éâ„Éá„Éã„É†','Levis 512 „Çπ„É™„É†„ÉÜ„Éº„Éë„Éº„Éâ „Éá„Éã„É† „Çπ„Éà„É¨„ÉÉ„ÉÅ',p));
          }
        }
      } else if (maxTemp >= 10) {
        if (isF) {
          if (style === 'business') {
            items.push(_item('üß•','„É¶„Éã„ÇØ„É≠ „Ç¶„Éº„É´„Ç≥„Éº„Éà „É¨„Éá„Ç£„Éº„Çπ','UNIQLO „Ç¶„Éº„É´Ê∑∑ „ÉÅ„Çß„Çπ„Çø„Éº„Ç≥„Éº„Éà „É¨„Éá„Ç£„Éº„Çπ „Éì„Ç∏„Éç„Çπ',p));
            items.push(_item('üß∂','„É¶„Éã„ÇØ„É≠ „É°„É™„Éé„Éã„ÉÉ„Éà „É¨„Éá„Ç£„Éº„Çπ','UNIQLO „É°„É™„Éé„Ç¶„Éº„É´ V„Éç„ÉÉ„ÇØ„Éã„ÉÉ„Éà „É¨„Éá„Ç£„Éº„Çπ',p));
          } else {
            items.push(_item('üß•','„É¶„Éã„ÇØ„É≠ „ÉÄ„Ç¶„É≥„Ç≥„Éº„Éà „É¨„Éá„Ç£„Éº„Çπ','UNIQLO „Ç¶„É´„Éà„É©„É©„Ç§„Éà„ÉÄ„Ç¶„É≥ „Ç≥„Éº„Éà „É¨„Éá„Ç£„Éº„Çπ ËªΩÈáè',p));
            items.push(_item('üß∂','„É¶„Éã„ÇØ„É≠ „Éã„ÉÉ„Éà„Çª„Éº„Çø„Éº „É¨„Éá„Ç£„Éº„Çπ','UNIQLO „Ç¶„Éº„É´Ê∑∑ „Çø„Éº„Éà„É´„Éç„ÉÉ„ÇØ „Çª„Éº„Çø„Éº „É¨„Éá„Ç£„Éº„Çπ',p));
          }
          items.push(_item('üëó','„É¶„Éã„ÇØ„É≠ Ê•µÊöñ„Çπ„Ç≠„Éã„Éº „É¨„Éá„Ç£„Éº„Çπ','UNIQLO „Éí„Éº„Éà„ÉÜ„ÉÉ„ÇØ Ê•µÊöñ „Çπ„Ç≠„Éã„Éº „É¨„Éá„Ç£„Éº„Çπ ‰øùÊ∏©',p));
        } else {
          if (style === 'business') {
            items.push(_item('üß•','„É¶„Éã„ÇØ„É≠ „Ç¶„Éº„É´„Ç≥„Éº„Éà','UNIQLO „Ç¶„Éº„É´Ê∑∑ „Çπ„ÉÜ„É≥„Ç´„É©„Éº„Ç≥„Éº„Éà „Éì„Ç∏„Éç„Çπ ÁßãÂÜ¨',p));
            items.push(_item('üëî','„É¶„Éã„ÇØ„É≠ V„Éç„ÉÉ„ÇØ„Éã„ÉÉ„Éà','UNIQLO „Ç¶„Éº„É´Ê∑∑ V„Éç„ÉÉ„ÇØ„Éã„ÉÉ„Éà „Çª„Éº„Çø„Éº „Éì„Ç∏„Éç„Çπ„Ç´„Ç∏„É•„Ç¢„É´',p));
          } else if (style === 'outdoor') {
            items.push(_item('üß•','„Éé„Éº„Çπ„Éï„Çß„Ç§„Çπ „Éû„Ç¶„É≥„ÉÜ„É≥„Ç∏„É£„Ç±„ÉÉ„Éà','The North Face „Éû„Ç¶„É≥„ÉÜ„É≥„Ç∏„É£„Ç±„ÉÉ„Éà Èò≤Ê∞¥ Èò≤È¢® „Ç¢„Ç¶„Éà„Éâ„Ç¢',p));
            items.push(_item('üß§','„Éñ„É©„ÉÉ„ÇØ„ÉÄ„Ç§„É§„É¢„É≥„Éâ „Ç∞„É≠„Éº„Éñ','Black Diamond „Ç¢„Ç¶„Éà„Éâ„Ç¢„Ç∞„É≠„Éº„Éñ Èò≤ÂØí Èò≤È¢® ‰øùÊ∏©',p));
          } else {
            items.push(_item('üß•','„É¶„Éã„ÇØ„É≠ „Çπ„Ç¶„Çß„ÉÉ„Éà„Éï„É´„Ç∏„ÉÉ„Éó„Éë„Éº„Ç´','UNIQLO „Çπ„Ç¶„Çß„ÉÉ„Éà „Éï„É´„Ç∏„ÉÉ„Éó„Éë„Éº„Ç´ Ë£èËµ∑ÊØõ „Éó„É´„Ç™„Éº„Éê„Éº',p));
            items.push(_item('üëï','„É¶„Éã„ÇØ„É≠ „ÇØ„É´„Éº„Éç„ÉÉ„ÇØ„Çª„Éº„Çø„Éº','UNIQLO „Ç¶„Éº„É´Ê∑∑ „ÇØ„É´„Éº„Éç„ÉÉ„ÇØ„Çª„Éº„Çø„Éº ËñÑÊâã ÁßãÂÜ¨',p));
          }
          items.push(_item('üëñ','„É¶„Éã„ÇØ„É≠ Ë£èËµ∑ÊØõ„Çπ„Éà„É¨„ÉÉ„ÉÅ„Éë„É≥„ÉÑ','UNIQLO Êöñ„Éë„É≥ Ë£èËµ∑ÊØõ „Çπ„Éà„É¨„ÉÉ„ÉÅ „Çπ„Ç≠„Éã„Éº ‰øùÊ∏©',p));
        }
      } else if (maxTemp >= 5) {
        if (isF) {
          items.push(_item('üß•','„É¶„Éã„ÇØ„É≠ „Ç¶„É´„Éà„É©„É©„Ç§„Éà„ÉÄ„Ç¶„É≥„É≠„É≥„Ç∞„Ç≥„Éº„Éà „É¨„Éá„Ç£„Éº„Çπ','UNIQLO „Ç¶„É´„Éà„É©„É©„Ç§„Éà„ÉÄ„Ç¶„É≥ „É≠„É≥„Ç∞„Ç≥„Éº„Éà „É¨„Éá„Ç£„Éº„Çπ Èò≤ÂØí',p));
          items.push(_item('üß£','GU „Ç¶„Éº„É´„É©„Ç§„ÇØ„Éû„Éï„É©„Éº „É¨„Éá„Ç£„Éº„Çπ','GU „Ç¶„Éº„É´„É©„Ç§„ÇØ „Éû„Éï„É©„Éº „É¨„Éá„Ç£„Éº„Çπ Èò≤ÂØí ÂÜ¨',p));
          items.push(_item('üëó','„É¶„Éã„ÇØ„É≠ Ê•µÊöñ„Éí„Éº„Éà„ÉÜ„ÉÉ„ÇØ„É¨„ÇÆ„É≥„Çπ','UNIQLO Ê•µÊöñ „Éí„Éº„Éà„ÉÜ„ÉÉ„ÇØ „É¨„ÇÆ„É≥„Çπ „É¨„Éá„Ç£„Éº„Çπ ÂÜ¨ Èò≤ÂØí',p));
        } else {
          items.push(_item('üß•','„É¶„Éã„ÇØ„É≠ „Ç¶„É´„Éà„É©„É©„Ç§„Éà„ÉÄ„Ç¶„É≥„É≠„É≥„Ç∞„Ç≥„Éº„Éà','UNIQLO „Ç¶„É´„Éà„É©„É©„Ç§„Éà„ÉÄ„Ç¶„É≥ „É≠„É≥„Ç∞„Ç≥„Éº„Éà Èò≤ÂØí ËªΩÈáè',p));
          items.push(_item('üß£','GU „É™„Éñ„Éã„ÉÉ„Éà„Éû„Éï„É©„Éº','GU „É™„Éñ„Éã„ÉÉ„Éà „Éû„Éï„É©„Éº Èò≤ÂØí „É≠„É≥„Ç∞ ÂÜ¨',p));
          items.push(_item('üëñ','„É¶„Éã„ÇØ„É≠ Êöñ„Éë„É≥ „ÉÜ„Éº„Éë„Éº„Éâ','UNIQLO Êöñ„Éë„É≥ „Ç¶„Ç©„Éº„É†EX „ÉÜ„Éº„Éë„Éº„Éâ Èò≤ÂØí ÂÜ¨',p));
        }
      } else {
        if (isF) {
          items.push(_item('üß•','„É¶„Éã„ÇØ„É≠ „Ç¶„É´„Éà„É©„É©„Ç§„Éà„ÉÄ„Ç¶„É≥„Éë„Éº„Ç´ „É¨„Éá„Ç£„Éº„Çπ','UNIQLO „Ç¶„É´„Éà„É©„É©„Ç§„Éà„ÉÄ„Ç¶„É≥ „Éë„Éº„Ç´ „É¨„Éá„Ç£„Éº„Çπ Ê•µÊöñ Èò≤È¢®',p));
          items.push(_item('üß£','„É¶„Éã„ÇØ„É≠ „Éï„É™„Éº„Çπ„Éû„Éï„É©„Éº „É¨„Éá„Ç£„Éº„Çπ','UNIQLO „Éï„É™„Éº„Çπ „Éû„Éï„É©„Éº ÊâãË¢ã „Çª„ÉÉ„Éà „É¨„Éá„Ç£„Éº„Çπ Ê•µÊöñ',p));
          items.push(_item('üëó','„É¶„Éã„ÇØ„É≠ Ê•µÊöñ„Éí„Éº„Éà„ÉÜ„ÉÉ„ÇØ„É¨„ÇÆ„É≥„Çπ„Éë„É≥„ÉÑ','UNIQLO Ê•µÊöñ „Éí„Éº„Éà„ÉÜ„ÉÉ„ÇØ „É¨„ÇÆ„É≥„Çπ„Éë„É≥„ÉÑ „É¨„Éá„Ç£„Éº„Çπ ÂéöÊâã',p));
        } else {
          items.push(_item('üß•','„É¶„Éã„ÇØ„É≠ „Ç¶„É´„Éà„É©„É©„Ç§„Éà„ÉÄ„Ç¶„É≥„Éë„Éº„Ç´','UNIQLO „Ç¶„É´„Éà„É©„É©„Ç§„Éà„ÉÄ„Ç¶„É≥ „Éë„Éº„Ç´ Ê•µÊöñ Èò≤È¢® Êí•Ê∞¥',p));
          items.push(_item('üß£','„É¶„Éã„ÇØ„É≠ „Éï„É™„Éº„Çπ„Éû„Éï„É©„ÉºÔºÜÊâãË¢ã„Çª„ÉÉ„Éà','UNIQLO „Éï„É™„Éº„Çπ „Éû„Éï„É©„Éº ÊâãË¢ã „Çª„ÉÉ„Éà Ê•µÊöñ Èò≤ÂØí',p));
          items.push(_item('üëñ','„É¶„Éã„ÇØ„É≠ Ê•µÊöñ„Éí„Éº„Éà„ÉÜ„ÉÉ„ÇØ„Éë„É≥„ÉÑ','UNIQLO Ê•µÊöñ „Éí„Éº„Éà„ÉÜ„ÉÉ„ÇØ „ÉÜ„Éº„Éë„Éº„Éâ„Éë„É≥„ÉÑ ÂÜ¨',p));
        }
        warn.push('ü•∂ Èò≤ÂØíÂØæÁ≠ñ„Çí‰∏áÂÖ®„Å´ÔºÅ');
      }

      // ‚îÄ‚îÄ‚îÄ „Ç∑„É•„Éº„Ç∫ ‚îÄ‚îÄ‚îÄ
      const hasShoe = items.some(it => ['üëü','üëû','ü•æ','ü©¥','üë†','ü•ø'].includes(it.emoji));
      if (!hasShoe) {
        if (isF) {
          if (style === 'business' || style === 'formal')
            items.push(_item('üë†','„É¶„Éã„ÇØ„É≠ „Éê„É¨„Ç®„Ç∑„É•„Éº„Ç∫','UNIQLO „Éê„É¨„Ç®„Ç∑„É•„Éº„Ç∫ „É¨„Éá„Ç£„Éº„Çπ „Éì„Ç∏„Éç„Çπ „Éï„É©„ÉÉ„Éà Êú¨Èù©',p));
          else if (style === 'sports')
            items.push(_item('üëü','„Éä„Ç§„Ç≠ „Éï„É™„Éº„É©„É≥ „É¨„Éá„Ç£„Éº„Çπ','NIKE Free Run „É¨„Éá„Ç£„Éº„Çπ „É©„É≥„Éã„É≥„Ç∞„Ç∑„É•„Éº„Ç∫ ËªΩÈáè',p));
          else if (style === 'outdoor')
            items.push(_item('ü•æ','„Çµ„É≠„É¢„É≥ „Éè„Ç§„Ç≠„É≥„Ç∞„Ç∑„É•„Éº„Ç∫ „É¨„Éá„Ç£„Éº„Çπ','Salomon XA PRO „Ç¥„Ç¢„ÉÜ„ÉÉ„ÇØ„Çπ „É¨„Éá„Ç£„Éº„Çπ „Éè„Ç§„Ç≠„É≥„Ç∞',p));
          else
            items.push(_item('üëü','„Ç≥„É≥„Éê„Éº„Çπ „Ç™„Éº„É´„Çπ„Çø„Éº „É¨„Éá„Ç£„Éº„Çπ','Converse All Star „É¨„Éá„Ç£„Éº„Çπ „É≠„Éº„Ç´„ÉÉ„Éà „Ç≠„É£„É≥„Éê„Çπ',p));
        } else {
          if (style === 'business' || style === 'formal')
            items.push(_item('üëû','„Çπ„Ç≥„ÉÉ„ÉÅ„Ç∞„É¨„Ç§„É≥ „Éó„É¨„Éº„É≥„Éà„Ç•','„Çπ„Ç≥„ÉÉ„ÉÅ„Ç∞„É¨„Ç§„É≥ „Éì„Ç∏„Éç„Çπ„Ç∑„É•„Éº„Ç∫ „Éó„É¨„Éº„É≥„Éà„Ç• Êú¨Èù© ÂõΩÁî£',p));
          else if (style === 'sports')
            items.push(_item('üëü','„Éä„Ç§„Ç≠ „Éö„Ç¨„Çµ„Çπ „É©„É≥„Ç∑„É•„Éº„Ç∫','NIKE „Éö„Ç¨„Çµ„Çπ „É©„É≥„Éã„É≥„Ç∞„Ç∑„É•„Éº„Ç∫ „ÇØ„ÉÉ„Ç∑„Éß„É≥ ËªΩÈáè',p));
          else if (style === 'outdoor')
            items.push(_item('ü•æ','„Çµ„É≠„É¢„É≥ „Éè„Ç§„Ç≠„É≥„Ç∞„Éñ„Éº„ÉÑ','Salomon X-ULTRA „Ç¥„Ç¢„ÉÜ„ÉÉ„ÇØ„Çπ „Éè„Ç§„Ç≠„É≥„Ç∞„Éñ„Éº„ÉÑ Èò≤Ê∞¥',p));
          else
            items.push(_item('üëü','„Ç≥„É≥„Éê„Éº„Çπ „Ç™„Éº„É´„Çπ„Çø„Éº','Converse Chuck Taylor All Star „É≠„Éº„Ç´„ÉÉ„Éà „Ç≠„É£„É≥„Éê„Çπ ÂÆöÁï™',p));
        }
      }

      // ‚îÄ‚îÄ‚îÄ Èõ®Èõ™ ‚îÄ‚îÄ‚îÄ
      if (isRain) {
        items.push(_item('‚òÇÔ∏è','„É¶„Éã„ÇØ„É≠ „Ç≥„É≥„Éë„ÇØ„Éà„Ç¢„É≥„Éñ„É¨„É©','UNIQLO „Ç≥„É≥„Éë„ÇØ„Éà Êäò„Çä„Åü„Åü„ÅøÂÇò ËªΩÈáè Êô¥Èõ®ÂÖºÁî® Ëá™ÂãïÈñãÈñâ',p));
        items.push(_item('ü•ø','„Ç¢„Ç∑„ÉÉ„ÇØ„Çπ „Éö„ÉÄ„É© Èò≤Ê∞¥„Ç∑„É•„Éº„Ç∫','ASICS „Éö„ÉÄ„É© Èò≤Ê∞¥ „Ç¶„Ç©„Éº„Ç≠„É≥„Ç∞„Ç∑„É•„Éº„Ç∫ Èõ® Âø´ÈÅ©',p));
      }
      if (isSnow) {
        items.push(_item('ü•æ','„ÇΩ„É¨„É´ „Ç´„É™„Éñ„Éº „Çπ„Éé„Éº„Éñ„Éº„ÉÑ','Sorel Caribou „Çπ„Éé„Éº„Éñ„Éº„ÉÑ Èò≤Ê∞¥ Èò≤Êªë Èõ™ÈÅì ÂÜ¨',p));
        warn.push('‚ö†Ô∏è Ë∑ØÈù¢ÂáçÁµê„Å´Ê≥®ÊÑè');
      }
      if (isThund) warn.push('‚õà Èõ∑Èõ®„ÅÆÊÅê„Çå ‚Äî Â§ñÂá∫Ê≥®ÊÑè');
      // ‚îÄ‚îÄ‚îÄ È¢®„ÉªUV ‚îÄ‚îÄ‚îÄ
      if (windspeed >= 30) {
        items.push(_item('üß¢','„Éä„Ç§„Ç≠ „Ç®„Ç¢„É≠„Éì„É´„Ç≠„É£„ÉÉ„Éó','NIKE „Ç®„Ç¢„É≠„Éì„É´ „Ç≠„É£„ÉÉ„Éó Â∏ΩÂ≠ê „Çπ„Éà„É©„ÉÉ„Éó È£õ„Å∞„Åï„Çå„Å™„ÅÑ',p));
        warn.push('üí® Âº∑È¢®Ê≥®ÊÑèÔºà„Çπ„Ç´„Éº„ÉàÊ≥®ÊÑèÔºâ');
      } else if (windspeed >= 20) {
        warn.push('üí® È¢®„ÅåÂº∑„ÇÅ„Åß„Åô');
      }
      if (maxTemp >= 22 && !isRain)
        items.push(_item('üß¥','„Ç¢„Éç„ÉÉ„Çµ „Éë„Éº„Éï„Çß„ÇØ„ÉàUV','ANESSA „Éë„Éº„Éï„Çß„ÇØ„ÉàUV „Çπ„Ç≠„É≥„Ç±„Ç¢„Éü„É´„ÇØ SPF50+ PA++++',p));

      return { items, warn, style, maxT: maxTemp, minT: minTemp, weatherCode, windspeed };
    }

    function _loadWeatherCache() {
      try {
        const r = localStorage.getItem(WEATHER_CACHE_KEY);
        if (!r) return null;
        const d = JSON.parse(r);
        if (!d.ts || Date.now() - d.ts > WEATHER_CACHE_TTL) return null;
        return d.data;
      } catch { return null; }
    }
    function _saveWeatherCache(data) {
      try { localStorage.setItem(WEATHER_CACHE_KEY, JSON.stringify({ ts: Date.now(), data })); } catch(_) {}
    }

    async function _fetchWeatherByCoords(lat, lon) {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
        `&daily=weathercode,temperature_2m_max,temperature_2m_min,windspeed_10m_max,precipitation_probability_max` +
        `&hourly=temperature_2m,apparent_temperature,weathercode,precipitation_probability,windspeed_10m` +
        `&current_weather=true&timezone=Asia%2FTokyo&forecast_days=7`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    async function _geocodeCity(city) {
      const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=ja&format=json`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const d = await res.json();
      if (!d.results?.length) throw new Error(`„Äå${city}„Äç„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì`);
      return { lat: d.results[0].latitude, lon: d.results[0].longitude, name: d.results[0].name };
    }

    function _getGPSCoords() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) { reject(new Error('GPSÈùûÂØæÂøú')); return; }
        navigator.geolocation.getCurrentPosition(
          p => resolve({ lat: p.coords.latitude, lon: p.coords.longitude, name: 'ÁèæÂú®Âú∞' }),
          () => reject(new Error('GPSÂèñÂæóÂ§±Êïó ‚Äî Ë®≠ÂÆö„ÅßÈÉΩÂ∏ÇÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ')),
          { timeout: 8000 }
        );
      });
    }

    async function _fetchWeatherData() {
      const city = loadConfig().city || '';
      const coords = city ? await _geocodeCity(city) : await _getGPSCoords();
      const raw = await _fetchWeatherByCoords(coords.lat, coords.lon);
      return { raw, locationName: coords.name };
    }


    // „Ç≥„Éº„Éá„Ç≠„É£„ÉÉ„Ç∑„É•ÔºàÂêåÊù°‰ª∂„ÅÆÂÜç„É¨„É≥„ÉÄ„É™„É≥„Ç∞Èò≤Ê≠¢Ôºâ
    let _outfitBoardCache = { key: null, html: null };

    // Êúç„ÅÆ„Ç´„É©„Éº„Éë„É¨„ÉÉ„ÉàÔºàstyleColor„Å´ÂØæÂøúÔºâ
    const _CLOTH_PAL = {
      basic:  { top:'#eceff1', btm:'#546e7a', out:'#37474f', sho:'#212121', sca:'#b0bec5', acc:'#90a4ae' },
      earth:  { top:'#efebe9', btm:'#a1887f', out:'#6d4c41', sho:'#3e2723', sca:'#d7ccc8', acc:'#bcaaa4' },
      dark:   { top:'#78909c', btm:'#263238', out:'#102027', sho:'#000a12', sca:'#455a64', acc:'#546e7a' },
      bright: { top:'#f06292', btm:'#4fc3f7', out:'#ba68c8', sho:'#ff7043', sca:'#fff176', acc:'#80cbc4' },
      pastel: { top:'#f8bbd0', btm:'#b3e5fc', out:'#c8e6c9', sho:'#ffccbc', sca:'#e1bee7', acc:'#f0f4c3' },
    };

    // „Éï„Ç°„ÉÉ„Ç∑„Éß„É≥„Ç§„É©„Çπ„ÉàÈ¢®„Ç¢„Éê„Çø„ÉºSVG„ÇíÁîüÊàêÔºà„Çπ„Çø„Ç§„É™„ÉÉ„Ç∑„É• 8È†≠Ë∫´Ôºâ
    function _buildMannequinSVG(items, colorKey) {
      const p = _CLOTH_PAL[colorKey] || _CLOTH_PAL.basic;
      const has = emoji => items.some(it => emoji.includes(it.emoji));
      const hasHat   = has(['üß¢','üé©','üëí']);
      const hasScarf = has(['üß£']);
      const hasOuter = has(['üß•']);
      const hasTop   = has(['üëî','üëï','üèÉ','üèï','üé©']);
      const hasBot   = has(['üëñ','ü©≥']);
      const hasShoe  = has(['üëü','üëû','ü•æ','ü•ø']);
      const hasAcc   = has(['üß§']);
      const sleeveC  = hasOuter ? p.out : (hasTop ? p.top : null);
      const u = Math.random().toString(36).slice(2,7);

      return `<svg class="vp-svg" viewBox="0 0 100 240" xmlns="http://www.w3.org/2000/svg">
<defs>
  <linearGradient id="sk${u}" x1="30%" y1="0%" x2="70%" y2="100%">
    <stop offset="0%" stop-color="#FDDBB4"/><stop offset="100%" stop-color="#F0B880"/>
  </linearGradient>
  <linearGradient id="lg${u}" x1="0%" y1="0%" x2="100%" y2="100%">
    <stop offset="0%" stop-color="#F5C498"/><stop offset="100%" stop-color="#E0A070"/>
  </linearGradient>
</defs>
<ellipse cx="50" cy="236" rx="20" ry="3.5" fill="rgba(0,0,0,0.10)"/>
<!-- HAIR -->
<path d="M36.5 13 Q36 1 50 0 Q64 1 63.5 13 Q66 8 65 20 Q64 30 62 36 Q56 40 50 40 Q44 40 38 36 Q36 30 35 20 Q34 8 36.5 13 Z" fill="#1c1410"/>
<path d="M37 15 Q32 24 34 36 Q36 42 38 44 Q36 38 37 28 Q37 18 38 14 Z" fill="#221810"/>
<path d="M63 15 Q68 24 66 36 Q64 42 62 44 Q64 38 63 28 Q63 18 62 14 Z" fill="#221810"/>
<path d="M41 2 Q50 0 59 2" stroke="rgba(255,255,255,0.18)" stroke-width="1.8" fill="none" stroke-linecap="round"/>
<!-- FACE -->
<ellipse cx="50" cy="16" rx="12.5" ry="14.5" fill="url(#sk${u})"/>
<path d="M40 19 Q40 29 44 32 Q47 34 50 34 Q53 34 56 32 Q60 29 60 19" fill="url(#sk${u})"/>
<ellipse cx="37.8" cy="18" rx="2.8" ry="4" fill="#FDCBA0"/>
<ellipse cx="62.2" cy="18" rx="2.8" ry="4" fill="#FDCBA0"/>
<ellipse cx="37.8" cy="18" rx="1.5" ry="2.4" fill="#E8A878"/>
<ellipse cx="62.2" cy="18" rx="1.5" ry="2.4" fill="#E8A878"/>
<!-- Eyebrows ‚Äî thin arched -->
<path d="M39.5 10.5 Q42.5 8.5 46.5 10.5" stroke="#221810" stroke-width="1.3" fill="none" stroke-linecap="round"/>
<path d="M53.5 10.5 Q57.5 8.5 60.5 10.5" stroke="#221810" stroke-width="1.3" fill="none" stroke-linecap="round"/>
<!-- Eyes ‚Äî almond/cat-eye -->
<path d="M38.5 16 Q42.5 12.5 46.5 16 Q42.5 20 38.5 16 Z" fill="white"/>
<ellipse cx="42.5" cy="16.2" rx="2" ry="2.5" fill="#2a1a10"/>
<circle cx="41.6" cy="15.3" r="0.75" fill="rgba(255,255,255,0.90)"/>
<path d="M38.5 16 Q42.5 12.5 46.5 16" stroke="#1c1410" stroke-width="1.5" fill="none" stroke-linecap="round"/>
<path d="M53.5 16 Q57.5 12.5 61.5 16 Q57.5 20 53.5 16 Z" fill="white"/>
<ellipse cx="57.5" cy="16.2" rx="2" ry="2.5" fill="#2a1a10"/>
<circle cx="56.6" cy="15.3" r="0.75" fill="rgba(255,255,255,0.90)"/>
<path d="M53.5 16 Q57.5 12.5 61.5 16" stroke="#1c1410" stroke-width="1.5" fill="none" stroke-linecap="round"/>
<!-- Nose subtle -->
<path d="M48.5 23 Q50 25 51.5 23" stroke="#C08862" stroke-width="0.9" fill="none" stroke-linecap="round"/>
<!-- Lips -->
<path d="M45.5 28.5 Q47.5 31 50 30.5 Q52.5 31 54.5 28.5" stroke="#B84848" stroke-width="1.6" fill="none" stroke-linecap="round"/>
<path d="M45.5 28.5 Q50 27 54.5 28.5" stroke="#D46060" stroke-width="0.9" fill="none" stroke-linecap="round"/>
<ellipse cx="37" cy="23" rx="4" ry="2.2" fill="rgba(255,110,100,0.16)"/>
<ellipse cx="63" cy="23" rx="4" ry="2.2" fill="rgba(255,110,100,0.16)"/>
<!-- NECK -->
<path d="M45.5 33 L44.5 44 L55.5 44 L54.5 33" fill="#FDCBA0"/>
<path d="M45.5 33 L45 39 L50 38.5 L50 33 Z" fill="rgba(0,0,0,0.05)"/>
<!-- ARMS skin -->
<path d="M19 54 C 11 70 9 107 11 128 C 12 135 15.5 138 20 136 C 23 135 24 128 24 122 L24 54 Z" fill="#FDCBA0"/>
<path d="M81 54 C 89 70 91 107 89 128 C 88 135 84.5 138 80 136 C 77 135 76 128 76 122 L76 54 Z" fill="#FDCBA0"/>
<ellipse cx="15" cy="138" rx="6" ry="7.5" fill="#FDCBA0"/>
<ellipse cx="85" cy="138" rx="6" ry="7.5" fill="#FDCBA0"/>
<path d="M10 135.5 Q15 133 20 135.5" stroke="rgba(0,0,0,0.08)" stroke-width="0.8" fill="none"/>
<path d="M80 135.5 Q85 133 90 135.5" stroke="rgba(0,0,0,0.08)" stroke-width="0.8" fill="none"/>
<!-- TORSO skin -->
<path d="M24 53 Q22 51 50 47 Q78 51 76 53 L74 126 Q72 138 50 139 Q28 138 26 126 Z" fill="#FDCBA0"/>
<path d="M26 126 Q24 137 28 143 Q40 152 50 152 Q60 152 72 143 Q76 137 74 126 Q60 139 50 139 Q40 139 26 126 Z" fill="#E8A870"/>
<!-- LEGS skin -->
<path d="M28 143 C 26 165 26 196 28 218 C 29 227 34 230 40 229 C 45 228 47 220 47 213 L47 143 Z" fill="url(#lg${u})"/>
<path d="M72 143 C 74 165 74 196 72 218 C 71 227 66 230 60 229 C 55 228 53 220 53 213 L53 143 Z" fill="url(#lg${u})"/>
<ellipse cx="37" cy="180" rx="6.5" ry="4" fill="rgba(255,255,255,0.14)"/>
<ellipse cx="63" cy="180" rx="6.5" ry="4" fill="rgba(255,255,255,0.14)"/>
<path d="M28 143 L31 143 L31 218 L28 217 Z" fill="rgba(0,0,0,0.055)"/>
<path d="M72 143 L69 143 L69 218 L72 217 Z" fill="rgba(0,0,0,0.055)"/>
<!-- Bare feet -->
<path d="M24 218 Q18 225 19 230 Q29 235 42 230 Q49 226 48 218 L40 217 Z" fill="#C88A68"/>
<path d="M76 218 Q82 225 81 230 Q71 235 58 230 Q51 226 52 218 L60 217 Z" fill="#C88A68"/>
<!-- CLOTHING LAYERS -->
${hasBot ? `<path d="M26 137 Q24 147 28 155 Q40 164 50 164 Q60 164 72 155 Q76 147 74 137 Q60 149 50 151 Q40 149 26 137 Z" fill="${p.btm}"/>
<path d="M28 155 L40 155 L40 219 L32 222 Q24 222 22 218 Z" fill="${p.btm}"/>
<path d="M72 155 L60 155 L60 219 L68 222 Q76 222 78 218 Z" fill="${p.btm}"/>
<line x1="50" y1="155" x2="50" y2="219" stroke="rgba(0,0,0,0.09)" stroke-width="0.9"/>
<path d="M28 155 L32 155 L32 219 L28 218 Z" fill="rgba(0,0,0,0.07)"/>
<path d="M72 155 L68 155 L68 219 L72 218 Z" fill="rgba(0,0,0,0.07)"/>
<path d="M39 157 L40 155 L40 215 L39 217 Z" fill="rgba(255,255,255,0.12)"/>
<path d="M61 157 L60 155 L60 215 L61 217 Z" fill="rgba(255,255,255,0.12)"/>` : ''}
${sleeveC ? `<path d="M19 56 C 11 72 9 107 11 128 C 12 134 15 137 19 136 L24 136 C 24 126 24 106 24 56 Z" fill="${sleeveC}"/>
<path d="M81 56 C 89 72 91 107 89 128 C 88 134 85 137 81 136 L76 136 C 76 126 76 106 76 56 Z" fill="${sleeveC}"/>
<path d="M20 57 C 12 72 10 106 12 126 L17 136 C 11 135 11.5 133 11 128 C 9 107 11 72 19 56 Z" fill="rgba(0,0,0,0.08)"/>
<path d="M80 57 C 88 72 90 106 88 126 L83 136 C 89 135 88.5 133 89 128 C 91 107 89 72 81 56 Z" fill="rgba(0,0,0,0.08)"/>` : ''}
${hasTop ? `<path d="M24 54 Q22 52 50 48 Q78 52 76 54 L74 131 Q72 140 50 141 Q28 140 26 131 Z" fill="${p.top}"/>
<path d="M50 48 L50 141 Q62 141 70 136 L74 131 L76 54 Q63 52 50 48 Z" fill="rgba(0,0,0,0.055)"/>
<path d="M44 48 Q50 45 56 48 L54 54 Q50 52 46 54 Z" fill="rgba(0,0,0,0.075)"/>
<path d="M46 54 Q50 58 54 54" stroke="rgba(0,0,0,0.14)" stroke-width="0.9" fill="none"/>
<path d="M27 57 L26 131 Q26 136 28 138 L24 131 L24 54 Z" fill="rgba(255,255,255,0.09)"/>` : ''}
${hasOuter ? `<path d="M15 51 Q13 49 50 45 Q87 49 85 51 L82 126 Q80 136 50 137 Q20 136 18 126 Z" fill="${p.out}"/>
<path d="M50 45 L50 137 Q64 137 72 131 L82 126 L85 51 Q68 49 50 45 Z" fill="rgba(0,0,0,0.07)"/>
<path d="M48 45 L43 58 Q47 58 50 62 Q53 58 57 58 L52 45 Z" fill="rgba(0,0,0,0.09)"/>
<line x1="50" y1="62" x2="50" y2="137" stroke="rgba(0,0,0,0.08)" stroke-width="0.85"/>
<circle cx="50" cy="80" r="1.3" fill="rgba(0,0,0,0.18)"/>
<circle cx="50" cy="98" r="1.3" fill="rgba(0,0,0,0.18)"/>
<circle cx="50" cy="116" r="1.3" fill="rgba(0,0,0,0.18)"/>
<path d="M20 54 L18 126 Q18 130 20 132 L15 51 Z" fill="rgba(255,255,255,0.11)"/>` : ''}
${hasScarf ? `<path d="M36 40 Q50 35 64 40 Q66 47 64 50 Q50 46 36 50 Q34 47 36 40 Z" fill="${p.sca}"/>
<path d="M44 50 L43 67 Q43 70 46 70 L50 70 Q50 70 50 67 L50 50 Z" fill="${p.sca}"/>
<path d="M36 42 Q50 37 64 42" stroke="rgba(255,255,255,0.26)" stroke-width="1.1" fill="none"/>
<path d="M36 47 Q50 43 64 47" stroke="rgba(0,0,0,0.08)" stroke-width="0.8" fill="none"/>` : ''}
${hasHat ? `<ellipse cx="50" cy="5" rx="23" ry="6" fill="${p.out}"/>
<path d="M34 5 Q37 -5 50 -7 Q63 -5 66 5 Z" fill="${p.out}"/>
<path d="M36 4.5 Q50 1 64 4.5" stroke="rgba(255,255,255,0.30)" stroke-width="1.5" fill="none"/>
<path d="M34 5 Q37 -5 50 -7 Q56 -4 58 3 Q52 5 50 5 Q42 5 40 5 Z" fill="rgba(0,0,0,0.11)"/>` : ''}
${hasAcc ? `<ellipse cx="15" cy="138" rx="6.5" ry="8" fill="${p.acc}"/>
<ellipse cx="85" cy="138" rx="6.5" ry="8" fill="${p.acc}"/>
<path d="M9.5 135 Q15 132 20.5 135" stroke="rgba(255,255,255,0.26)" stroke-width="0.9" fill="none"/>
<path d="M79.5 135 Q85 132 90.5 135" stroke="rgba(255,255,255,0.26)" stroke-width="0.9" fill="none"/>` : ''}
${hasShoe ? `<path d="M24 218 Q18 226 19 230 Q30 235 43 230 Q49 226 48 219 L40 217 Z" fill="${p.sho}"/>
<path d="M76 218 Q82 226 81 230 Q70 235 57 230 Q51 226 52 219 L60 217 Z" fill="${p.sho}"/>
<path d="M24 218 Q19 224 19 228 Q30 230 43 226 L48 219 Q40 222 27 221 Q19 220 24 218 Z" fill="rgba(255,255,255,0.16)"/>
<path d="M76 218 Q81 224 81 228 Q70 230 57 226 L52 219 Q60 222 73 221 Q81 220 76 218 Z" fill="rgba(255,255,255,0.16)"/>` : ''}
</svg>`;
    }

    // „Ç≥„Éº„Éá„Ç¢„Ç§„ÉÜ„É†„ÅÆÁêÜÁî±„ÉÜ„Ç≠„Çπ„Éà
    function _outfitReason(emoji, maxT, minT) {
      if (['üß•'].includes(emoji)) return maxT < 15 ? 'Èò≤ÂØíÂØæÁ≠ñ' : maxT < 20 ? 'ÁæΩÁπî„ÇäÊé®Â•®' : 'Ê∞óÊ∏©Â∑ÆÂØæÁ≠ñ';
      if (['üß£'].includes(emoji)) return 'È¶ñÂÖÉ„ÅÆ‰øùÊ∏©';
      if (['üß§'].includes(emoji)) return 'ÊâãÂÖà„ÅÆÈò≤ÂØí';
      if (['üß¢','üé©','üëí'].includes(emoji)) return maxT >= 25 ? 'Á¥´Â§ñÁ∑öÂØæÁ≠ñ' : 'Èò≤ÂØí„Ç¢„ÇØ„Çª„É≥„Éà';
      if (['üëü','ü•æ'].includes(emoji)) return '„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂêë„Åë';
      if (['üëû'].includes(emoji)) return '„Éï„Ç©„Éº„Éû„É´Âêë„Åë';
      if (['ü©≥'].includes(emoji)) return 'Âø´ÈÅ©„Å™ÈÄöÊ∞óÊÄß';
      return '';
    }

    // „Éï„É©„ÉÉ„Éà„É¨„Ç§ÊúçË°®Á§∫Ôºà„Éû„Éç„Ç≠„É≥SVG„ÅÆ‰ª£„Çè„ÇäÔºâ
    function _buildFlatLay(items) {
      const shown = items.slice(0, 6);
      const cards = shown.map(it => {
        const shortName = it.label.replace(/^(„É¶„Éã„ÇØ„É≠|UNIQLO|GU|„Éä„Ç§„Ç≠|NIKE|„Ç≥„É≥„Éê„Éº„Çπ|Champion|„ÉÅ„É£„É≥„Éî„Ç™„É≥|„Ç¢„Ç∑„ÉÉ„ÇØ„Çπ|ASICS|„Ç¢„É≥„ÉÄ„Éº„Ç¢„Éº„Éû„Éº|„Éé„Éº„Çπ„Éï„Çß„Ç§„Çπ|„Ç≥„É≠„É≥„Éì„Ç¢|„É¢„É≥„Éô„É´)\s/i, '');
        return `<div class="fl-card"><div class="fl-card-em">${it.emoji}</div><div class="fl-card-nm">${_esc(shortName)}</div></div>`;
      }).join('');
      return `<div class="vp-flatlay">${cards}</div>`;
    }

    // ÊúçË£Ö„Éú„Éº„ÉâHTMLÁîüÊàêÔºà„É°„É≥„Ç∫Ôºã„É¨„Éá„Ç£„Éº„Çπ‰∏°ÊñπË°®Á§∫„Éª„Ç≠„É£„ÉÉ„Ç∑„É•ÂØæÂøúÔºâ
    function _buildOutfitBoard(outfit, cacheKey) {
      if (cacheKey && cacheKey === _outfitBoardCache.key) return _outfitBoardCache.html;
      const { warn, style } = outfit;
      const styleLabel = STYLE_LABEL[style] || style;

      // „É¨„Éá„Ç£„Éº„Çπ„Ç≥„Éº„Éá„ÇÇË®àÁÆó
      const outfitF = _outfitAdvice(outfit.maxT, outfit.minT, outfit.weatherCode, outfit.windspeed, '„É¨„Éá„Ç£„Éº„Çπ');
      const outfitM = _outfitAdvice(outfit.maxT, outfit.minT, outfit.weatherCode, outfit.windspeed, '„É°„É≥„Ç∫');

      function _buildSection(o, label) {
        const flatlay = _buildFlatLay(o.items);
        const cards = o.items.map(it => {
          const reason = _outfitReason(it.emoji, o.maxT || 20, o.minT || 10);
          return `<a href="${_esc(_amzUrl(it.q))}" target="_blank" rel="noopener" class="oic">` +
            `<div class="oic-em">${it.emoji}</div>` +
            `<div class="oic-nm">${_esc(it.label)}</div>` +
            (reason ? `<div class="oic-why">${_esc(reason)}</div>` : '') +
            `<div class="oic-amz">üõí Amazon</div>` +
          `</a>`;
        }).join('');
        return `<div class="outfit-gender-section">` +
          `<div class="outfit-gender-label">${_esc(label)}</div>` +
          `<div class="outfit-mannequin-row">${flatlay}<div class="oic-grid" style="flex:1;">${cards}</div></div>` +
        `</div>`;
      }

      const warnHtml = warn.length
        ? `<div class="outfit-warn-row">${warn.map(w => `<div class="outfit-warn">${w}</div>`).join('')}</div>`
        : '';

      const allQ = outfitM.items.map(it => it.label).join(' ');
      const html = `<div class="outfit-board-wrap">` +
        `<div class="outfit-board-title">üëó ‰ªäÊó•„ÅÆ„Ç≥„Éº„ÉáÊèêÊ°à <span class="outfit-style-tag">${_esc(styleLabel)}</span></div>` +
        _buildSection(outfitM, 'üëî „É°„É≥„Ç∫') +
        _buildSection(outfitF, 'üëó „É¨„Éá„Ç£„Éº„Çπ') +
        warnHtml +
        `<a href="${_esc(_amzUrl(allQ))}" target="_blank" rel="noopener" class="outfit-all-btn">üõí „Ç≥„Éº„ÉáÂÖ®‰Ωì„ÇíAmazon„ÅßÊé¢„Åô</a>` +
      `</div>`;
      if (cacheKey) _outfitBoardCache = { key: cacheKey, html };
      return html;
    }

    function _renderWeatherUI(data) {
      const { raw, locationName } = data;
      const daily  = raw.daily;
      const hourly = raw.hourly;
      const now    = new Date();
      const today  = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
      const curH   = now.getHours();
      const ti     = Math.max(0, daily.time.findIndex(t => t === today));
      const maxT   = daily.temperature_2m_max[ti];
      const minT   = daily.temperature_2m_min[ti];
      const code   = daily.weathercode[ti];
      const wind   = daily.windspeed_10m_max[ti];
      const rain   = daily.precipitation_probability_max[ti];
      const wi     = _wmo(code);

      // ‰ªäÊó•„ÅÆ„É°„Ç§„É≥Â§©Ê∞ó
      const todayEl = document.getElementById('weather-today');
      if (todayEl) {
        todayEl.innerHTML =
          `<div class="weather-loc">üìç ${_esc(locationName)}</div>` +
          `<div class="weather-main-row">` +
            `<div class="weather-big-emoji">${wi.emoji}</div>` +
            `<div class="weather-temps">` +
              `<div class="weather-temp-max">${Math.round(maxT)}¬∞</div>` +
              `<div class="weather-temp-min">${Math.round(minT)}¬∞</div>` +
            `</div>` +
            `<div class="weather-cond">` +
              `<div class="weather-label">${wi.label}</div>` +
              `<div class="weather-sub">üíß${rain}%„ÄÄüí®${Math.round(wind)}km/h</div>` +
            `</div>` +
          `</div>`;
      }

      // 1ÊôÇÈñìÊØé„ÅÆ‰∫àÂ†±
      const hourlyEl = document.getElementById('hourly-scroll');
      if (hourlyEl) {
        hourlyEl.innerHTML = _buildHourlyCards(hourly, today, true);
        setTimeout(() => {
          const nowCard = hourlyEl.querySelector('.h-now');
          if (nowCard) nowCard.scrollIntoView({ inline: 'start', behavior: 'smooth', block: 'nearest' });
        }, 100);
      }

      // ÊúçË£Ö„Åä„Åô„Åô„ÇÅÔºàÊ•ΩÂ§©/AmazonÈÄ£Êê∫„ÄÅHAÂØæÂøúÔºâ
      const boardEl = document.getElementById('outfit-board');
      if (boardEl) {
        const outfitKey = `${Math.round(maxT)},${Math.round(minT)},${code},${Math.round(wind)}`;
        try {
          const outfit = _outfitAdvice(maxT, minT, code, wind);
          boardEl.innerHTML = _buildOutfitBoard(outfit, outfitKey);
        } catch(e) {
          console.warn('[outfit]', e);
          boardEl.innerHTML = '<div class="outfit-fallback">üëó „Ç≥„Éº„ÉáÊÉÖÂ†±„ÇíË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì„Åß„Åó„Åü</div>';
        }
      }

      // 7Êó•Èñì‰∫àÂ†±
      const forecastEl = document.getElementById('forecast-scroll');
      if (forecastEl) {
        forecastEl.innerHTML = daily.time.map((dateStr, i) => {
          const d    = new Date(dateStr + 'T00:00:00');
          const dow  = ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'][d.getDay()];
          const isTd = (dateStr === today);
          const wi2  = _wmo(daily.weathercode[i]);
          return `<div class="fc-card${isTd ? ' fc-today' : ''}">` +
            `<div class="fc-dow">${isTd ? '‰ªäÊó•' : dow}</div>` +
            `<div class="fc-emoji">${wi2.emoji}</div>` +
            `<div class="fc-max">${Math.round(daily.temperature_2m_max[i])}¬∞</div>` +
            `<div class="fc-min">${Math.round(daily.temperature_2m_min[i])}¬∞</div>` +
            `<div class="fc-rain">${daily.precipitation_probability_max[i]}%</div>` +
          `</div>`;
        }).join('');
      }

      document.getElementById('weather-main-section').style.display = '';
      document.getElementById('weather-loading').style.display = 'none';
      document.getElementById('weather-error').style.display = 'none';
    }

    // „É≠„Éº„Ç´„É´‰ªäÊó•Êó•‰ªò„Éò„É´„Éë„Éº
    function _localToday() {
      const n = new Date();
      return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`;
    }

    // ÊôÇÈñìÂà•„Ç´„Éº„ÉâHTMLÁîüÊàêÔºà„Éè„Éñ„Éª„Ç´„É¨„É≥„ÉÄ„ÉºÂÖ±ÈÄöÔºâ
    function _buildHourlyCards(hourly, targetDate, highlightCurrent) {
      if (!hourly) return '';
      const curH   = new Date().getHours();
      const cards  = [];
      const DOW    = ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'];
      let count    = 0;
      let lastDate = null;
      for (let i = 0; i < hourly.time.length && count < 28; i++) {
        const t    = hourly.time[i];
        const date = t.slice(0, 10);
        const h    = parseInt(t.slice(11, 13));
        if (date < targetDate) continue;
        if (date === targetDate && h < curH) continue;

        // Êó•‰ªò„ÅåÂ§â„Çè„Å£„Åü„Çâ‰ªïÂàá„Çä„Ç´„Éº„Éâ„ÇíÊåøÂÖ•
        if (date !== lastDate) {
          if (lastDate !== null) {
            const d   = new Date(date + 'T00:00:00');
            const mm  = d.getMonth() + 1;
            const dd  = d.getDate();
            const dow = DOW[d.getDay()];
            const isTomorrow = (() => {
              const td = new Date(targetDate + 'T00:00:00');
              const nd = new Date(d); nd.setDate(nd.getDate());
              return (d - td) / 86400000 <= 1;
            })();
            cards.push(
              `<div class="h-date-sep">` +
                (isTomorrow ? `<span class="h-ds-today">ÁøåÊó•</span>` : '') +
                `<span>${mm}/${dd}</span>` +
                `<span>${dow}</span>` +
              `</div>`
            );
          }
          lastDate = date;
        }

        const isNow = highlightCurrent && (date === targetDate && h === curH);
        const wi2   = _wmo(hourly.weathercode[i]);
        const tmp   = Math.round(hourly.temperature_2m[i]);
        const feel  = Math.round(hourly.apparent_temperature[i]);
        const rn    = hourly.precipitation_probability[i];
        cards.push(
          `<div class="h-card${isNow ? ' h-now' : ''}">` +
            `<div class="h-time">${isNow ? 'ÁèæÂú®' : h + 'ÊôÇ'}</div>` +
            `<div class="h-emoji">${wi2.emoji}</div>` +
            `<div class="h-temp">${tmp}¬∞</div>` +
            `<div class="h-feels">‰ΩìÊÑü${feel}¬∞</div>` +
            `<div class="h-rain">${rn}%</div>` +
          `</div>`
        );
        count++;
      }
      return cards.join('');
    }

    // „Ç´„É¨„É≥„ÉÄ„Éº„Çø„Éñ„ÅÆ„Éü„Éã„Éê„Éä„Éº„ÇíÊõ¥Êñ∞
    function _renderCalWeather(data) {
      const wrap = document.getElementById('cal-weather-wrap');
      if (!wrap) return;
      const { raw, locationName } = data;
      const daily  = raw.daily;
      const hourly = raw.hourly;
      const today  = _localToday();
      const ti     = Math.max(0, daily.time.findIndex(t => t === today));
      const maxT   = daily.temperature_2m_max[ti];
      const minT   = daily.temperature_2m_min[ti];
      const code   = daily.weathercode[ti];
      const wind   = daily.windspeed_10m_max[ti];
      const rain   = daily.precipitation_probability_max[ti];
      const wi     = _wmo(code);

      document.getElementById('cal-w-emoji').textContent = wi.emoji;
      document.getElementById('cal-w-cond').textContent  = wi.label;
      document.getElementById('cal-w-sub').textContent   = `üíß${rain}%  üí®${Math.round(wind)}km/h  üìç${locationName}`;
      document.getElementById('cal-w-temps').textContent = `${Math.round(maxT)}¬∞ / ${Math.round(minT)}¬∞`;
      wrap.style.display = '';

      // ‚è± ÊôÇÈñìÂà•„Éú„Çø„É≥
      const hourlyBtn = document.getElementById('cal-hourly-btn');
      if (hourlyBtn) {
        hourlyBtn.onclick = () => {
          const ex = document.getElementById('cal-hourly-expand');
          if (!ex) return;
          const open = ex.style.display !== 'none';
          if (open) {
            ex.style.display = 'none';
            hourlyBtn.textContent = '‚è± ÊôÇÈñìÂà•';
          } else {
            const scrollEl = document.getElementById('cal-hourly-scroll');
            if (scrollEl && hourly) {
              scrollEl.innerHTML = _buildHourlyCards(hourly, today, true);
              // ÁèæÂú®ÊôÇÂàª„Ç´„Éº„Éâ„Å∏„Çπ„ÇØ„É≠„Éº„É´
              setTimeout(() => {
                const nowCard = scrollEl.querySelector('.h-now');
                if (nowCard) nowCard.scrollIntoView({ inline: 'start', behavior: 'smooth', block: 'nearest' });
              }, 80);
            }
            ex.style.display = '';
            hourlyBtn.textContent = '‚è± Èñâ„Åò„Çã';
          }
        };
      }

      // üëó ÊúçË£Ö„Éú„Çø„É≥
      const outfitBtn = document.getElementById('cal-outfit-btn');
      if (outfitBtn) {
        outfitBtn.onclick = () => {
          const expand = document.getElementById('cal-outfit-expand');
          if (!expand) return;
          const open = expand.style.display !== 'none';
          if (open) {
            expand.style.display = 'none';
            outfitBtn.textContent = 'üëó ÊúçË£Ö';
          } else {
            const card = document.getElementById('cal-outfit-card');
            if (card) {
              const outfitKey = `cal,${Math.round(maxT)},${Math.round(minT)},${code},${Math.round(wind)}`;
              try {
                const outfit = _outfitAdvice(maxT, minT, code, wind);
                card.innerHTML = _buildOutfitBoard(outfit, outfitKey);
                card.style.padding = '0';
                card.style.border  = 'none';
                card.style.background = 'none';
              } catch(e) {
                card.innerHTML = '<div class="outfit-fallback">üëó „Ç≥„Éº„Éá„ÇíË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì„Åß„Åó„Åü</div>';
              }
            }
            expand.style.display = '';
            outfitBtn.textContent = '‚úï Èñâ„Åò„Çã';
          }
        };
      }
    }

    async function renderWeather(forceRefresh) {
      const cached = forceRefresh ? null : _loadWeatherCache();
      if (cached) {
        _renderWeatherUI(cached);
        _renderCalWeather(cached);
        return;
      }

      // „Éè„Éñ„Ç´„Éº„Éâ„ÅÆ„É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã
      const loadingEl = document.getElementById('weather-loading');
      const mainEl    = document.getElementById('weather-main-section');
      const errEl     = document.getElementById('weather-error');
      if (loadingEl) loadingEl.style.display = '';
      if (mainEl)    mainEl.style.display    = 'none';
      if (errEl)     errEl.style.display     = 'none';

      try {
        const data = await _fetchWeatherData();
        _saveWeatherCache(data);
        _appLog('info', 'weather', `ÂèñÂæóÂÆå‰∫Ü: ${data.locationName}`);
        _renderWeatherUI(data);
        _renderCalWeather(data);
      } catch (err) {
        if (loadingEl) loadingEl.style.display = 'none';
        if (errEl) {
          errEl.style.display  = '';
          errEl.textContent = `‚ö†Ô∏è Â§©Ê∞óÂèñÂæóÂ§±Êïó: ${err.message}`;
        }
        // „Ç´„É¨„É≥„ÉÄ„Éº„Éê„Éä„Éº„Å´„ÇÇ„Ç®„É©„ÉºË°®Á§∫
        const sub = document.getElementById('cal-w-sub');
        if (sub) sub.textContent = `ÂèñÂæóÂ§±Êïó: ${err.message}`;
      }
    }

    document.getElementById('weather-refresh-btn')?.addEventListener('click', () => {
      renderWeather(true);
    });

    /* =====================================================
       LOG VIEWER
       ===================================================== */
    function openLogModal(filterLevel) {
      const fl = filterLevel || 'all';
      document.querySelectorAll('.log-filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === fl));
      _populateLogDateSel();
      _renderLogList(fl);
      document.getElementById('log-modal').classList.add('show');
    }
    function _populateLogDateSel() {
      const sel = document.getElementById('log-date-sel');
      if (!sel) return;
      const days = [{ value: '', label: '‰ªäÊó•ÔºàÁõ¥Ëøë80‰ª∂Ôºâ' }];
      for (let i = 0; i < localStorage.length; i++) {
        const k = localStorage.key(i);
        if (k && k.startsWith(_LOG_ARCHIVE_PFX)) {
          const d = k.slice(_LOG_ARCHIVE_PFX.length);
          let cnt = 0;
          try { cnt = JSON.parse(localStorage.getItem(k) || '[]').length; } catch(_) {}
          days.push({ value: k, label: `${d}Ôºà${cnt}‰ª∂Ôºâ` });
        }
      }
      days.sort((a, b) => b.value.localeCompare(a.value));
      sel.innerHTML = days.map(d => `<option value="${_esc(d.value)}">${_esc(d.label)}</option>`).join('');
    }

    function _renderLogList(filter, dateKey) {
      const listEl = document.getElementById('log-list');
      if (!listEl) return;
      let appLogs = [], errLogs = [];
      if (dateKey) {
        // Êó•Ê¨°„Ç¢„Éº„Ç´„Ç§„Éñ„ÇíË°®Á§∫
        try { appLogs = JSON.parse(localStorage.getItem(dateKey) || '[]'); } catch(_) {}
      } else {
        // ‰ªäÊó•: „É™„É≥„Ç∞„Éê„ÉÉ„Éï„Ç° + „Ç∞„É≠„Éº„Éê„É´„Ç®„É©„Éº
        try { appLogs = JSON.parse(localStorage.getItem(_LOG_KEY) || '[]'); } catch(_) {}
        try {
          errLogs = JSON.parse(localStorage.getItem(_ERR_KEY) || '[]').map(e => ({
            ts: e.ts, level: 'error', source: e.type || 'global', msg: e.detail
          }));
        } catch(_) {}
      }
      const all = [...appLogs, ...errLogs].sort((a, b) => b.ts.localeCompare(a.ts));
      const filtered = filter === 'all' ? all : all.filter(e => e.level === filter);
      if (filtered.length === 0) {
        listEl.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:32px 0;font-size:13px;">üìã „É≠„Ç∞„Å™„Åó</div>';
        return;
      }
      const _LEVEL_MAP = {
        fatal: ['log-badge-fatal', 'üíÄ Ëá¥ÂëΩ'],
        error: ['log-badge-error', 'üî¥ „Ç®„É©„Éº'],
        warn:  ['log-badge-warn',  'üü° Ë≠¶Âëä'],
        info:  ['log-badge-info',  'üîµ ÊÉÖÂ†±'],
      };
      listEl.innerHTML = filtered.map(e => {
        const d  = new Date(e.ts);
        const ts = `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
        const [bc, bl] = _LEVEL_MAP[e.level] || ['log-badge-info', 'ÊÉÖÂ†±'];
        const suggestion = (e.level === 'fatal' || e.level === 'error' || e.level === 'warn')
          ? _logSuggestion(e.source, e.msg, e.level) : null;
        return `<div class="log-entry">` +
          `<div class="log-row1">` +
            `<span class="log-ts">${ts}</span>` +
            `<span class="log-badge ${bc}">${bl}</span>` +
            `<span class="log-src">[${_esc(e.source || 'app')}]</span>` +
          `</div>` +
          `<div class="log-msg">${_esc(e.msg || '')}</div>` +
          (suggestion ? `<div class="log-suggest">${_esc(suggestion)}</div>` : '') +
        `</div>`;
      }).join('');
    }

    document.getElementById('log-close').addEventListener('click', () =>
      document.getElementById('log-modal').classList.remove('show'));
    document.getElementById('log-close2').addEventListener('click', () =>
      document.getElementById('log-modal').classList.remove('show'));
    document.getElementById('log-clear').addEventListener('click', () => {
      const dk = document.getElementById('log-date-sel')?.value || '';
      if (dk) {
        // „Ç¢„Éº„Ç´„Ç§„ÉñÊó•„ÅÆ„ÅøÊ∂àÂéª
        if (!confirm(`${dk.slice(_LOG_ARCHIVE_PFX.length)} „ÅÆ„É≠„Ç∞„ÇíÊ∂àÂéª„Åó„Åæ„Åô„ÅãÔºü`)) return;
        try { localStorage.removeItem(dk); } catch(_) {}
        _populateLogDateSel();
        document.getElementById('log-date-sel').value = '';
        _renderLogList('all');
      } else {
        if (!confirm('‰ªäÊó•„ÅÆ„É≠„Ç∞„Çí„Åô„Åπ„Å¶Ê∂àÂéª„Åó„Åæ„Åô„ÅãÔºü')) return;
        try { localStorage.removeItem(_LOG_KEY); localStorage.removeItem(_ERR_KEY); } catch(_) {}
        _renderLogList('all');
      }
      document.querySelectorAll('.log-filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === 'all'));
    });
    document.querySelectorAll('.log-filter-btn').forEach(btn =>
      btn.addEventListener('click', () => {
        document.querySelectorAll('.log-filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const dk = document.getElementById('log-date-sel')?.value || '';
        _renderLogList(btn.dataset.filter, dk);
      })
    );
    document.getElementById('log-date-sel').addEventListener('change', e => {
      const fl = document.querySelector('.log-filter-btn.active')?.dataset.filter || 'all';
      _renderLogList(fl, e.target.value || '');
    });
    document.getElementById('health-log-btn').addEventListener('click', () => openLogModal('all'));
    document.getElementById('health-err-item').addEventListener('click', () => openLogModal('error'));
    document.getElementById('health-idb-item').addEventListener('click', () => openLogModal('all'));
    document.getElementById('health-perf-btn').addEventListener('click', () => openPerfModal());

    /* =====================================================
       PERFORMANCE VIEWER (powertopÈ¢®)
       ===================================================== */
    let _perfFpsLoop = null, _perfFps = 0;

    function _startFpsMeter() {
      let last = performance.now(), frames = 0;
      _perfFps = 0;
      function loop(ts) {
        frames++;
        if (ts - last >= 1000) {
          _perfFps = frames;
          frames = 0;
          last = ts;
        }
        _perfFpsLoop = requestAnimationFrame(loop);
      }
      _perfFpsLoop = requestAnimationFrame(loop);
    }
    function _stopFpsMeter() {
      if (_perfFpsLoop) { cancelAnimationFrame(_perfFpsLoop); _perfFpsLoop = null; }
    }

    function _dotClass(pct) {
      return pct >= 80 ? 'perf-dot-crit' : pct >= 50 ? 'perf-dot-warn' : 'perf-dot-ok';
    }
    function _barClass(pct) {
      return pct >= 80 ? 'perf-bar-crit' : pct >= 50 ? 'perf-bar-warn' : 'perf-bar-ok';
    }
    function _colorVal(pct, val) {
      const c = pct >= 80 ? '#b71c1c' : pct >= 50 ? '#e65100' : '#2e7d32';
      return `<span style="color:${c}">${val}</span>`;
    }

    async function _buildPerfReport() {
      // LocalStorage usage
      let lsUsed = 0;
      try {
        for (let i = 0; i < localStorage.length; i++) {
          const k = localStorage.key(i);
          lsUsed += (localStorage.getItem(k) || '').length + k.length;
        }
      } catch(_) {}
      const lsKB = (lsUsed / 1024).toFixed(1);
      const lsMax = 5120; // ~5MB typical limit
      const lsPct = Math.min(100, Math.round(lsUsed / 1024 / lsMax * 100));

      // Memory
      const mem = (performance.memory) ? {
        used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024),
        total: Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024),
        pct: Math.round(performance.memory.usedJSHeapSize / performance.memory.jsHeapSizeLimit * 100)
      } : null;

      // Error counts
      let errCount = 0, fatalCount = 0, warnCount = 0;
      try {
        const logs = JSON.parse(localStorage.getItem(_LOG_KEY) || '[]');
        errCount  = logs.filter(l => l.level === 'error').length;
        fatalCount= logs.filter(l => l.level === 'fatal').length;
        warnCount = logs.filter(l => l.level === 'warn').length;
      } catch(_) {}
      const errLegacy = JSON.parse(localStorage.getItem(_ERR_KEY) || '[]').length;
      const totalErr = errCount + fatalCount + errLegacy;
      const errPct = Math.min(100, totalErr * 5);

      // Network
      const online = navigator.onLine;
      let navTime = null;
      try {
        const nav = performance.getEntriesByType('navigation')[0];
        if (nav) navTime = Math.round(nav.loadEventEnd - nav.startTime);
      } catch(_) {}

      // SW cache
      let swCaches = 0;
      try {
        const keys = await caches.keys();
        swCaches = keys.length;
      } catch(_) {}

      // FPS
      const fps = _perfFps;
      const fpsPct = fps < 20 ? 90 : fps < 40 ? 50 : 10; // inverted: low fps = high pct = bad

      const row = (dot, label, val) =>
        `<div class="perf-metric"><div class="perf-dot ${dot}"></div><div class="perf-label">${label}</div><div class="perf-val">${val}</div></div>`;
      const bar = (pct) =>
        `<div class="perf-bar-wrap"><div class="perf-bar ${_barClass(pct)}" style="width:${pct}%"></div></div>`;

      return `
<div class="perf-section">
  <div class="perf-section-title">üíæ „Çπ„Éà„É¨„Éº„Ç∏</div>
  ${row(_dotClass(lsPct), 'LocalStorage', _colorVal(lsPct, `${lsKB} KB / ${lsMax} KB`))}
  ${bar(lsPct)}
  ${row('perf-dot-ok', 'SW „Ç≠„É£„ÉÉ„Ç∑„É•', `${swCaches} ‰ª∂`)}
</div>
<div class="perf-section">
  <div class="perf-section-title">üß† „É°„É¢„É™</div>
  ${mem
    ? row(_dotClass(mem.pct), 'JS „Éí„Éº„Éó', _colorVal(mem.pct, `${mem.used} / ${mem.total} MB`)) + bar(mem.pct)
    : row('perf-dot-ok', 'JS „Éí„Éº„Éó', '<span style="color:var(--text-muted)">Ë®àÊ∏¨‰∏çÂèØ (Safari)</span>')}
</div>
<div class="perf-section">
  <div class="perf-section-title">üåê „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ</div>
  ${row(online ? 'perf-dot-ok' : 'perf-dot-crit', '„Ç™„É≥„É©„Ç§„É≥Áä∂ÊÖã', online ? '‚úÖ „Ç™„É≥„É©„Ç§„É≥' : '‚ùå „Ç™„Éï„É©„Ç§„É≥')}
  ${navTime !== null ? row('perf-dot-ok', '„Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇÈñì', `${navTime} ms`) : ''}
</div>
<div class="perf-section">
  <div class="perf-section-title">‚ö†Ô∏è „Ç®„É©„ÉºÔºà„Çª„ÉÉ„Ç∑„Éß„É≥Á¥ØË®àÔºâ</div>
  ${row(_dotClass(Math.min(100,fatalCount*20)), 'Ëá¥ÂëΩÁöÑ„Ç®„É©„Éº', _colorVal(Math.min(100,fatalCount*20), `${fatalCount} ‰ª∂`))}
  ${row(_dotClass(Math.min(100,errPct)), '„Ç®„É©„ÉºÂêàË®à', _colorVal(Math.min(100,errPct), `${totalErr} ‰ª∂`))}
  ${row(_dotClass(Math.min(100,warnCount*3)), 'Ë≠¶Âëä', _colorVal(Math.min(100,warnCount*3), `${warnCount} ‰ª∂`))}
</div>
<div class="perf-section">
  <div class="perf-section-title">üñ• „É¨„É≥„ÉÄ„É™„É≥„Ç∞</div>
  <div class="perf-fps-display">
    <div class="perf-fps-num" style="color:${fps >= 50 ? '#2e7d32' : fps >= 30 ? '#e65100' : fps > 0 ? '#b71c1c' : 'var(--text-muted)'}">${fps > 0 ? fps : '--'}</div>
    <div class="perf-fps-label">FPS (ÁîªÈù¢ÊèèÁîª„É¨„Éº„Éà)</div>
  </div>
  ${bar(fpsPct)}
  ${row(_dotClass(fpsPct), '„Éï„É¨„Éº„É†„É¨„Éº„ÉàË©ï‰æ°', fps >= 50 ? '‚úÖ ËâØÂ•Ω' : fps >= 30 ? '‚ö†Ô∏è „ÇÑ„ÇÑ‰Ωé‰∏ã' : fps > 0 ? 'üî¥ ‰Ωé‰∏ã‰∏≠' : '-- Ë®àÊ∏¨‰∏≠')}
</div>`;
    }

    async function openPerfModal() {
      document.getElementById('perf-modal').classList.add('show');
      document.getElementById('perf-content').innerHTML =
        '<div style="text-align:center;color:var(--text-muted);font-size:13px;padding:24px 0;">Ë®àÊ∏¨‰∏≠‚Ä¶</div>';
      _startFpsMeter();
      // Give FPS meter 1 second to stabilize
      await new Promise(r => setTimeout(r, 1200));
      document.getElementById('perf-content').innerHTML = await _buildPerfReport();
    }

    document.getElementById('perf-close').addEventListener('click', () => {
      document.getElementById('perf-modal').classList.remove('show');
      _stopFpsMeter();
    });
    document.getElementById('perf-close2').addEventListener('click', () => {
      document.getElementById('perf-modal').classList.remove('show');
      _stopFpsMeter();
    });
    document.getElementById('perf-refresh').addEventListener('click', async () => {
      document.getElementById('perf-content').innerHTML =
        '<div style="text-align:center;color:var(--text-muted);font-size:13px;padding:24px 0;">ÂÜçË®àÊ∏¨‰∏≠‚Ä¶</div>';
      _stopFpsMeter();
      _startFpsMeter();
      await new Promise(r => setTimeout(r, 1200));
      document.getElementById('perf-content').innerHTML = await _buildPerfReport();
    });

    /* =====================================================
       TAILSCALE VPN / SSH
       ===================================================== */
    function renderTailscaleCard() {
      const cfg = loadConfig();
      const macIp   = cfg.tsMac   || '';
      const iphone  = cfg.tsIphone || '';
      const user    = cfg.tsUser  || '';
      const wrap    = document.getElementById('ts-card-wrap');
      if (!wrap) return;
      if (!macIp && !iphone) { wrap.style.display = 'none'; return; }
      wrap.style.display = '';
      document.getElementById('ts-mac-ip-disp').textContent    = macIp   || 'Êú™Ë®≠ÂÆö';
      document.getElementById('ts-iphone-ip-disp').textContent = iphone  || 'Êú™Ë®≠ÂÆö';

      const sshUrl  = user && macIp ? `ssh://${user}@${macIp}` : '#';
      const sftpUrl = user && macIp ? `ftp://${user}@${macIp}:22` : '#';
      document.getElementById('ts-ssh-btn').href  = sshUrl;
      document.getElementById('ts-sftp-btn').href = sftpUrl;

      // „Ç≥„Éî„Éº„Éú„Çø„É≥
      const copyMac = document.getElementById('ts-copy-mac');
      const copyIph = document.getElementById('ts-copy-iphone');
      copyMac.onclick = () => {
        navigator.clipboard?.writeText(macIp).then(() => toast('üìã MacBook IP „Çí„Ç≥„Éî„Éº'));
      };
      copyIph.onclick = () => {
        navigator.clipboard?.writeText(iphone).then(() => toast('üìã iPhone IP „Çí„Ç≥„Éî„Éº'));
      };

      // ÁñéÈÄöÁ¢∫Ë™çÔºàTailscaleÁµåÁî±„ÅßMac„Å´„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºâ
      document.getElementById('ts-ping-btn').onclick = async () => {
        const res = document.getElementById('ts-ping-result');
        const dot = document.getElementById('ts-status-dot');
        res.style.display = '';
        res.textContent = 'üì° Á¢∫Ë™ç‰∏≠‚Ä¶';
        dot.className = 'ts-status-dot offline';
        document.getElementById('ts-status-label').textContent = 'Á¢∫Ë™ç‰∏≠‚Ä¶';
        if (!macIp) { res.textContent = '‚ö†Ô∏è MacBook IP„ÅåÊú™Ë®≠ÂÆö„Åß„Åô'; return; }
        try {
          const ctrl = new AbortController();
          setTimeout(() => ctrl.abort(), 4000);
          await fetch(`http://${macIp}:22`, { signal: ctrl.signal, mode: 'no-cors' });
          dot.className = 'ts-status-dot';
          document.getElementById('ts-status-label').textContent = 'Êé•Á∂öÂèØËÉΩ';
          res.textContent = `‚úÖ ${macIp} „ÅØÂà∞ÈÅîÂèØËÉΩ„Åß„Åô`;
          _appLog('info', 'tailscale', `ÁñéÈÄöÁ¢∫Ë™çÊàêÂäü: ${macIp}`);
        } catch(e) {
          // no-cors„Åßfetch„ÅåÂ§±Êïó„Åó„Å¶„ÇÇSSH port„ÅåÈñã„ÅÑ„Å¶„ÅÑ„Çå„Å∞„ÄåÊé•Á∂öÊãíÂê¶„Äç„Ç®„É©„Éº„Å´„Å™„Çã
          const reachable = e.name !== 'AbortError';
          dot.className   = reachable ? 'ts-status-dot' : 'ts-status-dot offline';
          document.getElementById('ts-status-label').textContent = reachable ? 'Êé•Á∂öÂèØËÉΩ' : '„Çø„Ç§„É†„Ç¢„Ç¶„Éà';
          res.textContent = reachable
            ? `‚úÖ ${macIp} „Å´Âà∞ÈÅî„Åß„Åç„Åæ„ÅôÔºàSSHÊé•Á∂öÂèØËÉΩÔºâ`
            : `‚ùå ${macIp} „Å´Âà∞ÈÅî„Åß„Åç„Åæ„Åõ„ÇìÔºàVPNÁ¢∫Ë™çÔºâ`;
          _appLog(reachable ? 'info' : 'warn', 'tailscale', `ÁñéÈÄöÁ¢∫Ë™ç: ${macIp} ‚Üí ${e.name}`);
        }
      };
    }

    /* =====================================================
       Ë≠∞‰∫ãÈå≤„ÉªÊñáÂ≠óËµ∑„Åì„Åó (Web Speech API)
       ===================================================== */
    const _MIN_LS_KEY = '_kintai_minutes_hist';
    let _minActive = false, _minRec = null, _minTimer = null, _minElapsed = 0;
    let _minBlocks = [];      // { ts, text }[]
    let _minLastFinalTime = 0;
    const _MIN_PAUSE_MS = 2800; // „Åì„ÅÆÈñìÈöî‰ª•‰∏äÁ©∫„ÅÑ„Åü„ÇâÊñ∞„Éñ„É≠„ÉÉ„ÇØ

    function _minFmtTime(sec) {
      return `${String(Math.floor(sec/60)).padStart(2,'0')}:${String(sec%60).padStart(2,'0')}`;
    }
    function _minWallTs() {
      const d = new Date();
      return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
    }
    function _minRenderTranscript(interimText) {
      const body = document.getElementById('min-transcript-body');
      if (!body) return;
      if (!_minBlocks.length && !interimText) {
        body.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:28px 0;font-size:12px;line-height:1.8;">üéô Èå≤Èü≥ÈñãÂßã„Åß„É™„Ç¢„É´„Çø„Ç§„É†ÊñáÂ≠óËµ∑„Åì„Åó<br><span style="font-size:11px;">Chrome / Safari (iOS 14.5+)„ÄÄÊó•Êú¨Ë™û</span></div>';
        return;
      }
      let html = _minBlocks.map((b, i) =>
        `<div class="min-block">` +
          `<div class="min-speaker">Áô∫Ë®Ä ${i+1} ¬∑ ${b.ts}</div>` +
          `<div class="min-text">${_esc(b.text)}</div>` +
        `</div>`
      ).join('');
      if (interimText) {
        html += `<div class="min-block" style="opacity:.6;border-color:#bdbdbd;">` +
          `<div class="min-speaker">Ë™çË≠ò‰∏≠...</div>` +
          `<div class="min-text interim">${_esc(interimText)}</div>` +
        `</div>`;
      }
      body.innerHTML = html;
      const t = document.getElementById('min-transcript');
      if (t) t.scrollTop = t.scrollHeight;
    }

    function _minSetupSR() {
      if (!_minActive) return;
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) return;
      _minRec = new SR();
      _minRec.lang = 'ja-JP';
      _minRec.continuous = false;
      _minRec.interimResults = true;
      _minRec.maxAlternatives = 1;

      _minRec.onresult = ev => {
        const now = Date.now();
        let interim = '', final = '';
        for (const r of ev.results) {
          if (r.isFinal) final += r[0].transcript;
          else interim += r[0].transcript;
        }
        if (final) {
          const isNew = (now - _minLastFinalTime) > _MIN_PAUSE_MS || !_minBlocks.length;
          if (isNew) {
            _minBlocks.push({ ts: _minWallTs(), text: final });
          } else {
            _minBlocks[_minBlocks.length - 1].text += '„ÄÄ' + final;
          }
          _minLastFinalTime = now;
          _minRenderTranscript('');
        } else {
          _minRenderTranscript(interim);
        }
      };
      _minRec.onerror = ev => {
        if (ev.error === 'no-speech' || ev.error === 'aborted') return;
        const st = document.getElementById('min-status');
        if (st) st.textContent = `‚ö†Ô∏è ${ev.error}`;
        _appLog('warn', 'minutes', `SR error: ${ev.error}`);
      };
      _minRec.onend = () => { if (_minActive) setTimeout(_minSetupSR, 80); };
      try { _minRec.start(); } catch(_) { setTimeout(_minSetupSR, 500); }
    }

    function _minStart() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { toast('‚ùå „Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÈü≥Â£∞Ë™çË≠ò„Å´ÈùûÂØæÂøú„Åß„ÅôÔºàChrome/Safari„Çí‰ΩøÁî®Ôºâ'); return; }
      _minActive = true; _minElapsed = 0;
      _minTimer = setInterval(() => {
        _minElapsed++;
        const el = document.getElementById('min-timer');
        if (el) el.textContent = _minFmtTime(_minElapsed);
      }, 1000);
      const btn = document.getElementById('min-rec-btn');
      btn.textContent = '‚èπ ÂÅúÊ≠¢';
      btn.classList.replace('start', 'stop');
      document.getElementById('min-status').style.display = '';
      _minSetupSR();
      _appLog('info', 'minutes', 'Èå≤Èü≥ÈñãÂßã');
    }

    function _minStop() {
      _minActive = false;
      if (_minRec) { try { _minRec.stop(); } catch(_) {} _minRec = null; }
      if (_minTimer) { clearInterval(_minTimer); _minTimer = null; }
      const btn = document.getElementById('min-rec-btn');
      btn.textContent = 'üî¥ Èå≤Èü≥ÈñãÂßã';
      btn.classList.replace('stop', 'start');
      document.getElementById('min-status').style.display = 'none';
      _minRenderTranscript('');
      _appLog('info', 'minutes', `Èå≤Èü≥ÂÅúÊ≠¢: ${_minFmtTime(_minElapsed)}, ${_minBlocks.length}„Éñ„É≠„ÉÉ„ÇØ`);
    }

    function _minBuildText() {
      const title = document.getElementById('min-title')?.value.trim() || 'Ë≠∞‰∫ãÈå≤';
      const d = new Date();
      const dStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      const md = `# ${title}\nÊó•ÊôÇ: ${dStr}  \nÈå≤Èü≥ÊôÇÈñì: ${_minFmtTime(_minElapsed)}\n\n` +
        _minBlocks.map((b, i) => `## Áô∫Ë®Ä ${i+1} (${b.ts})\n${b.text}`).join('\n\n');
      return { title, dStr, md };
    }

    function _minSaveHistory() {
      try {
        const { title, dStr, md } = _minBuildText();
        const hist = JSON.parse(localStorage.getItem(_MIN_LS_KEY) || '[]');
        hist.unshift({ id: Date.now(), title, date: dStr, blocks: _minBlocks.length, md });
        if (hist.length > 50) hist.length = 50;
        localStorage.setItem(_MIN_LS_KEY, JSON.stringify(hist));
        toast('üíæ Ë≠∞‰∫ãÈå≤„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
        _appLog('info', 'minutes', `‰øùÂ≠ò: ${title}`);
      } catch(e) { toast('‚ùå ‰øùÂ≠òÂ§±Êïó: ' + e.message); }
    }

    function _minRenderHistory() {
      const el = document.getElementById('min-hist-list');
      if (!el) return;
      let hist = [];
      try { hist = JSON.parse(localStorage.getItem(_MIN_LS_KEY) || '[]'); } catch(_) {}
      if (!hist.length) {
        el.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:24px 0;font-size:12px;">‰øùÂ≠ò„Åï„Çå„ÅüË≠∞‰∫ãÈå≤„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
        return;
      }
      el.innerHTML = hist.map(h =>
        `<div class="min-hist-item" data-id="${h.id}">` +
          `<div class="min-hist-title">${_esc(h.title)}</div>` +
          `<div class="min-hist-meta">${h.date} ¬∑ ${h.blocks}„Éñ„É≠„ÉÉ„ÇØ</div>` +
        `</div>`
      ).join('');
      el.querySelectorAll('.min-hist-item').forEach(item => {
        item.addEventListener('click', () => {
          const id = Number(item.dataset.id);
          const rec = hist.find(h => h.id === id);
          if (!rec) return;
          navigator.clipboard?.writeText(rec.md).then(() => toast('üìã Markdown„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü'));
        });
      });
    }

    // Tab toggle
    function _minSwitchTab(tab) {
      ['rec','hist','video'].forEach(t => {
        const panel = document.getElementById('min-panel-' + t);
        const btn   = document.getElementById('min-tab-' + t);
        const active = t === tab;
        if (panel) panel.style.display = active ? 'flex' : 'none';
        if (btn) {
          btn.style.borderBottomColor = active ? 'var(--accent-blue)' : 'transparent';
          btn.style.color = active ? 'var(--accent-blue)' : 'var(--text-muted)';
        }
      });
      if (tab === 'hist') _minRenderHistory();
    }

    function openMinModal() {
      _minRenderTranscript('');
      document.getElementById('min-modal').classList.add('show');
    }

    document.getElementById('btn-minutes').addEventListener('click', openMinModal);
    document.getElementById('min-close').addEventListener('click', () => {
      if (_minActive) _minStop();
      document.getElementById('min-modal').classList.remove('show');
    });
    document.getElementById('min-tab-rec').addEventListener('click',   () => _minSwitchTab('rec'));
    document.getElementById('min-tab-hist').addEventListener('click',  () => _minSwitchTab('hist'));
    document.getElementById('min-tab-video').addEventListener('click', () => _minSwitchTab('video'));
    document.getElementById('min-rec-btn').addEventListener('click', () => {
      _minActive ? _minStop() : _minStart();
    });
    document.getElementById('min-copy').addEventListener('click', () => {
      if (!_minBlocks.length) { toast('‚ö†Ô∏è ÊñáÂ≠óËµ∑„Åì„ÅóÂÜÖÂÆπ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'); return; }
      const { md } = _minBuildText();
      navigator.clipboard?.writeText(md).then(() => toast('üìã „ÉÜ„Ç≠„Çπ„Éà„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü'))
        .catch(() => toast('‚ùå „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü'));
    });
    document.getElementById('min-md').addEventListener('click', () => {
      if (!_minBlocks.length) { toast('‚ö†Ô∏è ÂÜÖÂÆπ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'); return; }
      const { md, title, dStr } = _minBuildText();
      const blob = new Blob([md], { type: 'text/markdown;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${dStr}_${title}.md`;
      a.click();
      URL.revokeObjectURL(a.href);
    });
    document.getElementById('min-obsidian').addEventListener('click', () => {
      if (!_minBlocks.length) { toast('‚ö†Ô∏è ÂÜÖÂÆπ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'); return; }
      const cfg = loadConfig();
      const vault = cfg.vault || '';
      if (!vault) { toast('‚ö†Ô∏è Ë®≠ÂÆö„ÅßObsidian VaultÂêç„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
      const { md, title, dStr } = _minBuildText();
      const sub = cfg.subdir ? cfg.subdir + '/' : '';
      const file = encodeURIComponent(`${sub}${dStr}_${title}`);
      const content = encodeURIComponent(md);
      location.href = `obsidian://new?vault=${encodeURIComponent(vault)}&file=${file}&content=${content}`;
    });
    document.getElementById('min-save-min').addEventListener('click', () => {
      if (!_minBlocks.length) { toast('‚ö†Ô∏è ÂÜÖÂÆπ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'); return; }
      _minSaveHistory();
    });
    document.getElementById('min-clear').addEventListener('click', () => {
      if (!confirm('ÊñáÂ≠óËµ∑„Åì„ÅóÂÜÖÂÆπ„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü')) return;
      if (_minActive) _minStop();
      _minBlocks = []; _minElapsed = 0;
      document.getElementById('min-timer').textContent = '00:00';
      document.getElementById('min-title').value = '';
      _minRenderTranscript('');
    });

    /* =====================================================
       CAMERA SIZE MEASUREMENT
       ===================================================== */
    (function() {
      let _camStream = null;
      let _camFacing = 'environment';
      let _camScale  = null;   // px per mm (set after calibration)
      let _camState  = 0;      // 0=ref pt1, 1=ref pt2, 2=meas pt1, 3=meas pt2, 4=done
      let _camPts    = [];
      let _camRefW   = 85.6;   // mm
      let _camType   = 'foot';

      const vidEl    = document.getElementById('measure-video');
      const cvs      = document.getElementById('measure-canvas');
      const ctx      = cvs.getContext('2d');
      const stepEl   = document.getElementById('measure-step');
      const camMsg   = document.getElementById('measure-cam-msg');
      const resultEl = document.getElementById('measure-result');
      const resultMm = document.getElementById('measure-result-mm');
      const resultSz = document.getElementById('measure-result-size');

      const STEPS = [
        '‚ë† Âü∫Ê∫ñÁâ©„ÅÆÁ´ØÔºàAÁÇπÔºâ„Çí„Çø„ÉÉ„Éó',
        '‚ë° Âü∫Ê∫ñÁâ©„ÅÆÈÄÜÁ´ØÔºàBÁÇπÔºâ„Çí„Çø„ÉÉ„Éó',
        '‚ë¢ Ë®àÊ∏¨ÁÆáÊâÄ„ÅÆÂßãÁÇπÔºàCÁÇπÔºâ„Çí„Çø„ÉÉ„Éó',
        '‚ë£ Ë®àÊ∏¨ÁÆáÊâÄ„ÅÆÁµÇÁÇπÔºàDÁÇπÔºâ„Çí„Çø„ÉÉ„Éó',
        '‚úÖ Ë®àÊ∏¨ÂÆå‰∫ÜÔºÅ„É™„Çª„ÉÉ„Éà„ÅßÂÜçË®àÊ∏¨„Åß„Åç„Åæ„Åô',
      ];

      function _resize() {
        const wrap = document.getElementById('measure-cam-wrap');
        if (!wrap) return;
        cvs.width  = wrap.offsetWidth;
        cvs.height = wrap.offsetHeight;
        _draw();
      }

      function _draw() {
        ctx.clearRect(0, 0, cvs.width, cvs.height);
        const colors = ['#FFD600','#FF6F00','#00BCD4','#00E676'];
        const labels = ['A','B','C','D'];
        _camPts.forEach((pt, i) => {
          ctx.beginPath();
          ctx.arc(pt.x, pt.y, 9, 0, Math.PI * 2);
          ctx.fillStyle = colors[i] + 'CC';
          ctx.fill();
          ctx.strokeStyle = 'white';
          ctx.lineWidth = 2;
          ctx.stroke();
          ctx.fillStyle = 'white';
          ctx.font = 'bold 11px sans-serif';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(labels[i], pt.x, pt.y);
        });
        if (_camPts.length >= 2) {
          ctx.beginPath();
          ctx.moveTo(_camPts[0].x, _camPts[0].y);
          ctx.lineTo(_camPts[1].x, _camPts[1].y);
          ctx.strokeStyle = '#FFD600CC';
          ctx.lineWidth = 2;
          ctx.setLineDash([7, 4]);
          ctx.stroke();
          ctx.setLineDash([]);
        }
        if (_camPts.length >= 4) {
          ctx.beginPath();
          ctx.moveTo(_camPts[2].x, _camPts[2].y);
          ctx.lineTo(_camPts[3].x, _camPts[3].y);
          ctx.strokeStyle = '#00E676CC';
          ctx.lineWidth = 2.5;
          ctx.setLineDash([7, 4]);
          ctx.stroke();
          ctx.setLineDash([]);
        }
      }

      function _ptFromEvent(e) {
        const rect = cvs.getBoundingClientRect();
        const sx = cvs.width / rect.width;
        const sy = cvs.height / rect.height;
        const src = e.touches ? e.touches[0] : e;
        return { x: (src.clientX - rect.left) * sx, y: (src.clientY - rect.top) * sy };
      }

      function _dist(a, b) {
        return Math.sqrt((b.x - a.x) ** 2 + (b.y - a.y) ** 2);
      }

      function _sizeSuggestion(mm, type) {
        const cm = mm / 10;
        if (type === 'foot') {
          const sz = (Math.round(cm * 2) / 2).toFixed(1);
          return `Ë∂≥„ÅÆÈï∑„Åï: ${cm.toFixed(1)}cm\nÊé®Â•®„Ç∑„É•„Éº„Ç∫: ${sz}cm`;
        }
        if (type === 'shoulder') {
          const sz = cm < 40 ? 'S' : cm < 44 ? 'M' : cm < 48 ? 'L' : 'XL';
          return `ËÇ©ÂπÖ: ${cm.toFixed(1)}cm ‚Üí ${sz}„Çµ„Ç§„Ç∫`;
        }
        if (type === 'waist') {
          const sz = cm < 72 ? 'S' : cm < 78 ? 'M' : cm < 84 ? 'L' : 'XL';
          return `„Ç¶„Ç®„Çπ„Éà: ${cm.toFixed(1)}cm ‚Üí ${sz}„Çµ„Ç§„Ç∫`;
        }
        return `Ë®àÊ∏¨ÂÄ§: ${cm.toFixed(1)} cm`;
      }

      function _onTap(e) {
        e.preventDefault();
        if (_camState >= 4) return;
        const pt = _ptFromEvent(e);
        _camPts.push(pt);
        if (_camState === 1) {
          const px = _dist(_camPts[0], _camPts[1]);
          _camScale = px / _camRefW;
        }
        if (_camState === 3) {
          const px = _dist(_camPts[2], _camPts[3]);
          const mm = px / _camScale;
          resultMm.textContent = `${Math.round(mm)} mm (${(mm / 10).toFixed(1)} cm)`;
          resultSz.textContent = _sizeSuggestion(mm, _camType);
          resultSz.style.whiteSpace = 'pre-line';
          resultEl.style.display = '';
        }
        _camState = Math.min(_camState + 1, 4);
        stepEl.textContent = STEPS[_camState > 4 ? 4 : _camState];
        _draw();
      }

      function _reset() {
        _camState = 0; _camPts = []; _camScale = null;
        resultEl.style.display = 'none';
        stepEl.textContent = STEPS[0];
        _draw();
      }

      async function _startCam() {
        if (_camStream) { _camStream.getTracks().forEach(t => t.stop()); _camStream = null; }
        camMsg.style.display = 'flex';
        camMsg.textContent = 'üì∑ „Ç´„É°„É©„ÇíËµ∑Âãï‰∏≠...';
        try {
          _camStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: _camFacing, width: { ideal: 1280 }, height: { ideal: 720 } }
          });
          vidEl.srcObject = _camStream;
          await vidEl.play();
          camMsg.style.display = 'none';
        } catch(err) {
          camMsg.textContent = `‚ùå „Ç´„É°„É©„Å´„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Åæ„Åõ„Çì: ${err.message}`;
        }
      }

      function _stopCam() {
        if (_camStream) { _camStream.getTracks().forEach(t => t.stop()); _camStream = null; }
        vidEl.srcObject = null;
      }

      // Reference buttons
      document.querySelectorAll('.measure-ref-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.measure-ref-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          _camRefW = parseFloat(btn.dataset.w);
          _reset();
        });
      });

      // Type buttons
      document.querySelectorAll('.measure-type-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.measure-type-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          _camType = btn.dataset.type;
        });
      });

      cvs.addEventListener('click', _onTap);
      cvs.addEventListener('touchend', _onTap, { passive: false });
      document.getElementById('measure-reset').addEventListener('click', _reset);
      document.getElementById('measure-flip').addEventListener('click', async () => {
        _camFacing = _camFacing === 'environment' ? 'user' : 'environment';
        await _startCam();
      });

      document.getElementById('btn-measure').addEventListener('click', async () => {
        document.getElementById('measure-modal').classList.add('show');
        _reset();
        setTimeout(_resize, 100);
        await _startCam();
      });

      document.getElementById('measure-close').addEventListener('click', () => {
        document.getElementById('measure-modal').classList.remove('show');
        _stopCam();
      });

      vidEl.addEventListener('loadedmetadata', _resize);
      window.addEventListener('resize', () => {
        if (document.getElementById('measure-modal').classList.contains('show')) _resize();
      });
    })();

    /* =====================================================
       ÂãïÁîª„ÉªÈü≥Â£∞„Éï„Ç°„Ç§„É´ ÊñáÂ≠óËµ∑„Åì„Åó
       ===================================================== */
    (() => {
      let _vsr = null;         // SpeechRecognition instance
      let _vBlocks = [];       // transcript blocks [{text, ts}]
      let _vAudioEl = null;

      function _vRender() {
        const body = document.getElementById('min-video-transcript-body');
        if (!body) return;
        if (!_vBlocks.length) {
          body.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:28px 0;font-size:12px;line-height:1.8;">üìÅ ÂãïÁîª„Åæ„Åü„ÅØÈü≥Â£∞„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶<br>„ÄåÊñáÂ≠óËµ∑„Åì„ÅóÈñãÂßã„Äç„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ<br><span style="font-size:11px;opacity:0.8;">‚ö†Ô∏è „Çπ„Éî„Éº„Ç´„ÉºÂÜçÁîüÔºã„Éû„Ç§„ÇØË™çË≠òÊñπÂºè<br>„Éò„ÉÉ„Éâ„Éï„Ç©„É≥„ÇíÂ§ñ„Åó„Å¶„Åî‰ΩøÁî®„Åè„Å†„Åï„ÅÑ</span></div>';
          return;
        }
        body.innerHTML = _vBlocks.map((b, i) =>
          `<div class="min-block" data-i="${i}"><span class="min-ts">${b.ts}</span><span class="min-text">${_esc(b.text)}</span></div>`
        ).join('');
        body.scrollTop = body.scrollHeight;
      }

      function _vStop() {
        const statusEl = document.getElementById('min-video-status');
        const startBtn = document.getElementById('min-video-start');
        const stopBtn  = document.getElementById('min-video-stop');
        if (_vsr) { try { _vsr.stop(); } catch(e) {} _vsr = null; }
        if (_vAudioEl) { _vAudioEl.pause(); }
        if (statusEl) { statusEl.style.display = 'none'; statusEl.textContent = ''; }
        if (startBtn) startBtn.style.display = '';
        if (stopBtn)  stopBtn.style.display  = 'none';
      }

      function _vStart() {
        const audio = document.getElementById('min-video-audio');
        const statusEl = document.getElementById('min-video-status');
        const startBtn = document.getElementById('min-video-start');
        const stopBtn  = document.getElementById('min-video-stop');
        _vAudioEl = audio;

        if (!audio.src || audio.src === window.location.href) {
          toast('‚ö†Ô∏è ÂÖà„Å´„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return;
        }
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SR) { toast('‚ùå „Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÈü≥Â£∞Ë™çË≠ò„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì'); return; }

        _vBlocks = [];
        _vRender();

        const sr = new SR();
        _vsr = sr;
        sr.lang = 'ja-JP';
        sr.continuous = true;
        sr.interimResults = false;
        sr.maxAlternatives = 1;

        sr.onresult = e => {
          for (let i = e.resultIndex; i < e.results.length; i++) {
            const txt = e.results[i][0].transcript.trim();
            if (!txt) continue;
            const now = new Date();
            const ts = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
            _vBlocks.push({ text: txt, ts });
          }
          _vRender();
        };
        sr.onerror = e => {
          if (e.error === 'aborted') return;
          if (statusEl) statusEl.textContent = `‚ö†Ô∏è Ë™çË≠ò„Ç®„É©„Éº: ${e.error}`;
        };
        sr.onend = () => {
          // Restart if audio is still playing
          if (_vsr && _vAudioEl && !_vAudioEl.paused && !_vAudioEl.ended) {
            try { _vsr.start(); } catch(ex) {}
          } else {
            _vStop();
          }
        };

        sr.start();
        audio.play().catch(err => {
          toast(`‚ö†Ô∏è ÂÜçÁîü„Ç®„É©„Éº: ${err.message}`);
          _vStop();
        });
        audio.onended = () => _vStop();

        if (statusEl) { statusEl.textContent = 'üéô ÂÜçÁîü‰∏≠„ÉªÊñáÂ≠óËµ∑„Åì„Åó‰∏≠‚Ä¶'; statusEl.style.display = ''; }
        if (startBtn) startBtn.style.display = 'none';
        if (stopBtn)  stopBtn.style.display  = '';
      }

      // File picker
      document.getElementById('min-video-pick').addEventListener('click', () => {
        document.getElementById('min-video-file').click();
      });
      document.getElementById('min-video-file').addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        e.target.value = '';
        const url = URL.createObjectURL(file);
        const audio = document.getElementById('min-video-audio');
        audio.src = url;
        document.getElementById('min-video-player-wrap').style.display = '';
        document.getElementById('min-video-file-info').textContent = `üìÑ ${file.name}  (${(file.size/1024/1024).toFixed(1)} MB)`;
        document.getElementById('min-video-title').value = file.name.replace(/\.[^.]+$/, '');
        _vBlocks = [];
        _vRender();
      });

      document.getElementById('min-video-start').addEventListener('click', _vStart);
      document.getElementById('min-video-stop').addEventListener('click',  _vStop);

      document.getElementById('min-video-copy').addEventListener('click', () => {
        if (!_vBlocks.length) { toast('‚ö†Ô∏è ÊñáÂ≠óËµ∑„Åì„ÅóÂÜÖÂÆπ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'); return; }
        const txt = _vBlocks.map(b => `[${b.ts}] ${b.text}`).join('\n');
        navigator.clipboard?.writeText(txt).then(() => toast('üìã „ÉÜ„Ç≠„Çπ„Éà„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü'))
          .catch(() => toast('‚ùå „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü'));
      });

      document.getElementById('min-video-save').addEventListener('click', () => {
        if (!_vBlocks.length) { toast('‚ö†Ô∏è ÂÜÖÂÆπ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'); return; }
        const title = document.getElementById('min-video-title').value || 'ÂãïÁîªÊñáÂ≠óËµ∑„Åì„Åó';
        const now = new Date();
        const dStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
        const content = `# ${title}\n\n‰ΩúÊàêÊó•: ${dStr}\n\n` + _vBlocks.map(b => `[${b.ts}] ${b.text}`).join('\n');
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${title}_${dStr}.txt`;
        a.click();
        toast('üíæ „ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
      });

      document.getElementById('min-video-clear').addEventListener('click', () => {
        _vStop();
        _vBlocks = [];
        _vRender();
        const audio = document.getElementById('min-video-audio');
        audio.src = '';
        document.getElementById('min-video-player-wrap').style.display = 'none';
        document.getElementById('min-video-title').value = '';
      });
    })();

    /* =====================================================
       SERVICE WORKER
       ===================================================== */
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(err => {
        console.warn('ServiceWorker registration failed:', err);
      });
    }
  </script>
</body>
</html>
