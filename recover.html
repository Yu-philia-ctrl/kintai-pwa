<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>å‹¤æ€ PWA â€” ç·Šæ€¥å¾©æ—§</title>
<style>
  :root {
    --blue: #4f8dfd; --red: #ff3b30; --orange: #f57c00;
    --green: #2e7d32; --bg: #f0f2f8;
  }
  * { box-sizing: border-box; }
  body { font-family: -apple-system, sans-serif; background: var(--bg);
         min-height: 100vh; margin: 0; padding: 16px; }
  .page { max-width: 480px; margin: 0 auto; }
  h1 { font-size: 20px; margin: 0 0 4px; color: #1a1a1a; }
  .subtitle { font-size: 13px; color: #666; margin: 0 0 16px; line-height: 1.5; }

  .card { background: #fff; border-radius: 16px; padding: 16px;
          box-shadow: 0 2px 16px rgba(0,0,0,0.08); margin-bottom: 14px; }
  .card-title { font-size: 11px; font-weight: 800; letter-spacing: .08em;
                text-transform: uppercase; color: #999; margin-bottom: 10px; }

  .btn { display: block; width: 100%; padding: 13px 14px;
         border: none; border-radius: 12px; font-size: 14px; font-weight: 700;
         cursor: pointer; margin-bottom: 8px; font-family: inherit;
         text-align: left; transition: opacity 0.15s; }
  .btn:last-child { margin-bottom: 0; }
  .btn:active { opacity: 0.8; }
  .btn-safe    { background: #e3f2fd; color: #1565c0; }
  .btn-warn    { background: #fff8e1; color: var(--orange); }
  .btn-danger  { background: #ffebee; color: #c62828; }
  .btn-outline { background: #f4f5f9; color: #555; }
  .btn-green   { background: #e8f5e9; color: var(--green); }
  .btn-primary { background: var(--blue); color: #fff; }
  .btn span.desc { display: block; font-size: 11px; font-weight: 500;
                   opacity: 0.72; margin-top: 2px; }

  .warn-box { background: #fff8e1; border: 1px solid #ffe0b2;
              border-radius: 10px; padding: 10px 12px;
              font-size: 12px; color: var(--orange); line-height: 1.6;
              margin-bottom: 12px; }

  .status-box { font-size: 13px; color: var(--green); margin-top: 12px;
                min-height: 20px; font-weight: 600; line-height: 1.6; }
  .status-box.error { color: #c62828; }

  /* Diagnostics */
  .diag-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
               margin-bottom: 8px; }
  .diag-item { background: #f4f5f9; border-radius: 10px; padding: 10px 12px; }
  .diag-label { font-size: 10px; color: #999; font-weight: 700; text-transform: uppercase; }
  .diag-value { font-size: 16px; font-weight: 800; color: #1a1a1a; margin-top: 2px; }
  .diag-sub   { font-size: 10px; color: #888; margin-top: 2px; }
  .diag-ok   { color: var(--green); }
  .diag-warn { color: var(--orange); }
  .diag-error { color: #c62828; }

  /* Error log */
  .log-table { width: 100%; border-collapse: collapse; font-size: 11px; }
  .log-table th { background: #f4f5f9; padding: 6px 8px; text-align: left;
                  color: #999; font-weight: 700; }
  .log-table td { padding: 6px 8px; border-top: 1px solid #f0f0f0;
                  word-break: break-all; }
  .log-type { font-weight: 700; color: #c62828; white-space: nowrap; }
  .log-ts   { color: #999; white-space: nowrap; }
  .no-log   { text-align: center; color: #aaa; padding: 16px; font-size: 13px; }

  /* Snapshots */
  .snap-item { display: flex; align-items: center; gap: 10px;
               padding: 10px 12px; background: #f9f9fb;
               border-radius: 10px; margin-bottom: 6px; }
  .snap-item:last-child { margin-bottom: 0; }
  .snap-info  { flex: 1; }
  .snap-ts    { font-size: 13px; font-weight: 700; color: #1a1a1a; }
  .snap-sub   { font-size: 11px; color: #888; margin-top: 2px; }
  .snap-btn   { padding: 7px 14px; border: none; border-radius: 8px;
                font-size: 12px; font-weight: 700; cursor: pointer;
                background: var(--blue); color: #fff; font-family: inherit; }
  .snap-btn:active { opacity: 0.8; }
  .no-snap  { text-align: center; color: #aaa; padding: 16px; font-size: 13px; }

  .section-status { font-size: 12px; color: #aaa; margin-top: 4px; }
</style>
</head>
<body>
<div class="page">
  <h1>ğŸš¨ ç·Šæ€¥å¾©æ—§ãƒšãƒ¼ã‚¸</h1>
  <p class="subtitle">å‹¤æ€ PWAã«å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã€ã“ã®ãƒšãƒ¼ã‚¸ã§å¾©æ—§ã§ãã¾ã™ã€‚<br>ä¸Šã‹ã‚‰é †ã«è©¦ã—ã¦ãã ã•ã„ã€‚</p>

  <!-- PIN status notice -->
  <div id="pin-notice" style="display:none;background:#fff8e1;border:1px solid #ffe0b2;border-radius:12px;padding:10px 14px;margin-bottom:12px;font-size:12px;color:#e65100;line-height:1.6;">
    âš ï¸ <strong>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£PINãŒæœªè¨­å®š</strong>ã§ã™ã€‚å…¨ãƒ‡ãƒ¼ã‚¿æ¶ˆå»ã¯ã€ŒDELETEã€å…¥åŠ›ã§ä»£æ›¿ç¢ºèªã—ã¾ã™ã€‚<br>
    ã‚¢ãƒ—ãƒªã® <strong>âš™ï¸è¨­å®š â†’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£PIN</strong> ã‹ã‚‰äº‹å‰ã«PINã‚’è¨­å®šã™ã‚‹ã“ã¨ã‚’å¼·ãæ¨å¥¨ã—ã¾ã™ã€‚
  </div>

  <!-- Diagnostics -->
  <div class="card">
    <div class="card-title">ğŸ“Š è¨ºæ–­æƒ…å ±</div>
    <div class="diag-grid" id="diag-grid">
      <div class="diag-item"><div class="diag-label">LSä½¿ç”¨é‡</div><div class="diag-value" id="d-ls-size">--</div><div class="diag-sub" id="d-ls-sub"></div></div>
      <div class="diag-item"><div class="diag-label">IDB</div><div class="diag-value" id="d-idb">--</div><div class="diag-sub" id="d-idb-sub"></div></div>
      <div class="diag-item"><div class="diag-label">ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ</div><div class="diag-value" id="d-snap">--</div><div class="diag-sub" id="d-snap-sub"></div></div>
      <div class="diag-item"><div class="diag-label">ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°</div><div class="diag-value" id="d-err">--</div><div class="diag-sub" id="d-err-sub"></div></div>
    </div>
    <div class="diag-grid" style="margin-top:8px;">
      <div class="diag-item"><div class="diag-label">PINãƒ­ãƒƒã‚¯</div><div class="diag-value" id="d-pin">--</div><div class="diag-sub" id="d-pin-sub"></div></div>
    </div>
    <div class="section-status" id="diag-status">è¨ºæ–­ä¸­...</div>
  </div>

  <!-- Step 1: SW/Cache only -->
  <div class="card">
    <div class="card-title">Step 1 â€” è»½ã„ä¿®å¾©ï¼ˆãƒ‡ãƒ¼ã‚¿ä¿æŒï¼‰</div>
    <div class="warn-box">âš ï¸ ã¾ãšã“ã¡ã‚‰ã‚’è©¦ã—ã¦ãã ã•ã„ã€‚ãƒ‡ãƒ¼ã‚¿ã¯æ¶ˆãˆã¾ã›ã‚“ã€‚</div>
    <button class="btn btn-safe" onclick="swUpdate()">ğŸ”„ Service Worker ã‚’å¼·åˆ¶æ›´æ–°
      <span class="desc">SWã®æ›´æ–°ã®ã¿ã€‚æœ€ã‚‚å®‰å…¨ã€‚</span>
    </button>
    <button class="btn btn-warn" onclick="clearCacheOnly()">ğŸ—‚ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»SWã‚’ã‚¯ãƒªã‚¢ï¼ˆãƒ‡ãƒ¼ã‚¿ä¿æŒï¼‰
      <span class="desc">ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨SWã‚’å…¨å‰Šé™¤ã€‚å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã€‚</span>
    </button>
    <div class="status-box" id="status-1"></div>
  </div>

  <!-- Step 2: Snapshot restore -->
  <div class="card">
    <div class="card-title">Step 2 â€” ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‹ã‚‰å¾©å…ƒ</div>
    <p style="font-size:12px;color:#666;margin:0 0 10px;line-height:1.5;">
      ã‚¢ãƒ—ãƒªãŒè‡ªå‹•ä¿å­˜ã—ãŸã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼ˆæœ€å¤§3ä»¶ï¼‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã§ãã¾ã™ã€‚<br>
      ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚
    </p>
    <div id="snap-list"><div class="no-snap">èª­ã¿è¾¼ã¿ä¸­...</div></div>
    <div class="status-box" id="status-2"></div>
  </div>

  <!-- Step 3: Full reset -->
  <div class="card">
    <div class="card-title">Step 3 â€” å®Œå…¨ãƒªã‚»ãƒƒãƒˆï¼ˆæœ€çµ‚æ‰‹æ®µï¼‰</div>
    <div class="warn-box">âš ï¸ å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ã‚‚å«ã‚ã¦å…¨æ¶ˆå»ã—ã¾ã™ã€‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã‚ã‚‹å ´åˆã®ã¿å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</div>
    <button class="btn btn-danger" onclick="clearAll()">ğŸ—‘ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¦ãƒªã‚»ãƒƒãƒˆ
      <span class="desc">localStorageãƒ»IDBãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»SW ã‚’ã™ã¹ã¦å‰Šé™¤ã€‚</span>
    </button>
    <div class="status-box" id="status-3"></div>
  </div>

  <!-- Error log -->
  <div class="card">
    <div class="card-title">ğŸ ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ï¼ˆç›´è¿‘20ä»¶ï¼‰</div>
    <div id="err-log-container"><div class="no-log">èª­ã¿è¾¼ã¿ä¸­...</div></div>
    <button class="btn btn-outline" style="margin-top:10px;" onclick="clearErrorLog()">ğŸ—‘ ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’æ¶ˆå»</button>
  </div>

  <!-- Navigation -->
  <div class="card">
    <div class="card-title">ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³</div>
    <button class="btn btn-primary" onclick="goHome()">â† PWAã«æˆ»ã‚‹</button>
    <button class="btn btn-outline" onclick="location.reload()">ğŸ”ƒ ã“ã®ãƒšãƒ¼ã‚¸ã‚’å†èª­è¾¼</button>
  </div>
</div>

<script>
const STORE_KEY   = 'kintai_store_v1';
const IDB_NAME    = 'kintai_idb';
const IDB_STORE   = 'attendance';
const _ERR_KEY    = '_kintai_errors';
const _SNAP_KEY   = '_kintai_snap_';
const _SNAP_IDX   = '_kintai_snap_idx';
const _SNAP_GENS  = 3;
const ORIGIN      = location.origin + '/kintai-pwa';
const PIN_HASH_KEY = 'kintai_pin_hash';
const PIN_FAIL_KEY = 'kintai_pin_fails';
const PIN_LOCK_KEY = 'kintai_pin_lock';
const PIN_MAX_FAILS = 3;
const PIN_LOCKOUT_MS = 60000;

function log(id, msg, isError = false) {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = msg;
  el.className = 'status-box' + (isError ? ' error' : '');
  console.log('[recover]', msg);
}

/* ---- IDB helpers ---- */
function _openIDB() {
  return new Promise(resolve => {
    try {
      const req = indexedDB.open(IDB_NAME, 1);
      req.onupgradeneeded = e => e.target.result.createObjectStore(IDB_STORE, { keyPath: 'id' });
      req.onsuccess = e => resolve(e.target.result);
      req.onerror   = () => resolve(null);
    } catch(_) { resolve(null); }
  });
}
async function idbLoad() {
  const db = await _openIDB();
  if (!db) return null;
  return new Promise(resolve => {
    try {
      const req = db.transaction(IDB_STORE).objectStore(IDB_STORE).get('main');
      req.onsuccess = () => resolve(req.result?.data || null);
      req.onerror   = () => resolve(null);
    } catch(_) { resolve(null); }
  });
}
async function idbSave(data) {
  const db = await _openIDB();
  if (!db) return;
  try {
    const tx = db.transaction(IDB_STORE, 'readwrite');
    tx.objectStore(IDB_STORE).put({ id: 'main', data, saved_at: new Date().toISOString() });
  } catch(_) {}
}

/* ---- Snapshot helpers ---- */
function listSnapshots() {
  const result = [];
  const idx = Number(localStorage.getItem(_SNAP_IDX) || 0);
  for (let i = 0; i < _SNAP_GENS; i++) {
    const si = (idx - i + _SNAP_GENS) % _SNAP_GENS;
    const raw = localStorage.getItem(_SNAP_KEY + si);
    if (!raw) continue;
    try {
      const { meta, data } = JSON.parse(raw);
      result.push({ slot: si, meta, data });
    } catch(_) {}
  }
  return result;
}

/* ---- Diagnostics ---- */
async function runDiag() {
  // LS size
  let lsSize = 0;
  try { for (const k of Object.keys(localStorage)) lsSize += (localStorage.getItem(k)||'').length; } catch(_) {}
  const lsKB = Math.round(lsSize / 1024);
  const lsEl = document.getElementById('d-ls-size');
  const lsSubEl = document.getElementById('d-ls-sub');
  lsEl.textContent = lsKB + 'KB';
  lsEl.className = 'diag-value ' + (lsKB > 4000 ? 'diag-warn' : 'diag-ok');
  lsSubEl.textContent = lsKB > 4000 ? 'æ®‹ã‚Šå°‘ãªã„å¯èƒ½æ€§' : 'æ­£å¸¸ç¯„å›²';

  // IDB
  const idbData = await idbLoad();
  const idbMonths = Object.keys(idbData?.months || {}).length;
  const idbEl = document.getElementById('d-idb');
  const idbSubEl = document.getElementById('d-idb-sub');
  idbEl.textContent = idbMonths > 0 ? 'âœ“ æ­£å¸¸' : 'ç©º';
  idbEl.className = 'diag-value ' + (idbMonths > 0 ? 'diag-ok' : 'diag-warn');
  idbSubEl.textContent = idbMonths > 0 ? idbMonths + 'ãƒ¶æœˆåˆ†' : 'ãƒ‡ãƒ¼ã‚¿ãªã—';

  // Snapshots
  const snaps = listSnapshots();
  const snapEl = document.getElementById('d-snap');
  const snapSubEl = document.getElementById('d-snap-sub');
  snapEl.textContent = snaps.length + 'ä»¶';
  snapEl.className = 'diag-value ' + (snaps.length > 0 ? 'diag-ok' : 'diag-warn');
  if (snaps.length > 0) {
    const d = new Date(snaps[0].meta.ts);
    snapSubEl.textContent = 'æœ€æ–°: ' + d.toLocaleDateString('ja') + ' ' + d.toLocaleTimeString('ja', { hour:'2-digit', minute:'2-digit' });
  } else {
    snapSubEl.textContent = 'ãªã—';
  }

  // Error count
  const errs = JSON.parse(localStorage.getItem(_ERR_KEY) || '[]');
  const errEl = document.getElementById('d-err');
  const errSubEl = document.getElementById('d-err-sub');
  errEl.textContent = errs.length + 'ä»¶';
  errEl.className = 'diag-value ' + (errs.length === 0 ? 'diag-ok' : errs.length < 5 ? 'diag-warn' : 'diag-error');
  errSubEl.textContent = errs.length > 0 ? 'æœ€æ–°: ' + errs[0].type : 'ã‚¨ãƒ©ãƒ¼ãªã—';

  // PIN status
  const pinSet = !!localStorage.getItem(PIN_HASH_KEY);
  const pinEl    = document.getElementById('d-pin');
  const pinSubEl = document.getElementById('d-pin-sub');
  const pinNotice = document.getElementById('pin-notice');
  if (pinEl) {
    pinEl.textContent = pinSet ? 'âœ“ è¨­å®šæ¸ˆ' : 'æœªè¨­å®š';
    pinEl.className   = 'diag-value ' + (pinSet ? 'diag-ok' : 'diag-warn');
    if (pinSubEl) pinSubEl.textContent = pinSet ? 'DELæ“ä½œä¿è­·ã‚ã‚Š' : 'ã€ŒDELETEã€å…¥åŠ›ã§ä»£æ›¿';
    if (pinNotice) pinNotice.style.display = pinSet ? 'none' : '';
  }

  document.getElementById('diag-status').textContent = 'è¨ºæ–­å®Œäº† â€” ' + new Date().toLocaleTimeString('ja');

  // Render snapshots
  renderSnapshots(snaps);
  // Render error log
  renderErrorLog(errs);
}

function renderSnapshots(snaps) {
  const container = document.getElementById('snap-list');
  if (snaps.length === 0) {
    container.innerHTML = '<div class="no-snap">ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  container.innerHTML = snaps.map((s, i) => {
    const d = new Date(s.meta.ts);
    const fmt = d.toLocaleDateString('ja') + ' ' + d.toLocaleTimeString('ja', { hour:'2-digit', minute:'2-digit' });
    return `<div class="snap-item">
      <div class="snap-info">
        <div class="snap-ts">${fmt}</div>
        <div class="snap-sub">${s.meta.months}ãƒ¶æœˆåˆ†ã®ãƒ‡ãƒ¼ã‚¿${i === 0 ? ' â† æœ€æ–°' : ''}</div>
      </div>
      <button class="snap-btn" onclick="restoreSnap(${s.slot})">å¾©å…ƒ</button>
    </div>`;
  }).join('');
}

function renderErrorLog(errs) {
  const container = document.getElementById('err-log-container');
  if (errs.length === 0) {
    container.innerHTML = '<div class="no-log">âœ… ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  container.innerHTML = `<table class="log-table">
    <thead><tr><th>ç¨®é¡</th><th>æ™‚åˆ»</th><th>è©³ç´°</th></tr></thead>
    <tbody>${errs.map(e => `
      <tr>
        <td class="log-type">${_esc(e.type)}</td>
        <td class="log-ts">${(e.ts||'').slice(0,16).replace('T',' ')}</td>
        <td>${_esc(e.detail||'')}</td>
      </tr>`).join('')}
    </tbody>
  </table>`;
}

function _esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/* ---- PIN helpers ---- */
async function sha256(text) {
  try {
    const data = new TextEncoder().encode(String(text));
    const hash = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
  } catch(_) { return null; }
}
function isPinSet() { return !!localStorage.getItem(PIN_HASH_KEY); }

async function verifyPinPrompt(purpose) {
  if (!isPinSet()) {
    // PINãŒæœªè¨­å®š â†’ "DELETE"å…¥åŠ›ã§ä»£æ›¿ç¢ºèª
    const input = prompt(`ğŸ” PINæœªè¨­å®š\n\nã€Œ${purpose}ã€\n\nâš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£PINãŒæœªè¨­å®šã®ãŸã‚æ–‡å­—ç¢ºèªã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚\n\nç¶šè¡Œã™ã‚‹ã«ã¯ã€ŒDELETEã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š`);
    return input === 'DELETE';
  }
  // ãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆç¢ºèª
  const lockUntil = Number(localStorage.getItem(PIN_LOCK_KEY) || 0);
  if (lockUntil > Date.now()) {
    const rem = Math.ceil((lockUntil - Date.now()) / 1000);
    alert(`ğŸ”’ ${rem}ç§’é–“ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚æ™‚é–“ã‚’ãŠã„ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚`);
    return false;
  }
  for (let attempt = 1; attempt <= PIN_MAX_FAILS; attempt++) {
    const pin = prompt(`ğŸ” ${purpose}\n\nPINã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ${attempt}/${PIN_MAX_FAILS}å›ï¼‰`);
    if (pin === null) return false; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    const hash = await sha256(pin);
    if (hash === localStorage.getItem(PIN_HASH_KEY)) {
      localStorage.setItem(PIN_FAIL_KEY, '0');
      return true;
    }
    if (attempt >= PIN_MAX_FAILS) {
      localStorage.setItem(PIN_LOCK_KEY, String(Date.now() + PIN_LOCKOUT_MS));
      localStorage.setItem(PIN_FAIL_KEY, '0');
      alert(`âŒ ${PIN_MAX_FAILS}å›å¤±æ•—ã—ã¾ã—ãŸã€‚60ç§’é–“ãƒ­ãƒƒã‚¯ã—ã¾ã™ã€‚`);
      return false;
    }
    alert(`âŒ PINãŒé•ã„ã¾ã™ï¼ˆæ®‹ã‚Š${PIN_MAX_FAILS - attempt}å›ï¼‰`);
  }
  return false;
}

/* ---- Actions ---- */
async function swUpdate() {
  log('status-1', 'â³ Service Worker ã‚’æ›´æ–°ä¸­...');
  try {
    const regs = await navigator.serviceWorker.getRegistrations();
    for (const r of regs) await r.update();
    log('status-1', 'âœ… SWæ›´æ–°å®Œäº†ã€‚å•é¡ŒãŒç¶šãå ´åˆã¯Step 2ä»¥é™ã¸ã€‚');
  } catch(e) { log('status-1', 'SWæ›´æ–°ã‚¹ã‚­ãƒƒãƒ—: ' + e.message, true); }
}

async function clearCacheOnly() {
  log('status-1', 'â³ Service Worker ã‚’ç™»éŒ²è§£é™¤ä¸­...');
  try {
    const regs = await navigator.serviceWorker.getRegistrations();
    for (const r of regs) await r.unregister();
    log('status-1', 'âœ… SWè§£é™¤å®Œäº†');
  } catch(e) { log('status-1', 'SWè§£é™¤ã‚¹ã‚­ãƒƒãƒ—: ' + e.message); }

  try {
    const keys = await caches.keys();
    await Promise.all(keys.map(k => caches.delete(k)));
    log('status-1', 'âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤å®Œäº† â€” PWAã«æˆ»ã‚Šã¾ã™...');
  } catch(e) { log('status-1', 'ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ã‚¹ã‚­ãƒƒãƒ—'); }

  setTimeout(goHome, 1500);
}

function restoreSnap(slot) {
  try {
    const raw = localStorage.getItem(_SNAP_KEY + slot);
    if (!raw) { log('status-2', 'âš ï¸ ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', true); return; }
    const { meta, data } = JSON.parse(raw);
    const d = new Date(meta.ts);
    const fmt = d.toLocaleDateString('ja') + ' ' + d.toLocaleTimeString('ja', { hour:'2-digit', minute:'2-digit' });
    if (!confirm(`${fmt} ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼ˆ${meta.months}ãƒ¶æœˆåˆ†ï¼‰ã‹ã‚‰å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ\nç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚`)) return;
    localStorage.setItem(STORE_KEY, JSON.stringify(data));
    idbSave(data);
    log('status-2', 'âœ… å¾©å…ƒå®Œäº† â€” PWAã«æˆ»ã‚Šã¾ã™...');
    setTimeout(goHome, 1500);
  } catch(e) { log('status-2', 'å¾©å…ƒå¤±æ•—: ' + e.message, true); }
}

async function clearAll() {
  // â‘  ã¾ãšPIN/DELETEèªè¨¼ï¼ˆæœ€åˆã®å£ï¼‰
  const pinOk = await verifyPinPrompt('å…¨ãƒ‡ãƒ¼ã‚¿æ¶ˆå»ã—ã¦ãƒªã‚»ãƒƒãƒˆ');
  if (!pinOk) { log('status-3', 'âŒ èªè¨¼å¤±æ•— â€” ãƒªã‚»ãƒƒãƒˆã‚’ä¸­æ­¢ã—ã¾ã—ãŸ', true); return; }
  // â‘¡ èªè¨¼å¾Œã«ç¢ºèªãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
  if (!confirm('âš ï¸ å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ã‚‚å«ã‚ã¦å…¨ã¦å‰Šé™¤ã—ã¾ã™ã€‚\nãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯å–ã‚Šã¾ã—ãŸã‹ï¼Ÿ')) return;
  if (!confirm('æœ€çµ‚ç¢ºèªï¼šæœ¬å½“ã«ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

  log('status-3', 'â³ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ä¸­...');

  try {
    const regs = await navigator.serviceWorker.getRegistrations();
    for (const r of regs) await r.unregister();
  } catch(_) {}

  try {
    const keys = await caches.keys();
    await Promise.all(keys.map(k => caches.delete(k)));
  } catch(_) {}

  try { localStorage.clear(); } catch(_) {}
  try { indexedDB.deleteDatabase(IDB_NAME); } catch(_) {}

  log('status-3', 'âœ… å…¨ãƒªã‚»ãƒƒãƒˆå®Œäº† â€” PWAã«æˆ»ã‚Šã¾ã™...');
  setTimeout(goHome, 1500);
}

function clearErrorLog() {
  if (!confirm('ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')) return;
  try { localStorage.removeItem(_ERR_KEY); } catch(_) {}
  renderErrorLog([]);
  document.getElementById('d-err').textContent = '0ä»¶';
  document.getElementById('d-err').className = 'diag-value diag-ok';
  document.getElementById('d-err-sub').textContent = 'ã‚¨ãƒ©ãƒ¼ãªã—';
}

function goHome() {
  location.href = '/kintai-pwa/';
}

// èµ·å‹•æ™‚è¨ºæ–­
runDiag();
</script>
</body>
</html>
