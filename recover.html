<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>å‹¤æ€ PWA â€” ç·Šæ€¥å¾©æ—§</title>
<style>
  body { font-family:-apple-system,sans-serif; background:#f5f5f5; display:flex;
         align-items:center; justify-content:center; min-height:100vh; margin:0; }
  .box { background:#fff; border-radius:18px; padding:28px 24px; max-width:340px;
         width:90vw; box-shadow:0 4px 24px rgba(0,0,0,0.12); text-align:center; }
  h1   { font-size:20px; margin:0 0 8px; color:#1a1a1a; }
  p    { font-size:13px; color:#666; line-height:1.6; margin:0 0 20px; }
  .btn { display:block; width:100%; padding:13px; border:none; border-radius:12px;
         font-size:15px; font-weight:700; cursor:pointer; margin-bottom:10px; font-family:inherit; }
  .btn-danger  { background:#ff3b30; color:#fff; }
  .btn-safe    { background:#4f8dfd; color:#fff; }
  .btn-outline { background:#fff; color:#555; border:1.5px solid #ddd; }
  .status { font-size:13px; color:#2e7d32; margin-top:16px; min-height:20px; font-weight:600; }
  .warn   { font-size:12px; color:#ef6c00; background:#fff8e1; border-radius:8px;
            padding:8px 12px; margin-bottom:16px; text-align:left; }
</style>
</head>
<body>
<div class="box">
  <h1>ğŸš¨ ç·Šæ€¥å¾©æ—§ãƒšãƒ¼ã‚¸</h1>
  <p>å‹¤æ€ PWAãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ãƒ«ãƒ¼ãƒ—ã«å…¥ã£ãŸå ´åˆã€ã“ã®ãƒšãƒ¼ã‚¸ã§å¾©æ—§ã§ãã¾ã™ã€‚</p>

  <div class="warn">
    âš ï¸ ã€Œãƒ‡ãƒ¼ã‚¿ã‚‚å…¨éƒ¨æ¶ˆã™ã€ã‚’é¸ã¶ã¨å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆã¾ã™ã€‚<br>
    ã€Œã‚­ãƒ£ãƒƒã‚·ãƒ¥ã ã‘æ¶ˆã™ã€ã‚’å…ˆã«è©¦ã—ã¦ãã ã•ã„ã€‚
  </div>

  <button class="btn btn-safe" onclick="clearCacheOnly()">ğŸ—‚ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»SWã ã‘æ¶ˆã™ï¼ˆãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒï¼‰</button>
  <button class="btn btn-danger" onclick="clearAll()">ğŸ—‘ ãƒ‡ãƒ¼ã‚¿ã‚‚å…¨éƒ¨æ¶ˆã™ï¼ˆå®Œå…¨ãƒªã‚»ãƒƒãƒˆï¼‰</button>
  <button class="btn btn-outline" onclick="goHome()">â† PWAã«æˆ»ã‚‹ï¼ˆå¾©æ—§ã›ãšï¼‰</button>

  <div class="status" id="status"></div>
</div>

<script>
const STATUS = document.getElementById('status');
const ORIGIN = location.origin + '/kintai-pwa';

function log(msg) { STATUS.textContent = msg; console.log(msg); }

async function clearCacheOnly() {
  log('â³ Service Worker ã‚’ç™»éŒ²è§£é™¤ä¸­...');
  try {
    const regs = await navigator.serviceWorker.getRegistrations();
    for (const r of regs) await r.unregister();
    log('âœ… SWè§£é™¤å®Œäº†');
  } catch(e) { log('SWè§£é™¤ã‚¹ã‚­ãƒƒãƒ—: ' + e.message); }

  try {
    const keys = await caches.keys();
    await Promise.all(keys.map(k => caches.delete(k)));
    log('âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤å®Œäº†');
  } catch(e) { log('ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ã‚¹ã‚­ãƒƒãƒ—'); }

  log('âœ… å®Œäº†ï¼PWAã«æˆ»ã‚Šã¾ã™...');
  setTimeout(goHome, 1200);
}

async function clearAll() {
  if (!confirm('å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ã‚‚å«ã‚ã¦å…¨ã¦å‰Šé™¤ã—ã¾ã™ã€‚æœ¬å½“ã«ã‚ˆã„ã§ã™ã‹ï¼Ÿ')) return;

  await clearCacheOnly();

  // localStorage ã‚’å…¨æ¶ˆå»
  try {
    localStorage.clear();
    log('âœ… localStorage æ¶ˆå»å®Œäº†');
  } catch(e) {}

  // IndexedDB ã‚’å‰Šé™¤
  try {
    indexedDB.deleteDatabase('kintai_idb');
    log('âœ… IndexedDB å‰Šé™¤å®Œäº†');
  } catch(e) {}

  log('âœ… å…¨ãƒªã‚»ãƒƒãƒˆå®Œäº†ï¼PWAã«æˆ»ã‚Šã¾ã™...');
  setTimeout(goHome, 1200);
}

function goHome() {
  location.href = '/kintai-pwa/';
}
</script>
</body>
</html>
