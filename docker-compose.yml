# ========================================================
# kintai スタック — Docker Compose 設定
#
# 使い方:
#   docker compose up -d          # バックグラウンド起動
#   docker compose down           # 停止
#   docker compose logs -f        # ログ追跡
#   docker compose pull && docker compose up -d  # アップデート
#   docker compose build --no-cache && docker compose up -d  # イメージ再ビルド
#
# 注意:
#   - launchd の com.kintai.server を先に停止してからこちらを起動する
#   - launchctl unload ~/Library/LaunchAgents/com.kintai.server.plist
# ========================================================

services:
  kintai-server:
    build: .
    image: kintai-server:latest
    container_name: kintai-server
    restart: always                   # Docker 再起動時も自動起動 (HA)
    ports:
      - "8899:8899"
    volumes:
      # データ永続化 (勤怠JSON・タスクJSON)
      - ./data:/app/data
      # ログ永続化
      - ./logs:/app/logs
      # 環境変数 (.env が存在する場合)
      # - ./.env:/app/.env:ro
      # iCloud バックアップフォルダ (Mac のみ)
      - ~/Library/Mobile Documents/com~apple~CloudDocs/kintai:/app/icloud_kintai:ro
      # Docker ソケット — コンテナ内から Docker を操作するために必要
      # PWAの「Dockerタブ」がコンテナ管理に使用する (Docker-in-Docker)
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - PYTHONUNBUFFERED=1
      - KINTAI_MANAGED=1
      - PORT=8899
      # ホストのLAN IPを注入（miniserveカードのQRコード生成に使用）
      # Mac のLAN IPに合わせて変更: ipconfig getifaddr en0 で確認
      # - KINTAI_HOST_IP=192.168.x.x
    stop_grace_period: 30s              # SIGTERM → 30秒待ってから SIGKILL (code 137 防止)
    deploy:
      resources:
        limits:
          memory: 512M                  # OOM kill 防止: 512MB 上限
        reservations:
          memory: 128M
    healthcheck:
      test: ["CMD", "curl", "-fs", "http://localhost:8899/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: kintai-cloudflared
    restart: always                   # トンネルも自動復旧
    command: tunnel --url http://kintai-server:8899 --no-autoupdate
    depends_on:
      kintai-server:
        condition: service_healthy    # サーバー起動後にトンネル開始
    environment:
      - NO_AUTOUPDATE=true
